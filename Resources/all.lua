-- 避免内存泄露
collectgarbage("setpause", 100)
collectgarbage("setstepmul", 5000)

--设置随机数种子
math.randomseed( os.time() )
cfg_vip_data = {{vip_level=0,total_charge=0,desc="0",tax_count=10,tax_ratio=1.00,tax_bonus_max=5,training_slot_max=9999,training_ratio_max=1,dock_slot_max=2,dock_steal_max=10,dock_count_max=99999,dock_protect=0,horse_slot_max=1,forge_discount=1.00,forge_advance=1,forge_crit=0,polish_rare=0,polish_epic=0,jump_gold=1,jump_ratio=1.00,arena_count_max=0,cave_count_max=6,capture_max=3,daily_task_max=1,daily_task_refresh=0,ap_charge_max=0,vip_mall=0,vip_pack=0,vip_pack_price=0,auto_fate=0,team_raid_reset_count=0,},{vip_level=1,total_charge=100,desc="1.开启高级训练，训练效果提升1.5倍。\n2.竞技场挑战次数可额外购买10次。\n3.开启第二个奴隶位。\n4.精力购买：每天可购买精力1次。\n5.VIP充值奖励：勋章*5,经验丹*20，一级宝石袋*2\n银币*500000",tax_count=10,tax_ratio=1.05,tax_bonus_max=10,training_slot_max=9999,training_ratio_max=2,dock_slot_max=2,dock_steal_max=10,dock_count_max=99999,dock_protect=0,horse_slot_max=2,forge_discount=1.00,forge_advance=1,forge_crit=0,polish_rare=0,polish_epic=0,jump_gold=1,jump_ratio=1.00,arena_count_max=10,cave_count_max=7,capture_max=3,daily_task_max=3,daily_task_refresh=0,ap_charge_max=1,vip_mall=0,vip_pack=0,vip_pack_price=0,auto_fate=0,team_raid_reset_count=0,},{vip_level=2,total_charge=500,desc="1.开启高级提取,提取时获得更多经验。\n2.竞技场挑战次数可额外购买20次。\n3.开启“巨龙峡谷”佣兵任务。\n4.精力购买：每天可购买精力2次。\n5.开启第三个奴隶位。\n6.含VIP1所有功能。\n9.VIP充值奖励：勋章*10,经验丹*40，二级宝石袋*2\n银币*1000000",tax_count=10,tax_ratio=1.05,tax_bonus_max=15,training_slot_max=9999,training_ratio_max=2,dock_slot_max=2,dock_steal_max=10,dock_count_max=99999,dock_protect=0,horse_slot_max=2,forge_discount=1.00,forge_advance=1,forge_crit=0,polish_rare=0,polish_epic=0,jump_gold=1,jump_ratio=1.00,arena_count_max=20,cave_count_max=8,capture_max=3,daily_task_max=5,daily_task_refresh=0,ap_charge_max=2,vip_mall=0,vip_pack=0,vip_pack_price=0,auto_fate=0,team_raid_reset_count=0,},{vip_level=3,total_charge=1000,desc="1.开启超级训练，训练效果提升2倍。\n2.竞技场挑战次数可额外购买30次。\n3.开启潜能开发，更容易洗出高属性。\n4.精力购买：每天可购买精力4次。\n5.含VIP2所有功能。\n6.VIP充值奖励：勋章*20，经验丹*60，二级宝石袋*2\n银币*1500000",tax_count=10,tax_ratio=1.10,tax_bonus_max=20,training_slot_max=9999,training_ratio_max=3,dock_slot_max=2,dock_steal_max=10,dock_count_max=99999,dock_protect=0,horse_slot_max=2,forge_discount=1.00,forge_advance=1,forge_crit=0,polish_rare=1,polish_epic=0,jump_gold=1,jump_ratio=1.00,arena_count_max=30,cave_count_max=9,capture_max=3,daily_task_max=5,daily_task_refresh=0,ap_charge_max=4,vip_mall=0,vip_pack=0,vip_pack_price=0,auto_fate=0,team_raid_reset_count=0,},{vip_level=4,total_charge=2000,desc="1.开启超级提取,提取时获得大量经验值。\n2.竞技场挑战次数可额外购买50次。\n3.精力购买：每天可购买精力6次。\n4.开启第四个奴隶位。\n5.精英副本可购买一次重置机会。\n5.含VIP3所有功能。\n6.VIP充值奖励：勋章*30，经验丹*80，二级宝石袋*3\n银币*2000000",tax_count=10,tax_ratio=1.10,tax_bonus_max=25,training_slot_max=9999,training_ratio_max=3,dock_slot_max=2,dock_steal_max=10,dock_count_max=99999,dock_protect=0,horse_slot_max=2,forge_discount=1.00,forge_advance=1,forge_crit=0,polish_rare=1,polish_epic=0,jump_gold=1,jump_ratio=1.25,arena_count_max=50,cave_count_max=10,capture_max=4,daily_task_max=7,daily_task_refresh=0,ap_charge_max=6,vip_mall=0,vip_pack=0,vip_pack_price=0,auto_fate=0,team_raid_reset_count=1,},{vip_level=5,total_charge=5000,desc="1.竞技场挑战次数可额外购买150次。\n2.开启“生命之海”佣兵任务。\n3.含VIP4所有功能。\n4.可免费一键祭星。\n5.VIP充值奖励：勋章*50，经验丹*120，三级宝石*2\n银币*3000000",tax_count=10,tax_ratio=1.15,tax_bonus_max=30,training_slot_max=9999,training_ratio_max=3,dock_slot_max=3,dock_steal_max=10,dock_count_max=99999,dock_protect=0,horse_slot_max=2,forge_discount=1.00,forge_advance=1,forge_crit=0,polish_rare=1,polish_epic=0,jump_gold=1,jump_ratio=1.25,arena_count_max=150,cave_count_max=11,capture_max=4,daily_task_max=9,daily_task_refresh=0,ap_charge_max=6,vip_mall=0,vip_pack=0,vip_pack_price=0,auto_fate=1,team_raid_reset_count=1,},{vip_level=6,total_charge=10000,desc="1.竞技场挑战次数可额外购买250次。\n2.精力购买：每天可购买精力21次。\n3.开启第五个奴隶位。\n4.开启醍醐灌顶，更容易洗出高属性。\n5.精英副本可购买2次重置机会。\n5.含VIP5所有功能。\n6VIP充值奖励：勋章*70,经验丹*160，三级宝石袋*3\n银币*4000000",tax_count=10,tax_ratio=1.15,tax_bonus_max=35,training_slot_max=9999,training_ratio_max=3,dock_slot_max=3,dock_steal_max=10,dock_count_max=99999,dock_protect=0,horse_slot_max=3,forge_discount=1.00,forge_advance=1,forge_crit=0,polish_rare=1,polish_epic=1,jump_gold=1,jump_ratio=1.50,arena_count_max=250,cave_count_max=12,capture_max=5,daily_task_max=9,daily_task_refresh=0,ap_charge_max=21,vip_mall=0,vip_pack=0,vip_pack_price=0,auto_fate=1,team_raid_reset_count=2,},{vip_level=7,total_charge=20000,desc="1.开启魔鬼训练，训练效果提升3倍。\n2.开启第六个奴隶位。\n2.精英副本可购买3次重置机会。\n3.含VIP6所有功能。\n4.VIP充值奖励：勋章*100,经验丹*200，四级宝石袋*2\n银币*6000000",tax_count=10,tax_ratio=1.20,tax_bonus_max=40,training_slot_max=9999,training_ratio_max=4,dock_slot_max=3,dock_steal_max=10,dock_count_max=99999,dock_protect=0,horse_slot_max=3,forge_discount=1.00,forge_advance=1,forge_crit=0,polish_rare=1,polish_epic=1,jump_gold=1,jump_ratio=1.50,arena_count_max=250,cave_count_max=13,capture_max=6,daily_task_max=99999,daily_task_refresh=0,ap_charge_max=21,vip_mall=0,vip_pack=0,vip_pack_price=0,auto_fate=1,team_raid_reset_count=2,},{vip_level=8,total_charge=50000,desc="1.开启魔鬼提取,提取时获得海量经验值。\n2.竞技场挑战次数可额外购买500次。\n3.开启“魔神炼狱”佣兵任务。\n4.精力购买：每天可购买精力46次。\n5.含VIP7所有功能。\n6.VIP充值奖励：勋章*150，经验丹*320，四级宝石袋*4\n银币*8000000",tax_count=10,tax_ratio=1.20,tax_bonus_max=45,training_slot_max=9999,training_ratio_max=4,dock_slot_max=4,dock_steal_max=10,dock_count_max=99999,dock_protect=0,horse_slot_max=3,forge_discount=1.00,forge_advance=1,forge_crit=0,polish_rare=1,polish_epic=1,jump_gold=1,jump_ratio=1.75,arena_count_max=500,cave_count_max=14,capture_max=6,daily_task_max=99999,daily_task_refresh=0,ap_charge_max=46,vip_mall=0,vip_pack=0,vip_pack_price=0,auto_fate=1,team_raid_reset_count=3,},{vip_level=9,total_charge=100000,desc="1.含VIP8所有功能。\n2.VIP充值奖励：勋章*200，经验丹*400，五级宝石袋*5\n银币*10000000",tax_count=10,tax_ratio=1.20,tax_bonus_max=50,training_slot_max=9999,training_ratio_max=4,dock_slot_max=4,dock_steal_max=10,dock_count_max=99999,dock_protect=0,horse_slot_max=3,forge_discount=1.00,forge_advance=1,forge_crit=0,polish_rare=1,polish_epic=1,jump_gold=1,jump_ratio=2.00,arena_count_max=500,cave_count_max=15,capture_max=6,daily_task_max=99999,daily_task_refresh=0,ap_charge_max=46,vip_mall=0,vip_pack=0,vip_pack_price=0,auto_fate=1,team_raid_reset_count=3,},{vip_level=10,total_charge=500000,desc="1.竞技场挑战可额外增加次数无限制。\n2.精力购买：每天可购买精力60次。\n3.含VIP9所有功能。\n4.VIP充值奖励：勋章*500，经验丹*1000，六级宝石袋*6\n银币*30000000",tax_count=10,tax_ratio=1.20,tax_bonus_max=55,training_slot_max=9999,training_ratio_max=4,dock_slot_max=4,dock_steal_max=10,dock_count_max=99999,dock_protect=0,horse_slot_max=3,forge_discount=1.00,forge_advance=1,forge_crit=0,polish_rare=1,polish_epic=1,jump_gold=1,jump_ratio=2.00,arena_count_max=9999,cave_count_max=5,capture_max=6,daily_task_max=99999,daily_task_refresh=0,ap_charge_max=60,vip_mall=0,vip_pack=0,vip_pack_price=0,auto_fate=1,team_raid_reset_count=3,},}
cfg_army_data = {[10101]={cfg_army_id=10101,cfg_camp_id=101,camp_type=1,name="幼黄小龙",level=2,face=170011,figure=170011,desc="",order=1,require=0,reward_exploit=20,reward_prestige=30,reward_exp=100,reward_copper=100,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=170011,pos_3=0,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=6},[10102]={cfg_army_id=10102,cfg_camp_id=101,camp_type=1,name="山姆",level=3,face=170012,figure=170012,desc="",order=2,require=1,reward_exploit=22,reward_prestige=40,reward_exp=110,reward_copper=120,reward_item=43030001,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=170012,pos_3=0,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=11},[10103]={cfg_army_id=10103,cfg_camp_id=101,camp_type=1,name="伽尔",level=4,face=170014,figure=170014,desc="",order=3,require=2,reward_exploit=24,reward_prestige=60,reward_exp=130,reward_copper=140,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=170014,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=17},[10104]={cfg_army_id=10104,cfg_camp_id=101,camp_type=1,name="尖角镰刃",level=5,face=170002,figure=170002,desc="",order=4,require=3,reward_exploit=26,reward_prestige=80,reward_exp=170,reward_copper=160,reward_item=43030001,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=170002,pos_5=0,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=22},[10105]={cfg_army_id=10105,cfg_camp_id=101,camp_type=1,name="穆林",level=6,face=170003,figure=170003,desc="",order=5,require=4,reward_exploit=28,reward_prestige=100,reward_exp=210,reward_copper=180,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=0,pos_5=0,pos_6=170003,pos_7=170003,pos_8=0,pos_9=0,complete_percent=28},[10106]={cfg_army_id=10106,cfg_camp_id=101,camp_type=1,name="酷斯拉",level=7,face=170004,figure=170004,desc="",order=6,require=5,reward_exploit=30,reward_prestige=120,reward_exp=250,reward_copper=200,reward_item=43030001,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=0,pos_5=170004,pos_6=0,pos_7=0,pos_8=170004,pos_9=0,complete_percent=33},[10107]={cfg_army_id=10107,cfg_camp_id=101,camp_type=1,name="炉火",level=8,face=120011,figure=120011,desc="",order=7,require=6,reward_exploit=32,reward_prestige=140,reward_exp=310,reward_copper=220,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=120011,pos_3=0,pos_4=120011,pos_5=0,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=39},[10108]={cfg_army_id=10108,cfg_camp_id=101,camp_type=1,name="熔炉",level=9,face=120041,figure=120041,desc="",order=8,require=7,reward_exploit=34,reward_prestige=160,reward_exp=370,reward_copper=240,reward_item=43030001,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=120041,pos_4=0,pos_5=0,pos_6=120011,pos_7=0,pos_8=0,pos_9=0,complete_percent=44},[10109]={cfg_army_id=10109,cfg_camp_id=101,camp_type=1,name="精灵龙",level=10,face=170003,figure=170003,desc="",order=9,require=8,reward_exploit=36,reward_prestige=180,reward_exp=430,reward_copper=270,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170003,pos_2=0,pos_3=0,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=120011,pos_9=0,complete_percent=50},[10110]={cfg_army_id=10110,cfg_camp_id=101,camp_type=1,name="铁甲龙",level=11,face=170021,figure=170021,desc="",order=10,require=9,reward_exploit=38,reward_prestige=200,reward_exp=520,reward_copper=300,reward_item=43030001,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170021,pos_2=0,pos_3=0,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=170013,pos_9=0,complete_percent=56},[10111]={cfg_army_id=10111,cfg_camp_id=101,camp_type=1,name="铁甲紫龙",level=12,face=170025,figure=170025,desc="",order=11,require=10,reward_exploit=40,reward_prestige=230,reward_exp=610,reward_copper=330,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=0,pos_5=170025,pos_6=0,pos_7=170012,pos_8=0,pos_9=0,complete_percent=61},[10112]={cfg_army_id=10112,cfg_camp_id=101,camp_type=1,name="铁甲红龙",level=13,face=170021,figure=170021,desc="",order=12,require=11,reward_exploit=42,reward_prestige=260,reward_exp=700,reward_copper=360,reward_item=43030001,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=170021,pos_4=0,pos_5=170012,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=67},[10113]={cfg_army_id=10113,cfg_camp_id=101,camp_type=1,name="岩火男爵",level=14,face=120041,figure=120041,desc="",order=13,require=12,reward_exploit=44,reward_prestige=290,reward_exp=820,reward_copper=390,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=120041,pos_3=0,pos_4=0,pos_5=120041,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=72},[10114]={cfg_army_id=10114,cfg_camp_id=101,camp_type=1,name="丧魂幼狮",level=15,face=210005,figure=210005,desc="",order=14,require=13,reward_exploit=46,reward_prestige=320,reward_exp=940,reward_copper=420,reward_item=43030001,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=160013,pos_2=210005,pos_3=0,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=78},[10115]={cfg_army_id=10115,cfg_camp_id=101,camp_type=1,name="丧魂甲龙",level=16,face=210003,figure=210003,desc="",order=15,require=14,reward_exploit=48,reward_prestige=350,reward_exp=1060,reward_copper=450,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=210002,pos_2=0,pos_3=210002,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=210003,pos_9=0,complete_percent=83},[10116]={cfg_army_id=10116,cfg_camp_id=101,camp_type=1,name="飞翼紫龙",level=17,face=300001,figure=300001,desc="",order=16,require=15,reward_exploit=50,reward_prestige=380,reward_exp=1210,reward_copper=480,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=210001,pos_2=0,pos_3=210001,pos_4=0,pos_5=300001,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=89},[10117]={cfg_army_id=10117,cfg_camp_id=101,camp_type=1,name="树妖",level=18,face=260002,figure=260002,desc="",order=17,require=16,reward_exploit=52,reward_prestige=410,reward_exp=1360,reward_copper=510,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=190002,pos_5=0,pos_6=190002,pos_7=0,pos_8=260002,pos_9=0,complete_percent=94},[10118]={cfg_army_id=10118,cfg_camp_id=101,camp_type=1,name="石僵尸",level=19,face=260001,figure=260001,desc="",order=18,require=17,reward_exploit=54,reward_prestige=440,reward_exp=1510,reward_copper=540,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=320002,pos_5=260001,pos_6=320002,pos_7=0,pos_8=0,pos_9=0,complete_percent=100},[10201]={cfg_army_id=10201,cfg_camp_id=102,camp_type=1,name="变异竹节怪",level=20,face=250002,figure=250002,desc="",order=1,require=0,reward_exploit=57,reward_prestige=460,reward_exp=1690,reward_copper=580,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=150001,pos_2=0,pos_3=150001,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=250002,pos_9=0,complete_percent=5},[10202]={cfg_army_id=10202,cfg_camp_id=102,camp_type=1,name="魔鹰",level=20,face=250004,figure=250004,desc="",order=2,require=0,reward_exploit=58,reward_prestige=470,reward_exp=1760,reward_copper=600,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130012,pos_2=0,pos_3=130012,pos_4=0,pos_5=250004,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=10},[10203]={cfg_army_id=10203,cfg_camp_id=102,camp_type=1,name="游荡雄狮",level=21,face=160013,figure=160013,desc="",order=3,require=2,reward_exploit=60,reward_prestige=480,reward_exp=1870,reward_copper=620,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=160013,pos_3=0,pos_4=160013,pos_5=0,pos_6=160013,pos_7=0,pos_8=0,pos_9=0,complete_percent=15},[10204]={cfg_army_id=10204,cfg_camp_id=102,camp_type=1,name="帕里斯",level=21,face=160013,figure=160013,desc="",order=4,require=2,reward_exploit=61,reward_prestige=490,reward_exp=1940,reward_copper=640,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=160013,pos_5=0,pos_6=160013,pos_7=0,pos_8=160013,pos_9=0,complete_percent=20},[10205]={cfg_army_id=10205,cfg_camp_id=102,camp_type=1,name="调皮树妖",level=22,face=190011,figure=190011,desc="",order=5,require=4,reward_exploit=63,reward_prestige=500,reward_exp=2050,reward_copper=660,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190002,pos_2=0,pos_3=190002,pos_4=0,pos_5=190011,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=25},[10206]={cfg_army_id=10206,cfg_camp_id=102,camp_type=1,name="蘑菇妖",level=22,face=250001,figure=250001,desc="",order=6,require=4,reward_exploit=64,reward_prestige=510,reward_exp=2120,reward_copper=680,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=250002,pos_2=0,pos_3=250002,pos_4=0,pos_5=250001,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=30},[10207]={cfg_army_id=10207,cfg_camp_id=102,camp_type=1,name="顽皮冰童",level=23,face=280003,figure=280003,desc="",order=7,require=6,reward_exploit=66,reward_prestige=520,reward_exp=2230,reward_copper=700,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=0,pos_5=280003,pos_6=0,pos_7=140011,pos_8=0,pos_9=140011,complete_percent=35},[10208]={cfg_army_id=10208,cfg_camp_id=102,camp_type=1,name="小冰人",level=23,face=280001,figure=280001,desc="",order=8,require=6,reward_exploit=67,reward_prestige=530,reward_exp=2300,reward_copper=720,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=140011,pos_5=0,pos_6=140011,pos_7=0,pos_8=280001,pos_9=0,complete_percent=40},[10209]={cfg_army_id=10209,cfg_camp_id=102,camp_type=1,name="巡逻队长",level=24,face=140045,figure=140045,desc="",order=9,require=8,reward_exploit=69,reward_prestige=540,reward_exp=2410,reward_copper=740,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140045,pos_2=0,pos_3=0,pos_4=140045,pos_5=0,pos_6=140045,pos_7=0,pos_8=0,pos_9=0,complete_percent=45},[10210]={cfg_army_id=10210,cfg_camp_id=102,camp_type=1,name="冰女王",level=24,face=280002,figure=280002,desc="",order=10,require=8,reward_exploit=70,reward_prestige=550,reward_exp=2480,reward_copper=760,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=0,pos_3=130045,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=280002,pos_9=0,complete_percent=50},[10211]={cfg_army_id=10211,cfg_camp_id=102,camp_type=1,name="堕落火元素",level=25,face=120011,figure=120011,desc="",order=11,require=10,reward_exploit=72,reward_prestige=560,reward_exp=2590,reward_copper=780,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=120011,pos_3=0,pos_4=0,pos_5=0,pos_6=0,pos_7=120011,pos_8=0,pos_9=120011,complete_percent=55},[10212]={cfg_army_id=10212,cfg_camp_id=102,camp_type=1,name="雷精灵",level=25,face=240001,figure=240001,desc="",order=12,require=10,reward_exploit=73,reward_prestige=570,reward_exp=2660,reward_copper=800,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=160013,pos_2=0,pos_3=160013,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=240001,pos_9=0,complete_percent=60},[10213]={cfg_army_id=10213,cfg_camp_id=102,camp_type=1,name="小金果",level=26,face=190002,figure=190002,desc="",order=13,require=12,reward_exploit=75,reward_prestige=580,reward_exp=2770,reward_copper=820,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=250002,pos_5=250001,pos_6=250002,pos_7=0,pos_8=190002,pos_9=0,complete_percent=65},[10214]={cfg_army_id=10214,cfg_camp_id=102,camp_type=1,name="蓝果妖",level=26,face=190002,figure=190002,desc="",order=14,require=12,reward_exploit=76,reward_prestige=590,reward_exp=2840,reward_copper=840,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190002,pos_2=0,pos_3=190002,pos_4=0,pos_5=190002,pos_6=0,pos_7=0,pos_8=190011,pos_9=0,complete_percent=70},[10215]={cfg_army_id=10215,cfg_camp_id=102,camp_type=1,name="真知球卫士",level=27,face=130012,figure=130012,desc="",order=15,require=14,reward_exploit=78,reward_prestige=600,reward_exp=2950,reward_copper=860,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130012,pos_2=0,pos_3=130012,pos_4=0,pos_5=130012,pos_6=0,pos_7=0,pos_8=130012,pos_9=0,complete_percent=75},[10216]={cfg_army_id=10216,cfg_camp_id=102,camp_type=1,name="真知球守卫",level=27,face=130045,figure=130045,desc="",order=16,require=14,reward_exploit=79,reward_prestige=610,reward_exp=3020,reward_copper=880,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130012,pos_2=0,pos_3=130012,pos_4=0,pos_5=130045,pos_6=0,pos_7=0,pos_8=130045,pos_9=0,complete_percent=80},[10217]={cfg_army_id=10217,cfg_camp_id=102,camp_type=1,name="真知球护领",level=28,face=130045,figure=130045,desc="",order=17,require=16,reward_exploit=81,reward_prestige=620,reward_exp=3130,reward_copper=900,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=260001,pos_3=0,pos_4=0,pos_5=130045,pos_6=0,pos_7=140045,pos_8=0,pos_9=140045,complete_percent=85},[10218]={cfg_army_id=10218,cfg_camp_id=102,camp_type=1,name="萨鲁曼",level=28,face=260001,figure=260001,desc="",order=18,require=16,reward_exploit=82,reward_prestige=630,reward_exp=3200,reward_copper=920,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=250003,pos_2=0,pos_3=250003,pos_4=0,pos_5=260001,pos_6=0,pos_7=0,pos_8=280001,pos_9=0,complete_percent=90},[10219]={cfg_army_id=10219,cfg_camp_id=102,camp_type=1,name="魔化菇妖",level=29,face=250001,figure=250001,desc="",order=19,require=18,reward_exploit=84,reward_prestige=640,reward_exp=3310,reward_copper=940,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=250002,pos_3=0,pos_4=250004,pos_5=0,pos_6=250004,pos_7=0,pos_8=250001,pos_9=0,complete_percent=95},[10220]={cfg_army_id=10220,cfg_camp_id=102,camp_type=1,name="雷精灵真身",level=29,face=240001,figure=240001,desc="",order=20,require=18,reward_exploit=85,reward_prestige=650,reward_exp=3380,reward_copper=960,reward_item=43990002,drop_ratio=0.500,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=260001,pos_3=0,pos_4=130045,pos_5=0,pos_6=130045,pos_7=0,pos_8=240001,pos_9=0,complete_percent=100},[10301]={cfg_army_id=10301,cfg_camp_id=103,camp_type=1,name="小青狐",level=30,face=220001,figure=220001,desc="",order=1,require=0,reward_exploit=88,reward_prestige=670,reward_exp=3530,reward_copper=1000,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=0,pos_3=220001,pos_4=0,pos_5=220001,pos_6=0,pos_7=0,pos_8=220001,pos_9=0,complete_percent=5},[10302]={cfg_army_id=10302,cfg_camp_id=103,camp_type=1,name="黄狐精灵",level=30,face=220001,figure=220001,desc="",order=2,require=0,reward_exploit=89,reward_prestige=680,reward_exp=3600,reward_copper=1020,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=220001,pos_3=0,pos_4=220001,pos_5=0,pos_6=220001,pos_7=0,pos_8=220001,pos_9=0,complete_percent=10},[10303]={cfg_army_id=10303,cfg_camp_id=103,camp_type=1,name="树果仔",level=31,face=190002,figure=190002,desc="",order=3,require=2,reward_exploit=92,reward_prestige=700,reward_exp=3750,reward_copper=1060,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=190011,pos_3=0,pos_4=190002,pos_5=0,pos_6=190002,pos_7=0,pos_8=190002,pos_9=0,complete_percent=15},[10304]={cfg_army_id=10304,cfg_camp_id=103,camp_type=1,name="石树龟",level=31,face=320002,figure=320002,desc="",order=4,require=2,reward_exploit=93,reward_prestige=710,reward_exp=3820,reward_copper=1080,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=320002,pos_3=0,pos_4=110001,pos_5=250001,pos_6=110001,pos_7=0,pos_8=0,pos_9=0,complete_percent=20},[10305]={cfg_army_id=10305,cfg_camp_id=103,camp_type=1,name="树龟小弟",level=32,face=320002,figure=320002,desc="",order=5,require=4,reward_exploit=96,reward_prestige=730,reward_exp=3970,reward_copper=1120,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=190002,pos_5=320002,pos_6=190002,pos_7=0,pos_8=250002,pos_9=0,complete_percent=25},[10306]={cfg_army_id=10306,cfg_camp_id=103,camp_type=1,name="海树龟",level=32,face=310001,figure=310001,desc="",order=6,require=4,reward_exploit=97,reward_prestige=740,reward_exp=4040,reward_copper=1140,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=310001,pos_3=0,pos_4=0,pos_5=0,pos_6=0,pos_7=320002,pos_8=190011,pos_9=320002,complete_percent=30},[10307]={cfg_army_id=10307,cfg_camp_id=103,camp_type=1,name="小粉猫",level=33,face=220012,figure=220012,desc="",order=7,require=6,reward_exploit=100,reward_prestige=760,reward_exp=4190,reward_copper=1180,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=220012,pos_5=220012,pos_6=220012,pos_7=0,pos_8=220012,pos_9=0,complete_percent=35},[10308]={cfg_army_id=10308,cfg_camp_id=103,camp_type=1,name="花大猫",level=33,face=220012,figure=220012,desc="",order=8,require=6,reward_exploit=101,reward_prestige=770,reward_exp=4260,reward_copper=1200,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220012,pos_2=0,pos_3=220012,pos_4=0,pos_5=220012,pos_6=0,pos_7=0,pos_8=220012,pos_9=0,complete_percent=40},[10309]={cfg_army_id=10309,cfg_camp_id=103,camp_type=1,name="紫蛙",level=34,face=150001,figure=150001,desc="",order=9,require=8,reward_exploit=104,reward_prestige=790,reward_exp=4410,reward_copper=1240,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=150001,pos_2=0,pos_3=150001,pos_4=0,pos_5=0,pos_6=0,pos_7=150001,pos_8=0,pos_9=150001,complete_percent=45},[10310]={cfg_army_id=10310,cfg_camp_id=103,camp_type=1,name="赭蛙行者",level=34,face=150001,figure=150001,desc="",order=10,require=8,reward_exploit=105,reward_prestige=800,reward_exp=4480,reward_copper=1260,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=150001,pos_2=0,pos_3=150001,pos_4=0,pos_5=150001,pos_6=0,pos_7=0,pos_8=150001,pos_9=0,complete_percent=50},[10311]={cfg_army_id=10311,cfg_camp_id=103,camp_type=1,name="顽皮小灰",level=35,face=230001,figure=230001,desc="",order=11,require=10,reward_exploit=108,reward_prestige=820,reward_exp=4630,reward_copper=1300,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=230001,pos_3=0,pos_4=230001,pos_5=230001,pos_6=230001,pos_7=0,pos_8=0,pos_9=0,complete_percent=55},[10312]={cfg_army_id=10312,cfg_camp_id=103,camp_type=1,name="顽皮熊",level=35,face=230001,figure=230001,desc="",order=12,require=10,reward_exploit=109,reward_prestige=830,reward_exp=4700,reward_copper=1320,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=230001,pos_2=230001,pos_3=230001,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=230001,pos_9=0,complete_percent=60},[10313]={cfg_army_id=10313,cfg_camp_id=103,camp_type=1,name="小蓝果",level=36,face=190002,figure=190002,desc="",order=13,require=12,reward_exploit=112,reward_prestige=850,reward_exp=4850,reward_copper=1360,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190002,pos_2=0,pos_3=190002,pos_4=190002,pos_5=0,pos_6=190002,pos_7=0,pos_8=190002,pos_9=0,complete_percent=65},[10314]={cfg_army_id=10314,cfg_camp_id=103,camp_type=1,name="红果妖",level=36,face=190002,figure=190002,desc="",order=14,require=12,reward_exploit=113,reward_prestige=860,reward_exp=4920,reward_copper=1380,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=190002,pos_3=0,pos_4=190002,pos_5=0,pos_6=190002,pos_7=190002,pos_8=0,pos_9=190002,complete_percent=70},[10315]={cfg_army_id=10315,cfg_camp_id=103,camp_type=1,name="绿果仔",level=37,face=190011,figure=190011,desc="",order=15,require=14,reward_exploit=116,reward_prestige=880,reward_exp=5070,reward_copper=1420,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=190011,pos_3=0,pos_4=190002,pos_5=190002,pos_6=190002,pos_7=0,pos_8=190002,pos_9=0,complete_percent=75},[10316]={cfg_army_id=10316,cfg_camp_id=103,camp_type=1,name="蓝果人",level=37,face=190011,figure=190011,desc="",order=16,require=14,reward_exploit=117,reward_prestige=890,reward_exp=5140,reward_copper=1440,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190011,pos_2=0,pos_3=190011,pos_4=0,pos_5=190011,pos_6=0,pos_7=190002,pos_8=0,pos_9=190002,complete_percent=80},[10317]={cfg_army_id=10317,cfg_camp_id=103,camp_type=1,name="蓝果仔",level=38,face=190011,figure=190011,desc="",order=17,require=16,reward_exploit=120,reward_prestige=910,reward_exp=5290,reward_copper=1480,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=190011,pos_4=0,pos_5=190011,pos_6=190002,pos_7=190011,pos_8=190002,pos_9=0,complete_percent=85},[10318]={cfg_army_id=10318,cfg_camp_id=103,camp_type=1,name="黄果人",level=38,face=190011,figure=190011,desc="",order=18,require=16,reward_exploit=121,reward_prestige=920,reward_exp=5360,reward_copper=1500,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190011,pos_2=0,pos_3=190011,pos_4=190011,pos_5=0,pos_6=190011,pos_7=0,pos_8=190011,pos_9=0,complete_percent=90},[10319]={cfg_army_id=10319,cfg_camp_id=103,camp_type=1,name="黄果仔",level=39,face=190011,figure=190011,desc="",order=19,require=18,reward_exploit=124,reward_prestige=940,reward_exp=5510,reward_copper=1540,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=190011,pos_5=190011,pos_6=190011,pos_7=190002,pos_8=0,pos_9=190002,complete_percent=95},[10320]={cfg_army_id=10320,cfg_camp_id=103,camp_type=1,name="红果人",level=39,face=190011,figure=190011,desc="",order=20,require=18,reward_exploit=125,reward_prestige=950,reward_exp=5580,reward_copper=1560,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190011,pos_2=190011,pos_3=190011,pos_4=0,pos_5=190011,pos_6=0,pos_7=0,pos_8=130045,pos_9=0,complete_percent=100},[10401]={cfg_army_id=10401,cfg_camp_id=104,camp_type=1,name="天后卫士",level=40,face=130045,figure=130045,desc="",order=1,require=0,reward_exploit=129,reward_prestige=980,reward_exp=5780,reward_copper=1630,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=0,pos_6=0,pos_7=130045,pos_8=0,pos_9=130045,complete_percent=3},[10402]={cfg_army_id=10402,cfg_camp_id=104,camp_type=1,name="天后守护者",level=40,face=130045,figure=130045,desc="",order=2,require=0,reward_exploit=130,reward_prestige=990,reward_exp=5850,reward_copper=1650,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130045,pos_3=0,pos_4=130012,pos_5=0,pos_6=130012,pos_7=130045,pos_8=0,pos_9=130045,complete_percent=7},[10403]={cfg_army_id=10403,cfg_camp_id=104,camp_type=1,name="赫拉魔影",level=40,face=200001,figure=200001,desc="",order=3,require=0,reward_exploit=132,reward_prestige=1000,reward_exp=5920,reward_copper=1680,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=200001,pos_6=0,pos_7=0,pos_8=130045,pos_9=0,complete_percent=10},[10404]={cfg_army_id=10404,cfg_camp_id=104,camp_type=1,name="贪吃熊",level=41,face=230001,figure=230001,desc="",order=4,require=3,reward_exploit=134,reward_prestige=1020,reward_exp=6050,reward_copper=1720,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=230001,pos_2=0,pos_3=230001,pos_4=230001,pos_5=0,pos_6=230001,pos_7=0,pos_8=230001,pos_9=0,complete_percent=13},[10405]={cfg_army_id=10405,cfg_camp_id=104,camp_type=1,name="贪睡熊",level=41,face=230001,figure=230001,desc="",order=5,require=3,reward_exploit=135,reward_prestige=1030,reward_exp=6120,reward_copper=1740,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=230001,pos_2=230001,pos_3=230001,pos_4=0,pos_5=230001,pos_6=0,pos_7=0,pos_8=230001,pos_9=0,complete_percent=17},[10406]={cfg_army_id=10406,cfg_camp_id=104,camp_type=1,name="贪色小灰",level=41,face=230001,figure=230001,desc="",order=6,require=3,reward_exploit=137,reward_prestige=1040,reward_exp=6190,reward_copper=1770,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=230001,pos_2=0,pos_3=230001,pos_4=0,pos_5=230001,pos_6=0,pos_7=230001,pos_8=0,pos_9=230001,complete_percent=20},[10407]={cfg_army_id=10407,cfg_camp_id=104,camp_type=1,name="洛基守卫",level=42,face=130045,figure=130045,desc="",order=7,require=6,reward_exploit=139,reward_prestige=1060,reward_exp=6320,reward_copper=1810,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130045,pos_3=0,pos_4=120011,pos_5=0,pos_6=120011,pos_7=120011,pos_8=0,pos_9=120011,complete_percent=23},[10408]={cfg_army_id=10408,cfg_camp_id=104,camp_type=1,name="洛基卫士",level=42,face=120041,figure=120041,desc="",order=8,require=6,reward_exploit=140,reward_prestige=1070,reward_exp=6390,reward_copper=1830,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120011,pos_2=0,pos_3=120011,pos_4=0,pos_5=120041,pos_6=0,pos_7=120011,pos_8=0,pos_9=120011,complete_percent=27},[10409]={cfg_army_id=10409,cfg_camp_id=104,camp_type=1,name="洛基魔影",level=42,face=200002,figure=200002,desc="",order=9,require=6,reward_exploit=142,reward_prestige=1080,reward_exp=6460,reward_copper=1860,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120011,pos_2=120011,pos_3=120011,pos_4=0,pos_5=200002,pos_6=0,pos_7=0,pos_8=120041,pos_9=0,complete_percent=30},[10410]={cfg_army_id=10410,cfg_camp_id=104,camp_type=1,name="四角绿蛇",level=43,face=180002,figure=180002,desc="",order=10,require=9,reward_exploit=144,reward_prestige=1100,reward_exp=6590,reward_copper=1900,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=180002,pos_4=180002,pos_5=0,pos_6=180002,pos_7=0,pos_8=180002,pos_9=0,complete_percent=33},[10411]={cfg_army_id=10411,cfg_camp_id=104,camp_type=1,name="四角红蛇",level=43,face=180002,figure=180002,desc="",order=11,require=9,reward_exploit=145,reward_prestige=1110,reward_exp=6660,reward_copper=1920,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=180002,pos_4=180002,pos_5=180002,pos_6=180002,pos_7=0,pos_8=0,pos_9=0,complete_percent=37},[10412]={cfg_army_id=10412,cfg_camp_id=104,camp_type=1,name="四角蓝蛇",level=43,face=180002,figure=180002,desc="",order=12,require=9,reward_exploit=147,reward_prestige=1120,reward_exp=6730,reward_copper=1950,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=180002,pos_4=180002,pos_5=0,pos_6=180002,pos_7=0,pos_8=180002,pos_9=0,complete_percent=40},[10413]={cfg_army_id=10413,cfg_camp_id=104,camp_type=1,name="蓝水灵",level=44,face=140045,figure=140045,desc="",order=13,require=12,reward_exploit=149,reward_prestige=1140,reward_exp=6860,reward_copper=1990,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140011,pos_2=140045,pos_3=140011,pos_4=0,pos_5=0,pos_6=0,pos_7=140011,pos_8=0,pos_9=140011,complete_percent=43},[10414]={cfg_army_id=10414,cfg_camp_id=104,camp_type=1,name="深红水灵",level=44,face=140045,figure=140045,desc="",order=14,require=12,reward_exploit=150,reward_prestige=1150,reward_exp=6930,reward_copper=2010,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140045,pos_2=140011,pos_3=140045,pos_4=0,pos_5=140045,pos_6=0,pos_7=0,pos_8=140011,pos_9=0,complete_percent=47},[10415]={cfg_army_id=10415,cfg_camp_id=104,camp_type=1,name="维纳斯魔影",level=44,face=200003,figure=200003,desc="",order=15,require=12,reward_exploit=152,reward_prestige=1160,reward_exp=7000,reward_copper=2040,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140045,pos_2=0,pos_3=140045,pos_4=140045,pos_5=200003,pos_6=140045,pos_7=0,pos_8=0,pos_9=0,complete_percent=50},[10416]={cfg_army_id=10416,cfg_camp_id=104,camp_type=1,name="黄狮幼龙",level=45,face=170002,figure=170002,desc="",order=16,require=15,reward_exploit=154,reward_prestige=1180,reward_exp=7130,reward_copper=2080,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=160013,pos_2=0,pos_3=160013,pos_4=0,pos_5=170002,pos_6=0,pos_7=170004,pos_8=0,pos_9=170004,complete_percent=53},[10417]={cfg_army_id=10417,cfg_camp_id=104,camp_type=1,name="三尾魔狐",level=45,face=220001,figure=220001,desc="",order=17,require=15,reward_exploit=155,reward_prestige=1190,reward_exp=7200,reward_copper=2100,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=0,pos_3=220001,pos_4=220001,pos_5=0,pos_6=220001,pos_7=0,pos_8=220001,pos_9=0,complete_percent=57},[10418]={cfg_army_id=10418,cfg_camp_id=104,camp_type=1,name="四角紫蛇",level=45,face=180002,figure=180002,desc="",order=18,require=15,reward_exploit=157,reward_prestige=1200,reward_exp=7270,reward_copper=2130,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=180002,pos_4=180002,pos_5=0,pos_6=180002,pos_7=0,pos_8=180002,pos_9=0,complete_percent=60},[10419]={cfg_army_id=10419,cfg_camp_id=104,camp_type=1,name="大耳黄狮仔",level=46,face=160013,figure=160013,desc="",order=19,require=18,reward_exploit=159,reward_prestige=1220,reward_exp=7400,reward_copper=2170,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=160013,pos_4=0,pos_5=160013,pos_6=160013,pos_7=160013,pos_8=160013,pos_9=0,complete_percent=63},[10420]={cfg_army_id=10420,cfg_camp_id=104,camp_type=1,name="幼绿魔狮",level=46,face=160013,figure=160013,desc="",order=20,require=18,reward_exploit=160,reward_prestige=1230,reward_exp=7470,reward_copper=2190,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=160013,pos_2=0,pos_3=160013,pos_4=160013,pos_5=160013,pos_6=160013,pos_7=0,pos_8=0,pos_9=0,complete_percent=67},[10421]={cfg_army_id=10421,cfg_camp_id=104,camp_type=1,name="奥丁魔影",level=46,face=200004,figure=200004,desc="",order=21,require=18,reward_exploit=162,reward_prestige=1240,reward_exp=7540,reward_copper=2220,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=110043,pos_6=0,pos_7=0,pos_8=200004,pos_9=0,complete_percent=70},[10422]={cfg_army_id=10422,cfg_camp_id=104,camp_type=1,name="异化黄水灵",level=47,face=140011,figure=140011,desc="",order=22,require=21,reward_exploit=164,reward_prestige=1260,reward_exp=7670,reward_copper=2260,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130012,pos_2=0,pos_3=140011,pos_4=140011,pos_5=110001,pos_6=0,pos_7=0,pos_8=0,pos_9=140011,complete_percent=73},[10423]={cfg_army_id=10423,cfg_camp_id=104,camp_type=1,name="异化紫水灵",level=47,face=140011,figure=140011,desc="",order=23,require=21,reward_exploit=165,reward_prestige=1270,reward_exp=7740,reward_copper=2280,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130012,pos_2=140011,pos_3=140011,pos_4=130012,pos_5=0,pos_6=140011,pos_7=0,pos_8=0,pos_9=0,complete_percent=77},[10424]={cfg_army_id=10424,cfg_camp_id=104,camp_type=1,name="调皮蓝水人",level=47,face=140011,figure=140011,desc="",order=24,require=21,reward_exploit=167,reward_prestige=1280,reward_exp=7810,reward_copper=2310,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140011,pos_2=0,pos_3=0,pos_4=140011,pos_5=130012,pos_6=140011,pos_7=140011,pos_8=0,pos_9=0,complete_percent=80},[10425]={cfg_army_id=10425,cfg_camp_id=104,camp_type=1,name="萌紫水人",level=48,face=140011,figure=140011,desc="",order=25,require=24,reward_exploit=169,reward_prestige=1300,reward_exp=7940,reward_copper=2350,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=110001,pos_2=0,pos_3=140011,pos_4=0,pos_5=0,pos_6=140011,pos_7=140011,pos_8=0,pos_9=130012,complete_percent=83},[10426]={cfg_army_id=10426,cfg_camp_id=104,camp_type=1,name="萌黄水人",level=48,face=140011,figure=140011,desc="",order=26,require=24,reward_exploit=170,reward_prestige=1310,reward_exp=8010,reward_copper=2370,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=110001,pos_2=0,pos_3=0,pos_4=110001,pos_5=140011,pos_6=0,pos_7=0,pos_8=140011,pos_9=140011,complete_percent=87},[10427]={cfg_army_id=10427,cfg_camp_id=104,camp_type=1,name="铁腕红水人",level=48,face=140011,figure=140011,desc="",order=27,require=24,reward_exploit=172,reward_prestige=1320,reward_exp=8080,reward_copper=2400,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140011,pos_2=0,pos_3=120011,pos_4=140011,pos_5=130012,pos_6=0,pos_7=140011,pos_8=0,pos_9=0,complete_percent=90},[10428]={cfg_army_id=10428,cfg_camp_id=104,camp_type=1,name="赤火斗士",level=49,face=120011,figure=120011,desc="",order=28,require=27,reward_exploit=174,reward_prestige=1340,reward_exp=8210,reward_copper=2440,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130012,pos_3=0,pos_4=120011,pos_5=130012,pos_6=0,pos_7=120011,pos_8=130012,pos_9=0,complete_percent=93},[10429]={cfg_army_id=10429,cfg_camp_id=104,camp_type=1,name="蓝焰斗士",level=49,face=120011,figure=120011,desc="",order=29,require=27,reward_exploit=175,reward_prestige=1350,reward_exp=8280,reward_copper=2460,reward_item=11100030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120011,pos_2=0,pos_3=130012,pos_4=120011,pos_5=0,pos_6=130012,pos_7=0,pos_8=0,pos_9=130012,complete_percent=97},[10430]={cfg_army_id=10430,cfg_camp_id=104,camp_type=1,name="赤炎火人",level=49,face=120011,figure=120011,desc="",order=30,require=27,reward_exploit=177,reward_prestige=1360,reward_exp=8350,reward_copper=2490,reward_item=43030030,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120011,pos_2=0,pos_3=130012,pos_4=0,pos_5=120011,pos_6=130012,pos_7=0,pos_8=0,pos_9=130012,complete_percent=100},[10501]={cfg_army_id=10501,cfg_camp_id=105,camp_type=1,name="蓝灵火人",level=50,face=120011,figure=120011,desc="",order=1,require=0,reward_exploit=180,reward_prestige=1400,reward_exp=8540,reward_copper=2570,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130012,pos_3=120011,pos_4=120011,pos_5=130012,pos_6=0,pos_7=0,pos_8=130012,pos_9=0,complete_percent=3},[10502]={cfg_army_id=10502,cfg_camp_id=105,camp_type=1,name="紫灵火人",level=50,face=120011,figure=120011,desc="",order=2,require=0,reward_exploit=181,reward_prestige=1420,reward_exp=8620,reward_copper=2600,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120011,pos_2=0,pos_3=130012,pos_4=120011,pos_5=0,pos_6=130012,pos_7=120011,pos_8=0,pos_9=0,complete_percent=7},[10503]={cfg_army_id=10503,cfg_camp_id=105,camp_type=1,name="幼蓝狮仔",level=50,face=160013,figure=160013,desc="",order=3,require=0,reward_exploit=183,reward_prestige=1440,reward_exp=8710,reward_copper=2640,reward_item=43030050,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=230001,pos_3=230001,pos_4=0,pos_5=160013,pos_6=0,pos_7=230001,pos_8=230001,pos_9=0,complete_percent=10},[10504]={cfg_army_id=10504,cfg_camp_id=105,camp_type=1,name="蓝狮兽",level=51,face=160013,figure=160013,desc="",order=4,require=3,reward_exploit=186,reward_prestige=1460,reward_exp=8870,reward_copper=2700,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=160013,pos_2=230001,pos_3=0,pos_4=230001,pos_5=230001,pos_6=0,pos_7=0,pos_8=230001,pos_9=0,complete_percent=13},[10505]={cfg_army_id=10505,cfg_camp_id=105,camp_type=1,name="红狮兽",level=51,face=160013,figure=160013,desc="",order=5,require=3,reward_exploit=187,reward_prestige=1480,reward_exp=8950,reward_copper=2730,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=230001,pos_2=0,pos_3=160013,pos_4=230001,pos_5=0,pos_6=0,pos_7=230001,pos_8=0,pos_9=230001,complete_percent=17},[10506]={cfg_army_id=10506,cfg_camp_id=105,camp_type=1,name="幼红狮仔",level=51,face=160013,figure=160013,desc="",order=6,require=3,reward_exploit=189,reward_prestige=1500,reward_exp=9040,reward_copper=2770,reward_item=43030050,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=230001,pos_3=0,pos_4=230001,pos_5=230001,pos_6=160013,pos_7=0,pos_8=230001,pos_9=0,complete_percent=20},[10507]={cfg_army_id=10507,cfg_camp_id=105,camp_type=1,name="幼紫沙兽",level=52,face=110001,figure=110001,desc="",order=7,require=6,reward_exploit=192,reward_prestige=1520,reward_exp=9200,reward_copper=2830,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=110001,pos_2=0,pos_3=0,pos_4=110001,pos_5=130012,pos_6=0,pos_7=0,pos_8=130012,pos_9=110001,complete_percent=23},[10508]={cfg_army_id=10508,cfg_camp_id=105,camp_type=1,name="幼蓝沙兽",level=52,face=110001,figure=110001,desc="",order=8,require=6,reward_exploit=193,reward_prestige=1540,reward_exp=9280,reward_copper=2860,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=110001,pos_4=140011,pos_5=110001,pos_6=110001,pos_7=0,pos_8=0,pos_9=110001,complete_percent=27},[10509]={cfg_army_id=10509,cfg_camp_id=105,camp_type=1,name="泥沙小黄兽",level=52,face=110001,figure=110001,desc="",order=9,require=6,reward_exploit=195,reward_prestige=1560,reward_exp=9370,reward_copper=2900,reward_item=43030050,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=110001,pos_2=0,pos_3=0,pos_4=110001,pos_5=130012,pos_6=140011,pos_7=110001,pos_8=0,pos_9=0,complete_percent=30},[10510]={cfg_army_id=10510,cfg_camp_id=105,camp_type=1,name="幼青沙兽",level=53,face=110001,figure=110001,desc="",order=10,require=9,reward_exploit=198,reward_prestige=1580,reward_exp=9530,reward_copper=2960,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=110001,pos_2=0,pos_3=110001,pos_4=110001,pos_5=0,pos_6=0,pos_7=110001,pos_8=0,pos_9=140011,complete_percent=33},[10511]={cfg_army_id=10511,cfg_camp_id=105,camp_type=1,name="魔眼紫蛇",level=53,face=180002,figure=180002,desc="",order=11,require=9,reward_exploit=199,reward_prestige=1600,reward_exp=9610,reward_copper=2990,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130045,pos_3=0,pos_4=120011,pos_5=130045,pos_6=180002,pos_7=120011,pos_8=0,pos_9=0,complete_percent=37},[10512]={cfg_army_id=10512,cfg_camp_id=105,camp_type=1,name="美狄亚",level=53,face=180002,figure=180002,desc="",order=12,require=9,reward_exploit=201,reward_prestige=1620,reward_exp=9700,reward_copper=3030,reward_item=43030050,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=0,pos_4=130045,pos_5=130045,pos_6=110001,pos_7=130045,pos_8=0,pos_9=0,complete_percent=40},[10513]={cfg_army_id=10513,cfg_camp_id=105,camp_type=1,name="异化雷灵",level=54,face=240001,figure=240001,desc="",order=13,require=12,reward_exploit=204,reward_prestige=1640,reward_exp=9860,reward_copper=3090,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=0,pos_3=0,pos_4=130045,pos_5=140045,pos_6=240001,pos_7=130045,pos_8=0,pos_9=0,complete_percent=43},[10514]={cfg_army_id=10514,cfg_camp_id=105,camp_type=1,name="兀鹰",level=54,face=250004,figure=250004,desc="",order=14,require=12,reward_exploit=205,reward_prestige=1660,reward_exp=9940,reward_copper=3120,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=250002,pos_2=250001,pos_3=0,pos_4=250002,pos_5=250004,pos_6=250003,pos_7=0,pos_8=0,pos_9=0,complete_percent=47},[10515]={cfg_army_id=10515,cfg_camp_id=105,camp_type=1,name="卡俄斯",level=54,face=250002,figure=250002,desc="",order=15,require=12,reward_exploit=207,reward_prestige=1680,reward_exp=10030,reward_copper=3160,reward_item=43030050,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=250003,pos_4=250004,pos_5=250002,pos_6=250003,pos_7=0,pos_8=0,pos_9=250003,complete_percent=50},[10516]={cfg_army_id=10516,cfg_camp_id=105,camp_type=1,name="淡银熊精",level=55,face=230001,figure=230001,desc="",order=16,require=15,reward_exploit=210,reward_prestige=1700,reward_exp=10190,reward_copper=3220,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=160013,pos_2=160013,pos_3=0,pos_4=230001,pos_5=160013,pos_6=0,pos_7=160013,pos_8=0,pos_9=0,complete_percent=53},[10517]={cfg_army_id=10517,cfg_camp_id=105,camp_type=1,name="淡灰熊精",level=55,face=230001,figure=230001,desc="",order=17,require=15,reward_exploit=211,reward_prestige=1720,reward_exp=10270,reward_copper=3250,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=160013,pos_3=160013,pos_4=230001,pos_5=160013,pos_6=160013,pos_7=0,pos_8=0,pos_9=0,complete_percent=57},[10518]={cfg_army_id=10518,cfg_camp_id=105,camp_type=1,name="贪吃绿熊",level=55,face=230001,figure=230001,desc="",order=18,require=15,reward_exploit=213,reward_prestige=1740,reward_exp=10360,reward_copper=3290,reward_item=43030050,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=160013,pos_2=0,pos_3=0,pos_4=160013,pos_5=160013,pos_6=230001,pos_7=160013,pos_8=0,pos_9=0,complete_percent=60},[10519]={cfg_army_id=10519,cfg_camp_id=105,camp_type=1,name="深蓝花猫",level=56,face=220012,figure=220012,desc="",order=19,require=18,reward_exploit=216,reward_prestige=1760,reward_exp=10520,reward_copper=3350,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=220001,pos_3=0,pos_4=220012,pos_5=220001,pos_6=230001,pos_7=0,pos_8=0,pos_9=230001,complete_percent=63},[10520]={cfg_army_id=10520,cfg_camp_id=105,camp_type=1,name="翠绿花猫",level=56,face=220012,figure=220012,desc="",order=20,require=18,reward_exploit=217,reward_prestige=1780,reward_exp=10600,reward_copper=3380,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=230001,pos_2=0,pos_3=0,pos_4=230001,pos_5=220012,pos_6=220001,pos_7=0,pos_8=0,pos_9=220001,complete_percent=67},[10521]={cfg_army_id=10521,cfg_camp_id=105,camp_type=1,name="贪醉棕猫",level=56,face=220012,figure=220012,desc="",order=21,require=18,reward_exploit=219,reward_prestige=1800,reward_exp=10690,reward_copper=3420,reward_item=43030050,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=0,pos_3=0,pos_4=220001,pos_5=230001,pos_6=220012,pos_7=0,pos_8=230001,pos_9=0,complete_percent=70},[10522]={cfg_army_id=10522,cfg_camp_id=105,camp_type=1,name="妖火绿焰",level=57,face=120041,figure=120041,desc="",order=22,require=21,reward_exploit=222,reward_prestige=1820,reward_exp=10850,reward_copper=3480,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=120011,pos_3=130012,pos_4=120041,pos_5=120011,pos_6=110001,pos_7=0,pos_8=0,pos_9=0,complete_percent=73},[10523]={cfg_army_id=10523,cfg_camp_id=105,camp_type=1,name="妖火蓝焰",level=57,face=120041,figure=120041,desc="",order=23,require=21,reward_exploit=223,reward_prestige=1840,reward_exp=10930,reward_copper=3510,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=120041,pos_3=130045,pos_4=120041,pos_5=120041,pos_6=110001,pos_7=0,pos_8=0,pos_9=0,complete_percent=77},[10524]={cfg_army_id=10524,cfg_camp_id=105,camp_type=1,name="赤炎斗士",level=57,face=120041,figure=120041,desc="",order=24,require=21,reward_exploit=225,reward_prestige=1860,reward_exp=11020,reward_copper=3550,reward_item=43030050,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=120041,pos_3=130045,pos_4=120041,pos_5=120041,pos_6=110001,pos_7=0,pos_8=0,pos_9=0,complete_percent=80},[10525]={cfg_army_id=10525,cfg_camp_id=105,camp_type=1,name="紫炎火兽",level=58,face=120041,figure=120041,desc="",order=25,require=24,reward_exploit=228,reward_prestige=1880,reward_exp=11180,reward_copper=3610,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120011,pos_2=130045,pos_3=0,pos_4=120011,pos_5=130045,pos_6=120041,pos_7=0,pos_8=0,pos_9=0,complete_percent=83},[10526]={cfg_army_id=10526,cfg_camp_id=105,camp_type=1,name="黄炎火兽",level=58,face=120041,figure=120041,desc="",order=26,require=24,reward_exploit=229,reward_prestige=1900,reward_exp=11260,reward_copper=3640,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120041,pos_2=0,pos_3=0,pos_4=130045,pos_5=0,pos_6=130045,pos_7=130045,pos_8=0,pos_9=130045,complete_percent=87},[10527]={cfg_army_id=10527,cfg_camp_id=105,camp_type=1,name="阿波罗",level=58,face=270001,figure=270001,desc="",order=27,require=24,reward_exploit=231,reward_prestige=1920,reward_exp=11350,reward_copper=3680,reward_item=43030050,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170014,pos_2=170001,pos_3=0,pos_4=270001,pos_5=170001,pos_6=0,pos_7=170014,pos_8=0,pos_9=0,complete_percent=90},[10528]={cfg_army_id=10528,cfg_camp_id=105,camp_type=1,name="灿金水兽",level=59,face=140011,figure=140011,desc="",order=28,require=27,reward_exploit=234,reward_prestige=1940,reward_exp=11510,reward_copper=3740,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130012,pos_2=0,pos_3=0,pos_4=130012,pos_5=140011,pos_6=110001,pos_7=0,pos_8=0,pos_9=110001,complete_percent=93},[10529]={cfg_army_id=10529,cfg_camp_id=105,camp_type=1,name="绿水兽",level=59,face=140011,figure=140011,desc="",order=29,require=27,reward_exploit=235,reward_prestige=1960,reward_exp=11590,reward_copper=3770,reward_item=11100050,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=140011,pos_5=130012,pos_6=110001,pos_7=0,pos_8=130012,pos_9=110001,complete_percent=97},[10530]={cfg_army_id=10530,cfg_camp_id=105,camp_type=1,name="寒冰兽",level=59,face=280003,figure=280003,desc="",order=30,require=27,reward_exploit=237,reward_prestige=1980,reward_exp=11680,reward_copper=3810,reward_item=43030050,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=240001,pos_2=0,pos_3=0,pos_4=240001,pos_5=280003,pos_6=310001,pos_7=0,pos_8=0,pos_9=310001,complete_percent=100},[10601]={cfg_army_id=10601,cfg_camp_id=106,camp_type=1,name="魔化冰晶",level=60,face=280001,figure=280001,desc="",order=1,require=0,reward_exploit=241,reward_prestige=2040,reward_exp=11910,reward_copper=3920,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=240001,pos_2=0,pos_3=0,pos_4=240001,pos_5=280001,pos_6=140045,pos_7=0,pos_8=0,pos_9=140045,complete_percent=3},[10602]={cfg_army_id=10602,cfg_camp_id=106,camp_type=1,name="壳贝翠蛙",level=60,face=150001,figure=150001,desc="",order=2,require=0,reward_exploit=243,reward_prestige=2070,reward_exp=12000,reward_copper=3960,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=150001,pos_5=130012,pos_6=110001,pos_7=0,pos_8=130012,pos_9=110001,complete_percent=7},[10603]={cfg_army_id=10603,cfg_camp_id=106,camp_type=1,name="壳贝黄蛙",level=60,face=150001,figure=150001,desc="",order=3,require=0,reward_exploit=245,reward_prestige=2100,reward_exp=12100,reward_copper=4020,reward_item=43030060,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=150001,pos_5=130012,pos_6=110001,pos_7=0,pos_8=130012,pos_9=110001,complete_percent=10},[10604]={cfg_army_id=10604,cfg_camp_id=106,camp_type=1,name="失魂妖菇",level=61,face=250001,figure=250001,desc="",order=4,require=3,reward_exploit=248,reward_prestige=2140,reward_exp=12310,reward_copper=4100,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=250002,pos_2=0,pos_3=0,pos_4=250002,pos_5=250001,pos_6=250003,pos_7=0,pos_8=0,pos_9=250003,complete_percent=13},[10605]={cfg_army_id=10605,cfg_camp_id=106,camp_type=1,name="金泥魔兽",level=61,face=110001,figure=110001,desc="",order=5,require=3,reward_exploit=250,reward_prestige=2170,reward_exp=12400,reward_copper=4140,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=110001,pos_2=0,pos_3=140011,pos_4=110001,pos_5=0,pos_6=140011,pos_7=110001,pos_8=0,pos_9=0,complete_percent=17},[10606]={cfg_army_id=10606,cfg_camp_id=106,camp_type=1,name="红眼魔鼠",level=61,face=250003,figure=250003,desc="",order=6,require=3,reward_exploit=252,reward_prestige=2200,reward_exp=12500,reward_copper=4200,reward_item=43030060,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=250002,pos_2=0,pos_3=0,pos_4=250002,pos_5=250003,pos_6=250004,pos_7=0,pos_8=0,pos_9=250004,complete_percent=20},[10607]={cfg_army_id=10607,cfg_camp_id=106,camp_type=1,name="蓝泥魔兽",level=62,face=110001,figure=110001,desc="",order=7,require=6,reward_exploit=255,reward_prestige=2240,reward_exp=12710,reward_copper=4280,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=110001,pos_2=0,pos_3=140045,pos_4=110001,pos_5=0,pos_6=140045,pos_7=110001,pos_8=0,pos_9=0,complete_percent=23},[10608]={cfg_army_id=10608,cfg_camp_id=106,camp_type=1,name="青泥魔兽",level=62,face=110001,figure=110001,desc="",order=8,require=6,reward_exploit=257,reward_prestige=2270,reward_exp=12800,reward_copper=4320,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=110001,pos_2=0,pos_3=140011,pos_4=110001,pos_5=0,pos_6=140011,pos_7=110001,pos_8=0,pos_9=0,complete_percent=27},[10609]={cfg_army_id=10609,cfg_camp_id=106,camp_type=1,name="魔灵贪婪",level=62,face=170011,figure=170011,desc="",order=9,require=6,reward_exploit=259,reward_prestige=2300,reward_exp=12900,reward_copper=4380,reward_item=43030060,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170012,pos_2=0,pos_3=0,pos_4=170012,pos_5=170011,pos_6=170013,pos_7=0,pos_8=0,pos_9=170013,complete_percent=30},[10610]={cfg_army_id=10610,cfg_camp_id=106,camp_type=1,name="懵懂绿豆",level=63,face=170013,figure=170013,desc="",order=10,require=9,reward_exploit=262,reward_prestige=2340,reward_exp=13110,reward_copper=4460,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170012,pos_2=170011,pos_3=0,pos_4=170012,pos_5=170011,pos_6=170013,pos_7=0,pos_8=0,pos_9=0,complete_percent=33},[10611]={cfg_army_id=10611,cfg_camp_id=106,camp_type=1,name="狂暴斗龙",level=63,face=170014,figure=170014,desc="",order=11,require=9,reward_exploit=264,reward_prestige=2370,reward_exp=13200,reward_copper=4500,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170012,pos_2=170011,pos_3=170012,pos_4=170014,pos_5=170011,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=37},[10612]={cfg_army_id=10612,cfg_camp_id=106,camp_type=1,name="魔灵嫉妒",level=63,face=170012,figure=170012,desc="",order=12,require=9,reward_exploit=266,reward_prestige=2400,reward_exp=13300,reward_copper=4560,reward_item=43030060,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170014,pos_2=0,pos_3=0,pos_4=170014,pos_5=170012,pos_6=170013,pos_7=0,pos_8=0,pos_9=170013,complete_percent=40},[10613]={cfg_army_id=10613,cfg_camp_id=106,camp_type=1,name="熔岩金守卫",level=64,face=120041,figure=120041,desc="",order=13,require=12,reward_exploit=269,reward_prestige=2440,reward_exp=13510,reward_copper=4640,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120041,pos_2=0,pos_3=0,pos_4=130045,pos_5=0,pos_6=130045,pos_7=130045,pos_8=0,pos_9=130045,complete_percent=43},[10614]={cfg_army_id=10614,cfg_camp_id=106,camp_type=1,name="熔岩绿守卫",level=64,face=120041,figure=120041,desc="",order=14,require=12,reward_exploit=271,reward_prestige=2470,reward_exp=13600,reward_copper=4680,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120041,pos_2=0,pos_3=0,pos_4=120011,pos_5=0,pos_6=130012,pos_7=120011,pos_8=0,pos_9=130012,complete_percent=47},[10615]={cfg_army_id=10615,cfg_camp_id=106,camp_type=1,name="魔灵暴怒",level=64,face=120041,figure=120041,desc="",order=15,require=12,reward_exploit=273,reward_prestige=2500,reward_exp=13700,reward_copper=4740,reward_item=43030060,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120041,pos_2=0,pos_3=0,pos_4=120041,pos_5=0,pos_6=130045,pos_7=120041,pos_8=0,pos_9=130045,complete_percent=50},[10616]={cfg_army_id=10616,cfg_camp_id=106,camp_type=1,name="红袍领主",level=65,face=130045,figure=130045,desc="",order=16,require=15,reward_exploit=276,reward_prestige=2540,reward_exp=13910,reward_copper=4820,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=0,pos_3=0,pos_4=130045,pos_5=130045,pos_6=140045,pos_7=0,pos_8=0,pos_9=140045,complete_percent=53},[10617]={cfg_army_id=10617,cfg_camp_id=106,camp_type=1,name="绿袍领主",level=65,face=130045,figure=130045,desc="",order=17,require=15,reward_exploit=278,reward_prestige=2570,reward_exp=14000,reward_copper=4860,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=0,pos_3=0,pos_4=130045,pos_5=130045,pos_6=140045,pos_7=0,pos_8=0,pos_9=140045,complete_percent=57},[10618]={cfg_army_id=10618,cfg_camp_id=106,camp_type=1,name="魔灵痛苦",level=65,face=210001,figure=210001,desc="",order=18,require=15,reward_exploit=280,reward_prestige=2600,reward_exp=14100,reward_copper=4920,reward_item=43030060,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=210001,pos_2=0,pos_3=130045,pos_4=130045,pos_5=130045,pos_6=130045,pos_7=0,pos_8=0,pos_9=0,complete_percent=60},[10619]={cfg_army_id=10619,cfg_camp_id=106,camp_type=1,name="铁甲金领主",level=66,face=140045,figure=140045,desc="",order=19,require=18,reward_exploit=283,reward_prestige=2640,reward_exp=14310,reward_copper=5000,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140045,pos_2=0,pos_3=0,pos_4=140045,pos_5=0,pos_6=130045,pos_7=140045,pos_8=0,pos_9=130045,complete_percent=63},[10620]={cfg_army_id=10620,cfg_camp_id=106,camp_type=1,name="铁甲红领主",level=66,face=140045,figure=140045,desc="",order=20,require=18,reward_exploit=285,reward_prestige=2670,reward_exp=14400,reward_copper=5040,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140045,pos_2=0,pos_3=0,pos_4=140045,pos_5=0,pos_6=130045,pos_7=140045,pos_8=0,pos_9=130045,complete_percent=67},[10621]={cfg_army_id=10621,cfg_camp_id=106,camp_type=1,name="潘多拉",level=66,face=140045,figure=140045,desc="",order=21,require=18,reward_exploit=287,reward_prestige=2700,reward_exp=14500,reward_copper=5100,reward_item=43030060,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140045,pos_2=0,pos_3=130045,pos_4=140045,pos_5=0,pos_6=0,pos_7=140045,pos_8=0,pos_9=130045,complete_percent=70},[10622]={cfg_army_id=10622,cfg_camp_id=106,camp_type=1,name="蓝果精灵",level=67,face=190011,figure=190011,desc="",order=22,require=21,reward_exploit=290,reward_prestige=2740,reward_exp=14710,reward_copper=5180,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=190002,pos_3=0,pos_4=190002,pos_5=190002,pos_6=190002,pos_7=0,pos_8=190011,pos_9=0,complete_percent=73},[10623]={cfg_army_id=10623,cfg_camp_id=106,camp_type=1,name="金果精灵",level=67,face=190011,figure=190011,desc="",order=23,require=21,reward_exploit=292,reward_prestige=2770,reward_exp=14800,reward_copper=5220,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190002,pos_2=190002,pos_3=0,pos_4=190002,pos_5=190002,pos_6=0,pos_7=0,pos_8=190011,pos_9=0,complete_percent=77},[10624]={cfg_army_id=10624,cfg_camp_id=106,camp_type=1,name="精灵希望",level=67,face=190011,figure=190011,desc="",order=24,require=21,reward_exploit=294,reward_prestige=2800,reward_exp=14900,reward_copper=5280,reward_item=43030060,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190002,pos_2=0,pos_3=190002,pos_4=190002,pos_5=190002,pos_6=0,pos_7=190011,pos_8=0,pos_9=0,complete_percent=80},[10625]={cfg_army_id=10625,cfg_camp_id=106,camp_type=1,name="粉影守卫",level=68,face=130045,figure=130045,desc="",order=25,require=24,reward_exploit=297,reward_prestige=2840,reward_exp=15110,reward_copper=5360,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130012,pos_3=130012,pos_4=130012,pos_5=130012,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=83},[10626]={cfg_army_id=10626,cfg_camp_id=106,camp_type=1,name="红影守卫",level=68,face=130045,figure=130045,desc="",order=26,require=24,reward_exploit=299,reward_prestige=2870,reward_exp=15200,reward_copper=5400,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130012,pos_2=130012,pos_3=0,pos_4=0,pos_5=130012,pos_6=130012,pos_7=0,pos_8=0,pos_9=130045,complete_percent=87},[10627]={cfg_army_id=10627,cfg_camp_id=106,camp_type=1,name="绿影风卫",level=68,face=130045,figure=130045,desc="",order=27,require=24,reward_exploit=301,reward_prestige=2900,reward_exp=15300,reward_copper=5460,reward_item=43030060,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130012,pos_3=130012,pos_4=130012,pos_5=130012,pos_6=130045,pos_7=0,pos_8=0,pos_9=0,complete_percent=90},[10628]={cfg_army_id=10628,cfg_camp_id=106,camp_type=1,name="红蛇魔卫",level=69,face=180002,figure=180002,desc="",order=28,require=27,reward_exploit=304,reward_prestige=2940,reward_exp=15510,reward_copper=5540,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=150001,pos_3=150001,pos_4=180002,pos_5=0,pos_6=150001,pos_7=150001,pos_8=0,pos_9=0,complete_percent=93},[10629]={cfg_army_id=10629,cfg_camp_id=106,camp_type=1,name="蓝蛇魔卫",level=69,face=180002,figure=180002,desc="",order=29,require=27,reward_exploit=306,reward_prestige=2970,reward_exp=15600,reward_copper=5580,reward_item=11100060,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=0,pos_4=0,pos_5=150001,pos_6=0,pos_7=150001,pos_8=150001,pos_9=150001,complete_percent=97},[10630]={cfg_army_id=10630,cfg_camp_id=106,camp_type=1,name="蛇心恶商",level=69,face=180002,figure=180002,desc="",order=30,require=27,reward_exploit=308,reward_prestige=3000,reward_exp=15700,reward_copper=5640,reward_item=43030060,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=150001,pos_2=150001,pos_3=0,pos_4=180002,pos_5=150001,pos_6=0,pos_7=150001,pos_8=0,pos_9=0,complete_percent=100},[10701]={cfg_army_id=10701,cfg_camp_id=107,camp_type=1,name="金甲龙",level=70,face=170021,figure=170021,desc="",order=1,require=0,reward_exploit=313,reward_prestige=3120,reward_exp=15990,reward_copper=5790,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170021,pos_2=0,pos_3=170012,pos_4=0,pos_5=170012,pos_6=0,pos_7=170011,pos_8=0,pos_9=170011,complete_percent=5},[10702]={cfg_army_id=10702,cfg_camp_id=107,camp_type=1,name="蓝甲龙",level=70,face=170021,figure=170021,desc="",order=2,require=0,reward_exploit=315,reward_prestige=3150,reward_exp=16080,reward_copper=5830,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=170011,pos_3=0,pos_4=170012,pos_5=170021,pos_6=170012,pos_7=0,pos_8=170011,pos_9=0,complete_percent=10},[10703]={cfg_army_id=10703,cfg_camp_id=107,camp_type=1,name="绿甲龙",level=70,face=170025,figure=170025,desc="",order=3,require=0,reward_exploit=317,reward_prestige=3190,reward_exp=16180,reward_copper=5880,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170013,pos_2=170025,pos_3=170013,pos_4=170012,pos_5=0,pos_6=170011,pos_7=0,pos_8=0,pos_9=0,complete_percent=15},[10704]={cfg_army_id=10704,cfg_camp_id=107,camp_type=1,name="紫甲龙",level=70,face=170025,figure=170025,desc="",order=4,require=0,reward_exploit=319,reward_prestige=3240,reward_exp=16300,reward_copper=5940,reward_item=43030070,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=0,pos_5=170011,pos_6=170012,pos_7=170025,pos_8=170014,pos_9=170014,complete_percent=20},[10705]={cfg_army_id=10705,cfg_camp_id=107,camp_type=1,name="金狐",level=71,face=220001,figure=220001,desc="",order=5,require=4,reward_exploit=322,reward_prestige=3300,reward_exp=16470,reward_copper=6040,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=220012,pos_3=0,pos_4=0,pos_5=0,pos_6=220012,pos_7=220012,pos_8=220001,pos_9=220012,complete_percent=25},[10706]={cfg_army_id=10706,cfg_camp_id=107,camp_type=1,name="青狐",level=71,face=220001,figure=220001,desc="",order=6,require=4,reward_exploit=324,reward_prestige=3330,reward_exp=16560,reward_copper=6080,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220012,pos_2=0,pos_3=0,pos_4=220012,pos_5=220001,pos_6=220012,pos_7=220012,pos_8=0,pos_9=0,complete_percent=30},[10707]={cfg_army_id=10707,cfg_camp_id=107,camp_type=1,name="灰狐",level=71,face=220001,figure=220001,desc="",order=7,require=4,reward_exploit=326,reward_prestige=3370,reward_exp=16660,reward_copper=6130,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220012,pos_2=0,pos_3=0,pos_4=220012,pos_5=220012,pos_6=0,pos_7=220001,pos_8=220012,pos_9=0,complete_percent=35},[10708]={cfg_army_id=10708,cfg_camp_id=107,camp_type=1,name="火狐",level=71,face=220001,figure=220001,desc="",order=8,require=4,reward_exploit=328,reward_prestige=3420,reward_exp=16780,reward_copper=6190,reward_item=43030070,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=220012,pos_3=220001,pos_4=0,pos_5=220012,pos_6=220012,pos_7=0,pos_8=0,pos_9=220012,complete_percent=40},[10709]={cfg_army_id=10709,cfg_camp_id=107,camp_type=1,name="金毛魔狮",level=72,face=270001,figure=270001,desc="",order=9,require=8,reward_exploit=331,reward_prestige=3480,reward_exp=16950,reward_copper=6290,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220012,pos_2=0,pos_3=0,pos_4=210005,pos_5=170011,pos_6=0,pos_7=270001,pos_8=210005,pos_9=0,complete_percent=45},[10710]={cfg_army_id=10710,cfg_camp_id=107,camp_type=1,name="炉焰绿卫长",level=72,face=120041,figure=120041,desc="",order=10,require=8,reward_exploit=333,reward_prestige=3510,reward_exp=17040,reward_copper=6330,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=120041,pos_3=120011,pos_4=120011,pos_5=120011,pos_6=120011,pos_7=0,pos_8=0,pos_9=0,complete_percent=50},[10711]={cfg_army_id=10711,cfg_camp_id=107,camp_type=1,name="炉焰蓝卫长",level=72,face=120041,figure=120041,desc="",order=11,require=8,reward_exploit=335,reward_prestige=3550,reward_exp=17140,reward_copper=6380,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120041,pos_2=120011,pos_3=0,pos_4=120011,pos_5=120011,pos_6=0,pos_7=120011,pos_8=0,pos_9=0,complete_percent=55},[10712]={cfg_army_id=10712,cfg_camp_id=107,camp_type=1,name="赤火魔",level=72,face=120041,figure=120041,desc="",order=12,require=8,reward_exploit=337,reward_prestige=3600,reward_exp=17260,reward_copper=6440,reward_item=43030070,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120041,pos_2=120011,pos_3=0,pos_4=0,pos_5=0,pos_6=120011,pos_7=120011,pos_8=0,pos_9=120011,complete_percent=60},[10713]={cfg_army_id=10713,cfg_camp_id=107,camp_type=1,name="小冰魄",level=73,face=280003,figure=280003,desc="",order=13,require=12,reward_exploit=340,reward_prestige=3660,reward_exp=17430,reward_copper=6540,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=280003,pos_2=0,pos_3=250002,pos_4=240001,pos_5=0,pos_6=250002,pos_7=240001,pos_8=0,pos_9=0,complete_percent=65},[10714]={cfg_army_id=10714,cfg_camp_id=107,camp_type=1,name="水灵金兽",level=73,face=140045,figure=140045,desc="",order=14,require=12,reward_exploit=342,reward_prestige=3690,reward_exp=17520,reward_copper=6580,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=140045,pos_3=0,pos_4=0,pos_5=140011,pos_6=0,pos_7=140011,pos_8=140011,pos_9=140011,complete_percent=70},[10715]={cfg_army_id=10715,cfg_camp_id=107,camp_type=1,name="水灵红兽",level=73,face=140045,figure=140045,desc="",order=15,require=12,reward_exploit=344,reward_prestige=3730,reward_exp=17620,reward_copper=6630,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140045,pos_2=0,pos_3=140011,pos_4=140011,pos_5=140011,pos_6=0,pos_7=140011,pos_8=0,pos_9=0,complete_percent=75},[10716]={cfg_army_id=10716,cfg_camp_id=107,camp_type=1,name="冰晶魂兽",level=73,face=280001,figure=280001,desc="",order=16,require=12,reward_exploit=346,reward_prestige=3780,reward_exp=17740,reward_copper=6690,reward_item=43030070,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=280001,pos_4=0,pos_5=280003,pos_6=280003,pos_7=280003,pos_8=0,pos_9=280003,complete_percent=80},[10717]={cfg_army_id=10717,cfg_camp_id=107,camp_type=1,name="风灵领主",level=74,face=200001,figure=200001,desc="",order=17,require=16,reward_exploit=349,reward_prestige=3840,reward_exp=17910,reward_copper=6790,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=200001,pos_2=0,pos_3=130045,pos_4=190011,pos_5=130045,pos_6=0,pos_7=170012,pos_8=0,pos_9=0,complete_percent=85},[10718]={cfg_army_id=10718,cfg_camp_id=107,camp_type=1,name="水灵领主",level=74,face=200003,figure=200003,desc="",order=18,require=16,reward_exploit=351,reward_prestige=3870,reward_exp=18000,reward_copper=6830,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=0,pos_5=200003,pos_6=190011,pos_7=170012,pos_8=140045,pos_9=140045,complete_percent=90},[10719]={cfg_army_id=10719,cfg_camp_id=107,camp_type=1,name="绿龙宝仔",level=74,face=170004,figure=170004,desc="",order=19,require=16,reward_exploit=353,reward_prestige=3910,reward_exp=18100,reward_copper=6880,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170004,pos_2=170003,pos_3=170003,pos_4=170002,pos_5=170002,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=95},[10720]={cfg_army_id=10720,cfg_camp_id=107,camp_type=1,name="墨丘利",level=74,face=170001,figure=170001,desc="",order=20,require=16,reward_exploit=355,reward_prestige=3960,reward_exp=18220,reward_copper=6940,reward_item=43030070,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170001,pos_2=0,pos_3=0,pos_4=170003,pos_5=0,pos_6=0,pos_7=170003,pos_8=170002,pos_9=170002,complete_percent=100},[10801]={cfg_army_id=10801,cfg_camp_id=108,camp_type=1,name="魔化蓝狮",level=75,face=160013,figure=160013,desc="",order=1,require=0,reward_exploit=358,reward_prestige=4020,reward_exp=18390,reward_copper=7040,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=160013,pos_3=0,pos_4=0,pos_5=220001,pos_6=220012,pos_7=0,pos_8=220001,pos_9=220012,complete_percent=5},[10802]={cfg_army_id=10802,cfg_camp_id=108,camp_type=1,name="魔化灿狮",level=75,face=160013,figure=160013,desc="",order=2,require=0,reward_exploit=360,reward_prestige=4050,reward_exp=18480,reward_copper=7080,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=160013,pos_3=0,pos_4=220012,pos_5=220001,pos_6=0,pos_7=220012,pos_8=220001,pos_9=0,complete_percent=10},[10803]={cfg_army_id=10803,cfg_camp_id=108,camp_type=1,name="魔化绿狮",level=75,face=160013,figure=160013,desc="",order=3,require=0,reward_exploit=362,reward_prestige=4090,reward_exp=18580,reward_copper=7130,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=160013,pos_2=110001,pos_3=110001,pos_4=0,pos_5=290001,pos_6=290001,pos_7=0,pos_8=0,pos_9=0,complete_percent=15},[10804]={cfg_army_id=10804,cfg_camp_id=108,camp_type=1,name="金狮",level=75,face=160013,figure=160013,desc="",order=4,require=0,reward_exploit=364,reward_prestige=4140,reward_exp=18700,reward_copper=7190,reward_item=43030070,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=160013,pos_2=110001,pos_3=110001,pos_4=0,pos_5=0,pos_6=0,pos_7=290001,pos_8=290001,pos_9=0,complete_percent=20},[10805]={cfg_army_id=10805,cfg_camp_id=108,camp_type=1,name="幼翼蓝龙",level=76,face=170003,figure=170003,desc="",order=5,require=4,reward_exploit=367,reward_prestige=4200,reward_exp=18870,reward_copper=7290,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170003,pos_2=170011,pos_3=170011,pos_4=0,pos_5=150001,pos_6=0,pos_7=0,pos_8=150001,pos_9=0,complete_percent=25},[10806]={cfg_army_id=10806,cfg_camp_id=108,camp_type=1,name="雅典娜石卫",level=76,face=260001,figure=260001,desc="",order=6,require=4,reward_exploit=369,reward_prestige=4230,reward_exp=18960,reward_copper=7330,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=260001,pos_3=0,pos_4=270001,pos_5=0,pos_6=280001,pos_7=270001,pos_8=0,pos_9=280001,complete_percent=30},[10807]={cfg_army_id=10807,cfg_camp_id=108,camp_type=1,name="雅典娜树卫",level=76,face=260002,figure=260002,desc="",order=7,require=4,reward_exploit=371,reward_prestige=4270,reward_exp=19060,reward_copper=7380,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=260002,pos_2=0,pos_3=270001,pos_4=270001,pos_5=0,pos_6=240001,pos_7=0,pos_8=240001,pos_9=0,complete_percent=35},[10808]={cfg_army_id=10808,cfg_camp_id=108,camp_type=1,name="雅典娜",level=76,face=280002,figure=280002,desc="",order=8,require=4,reward_exploit=373,reward_prestige=4320,reward_exp=19180,reward_copper=7440,reward_item=43030070,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=260001,pos_3=0,pos_4=280001,pos_5=280002,pos_6=280001,pos_7=0,pos_8=260002,pos_9=0,complete_percent=40},[10809]={cfg_army_id=10809,cfg_camp_id=108,camp_type=1,name="长臂石人",level=77,face=260001,figure=260001,desc="",order=9,require=8,reward_exploit=376,reward_prestige=4380,reward_exp=19350,reward_copper=7540,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=260001,pos_3=0,pos_4=0,pos_5=270001,pos_6=0,pos_7=130045,pos_8=270001,pos_9=130045,complete_percent=45},[10810]={cfg_army_id=10810,cfg_camp_id=108,camp_type=1,name="暗影甲龙",level=77,face=210003,figure=210003,desc="",order=10,require=8,reward_exploit=378,reward_prestige=4410,reward_exp=19440,reward_copper=7580,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=310001,pos_4=180002,pos_5=310001,pos_6=0,pos_7=210003,pos_8=0,pos_9=0,complete_percent=50},[10811]={cfg_army_id=10811,cfg_camp_id=108,camp_type=1,name="暗影沙王",level=77,face=210002,figure=210002,desc="",order=11,require=8,reward_exploit=380,reward_prestige=4450,reward_exp=19540,reward_copper=7630,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=210002,pos_2=110043,pos_3=110043,pos_4=230001,pos_5=230001,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=55},[10812]={cfg_army_id=10812,cfg_camp_id=108,camp_type=1,name="鬼卫",level=77,face=210001,figure=210001,desc="",order=12,require=8,reward_exploit=382,reward_prestige=4500,reward_exp=19660,reward_copper=7690,reward_item=43030070,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=220001,pos_3=0,pos_4=0,pos_5=300001,pos_6=300001,pos_7=0,pos_8=0,pos_9=210001,complete_percent=60},[10813]={cfg_army_id=10813,cfg_camp_id=108,camp_type=1,name="绿意风精",level=78,face=130045,figure=130045,desc="",order=13,require=12,reward_exploit=385,reward_prestige=4560,reward_exp=19830,reward_copper=7790,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=150001,pos_3=150001,pos_4=180002,pos_5=180002,pos_6=130045,pos_7=0,pos_8=0,pos_9=0,complete_percent=65},[10814]={cfg_army_id=10814,cfg_camp_id=108,camp_type=1,name="赤意风精",level=78,face=130045,figure=130045,desc="",order=14,require=12,reward_exploit=387,reward_prestige=4590,reward_exp=19920,reward_copper=7830,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=150001,pos_3=150001,pos_4=130045,pos_5=0,pos_6=180002,pos_7=180002,pos_8=0,pos_9=0,complete_percent=70},[10815]={cfg_army_id=10815,cfg_camp_id=108,camp_type=1,name="金意风精",level=78,face=130045,figure=130045,desc="",order=15,require=12,reward_exploit=389,reward_prestige=4630,reward_exp=20020,reward_copper=7880,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=0,pos_3=0,pos_4=0,pos_5=130045,pos_6=0,pos_7=130045,pos_8=230001,pos_9=230001,complete_percent=75},[10816]={cfg_army_id=10816,cfg_camp_id=108,camp_type=1,name="米诺斯",level=78,face=130045,figure=130045,desc="",order=16,require=12,reward_exploit=391,reward_prestige=4680,reward_exp=20140,reward_copper=7940,reward_item=43030070,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=0,pos_4=130045,pos_5=230001,pos_6=0,pos_7=230001,pos_8=0,pos_9=0,complete_percent=80},[10817]={cfg_army_id=10817,cfg_camp_id=108,camp_type=1,name="紫灵狱守",level=79,face=130045,figure=130045,desc="",order=17,require=16,reward_exploit=394,reward_prestige=4740,reward_exp=20310,reward_copper=8040,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=0,pos_3=170021,pos_4=0,pos_5=170021,pos_6=0,pos_7=130012,pos_8=0,pos_9=130012,complete_percent=85},[10818]={cfg_army_id=10818,cfg_camp_id=108,camp_type=1,name="绿灵狱守",level=79,face=130012,figure=130012,desc="",order=18,require=16,reward_exploit=396,reward_prestige=4770,reward_exp=20400,reward_copper=8080,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130012,pos_3=0,pos_4=170021,pos_5=130012,pos_6=170021,pos_7=0,pos_8=130012,pos_9=0,complete_percent=90},[10819]={cfg_army_id=10819,cfg_camp_id=108,camp_type=1,name="赤灵狱守",level=79,face=130045,figure=130045,desc="",order=19,require=16,reward_exploit=398,reward_prestige=4810,reward_exp=20500,reward_copper=8130,reward_item=11100070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170021,pos_2=130045,pos_3=170021,pos_4=130012,pos_5=0,pos_6=130012,pos_7=0,pos_8=0,pos_9=0,complete_percent=95},[10820]={cfg_army_id=10820,cfg_camp_id=108,camp_type=1,name="拉达曼提斯",level=79,face=130045,figure=130045,desc="",order=20,require=16,reward_exploit=400,reward_prestige=4860,reward_exp=20620,reward_copper=8190,reward_item=43030070,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=0,pos_5=130012,pos_6=130012,pos_7=130045,pos_8=170025,pos_9=170025,complete_percent=100},[10901]={cfg_army_id=10901,cfg_camp_id=109,camp_type=1,name="审判金守卫",level=80,face=130045,figure=130045,desc="",order=1,require=0,reward_exploit=405,reward_prestige=5040,reward_exp=20910,reward_copper=8390,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130012,pos_3=0,pos_4=0,pos_5=0,pos_6=170025,pos_7=170025,pos_8=130045,pos_9=130012,complete_percent=5},[10902]={cfg_army_id=10902,cfg_camp_id=109,camp_type=1,name="审判紫守卫",level=80,face=130045,figure=130045,desc="",order=2,require=0,reward_exploit=407,reward_prestige=5090,reward_exp=21020,reward_copper=8440,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=0,pos_3=0,pos_4=190011,pos_5=130045,pos_6=130045,pos_7=190011,pos_8=0,pos_9=0,complete_percent=10},[10903]={cfg_army_id=10903,cfg_camp_id=109,camp_type=1,name="审判蓝守卫",level=80,face=130045,figure=130045,desc="",order=3,require=0,reward_exploit=409,reward_prestige=5150,reward_exp=21140,reward_copper=8500,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190011,pos_2=0,pos_3=0,pos_4=190011,pos_5=130045,pos_6=0,pos_7=130045,pos_8=130045,pos_9=0,complete_percent=15},[10904]={cfg_army_id=10904,cfg_camp_id=109,camp_type=1,name="艾亚哥斯",level=80,face=130045,figure=130045,desc="",order=4,require=0,reward_exploit=411,reward_prestige=5220,reward_exp=21280,reward_copper=8580,reward_item=43030080,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=190011,pos_3=130045,pos_4=0,pos_5=130045,pos_6=190011,pos_7=0,pos_8=0,pos_9=130045,complete_percent=20},[10905]={cfg_army_id=10905,cfg_camp_id=109,camp_type=1,name="雷之子",level=81,face=240001,figure=240001,desc="",order=5,require=4,reward_exploit=416,reward_prestige=5340,reward_exp=21510,reward_copper=8740,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=0,pos_4=190011,pos_5=180002,pos_6=0,pos_7=240001,pos_8=190011,pos_9=0,complete_percent=25},[10906]={cfg_army_id=10906,cfg_camp_id=109,camp_type=1,name="笨拙石人",level=81,face=260001,figure=260001,desc="",order=6,require=4,reward_exploit=418,reward_prestige=5390,reward_exp=21620,reward_copper=8790,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=260001,pos_3=210005,pos_4=210005,pos_5=160013,pos_6=160013,pos_7=0,pos_8=0,pos_9=0,complete_percent=30},[10907]={cfg_army_id=10907,cfg_camp_id=109,camp_type=1,name="擎树巨人",level=81,face=260002,figure=260002,desc="",order=7,require=4,reward_exploit=420,reward_prestige=5450,reward_exp=21740,reward_copper=8850,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=260002,pos_2=160013,pos_3=0,pos_4=160013,pos_5=160013,pos_6=0,pos_7=160013,pos_8=0,pos_9=0,complete_percent=35},[10908]={cfg_army_id=10908,cfg_camp_id=109,camp_type=1,name="草树龟",level=81,face=310001,figure=310001,desc="",order=8,require=4,reward_exploit=422,reward_prestige=5520,reward_exp=21880,reward_copper=8930,reward_item=43030080,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=310001,pos_2=160013,pos_3=0,pos_4=0,pos_5=0,pos_6=160013,pos_7=210005,pos_8=0,pos_9=210005,complete_percent=40},[10909]={cfg_army_id=10909,cfg_camp_id=109,camp_type=1,name="泰坦金刚",level=82,face=260001,figure=260001,desc="",order=9,require=8,reward_exploit=427,reward_prestige=5640,reward_exp=22110,reward_copper=9090,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=260001,pos_2=0,pos_3=320002,pos_4=320002,pos_5=0,pos_6=310001,pos_7=310001,pos_8=0,pos_9=0,complete_percent=45},[10910]={cfg_army_id=10910,cfg_camp_id=109,camp_type=1,name="魔鹰",level=82,face=250004,figure=250004,desc="",order=10,require=8,reward_exploit=429,reward_prestige=5690,reward_exp=22220,reward_copper=9140,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=250004,pos_3=0,pos_4=0,pos_5=250001,pos_6=0,pos_7=250001,pos_8=150001,pos_9=150001,complete_percent=50},[10911]={cfg_army_id=10911,cfg_camp_id=109,camp_type=1,name="嗜血鼠王",level=82,face=250003,figure=250003,desc="",order=11,require=8,reward_exploit=431,reward_prestige=5750,reward_exp=22340,reward_copper=9200,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=250003,pos_2=0,pos_3=270001,pos_4=270001,pos_5=250002,pos_6=0,pos_7=250002,pos_8=0,pos_9=0,complete_percent=55},[10912]={cfg_army_id=10912,cfg_camp_id=109,camp_type=1,name="哈迪斯",level=82,face=300001,figure=300001,desc="",order=12,require=8,reward_exploit=433,reward_prestige=5820,reward_exp=22480,reward_copper=9280,reward_item=43030080,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=0,pos_3=220001,pos_4=0,pos_5=300001,pos_6=0,pos_7=220001,pos_8=0,pos_9=220001,complete_percent=60},[10913]={cfg_army_id=10913,cfg_camp_id=109,camp_type=1,name="天使守卫",level=83,face=130045,figure=130045,desc="",order=13,require=12,reward_exploit=438,reward_prestige=5940,reward_exp=22710,reward_copper=9440,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130045,pos_3=0,pos_4=130045,pos_5=0,pos_6=130045,pos_7=130012,pos_8=0,pos_9=130012,complete_percent=65},[10914]={cfg_army_id=10914,cfg_camp_id=109,camp_type=1,name="幼天使卫士",level=83,face=130045,figure=130045,desc="",order=14,require=12,reward_exploit=440,reward_prestige=5990,reward_exp=22820,reward_copper=9490,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130045,pos_3=0,pos_4=130045,pos_5=130045,pos_6=130012,pos_7=0,pos_8=130012,pos_9=0,complete_percent=70},[10915]={cfg_army_id=10915,cfg_camp_id=109,camp_type=1,name="绿袍天使长",level=83,face=130045,figure=130045,desc="",order=15,require=12,reward_exploit=442,reward_prestige=6050,reward_exp=22940,reward_copper=9550,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130045,pos_3=130045,pos_4=0,pos_5=130045,pos_6=130045,pos_7=0,pos_8=0,pos_9=130045,complete_percent=75},[10916]={cfg_army_id=10916,cfg_camp_id=109,camp_type=1,name="加百列",level=83,face=130045,figure=130045,desc="",order=16,require=12,reward_exploit=444,reward_prestige=6120,reward_exp=23080,reward_copper=9630,reward_item=43030080,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130045,pos_3=0,pos_4=130045,pos_5=0,pos_6=130045,pos_7=130045,pos_8=0,pos_9=130045,complete_percent=80},[10917]={cfg_army_id=10917,cfg_camp_id=109,camp_type=1,name="堕落绿龙",level=84,face=170025,figure=170025,desc="",order=17,require=16,reward_exploit=449,reward_prestige=6240,reward_exp=23310,reward_copper=9790,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=210005,pos_3=210005,pos_4=0,pos_5=170025,pos_6=160013,pos_7=0,pos_8=0,pos_9=160013,complete_percent=85},[10918]={cfg_army_id=10918,cfg_camp_id=109,camp_type=1,name="堕落蓝龙",level=84,face=170021,figure=170021,desc="",order=18,require=16,reward_exploit=451,reward_prestige=6290,reward_exp=23420,reward_copper=9840,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=210005,pos_3=210005,pos_4=0,pos_5=170021,pos_6=160013,pos_7=0,pos_8=0,pos_9=160013,complete_percent=90},[10919]={cfg_army_id=10919,cfg_camp_id=109,camp_type=1,name="堕落紫龙",level=84,face=170025,figure=170025,desc="",order=19,require=16,reward_exploit=453,reward_prestige=6350,reward_exp=23540,reward_copper=9900,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=170025,pos_6=0,pos_7=0,pos_8=120011,pos_9=0,complete_percent=95},[10920]={cfg_army_id=10920,cfg_camp_id=109,camp_type=1,name="路西法",level=84,face=170021,figure=170021,desc="",order=20,require=16,reward_exploit=455,reward_prestige=6420,reward_exp=23680,reward_copper=9980,reward_item=43030080,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=170021,pos_6=0,pos_7=0,pos_8=120011,pos_9=0,complete_percent=100},[11001]={cfg_army_id=11001,cfg_camp_id=110,camp_type=1,name="魔化黄沙兽",level=85,face=110001,figure=110001,desc="",order=1,require=0,reward_exploit=460,reward_prestige=6540,reward_exp=23910,reward_copper=10140,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=110001,pos_3=0,pos_4=110001,pos_5=0,pos_6=110001,pos_7=110001,pos_8=0,pos_9=110001,complete_percent=5},[11002]={cfg_army_id=11002,cfg_camp_id=110,camp_type=1,name="魔化蓝沙兽",level=85,face=110043,figure=110043,desc="",order=2,require=0,reward_exploit=462,reward_prestige=6590,reward_exp=24020,reward_copper=10190,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=110001,pos_5=0,pos_6=110001,pos_7=110001,pos_8=0,pos_9=110001,complete_percent=10},[11003]={cfg_army_id=11003,cfg_camp_id=110,camp_type=1,name="魔化紫沙兽",level=85,face=110043,figure=110043,desc="",order=3,require=0,reward_exploit=464,reward_prestige=6650,reward_exp=24140,reward_copper=10250,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=110043,pos_3=0,pos_4=0,pos_5=110001,pos_6=0,pos_7=110001,pos_8=110001,pos_9=110001,complete_percent=15},[11004]={cfg_army_id=11004,cfg_camp_id=110,camp_type=1,name="风沙青兽",level=85,face=110043,figure=110043,desc="",order=4,require=0,reward_exploit=466,reward_prestige=6720,reward_exp=24280,reward_copper=10330,reward_item=43030080,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=110043,pos_3=0,pos_4=0,pos_5=110001,pos_6=0,pos_7=110001,pos_8=110001,pos_9=110001,complete_percent=20},[11005]={cfg_army_id=11005,cfg_camp_id=110,camp_type=1,name="红斑蛇王",level=86,face=180002,figure=180002,desc="",order=5,require=4,reward_exploit=471,reward_prestige=6840,reward_exp=24510,reward_copper=10490,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=210002,pos_2=0,pos_3=210002,pos_4=0,pos_5=180002,pos_6=0,pos_7=150001,pos_8=0,pos_9=150001,complete_percent=25},[11006]={cfg_army_id=11006,cfg_camp_id=110,camp_type=1,name="蓝斑蛇王",level=86,face=180002,figure=180002,desc="",order=6,require=4,reward_exploit=473,reward_prestige=6890,reward_exp=24620,reward_copper=10540,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=210001,pos_2=0,pos_3=210001,pos_4=0,pos_5=180002,pos_6=0,pos_7=150001,pos_8=0,pos_9=150001,complete_percent=30},[11007]={cfg_army_id=11007,cfg_camp_id=110,camp_type=1,name="紫斑蛇王",level=86,face=180002,figure=180002,desc="",order=7,require=4,reward_exploit=475,reward_prestige=6950,reward_exp=24740,reward_copper=10600,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=180002,pos_3=180002,pos_4=0,pos_5=180002,pos_6=0,pos_7=0,pos_8=180002,pos_9=0,complete_percent=35},[11008]={cfg_army_id=11008,cfg_camp_id=110,camp_type=1,name="美杜莎",level=86,face=180002,figure=180002,desc="",order=8,require=4,reward_exploit=477,reward_prestige=7020,reward_exp=24880,reward_copper=10680,reward_item=43030080,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=180002,pos_3=180002,pos_4=0,pos_5=180002,pos_6=0,pos_7=0,pos_8=180002,pos_9=0,complete_percent=40},[11009]={cfg_army_id=11009,cfg_camp_id=110,camp_type=1,name="战神石领卫",level=87,face=260001,figure=260001,desc="",order=9,require=8,reward_exploit=482,reward_prestige=7140,reward_exp=25110,reward_copper=10840,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=260001,pos_2=0,pos_3=190011,pos_4=0,pos_5=190002,pos_6=0,pos_7=190002,pos_8=0,pos_9=190002,complete_percent=45},[11010]={cfg_army_id=11010,cfg_camp_id=110,camp_type=1,name="战神狮领卫",level=87,face=270001,figure=270001,desc="",order=10,require=8,reward_exploit=484,reward_prestige=7190,reward_exp=25220,reward_copper=10890,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=270001,pos_2=0,pos_3=190011,pos_4=0,pos_5=190002,pos_6=0,pos_7=190002,pos_8=0,pos_9=190002,complete_percent=50},[11011]={cfg_army_id=11011,cfg_camp_id=110,camp_type=1,name="战神岩领卫",level=87,face=260001,figure=260001,desc="",order=11,require=8,reward_exploit=486,reward_prestige=7250,reward_exp=25340,reward_copper=10950,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=190011,pos_5=0,pos_6=190011,pos_7=190002,pos_8=260001,pos_9=190002,complete_percent=55},[11012]={cfg_army_id=11012,cfg_camp_id=110,camp_type=1,name="阿瑞斯",level=87,face=260002,figure=260002,desc="",order=12,require=8,reward_exploit=488,reward_prestige=7320,reward_exp=25480,reward_copper=11030,reward_item=43030080,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=190011,pos_5=0,pos_6=190011,pos_7=190002,pos_8=260002,pos_9=190002,complete_percent=60},[11013]={cfg_army_id=11013,cfg_camp_id=110,camp_type=1,name="雷霆使者",level=88,face=240001,figure=240001,desc="",order=13,require=12,reward_exploit=493,reward_prestige=7440,reward_exp=25710,reward_copper=11190,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=320002,pos_3=0,pos_4=310001,pos_5=240001,pos_6=310001,pos_7=0,pos_8=310001,pos_9=0,complete_percent=65},[11014]={cfg_army_id=11014,cfg_camp_id=110,camp_type=1,name="飞鹰使者",level=88,face=250004,figure=250004,desc="",order=14,require=12,reward_exploit=495,reward_prestige=7490,reward_exp=25820,reward_copper=11240,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=310001,pos_3=0,pos_4=320002,pos_5=250004,pos_6=320002,pos_7=0,pos_8=320002,pos_9=0,complete_percent=70},[11015]={cfg_army_id=11015,cfg_camp_id=110,camp_type=1,name="角龙使者",level=88,face=170014,figure=170014,desc="",order=15,require=12,reward_exploit=497,reward_prestige=7550,reward_exp=25940,reward_copper=11300,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=170014,pos_3=0,pos_4=170013,pos_5=170013,pos_6=170011,pos_7=0,pos_8=170011,pos_9=0,complete_percent=75},[11016]={cfg_army_id=11016,cfg_camp_id=110,camp_type=1,name="波塞冬",level=88,face=290001,figure=290001,desc="",order=16,require=12,reward_exploit=499,reward_prestige=7620,reward_exp=26080,reward_copper=11380,reward_item=43030080,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=290001,pos_3=0,pos_4=170013,pos_5=170013,pos_6=170011,pos_7=0,pos_8=170011,pos_9=0,complete_percent=80},[11017]={cfg_army_id=11017,cfg_camp_id=110,camp_type=1,name="魔王竹护卫",level=89,face=250002,figure=250002,desc="",order=17,require=16,reward_exploit=504,reward_prestige=7740,reward_exp=26310,reward_copper=11540,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=0,pos_3=220001,pos_4=220001,pos_5=0,pos_6=220001,pos_7=0,pos_8=250002,pos_9=0,complete_percent=85},[11018]={cfg_army_id=11018,cfg_camp_id=110,camp_type=1,name="魔王熊护卫",level=89,face=230001,figure=230001,desc="",order=18,require=16,reward_exploit=506,reward_prestige=7790,reward_exp=26420,reward_copper=11590,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=0,pos_3=220001,pos_4=220001,pos_5=0,pos_6=220001,pos_7=0,pos_8=230001,pos_9=0,complete_percent=90},[11019]={cfg_army_id=11019,cfg_camp_id=110,camp_type=1,name="魔王龙护卫",level=89,face=170001,figure=170001,desc="",order=19,require=16,reward_exploit=508,reward_prestige=7850,reward_exp=26540,reward_copper=11650,reward_item=11100080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=170001,pos_3=0,pos_4=0,pos_5=280001,pos_6=0,pos_7=280003,pos_8=280001,pos_9=280003,complete_percent=95},[11020]={cfg_army_id=11020,cfg_camp_id=110,camp_type=1,name="路西法",level=89,face=170021,figure=170021,desc="",order=20,require=16,reward_exploit=510,reward_prestige=7920,reward_exp=26680,reward_copper=11730,reward_item=43030080,drop_ratio=0.300,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=170021,pos_3=0,pos_4=0,pos_5=280001,pos_6=0,pos_7=280003,pos_8=280001,pos_9=280003,complete_percent=100},[20101]={cfg_army_id=20101,cfg_camp_id=201,camp_type=2,name="黄狐精灵",level=30,face=220001,figure=220001,desc="",order=1,require=0,reward_exploit=220,reward_prestige=1675,reward_exp=8825,reward_copper=2500,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=220001,pos_3=0,pos_4=220001,pos_5=0,pos_6=220001,pos_7=0,pos_8=220001,pos_9=0,complete_percent=10},[20102]={cfg_army_id=20102,cfg_camp_id=201,camp_type=2,name="石树龟",level=31,face=320002,figure=320002,desc="",order=2,require=1,reward_exploit=230,reward_prestige=1750,reward_exp=9375,reward_copper=2650,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=320002,pos_3=0,pos_4=110001,pos_5=250001,pos_6=110001,pos_7=0,pos_8=0,pos_9=0,complete_percent=20},[20103]={cfg_army_id=20103,cfg_camp_id=201,camp_type=2,name="海树龟",level=32,face=310001,figure=310001,desc="",order=3,require=1,reward_exploit=240,reward_prestige=1825,reward_exp=9925,reward_copper=2800,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=310001,pos_3=0,pos_4=0,pos_5=0,pos_6=0,pos_7=320002,pos_8=190011,pos_9=320002,complete_percent=30},[20104]={cfg_army_id=20104,cfg_camp_id=201,camp_type=2,name="花大猫",level=33,face=220012,figure=220012,desc="",order=4,require=1,reward_exploit=250,reward_prestige=1900,reward_exp=10475,reward_copper=2950,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220012,pos_2=0,pos_3=220012,pos_4=0,pos_5=220012,pos_6=0,pos_7=0,pos_8=220012,pos_9=0,complete_percent=40},[20105]={cfg_army_id=20105,cfg_camp_id=201,camp_type=2,name="赭蛙行者",level=34,face=150001,figure=150001,desc="",order=5,require=1,reward_exploit=260,reward_prestige=1975,reward_exp=11025,reward_copper=3100,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=150001,pos_2=0,pos_3=150001,pos_4=0,pos_5=150001,pos_6=0,pos_7=0,pos_8=150001,pos_9=0,complete_percent=50},[20106]={cfg_army_id=20106,cfg_camp_id=201,camp_type=2,name="顽皮熊",level=35,face=230001,figure=230001,desc="",order=6,require=1,reward_exploit=270,reward_prestige=2050,reward_exp=11575,reward_copper=3250,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=230001,pos_2=230001,pos_3=230001,pos_4=0,pos_5=0,pos_6=0,pos_7=0,pos_8=230001,pos_9=0,complete_percent=60},[20107]={cfg_army_id=20107,cfg_camp_id=201,camp_type=2,name="红果妖",level=36,face=190002,figure=190002,desc="",order=7,require=1,reward_exploit=280,reward_prestige=2125,reward_exp=12125,reward_copper=3400,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=190002,pos_3=0,pos_4=190002,pos_5=0,pos_6=190002,pos_7=190002,pos_8=0,pos_9=190002,complete_percent=70},[20108]={cfg_army_id=20108,cfg_camp_id=201,camp_type=2,name="蓝果人",level=37,face=190011,figure=190011,desc="",order=8,require=1,reward_exploit=290,reward_prestige=2200,reward_exp=12675,reward_copper=3550,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190011,pos_2=0,pos_3=190011,pos_4=0,pos_5=190011,pos_6=0,pos_7=190002,pos_8=0,pos_9=190002,complete_percent=80},[20109]={cfg_army_id=20109,cfg_camp_id=201,camp_type=2,name="黄果人",level=38,face=190011,figure=190011,desc="",order=9,require=1,reward_exploit=300,reward_prestige=2275,reward_exp=13225,reward_copper=3700,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190011,pos_2=0,pos_3=190011,pos_4=190011,pos_5=0,pos_6=190011,pos_7=0,pos_8=190011,pos_9=0,complete_percent=90},[20110]={cfg_army_id=20110,cfg_camp_id=201,camp_type=2,name="红果人",level=39,face=190011,figure=190011,desc="",order=10,require=1,reward_exploit=310,reward_prestige=2350,reward_exp=13775,reward_copper=3850,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190011,pos_2=190011,pos_3=190011,pos_4=0,pos_5=190011,pos_6=0,pos_7=0,pos_8=130045,pos_9=0,complete_percent=100},[20201]={cfg_army_id=20201,cfg_camp_id=202,camp_type=2,name="赫拉魔影",level=40,face=200001,figure=200001,desc="",order=1,require=0,reward_exploit=323,reward_prestige=2450,reward_exp=14450,reward_copper=4075,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=200001,pos_6=0,pos_7=0,pos_8=130045,pos_9=0,complete_percent=10},[20202]={cfg_army_id=20202,cfg_camp_id=202,camp_type=2,name="贪色小灰",level=41,face=230001,figure=230001,desc="",order=2,require=1,reward_exploit=335,reward_prestige=2550,reward_exp=15125,reward_copper=4300,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=230001,pos_2=0,pos_3=230001,pos_4=0,pos_5=230001,pos_6=0,pos_7=230001,pos_8=0,pos_9=230001,complete_percent=20},[20203]={cfg_army_id=20203,cfg_camp_id=202,camp_type=2,name="洛基魔影",level=42,face=200002,figure=200002,desc="",order=3,require=2,reward_exploit=348,reward_prestige=2650,reward_exp=15800,reward_copper=4525,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120011,pos_2=120011,pos_3=120011,pos_4=0,pos_5=200002,pos_6=0,pos_7=0,pos_8=120041,pos_9=0,complete_percent=30},[20204]={cfg_army_id=20204,cfg_camp_id=202,camp_type=2,name="四角蓝蛇",level=43,face=180002,figure=180002,desc="",order=4,require=3,reward_exploit=360,reward_prestige=2750,reward_exp=16475,reward_copper=4750,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=180002,pos_4=180002,pos_5=0,pos_6=180002,pos_7=0,pos_8=180002,pos_9=0,complete_percent=40},[20205]={cfg_army_id=20205,cfg_camp_id=202,camp_type=2,name="维纳斯魔影",level=44,face=200003,figure=200003,desc="",order=5,require=4,reward_exploit=373,reward_prestige=2850,reward_exp=17150,reward_copper=4975,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140045,pos_2=0,pos_3=140045,pos_4=140045,pos_5=200003,pos_6=140045,pos_7=0,pos_8=0,pos_9=0,complete_percent=50},[20206]={cfg_army_id=20206,cfg_camp_id=202,camp_type=2,name="四角紫蛇",level=45,face=180002,figure=180002,desc="",order=6,require=5,reward_exploit=385,reward_prestige=2950,reward_exp=17825,reward_copper=5200,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=180002,pos_4=180002,pos_5=0,pos_6=180002,pos_7=0,pos_8=180002,pos_9=0,complete_percent=60},[20207]={cfg_army_id=20207,cfg_camp_id=202,camp_type=2,name="奥丁魔影",level=46,face=200004,figure=200004,desc="",order=7,require=6,reward_exploit=398,reward_prestige=3050,reward_exp=18500,reward_copper=5425,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=110043,pos_6=0,pos_7=0,pos_8=200004,pos_9=0,complete_percent=70},[20208]={cfg_army_id=20208,cfg_camp_id=202,camp_type=2,name="调皮蓝水人",level=47,face=140011,figure=140011,desc="",order=8,require=7,reward_exploit=410,reward_prestige=3150,reward_exp=19175,reward_copper=5650,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140011,pos_2=0,pos_3=0,pos_4=140011,pos_5=130012,pos_6=140011,pos_7=140011,pos_8=0,pos_9=0,complete_percent=80},[20209]={cfg_army_id=20209,cfg_camp_id=202,camp_type=2,name="铁腕红水人",level=48,face=140011,figure=140011,desc="",order=9,require=8,reward_exploit=423,reward_prestige=3250,reward_exp=19850,reward_copper=5875,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140011,pos_2=0,pos_3=120011,pos_4=140011,pos_5=130012,pos_6=0,pos_7=140011,pos_8=0,pos_9=0,complete_percent=90},[20210]={cfg_army_id=20210,cfg_camp_id=202,camp_type=2,name="赤炎火人",level=49,face=120011,figure=120011,desc="",order=10,require=9,reward_exploit=435,reward_prestige=3350,reward_exp=20525,reward_copper=6100,reward_item=43010030,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120011,pos_2=0,pos_3=130012,pos_4=0,pos_5=120011,pos_6=130012,pos_7=0,pos_8=0,pos_9=130012,complete_percent=100},[20301]={cfg_army_id=20301,cfg_camp_id=203,camp_type=2,name="幼蓝狮仔",level=50,face=160013,figure=160013,desc="",order=1,require=0,reward_exploit=450,reward_prestige=3500,reward_exp=21350,reward_copper=6425,reward_item=43010050,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=230001,pos_3=230001,pos_4=0,pos_5=160013,pos_6=0,pos_7=230001,pos_8=230001,pos_9=0,complete_percent=10},[20302]={cfg_army_id=20302,cfg_camp_id=203,camp_type=2,name="幼红狮仔",level=51,face=160013,figure=160013,desc="",order=2,require=1,reward_exploit=465,reward_prestige=3650,reward_exp=22175,reward_copper=6750,reward_item=43010050,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=230001,pos_3=0,pos_4=230001,pos_5=230001,pos_6=160013,pos_7=0,pos_8=230001,pos_9=0,complete_percent=20},[20303]={cfg_army_id=20303,cfg_camp_id=203,camp_type=2,name="泥沙小黄兽",level=52,face=110001,figure=110001,desc="",order=3,require=2,reward_exploit=480,reward_prestige=3800,reward_exp=23000,reward_copper=7075,reward_item=43010050,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=110001,pos_2=0,pos_3=0,pos_4=110001,pos_5=130012,pos_6=140011,pos_7=110001,pos_8=0,pos_9=0,complete_percent=30},[20304]={cfg_army_id=20304,cfg_camp_id=203,camp_type=2,name="美狄亚",level=53,face=180002,figure=180002,desc="",order=4,require=3,reward_exploit=495,reward_prestige=3950,reward_exp=23825,reward_copper=7400,reward_item=43010050,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=0,pos_4=130045,pos_5=130045,pos_6=110001,pos_7=130045,pos_8=0,pos_9=0,complete_percent=40},[20305]={cfg_army_id=20305,cfg_camp_id=203,camp_type=2,name="卡俄斯",level=54,face=250002,figure=250002,desc="",order=5,require=4,reward_exploit=510,reward_prestige=4100,reward_exp=24650,reward_copper=7725,reward_item=43010050,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=250003,pos_4=250004,pos_5=250002,pos_6=250003,pos_7=0,pos_8=0,pos_9=250003,complete_percent=50},[20306]={cfg_army_id=20306,cfg_camp_id=203,camp_type=2,name="贪吃绿熊",level=55,face=230001,figure=230001,desc="",order=6,require=5,reward_exploit=525,reward_prestige=4250,reward_exp=25475,reward_copper=8050,reward_item=43010050,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=160013,pos_2=0,pos_3=0,pos_4=160013,pos_5=160013,pos_6=230001,pos_7=160013,pos_8=0,pos_9=0,complete_percent=60},[20307]={cfg_army_id=20307,cfg_camp_id=203,camp_type=2,name="贪醉棕猫",level=56,face=220012,figure=220012,desc="",order=7,require=6,reward_exploit=540,reward_prestige=4400,reward_exp=26300,reward_copper=8375,reward_item=43010050,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=0,pos_3=0,pos_4=220001,pos_5=230001,pos_6=220012,pos_7=0,pos_8=230001,pos_9=0,complete_percent=70},[20308]={cfg_army_id=20308,cfg_camp_id=203,camp_type=2,name="赤炎斗士",level=57,face=120041,figure=120041,desc="",order=8,require=7,reward_exploit=555,reward_prestige=4550,reward_exp=27125,reward_copper=8700,reward_item=43010050,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=120041,pos_3=130045,pos_4=120041,pos_5=120041,pos_6=110001,pos_7=0,pos_8=0,pos_9=0,complete_percent=80},[20309]={cfg_army_id=20309,cfg_camp_id=203,camp_type=2,name="阿波罗",level=58,face=270001,figure=270001,desc="",order=9,require=8,reward_exploit=570,reward_prestige=4700,reward_exp=27950,reward_copper=9025,reward_item=43010050,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170014,pos_2=170001,pos_3=0,pos_4=270001,pos_5=170001,pos_6=0,pos_7=170014,pos_8=0,pos_9=0,complete_percent=90},[20310]={cfg_army_id=20310,cfg_camp_id=203,camp_type=2,name="寒冰兽",level=59,face=280003,figure=280003,desc="",order=10,require=9,reward_exploit=585,reward_prestige=4850,reward_exp=28775,reward_copper=9350,reward_item=43010050,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=240001,pos_2=0,pos_3=0,pos_4=240001,pos_5=280003,pos_6=310001,pos_7=0,pos_8=0,pos_9=310001,complete_percent=100},[20401]={cfg_army_id=20401,cfg_camp_id=204,camp_type=2,name="壳贝黄蛙",level=60,face=150001,figure=150001,desc="",order=1,require=0,reward_exploit=603,reward_prestige=5100,reward_exp=29775,reward_copper=9800,reward_item=43010060,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=150001,pos_5=130012,pos_6=110001,pos_7=0,pos_8=130012,pos_9=110001,complete_percent=10},[20402]={cfg_army_id=20402,cfg_camp_id=204,camp_type=2,name="红眼魔鼠",level=61,face=250003,figure=250003,desc="",order=2,require=1,reward_exploit=620,reward_prestige=5350,reward_exp=30775,reward_copper=10250,reward_item=43010060,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=250002,pos_2=0,pos_3=0,pos_4=250002,pos_5=250003,pos_6=250004,pos_7=0,pos_8=0,pos_9=250004,complete_percent=20},[20403]={cfg_army_id=20403,cfg_camp_id=204,camp_type=2,name="魔灵贪婪",level=62,face=170011,figure=170011,desc="",order=3,require=2,reward_exploit=638,reward_prestige=5600,reward_exp=31775,reward_copper=10700,reward_item=43010060,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170012,pos_2=0,pos_3=0,pos_4=170012,pos_5=170011,pos_6=170013,pos_7=0,pos_8=0,pos_9=170013,complete_percent=30},[20404]={cfg_army_id=20404,cfg_camp_id=204,camp_type=2,name="魔灵嫉妒",level=63,face=170012,figure=170012,desc="",order=4,require=3,reward_exploit=655,reward_prestige=5850,reward_exp=32775,reward_copper=11150,reward_item=43010060,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170014,pos_2=0,pos_3=0,pos_4=170014,pos_5=170012,pos_6=170013,pos_7=0,pos_8=0,pos_9=170013,complete_percent=40},[20405]={cfg_army_id=20405,cfg_camp_id=204,camp_type=2,name="魔灵暴怒",level=64,face=120041,figure=120041,desc="",order=5,require=4,reward_exploit=673,reward_prestige=6100,reward_exp=33775,reward_copper=11600,reward_item=43010060,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120041,pos_2=0,pos_3=0,pos_4=120041,pos_5=0,pos_6=130045,pos_7=120041,pos_8=0,pos_9=130045,complete_percent=50},[20406]={cfg_army_id=20406,cfg_camp_id=204,camp_type=2,name="魔灵痛苦",level=65,face=210001,figure=210001,desc="",order=6,require=5,reward_exploit=690,reward_prestige=6350,reward_exp=34775,reward_copper=12050,reward_item=43010060,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=210001,pos_2=0,pos_3=130045,pos_4=130045,pos_5=130045,pos_6=130045,pos_7=0,pos_8=0,pos_9=0,complete_percent=60},[20407]={cfg_army_id=20407,cfg_camp_id=204,camp_type=2,name="潘多拉",level=66,face=140045,figure=140045,desc="",order=7,require=6,reward_exploit=708,reward_prestige=6600,reward_exp=35775,reward_copper=12500,reward_item=43010060,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140045,pos_2=0,pos_3=130045,pos_4=140045,pos_5=0,pos_6=0,pos_7=140045,pos_8=0,pos_9=130045,complete_percent=70},[20408]={cfg_army_id=20408,cfg_camp_id=204,camp_type=2,name="精灵希望",level=67,face=190011,figure=190011,desc="",order=8,require=7,reward_exploit=725,reward_prestige=6850,reward_exp=36775,reward_copper=12950,reward_item=43010060,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190002,pos_2=0,pos_3=190002,pos_4=190002,pos_5=190002,pos_6=0,pos_7=190011,pos_8=0,pos_9=0,complete_percent=80},[20409]={cfg_army_id=20409,cfg_camp_id=204,camp_type=2,name="绿影风卫",level=68,face=130045,figure=130045,desc="",order=9,require=8,reward_exploit=743,reward_prestige=7100,reward_exp=37775,reward_copper=13400,reward_item=43010060,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130012,pos_3=130012,pos_4=130012,pos_5=130012,pos_6=130045,pos_7=0,pos_8=0,pos_9=0,complete_percent=90},[20410]={cfg_army_id=20410,cfg_camp_id=204,camp_type=2,name="蛇心恶商",level=69,face=180002,figure=180002,desc="",order=10,require=9,reward_exploit=760,reward_prestige=7350,reward_exp=38775,reward_copper=13850,reward_item=43010060,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=150001,pos_2=150001,pos_3=0,pos_4=180002,pos_5=150001,pos_6=0,pos_7=150001,pos_8=0,pos_9=0,complete_percent=100},[20501]={cfg_army_id=20501,cfg_camp_id=205,camp_type=2,name="紫甲龙",level=70,face=170025,figure=170025,desc="",order=1,require=0,reward_exploit=783,reward_prestige=7800,reward_exp=39975,reward_copper=14475,reward_item=43010070,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=0,pos_5=170011,pos_6=170012,pos_7=170025,pos_8=170014,pos_9=170014,complete_percent=10},[20502]={cfg_army_id=20502,cfg_camp_id=205,camp_type=2,name="火狐",level=71,face=220001,figure=220001,desc="",order=2,require=1,reward_exploit=805,reward_prestige=8250,reward_exp=41175,reward_copper=15100,reward_item=43010070,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=220012,pos_3=220001,pos_4=0,pos_5=220012,pos_6=220012,pos_7=0,pos_8=0,pos_9=220012,complete_percent=20},[20503]={cfg_army_id=20503,cfg_camp_id=205,camp_type=2,name="赤火魔",level=72,face=120041,figure=120041,desc="",order=3,require=2,reward_exploit=828,reward_prestige=8700,reward_exp=42375,reward_copper=15725,reward_item=43010070,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120041,pos_2=120011,pos_3=0,pos_4=0,pos_5=0,pos_6=120011,pos_7=120011,pos_8=0,pos_9=120011,complete_percent=30},[20504]={cfg_army_id=20504,cfg_camp_id=205,camp_type=2,name="冰晶魂兽",level=73,face=280001,figure=280001,desc="",order=4,require=3,reward_exploit=850,reward_prestige=9150,reward_exp=43575,reward_copper=16350,reward_item=43010070,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=280001,pos_4=0,pos_5=280003,pos_6=280003,pos_7=280003,pos_8=0,pos_9=280003,complete_percent=40},[20505]={cfg_army_id=20505,cfg_camp_id=205,camp_type=2,name="墨丘利",level=74,face=170001,figure=170001,desc="",order=5,require=4,reward_exploit=873,reward_prestige=9600,reward_exp=44775,reward_copper=16975,reward_item=43010070,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170001,pos_2=0,pos_3=0,pos_4=170003,pos_5=0,pos_6=0,pos_7=170003,pos_8=170002,pos_9=170002,complete_percent=50},[20506]={cfg_army_id=20506,cfg_camp_id=205,camp_type=2,name="金狮",level=75,face=160013,figure=160013,desc="",order=6,require=5,reward_exploit=895,reward_prestige=10050,reward_exp=45975,reward_copper=17600,reward_item=43010070,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=160013,pos_2=110001,pos_3=110001,pos_4=0,pos_5=0,pos_6=0,pos_7=290001,pos_8=290001,pos_9=0,complete_percent=60},[20507]={cfg_army_id=20507,cfg_camp_id=205,camp_type=2,name="雅典娜",level=76,face=280002,figure=280002,desc="",order=7,require=6,reward_exploit=918,reward_prestige=10500,reward_exp=47175,reward_copper=18225,reward_item=43010070,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=260001,pos_3=0,pos_4=280001,pos_5=280002,pos_6=280001,pos_7=0,pos_8=260002,pos_9=0,complete_percent=70},[20508]={cfg_army_id=20508,cfg_camp_id=205,camp_type=2,name="鬼卫",level=77,face=210001,figure=210001,desc="",order=8,require=7,reward_exploit=940,reward_prestige=10950,reward_exp=48375,reward_copper=18850,reward_item=43010070,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=220001,pos_3=0,pos_4=0,pos_5=300001,pos_6=300001,pos_7=0,pos_8=0,pos_9=210001,complete_percent=80},[20509]={cfg_army_id=20509,cfg_camp_id=205,camp_type=2,name="米诺斯",level=78,face=130045,figure=130045,desc="",order=9,require=8,reward_exploit=963,reward_prestige=11400,reward_exp=49575,reward_copper=19475,reward_item=43010070,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=0,pos_4=130045,pos_5=230001,pos_6=0,pos_7=230001,pos_8=0,pos_9=0,complete_percent=90},[20510]={cfg_army_id=20510,cfg_camp_id=205,camp_type=2,name="拉达曼提斯",level=79,face=130045,figure=130045,desc="",order=10,require=9,reward_exploit=985,reward_prestige=11850,reward_exp=50775,reward_copper=20100,reward_item=43010070,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=0,pos_5=130012,pos_6=130012,pos_7=130045,pos_8=170025,pos_9=170025,complete_percent=100},[20601]={cfg_army_id=20601,cfg_camp_id=206,camp_type=2,name="艾亚哥斯",level=80,face=130045,figure=130045,desc="",order=1,require=0,reward_exploit=1013,reward_prestige=12600,reward_exp=52275,reward_copper=20975,reward_item=43010080,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=190011,pos_3=130045,pos_4=0,pos_5=130045,pos_6=190011,pos_7=0,pos_8=0,pos_9=130045,complete_percent=10},[20602]={cfg_army_id=20602,cfg_camp_id=206,camp_type=2,name="草树龟",level=81,face=310001,figure=310001,desc="",order=2,require=1,reward_exploit=1040,reward_prestige=13350,reward_exp=53775,reward_copper=21850,reward_item=43010080,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=310001,pos_2=160013,pos_3=0,pos_4=0,pos_5=0,pos_6=160013,pos_7=210005,pos_8=0,pos_9=210005,complete_percent=20},[20603]={cfg_army_id=20603,cfg_camp_id=206,camp_type=2,name="哈迪斯",level=82,face=300001,figure=300001,desc="",order=3,require=2,reward_exploit=1068,reward_prestige=14100,reward_exp=55275,reward_copper=22725,reward_item=43010080,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=0,pos_3=220001,pos_4=0,pos_5=300001,pos_6=0,pos_7=220001,pos_8=0,pos_9=220001,complete_percent=30},[20604]={cfg_army_id=20604,cfg_camp_id=206,camp_type=2,name="加百列",level=83,face=130045,figure=130045,desc="",order=4,require=3,reward_exploit=1095,reward_prestige=14850,reward_exp=56775,reward_copper=23600,reward_item=43010080,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130045,pos_3=0,pos_4=130045,pos_5=0,pos_6=130045,pos_7=130045,pos_8=0,pos_9=130045,complete_percent=40},[20605]={cfg_army_id=20605,cfg_camp_id=206,camp_type=2,name="路西法",level=84,face=170021,figure=170021,desc="",order=5,require=4,reward_exploit=1123,reward_prestige=15600,reward_exp=58275,reward_copper=24475,reward_item=43010080,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=170021,pos_6=0,pos_7=0,pos_8=120011,pos_9=0,complete_percent=50},[20606]={cfg_army_id=20606,cfg_camp_id=206,camp_type=2,name="风沙青兽",level=85,face=110043,figure=110043,desc="",order=6,require=5,reward_exploit=1150,reward_prestige=16350,reward_exp=59775,reward_copper=25350,reward_item=43010080,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=110043,pos_3=0,pos_4=0,pos_5=110001,pos_6=0,pos_7=110001,pos_8=110001,pos_9=110001,complete_percent=60},[20607]={cfg_army_id=20607,cfg_camp_id=206,camp_type=2,name="金斑蛇王",level=86,face=180002,figure=180002,desc="",order=7,require=6,reward_exploit=1178,reward_prestige=17100,reward_exp=61275,reward_copper=26225,reward_item=43010080,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=180002,pos_3=180002,pos_4=0,pos_5=180002,pos_6=0,pos_7=0,pos_8=180002,pos_9=0,complete_percent=70},[20608]={cfg_army_id=20608,cfg_camp_id=206,camp_type=2,name="阿瑞斯",level=87,face=260002,figure=260002,desc="",order=8,require=7,reward_exploit=1205,reward_prestige=17850,reward_exp=62775,reward_copper=27100,reward_item=43010080,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=190011,pos_5=0,pos_6=190011,pos_7=190002,pos_8=260002,pos_9=190002,complete_percent=80},[20609]={cfg_army_id=20609,cfg_camp_id=206,camp_type=2,name="波塞冬",level=88,face=290001,figure=290001,desc="",order=9,require=8,reward_exploit=1233,reward_prestige=18600,reward_exp=64275,reward_copper=27975,reward_item=43010080,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=290001,pos_3=0,pos_4=170013,pos_5=170013,pos_6=170011,pos_7=0,pos_8=170011,pos_9=0,complete_percent=90},[20610]={cfg_army_id=20610,cfg_camp_id=206,camp_type=2,name="路西法",level=89,face=170021,figure=170021,desc="",order=10,require=9,reward_exploit=1260,reward_prestige=19350,reward_exp=65775,reward_copper=28850,reward_item=43010080,drop_ratio=1.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=170021,pos_3=0,pos_4=0,pos_5=280001,pos_6=0,pos_7=280003,pos_8=280001,pos_9=280003,complete_percent=100},[30101]={cfg_army_id=30101,cfg_camp_id=301,camp_type=3,name="小青狐",level=30,face=220001,figure=220001,desc="",order=1,require=0,reward_exploit=36,reward_prestige=0,reward_exp=1412,reward_copper=400,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=0,pos_3=220001,pos_4=0,pos_5=220001,pos_6=0,pos_7=0,pos_8=220001,pos_9=0,complete_percent=10},[30102]={cfg_army_id=30102,cfg_camp_id=301,camp_type=3,name="黄狐精灵",level=30,face=220001,figure=220001,desc="",order=2,require=1,reward_exploit=37,reward_prestige=0,reward_exp=1500,reward_copper=424,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=220001,pos_3=0,pos_4=220001,pos_5=0,pos_6=220001,pos_7=0,pos_8=220001,pos_9=0,complete_percent=20},[30103]={cfg_army_id=30103,cfg_camp_id=301,camp_type=3,name="树果仔",level=30,face=190002,figure=190002,desc="",order=3,require=2,reward_exploit=39,reward_prestige=0,reward_exp=1588,reward_copper=448,reward_item=43020030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=190011,pos_3=0,pos_4=190002,pos_5=0,pos_6=190002,pos_7=0,pos_8=190002,pos_9=0,complete_percent=30},[30104]={cfg_army_id=30104,cfg_camp_id=301,camp_type=3,name="小粉猫",level=30,face=220012,figure=220012,desc="",order=4,require=3,reward_exploit=40,reward_prestige=0,reward_exp=1676,reward_copper=472,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=220012,pos_5=220012,pos_6=220012,pos_7=0,pos_8=220012,pos_9=0,complete_percent=40},[30105]={cfg_army_id=30105,cfg_camp_id=301,camp_type=3,name="花大猫",level=30,face=220012,figure=220012,desc="",order=5,require=4,reward_exploit=42,reward_prestige=0,reward_exp=1764,reward_copper=496,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220012,pos_2=0,pos_3=220012,pos_4=0,pos_5=220012,pos_6=0,pos_7=0,pos_8=220012,pos_9=0,complete_percent=50},[30106]={cfg_army_id=30106,cfg_camp_id=301,camp_type=3,name="紫蛙",level=30,face=150001,figure=150001,desc="",order=6,require=5,reward_exploit=44,reward_prestige=0,reward_exp=1852,reward_copper=520,reward_item=43020030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=150001,pos_2=0,pos_3=150001,pos_4=0,pos_5=0,pos_6=0,pos_7=150001,pos_8=0,pos_9=150001,complete_percent=60},[30107]={cfg_army_id=30107,cfg_camp_id=301,camp_type=3,name="绿果仔",level=30,face=190011,figure=190011,desc="",order=7,require=6,reward_exploit=45,reward_prestige=0,reward_exp=1940,reward_copper=544,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=190011,pos_3=0,pos_4=190002,pos_5=190002,pos_6=190002,pos_7=0,pos_8=190002,pos_9=0,complete_percent=70},[30108]={cfg_army_id=30108,cfg_camp_id=301,camp_type=3,name="蓝果人",level=30,face=190011,figure=190011,desc="",order=8,require=7,reward_exploit=47,reward_prestige=0,reward_exp=2028,reward_copper=568,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190011,pos_2=0,pos_3=190011,pos_4=0,pos_5=190011,pos_6=0,pos_7=190002,pos_8=0,pos_9=190002,complete_percent=80},[30109]={cfg_army_id=30109,cfg_camp_id=301,camp_type=3,name="蓝果仔",level=30,face=190011,figure=190011,desc="",order=9,require=8,reward_exploit=48,reward_prestige=0,reward_exp=2116,reward_copper=592,reward_item=43020030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=190011,pos_4=0,pos_5=190011,pos_6=190002,pos_7=190011,pos_8=190002,pos_9=0,complete_percent=90},[30110]={cfg_army_id=30110,cfg_camp_id=301,camp_type=3,name="红果人",level=30,face=190011,figure=190011,desc="",order=10,require=9,reward_exploit=50,reward_prestige=0,reward_exp=2204,reward_copper=616,reward_item=43020030,drop_ratio=2.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190011,pos_2=190011,pos_3=190011,pos_4=0,pos_5=190011,pos_6=0,pos_7=0,pos_8=130045,pos_9=0,complete_percent=100},[30201]={cfg_army_id=30201,cfg_camp_id=302,camp_type=3,name="天后卫士",level=40,face=130045,figure=130045,desc="",order=1,require=0,reward_exploit=52,reward_prestige=0,reward_exp=2312,reward_copper=652,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=0,pos_6=0,pos_7=130045,pos_8=0,pos_9=130045,complete_percent=10},[30202]={cfg_army_id=30202,cfg_camp_id=302,camp_type=3,name="天后守护者",level=40,face=130045,figure=130045,desc="",order=2,require=1,reward_exploit=54,reward_prestige=0,reward_exp=2420,reward_copper=688,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130045,pos_3=0,pos_4=130012,pos_5=0,pos_6=130012,pos_7=130045,pos_8=0,pos_9=130045,complete_percent=20},[30203]={cfg_army_id=30203,cfg_camp_id=302,camp_type=3,name="赫拉魔影",level=40,face=200001,figure=200001,desc="",order=3,require=2,reward_exploit=56,reward_prestige=0,reward_exp=2528,reward_copper=724,reward_item=43020030,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=200001,pos_6=0,pos_7=0,pos_8=130045,pos_9=0,complete_percent=30},[30204]={cfg_army_id=30204,cfg_camp_id=302,camp_type=3,name="四角绿蛇",level=40,face=180002,figure=180002,desc="",order=4,require=3,reward_exploit=58,reward_prestige=0,reward_exp=2636,reward_copper=760,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=180002,pos_4=180002,pos_5=0,pos_6=180002,pos_7=0,pos_8=180002,pos_9=0,complete_percent=40},[30205]={cfg_army_id=30205,cfg_camp_id=302,camp_type=3,name="四角红蛇",level=40,face=180002,figure=180002,desc="",order=5,require=4,reward_exploit=60,reward_prestige=0,reward_exp=2744,reward_copper=796,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=180002,pos_4=180002,pos_5=180002,pos_6=180002,pos_7=0,pos_8=0,pos_9=0,complete_percent=50},[30206]={cfg_army_id=30206,cfg_camp_id=302,camp_type=3,name="四角蓝蛇",level=40,face=180002,figure=180002,desc="",order=6,require=5,reward_exploit=62,reward_prestige=0,reward_exp=2852,reward_copper=832,reward_item=43020030,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=180002,pos_4=180002,pos_5=0,pos_6=180002,pos_7=0,pos_8=180002,pos_9=0,complete_percent=60},[30207]={cfg_army_id=30207,cfg_camp_id=302,camp_type=3,name="异化黄水灵",level=40,face=140011,figure=140011,desc="",order=7,require=6,reward_exploit=64,reward_prestige=0,reward_exp=2960,reward_copper=868,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130012,pos_2=0,pos_3=140011,pos_4=140011,pos_5=110001,pos_6=0,pos_7=0,pos_8=0,pos_9=140011,complete_percent=70},[30208]={cfg_army_id=30208,cfg_camp_id=302,camp_type=3,name="异化紫水灵",level=40,face=140011,figure=140011,desc="",order=8,require=7,reward_exploit=66,reward_prestige=0,reward_exp=3068,reward_copper=904,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130012,pos_2=140011,pos_3=140011,pos_4=130012,pos_5=0,pos_6=140011,pos_7=0,pos_8=0,pos_9=0,complete_percent=80},[30209]={cfg_army_id=30209,cfg_camp_id=302,camp_type=3,name="调皮蓝水人",level=40,face=140011,figure=140011,desc="",order=9,require=8,reward_exploit=68,reward_prestige=0,reward_exp=3176,reward_copper=940,reward_item=43020030,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=140011,pos_2=0,pos_3=0,pos_4=140011,pos_5=130012,pos_6=140011,pos_7=140011,pos_8=0,pos_9=0,complete_percent=90},[30210]={cfg_army_id=30210,cfg_camp_id=302,camp_type=3,name="赤炎火人",level=40,face=120011,figure=120011,desc="",order=10,require=9,reward_exploit=70,reward_prestige=0,reward_exp=3284,reward_copper=976,reward_item=43020030,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120011,pos_2=0,pos_3=130012,pos_4=0,pos_5=120011,pos_6=130012,pos_7=0,pos_8=0,pos_9=130012,complete_percent=100},[30301]={cfg_army_id=30301,cfg_camp_id=303,camp_type=3,name="蓝灵火人",level=50,face=120011,figure=120011,desc="",order=1,require=0,reward_exploit=72,reward_prestige=0,reward_exp=3416,reward_copper=1028,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130012,pos_3=120011,pos_4=120011,pos_5=130012,pos_6=0,pos_7=0,pos_8=130012,pos_9=0,complete_percent=10},[30302]={cfg_army_id=30302,cfg_camp_id=303,camp_type=3,name="紫灵火人",level=50,face=120011,figure=120011,desc="",order=2,require=1,reward_exploit=75,reward_prestige=0,reward_exp=3548,reward_copper=1080,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=120011,pos_2=0,pos_3=130012,pos_4=120011,pos_5=0,pos_6=130012,pos_7=120011,pos_8=0,pos_9=0,complete_percent=20},[30303]={cfg_army_id=30303,cfg_camp_id=303,camp_type=3,name="幼蓝狮仔",level=50,face=160013,figure=160013,desc="",order=3,require=2,reward_exploit=77,reward_prestige=0,reward_exp=3680,reward_copper=1132,reward_item=43020050,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=230001,pos_3=230001,pos_4=0,pos_5=160013,pos_6=0,pos_7=230001,pos_8=230001,pos_9=0,complete_percent=30},[30304]={cfg_army_id=30304,cfg_camp_id=303,camp_type=3,name="幼青沙兽",level=50,face=110001,figure=110001,desc="",order=4,require=3,reward_exploit=80,reward_prestige=0,reward_exp=3812,reward_copper=1184,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=110001,pos_2=0,pos_3=110001,pos_4=110001,pos_5=0,pos_6=0,pos_7=110001,pos_8=0,pos_9=140011,complete_percent=40},[30305]={cfg_army_id=30305,cfg_camp_id=303,camp_type=3,name="魔眼紫蛇",level=50,face=180002,figure=180002,desc="",order=5,require=4,reward_exploit=82,reward_prestige=0,reward_exp=3944,reward_copper=1236,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130045,pos_3=0,pos_4=120011,pos_5=130045,pos_6=180002,pos_7=120011,pos_8=0,pos_9=0,complete_percent=50},[30306]={cfg_army_id=30306,cfg_camp_id=303,camp_type=3,name="美狄亚",level=50,face=180002,figure=180002,desc="",order=6,require=5,reward_exploit=84,reward_prestige=0,reward_exp=4076,reward_copper=1288,reward_item=43020050,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=0,pos_4=130045,pos_5=130045,pos_6=110001,pos_7=130045,pos_8=0,pos_9=0,complete_percent=60},[30307]={cfg_army_id=30307,cfg_camp_id=303,camp_type=3,name="妖火绿焰",level=50,face=120041,figure=120041,desc="",order=7,require=6,reward_exploit=87,reward_prestige=0,reward_exp=4208,reward_copper=1340,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=120011,pos_3=130012,pos_4=120041,pos_5=120011,pos_6=110001,pos_7=0,pos_8=0,pos_9=0,complete_percent=70},[30308]={cfg_army_id=30308,cfg_camp_id=303,camp_type=3,name="妖火蓝焰",level=50,face=120041,figure=120041,desc="",order=8,require=7,reward_exploit=89,reward_prestige=0,reward_exp=4340,reward_copper=1392,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=120041,pos_3=130045,pos_4=120041,pos_5=120041,pos_6=110001,pos_7=0,pos_8=0,pos_9=0,complete_percent=80},[30309]={cfg_army_id=30309,cfg_camp_id=303,camp_type=3,name="赤炎斗士",level=50,face=120041,figure=120041,desc="",order=9,require=8,reward_exploit=92,reward_prestige=0,reward_exp=4472,reward_copper=1444,reward_item=43020050,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=120041,pos_3=130045,pos_4=120041,pos_5=120041,pos_6=110001,pos_7=0,pos_8=0,pos_9=0,complete_percent=90},[30310]={cfg_army_id=30310,cfg_camp_id=303,camp_type=3,name="寒冰兽",level=50,face=280003,figure=280003,desc="",order=10,require=9,reward_exploit=94,reward_prestige=0,reward_exp=4604,reward_copper=1496,reward_item=43020050,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=240001,pos_2=0,pos_3=0,pos_4=240001,pos_5=280003,pos_6=310001,pos_7=0,pos_8=0,pos_9=310001,complete_percent=100},[30401]={cfg_army_id=30401,cfg_camp_id=304,camp_type=3,name="魔化冰晶",level=60,face=280001,figure=280001,desc="",order=1,require=0,reward_exploit=97,reward_prestige=0,reward_exp=4764,reward_copper=1568,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=240001,pos_2=0,pos_3=0,pos_4=240001,pos_5=280001,pos_6=140045,pos_7=0,pos_8=0,pos_9=140045,complete_percent=10},[30402]={cfg_army_id=30402,cfg_camp_id=304,camp_type=3,name="壳贝翠蛙",level=60,face=150001,figure=150001,desc="",order=2,require=1,reward_exploit=100,reward_prestige=0,reward_exp=4924,reward_copper=1640,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=150001,pos_5=130012,pos_6=110001,pos_7=0,pos_8=130012,pos_9=110001,complete_percent=20},[30403]={cfg_army_id=30403,cfg_camp_id=304,camp_type=3,name="壳贝黄蛙",level=60,face=150001,figure=150001,desc="",order=3,require=2,reward_exploit=102,reward_prestige=0,reward_exp=5084,reward_copper=1712,reward_item=43020060,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=150001,pos_5=130012,pos_6=110001,pos_7=0,pos_8=130012,pos_9=110001,complete_percent=30},[30404]={cfg_army_id=30404,cfg_camp_id=304,camp_type=3,name="懵懂绿豆",level=60,face=170013,figure=170013,desc="",order=4,require=3,reward_exploit=105,reward_prestige=0,reward_exp=5244,reward_copper=1784,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170012,pos_2=170011,pos_3=0,pos_4=170012,pos_5=170011,pos_6=170013,pos_7=0,pos_8=0,pos_9=0,complete_percent=40},[30405]={cfg_army_id=30405,cfg_camp_id=304,camp_type=3,name="狂暴斗龙",level=60,face=170014,figure=170014,desc="",order=5,require=4,reward_exploit=108,reward_prestige=0,reward_exp=5404,reward_copper=1856,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170012,pos_2=170011,pos_3=170012,pos_4=170014,pos_5=170011,pos_6=0,pos_7=0,pos_8=0,pos_9=0,complete_percent=50},[30406]={cfg_army_id=30406,cfg_camp_id=304,camp_type=3,name="魔灵嫉妒",level=60,face=170012,figure=170012,desc="",order=6,require=5,reward_exploit=111,reward_prestige=0,reward_exp=5564,reward_copper=1928,reward_item=43020060,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170014,pos_2=0,pos_3=0,pos_4=170014,pos_5=170012,pos_6=170013,pos_7=0,pos_8=0,pos_9=170013,complete_percent=60},[30407]={cfg_army_id=30407,cfg_camp_id=304,camp_type=3,name="蓝果精灵",level=60,face=190011,figure=190011,desc="",order=7,require=6,reward_exploit=114,reward_prestige=0,reward_exp=5724,reward_copper=2000,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=190002,pos_3=0,pos_4=190002,pos_5=190002,pos_6=190002,pos_7=0,pos_8=190011,pos_9=0,complete_percent=70},[30408]={cfg_army_id=30408,cfg_camp_id=304,camp_type=3,name="金果精灵",level=60,face=190011,figure=190011,desc="",order=8,require=7,reward_exploit=116,reward_prestige=0,reward_exp=5884,reward_copper=2072,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190002,pos_2=190002,pos_3=0,pos_4=190002,pos_5=190002,pos_6=0,pos_7=0,pos_8=190011,pos_9=0,complete_percent=80},[30409]={cfg_army_id=30409,cfg_camp_id=304,camp_type=3,name="精灵希望",level=60,face=190011,figure=190011,desc="",order=9,require=8,reward_exploit=119,reward_prestige=0,reward_exp=6044,reward_copper=2144,reward_item=43020060,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=190002,pos_2=0,pos_3=190002,pos_4=190002,pos_5=190002,pos_6=0,pos_7=190011,pos_8=0,pos_9=0,complete_percent=90},[30410]={cfg_army_id=30410,cfg_camp_id=304,camp_type=3,name="蛇心恶商",level=60,face=180002,figure=180002,desc="",order=10,require=9,reward_exploit=122,reward_prestige=0,reward_exp=6204,reward_copper=2216,reward_item=43020060,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=150001,pos_2=150001,pos_3=0,pos_4=180002,pos_5=150001,pos_6=0,pos_7=150001,pos_8=0,pos_9=0,complete_percent=100},[30501]={cfg_army_id=30501,cfg_camp_id=305,camp_type=3,name="金甲龙",level=70,face=170021,figure=170021,desc="",order=1,require=0,reward_exploit=126,reward_prestige=0,reward_exp=6396,reward_copper=2316,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170021,pos_2=0,pos_3=170012,pos_4=0,pos_5=170012,pos_6=0,pos_7=170011,pos_8=0,pos_9=170011,complete_percent=10},[30502]={cfg_army_id=30502,cfg_camp_id=305,camp_type=3,name="蓝甲龙",level=70,face=170021,figure=170021,desc="",order=2,require=1,reward_exploit=129,reward_prestige=0,reward_exp=6588,reward_copper=2416,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=170011,pos_3=0,pos_4=170012,pos_5=170021,pos_6=170012,pos_7=0,pos_8=170011,pos_9=0,complete_percent=20},[30503]={cfg_army_id=30503,cfg_camp_id=305,camp_type=3,name="紫甲龙",level=70,face=170025,figure=170025,desc="",order=3,require=2,reward_exploit=133,reward_prestige=0,reward_exp=6780,reward_copper=2516,reward_item=43020070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=0,pos_5=170011,pos_6=170012,pos_7=170025,pos_8=170014,pos_9=170014,complete_percent=30},[30504]={cfg_army_id=30504,cfg_camp_id=305,camp_type=3,name="金毛魔狮",level=70,face=270001,figure=270001,desc="",order=4,require=3,reward_exploit=136,reward_prestige=0,reward_exp=6972,reward_copper=2616,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220012,pos_2=0,pos_3=0,pos_4=210005,pos_5=170011,pos_6=0,pos_7=270001,pos_8=210005,pos_9=0,complete_percent=40},[30505]={cfg_army_id=30505,cfg_camp_id=305,camp_type=3,name="暗影甲龙",level=70,face=210003,figure=210003,desc="",order=5,require=4,reward_exploit=140,reward_prestige=0,reward_exp=7164,reward_copper=2716,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=180002,pos_2=0,pos_3=310001,pos_4=180002,pos_5=310001,pos_6=0,pos_7=210003,pos_8=0,pos_9=0,complete_percent=50},[30506]={cfg_army_id=30506,cfg_camp_id=305,camp_type=3,name="鬼卫",level=70,face=210001,figure=210001,desc="",order=6,require=5,reward_exploit=144,reward_prestige=0,reward_exp=7356,reward_copper=2816,reward_item=43020070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=220001,pos_3=0,pos_4=0,pos_5=300001,pos_6=300001,pos_7=0,pos_8=0,pos_9=210001,complete_percent=60},[30507]={cfg_army_id=30507,cfg_camp_id=305,camp_type=3,name="紫灵狱守",level=70,face=130045,figure=130045,desc="",order=7,require=6,reward_exploit=147,reward_prestige=0,reward_exp=7548,reward_copper=2916,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=0,pos_3=170021,pos_4=0,pos_5=170021,pos_6=0,pos_7=130012,pos_8=0,pos_9=130012,complete_percent=70},[30508]={cfg_army_id=30508,cfg_camp_id=305,camp_type=3,name="绿灵狱守",level=70,face=130012,figure=130012,desc="",order=8,require=7,reward_exploit=151,reward_prestige=0,reward_exp=7740,reward_copper=3016,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130012,pos_3=0,pos_4=170021,pos_5=130012,pos_6=170021,pos_7=0,pos_8=130012,pos_9=0,complete_percent=80},[30509]={cfg_army_id=30509,cfg_camp_id=305,camp_type=3,name="赤灵狱守",level=70,face=130045,figure=130045,desc="",order=9,require=8,reward_exploit=154,reward_prestige=0,reward_exp=7932,reward_copper=3116,reward_item=43020070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=170021,pos_2=130045,pos_3=170021,pos_4=130012,pos_5=0,pos_6=130012,pos_7=0,pos_8=0,pos_9=0,complete_percent=90},[30510]={cfg_army_id=30510,cfg_camp_id=305,camp_type=3,name="拉达曼提斯",level=70,face=130045,figure=130045,desc="",order=10,require=9,reward_exploit=158,reward_prestige=0,reward_exp=8124,reward_copper=3216,reward_item=43020070,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=0,pos_5=130012,pos_6=130012,pos_7=130045,pos_8=170025,pos_9=170025,complete_percent=100},[30601]={cfg_army_id=30601,cfg_camp_id=306,camp_type=3,name="审判金守卫",level=80,face=130045,figure=130045,desc="",order=1,require=0,reward_exploit=162,reward_prestige=0,reward_exp=8364,reward_copper=3356,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=130012,pos_3=0,pos_4=0,pos_5=0,pos_6=170025,pos_7=170025,pos_8=130045,pos_9=130012,complete_percent=10},[30602]={cfg_army_id=30602,cfg_camp_id=306,camp_type=3,name="艾亚哥斯",level=80,face=130045,figure=130045,desc="",order=2,require=1,reward_exploit=167,reward_prestige=0,reward_exp=8604,reward_copper=3496,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=190011,pos_3=130045,pos_4=0,pos_5=130045,pos_6=190011,pos_7=0,pos_8=0,pos_9=130045,complete_percent=20},[30603]={cfg_army_id=30603,cfg_camp_id=306,camp_type=3,name="哈迪斯",level=80,face=300001,figure=300001,desc="",order=3,require=2,reward_exploit=171,reward_prestige=0,reward_exp=8844,reward_copper=3636,reward_item=43020080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=220001,pos_2=0,pos_3=220001,pos_4=0,pos_5=300001,pos_6=0,pos_7=220001,pos_8=0,pos_9=220001,complete_percent=30},[30604]={cfg_army_id=30604,cfg_camp_id=306,camp_type=3,name="堕落紫龙",level=80,face=170025,figure=170025,desc="",order=4,require=3,reward_exploit=176,reward_prestige=0,reward_exp=9084,reward_copper=3776,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=170025,pos_6=0,pos_7=0,pos_8=120011,pos_9=0,complete_percent=40},[30605]={cfg_army_id=30605,cfg_camp_id=306,camp_type=3,name="路西法",level=80,face=170021,figure=170021,desc="",order=5,require=4,reward_exploit=180,reward_prestige=0,reward_exp=9324,reward_copper=3916,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=130045,pos_2=130045,pos_3=130045,pos_4=0,pos_5=170021,pos_6=0,pos_7=0,pos_8=120011,pos_9=0,complete_percent=50},[30606]={cfg_army_id=30606,cfg_camp_id=306,camp_type=3,name="战神石领卫",level=80,face=260001,figure=260001,desc="",order=6,require=5,reward_exploit=184,reward_prestige=0,reward_exp=9564,reward_copper=4056,reward_item=43020080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=260001,pos_2=0,pos_3=190011,pos_4=0,pos_5=190002,pos_6=0,pos_7=190002,pos_8=0,pos_9=190002,complete_percent=60},[30607]={cfg_army_id=30607,cfg_camp_id=306,camp_type=3,name="战神狮领卫",level=80,face=270001,figure=270001,desc="",order=7,require=6,reward_exploit=189,reward_prestige=0,reward_exp=9804,reward_copper=4196,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=270001,pos_2=0,pos_3=190011,pos_4=0,pos_5=190002,pos_6=0,pos_7=190002,pos_8=0,pos_9=190002,complete_percent=70},[30608]={cfg_army_id=30608,cfg_camp_id=306,camp_type=3,name="阿瑞斯",level=80,face=260002,figure=260002,desc="",order=8,require=7,reward_exploit=193,reward_prestige=0,reward_exp=10044,reward_copper=4336,reward_item=0,drop_ratio=0.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=0,pos_3=0,pos_4=190011,pos_5=0,pos_6=190011,pos_7=190002,pos_8=260002,pos_9=190002,complete_percent=80},[30609]={cfg_army_id=30609,cfg_camp_id=306,camp_type=3,name="魔王龙护卫",level=80,face=170001,figure=170001,desc="",order=9,require=8,reward_exploit=198,reward_prestige=0,reward_exp=10284,reward_copper=4476,reward_item=43020080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=170001,pos_3=0,pos_4=0,pos_5=280001,pos_6=0,pos_7=280003,pos_8=280001,pos_9=280003,complete_percent=90},[30610]={cfg_army_id=30610,cfg_camp_id=306,camp_type=3,name="路西法",level=80,face=170021,figure=170021,desc="",order=10,require=9,reward_exploit=202,reward_prestige=0,reward_exp=10524,reward_copper=4616,reward_item=43020080,drop_ratio=3.000,reward_item2=0,drop_ratio2=0.000,story_word=0,pos_1=0,pos_2=170021,pos_3=0,pos_4=0,pos_5=280001,pos_6=0,pos_7=280003,pos_8=280001,pos_9=280003,complete_percent=100}}
cfg_camp_data = {[101]={cfg_camp_id=101,name="黄金谷",type=1,desc="",idx=1,last_order=18,require_officium=0,battle_background=1,battle_thumb=1,cfg_army_data = {10101,10102,10103,10104,10105,10106,10107,10108,10109,10110,10111,10112,10113,10114,10115,10116,10117,10118,},},[102]={cfg_camp_id=102,name="乱石林",type=1,desc="",idx=2,last_order=20,require_officium=0,battle_background=1,battle_thumb=2,cfg_army_data = {10201,10202,10203,10204,10205,10206,10207,10208,10209,10210,10211,10212,10213,10214,10215,10216,10217,10218,10219,10220,},},[103]={cfg_camp_id=103,name="象牙小镇",type=1,desc="",idx=3,last_order=20,require_officium=0,battle_background=1,battle_thumb=3,cfg_army_data = {10301,10302,10303,10304,10305,10306,10307,10308,10309,10310,10311,10312,10313,10314,10315,10316,10317,10318,10319,10320,},},[104]={cfg_camp_id=104,name="冰川怨地",type=1,desc="",idx=4,last_order=30,require_officium=0,battle_background=2,battle_thumb=4,cfg_army_data = {10401,10402,10403,10404,10405,10406,10407,10408,10409,10410,10411,10412,10413,10414,10415,10416,10417,10418,10419,10420,10421,10422,10423,10424,10425,10426,10427,10428,10429,10430,},},[105]={cfg_camp_id=105,name="红枫坡",type=1,desc="",idx=5,last_order=30,require_officium=0,battle_background=2,battle_thumb=5,cfg_army_data = {10501,10502,10503,10504,10505,10506,10507,10508,10509,10510,10511,10512,10513,10514,10515,10516,10517,10518,10519,10520,10521,10522,10523,10524,10525,10526,10527,10528,10529,10530,},},[106]={cfg_camp_id=106,name="息风堡",type=1,desc="",idx=6,last_order=30,require_officium=0,battle_background=2,battle_thumb=6,cfg_army_data = {10601,10602,10603,10604,10605,10606,10607,10608,10609,10610,10611,10612,10613,10614,10615,10616,10617,10618,10619,10620,10621,10622,10623,10624,10625,10626,10627,10628,10629,10630,},},[107]={cfg_camp_id=107,name="熔岩洞",type=1,desc="",idx=7,last_order=20,require_officium=0,battle_background=3,battle_thumb=7,cfg_army_data = {10701,10702,10703,10704,10705,10706,10707,10708,10709,10710,10711,10712,10713,10714,10715,10716,10717,10718,10719,10720,},},[108]={cfg_camp_id=108,name="幽冥地界",type=1,desc="",idx=8,last_order=20,require_officium=0,battle_background=4,battle_thumb=8,cfg_army_data = {10801,10802,10803,10804,10805,10806,10807,10808,10809,10810,10811,10812,10813,10814,10815,10816,10817,10818,10819,10820,},},[109]={cfg_camp_id=109,name="艾泽荒原",type=1,desc="",idx=9,last_order=20,require_officium=0,battle_background=3,battle_thumb=9,cfg_army_data = {10901,10902,10903,10904,10905,10906,10907,10908,10909,10910,10911,10912,10913,10914,10915,10916,10917,10918,10919,10920,},},[110]={cfg_camp_id=110,name="哀嚎山林",type=1,desc="",idx=10,last_order=20,require_officium=0,battle_background=3,battle_thumb=10,cfg_army_data = {11001,11002,11003,11004,11005,11006,11007,11008,11009,11010,11011,11012,11013,11014,11015,11016,11017,11018,11019,11020,},},[201]={cfg_camp_id=201,name="象牙小镇",type=2,desc="",idx=1,last_order=10,require_officium=30,battle_background=4,battle_thumb=3,cfg_army_data = {20101,20102,20103,20104,20105,20106,20107,20108,20109,20110,},},[202]={cfg_camp_id=202,name="冰川怨地",type=2,desc="",idx=2,last_order=10,require_officium=40,battle_background=4,battle_thumb=4,cfg_army_data = {20201,20202,20203,20204,20205,20206,20207,20208,20209,20210,},},[203]={cfg_camp_id=203,name="红枫坡",type=2,desc="",idx=3,last_order=10,require_officium=50,battle_background=1,battle_thumb=5,cfg_army_data = {20301,20302,20303,20304,20305,20306,20307,20308,20309,20310,},},[204]={cfg_camp_id=204,name="息风堡",type=2,desc="",idx=4,last_order=10,require_officium=60,battle_background=2,battle_thumb=6,cfg_army_data = {20401,20402,20403,20404,20405,20406,20407,20408,20409,20410,},},[205]={cfg_camp_id=205,name="熔岩洞",type=2,desc="",idx=5,last_order=10,require_officium=70,battle_background=1,battle_thumb=7,cfg_army_data = {20501,20502,20503,20504,20505,20506,20507,20508,20509,20510,},},[206]={cfg_camp_id=206,name="幽冥地界",type=2,desc="",idx=6,last_order=10,require_officium=80,battle_background=2,battle_thumb=8,cfg_army_data = {20601,20602,20603,20604,20605,20606,20607,20608,20609,20610,},},[301]={cfg_camp_id=301,name="雾之鸿沟",type=3,desc="",idx=1,last_order=10,require_officium=30,battle_background=3,battle_thumb=11,cfg_army_data = {30101,30102,30103,30104,30105,30106,30107,30108,30109,30110,},},[302]={cfg_camp_id=302,name="苍穹中庭",type=3,desc="",idx=2,last_order=10,require_officium=40,battle_background=1,battle_thumb=9,cfg_army_data = {30201,30202,30203,30204,30205,30206,30207,30208,30209,30210,},},[303]={cfg_camp_id=303,name="巨人血溺",type=3,desc="",idx=3,last_order=10,require_officium=50,battle_background=2,battle_thumb=14,cfg_army_data = {30301,30302,30303,30304,30305,30306,30307,30308,30309,30310,},},[304]={cfg_camp_id=304,name="耀世辉创",type=3,desc="",idx=4,last_order=10,require_officium=60,battle_background=3,battle_thumb=5,cfg_army_data = {30401,30402,30403,30404,30405,30406,30407,30408,30409,30410,},},[305]={cfg_camp_id=305,name="智慧寒泉",type=3,desc="",idx=5,last_order=10,require_officium=70,battle_background=4,battle_thumb=3,cfg_army_data = {30501,30502,30503,30504,30505,30506,30507,30508,30509,30510,},},[306]={cfg_camp_id=306,name="英灵神殿",type=3,desc="",idx=6,last_order=10,require_officium=80,battle_background=3,battle_thumb=13,cfg_army_data = {30601,30602,30603,30604,30605,30606,30607,30608,30609,30610,},}}
cfg_legion_tech = {{name="众志成城",desc="增加家族人数上限。",require_level=0,effect_base=30.000,effect_level=1.000,contribute_base=50000,contribute_level=100000,},{name="有福同享",desc="增加灵泉阁征收银币的收入。",require_level=5,effect_base=0.000,effect_level=0.001,contribute_base=15000,contribute_level=40000,},{name="赏金猎人",desc="增加佣兵任务的固定收入。",require_level=15,effect_base=0.000,effect_level=0.010,contribute_base=20000,contribute_level=50000,},{name="灵魔圣水",desc="增加灵果的产量。",require_level=30,effect_base=0.000,effect_level=0.002,contribute_base=15000,contribute_level=40000,},{name="群策群力",desc="提高可贡献给家族建设银币上限。",require_level=50,effect_base=0.000,effect_level=0.002,contribute_base=30000,contribute_level=60000,},{name="诸神威慑",desc="增加神力的获得量。",require_level=60,effect_base=0.000,effect_level=0.005,contribute_base=40000,contribute_level=80000,},}
total_reward_cfg = {{100,{{id=42200001,count=2},{id=13030001,count=5},{id=0,count=500000},{id=14,count=20},}},{500,{{id=13030001,count=10},{id=42200002,count=2},{id=0,count=1000000},{id=14,count=40},}},{1000,{{id=13030001,count=20},{id=42200002,count=2},{id=14,count=60},{id=0,count=1500000},}},{2000,{{id=13030001,count=30},{id=42200002,count=3},{id=14,count=80},{id=0,count=2000000},}},{5000,{{id=13030001,count=50},{id=42200003,count=2},{id=14,count=120},{id=0,count=3000000},}},{10000,{{id=13030001,count=70},{id=42200003,count=3},{id=14,count=160},{id=0,count=4000000},}},{20000,{{id=13030001,count=100},{id=42200004,count=2},{id=14,count=200},{id=0,count=8000000},}},{50000,{{id=13030001,count=150},{id=42200004,count=4},{id=14,count=320},{id=0,count=8000000},}},{100000,{{id=13030001,count=200},{id=42200005,count=5},{id=14,count=400},{id=0,count=10000000},}},{500000,{{id=13030001,count=500},{id=42200006,count=6},{id=14,count=1000},{id=0,count=30000000},}},}
cfg_event = {[101]={name="赫拉之祝福",rank=1,category=1,type=1,value=12800,},[102]={name="赫拉之祝福",rank=1,category=1,type=1,value=12000,},[103]={name="赫拉之祝福",rank=1,category=1,type=1,value=14400,},[104]={name="赫拉之祝福",rank=1,category=1,type=1,value=16800,},[105]={name="赫拉之祝福",rank=2,category=1,type=1,value=25200,},[106]={name="赫拉之祝福",rank=2,category=1,type=1,value=31200,},[107]={name="赫拉之祝福",rank=2,category=1,type=1,value=37200,},[108]={name="赫拉之祝福",rank=2,category=1,type=1,value=43200,},[109]={name="赫拉之祝福",rank=3,category=1,type=1,value=55200,},[110]={name="赫拉之祝福",rank=3,category=1,type=1,value=67200,},[111]={name="赫拉之祝福",rank=3,category=1,type=1,value=79200,},[112]={name="赫拉之祝福",rank=3,category=1,type=1,value=91200,},[301]={name="赫拉之祝福",rank=1,category=1,type=3,value=4,},[302]={name="赫拉之祝福",rank=2,category=1,type=3,value=5,},[303]={name="赫拉之祝福",rank=3,category=1,type=3,value=6,},[401]={name="赫拉之祝福",rank=1,category=1,type=4,value=12100001,},[402]={name="赫拉之祝福",rank=2,category=1,type=4,value=12100002,},[403]={name="赫拉之祝福",rank=3,category=1,type=4,value=12100003,},[501]={name="赫拉之祝福",rank=1,category=1,type=5,value=4,},[502]={name="赫拉之祝福",rank=2,category=1,type=5,value=8,},[503]={name="赫拉之祝福",rank=3,category=1,type=5,value=16,},}
cfg_task_daily_data = {[300001]={cfg_task_id=300001,name="灵泉阁里收收钱",desc="去灵泉阁征收",aim="灵泉阁征收1次",quality=1,complete_type=1,complete_value=1,reward_prestige=160,reward_copper=2400,reward_gold=0,reward_jump_wand=1,reward_item=0,reward_item_amount=0,icon=4},[300002]={cfg_task_id=300002,name="灵泉阁里收收钱",desc="去灵泉阁征收",aim="灵泉阁征收2次",quality=1,complete_type=1,complete_value=2,reward_prestige=320,reward_copper=4800,reward_gold=0,reward_jump_wand=2,reward_item=0,reward_item_amount=0,icon=4},[300003]={cfg_task_id=300003,name="灵泉阁里收收钱",desc="去灵泉阁征收",aim="灵泉阁征收3次",quality=1,complete_type=1,complete_value=3,reward_prestige=480,reward_copper=7200,reward_gold=0,reward_jump_wand=3,reward_item=0,reward_item_amount=0,icon=4},[300004]={cfg_task_id=300004,name="灵泉阁里收收钱",desc="去灵泉阁征收",aim="灵泉阁征收4次",quality=2,complete_type=1,complete_value=4,reward_prestige=640,reward_copper=9600,reward_gold=0,reward_jump_wand=4,reward_item=0,reward_item_amount=0,icon=4},[300005]={cfg_task_id=300005,name="灵泉阁里收收钱",desc="去灵泉阁征收",aim="灵泉阁征收5次",quality=2,complete_type=1,complete_value=5,reward_prestige=800,reward_copper=12000,reward_gold=0,reward_jump_wand=5,reward_item=0,reward_item_amount=0,icon=4},[300011]={cfg_task_id=300011,name="赚钱才是硬道理",desc="赚取银币",aim="收入1000银币",quality=1,complete_type=2,complete_value=1000,reward_prestige=160,reward_copper=4000,reward_gold=1,reward_jump_wand=1,reward_item=0,reward_item_amount=0,icon=4},[300012]={cfg_task_id=300012,name="赚钱才是硬道理",desc="赚取银币",aim="收入10000银币",quality=1,complete_type=2,complete_value=10000,reward_prestige=320,reward_copper=8000,reward_gold=2,reward_jump_wand=2,reward_item=0,reward_item_amount=0,icon=4},[300013]={cfg_task_id=300013,name="赚钱才是硬道理",desc="赚取银币",aim="收入15000银币",quality=1,complete_type=2,complete_value=15000,reward_prestige=480,reward_copper=12000,reward_gold=3,reward_jump_wand=3,reward_item=0,reward_item_amount=0,icon=4},[300014]={cfg_task_id=300014,name="赚钱才是硬道理",desc="赚取银币",aim="收入25000银币",quality=2,complete_type=2,complete_value=25000,reward_prestige=640,reward_copper=16000,reward_gold=4,reward_jump_wand=4,reward_item=0,reward_item_amount=0,icon=4},[300015]={cfg_task_id=300015,name="赚钱才是硬道理",desc="赚取银币",aim="收入50000银币",quality=2,complete_type=2,complete_value=50000,reward_prestige=800,reward_copper=20000,reward_gold=6,reward_jump_wand=5,reward_item=0,reward_item_amount=0,icon=4},[300021]={cfg_task_id=300021,name="佣兵的快乐生活",desc="进行佣兵任务",aim="佣兵任务1次",quality=1,complete_type=3,complete_value=1,reward_prestige=160,reward_copper=4800,reward_gold=0,reward_jump_wand=2,reward_item=0,reward_item_amount=0,icon=4},[300022]={cfg_task_id=300022,name="佣兵的快乐生活",desc="进行佣兵任务",aim="佣兵任务2次",quality=1,complete_type=3,complete_value=2,reward_prestige=320,reward_copper=9600,reward_gold=0,reward_jump_wand=4,reward_item=0,reward_item_amount=0,icon=4},[300023]={cfg_task_id=300023,name="佣兵的快乐生活",desc="进行佣兵任务",aim="佣兵任务3次",quality=1,complete_type=3,complete_value=3,reward_prestige=480,reward_copper=14400,reward_gold=0,reward_jump_wand=6,reward_item=0,reward_item_amount=0,icon=4},[300024]={cfg_task_id=300024,name="佣兵的快乐生活",desc="进行佣兵任务",aim="佣兵任务4次",quality=1,complete_type=3,complete_value=4,reward_prestige=640,reward_copper=19200,reward_gold=0,reward_jump_wand=8,reward_item=0,reward_item_amount=0,icon=4},[300025]={cfg_task_id=300025,name="佣兵的快乐生活",desc="进行佣兵任务",aim="佣兵任务5次",quality=2,complete_type=3,complete_value=5,reward_prestige=800,reward_copper=24000,reward_gold=0,reward_jump_wand=10,reward_item=0,reward_item_amount=0,icon=4},[300031]={cfg_task_id=300031,name="用心祭炼得符文",desc="祭炼并获得符文",aim="祭炼1个符文",quality=1,complete_type=4,complete_value=1,reward_prestige=160,reward_copper=16000,reward_gold=0,reward_jump_wand=0,reward_item=0,reward_item_amount=0,icon=6},[300032]={cfg_task_id=300032,name="用心祭炼得符文",desc="祭炼并获得符文",aim="祭炼2个符文",quality=2,complete_type=4,complete_value=2,reward_prestige=320,reward_copper=40000,reward_gold=0,reward_jump_wand=0,reward_item=0,reward_item_amount=0,icon=6},[300033]={cfg_task_id=300033,name="用心祭炼得符文",desc="祭炼并获得符文",aim="祭炼3个符文",quality=2,complete_type=4,complete_value=3,reward_prestige=480,reward_copper=64000,reward_gold=0,reward_jump_wand=0,reward_item=24308268,reward_item_amount=1,icon=6},[300034]={cfg_task_id=300034,name="用心祭炼得符文",desc="祭炼并获得符文",aim="祭炼4个符文",quality=3,complete_type=4,complete_value=4,reward_prestige=640,reward_copper=96000,reward_gold=0,reward_jump_wand=0,reward_item=24408530,reward_item_amount=1,icon=6},[300035]={cfg_task_id=300035,name="用心祭炼得符文",desc="祭炼并获得符文",aim="祭炼5个符文",quality=3,complete_type=4,complete_value=5,reward_prestige=800,reward_copper=128000,reward_gold=0,reward_jump_wand=0,reward_item=24408277,reward_item_amount=1,icon=6},[300047]={cfg_task_id=300047,name="竞技是一天的开始",desc="竞技场进行挑战",aim="挑战1次",quality=1,complete_type=5,complete_value=1,reward_prestige=160,reward_copper=2400,reward_gold=0,reward_jump_wand=1,reward_item=0,reward_item_amount=0,icon=1},[300048]={cfg_task_id=300048,name="竞技是一天的开始",desc="竞技场进行挑战",aim="挑战2次",quality=1,complete_type=5,complete_value=2,reward_prestige=320,reward_copper=4800,reward_gold=0,reward_jump_wand=2,reward_item=0,reward_item_amount=0,icon=1},[300049]={cfg_task_id=300049,name="竞技是一天的开始",desc="竞技场进行挑战",aim="挑战3次",quality=2,complete_type=5,complete_value=3,reward_prestige=480,reward_copper=7200,reward_gold=0,reward_jump_wand=3,reward_item=0,reward_item_amount=0,icon=1},[300050]={cfg_task_id=300050,name="竞技是一天的开始",desc="竞技场进行挑战",aim="挑战4次",quality=2,complete_type=5,complete_value=4,reward_prestige=640,reward_copper=9600,reward_gold=0,reward_jump_wand=4,reward_item=0,reward_item_amount=0,icon=1},[300051]={cfg_task_id=300051,name="竞技是一天的开始",desc="竞技场进行挑战",aim="挑战5次",quality=2,complete_type=5,complete_value=5,reward_prestige=800,reward_copper=12000,reward_gold=0,reward_jump_wand=5,reward_item=0,reward_item_amount=0,icon=1},[300077]={cfg_task_id=300077,name="适度用金有益发展",desc="使用金币次数",aim="使用金币1次",quality=1,complete_type=7,complete_value=1,reward_prestige=160,reward_copper=8000,reward_gold=0,reward_jump_wand=2,reward_item=0,reward_item_amount=0,icon=4},[300078]={cfg_task_id=300078,name="适度用金有益发展",desc="使用金币次数",aim="使用金币2次",quality=1,complete_type=7,complete_value=2,reward_prestige=320,reward_copper=16000,reward_gold=0,reward_jump_wand=4,reward_item=0,reward_item_amount=0,icon=4},[300079]={cfg_task_id=300079,name="适度用金有益发展",desc="使用金币次数",aim="使用金币3次",quality=2,complete_type=7,complete_value=3,reward_prestige=480,reward_copper=24000,reward_gold=0,reward_jump_wand=6,reward_item=0,reward_item_amount=0,icon=4},[300080]={cfg_task_id=300080,name="适度用金有益发展",desc="使用金币次数",aim="使用金币4次",quality=2,complete_type=7,complete_value=4,reward_prestige=640,reward_copper=32000,reward_gold=0,reward_jump_wand=8,reward_item=0,reward_item_amount=0,icon=4},[300081]={cfg_task_id=300081,name="适度用金有益发展",desc="使用金币次数",aim="使用金币5次",quality=2,complete_type=7,complete_value=5,reward_prestige=800,reward_copper=40000,reward_gold=0,reward_jump_wand=10,reward_item=0,reward_item_amount=0,icon=4},[300087]={cfg_task_id=300087,name="好宠配强装",desc="强化任意装备",aim="强化装备1次",quality=1,complete_type=8,complete_value=1,reward_prestige=160,reward_copper=4000,reward_gold=0,reward_jump_wand=1,reward_item=0,reward_item_amount=0,icon=3},[300088]={cfg_task_id=300088,name="好宠配强装",desc="强化任意装备",aim="强化装备2次",quality=1,complete_type=8,complete_value=2,reward_prestige=320,reward_copper=8000,reward_gold=0,reward_jump_wand=2,reward_item=0,reward_item_amount=0,icon=3},[300089]={cfg_task_id=300089,name="好宠配强装",desc="强化任意装备",aim="强化装备3次",quality=1,complete_type=8,complete_value=3,reward_prestige=480,reward_copper=12000,reward_gold=0,reward_jump_wand=3,reward_item=0,reward_item_amount=0,icon=3},[300090]={cfg_task_id=300090,name="好宠配强装",desc="强化任意装备",aim="强化装备4次",quality=2,complete_type=8,complete_value=4,reward_prestige=640,reward_copper=16000,reward_gold=0,reward_jump_wand=4,reward_item=0,reward_item_amount=0,icon=3},[300091]={cfg_task_id=300091,name="好宠配强装",desc="强化任意装备",aim="强化装备5次",quality=2,complete_type=8,complete_value=5,reward_prestige=800,reward_copper=20000,reward_gold=0,reward_jump_wand=5,reward_item=0,reward_item_amount=0,icon=3},[300097]={cfg_task_id=300097,name="勇士的历练",desc="击败冒险中任意敌人队伍",aim="击败冒险中2个部队",quality=1,complete_type=9,complete_value=2,reward_prestige=160,reward_copper=2400,reward_gold=0,reward_jump_wand=1,reward_item=0,reward_item_amount=0,icon=2},[300098]={cfg_task_id=300098,name="勇士的历练",desc="击败冒险中任意敌人队伍",aim="击败冒险中4个部队",quality=1,complete_type=9,complete_value=4,reward_prestige=320,reward_copper=4800,reward_gold=0,reward_jump_wand=2,reward_item=0,reward_item_amount=0,icon=2},[300099]={cfg_task_id=300099,name="勇士的历练",desc="击败冒险中任意敌人队伍",aim="击败冒险中6个部队",quality=2,complete_type=9,complete_value=6,reward_prestige=480,reward_copper=7200,reward_gold=0,reward_jump_wand=3,reward_item=0,reward_item_amount=0,icon=2},[300100]={cfg_task_id=300100,name="勇士的历练",desc="击败冒险中任意敌人队伍",aim="击败冒险中8个部队",quality=2,complete_type=9,complete_value=8,reward_prestige=640,reward_copper=9600,reward_gold=0,reward_jump_wand=4,reward_item=0,reward_item_amount=0,icon=2},[300101]={cfg_task_id=300101,name="勇士的历练",desc="击败冒险中任意敌人队伍",aim="击败冒险中10个部队",quality=3,complete_type=9,complete_value=10,reward_prestige=800,reward_copper=12000,reward_gold=0,reward_jump_wand=5,reward_item=0,reward_item_amount=0,icon=2},[300107]={cfg_task_id=300107,name="脱胎换骨",desc="对任意角色进行洗髓",aim="洗髓1次",quality=1,complete_type=10,complete_value=1,reward_prestige=160,reward_copper=4000,reward_gold=0,reward_jump_wand=1,reward_item=0,reward_item_amount=0,icon=1},[300108]={cfg_task_id=300108,name="脱胎换骨",desc="对任意角色进行洗髓",aim="洗髓2次",quality=1,complete_type=10,complete_value=2,reward_prestige=320,reward_copper=8000,reward_gold=0,reward_jump_wand=2,reward_item=0,reward_item_amount=0,icon=1},[300109]={cfg_task_id=300109,name="脱胎换骨",desc="对任意角色进行洗髓",aim="洗髓3次",quality=1,complete_type=10,complete_value=3,reward_prestige=480,reward_copper=12000,reward_gold=0,reward_jump_wand=3,reward_item=0,reward_item_amount=0,icon=1},[300110]={cfg_task_id=300110,name="脱胎换骨",desc="对任意角色进行洗髓",aim="洗髓4次",quality=2,complete_type=10,complete_value=4,reward_prestige=640,reward_copper=16000,reward_gold=0,reward_jump_wand=4,reward_item=0,reward_item_amount=0,icon=1},[300111]={cfg_task_id=300111,name="脱胎换骨",desc="对任意角色进行洗髓",aim="洗髓5次",quality=2,complete_type=10,complete_value=5,reward_prestige=800,reward_copper=20000,reward_gold=0,reward_jump_wand=5,reward_item=0,reward_item_amount=0,icon=1},[300122]={cfg_task_id=300122,name="做一个勤恳的人",desc="灵果园收获灵果",aim="收获灵果1次",quality=1,complete_type=12,complete_value=1,reward_prestige=160,reward_copper=4000,reward_gold=0,reward_jump_wand=2,reward_item=0,reward_item_amount=0,icon=2},[300123]={cfg_task_id=300123,name="做一个勤恳的人",desc="灵果园收获灵果",aim="收获灵果2次",quality=1,complete_type=12,complete_value=2,reward_prestige=320,reward_copper=8000,reward_gold=0,reward_jump_wand=4,reward_item=0,reward_item_amount=0,icon=2},[300124]={cfg_task_id=300124,name="做一个勤恳的人",desc="灵果园收获灵果",aim="收获灵果3次",quality=2,complete_type=12,complete_value=3,reward_prestige=480,reward_copper=12000,reward_gold=0,reward_jump_wand=6,reward_item=0,reward_item_amount=0,icon=2},[300125]={cfg_task_id=300125,name="做一个勤恳的人",desc="灵果园收获灵果",aim="收获灵果4次",quality=2,complete_type=12,complete_value=4,reward_prestige=640,reward_copper=16000,reward_gold=0,reward_jump_wand=8,reward_item=0,reward_item_amount=0,icon=2},[300126]={cfg_task_id=300126,name="做一个勤恳的人",desc="灵果园收获灵果",aim="收获灵果5次",quality=3,complete_type=12,complete_value=5,reward_prestige=800,reward_copper=20000,reward_gold=0,reward_jump_wand=10,reward_item=0,reward_item_amount=0,icon=2}}


---dailyActivity

WEEK_ACTIVITY = {"周一","周二","周三","周四","周五","周六","周日"}
ACTIVITY_TIME = "活动时间："
ACTIVITY_NOTS = "尚未开启"

---juntuanbattle--



-----日常任务-------
TASK_C = "，你已经完成了"
DAILY_TASK_DES = "一、悬赏任务分为白、绿、蓝、橙四种不同等级。\n二、每天可免费完成10个悬赏任务，也可用金币额外增加次数。 \n三、每次只可接一个悬赏任务，接受后可放弃，但仍计算在总次数内，每日凌晨重置可完成的次数。 \n四、任务免费刷新有一小时的冷却时间。 "
TASK_SHENGWANG = "神力："
TASK_TUFEI = "经验丹："
TASK_WUPIN = "物品："
TASK_REFRSH = "刷新时间："
TASK_SHENG = "今日剩余次数："
TASK_ADD = "金币增加5次日常任务？"
TASK_R = "是否花费10金币刷新日常任务？"
TASK_T = "是否放弃该任务？"
TASK_A = "增加次数成功"
----事务日誌--- 
TRANS_LOG_DES = 
{
	"你还有很多事情沒有做哦。",
	"加油，金光闪闪的宝箱在等著你哦。",
	"再接再厉，让我们一起活跃吧。"
}
TRANS_HUO = "今日活跃度："
TRANS_HUODU = "活跃度"
TRANS_SUC = "领取成功"
TRANS_REWARD = {
	"使用后获得朗姆酒*2、魔典*2",
	"使用后获得5万银币、小行星牌*3、朗姆酒*2、魔典*3",
	"使用后获得10万银币、行星牌*3、朗姆酒*3、魔典*3",
	"使用后获得15万银币、恒星牌*3、朗姆酒*3、魔典*3",
}



---九龍吐珠--
NINE_FUCK = "，需神位28以上。"


NINE_C1 = "10金币/1次"
NINE_C2 = "100金币/10次"
NINE_C3 = "500金币/50次"

NINE_S1 = "----1次祈福成功----"
NINE_S2 = "----10次祈福成功----"
NINE_S3 = "----50次祈福成功----"

---friend--
ADD_FRIEND_SUCCESS = "添加好友成功"
DEL_FRIEND_SUCCESS = "刪除好友成功"
---system
LOGIN_OUT = "亲，你确定要注销游戏？"
--chat---
WORLD_TXT = "世界"
NATION_TXT = "阵营"
GONGGAO_TXT = "公告"
JUNTUAN_TXT = "家族"
ZHIDAOYUAN = "指导员"

--cave
CAVE_COMSUME1 = "今日免费进入次数已经用完，是否花费"
CAVE_COMSUME2 = "金币再次进入?"
CAVE_ATTITION = "1.每日免费探险次数5次，VIP用户可以使用金币额外增加次数。\n2.进入众神墓地后，退出或者刷新页面，次数不会恢复。\n3.各NPC触发的事件效果请查询官网介紹。"


--tavern
TAVERN_RESULT1 = "宠物店的宠物都去玩诸神Q传了，可点击刷新按钮请他们回來。"

RECUIT = "驯服"
CHANGZHU = "常驻神宠"
AUTOREFRESH = "自动刷新"
REFRESHNOW = "立即刷新"
REFRESH_SUCCESS = "刷新成功，获得爱心值："
EXCHANGE = "兑换"
CONGRA_HERO = "恭喜你获得"
MING_WANG = "爱心值："
XUQIU = "需求"

--public
ZHENG_SHOU = "征收"
LEI_TAI = "竞技场"
DONG_TIAN_FU_DI = "众神墓地"
FU_BEN = "副本"

GAIN_REWARD = "可获得以下奖励"

ENTER = "进入"
SANDAN = "扫荡"
QUIT =  "退出"
OKBTN = "确认"
CLOSEBTN = "关闭"
--zhengShou Panel Data

ZS_GOLD = "金币："
ZS_SLIVE = "银币："
ZS_LEN_QUE_TIME = "冷却时间："
ZS_BTN = "征收"
QXZS_BTN = "强行征收"
CHOOSE_BTN = "选择"
CONSUME = "花费"
THE_GOLD = "两金币"
THE_SLIVE = "银币"
ZS_GAIN = "征收成功，"
ADD_ZS = "增加征收次数"
ADD_CI = "次"
ZS_E_WAI = "额外获得"
ZS_CD = "征收CD减少"
ZS_MINUTE = "分钟"
LQ_CONSUME1 = "是否花费"
LQ_CONSUME2 = "金币将冷却时间设为0？"
LQ_CONSUME3 = "金币请新的宠物到宠物店游玩？"
--竞技场panel data
DAILY_CURRENT_RANK = "当前排名："
DAILY_RANK = "排名:"
DAILY_CURRENT_RANK_REWARD = "当前排名奖励："

BENLUN_TIME = "本轮剩余时间："
DAILY_TODAY_RANK = "今日排名："
DAILY_TOTAL_POINT = "积分："
LEITAI_GAIN = "领取"

LEITAI_VICTORY = "胜利次数："
LEITAI_LIAN_SHENG = "连胜场数："
LEITAI_WINNING = "胜率："
LEITAI_FAIL = "失败次数："
DAILY_LEITAI_UPDATE = "刷新时间："
LEITAI_SHENG_YU_TIMES = "今日剩余免费次数："
LEITAI_COMBAT_LENGQUE = "战斗冷却："

DAILY_GUANG_JIE = "神位："

JIFENG_MALL = "积分商城"

LEITEI_UPDATE = "刷新对手"
LEITEI_UPDATE_TXT = "是否花费5金币來刷新对手？"
LEITEI_GAIN_SUCCESS = "领取奖励成功"
LEITEI_ZB = "你挑战"
LEITEI_SUCCESS = "成功"
LEITEI_FAILED = "失败"

LEITEI_FREE1 = "免费次数用完，是否花费"
LEITEI_FREE2 = "金币打竞技场？"

--众神墓地
QUIT_DONG = "离开众神墓地以后，本次探索将会结束，是否确定离开？"
CAVE_TXT = "1.每日免费探险次数5次，VIP用户可以使用金币额外增加次数。\n2.进入众神墓地后，退出或者刷新页面，次数不会恢复。\n3.各NPC触发的事件效果请查询官网介紹。"		

--fuben

---副本战斗选择data


--saodan
SAODAN_R1 = "扫荡3次，消耗30分钟"
SAODAN_R2 = "扫荡5次，消耗50分钟"
SAODAN_R3 = "扫荡18次，消耗180分钟"
SAODAN_BTN = "开始扫荡"
FAST_SAO_BTN = "快速扫荡"
CANCEL_SAO_BTN = "取消扫荡"
SHENG_SAO_TIME = "剩余扫荡时间"
FUBEN_SAODAN = "副本扫荡中"
CANCEL_SAODAN_TX = "是否取消进行中的扫荡？"
FAST_SAODAN_TX = "是否花费30金币将冷却时间设为0？"

----plant
PLANT_PANEL = "种植"
GAIN_BTN = "收获"

GAIN_PLANT = "收获灵果："

GAIN_TXT = "1.神域中开启耕地可种植天果，地果，神果三种灵果。\n2.每次收获天果时可以获得1金币。\n3.仓库內的灵果可补充到生命池，仓库容量隨神位等级提升而增加。"

----------------战役
BATTLE_BTN = "战役"

----------------战役战斗选择data

ATTACK_BTN = "进攻"
GONGLUE_BTN = "攻略"
BUZHEN_BTN = "布阵"
FIRST_KILL = "首次击杀者："
ARMY_LEVEL = "敌军等级："
BATTLE_REWARD ="战斗奖励："
JUN_GONG_TX = "战功"
DROD_DOWN_WOOD = "掉落物品："
--[[
公共方法
--]]

--表new方法 将为表創建一个新表
function new(s)
	local o = {}
	setmetatable(o, s)
	s.__index = s
	return o
end

--[[
單选按钮点击操作

傳过來單选按钮表 和 被按下的按钮

将所有按钮組中的按钮彈起将 按下的按钮设置为按下
--]]
public_toggleRadioBtn = function(btns, btn)
	for i = 1 , table.getn(btns) do
		btns[i]:toggled(false)
	end
	btn:toggled(true)
end

--[[
返回被按下的單选按钮
--]]
public_getToggleRadioBtn = function(btns)
	for i = 1 , table.getn(btns) do
		if btns[i]:isToggled() then
			return i
		end
	end
	return 0
end

function nothing()
end

function opFailedCB(s)
	closeWait()
end

function lua_string_split(str, split_char)
	local sub_str_tab = {};
	while (true) do
		local pos = string.find(str, split_char);
		if (not pos) then
			sub_str_tab[#sub_str_tab + 1] = str;
			break;
		end
		local sub_str = string.sub(str, 1, pos - 1);
		sub_str_tab[#sub_str_tab + 1] = sub_str;
		str = string.sub(str, pos + 1, #str);
	end
	return sub_str_tab;
end

function lua_string_replace(str, char, replace_char)
	local str_table = lua_string_split(str, split_char)
	local str = ""
	for i =1 ,table.getn(str_table)-1 do
		str= str..str_table..replace_char
	end
	return
end

--[[
randomBool
]]--
public_randomBool = function(max)
	if max == nil then
		max = 1
	end
	return math.random(0,max) == 0
end

public_setAlignForParent = function(label,parent,align,labelHeight)
	local pos,ap

	if align == "center" then
		pos = CCPoint(parent:getContentSize().width/2,parent:getContentSize().height - labelHeight)
		ap = CCPoint(0.5, 1)
	elseif align == "left" then
		pos = CCPoint(40,parent:getContentSize().height - labelHeight)
		ap = CCPoint(0, 1)
	else
		pos = CCPoint(parent:getContentSize().width,parent:getContentSize().height - labelHeight)
		ap = CCPoint(1, 1)
	end

	label:setAnchorPoint(ap)
	label:setPosition(pos)
end

--返回价格字符串
public_chageShowTypeForMoney = function(mon,nomoney,max)
	local money = 0
	if mon ~= nil then
		money = mon
	end
	local m = 60000
	if max ~= nil then
		m = max
	end
	if tonumber(money) > m then
		money = math.floor(money/10000)
		money = tostring(money).."万"
	end

	if nomoney ~= nil and nomoney then
		return money
	else
		return money.."银币"
	end
end
public_Wan_Exp = function(exp)
	local m = 69999
	if tonumber(exp) > m then
		exp = math.floor(exp/10000)
		exp = tostring(exp).."万"
	else
		return math.floor(exp)
	end
	return exp
end

local ItemAttributeTag = {"体力","物攻","物防","法攻","法防","速度","命中","闪避","破击","格挡","暴击","韧性"}
public_returnEquipAttributeDesc = function(item)
	local itemAttributeDesc = {}
	local itemAttributeTag = {}
	local itemAttributeStar = {}
	local count = 1

	if item.ability_type ~= 0 then
		itemAttributeDesc[count] = item.ability
		itemAttributeStar[count] = item.ability_grow
		itemAttributeTag[count] = ItemAttributeTag[item.ability_type]
		count = count + 1
	end

	if item.ability_type_2 ~= 0 then
		itemAttributeDesc[count] = item.ability_2
		itemAttributeStar[count] = item.ability_grow_2
		itemAttributeTag[count] = ItemAttributeTag[item.ability_type_2]
		count = count + 1
	end
	
	return itemAttributeDesc,itemAttributeTag,itemAttributeStar
end

public_returnBaoshiAttribute = function(item)
	return item.ability,ItemAttributeTag[item.ability_type]
end

public_ternaryOperation = function(condition,trueReturn,falseReturn)
	if condition  then
		return trueReturn
	else
		return falseReturn
	end
end

public_sellprice = function(item)
	local sum = 0
	for i=1,item.star do
		sum = sum + forgeMoney(item.forge_price,i)
	end
	sum = sum + item.sell_price
	
	return math.floor(sum * 0.5)
end

--强化等级 初始强化价格 折扣
forgeMoney = function(forge_price,star)
	local levelSectionParam = 0
	local levelSectionValue = 0
	local levelParam = 0
	
	if star >= 1 and star <= 20 then
		levelSectionParam = 1
		levelSectionValue = 0
		levelParam = 0
	elseif star >= 21 and star <= 30 then
		levelSectionParam = 2
		levelSectionValue = 20
		levelParam = 20
	elseif star >= 31 and star <= 40 then
		levelSectionParam = 3
		levelSectionValue = 40
		levelParam = 30
	elseif star >= 41 and star <= 50 then
		levelSectionParam = 5
		levelSectionValue = 70
		levelParam = 40
	elseif star >= 51 and star <= 60 then
		levelSectionParam = 7
		levelSectionValue = 120
		levelParam = 50
	elseif star >= 61 and star <= 70 then
		levelSectionParam = 10
		levelSectionValue = 190
		levelParam = 60
	elseif star >= 71 and star <= 80 then
		levelSectionParam = 13
		levelSectionValue = 290
		levelParam = 70
	elseif star >= 81 and star <= 90 then
		levelSectionParam = 16
		levelSectionValue = 420
		levelParam = 80
	elseif star >= 91 and star <= 100 then
		levelSectionParam = 20
		levelSectionValue = 580
		levelParam = 90
	else
		levelSectionParam = 24;
		levelSectionValue = 600
		levelParam = 100
	end
	--装备升级费用=强化基础值*{（强化等级-等级参数）*等级段参数+等级段数值}
	return forge_price * ((star - levelParam) * levelSectionParam + levelSectionValue)
end

alert = function(info,ccp)
	local alertPanel = new(SimpleTipPanel)
	alertPanel:create(info,ccc3(255,204,153),0)
end

--cfg选项：fontSize,onClickOK,clickParams,btnImg
alertOK = function(info,cfg)
	cfg = cfg==nil and {} or cfg
	cfg.clickOK = cfg.clickOK or nothing
	cfg.clickParams = cfg.clickParams or {}
	cfg.btnImg = cfg.btnImg or "UI/public/btn_ok.png"
	
	local dialogCfg = new(basicDialogCfg)
	dialogCfg.msg = info
	dialogCfg.msgAlign = "center"
	dialogCfg.dialogType = 5
	dialogCfg.msgSize = cfg.fontSize

	local bs = new(ButtonScale)
	bs:create(cfg.btnImg,1.2,ccc3(255,255,255))

	local btns = {}
	btns[1] = bs.btn
	btns[1].action = cfg.clickOK
	btns[1].param = cfg.clickParams
	dialogCfg.btns = btns
	
	new(Dialog):create(dialogCfg)
end
				
--
ShowInfoDialog = function(info)
	local dialogCfg = new(basicDialogCfg)
	dialogCfg.msg = info
	dialogCfg.title = ""
	dialogCfg.closeBtn = true
	dialogCfg.dialogType = 5
	dialogCfg.dialogMoveType = false

	new(Dialog):create(dialogCfg)
end

ShowReward = function(info, callback)
	local dialogCfg = new(basicDialogCfg)
	dialogCfg.msg = info
	dialogCfg.size = CCSize(544,490)
	dialogCfg.title = ""
	dialogCfg.closeBtn = true
	dialogCfg.bg="UI/gift/get_reward.png"
	dialogCfg.dialogType = 66
	dialogCfg.dialogMoveType = false
	dialogCfg.closeFunc = callback
	
	local d = new(Dialog)
	d:create(dialogCfg)
	return d
end

ShowInfo = ShowInfoDialog

ShowErrorInfoDialog = function(id,info)
	--关卡扫荡中
	if id == 10010 then
		viewSweeping()
		return
	end

	--关卡扫荡中
	if id == 457 then
		ViewRaidSweeping()
		return
	end
	
	local msg = ""
	local desc = ERROR_CODE_DESC[id]
	if desc == nil or id == 99 or id == 98 then
		return
	else
		if info == nil then
			msg = desc
		else
			msg = info
		end
	end
	ShowInfo(msg)
end

--计算缩放比例
caltScale = function(designSize)
	local scaleX = WINSIZE.width/designSize.width
	local scaleY = WINSIZE.height/designSize.height
	local scale = scaleX > scaleY and scaleX or scaleY
	return scale
end

 shortofgold=function()    
    local createBtns = function()
		local btns = {}
		local bs = new(ButtonScale)
		bs:create("UI/public/ldjb.png",1.2)
		btns[1] = bs.btn
		btns[1].action = globleShowVipPanel --sendRequest
			
		local bs = new(ButtonScale)
		bs:create("UI/public/xczs.png",1.2)
		btns[2] = bs.btn
		btns[2].action = nothing
		return btns
       end
   
       local dialogCfg = new(basicDialogCfg)
	    dialogCfg.bg="UI/public/tankuang_bg.png"
		dialogCfg.msg ="金币不足"
		dialogCfg.dialogType=2
		dialogCfg.btns = createBtns()
		new(Dialog):create(dialogCfg)
end
getShotNumber = function(num)
	if num >= 10000 and num < 100000000 then
		return tostring(math.floor(num/10000))..units[1]
	elseif num >= 100000000 then
		return tostring(math.floor (num/100000000))..units[2]
	end
	return  tostring(math.floor (num))
end
getEXP_par = function()
	local level_prestige_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_level_prestige.json")
	local nowEXP = level_prestige_cfg:getByIndex(GloblePlayerData.officium-1):getByKey("prestige_need"):asInt()
	if GloblePlayerData.officium == 1 then
		return GloblePlayerData.prestige,nowEXP
	end
	if GloblePlayerData.officium == level_prestige_cfg:size() then
		return 100000,100000
	end
	local lastEXP = level_prestige_cfg:getByIndex(GloblePlayerData.officium-2):getByKey("prestige_need"):asInt()
	local MAX = nowEXP - lastEXP
	local plaerEXP = GloblePlayerData.prestige - lastEXP
	return plaerEXP,MAX

end
function getMAXPool()
	return GloblePlayerData.officium*9000+100000
end

function getWidgetCenter(wid)
	return CCPoint(wid:getContentSize().width/2,wid:getContentSize().height/2)
end

function getWinCenter(isScale)
	if isScale ~=nil and isScale then
		return CCPoint(WINSIZE.width / 2 / SCALEY, WINSIZE.height / 2 / SCALEY)
	end
	return CCPoint(WINSIZE.width/2,WINSIZE.height/2)
end

function multSize(size,scale)
	return CCSize(size.width * scale,size.height * scale)
end

function noRepeatData(t)
	local tab = {}
	for i = 1 , table.getn(t) do
		if tab[t[i]] == nil then
			tab[t[i]] = t[i]
		end
	end

	local res = {}
	for i, v in ipairs(tab) do
		table.insert(res,v)
	end
	return res
end

local radtodeg = 180/math.pi
local degtorad = math.pi/180
--两点
function AngleBetweenPoints(src,dst)
	return math.atan2(dst.y - src.y, dst.x - src.x) * radtodeg
end

--極坐标移动
function PolarProjection(org,dist,angle)
	return CCPoint(org.x + dist * math.cos(angle * degtorad),org.y + dist * math.sin(angle * degtorad))
end

--两点的
function Distance(loc1,loc2)
	local dx, dy
	dx = loc2.x - loc1.x
	dy = loc2.y - loc1.y
	return math.sqrt(dx*dx+dy*dy)
end

--两点的
function DistanceSquare(loc1,loc2)
	local dx, dy
	dx = loc2.x - loc1.x
	dy = loc2.y - loc1.y
	return dx*dx+dy*dy
end

function getItemEnable(item)
	if item.effect_type == 11 or
	item.effect_type == 10 or
	item.effect_type == 9 or
	(item.effect_type == 0 and item.type ~= 2) or
	(item.type == 5 and item.effect_type == 17) or
	(item.type == 3 and item.effect_type == 19)
	then
		return false
	else
		return true
	end
end
function getPageCount(count,pageSize)
	local pageCount = math.floor(count/pageSize)
	if count % pageSize ~= 0 then
		pageCount = pageCount+1
	end
	if pageCount<=0 then
		pageCount = 1
	end
	return pageCount
end
--根据文字，和字体大小计算label的实际宽度
function getlabelWidth(text,fontSize)
	return (string.len(text))*fontSize/3
end

function showInfo(text)
	local dtp = new(DialogTipPanel)
	dtp:create(text,ccc3(255,204,153),180)
	dtp.okBtn.m_nScriptClickedHandler = function()
		dtp:destroy()
	end
end

getLenQueTime = function(mtime)
	local hour = math.floor(mtime / 3600)
	local tempM = math.floor((mtime - hour*3600)/60)
	local seconds = (mtime % 3600)%60

	if hour == 0 then --------------
		if  tempM < 10 then
			if  seconds<10 then
				return "0"..tempM..":0"..seconds
			else
				return "0"..tempM..":"..seconds
			end
		else
			if  seconds<10 then
				return tempM..":0"..seconds
			else
				return tempM..":"..seconds
			end
		end
	elseif hour > 0 and hour < 10 then -----------
		if  tempM < 10 then
			if  seconds<10 then
				return "0"..hour..":0"..tempM..":0"..seconds
			else
				return "0"..hour..":0"..tempM..":"..seconds
			end
		else
			if  seconds<10 then
				return "0"..hour..":"..tempM..":0"..seconds
			else
				return "0"..hour..":"..tempM..":"..seconds
			end
		end
	else  ------------------
		if  tempM < 10 then
			if  seconds<10 then
				return hour..":0"..tempM..":0"..seconds
			else
				return hour..":0"..tempM..":"..seconds
			end
		else
			if  seconds<10 then
				return hour..":"..tempM..":0"..seconds
			else
				return hour..":"..tempM..":"..seconds
			end
		end
	end
end

updataHUDData = function()
	local HUD  = dbHUDLayer:shareHUD2Lua()
	if HUD ~= nil then  
		local x,y = getEXP_par()
		HUD:updatePlayerHUDData(getShotNumber(GloblePlayerData.exploit),
								getShotNumber(GloblePlayerData.gold),
								getShotNumber(GloblePlayerData.copper),
								"head/Round/head_round_"..GloblePlayerData.role_face ..".png",
								math.floor(GloblePlayerData.pool/getMAXPool()*100),
								math.floor(GloblePlayerData.action_point/300*100),
								math.floor(x/y*100),
								GloblePlayerData.vip_level
							)
		HUD:updatePlayerLevel(GloblePlayerData.officium)
		HUD:updateHudStep(GloblePlayerData.officium)
		
		if IN_BOSS_WAR_SCENE then
			HUD:setIsVisibleRightUp(false)
		end
	end
end

--检查阵型中是不是没有人
checkFormationIsEmpty = function()
	local formation = findFormationsById(GloblePlayerData.cur_formation)
	local noman = true
	for i=1,9 do
		if formation.pos[i] ~= 0 then
			local general = findGeneralByGeneralId(formation.pos[i])
			if general ~= 0 then
				noman = false
			end
		end
	end
	if noman then
		local createBtns = function(ccp)
			local btns = {}
			
			local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
			btns[1] = btn
			btns[1].action = globleShowZhenFaPanel
						
			local btn = dbUIButtonScale:buttonWithImage("UI/public/cancel_btn.png", 1, ccc3(125, 125, 125))
			btns[2] = btn
			btns[2].action = nothing
			return btns
		end
	
		local dialogCfg = new(basicDialogCfg)
		dialogCfg.bg = "UI/baoguoPanel/kuang.png"
		dialogCfg.msg = "阵型中没有宠物！去阵型看看"
		dialogCfg.msgSize = 24
		dialogCfg.dialogType = 5
		dialogCfg.btns = createBtns()
		new(Dialog):create(dialogCfg)
	end	
	return noman
end

removeUnusedTextures = function()
	--CCSpriteFrameCache:sharedSpriteFrameCache():removeUnusedSpriteFrames()
	--CCTextureCache:sharedTextureCache():removeUnusedTextures()
	
	--dumpCache()
end

dumpCache = function()
	CCTextureCache:sharedTextureCache():dumpCachedTextureInfo()
end

openJson = function(file)
	return GlobalCfgMgr:getCfgJsonRoot(file)
end

Log = function(msg)
	CCLuaLog("lua log: "..msg)
end
NetSys = NetSys:getInstance()
NetMgr = NetSys:getNetMgr()

ClientData = {
	request_code = ""
	,passport = ""
	,role_id = 0
	,role_name = ""
	,role_job = 0
	,fate_last_index = -1
	,officium = 0	-- 神位
	,vip_level = 0
	,nation = 0
	,fate_point = 0  -- 天運值强化机率
	,sdk = ""  -- 所接入SDK名称,如 umi,joy7,和android端中的JNIHelper配置对应
}

function clearClientData()
	ClientData.request_code = ""
	ClientData.passport = ""
	ClientData.role_name = ""
	ClientData.role_id = 0
	ClientData.role_job = 0
	ClientData.fate_last_index = 0
	ClientData.officium = 0
	ClientData.vip_level = 0
	ClientData.nation = 0
	ClientData.fate_point = 0
	ClientData.daily_online = nil
	ClientData.online_act_step = nil
	ClientData.total_charge = nil
	ClientData.army_sweeping_end = nil
	ClientData.raid_sweeping_end = nil
end

---福利礼包是否有新的可以领取
function GiftEnable(enable)
	local HUD = dbHUDLayer:shareHUD2Lua()
	if HUD then
		local btn = HUD:getChildByTag(411) --福利礼包按钮
		local node = HUD:getChildByTag(411):getChildByTag(417)
		node:setIsVisible(enable)
		if enable then
			local animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("availible")
			local action = CCAnimate:actionWithAnimation(animation)
			node:runAction(CCRepeatForever:actionWithAction(action))
		else
			node:stopAction()
		end
	end
end

function loginfuli()
	local HUD = dbHUDLayer:shareHUD2Lua()
	if HUD then
		local btn = HUD:getChildByTag(411) --福利礼包按钮
		local node = HUD:getChildByTag(411):getChildByTag(417)
		node:setIsVisible(true)
		btn:setIsVisible(false)
		local animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("availible")
		local action = CCAnimate:actionWithAnimation(animation)
		node:runAction(CCRepeatForever:actionWithAction(action))
	end
end

function serverOpenGiftVisible()
	local HUD = dbHUDLayer:shareHUD2Lua()
	if HUD then
		local btn = HUD:getChildByTag(421) --开服礼包按钮
		local node = HUD:getChildByTag(421):getChildByTag(422)
		node:setIsVisible(ClientData.server_open_gift)
		btn:setIsVisible(ClientData.server_open_gift)
		local animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("availible")
		local action = CCAnimate:actionWithAnimation(animation)
		node:runAction(CCRepeatForever:actionWithAction(action))
	end
end

function globleEnterHUD()
	--转职
	if (GloblePlayerData.officium >= 48 or GloblePlayerData.task_id == 130037)  and
	(GloblePlayerData.role_job == 51001 or GloblePlayerData.role_job == 61004
	or GloblePlayerData.role_job == 71007 or GloblePlayerData.role_job == 81010)
	then
		globleShowRoleTransferPanel()
	end
	
	--检查背包状态
	checkBaoguoCapacityEnough()
	
	GiftEnable(ClientData.gift_enable)
	
	WaitForGuaJi()
	loginfuli()
	SetNewManRewardVisible(ClientData.new_man_reward)
	
	updataHUDData()
	
	--serverOpenGiftVisible()	--新服礼包是否可见
	
	--DispatchEvent("zhaomu")
	--GlobleAddStepOfficuim(9)
	--StartUserGuide("formation")
	
	if ClientData.army_sweeping_end then
		DispatchEvent("army_sweeping")
		ClientData.army_sweeping_end = false
	end

	if ClientData.raid_sweeping_end then
		DispatchEvent("raid_sweeping")
		ClientData.raid_sweeping_end = false
	end	
end

function initGameData()
	GloblePanel = new(MainPanel)
	GloblePanel.curGenerals = GloblePanel.curGenerals==nil and 1 or GloblePanel.curGenerals
	GloblePanel.curItemPackbackPage = GloblePanel.curItemPackbackPage==nil and 1 or GloblePanel.curItemPackbackPage
	GloblePanel.curItemPackbackClass = GloblePanel.curItemPackbackClass==nil and 99 or GloblePanel.curItemPackbackClass
end

local function setClientData(s)
	initGameData()
	ClientData.request_code = s:getByKey("request_code"):asString()
	ClientData.role_id = s:getByKey("role_data"):getByKey("role_id"):asInt()
	ClientData.role_name = s:getByKey("role_data"):getByKey("name"):asString()
	ClientData.new_man_reward = s:getByKey("new_man_reward"):asBool()
	ClientData.gift_enable = s:getByKey("gift_enable"):asBool()
	ClientData.server_open_gift = s:getByKey("server_open_gift"):asBool()
	ClientData.officium = s:getByKey("role_data"):getByKey("officium"):asInt()

	ClientData.vip_level = s:getByKey("role_data"):getByKey("vip_level"):asInt()
	ClientData.nation = s:getByKey("role_data"):getByKey("nation"):asInt()
	
	--在线礼包数据
	--ClientData.daily_online = s:getByKey("daily_online"):asDouble()
	ClientData.online_act_step = s:getByKey("online_act_step"):asInt()
	ClientData.total_charge = s:getByKey("total_charge"):asFloat()--充值数
	ClientData.sdk = s:getByKey("sdk"):asString()

	initPlayerData()

	mappedPlayerRoleData(s:getByKey("role_data"))
	mappedPlayerGeneralData(s:getByKey("general_data"))
	mappedItemData(s:getByKey("item_data"))
	mappedPlayerFormations(s:getByKey("general_data"))
	getWunHunInfo(s:getByKey("soul_data"))

	GloblePlayerData.login_reward_step = s:getByKey("login_reward_step"):asInt()
	GloblePlayerData.login_days = s:getByKey("login_days"):asInt()
	GloblePlayerData.vitality	= s:getByKey("vitality"):asInt()	--进入游戏主界面时，增加活跃度和当前可领index的字段
	GloblePlayerData.vitality_idx = s:getByKey("vitality_idx"):asInt()		--
	GloblePlayerData.task_id = s:getByKey("task_data"):getByKey("mem_task_list"):getByIndex(0):getByKey("cfg_task_id"):asInt()
	GloblePlayerData.cultivate_count = s:getByKey("cultivate_count"):asInt()	--今天洗髓次数
	
	loginfuli()            --福利礼包，每次上线均增加光环特效，点击后消失
	
	local open_scene_list = s:getByKey("open_scene")
	for i=1,open_scene_list:size() do
		local sceneId = open_scene_list:getByIndex(i-1):asInt()
		GloblePlayerData.sceneMap[sceneId] = sceneId
	end
end

---有新的地图开启，世界地图上显示的
function GlobalOpenNewScene(s)
	local sceneId = s:getByKey("new_scene_id"):asInt()
	GloblePlayerData.sceneMap[sceneId] = sceneId
	GlobalUpdateMapData()
end

----- OPT_Enter -------------------------------------------------------------------------------
function GlobalLoginFinishCB(s)
	local isActive = s:getByKey("is_active"):asBool()
	if isActive then
		setClientData(s)
	end
end

----- OPT_Create -------------------------------------------------------------------------------
function GlobaCreateFinishCB(s)
	setClientData(s)
end

----- OPT_Fate ---------------------------------------------------------------------------------

----判断是否有补偿
local function checkCompensate(s)
	local function response(s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()
		if error_code==-1 then
			alert("封测补偿已经领取")
			GloblePlayerData.gold = s:getByKey("gold"):asInt()
			GloblePlayerData.vip_charge = s:getByKey("vip_charge"):asInt()
			GloblePlayerData.vip_level = s:getByKey("vip_level"):asInt()
			updataHUDData()
		else
			ShowErrorInfoDialog(error_code)
		end
	end
	local function request()
		showWaitDialog("")

		NetMgr:registOpLuaFinishedCB(Net.OPT_Compensate, response)
		NetMgr:registOpLuaFailedCB(Net.OPT_SoulAltar,opFailedCB)
	
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(Net.OPT_Compensate, cj)
	end

	local compensate_stat = s:getByKey("compensate_stat"):asInt()
	if compensate_stat==3 then -- 3 表示未领取
		local hud = dbHUDLayer:shareHUD2Lua()
		if hud then
			local tip = hud:getChildByTag(502)
			if tip == nil then
				CCSpriteFrameCache:sharedSpriteFrameCache():addSpriteFramesWithFile("UI/HUD/HUD.plist")
				local icon = CCSprite:spriteWithSpriteFrameName("UI/HUD/compensate.png")
				local btn = dbUIButtonScale:buttonWithImage(icon, 1.2, ccc3(125, 125, 125))
				btn:setPosition(CCPoint(WINSIZE.width/2, WINSIZE.height/2))
				btn:setAnchorPoint(CCPoint(0.5,0.5))
				btn.m_nScriptClickedHandler = function()
					local dtp = new(DialogTipPanel)
						dtp:create("确定要领取封测奖励吗",ccc3(255,204,153),180)
						dtp.okBtn.m_nScriptClickedHandler = function()
						request()
						dtp:destroy()
						hud:removeChildByTag(502)
					end
				end
				hud:addChild(btn,100000,502)
			end
		end	
	end
end

---显示系统公告,会在屏幕顶上显示滚动文字
local showAnnounce = function(s)
	local announce = s:getByKey("sys_announce")
	if announce == nil or announce:empty() then
		return
	end
	
	local hud = dbHUDLayer:shareHUD2Lua()
	if hud then
		local content = announce:getByKey("content"):asString()
		local startTime = announce:getByKey("startTime"):asInt()
		local endTime = announce:getByKey("endTime"):asInt()
		
		if content == "" or startTime==0 then
			return
		end

		local height = WINSIZE.height / 20
		
		local mask = CCSprite:spriteWithFile("UI/mask.png")
		mask:setPosition(CCPoint(WINSIZE.width/2, height))
		mask:setScaleX(WINSIZE.width / mask:getContentSize().width)
		mask:setScaleY(height / mask:getContentSize().height)
		mask:setAnchorPoint(CCPoint(0.5,1))

		local label = CCLabelTTF:labelWithString(content,SYSFONT[EQUIPMENT], 32)
		label:setPosition(CCPoint(WINSIZE.width-label:getContentSize().width/2,height/2))
		label:setColor(ccc3(255,255,255))
		
    	local announcePanel = dbUIPanel:panelWithSize(CCSize(WINSIZE.width,height))
    	announcePanel:setAnchorPoint(CCPoint(0.5, 1))
    	announcePanel:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height))
		announcePanel:addChild(mask)
		announcePanel:addChild(label)
		
		hud:addChild(announcePanel,1000,501);

		local move = CCMoveTo:actionWithDuration(15, CCPoint(-label:getContentSize().width/2, height/2))
		label:runAction(move)

		local function remove()
			announcePanel:removeFromParentAndCleanup(true)
			if AnnounceMoveHandler then
				CCScheduler:sharedScheduler():unscheduleScriptEntry(AnnounceMoveHandler)
				AnnounceMoveHandler = nil
			end
		end
		AnnounceMoveHandler = CCScheduler:sharedScheduler():scheduleScriptFunc(remove, 15, false)
	end
end

local checkLegionApply = function(s)
	local apply = s:getByKey("new_legion_apply"):asBool()
	local HUD = dbHUDLayer:shareHUD2Lua()
	if apply and HUD then
		HUD:showHudBtns()
		
		local btn = HUD:getChildByTag(309) --家族按钮
		local node = HUD:getChildByTag(309):getChildByTag(3091)
		node:setIsVisible(apply)
		
		if not node.running then
			local animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("availible")
			local action = CCAnimate:actionWithAnimation(animation)
			node:runAction(CCRepeatForever:actionWithAction(action))
			node.running = true
		end
	end
end


local newMail = nil		--避免心跳包中一直创建新邮件
local function opFateFinishCB(s)
	if s:getByKey("error_code"):asInt()~= -1 then
		return
	end
	
	ClientData.army_sweeping_end = s:getByKey("army_sweeping_end"):asBool()
	ClientData.raid_sweeping_end = s:getByKey("raid_sweeping_end"):asBool()
	ClientData.fate_point = s:getByKey("fate_point"):asInt()
	ClientData.fate_last_index = s:getByKey("last_index"):asInt()
	GlobalGetChatData(s)
	
	showAnnounce(s)
	
	updateRewardOnlineData(s)
	
	GloblePlayerData.action_point = s:getByKey("action_point"):asInt()
	GloblePlayerData.exploit = s:getByKey("exploit"):asInt()
	GloblePlayerData.pool = s:getByKey("pool"):asInt()
	GloblePlayerData.vip_charge = s:getByKey("vip_charge"):asInt()
	--更新General数据
	mappedPlayerGeneralData(s)

	if s:getByKey("gold"):asInt() ~= GloblePlayerData.gold then
		GloblePlayerData.gold = s:getByKey("gold"):asInt()
		updataHUDData()
	end
	
	if s:getByKey("copper"):asInt() ~= GloblePlayerData.copper then
		GloblePlayerData.copper = s:getByKey("copper"):asInt()
		updataHUDData()
	end
	
	if s:getByKey("vip_level"):asInt() ~= GloblePlayerData.vip_level then
		GloblePlayerData.vip_level = s:getByKey("vip_level"):asInt()
		updataHUDData()
	end

	--有新邮件
	if s:getByKey("new_mail"):asInt() ~= nil and s:getByKey("new_mail"):asInt() ~= 0 then
		if not newMail then
			newMail = true
			local hud = dbHUDLayer:shareHUD2Lua()
			if hud then
				local btn = dbUIButtonScale:buttonWithImage("UI/ri_chang/new.png", 1, ccc3(125, 125, 125))
				btn:setPosition(CCPoint(512+200, 150))
				btn:setAnchorPoint(CCPoint(0,0))
				btn.m_nScriptClickedHandler = function()
					globleShowMailInbox()
					btn:removeFromParentAndCleanup(true)
					newMail = nil
				end
				hud:addChild(btn,20000)
			end
		end
	end

	if ClientData.army_sweeping_end then
		DispatchEvent("army_sweeping")
		ClientData.army_sweeping_end = false
	end
	
	if ClientData.raid_sweeping_end then
		DispatchEvent("raid_sweeping")
		ClientData.raid_sweeping_end = false
	end
	
	--BOSS战开启倒计时
	MausoleumHUD(s:getByKey("mausoleum_wait_for_open"):asInt())
	--阵营战开启倒计时
	GlobleUpdateLeagueHUD(s:getByKey("league_wait_for_open"):asInt())

--	checkCompensate(s)
	
	checkLegionApply(s)
end

----- OPT_Generals ---------------------------------------------------------------------------
local function opGeneralsFinishCB(s)
	local error_code = s:getByKey("error_code"):asInt()
	if error_code > 0 then
		ShowErrorInfoDialog(error_code)
	else
		mappedPlayerGeneralData(s)
		mappedPlayerFormations(s)
	end
end

local function opGeneralsFailedCB(s)
	alert("更新宠物列表失败。")
end

function executeGenerals()
	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	NetMgr:setOpUnique(Net.OPT_Generals)
	NetMgr:executeOperate(Net.OPT_Generals, cj)
end

NetMgr:registOpLuaFinishedCB(Net.OPT_Generals, opGeneralsFinishCB)
NetMgr:registOpLuaFailedCB(Net.OPT_Generals, opGeneralsFailedCB)

----- OPT_RoleSimple ---------------------------------------------------------------------------
local function opRoleSimpleFinishCB(s)
	local error_code = s:getByKey("error_code"):asInt()

	if error_code > 0 then
		ShowErrorInfoDialog(error_code)
	else
		GloblePlayerData.prestige = s:getByKey("prestige"):asInt()
		GloblePlayerData.barn = s:getByKey("barn"):asInt()
		GloblePlayerData.copper = s:getByKey("copper"):asInt()
		GloblePlayerData.pool = s:getByKey("pool"):asInt()
		GloblePlayerData.gold = s:getByKey("gold"):asInt()
		GloblePlayerData.action_point = s:getByKey("action_point"):asInt()
		GloblePlayerData.fame = s:getByKey("fame"):asInt()
		GloblePlayerData.arena_rank = s:getByKey("arena_rank"):asInt()
		GloblePlayerData.exploit = s:getByKey("exploit"):asInt()
		GloblePlayerData.ap_wand = s:getByKey("ap_wand"):asInt()
		GloblePlayerData.step = s:getByKey("step"):asInt()

		if GloblePlayerData.officium ~= s:getByKey("officium"):asInt() then
			GlobleUpdateOfficum(s:getByKey("officium"):asInt())
		end
		
		updataHUDData()
	end
end

local function opRoleSimpleFailedCB(s)
	closeWait()
	alert("网络请求失败。")
end

--是否需要更新主角神位等级等信息，一般用于战斗前设置，进入主场景后调用
globalRoleSimpleOnce = nil		
function executeRoleSimpleOnce()
	if globalRoleSimpleOnce then
		executeRoleSimple()
		globalRoleSimpleOnce = nil
	end
end

function executeRoleSimple()
	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	NetMgr:executeOperate(Net.OPT_RoleSimple, cj)
end

function GlobalLogout()
	--在线礼包
	destroyRewardOnline()
	PlayChannelSystemState = true
	PlayChannelNWState = true
	FisrtChatState = true
	if GlobalChatData ~= nil then
		CCScheduler:sharedScheduler():unscheduleScriptEntry(GlobalChatData.requestHand)
		GlobalChatData.requestHand = nil
		GlobalChatData:clearData()
		GlobalChatData = nil
	end
	
	unscheduleGuaJiTimeHandle()

	GlobleClearBossWarStatus()
	GlobleClearLeagueStatus()
	
	if GolbalChatSMSPanel ~= nil then
		GolbalChatSMSPanel:destroy()
		GolbalChatSMSPanel = nil
	end
	
	if AnnounceMoveHandler then
		CCScheduler:sharedScheduler():unscheduleScriptEntry(AnnounceMoveHandler)
		AnnounceMoveHandler = nil
	end
			
	if GlobleChatPanel ~= nil then
		FirstOpenChatPanel = true
		GlobleChatPanel:destroy()
		GlobleChatPanel = nil
	end
	GlobalCurZhenFa = nil
	GloblePanel = nil
	clearClientData()
	
	globlLeaveBossWar()
	
	GlobleUserGuideCheckTime = 0
	dbSceneMgr:getSingletonPtr():logout()
end

NetMgr:registOpLuaFinishedCB(Net.OPT_RoleSimple, opRoleSimpleFinishCB)
NetMgr:registOpLuaFailedCB(Net.OPT_RoleSimple, opRoleSimpleFailedCB)
NetMgr:registOpLuaFinishedCB(Net.OPT_Fate, opFateFinishCB)
Queue = {
	first = nil,
	last = nil,
	count = nil,
	values = nil,
	index = nil,
	create = function(self)
		self.values = new({})
		self.first = 1
		self.last = 0
		self.count = 0
		self.index = new({})
		return self
	end,
	push = function(self,value)
		if self.first==1 and self.last==0 then
			self:pushFront(value)
		else
			self:pushBack(value)
		end
	end,
	pushFront = function(self,value)
		local first = self.first - 1;
		self.first = first
		self.values[first] = value
		self.count = self.count + 1
	end,
	pushBack = function(self,value)
		local last = self.last + 1
		self.last = last
		self.values[last] = value
		self.count = self.count + 1
	end,
	popFirst = function(self)
		local first = self.first
		if first > self.last then
			return
		end
		local value = self.values[first]
		self.values[first] = nil
		self.first = first + 1
		self.count = self.count - 1
		return value
	end,
	popLast = function(self)
		local last = self.last
		if self.first > last then
			return
		end
		local value = self.values[last]
		self.values[last] = nil
		self.last = last - 1
		self.count = self.count - 1
		return value
	end,

	CountValue = function(self)
		return self.count
	end,

	empty = function(self)
		local last = self.last
		if self.first > last then
			return true
		else
			return false
		end
	end,
	
	isHave = function(self,v) ---values必须是从后面插入
		local last = self.last
		if self.first > last then
			return
		end
		local c = 0

		for i = 1,table.getn(self.values) do
			if self.values[i] == v then
				c = c + 1
			end
		end

		if c > 0 then
			return true
		else
			return false
		end
	end,
	destroyData = function(self)
		self.values = nil
		self.index = nil
		self.first = 1
		self.last = 0
		self.count = 0
	end,
}

DIRECTOR = CCDirector:sharedDirector()
WINSIZE = DIRECTOR:sharedDirector():getWinSize()
SCALEX = dbGameDataMgr:sharedGameDataMgr():globleScaleX()
SCALEY = dbGameDataMgr:sharedGameDataMgr():globleScaleY()
SCALE = SCALEX>SCALEY and SCALEY or SCALEX
HUD_SCALE = WINSIZE.height>=720 and (WINSIZE.height > 1024 and 1.5 or SCALE) or SCALE*1.2

FRAMECACHE = CCSpriteFrameCache:sharedSpriteFrameCache()

GloblePlayerData = {}
GlobleItemsData = {}

GlobalCfgMgr = dbCommonCfg:getInstance()
G_SceneMgr  = dbSceneMgr:getSingletonPtr()

--设備类型
EQUIPMENT = dbGameDataMgr:sharedGameDataMgr():getDeviceType()
HARDWARE = "flat"
if (WINSIZE.height == 480 and (WINSIZE.width == 800 or WINSIZE.width == 854)) or (WINSIZE.height == 640 and WINSIZE.width == 960) then
	HARDWARE = "phone"
end

isRetina=1.0
if (EQUIPMENT ==2) then 
  isRetina=2.0
 end

--CCLuaLog("@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"..isRetina)

SYSFONT = {
	"",--win32
	"Arial",--ios
	"",--android
	--Droid Sans Fallback
}

COLOR = {
	GRAY = ccc3(125,125,125),
	RED = ccc3(255,0,0),
	GREED = ccc3(0,255,0),
	GRAY2 = ccc3(83,69,60)
}
ReColor = {
	ccc3(0,255,0),
	ccc3(255,200,0),
	ccc3(0,255,200),
	ccc3(255,0,0),
}
ITEM_COLOR = {
	ccc3(255,255,255),
	ccc3(141,219,109),
	ccc3(112,112,255),
	ccc3(158,54,158),
	ccc3(255,137,0),
	ccc3(255,0,0),
	ccc3(255,255,0),
}
ITEM_COLOR[0] = ccc3(255,255,255)
ITEM_QUALITY = {
	"UI/baoguoPanel/q_0.png",
	"UI/baoguoPanel/q_1.png",
	"UI/baoguoPanel/q_2.png",
	"UI/baoguoPanel/q_3.png",
	"UI/baoguoPanel/q_4.png",
	"UI/baoguoPanel/q_5.png",
}

PLAYER_COLOR = {
	ccc3(255,255,255),
	ccc3(141,219,109),
	ccc3(112,112,255),
	ccc3(158,54,158),
	ccc3(255,137,0),
	ccc3(255,0,0),
	ccc3(255,255,0),
}
SOUL_COLOR = {
	ccc3(255,255,255),
	ccc3(0,255,0),
	ccc3(0,200,255),
	ccc3(127,0,255),
	ccc3(255,127,0),
}

JOB_LIST = {}
JOB_LIST[51001] = {52002,52003}
JOB_LIST[61004] = {62005,62006}
JOB_LIST[71007] = {72008,72009}
JOB_LIST[81010] = {82011,82012}

--各职业领悟技能列表
SKILL_AWALEN_TABLE = {}

--游侠
SKILL_AWALEN_TABLE[51001] = {
	11001,
	11002,
	11003,
	11004,
	11005,
	11006,
	11007,
	11008,
	11009,
	11010,
}
--剑圣
SKILL_AWALEN_TABLE[52002] = {
	12011,
	12012,
	12013,
	12014,
	12015,
	12016,
}
--圣骑士
SKILL_AWALEN_TABLE[52003] = {
	12017,
	12018,
	12019,
	12020,
	12021,
	12022,
}

--炎系
SKILL_AWALEN_TABLE[12002] = {
	11001,
	11002,
	11003,
	11004,
	11005,
	11006,
	11007,
	11008,
	11009,
	11010,
	12011,
	12012,
	12013,
	12014,
	12015,
	12016,	
}
--巨魔系
SKILL_AWALEN_TABLE[12003] = {
	11001,
	11002,
	11003,
	11004,
	11005,
	11006,
	11007,
	11008,
	11009,
	11010,
	12017,
	12018,
	12019,
	12020,
	12021,
	12022,	
}

--法师
SKILL_AWALEN_TABLE[61004] = {
	11023,
	11024,
	11025,
	11026,
	11027,
	11028,
	11029,
	11030,
	11031,
	11032,
}
--魔导师
SKILL_AWALEN_TABLE[62005] = {
	12033,
	12034,
	12035,
	12036,
	12037,
	12038,
}
--仙术师
SKILL_AWALEN_TABLE[62006] = {
	12039,
	12040,
	12041,
	12042,
	12043,
	12044,
}
--魔法系
SKILL_AWALEN_TABLE[22005] = {
	11023,
	11024,
	11025,
	11026,
	11027,
	11028,
	11029,
	11030,
	11031,
	11032,
	12033,
	12034,
	12035,
	12036,
	12037,
	12038,	
}
--仙法系
SKILL_AWALEN_TABLE[22006] = {
	11023,
	11024,
	11025,
	11026,
	11027,
	11028,
	11029,
	11030,
	11031,
	11032,
	12039,
	12040,
	12041,
	12042,
	12043,
	12044,
}

--噬魂者
SKILL_AWALEN_TABLE[71007] = {
	11045,
	11046,
	11047,
	11048,
	11049,
	11050,
	11051,
	11052,
	11053,
	11054,
}
--暗堂
SKILL_AWALEN_TABLE[72008] = {
	12055,
	12056,
	12057,
	12058,
	12059,
	12060,
}
--死神
SKILL_AWALEN_TABLE[72009] = {
	12061,
	12062,
	12063,
	12064,
	12065,
	12066,
}

--暗系
SKILL_AWALEN_TABLE[32008] = {
	11045,
	11046,
	11047,
	11048,
	11049,
	11050,
	11051,
	11052,
	11053,
	11054,
	12055,
	12056,
	12057,
	12058,
	12059,
	12060,	
}
--月系
SKILL_AWALEN_TABLE[32009] = {
	11045,
	11046,
	11047,
	11048,
	11049,
	11050,
	11051,
	11052,
	11053,
	11054,
	12061,
	12062,
	12063,
	12064,
	12065,
	12066,
}

--吟游诗人
SKILL_AWALEN_TABLE[81010] = {
	11067,
	11068,
	11069,
	11070,
	11071,
	11072,
	11073,
	11074,
	11075,
	11076,
}
--萨满
SKILL_AWALEN_TABLE[82011] = {
	12077,
	12078,
	12079,
	12080,
	12081,
	12082,
}
--巫女
SKILL_AWALEN_TABLE[82012] = {
	12083,
	12084,
	12085,
	12086,
	12087,
	12088,
}
--水系
SKILL_AWALEN_TABLE[42011] = {
	11067,
	11068,
	11069,
	11070,
	11071,
	11072,
	11073,
	11074,
	11075,
	11076,
	12077,
	12078,
	12079,
	12080,
	12081,
	12082,
}
--水系
SKILL_AWALEN_TABLE[42012] = {
	11067,
	11068,
	11069,
	11070,
	11071,
	11072,
	11073,
	11074,
	11075,
	11076,
	12083,
	12084,
	12085,
	12086,
	12087,
	12088,
}

ERROR_CODE_DESC = {}
ERROR_CODE_DESC[88881] = "服务器数据传输错误！"	-- Default
--ERROR_CODE_DESC[-1] = "成功"
ERROR_CODE_DESC[98] = "过期"
ERROR_CODE_DESC[99] = "服务器忙"
ERROR_CODE_DESC[100] = "角色无效"
ERROR_CODE_DESC[101] = "密码错误"
ERROR_CODE_DESC[102] = "名字已有主啦"
ERROR_CODE_DESC[103] = "创建失败，请重试"
ERROR_CODE_DESC[104] = "名字太长，最大5个中文或10个英文"
ERROR_CODE_DESC[105] = "账号被冻结"
ERROR_CODE_DESC[106] = "名字有非法字符"
ERROR_CODE_DESC[107] = "通行证角色已创建"
ERROR_CODE_DESC[108] = "通行证绑定失败"
ERROR_CODE_DESC[201] = "物品不存在"
ERROR_CODE_DESC[202] = "金币不足"
ERROR_CODE_DESC[203] = "拍卖纪录错误"
ERROR_CODE_DESC[204] = "配置数据错误"
ERROR_CODE_DESC[205] = "宠物不存在"
ERROR_CODE_DESC[2051] = "宠物已经招募过了"
ERROR_CODE_DESC[206] = "失败"
ERROR_CODE_DESC[207] = "没有技能可以学习"
ERROR_CODE_DESC[208] = "技能点不足"
ERROR_CODE_DESC[209] = "技能已满"
ERROR_CODE_DESC[210] = "等级还不够哦"
ERROR_CODE_DESC[211] = "技能不存在"
ERROR_CODE_DESC[212] = "位置未开启"
ERROR_CODE_DESC[213] = "阵型不存在="
ERROR_CODE_DESC[214] = "神位不够"
ERROR_CODE_DESC[215] = "阵型等级已满"
ERROR_CODE_DESC[216] = "宠物身上有物品或星魂，无法放生"
ERROR_CODE_DESC[217] = "该物品无法购买"
ERROR_CODE_DESC[218] = "征收冷却中"
ERROR_CODE_DESC[219] = "征收次数已满"
ERROR_CODE_DESC[220] = "征收事件不存在"
ERROR_CODE_DESC[221] = "该宠物正在训练"
ERROR_CODE_DESC[222] = "训练位不足"
ERROR_CODE_DESC[223] = "宠物未在训练中"
ERROR_CODE_DESC[224] = "经验丹冷却中"
ERROR_CODE_DESC[225] = "强化冷却中"
ERROR_CODE_DESC[226] = "装备强化等级不能超过主角神位等级"
ERROR_CODE_DESC[227] = "场景不存在"
ERROR_CODE_DESC[228] = "学习失败"
ERROR_CODE_DESC[229] = "科技等级已满"
ERROR_CODE_DESC[230] = "当前神位可招募数已满"
ERROR_CODE_DESC[231] = "银币不足"
ERROR_CODE_DESC[232] = "任务列表已满"
ERROR_CODE_DESC[233] = "任务不能重复接取"
ERROR_CODE_DESC[234] = "任务不存在"
ERROR_CODE_DESC[235] = "训练位已满"
ERROR_CODE_DESC[236] = "任务无法放弃"
ERROR_CODE_DESC[237] = "技能无法升级"
ERROR_CODE_DESC[238] = "技能已经满级"
ERROR_CODE_DESC[239] = "天运值已经修改"
ERROR_CODE_DESC[240] = "您没有阵营"
ERROR_CODE_DESC[241] = "有其他阵营任务在进行中"
ERROR_CODE_DESC[242] = "生命池用完"
ERROR_CODE_DESC[243] = "抢劫失败"
ERROR_CODE_DESC[244] = "目标玩家不存在"
ERROR_CODE_DESC[245] = "场景信息错误"
ERROR_CODE_DESC[246] = "该物品不能出售"
ERROR_CODE_DESC[2461] = "拆卸宝石后才可以出售"
ERROR_CODE_DESC[247] = "邮件不存在"
ERROR_CODE_DESC[248] = "邮件不能发送给自己"
ERROR_CODE_DESC[249] = "操作对象不能是自己"
ERROR_CODE_DESC[250] = "任务还没有结束"
ERROR_CODE_DESC[251] = "任务已经被别人【照顾】过了~"
ERROR_CODE_DESC[252] = "精力不足"
ERROR_CODE_DESC[253] = "不能重复奴役"
ERROR_CODE_DESC[254] = "该物品不是装备"
ERROR_CODE_DESC[255] = "话太长了"
ERROR_CODE_DESC[256] = "祭炼冷却中"
ERROR_CODE_DESC[257] = "还没有获得符文"
ERROR_CODE_DESC[258] = "符文不存在"
ERROR_CODE_DESC[259] = "占领已达上限"
ERROR_CODE_DESC[260] = "挑战次数已满"
ERROR_CODE_DESC[261] = "祭炼师已达上限"
ERROR_CODE_DESC[262] = "偷饲料次数已满"
ERROR_CODE_DESC[263] = "对方被偷次数已满"
ERROR_CODE_DESC[264] = "打扫次数已满"
ERROR_CODE_DESC[265] = "对方被打扫次数已满"
ERROR_CODE_DESC[266] = "特殊技能"
ERROR_CODE_DESC[267] = "任务物品无法使用"
ERROR_CODE_DESC[268] = "碎片不能装备"
ERROR_CODE_DESC[269] = "物品必須先降级到1级"
ERROR_CODE_DESC[270] = "只有碎片才能交易"
ERROR_CODE_DESC[271] = "阵型使用中"
ERROR_CODE_DESC[272] = "祭炼师交流冷却中"
ERROR_CODE_DESC[273] = "科技升级冷却中"
ERROR_CODE_DESC[274] = "现在去那里就是送肉"
ERROR_CODE_DESC[275] = "当前VIP可接任务已满"
ERROR_CODE_DESC[276] = "VIP等级不足"
ERROR_CODE_DESC[277] = "邮箱为空"
ERROR_CODE_DESC[278] = "战功不足"
ERROR_CODE_DESC[279] = "精英数量不足"
ERROR_CODE_DESC[280] = "技能列表为空"
ERROR_CODE_DESC[281] = "技能领悟数已满"
ERROR_CODE_DESC[282] = "不需要重置技能"
ERROR_CODE_DESC[283] = "队伍不存在"
ERROR_CODE_DESC[2831] = "队伍人数已经达到上限"
ERROR_CODE_DESC[2833] = "重置达到上限"
ERROR_CODE_DESC[284] = "精力购买数已达本VIP等级上限"
ERROR_CODE_DESC[285] = "训练等级不能超过神位等级"
ERROR_CODE_DESC[286] = "该农田已在种植"
ERROR_CODE_DESC[287] = "农田不存在"
ERROR_CODE_DESC[288] = "果子还没成熟"
ERROR_CODE_DESC[289] = "今日賽馬次数已经用完"
ERROR_CODE_DESC[290] = "祭炼场可开数已满"
ERROR_CODE_DESC[291] = "目标等级差距过大"
ERROR_CODE_DESC[292] = "今日抢劫次数已满"
ERROR_CODE_DESC[293] = "对手已经击败过了"
ERROR_CODE_DESC[294] = "兑换奖励不存在"
ERROR_CODE_DESC[295] = "竞技场积分不足"
ERROR_CODE_DESC[296] = "祭炼师已经拥有"
ERROR_CODE_DESC[297] = "祭炼师不存在"
ERROR_CODE_DESC[298] = "灵果不足"
ERROR_CODE_DESC[299] = "技能已经锁定"
ERROR_CODE_DESC[300] = "技能还没有锁定"
ERROR_CODE_DESC[301] = "朗姆酒不足"
ERROR_CODE_DESC[302] = "对方处于保护阶段"
ERROR_CODE_DESC[303] = "礼包码不存在"
ERROR_CODE_DESC[304] = "礼包码已经使用过了"
ERROR_CODE_DESC[305] = "礼包已经领取"
ERROR_CODE_DESC[306] = "礼包已经领取过了"
ERROR_CODE_DESC[307] = "奖励不存在"
ERROR_CODE_DESC[308] = "奖励领取条件未满足"
ERROR_CODE_DESC[309] = "已经在队伍中"
ERROR_CODE_DESC[310] = "不能重复收藏"
ERROR_CODE_DESC[311] = "收藏不存在"
ERROR_CODE_DESC[312] = "家族不存在"
ERROR_CODE_DESC[313] = "已在申请列表中"
ERROR_CODE_DESC[314] = "申请的家族不是本阵营的"
ERROR_CODE_DESC[315] = "太晚了，TA已经被别的家族抢走了！"
ERROR_CODE_DESC[316] = "权限不足"
ERROR_CODE_DESC[317] = "不在申请列表"
ERROR_CODE_DESC[318] = "已经在家族中了"
ERROR_CODE_DESC[319] = "不在家族中"
ERROR_CODE_DESC[320] = "你现在是族长，无法退出家族，\n请先将族长转让给别人"
ERROR_CODE_DESC[321] = "对方不在家族中"
ERROR_CODE_DESC[322] = "家族名字重复"
ERROR_CODE_DESC[323] = "家族等级已满"
ERROR_CODE_DESC[324] = "对方不在线"
ERROR_CODE_DESC[325] = "对方已经是你的好友了"
ERROR_CODE_DESC[326] = "好友不存在"
ERROR_CODE_DESC[327] = "家族人数已满"
ERROR_CODE_DESC[3271] = "已经申请过家族了"
ERROR_CODE_DESC[3272] = "你已经加入家族，不能撤回申请"
ERROR_CODE_DESC[3273] = "申请已经撤回"
ERROR_CODE_DESC[328] = "家族名字不能为空"
ERROR_CODE_DESC[329] = "竞技场购买次数已满"
ERROR_CODE_DESC[330] = "宠物需要转生后才能升级"
ERROR_CODE_DESC[331] = "日常任务已经接取"
ERROR_CODE_DESC[332] = "日常任务不存在"
ERROR_CODE_DESC[333] = "日常任务无法提交"
ERROR_CODE_DESC[334] = "日常任务未完成"
ERROR_CODE_DESC[335] = "日常任务不能接取"
ERROR_CODE_DESC[336] = "日常任务剩余数量不足"
ERROR_CODE_DESC[337] = "宠物转生次数已满"
ERROR_CODE_DESC[338] = "贡献已满"
ERROR_CODE_DESC[339] = "装备中的物品不能出售"
ERROR_CODE_DESC[340] = "勋章不足"
ERROR_CODE_DESC[341] = "商贸市场操作异常"
ERROR_CODE_DESC[342] = "祭炼次数已满"
ERROR_CODE_DESC[343] = "本家族此轮已经竞标过"
ERROR_CODE_DESC[344] = "家族贡献度不足"
ERROR_CODE_DESC[345] = "不能竞标"
ERROR_CODE_DESC[346] = "矿点未占领"
ERROR_CODE_DESC[347] = "竞标价格错误"
ERROR_CODE_DESC[348] = "该矿点奖励已领取"
ERROR_CODE_DESC[349] = "鼓舞冷却中"
ERROR_CODE_DESC[350] = "家族战不存在"
ERROR_CODE_DESC[351] = "补给冷却中"
ERROR_CODE_DESC[352] = "家族等级不符"
ERROR_CODE_DESC[353] = "矿点不存在"
ERROR_CODE_DESC[354] = "家族战人数已满"
ERROR_CODE_DESC[355] = "家族战最后一轮不能复活"
ERROR_CODE_DESC[356] = "该佣兵已交保护费"
ERROR_CODE_DESC[357] = "驛站事件不存在"
ERROR_CODE_DESC[358] = "祭星台星魂已满"
ERROR_CODE_DESC[359] = "星魂背包已满"
ERROR_CODE_DESC[360] = "该星魂不存在"
ERROR_CODE_DESC[361] = "该星魂已是最高级"
ERROR_CODE_DESC[362] = "该星魂无法被吞噬"
ERROR_CODE_DESC[363] = "奖励已经领取过了"
ERROR_CODE_DESC[364] = "星魂已经装备"
ERROR_CODE_DESC[365] = "不能装备同类型的星魂"
ERROR_CODE_DESC[366] = "该道具不能直接使用，请在“神宠图鉴”中兑换指定神宠"
ERROR_CODE_DESC[367] = "星魂无法吞噬自己"
ERROR_CODE_DESC[368] = "活动已过期"
ERROR_CODE_DESC[369] = "充值数未满足"
ERROR_CODE_DESC[370] = "没有占领目标"
ERROR_CODE_DESC[371] = "您被禁言了"
ERROR_CODE_DESC[372] = "活跃度不够"
ERROR_CODE_DESC[373] = "日常任务数量已满"
ERROR_CODE_DESC[374] = "没有对应的VIP礼包"
ERROR_CODE_DESC[375] = "今日VIP礼包已经购买"
ERROR_CODE_DESC[376] = "购买次数已满"
ERROR_CODE_DESC[378] = "暂无奴隶"
ERROR_CODE_DESC[396] = "你已经死亡，请等待复活"
ERROR_CODE_DESC[397] = "BOSS战尚未开启\n开启时间：\n中午12:00-12:30\n晚上08:00-08:30"
ERROR_CODE_DESC[398] = "BOSS正忙"
ERROR_CODE_DESC[399] = "BOSS已经阵亡"
ERROR_CODE_DESC[3991] = "战斗准备中，请稍候"
ERROR_CODE_DESC[400] = "没有改记录"
ERROR_CODE_DESC[401] = "沒有最近信息"
ERROR_CODE_DESC[402] = "争霸赛还没有结束"
ERROR_CODE_DESC[403] = "当前没有开放争霸赛"
ERROR_CODE_DESC[404] = "与服务器断开连接"
ERROR_CODE_DESC[405] = "没有奖励可领或者已经领取"
ERROR_CODE_DESC[406] = "现在不是报名时间"
ERROR_CODE_DESC[407] = "您已经参加该争霸赛的报名了"
ERROR_CODE_DESC[408] = "没有您的战报"
ERROR_CODE_DESC[410] = "众神墓地进入冷却中"
ERROR_CODE_DESC[411] = "没有该NPC"
ERROR_CODE_DESC[412] = "事件未找到"
ERROR_CODE_DESC[413] = "没有足够的介绍信"
ERROR_CODE_DESC[414] = "活动未开启"
ERROR_CODE_DESC[416] = "祝福未冷却"
ERROR_CODE_DESC[417] = "祝福次数已用完"
ERROR_CODE_DESC[418] = "活动未开启或者已经结束"
ERROR_CODE_DESC[419] = "该爆竹已经賣完"
ERROR_CODE_DESC[420] = "请先选择是否替换"
ERROR_CODE_DESC[421] = "挑战冷却中"
ERROR_CODE_DESC[422] = "暂无奖励可领"
ERROR_CODE_DESC[423] = "无法购买金蟾"
ERROR_CODE_DESC[424] = "金蟾购买数量已满"
ERROR_CODE_DESC[425] = "角色目标不是敌人"
ERROR_CODE_DESC[426] = "角色敌人被设置为永久"
ERROR_CODE_DESC[427] = "角色敌人未被设置永久"
ERROR_CODE_DESC[428] = "已经加入阵营"
ERROR_CODE_DESC[429] = "道具不是宝石"
ERROR_CODE_DESC[430] = "孔已经镶上宝石了"
ERROR_CODE_DESC[431] = "孔和宝石属性不符"
ERROR_CODE_DESC[432] = "孔没有镶嵌宝石"
ERROR_CODE_DESC[434] = "合成宝石所需数量不对"
ERROR_CODE_DESC[435] = "合成宝石所需数量不足"
ERROR_CODE_DESC[436] = "宝石品质已达最高"
ERROR_CODE_DESC[437] = " 宝石不能直接使用"
ERROR_CODE_DESC[438] = " 天雲亨通活动无效"
ERROR_CODE_DESC[439] = " 已经激活天雲亨通"
ERROR_CODE_DESC[440] = " 新年礼包兑换活动"
ERROR_CODE_DESC[441] = " 兑换所需礼包数不够"
ERROR_CODE_DESC[443] = " 四海朝貢活动无效"
ERROR_CODE_DESC[444] = " 沒有四海朝貢奖励"
ERROR_CODE_DESC[445] = " 道具不能直接使用"
ERROR_CODE_DESC[446] = " 勋章数不足"
ERROR_CODE_DESC[447] = " 不能用爱心值兑换"
ERROR_CODE_DESC[448] = " 天雲亨通还有效果"
ERROR_CODE_DESC[449] = " 已装备物品不能升级"
ERROR_CODE_DESC[450] = " 升级材料不足"
ERROR_CODE_DESC[451] = " 副本还没有通关"
ERROR_CODE_DESC[4510] = "副本重置次数用完了"
ERROR_CODE_DESC[4511] = "没有怪可以扫荡"
ERROR_CODE_DESC[4512] = "精英副本中的怪只能打一次"
ERROR_CODE_DESC[452] = " 已经拥有该宠物"
ERROR_CODE_DESC[453] = " 大逃杀战场不能进入"
ERROR_CODE_DESC[454] = "大逃杀活动未开启"
ERROR_CODE_DESC[455] = "您已经进入了其他副本"
ERROR_CODE_DESC[456] = "宠物出现在店里了，无需爱心兑换"
ERROR_CODE_DESC[457] = "副本正在扫荡中"
ERROR_CODE_DESC[458] = "不在活动领取时间内"
ERROR_CODE_DESC[459] = "领取条件不满足"
ERROR_CODE_DESC[460] = "大逃杀战斗中轮空，无記錄"
ERROR_CODE_DESC[462] = "賽馬还沒有开始"
ERROR_CODE_DESC[463] = "还沒加入比賽"
ERROR_CODE_DESC[464] = "跑完比賽了"
ERROR_CODE_DESC[465] = "比賽行动冷却中"
ERROR_CODE_DESC[466] = "不能对该城門使用"
ERROR_CODE_DESC[467] = "沒有事件卡"
ERROR_CODE_DESC[469] = "当前无可挑战对手"
ERROR_CODE_DESC[470] = "不能移动到当前城門"
ERROR_CODE_DESC[471] = "不能在当前城門挑战"
ERROR_CODE_DESC[472] = "前方无可到达城門"
ERROR_CODE_DESC[473] = "还没有接取阵营任务"
ERROR_CODE_DESC[474] = "宠物已经放生"
ERROR_CODE_DESC[482] = "请至技能面板重置技能使用"
ERROR_CODE_DESC[483] = "星魂炉中没有星魂"
ERROR_CODE_DESC[484] = "消费数量不足"
ERROR_CODE_DESC[510] = "天将係統未开启"
ERROR_CODE_DESC[511] = "靈值已满"
ERROR_CODE_DESC[512] = "通靈次数已满"
ERROR_CODE_DESC[513] = "魔典不足"
ERROR_CODE_DESC[514] = "靈值不足"
ERROR_CODE_DESC[515] = "神宠不能领悟技能"
ERROR_CODE_DESC[516] = "神宠不能重置技能"
ERROR_CODE_DESC[517] = "神宠技能达到最高"
ERROR_CODE_DESC[518] = "神宠技能前置未满足"
ERROR_CODE_DESC[519] = "神宠技能不存在"
ERROR_CODE_DESC[520] = "没有神宠技能可以被替换"
ERROR_CODE_DESC[521] = "心魔家族不存在"
ERROR_CODE_DESC[522] = "只有主角和神宠形象能够替换"
ERROR_CODE_DESC[523] = "目标角色已绑定"
ERROR_CODE_DESC[524] = "目标账号已绑定"
ERROR_CODE_DESC[525] = "目标账号未绑定"
ERROR_CODE_DESC[550] = "阵营战未开"
ERROR_CODE_DESC[551] = "沒有加入"
ERROR_CODE_DESC[552] = "不能移动到该点"
ERROR_CODE_DESC[553] = "战斗冷却"
ERROR_CODE_DESC[554] = "移动冷却"
ERROR_CODE_DESC[555] = "沒有事件卡"
ERROR_CODE_DESC[556] = "不能对该点进行攻击"
ERROR_CODE_DESC[557] = "不能对改據点使用"
ERROR_CODE_DESC[558] = "空城不能被偷襲"
ERROR_CODE_DESC[559] = "挖掘冷却时间"
ERROR_CODE_DESC[580] = "任务进行中不能刷新收益"
ERROR_CODE_DESC[581] = "任务未开放"
ERROR_CODE_DESC[582] = "领取时间未到"
ERROR_CODE_DESC[583] = "没有神宠可以兑换"
ERROR_CODE_DESC[584] = "没有宠物可以兑换"
ERROR_CODE_DESC[585] = "不在报名阶段"
ERROR_CODE_DESC[586] = "你已经报名了"
ERROR_CODE_DESC[587] = "你沒有參加比賽"
ERROR_CODE_DESC[588] = "比赛还没有结束"
ERROR_CODE_DESC[589] = "你已经下注了"
ERROR_CODE_DESC[590] = "不能下注"
ERROR_CODE_DESC[591] = "不能鲜花"
ERROR_CODE_DESC[592] = "爬塔次数不足"
ERROR_CODE_DESC[593] = "爬塔難度範圍错误"
ERROR_CODE_DESC[594] = "不在队伍中"
ERROR_CODE_DESC[595] = "爬塔信息不存在"
ERROR_CODE_DESC[596] = "爬塔连胜次数最大"
ERROR_CODE_DESC[597] = "鼓舞次数"
ERROR_CODE_DESC[598] = "爬塔战败"
ERROR_CODE_DESC[599] = "爬塔在準備时间"
ERROR_CODE_DESC[600] = "爬塔人数不足"
ERROR_CODE_DESC[601] = "爬塔已经开始"
ERROR_CODE_DESC[602] = "不是队长，没有权利选择他人出战"
ERROR_CODE_DESC[603] = "不在时间范围内"
ERROR_CODE_DESC[604] = "竞技场的奖励领取数量错误"
ERROR_CODE_DESC[605] = "端午活动无效"
ERROR_CODE_DESC[606] = "端午领取奖励类型不存在"
ERROR_CODE_DESC[607] = "兑换道具不足"
ERROR_CODE_DESC[608] = "跨服强副本没有开启"
ERROR_CODE_DESC[609] = "跨服强副本怪物不存在"
ERROR_CODE_DESC[610] = "跨服强副本难度错误"
ERROR_CODE_DESC[703] = "鼓舞已经到达上限"
ERROR_CODE_DESC[704] = "神位等级20级才能进入"
ERROR_CODE_DESC[705] = "这个技能可千万不能忘"
ERROR_CODE_DESC[706] = "体力池是满的，不需要增加"
ERROR_CODE_DESC[707] = "不需要复活"
ERROR_CODE_DESC[708] = "所加体力还不够回满所有\n宠物的血,再吃一个试试"
ERROR_CODE_DESC[709] = "剩余数量为0，不能兑换了"
ERROR_CODE_DESC[710] = "兑换奖励失败，名次不够"

ERROR_CODE_DESC[800] = "补偿已经领取过了，不能再领"
ERROR_CODE_DESC[801] = "没有补偿奖励"
ERROR_CODE_DESC[802] = "不存在的城池"
ERROR_CODE_DESC[803] = "不能移动到该主城"
ERROR_CODE_DESC[804] = "攻城战尚未开启\n开启时间：\n晚上07:20-07:50"
--ERROR_CODE_DESC[804] = "攻城战尚未开启"
ERROR_CODE_DESC[805] = "行动冷却中，请稍候"
ERROR_CODE_DESC[806] = "战斗冷却中，请稍候"
ERROR_CODE_DESC[807] = "等待复活中"
ERROR_CODE_DESC[808] = "未找到合适的对手"
ERROR_CODE_DESC[809] = "攻城战即将开始，请稍作等待"
ERROR_CODE_DESC[810] = "攻城战已结束"
ERROR_CODE_DESC[811] = "团队鼓舞已达上限"
ERROR_CODE_DESC[812] = "怒气值不足"
ERROR_CODE_DESC[813] = "奋勇效果未消失，不能多次奋勇"
ERROR_CODE_DESC[814] = "无需加速"
ERROR_CODE_DESC[815] = "无需清除"
ERROR_CODE_DESC[816] = "无需复活"
ERROR_CODE_DESC[817] = "个人鼓舞已达上限"
ERROR_CODE_DESC[818] = "个人鼓舞已达上限"
ERROR_CODE_DESC[819] = "攻城战已经结束"
ERROR_CODE_DESC[820] = "满血，不需要加血"

ERROR_CODE_DESC[900] = "后续内容尚未开放，敬请期待！"
ERROR_CODE_DESC[1000] = "今天捐献次数已经到达上限"

ERROR_CODE_DESC[1001] = "主宠等级大于副宠，无法继承"
ERROR_CODE_DESC[1002] = "副宠身上有装备或星魂未脱落，无法继承"
ERROR_CODE_DESC[1003] = "主角不能被继承"
ERROR_CODE_DESC[1004] = "神宠不能被继承"

ERROR_CODE_DESC[2001] = "背包空间不足"	
ERROR_CODE_DESC[2002] = "星魂背包空间不足"	

ERROR_CODE_DESC[2131] = "主角不能下阵"

ERROR_CODE_DESC[3005] = "什么也没有捞到"

ERROR_CODE_DESC[10010] = "关卡扫荡中"
ERROR_CODE_DESC[10011] = "关卡扫荡已取消"
ERROR_CODE_DESC[10012] = "必须指定关卡才能扫荡"
ERROR_CODE_DESC[10013] = "扫荡次数必须大于0"

ERROR_CODE_DESC[10020] = "崇拜次数已经用完"
ERROR_CODE_DESC[10021] = "不能崇拜自己"
ERROR_CODE_DESC[10022] = "每人每天只能被同一人崇拜一次"
PART_STRING = {
	"武器",
	"衣服", 
	"符文", 
	"手套",
	"帽子", 
	"戒指",
	"道具",
}
soul_ability_type ={}
soul_ability_type[1]="生命"
soul_ability_type[2]="物攻"
soul_ability_type[3]="物防"
soul_ability_type[4]="法攻"
soul_ability_type[5]="法防"
soul_ability_type[6]="速度"
soul_ability_type[7]="命中" 
soul_ability_type[8]="闪避" 
soul_ability_type[9]="破击" 
soul_ability_type[10]="格挡" 
soul_ability_type[11]="暴击" 
soul_ability_type[12]="韧性" 

range_info = {
	"单体",
	"一排",
	"一列",
	"十字",
	"全体",
	"前两列",
}

NATION = {
	"无","泰坦","精灵","魔神",
}
WU_JIANG = "宠物"
BAO_GUO = "背包"
JI_NENG = "技能"
QIANG_HUA = "强化"
JIAO_CHANG = "训练"
WU_HUN = "星魂"
TIAN_FU = "科技"
FAN_HUI = "返回"

TI_LI = "生命"
JING_YAN = "经验"

QUAN_BU = "全部"
ZHUANG_BEI = "装备"
XIAO_HAO = "消耗"
CAI_LIAO = "材料"

WEI_CHI = "维持"
TI_HUAN = "替换"
PEI_YANG = "培养"

WU_LI = "力量"
ZHI_LI = "智力"
TI_ZHI = "耐力"
MIN_JIE = "敏捷"
CHENG_ZHANG = "成长"
DENG_JI = "等级"
YIN_LIANG = "银币"
HUANG_JIN = "金币"
XU_QIU = "需求"
SHENG_JI = "升级"
CHONG_ZHI = "重置"
LING_WU = "领悟"

JI_NENG_DIAN = "技能点"

SUO_DING = "锁定"
JIE_SUO = "解锁"

SHI_YONG = "使用"
CHU_SHOU = "出售"
XIE_XIA = "卸下"

QUE_DING = "确定"
QU_XIAO = "取消"

TI_SHI = "提示"

String_tip2 = "请选择洗髓方式！"
String_tip3 = "你确定要培养宠物嗎？"

String_tip4 = "是否消耗50金币锁定技能"
String_tip5 = "是否消耗10金币解锁技能"

NENG_LI_QIANG_HUA = "能\n力\n强\n化"
JI_NENG_QIANG_HUA = "技\n能\n强\n化"
XUE_XI = "学习"


JI_SI="前往祭星台"
HE_CHENG="一键合成"


TINGZHI_XUNLIAN="停止训练"
TUFEI_MENGJIN="经验飞升"


CHAKAN="查看"
SILIAO="私聊"
SHANCHU="刪除"


DENG_JI_YAO_QIU = "等级要求"
CHU_SHOU_JIA_GE = "出售价格"
CHU_XIAN_CHANG_JING = "出现场景:"
MING_JIANG_JI = "绝技:"
DUI_HUAN_MING_JIANG_HUA_FEI = "兑换神宠花费:"
XIAN_YOU = "现有:"
DUI_HUAN_MING_JIANG = "兑换神宠:"

QIANG_HUA_DENG_JI = "强化等级"
WU_HUN_JING_YAN = "星魂经验"
TUN_SHI = "吞噬"
HUO_DE = "获得"
SHI_FOU_RANG = "是否让"
YIN_BI="银币"
JUN_GONG="战功"
xunlianTime = {}  
xunlianTime[1] = "8小时 1200银币"
xunlianTime[2] = "12小时 4800银币"
xunlianTime[3] = "24小时 7200银币"
xunlianTime[4] = "48小时 14400银币"      
xunlianType = {}
xunlianType[1] = "100%100"
xunlianType[2] = "120%100 2金币"
xunlianType[3] = "150%100 5金币"
xunlianType[4] = "200%100 10金币"
xunlianType[5] = "250%100 15金币"
xunlianType[6] = "300%100 20金币"
SHI_FOU_TING_ZHI = "是否花费1金币停止"
DE_XUN_LIAN = "的训练"
TU_FEI_XIAO_HAO = "提取消耗	"
HUO_DE = "获得"
DANG_QIAN_BEISHU="训练倍数"
TUFEI_LING = "拥有经验丹"
XUN_LIAN = "训练"

tufeiType = {}
tufeiType[1] = "普通提取"
tufeiType[2] = "金币提取(10金币)"
tufeiType[3] = "砖石提取(100金币)"
tufeiType[4] = "至尊提取(500金币)"
tufeiType[5] = "普通提取(10倍)"
tufeiType[6] = "普通提取(50倍)"

tufei_ok = "提取成功，获得"
YUJI = "预计最低获得经验："
XUN_LIAN_TI_SHI = "提示：升级神位能获得更多经验"
QING_CHU_LENG_QUE = "清除冷却"
QING_CHU_LENG_QUE_TI_SHI = "是否花费%d金币消除冷却"
DANG_QIAN = "当前"
XIA_YI = "下一"
units = {
	"万",
	"亿",
}
ZENG_JIA_TILI_YIN_LIANG = "花费%s银币  补充%s生命"
ZENG_JIA_TILI_LIANG_SHI = "花费%s灵果  补充%s生命"
BU_CHONG_TI_LI_TYPE = {
	"当前朗姆酒%d瓶,使用1瓶恢复20点精力",
	"当前朗姆酒%d瓶,使用10瓶恢复200点精力",
	"使用80金币恢复20点精力",
	"使用190金币恢复50点精力",
	"使用360金币恢复100点精力",
}
SELL = "卖出"
SHI_QU = "拾取"
function initPlayerData()
	GloblePanel.curGenerals = 1
	GloblePanel.curItemPackbackClass = 99
	GloblePanel.curItemPackbackPage = 1
	GloblePanel.curGemPackbackPage = 1
	GloblePanel.curForgeItem = nil	
	GloblePlayerData = nil
	GloblePlayerData = new({})
	tovip5=nil
	GloblePlayerData = {
		gold			=	0		,	--金币
		exploit			=	0		,	--战功
		copper			=	0		,	--银币
		action_point	=	0		,	--精力
		cur_formation	=	0 		,	--当前陣法
		pool 	  		=	0		,	--生命池
		barn	  		=	0		,	--灵果
		prestige   		=	0		,	--神力
		ap_wand			=	0		,	--朗姆酒
		fighting_value	=	0		,	--战斗力
		vip_level		=	0		,	--vip等级
		nation			=	0		,	--阵营名
		nationId        =   0		,	--阵营号
		role_name		=	""		,	--名稱
		officium		=	1		,	--当前等级
		vip_charge		=	0		,	--累计充值
		role_face		=	1001	,	--主角頭像
		role_job		=	1		,	--主角职业
		task_id			=	10001	,	--玩家当前任务
		step			=	1		,	--玩家当前的步驟
		login_days      =   0       ,   --第机天登陆
		login_reward    =   false   ,   --是否可以领取奖励
		vitality		= 	0		,	--活跃度
		vitality_idx	= 	0		,	--还未领取的活跃度奖励index
		skill_reset_operator =		0	,	--技能重置符
		cultivate_count      = 0		,	--今天洗髓次数
		soul_cell_count      = 0        ,	--星魂格指数

		forge_cooldown		 = 0		,	--装备强化冷却时间
		forge_refresh_time	 = 0		,	--装备强化刷新时间
		fight_power			 = 0		,	--总战斗力
		generals 	=	{},
		
		formations	=	{},

		sceneMap	=	{},					--开放的城市
		
		trainings	=	{
			jump_wand		=	5					,	--经验丹
			jump_enable		=	true				,	--是否可以提取
			training_slot	=	2					,	--当前训练位置
			jump_cooldown	=	0					,	--提取CD
			server_time		=	1342723531117 		,	--服务器时间
			training_list	=	{
				{
					training_end	=	1342752053193 		,	--训练结束时间
					level			=	5 					,	--宠物等级
					training_ratio	=	100 				,	--训练方式（经验百分比）
					experience		=	990 				,	--获得经验
					generalId		=	26805 				,	--宠物id
				},
			},
		},
		
		items		= {},	
		xiang		= {0,0,0,0,0,},	
		bingfu		= {},
		baoshi		= {},
	}
end

findBingFuByName = function(name)
	for i = 1 , table.getn(GloblePlayerData.bingfu) do
		if GloblePlayerData.bingfu[i].name == name then
			return GloblePlayerData.bingfu[i]
		end
	end
	return 0
end

function insertItemToTable(cfg_item_id,amount,id)
	local i = table.getn(GlobleItemsData) + 1
	local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
	local item = itemJsonConfig:getByKey(cfg_item_id)
	GlobleItemsData[i] = new({})
	GlobleItemsData[i].cfg_item_id = cfg_item_id
	GlobleItemsData[i].name = item:getByKey("name"):asString()
	GlobleItemsData[i].part = item:getByKey("part"):asInt()
	GlobleItemsData[i].amount = amount
	GlobleItemsData[i].id = i
	GlobleItemsData[i].item_id = id
	GlobleItemsData[i].type = item:getByKey("type"):asInt()
	GlobleItemsData[i].quality = item:getByKey("quality"):asInt()
	GlobleItemsData[i].require_level = item:getByKey("require_level"):asInt()
	GlobleItemsData[i].info = item:getByKey("desc"):asString()
	GlobleItemsData[i].star = 1
	GlobleItemsData[i].isEquip = false
	GlobleItemsData[i].effect_type = item:getByKey("effect_type"):asInt()
	GlobleItemsData[i].effect_value = item:getByKey("effect_value"):asInt()
	GlobleItemsData[i].max_count = item:getByKey("max_count"):asInt()
	GlobleItemsData[i].icon = item:getByKey("icon"):asInt()
	GlobleItemsData[i].forge_price = item:getByKey("forge_price"):asInt()
	GlobleItemsData[i].ability = item:getByKey("ability"):asInt()
	GlobleItemsData[i].ability_grow = item:getByKey("ability_grow"):asInt()
	GlobleItemsData[i].ability_type = item:getByKey("ability_type"):asInt()

	GlobleItemsData[i].ability_2 = item:getByKey("ability_2"):asInt()
	GlobleItemsData[i].ability_grow_2 = item:getByKey("ability_grow_2"):asInt()
	GlobleItemsData[i].ability_type_2 = item:getByKey("ability_type_2"):asInt()
		
	GlobleItemsData[i].sell_price = item:getByKey("sell_price"):asInt()
end

function findShowItemInfo(id)
	local items = {
		cfg_item_id = id,
		amount = 1,
		item_id = 0,
		star = 0,
		id = 0,
		hole1 = 0,
		hole2 = 0,
		hole3 = 0,
		hole4 = 0,
		hole5 = 0,
		hole6 = 0,		
		equiped = false,
	}
	
	local item = mappedItemSingle(items)
	return item
end

function mappedItemSingle(items)
	local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
	local item = itemJsonConfig:getByKey(items.cfg_item_id)
	
	local i = new({})
	i.cfg_item_id = items.cfg_item_id
	
	i.hole = new({})
		
	for k = 1 , 6 do 
		i.hole[k] = {
			id = items["hole"..k],
			type = item:getByKey("hole_catrgory_"..k):asInt()
		}
	end
	
	i.name = item:getByKey("name"):asString()
	i.part = item:getByKey("part"):asInt()
	i.amount = items.amount
	i.id = items.id
	i.item_id = items.item_id
	i.type = item:getByKey("type"):asInt()
	i.quality = item:getByKey("quality"):asInt()
	i.require_level = item:getByKey("require_level"):asInt()
	i.info = item:getByKey("desc"):asString()
	i.star = items.star
	i.isEquip = items.equiped
	i.effect_type = item:getByKey("effect_type"):asInt()
	i.effect_value = item:getByKey("effect_value"):asInt()
	i.max_count = item:getByKey("max_count"):asInt()
	i.icon = item:getByKey("icon"):asInt()
	i.forge_price = item:getByKey("forge_price"):asInt()	
	i.ability = item:getByKey("ability"):asInt()
	i.ability_grow = item:getByKey("ability_grow"):asInt()
	i.ability_type = item:getByKey("ability_type"):asInt()
	i.ability_2 = item:getByKey("ability_2"):asInt()
	i.ability_grow_2 = item:getByKey("ability_grow_2"):asInt()
	i.ability_type_2 = item:getByKey("ability_type_2"):asInt()	
	i.sell_price = item:getByKey("sell_price"):asInt()
	return i
end

function mappedItemDataToTable(items)
	GlobleItemsData = nil
	GlobleItemsData = new({})
	local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
	for i = 1 , table.getn(items) do
		local item = itemJsonConfig:getByKey(items[i].cfg_item_id)
		
		GlobleItemsData[i] = new({})
		GlobleItemsData[i].cfg_item_id = items[i].cfg_item_id
		
		GlobleItemsData[i].hole = new({})
		
		for k = 1 , 6 do 
			GlobleItemsData[i].hole[k] = {
				id = items[i]["hole"..k],
				type = item:getByKey("hole_catrgory_"..k):asInt()
			}
		end
		
		GlobleItemsData[i].name = item:getByKey("name"):asString()
		GlobleItemsData[i].part = item:getByKey("part"):asInt()
		GlobleItemsData[i].amount = items[i].amount
		GlobleItemsData[i].id = i
		GlobleItemsData[i].item_id = items[i].item_id
		GlobleItemsData[i].type = item:getByKey("type"):asInt()
		GlobleItemsData[i].quality = item:getByKey("quality"):asInt()
		GlobleItemsData[i].require_level = item:getByKey("require_level"):asInt()
		GlobleItemsData[i].info = item:getByKey("desc"):asString()
		GlobleItemsData[i].star = items[i].star
		GlobleItemsData[i].isEquip = items[i].equiped
		GlobleItemsData[i].effect_type = item:getByKey("effect_type"):asInt()
		GlobleItemsData[i].effect_value = item:getByKey("effect_value"):asInt()
		GlobleItemsData[i].max_count = item:getByKey("max_count"):asInt()
		GlobleItemsData[i].icon = item:getByKey("icon"):asInt()
		--强化费用
		GlobleItemsData[i].forge_price = item:getByKey("forge_price"):asInt()
		
		GlobleItemsData[i].ability = item:getByKey("ability"):asInt()
		GlobleItemsData[i].ability_grow = item:getByKey("ability_grow"):asInt()
		GlobleItemsData[i].ability_type = item:getByKey("ability_type"):asInt()
		
		GlobleItemsData[i].ability_2 = item:getByKey("ability_2"):asInt()
		GlobleItemsData[i].ability_grow_2 = item:getByKey("ability_grow_2"):asInt()
		GlobleItemsData[i].ability_type_2 = item:getByKey("ability_type_2"):asInt()
		
		GlobleItemsData[i].sell_price = item:getByKey("sell_price"):asInt()
		
		if GlobleItemsData[i].type == 5 then
			--戒指
			local new = true
			for j = 1 , table.getn(GloblePlayerData.bingfu) do
				if GlobleItemsData[i].name == GloblePlayerData.bingfu[j].name then
					GloblePlayerData.bingfu[j].amount = GloblePlayerData.bingfu[j].amount + items[i].amount
					new = false
				end
			end
			
			if new then
				GloblePlayerData.bingfu[table.getn(GloblePlayerData.bingfu)+1] = {
					name = GlobleItemsData[i].name,
					amount = items[i].amount,
				}
			end
		end
		if GlobleItemsData[i].type == 3 and GlobleItemsData[i].effect_type == 19 then
			--祭神香
			local xiangId = GlobleItemsData[i].effect_value
			GloblePlayerData.xiang[xiangId] = GloblePlayerData.xiang[xiangId] + items[i].amount
		end
		
		if GlobleItemsData[i].type == 3 and GlobleItemsData[i].effect_type == 18 then
			GloblePlayerData.skill_reset_operator = GloblePlayerData.skill_reset_operator + items[i].amount
		end
		
		if GlobleItemsData[i].type == 4 and GlobleItemsData[i].effect_type == 9 then
			local new = true
			for j = 1 , table.getn(GloblePlayerData.baoshi) do
				if GlobleItemsData[i].name == GloblePlayerData.baoshi[j].name then
					GloblePlayerData.baoshi[j].amount = GloblePlayerData.baoshi[j].amount + items[i].amount
					new = false
				end
			end
			
			if new then
				GloblePlayerData.baoshi[table.getn(GloblePlayerData.baoshi)+1] = {
					name = GlobleItemsData[i].name,
					amount = items[i].amount,
					cfg_item_id = items[i].cfg_item_id,
					quality = GlobleItemsData[i].quality,
					effect = GlobleItemsData[i].effect_value,
					icon = GlobleItemsData[i].icon,
				}
			end
		end
	end	
	
	if GloblePanel ~= nil and GloblePanel.mainWidget ~= nil then
		GloblePanel:clearMainWidget()
		createBaoGuo(true)
	end	
end

function updateSpecialItemData()
	GloblePlayerData.xiang = nil
	GloblePlayerData.xiang = new({})
	GloblePlayerData.xiang[1] = 0
	GloblePlayerData.xiang[2] = 0
	GloblePlayerData.xiang[3] = 0
	GloblePlayerData.xiang[4] = 0
	GloblePlayerData.xiang[5] = 0
	GloblePlayerData.bingfu = nil
	GloblePlayerData.bingfu = new({})
	
	GloblePlayerData.baoshi = nil
	GloblePlayerData.baoshi = new({})
	
	GloblePlayerData.skill_reset_operator = 0
	
	for i = 1 , table.getn(GlobleItemsData) do
		if GlobleItemsData[i].id ~= 0 then
			if GlobleItemsData[i].type == 5 then
				local new = true
				for j = 1 , table.getn(GloblePlayerData.bingfu) do
					if GlobleItemsData[i].name == GloblePlayerData.bingfu[j].name then
						GloblePlayerData.bingfu[j].amount = GloblePlayerData.bingfu[j].amount + GlobleItemsData[i].amount
						new = false
					end
				end
				
				if new then
					GloblePlayerData.bingfu[table.getn(GloblePlayerData.bingfu)+1] = {
						name = GlobleItemsData[i].name,
						amount = GlobleItemsData[i].amount,
					}
				end
			end
			if GlobleItemsData[i].type == 3 and GlobleItemsData[i].effect_type == 19 then
				--祭神香
				local xiangId = GlobleItemsData[i].effect_value
				GloblePlayerData.xiang[xiangId] = GloblePlayerData.xiang[xiangId] + GlobleItemsData[i].amount
			end
			
			if GlobleItemsData[i].type == 3 and GlobleItemsData[i].effect_type == 18 then
				GloblePlayerData.skill_reset_operator = GloblePlayerData.skill_reset_operator + GlobleItemsData[i].amount
			end
			
			if GlobleItemsData[i].type == 4 and GlobleItemsData[i].effect_type == 9 then
				local new = true
				for j = 1 , table.getn(GloblePlayerData.baoshi) do
					if GlobleItemsData[i].name == GloblePlayerData.baoshi[j].name then
						GloblePlayerData.baoshi[j].amount = GloblePlayerData.baoshi[j].amount + GlobleItemsData[i].amount
						new = false
					end
				end
				
				if new then
					GloblePlayerData.baoshi[table.getn(GloblePlayerData.baoshi)+1] = {
						name = GlobleItemsData[i].name,
						amount = GlobleItemsData[i].amount,
						cfg_item_id = GlobleItemsData[i].cfg_item_id,
						quality = GlobleItemsData[i].quality,
						effect = GlobleItemsData[i].effect_value,
						icon = GlobleItemsData[i].icon,
					}
				end
			end
		end
	end
end

function getSkillAwalenTableForJob(job)
	return {}
end

function mappedPlayerSkillData(s)
	local general = findGeneralByGeneralId(s:getByKey("general_id"):asInt())
	general.skill_point = public_ternaryOperation(s:getByKey("skill_point"):asInt() ~= nil, s:getByKey("skill_point"):asInt(),general.skill_point)
	general.skills = new({})
	if s:getByKey("skills"):size() > 0 then			
		for j = 1 , s:getByKey("skills"):size() do
			local skillIdx = j - 1
			local skill = s:getByKey("skills"):getByIndex(skillIdx)
			general.skills[j] = new({})
			general.skills[j].cfg_skill_id = 	skill:getByKey("cfg_skill_id"):asInt()
			general.skills[j].idx = 			skill:getByKey("idx"):asInt()
			general.skills[j].level =	 		skill:getByKey("level"):asInt()
			general.skills[j].is_lock = 		skill:getByKey("is_lock"):asBool()
		end
	end			
end

findGeneralSkillBySkillId = function(general,id)
	for i = 1 , table.getn(general.skills) do
		if general.skills[i].cfg_skill_id == id then
			return general.skills[i]
		end
	end
	return 0
end
findGeneralSkillByIdx = function(general,idx)
	for i = 1 , table.getn(general.skills) do
		if general.skills[i].idx == idx then
			return general.skills[i]
		end
	end
	return 0
end

function mappedPlayerFormations(s)
	GloblePlayerData.formations = new({})
	for i = 1 , s:getByKey("formations"):size() do
		local idx = i - 1		
		
		local formation = s:getByKey("formations"):getByIndex(idx)
			
		GloblePlayerData.formations[i] = new({})		
		GloblePlayerData.formations[i].pos = new({})		
		GloblePlayerData.formations[i].pos[1] = formation:getByKey("pos_1"):asInt()
		GloblePlayerData.formations[i].pos[2] = formation:getByKey("pos_2"):asInt()
		GloblePlayerData.formations[i].pos[3] = formation:getByKey("pos_3"):asInt()
		GloblePlayerData.formations[i].pos[4] = formation:getByKey("pos_4"):asInt()
		GloblePlayerData.formations[i].pos[5] = formation:getByKey("pos_5"):asInt()
		GloblePlayerData.formations[i].pos[6] = formation:getByKey("pos_6"):asInt()
		GloblePlayerData.formations[i].pos[7] = formation:getByKey("pos_7"):asInt()
		GloblePlayerData.formations[i].pos[8] = formation:getByKey("pos_8"):asInt()
		GloblePlayerData.formations[i].pos[9] = formation:getByKey("pos_9"):asInt()
		
		GloblePlayerData.formations[i].level = formation:getByKey("level"):asInt()
		GloblePlayerData.formations[i].is_default = formation:getByKey("is_default"):asBool()
		GloblePlayerData.formations[i].cfg_formation_id = formation:getByKey("cfg_formation_id"):asInt()
		
		if GloblePlayerData.formations[i].is_default then
			GloblePlayerData.cur_formation = GloblePlayerData.formations[i].cfg_formation_id
			if GlobalCurZhenFa == nil then
				GlobalCurZhenFa = i
			end
		end
	end
end

findFormationsById = function(id)
	for i = 1 , table.getn(GloblePlayerData.formations) do
		if GloblePlayerData.formations[i].cfg_formation_id == id then
			return GloblePlayerData.formations[i]
		end
	end
	return 0
end

function mappedPlayerRoleData(s)	
	GloblePlayerData.vip_level = s:getByKey("vip_level"):asInt()
	GloblePlayerData.nation = NATION[s:getByKey("nation"):asInt() + 1]
	GloblePlayerData.nationId = s:getByKey("nation"):asInt()
	GloblePlayerData.officium = s:getByKey("officium"):asInt()
	GloblePlayerData.role_name = s:getByKey("name"):asString()
	GloblePlayerData.fight_power = s:getByKey("fight_power"):asInt()
	
	GloblePlayerData.pool = s:getByKey("pool"):asInt()
	GloblePlayerData.barn = s:getByKey("barn"):asInt()
	GloblePlayerData.prestige = s:getByKey("prestige"):asInt()
	GloblePlayerData.action_point = s:getByKey("action_point"):asInt()	
	GloblePlayerData.vip_charge = s:getByKey("vip_charge"):asInt()
	GloblePlayerData.gold = s:getByKey("gold"):asInt()
	GloblePlayerData.exploit = s:getByKey("exploit"):asInt()
	GloblePlayerData.ap_wand = s:getByKey("ap_wand"):asInt()
	GloblePlayerData.fame = s:getByKey("fame"):asInt()
	GloblePlayerData.arena_rank = s:getByKey("arena_rank"):asInt()
	GloblePlayerData.forge_cooldown = s:getByKey("forge_cooldown"):asInt()
	GloblePlayerData.forge_refresh_time = os.time()

	GloblePlayerData.step = public_ternaryOperation(s:getByKey("step"):asInt() ~= nil,s:getByKey("step"):asInt(),GloblePlayerData.step)
	GloblePlayerData.is_raid_sweep = s:getByKey("is_raid_sweep"):asBool()
	GloblePlayerData.ph_worship_left_count = s:getByKey("ph_worship_left_count"):asInt()	--今天排行榜崇拜剩余次数
	globalUpdateRoleCellCount(s)
end

function mappedPlayerGeneralData(s)
	GloblePlayerData.gold = public_ternaryOperation( s:getByKey("gold"):asInt() ~= nil, s:getByKey("gold"):asInt() , GloblePlayerData.gold)
	GloblePlayerData.exploit = public_ternaryOperation( s:getByKey("exploit"):asInt() ~= nil , s:getByKey("exploit"):asInt() , GloblePlayerData.exploit)
	GloblePlayerData.copper = public_ternaryOperation( s:getByKey("copper"):asInt() ~= nil, s:getByKey("copper"):asInt() , GloblePlayerData.copper)

	GloblePlayerData.generals = new({})
	
	for i = 1 , s:getByKey("generals"):size() do
		local idx = i-1
		if not GloblePlayerData.generals[i] then		--增加更新人物时判断，防止保存的general无效
			GloblePlayerData.generals[i] = new({})
		end
		GloblePlayerData.generals[i].index = i
		GloblePlayerData.generals[i].skills	= new({})
		
		local general = s:getByKey("generals"):getByIndex(idx)
		GloblePlayerData.generals[i].general_id = general:getByKey("general_id"):asInt()
		
		GloblePlayerData.generals[i].skills = new({})
		if general:getByKey("skills"):size() > 0 then			
			for j = 1 , general:getByKey("skills"):size() do
				local skillIdx = j - 1
				local skill = general:getByKey("skills"):getByIndex(skillIdx)
				GloblePlayerData.generals[i].skills[j] = new({})
				GloblePlayerData.generals[i].skills[j].cfg_skill_id = 	skill:getByKey("cfg_skill_id"):asInt()
				GloblePlayerData.generals[i].skills[j].idx = 			skill:getByKey("idx"):asInt()
				GloblePlayerData.generals[i].skills[j].level =	 		skill:getByKey("level"):asInt()
				GloblePlayerData.generals[i].skills[j].is_lock = 		skill:getByKey("is_lock"):asBool()
			end
		end			

		GloblePlayerData.generals[i].cfg_general_id	=	general:getByKey("cfg_general_id"):asInt()				--
		GloblePlayerData.generals[i].name			=	general:getByKey("name"):asString()						--
		GloblePlayerData.generals[i].job			=	general:getByKey("job"):asInt()							--				--职业id
		GloblePlayerData.generals[i].is_god			=	general:getByKey("is_god"):asBool()						--				--是否是神将
		GloblePlayerData.generals[i].is_role		=	general:getByKey("is_role"):asBool()					--				--是否是主角
		GloblePlayerData.generals[i].is_del			=	false													--				--是否被下野
		
		GloblePlayerData.generals[i].face			=	general:getByKey("face"):asInt()						--				--頭像
		GloblePlayerData.generals[i].figure			=	general:getByKey("figure"):asInt()						--				--大頭像

		GloblePlayerData.generals[i].level			=	general:getByKey("level"):asInt()						--					--等级
		GloblePlayerData.generals[i].health_point_max=	general:getByKey("health_point_max"):asInt()			--					--生命上限
		GloblePlayerData.generals[i].health_point	=	general:getByKey("health_point"):asInt()				--					--当前生命
		GloblePlayerData.generals[i].experience		=	general:getByKey("experience"):asInt()					--					--经验值
		GloblePlayerData.generals[i].skill_point	=	general:getByKey("skill_point"):asInt()					--					--技能点
						
		GloblePlayerData.generals[i].reincarnate	=	general:getByKey("reincarnate"):asInt()					--					--轉生次数
		GloblePlayerData.generals[i].quality		=	general:getByKey("quality"):asInt()						--					--宠物品質
						
		GloblePlayerData.generals[i].physical_attack=	general:getByKey("physical_attack"):asInt()				--					--物理攻击
		GloblePlayerData.generals[i].physical_defence=	general:getByKey("physical_defence"):asInt()			--					--物理防御
						
		GloblePlayerData.generals[i].spell_attack	=	general:getByKey("spell_attack"):asInt()				--					--法术攻击
		GloblePlayerData.generals[i].spell_defence	=	general:getByKey("spell_defence"):asInt()				--					--法术防御
						
		GloblePlayerData.generals[i].speed			=	general:getByKey("speed"):asInt()						--					--速度
		GloblePlayerData.generals[i].critic			=	general:getByKey("critic"):asInt()						--					--暴击
		GloblePlayerData.generals[i].tough			=	general:getByKey("tough"):asInt()						--					--韧性		
		GloblePlayerData.generals[i].hit			=	general:getByKey("hit"):asInt()							--					--命中
		GloblePlayerData.generals[i].dodge			=	general:getByKey("dodge"):asInt()						--					--闪避
		GloblePlayerData.generals[i].unblock		=	general:getByKey("unblock"):asInt()							--					--破击
		GloblePlayerData.generals[i].block			=	general:getByKey("block"):asInt()						--					--格挡
								
		GloblePlayerData.generals[i].amulet			=	general:getByKey("amulet"):asInt()						--					--護身符
		GloblePlayerData.generals[i].horse			=	general:getByKey("horse"):asInt()						--					--馬
		GloblePlayerData.generals[i].armor			=	general:getByKey("armor"):asInt()						--					--衣服
		GloblePlayerData.generals[i].cloak			=	general:getByKey("cloak"):asInt()						--					--手套
		GloblePlayerData.generals[i].misc			=	general:getByKey("misc"):asInt()						--					--帽子
		GloblePlayerData.generals[i].weapon			=	general:getByKey("weapon"):asInt()						--					--武器
		
		GloblePlayerData.generals[i].mem_soul_1		=	general:getByKey("mem_soul_1"):asInt()					--					--主星魂
		GloblePlayerData.generals[i].mem_soul_2		=	general:getByKey("mem_soul_2"):asInt()					--					,
		GloblePlayerData.generals[i].mem_soul_3	    =	general:getByKey("mem_soul_3"):asInt()					--					,
	    GloblePlayerData.generals[i].mem_soul_4		=	general:getByKey("mem_soul_4"):asInt()					--					--主星魂
		GloblePlayerData.generals[i].mem_soul_5		=	general:getByKey("mem_soul_5"):asInt()					--					,
		GloblePlayerData.generals[i].mem_soul_6  	=	general:getByKey("mem_soul_6"):asInt()					--					,
		
		GloblePlayerData.generals[i].strength		=	general:getByKey("strength"):asDouble()					--					--力量数值
		GloblePlayerData.generals[i].str_grow		=	general:getByKey("str_grow"):asInt()					--					--力量成长
		GloblePlayerData.generals[i].temp_str_grow	=	general:getByKey("temp_str_grow"):asInt()			--					--力量培养臨时数值
		
		GloblePlayerData.generals[i].intellect		=	general:getByKey("intellect"):asDouble()				--					智力,
		GloblePlayerData.generals[i].int_grow		=	general:getByKey("int_grow"):asInt()					--					,				
		GloblePlayerData.generals[i].temp_int_grow	=	general:getByKey("temp_int_grow"):asInt()			--					,	
		
		GloblePlayerData.generals[i].stamina		=	general:getByKey("stamina"):asDouble()					--					耐力,	
		GloblePlayerData.generals[i].sta_grow		=	general:getByKey("sta_grow"):asInt()					--					,	
		GloblePlayerData.generals[i].temp_sta_grow	=	general:getByKey("temp_sta_grow"):asInt()			--					,	

		GloblePlayerData.generals[i].agility		=	general:getByKey("agility"):asDouble()					--					敏捷,	
		GloblePlayerData.generals[i].agi_grow		=	general:getByKey("agi_grow"):asInt()					--					,	
		GloblePlayerData.generals[i].temp_agi_grow	=	general:getByKey("temp_agi_grow"):asInt()			--					,	
		
		if GloblePlayerData.generals[i].is_role then
			GloblePlayerData.role_job = GloblePlayerData.generals[i].job
			GloblePlayerData.role_face = GloblePlayerData.generals[i].face
			GloblePlayerData.roleIndex = i
			--GloblePanel.curGenerals = i
		end
	end
end

checkUpRoleIndex = function ()
	for i = 1 , table.getn(GloblePlayerData.generals) do
		GloblePlayerData.generals[i].index = i
		if GloblePlayerData.generals[i].is_role then
			GloblePlayerData.roleIndex = i
			GloblePanel.curGenerals = i
		end
	end
end

findGeneralByGeneralId = function(id)
	local generals = GloblePlayerData.generals
	for i = 1 , table.getn(generals) do
		if generals[i].general_id == id then
			return GloblePlayerData.generals[i]
		end
	end
	return 0
end
findGeneralIndexByGeneralId = function(id)
	local generals = GloblePlayerData.generals
	for i = 1 , table.getn(generals) do
		if generals[i].general_id == id then
			return i
		end
	end
	return 0
end
function mappedItemData(s)
	GloblePlayerData.items = nil
	GloblePlayerData.items = new({})
	if s:getByKey("items"):size() > 0 then	
		for i = 1 , s:getByKey("items"):size() do
			local idx = i - 1
			GloblePlayerData.items[i] = new({})
				
			GloblePlayerData.items[i].item_id = s:getByKey("items"):getByIndex(idx):getByKey("item_id"):asInt()
			GloblePlayerData.items[i].cfg_item_id = s:getByKey("items"):getByIndex(idx):getByKey("cfg_item_id"):asInt()
			GloblePlayerData.items[i].star = s:getByKey("items"):getByIndex(idx):getByKey("star"):asInt()
			GloblePlayerData.items[i].equiped = s:getByKey("items"):getByIndex(idx):getByKey("equiped"):asBool()
			GloblePlayerData.items[i].amount = s:getByKey("items"):getByIndex(idx):getByKey("amount"):asInt()
			GloblePlayerData.items[i].hole1 = s:getByKey("items"):getByIndex(idx):getByKey("hole1"):asInt()
			GloblePlayerData.items[i].hole2 = s:getByKey("items"):getByIndex(idx):getByKey("hole2"):asInt()
			GloblePlayerData.items[i].hole3 = s:getByKey("items"):getByIndex(idx):getByKey("hole3"):asInt()
			GloblePlayerData.items[i].hole4 = s:getByKey("items"):getByIndex(idx):getByKey("hole4"):asInt()
			GloblePlayerData.items[i].hole5 = s:getByKey("items"):getByIndex(idx):getByKey("hole5"):asInt()
			GloblePlayerData.items[i].hole6 = s:getByKey("items"):getByIndex(idx):getByKey("hole6"):asInt()			
		end
	end
	
	mappedItemDataToTable(GloblePlayerData.items)
end
findItemByItemId = function(id)
	for i = 1 , table.getn(GlobleItemsData) do
		if GlobleItemsData[i].item_id == id and GlobleItemsData[i].id ~= 0 then
			return GlobleItemsData[i]
		end
	end
	return 0
end

findItemsByItemCfgId = function(id)
	for i = 1 , table.getn(GlobleItemsData) do
		if GlobleItemsData[i].cfg_item_id == id and GlobleItemsData[i].amount < GlobleItemsData[i].max_count and GlobleItemsData[i].id ~= 0 then
			return GlobleItemsData[i]
		end
	end
	
	return 0
end

findItemsByItemCfgId1 = function(id)
	for i = 1 , table.getn(GlobleItemsData) do
		if GlobleItemsData[i].cfg_item_id == id and GlobleItemsData[i].id ~= 0 then
			return GlobleItemsData[i]
		end
	end
	
	return 0
end

findItemListByItemCfgId = function(id)
	local list = {}
	for i = 1 , table.getn(GlobleItemsData) do
		if GlobleItemsData[i].cfg_item_id == id  and GlobleItemsData[i].id ~= 0 then
			table.insert(list,GlobleItemsData[i])
		end
	end
	return list
end

function mappedPlayerBaseAttribute(general,s)
	if general ~= nil and general ~= 0 then
		general.level					=	(s:getByKey("level"):asInt() ~= nil and s:getByKey("level"):asInt() ~= 0) and s:getByKey("level"):asInt() or general.level			--					--等级
		general.health_point_max		=	s:getByKey("health_point_max"):asInt()									--						--生命上限
		general.health_point			=	s:getByKey("health_point"):asInt()										--					--当前生命
		general.experience				=	(s:getByKey("experience"):asInt() ~= nil and s:getByKey("experience"):asInt() ~= 0) and s:getByKey("experience"):asInt() or general.experience			--					--经验值
		general.skill_point				=	public_ternaryOperation(s:getByKey("skill_point"):asInt() ~= nil,s:getByKey("skill_point"):asInt(),general.skill_point)        							--					--技能点
		general.reincarnate				=	(s:getByKey("reincarnate"):asInt() ~= nil and s:getByKey("reincarnate"):asInt() ~= 0) and s:getByKey("reincarnate"):asInt() or general.reincarnate		--					--轉生次数
		general.quality					=	(s:getByKey("quality"):asInt() ~= nil and s:getByKey("quality"):asInt() ~= 0 ) and s:getByKey("quality"):asInt() or general.quality						--					--宠物品質				
		general.physical_attack			=	s:getByKey("physical_attack"):asInt()			--					--物理攻击
		general.physical_defence		=	s:getByKey("physical_defence"):asInt()			--					--物理防御				
		general.spell_attack			=	s:getByKey("spell_attack"):asInt()				--					--法术攻击
		general.spell_defence			=	s:getByKey("spell_defence"):asInt()				--					--法术防御				
		general.speed					=	s:getByKey("speed"):asInt()						--					--速度
		general.critic					=	s:getByKey("critic"):asInt()					--					--暴击
		general.hit						=	s:getByKey("hit"):asInt()						--					--命中
		general.dodge					=	s:getByKey("dodge"):asInt()						--					--闪避
		general.block					=	s:getByKey("block"):asInt()						--					--格挡
		general.unblock					=	s:getByKey("unblock"):asInt()					--					--破击
		general.tough					=	s:getByKey("tough"):asInt()						--					--韧性
	end
end

--训练后主属性增加
function mappedPlayerTrainAdd(general,s)
	if general ~= nil and general ~= 0 then
		general.strength		=	s:getByKey("strength"):asInt()
		general.agility			=	s:getByKey("agility"):asInt()
		general.stamina			=	s:getByKey("stamina"):asInt()
		general.intellect		=	s:getByKey("intellect"):asInt()
	end
end

function mappedPlayerPolishConfirmSimple(s)
	local id = s:getByKey("general_id"):asInt()			--宠物id
	local general = findGeneralByGeneralId(id)
	
	mappedPlayerBaseAttribute(general,s)
end

function mappedPlayerPolishSimpleData(s)
	local id = s:getByKey("generalId"):asInt()			--宠物id
	local general = findGeneralByGeneralId(id)
	
	general.temp_int_grow = s:getByKey("temp_int_grow"):asInt()	
	general.temp_agi_grow = s:getByKey("temp_agi_grow"):asInt()	
	general.temp_sta_grow = s:getByKey("temp_sta_grow"):asInt()	
	general.temp_str_grow = s:getByKey("temp_str_grow"):asInt()
	
	GloblePlayerData.copper = s:getByKey("copper"):asInt()
	GloblePlayerData.gold = s:getByKey("gold"):asInt()
end

function mappedPlayerEquipData(general,s)
	if general.amulet ~= 0 then
		local item = findItemByItemId(general.amulet)
		item.isEquip = false
	end
	
	if general.horse ~= 0 then
		local item = findItemByItemId(general.horse)
		item.isEquip = false
	end
	
	if general.armor ~= 0 then
		local item = findItemByItemId(general.armor)
		item.isEquip = false
	end
	
	if general.cloak ~= 0 then
		local item = findItemByItemId(general.cloak)
		item.isEquip = false
	end
	
	if general.misc ~= 0 then
		local item = findItemByItemId(general.misc)
		item.isEquip = false
	end
	
	if general.weapon ~= 0 then
		local item = findItemByItemId(general.weapon)
		item.isEquip = false
	end
	
	general.amulet			=	s:getByKey("amulet"):asInt()
	general.horse			=	s:getByKey("horse"):asInt()
	general.armor			=	s:getByKey("amor"):asInt()
	general.cloak			=	s:getByKey("cloak"):asInt()
	general.misc			=	s:getByKey("misc"):asInt()
	general.weapon			=	s:getByKey("weapon"):asInt()
	
	if general.amulet ~= 0 then
		local item = findItemByItemId(general.amulet)
		item.isEquip = true
	end
	
	if general.horse ~= 0 then
		local item = findItemByItemId(general.horse)
		item.isEquip = true
	end
	
	if general.armor ~= 0 then
		local item = findItemByItemId(general.armor)
		item.isEquip = true
	end
	
	if general.cloak ~= 0 then
		local item = findItemByItemId(general.cloak)
		item.isEquip = true
	end
	
	if general.misc ~= 0 then
		local item = findItemByItemId(general.misc)
		item.isEquip = true
	end
	
	if general.weapon ~= 0 then
		local item = findItemByItemId(general.weapon)
		item.isEquip = true
	end
end

--获取物品请求服务器操作
needRefreshItems = false

function ItemSimple(id,show,isreward)
	local ids = {}
	
	for i = 1 , table.getn(id) do
		if id[i] ~= 0 then
			table.insert(ids,id[i])
		end
	end
	
	--OPT_ItemSimple
	local count = 0
	local function opItemSimpleFinishCB(s)
		--closeWait()
		local error_code = s:getByKey("error_code"):asInt()		
		if error_code > 0 then
			Log("opItemSimpleFinishCB error_code  "..error_code)
		else	
			local items = {
				cfg_item_id = s:getByKey("cfg_item_id"):asInt(),
				amount  = s:getByKey("amount"):asInt(),
				equiped  = s:getByKey("equiped"):asBool(),
				item_id	 = s:getByKey("item_id"):asInt(),
				star = s:getByKey("star"):asInt(),
				id = math.random(2,4),
				hole1 = 0,
				hole2 = 0,
				hole3 = 0,
				hole4 = 0,
				hole5 = 0,
				hole6 = 0,				
			}
			local item = mappedItemSingle(items)
			local i = table.getn(GlobleItemsData) + 1
			GlobleItemsData[i] = new(item)

			count = count + 1
			
			if count >= table.getn(ids) then
				needRefreshItems = true
				updateSpecialItemData()
			end
			checkBaoguoCapacityEnough()		--获得物品，检查背包状态	
			if show ~= nil and show then
				local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
				local iteminfo = itemJsonConfig:getByKey(items.cfg_item_id)
				local name = iteminfo:getByKey("name"):asString()
				if isreward~=nil  then
					if isreward==3 then
						local dialog = ShowReward("新手礼包：".."\n".."恭喜获得了"..name, function()
							StartUserGuide("open_gift_1")
						end)
						dialog.autoClose = false
						GlobleShowXinShouLiBaoOkClickGuide(dialog.closeBtn)
					elseif isreward==2 then
						ShowReward("活跃度奖励：".."\n".."恭喜获得了"..name)
					else
						ShowReward("恭喜获得了"..name)
					end
				else
					alert("恭喜获得了"..name)
				end
			end
		end
	end	
	
	local function execItemSimple()		
		local action = Net.OPT_ItemSimple
		
		NetMgr:registOpLuaFinishedCB(action, opItemSimpleFinishCB)
		NetMgr:registOpLuaFailedCB(action, opFailedCB)
		--showWaitDialog()

		for i = 1 , table.getn(ids) do
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("item_id", ids[i])
			NetMgr:executeOperate(action, cj)
		end		
	end
	
	execItemSimple()
end

function mappedPlayerGetItemData(s,s1)
	local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
	local temp_count = 0
	local ids = {}
	for i = 1 , s:size() do
		local idx = i - 1 
		local item = s:getByIndex(idx)
		
		--如果 使用道具获得的是银币 战功 或者 金币 則直接添加值
		local type = item:getByKey("type"):asInt()
		local value = item:getByKey("value"):asInt()
		if type == 0 then			
			GloblePlayerData.copper = GloblePlayerData.copper + value
			updataHUDData()
			alert("获得银币"..value)
		elseif type == 1 then
			GloblePlayerData.gold = GloblePlayerData.gold + value
			updataHUDData()
			alert("获得金币"..value)
		elseif type == 2 then
			GloblePlayerData.exploit = GloblePlayerData.exploit + value
			alert("获得战功"..value)
		elseif type == 3 then
			GloblePlayerData.prestige = GloblePlayerData.prestige + value
			alert("获得神力"..value)
		elseif type == 4 then
			GloblePlayerData.prestige = GloblePlayerData.prestige + value
			alert("获得神力"..value)
		elseif type == 5 then			
			GloblePlayerData.action_point = GloblePlayerData.action_point + value
			alert("获得"..value.."点精力")
		elseif type == 6 then
			alert("获得"..value.."个经验丹")
		elseif type == 7 then
			GloblePlayerData.pool = GloblePlayerData.pool + value
			alert("获得生命池存储"..value)
		elseif type == 8 then
			alert("获得"..value.."瓶朗姆酒")
			GloblePlayerData.ap_wand = GloblePlayerData.ap_wand + value
		elseif type == 9 then
			local cfg_general_epic_json = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_general_epic.json")
			--local data = cfg_general_epic_json:getByKey(value)
			local data = cfg_general_epic_json:getByKey("10000")
			local msg = "获得宠物"..data:getByKey("name"):asString()..",请到招募中的神宠图鉴处召回"
			alertOK(msg,{
				clickOK = globalZhaoMuMJPanel2,
				clickParams = {
					{
						general_id		=	value,
						cfg_general_id	=	10000
					}
				}
			})
		elseif type == 10 then
			alert("获得通靈值"..value)
		elseif type == 14 then
			alert("获得经验丹"..value)
		elseif type == 15 then
			alert("获得朗姆酒"..value)
		elseif type == 101 then
			GloblePlayerData.copper = GloblePlayerData.copper + value
			updataHUDData()
			alert("获得银币"..value)
		elseif type == 102 then
			GloblePlayerData.copper = GloblePlayerData.copper + value
			updataHUDData()
			alert("获得银币"..value)
		else			
			local item = findItemsByItemCfgId(type)
			local id = 0
			
			if item ~= 0 then
				if item.amount + value < item.max_count then
					item.amount = item.amount + value
				else
					if item.effect_type ~= 11 then
						item.amount = item.max_count
					else
						item.id = 0
					end
				end
			end	
			local iteminfo = itemJsonConfig:getByKey(type)
			local name = iteminfo:getByKey("name"):asString()
			alert("恭喜获得了"..name)
		end
	end
	
	local add_list = s1
	for i = 1 , add_list:size() do
		ids[i] = add_list:getByIndex(i-1):asInt()
	end
	
	if table.getn(ids) > 0 then
		ItemSimple(ids)
	else
		needRefreshItems = true
	end
	updateSpecialItemData()
end

function mappedPlayerUsingSimpleData(s,id)
	local general = findGeneralByGeneralId(id)	
	mappedPlayerBaseAttribute(general,s:getByKey("general_base_data"))
	mappedPlayerEquipData(general,s:getByKey("equipment_data"))
	
	if s:getByKey("result_list"):size() > 0 then
		mappedPlayerGetItemData(s:getByKey("result_list"),s:getByKey("add_item_id_list"))
	end
	needRefreshItems = true
end

wuHunUsing = {}
function getWunHunInfo(json)
	set_general_list(json:getByKey("general_list"))
	local general = findGeneralByGeneralId(json:getByKey("general_id"):asInt())
	if(general ~= 0)then
		mappedPlayerBaseAttribute(general,json)
		general.mem_soul_1 = json:getByKey("mem_soul_1"):asInt()
		general.mem_soul_2 = json:getByKey("mem_soul_2"):asInt()
		general.mem_soul_3 = json:getByKey("mem_soul_3"):asInt()
		general.mem_soul_4 = json:getByKey("mem_soul_4"):asInt()
		general.mem_soul_5 = json:getByKey("mem_soul_5"):asInt()
		general.mem_soul_6 = json:getByKey("mem_soul_6"):asInt()
		--Log(general.name)
		--Log("mem_soul_1:"..general.mem_soul_1.."\n".."mem_soul_2:"..general.mem_soul_2.."\n".."mem_soul_3:"..general.mem_soul_3.."\n".."mem_soul_4"..general.mem_soul_4.."\n".."mem_soul_5"..general.mem_soul_5.."\n".."mem_soul_6"..general.mem_soul_6.."\n")
	end
	local soul_list = json:getByKey("soul_list")
	local count = 1
	local usingCount = 1
	wuHunInfo = new ({})
	wuHun_equiped_list = new ({})
	local soul_json_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_soul.json")
	for i = 1 , soul_list:size() do
		if soul_list:getByIndex(i-1):getByKey("equiped"):asBool() then
			local data  = soul_json_cfg:getByKey(tostring(soul_list:getByIndex(i-1):getByKey("cfg_soul_id"):asInt()))
			--------------------------------装备中----------------------------------------------------
			wuHun_equiped_list[usingCount] =
			{
				--------------------------------非装备中----------------------------------------------------
				--------------------------------服务器得到的数據----------------------------------------------------
				soul_id = soul_list:getByIndex(i-1):getByKey("soul_id"):asInt(),
				cfg_soul_id = soul_list:getByIndex(i-1):getByKey("cfg_soul_id"):asInt(),
				level = soul_list:getByIndex(i-1):getByKey("level"):asInt(),
				experience = soul_list:getByIndex(i-1):getByKey("experience"):asInt(),
				equiped = soul_list:getByIndex(i-1):getByKey("equiped"):asBool(),
				--------------------------------服务器得到的数據----------------------------------------------------
				ability_base = data:getByKey("ability_base"):asInt(),
				ability_grow =data:getByKey("ability_grow"):asInt(),
				ability_type =data:getByKey("ability_type"):asInt(),
				eat_exp =data:getByKey("eat_exp"):asInt(),
				icon =data:getByKey("icon"):asInt(),
				level_param =data:getByKey("level_param"):asInt(),
				name =data:getByKey("name"):asString(),
				quality =data:getByKey("quality"):asInt(),
				sell_price =data:getByKey("sell_price"):asInt(),
			}
			usingCount = usingCount+1
			
		else
			local data  = soul_json_cfg:getByKey(tostring(soul_list:getByIndex(i-1):getByKey("cfg_soul_id"):asInt()))

			wuHunInfo[count] =
			{
				--------------------------------非装备中----------------------------------------------------
				--------------------------------服务器得到的数據----------------------------------------------------
				soul_id = soul_list:getByIndex(i-1):getByKey("soul_id"):asInt(),
				cfg_soul_id = soul_list:getByIndex(i-1):getByKey("cfg_soul_id"):asInt(),
				level = soul_list:getByIndex(i-1):getByKey("level"):asInt(),
				experience = soul_list:getByIndex(i-1):getByKey("experience"):asInt(),
				equiped = soul_list:getByIndex(i-1):getByKey("equiped"):asBool(),
				--------------------------------服务器得到的数據----------------------------------------------------
				ability_base = data:getByKey("ability_base"):asInt(),
				ability_grow =data:getByKey("ability_grow"):asInt(),
				ability_type =data:getByKey("ability_type"):asInt(),
				eat_exp =data:getByKey("eat_exp"):asInt(),
				icon =data:getByKey("icon"):asInt(),
				level_param =data:getByKey("level_param"):asInt(),
				name =data:getByKey("name"):asString(),
				quality =data:getByKey("quality"):asInt(),
				sell_price =data:getByKey("sell_price"):asInt(),
			}
			count = count+1
		end
	end
	--Log("getWunHunInfo:usingCount:"..usingCount)
end

function set_general_list(general_list)
	for i =1 ,  general_list:size() do
		GloblePlayerData.generals[i].general_id = general_list:getByIndex(i-1):getByKey("general_id"):asInt()
		--[[GloblePlayerData.generals[i].main_soul = general_list:getByIndex(i-1):getByKey("main_soul"):asInt()
		GloblePlayerData.generals[i].tert_soul = general_list:getByIndex(i-1):getByKey("tert_soul"):asInt()
		GloblePlayerData.generals[i].vice_soul = general_list:getByIndex(i-1):getByKey("vice_soul"):asInt()
		--]]
		GloblePlayerData.generals[i].mem_soul_1 = general_list:getByIndex(i-1):getByKey("mem_soul_1"):asInt()
		GloblePlayerData.generals[i].mem_soul_2 = general_list:getByIndex(i-1):getByKey("mem_soul_2"):asInt()
		GloblePlayerData.generals[i].mem_soul_3 = general_list:getByIndex(i-1):getByKey("mem_soul_3"):asInt()
		GloblePlayerData.generals[i].mem_soul_4 = general_list:getByIndex(i-1):getByKey("mem_soul_4"):asInt()
		GloblePlayerData.generals[i].mem_soul_5 = general_list:getByIndex(i-1):getByKey("mem_soul_5"):asInt()
		GloblePlayerData.generals[i].mem_soul_6 = general_list:getByIndex(i-1):getByKey("mem_soul_6"):asInt()
	end
end

function mappedPlayerTrainSingleData(train,s)
	train.generalId			=	s:getByKey("generalId"):asInt()
	local general = findGeneralByGeneralId(train.generalId)
	
	train.training_end		=	s:getByKey("training_end"):asDouble()
	train.level				=	s:getByKey("level"):asInt()
	train.training_ratio	=	s:getByKey("training_ratio"):asDouble()
	train.training_type		=	s:getByKey("training_type"):asInt()
	train.experience		=	s:getByKey("experience"):asInt()
	
	if general.level ~= nil and train.level > general.level then
		train.needShowLevelUp	=	true
		general.level = train.level
	end
end

findTrainByGeneralId = function(id)
	for i = 1 , table.getn(GloblePlayerData.trainings.training_list) do
		if GloblePlayerData.trainings.training_list[i].generalId == id then
			print(GloblePlayerData.trainings.training_list[i].generalId,"GloblePlayerData.trainings.training_list[i].generalId")
			return GloblePlayerData.trainings.training_list[i]
		end
	end
	
	return 0
end
--是否出战
function generalIsInFormation(general_id)
	local formation = returnFormationInfo(GloblePlayerData.formations[GlobalCurZhenFa])	
	for i = 1 , table.getn(formation.pos) do
		if formation.pos[i] == general_id then
			return true
		end
	end
	return false
end

function mappedPlayerTrainSimpleData(s)
	local generalId	= s:getByKey("generalId"):asInt()
	local train = findTrainByGeneralId(generalId)
	if train ~= 0 then
		mappedPlayerTrainSingleData(train,s)
		local general = findGeneralByGeneralId(generalId)
		mappedPlayerBaseAttribute(general,s)
		mappedPlayerTrainAdd(general,s)
	end
	
	GloblePlayerData.copper							=	s:getByKey("copper"):asDouble()
	GloblePlayerData.gold							=	s:getByKey("gold"):asDouble()
	GloblePlayerData.exploit						=	s:getByKey("exploit"):asInt() 
		
	GloblePlayerData.trainings.jump_wand			=	s:getByKey("jump_wand") :asInt() 
	GloblePlayerData.trainings.jump_enable			=	s:getByKey("jump_enable"):asBool() 	
	GloblePlayerData.trainings.training_slot		=	s:getByKey("training_slot"):asInt() 
	GloblePlayerData.trainings.jump_cooldown		=	s:getByKey("jump_cooldown"):asDouble() 
	GloblePlayerData.trainings.server_time			=	s:getByKey("server_time"):asDouble() 
	GloblePlayerData.trainings.training_experience 	=	s:getByKey("training_experience"):asInt() 
end

function initPlayerTrainData(s)
	GloblePlayerData.trainings = nil
	GloblePlayerData.trainings = new({})	
	GloblePlayerData.trainings.training_list = new ({})
		
	local training_list = s:getByKey("training_list")
	for i = 1 , training_list:size() do
		local idx = i - 1
		GloblePlayerData.trainings.training_list[i] = new({})
		
		mappedPlayerTrainSingleData(GloblePlayerData.trainings.training_list[i],training_list:getByIndex(idx))
	end 
		
	GloblePlayerData.copper							=	s:getByKey("copper"):asDouble()
	GloblePlayerData.gold							=	s:getByKey("gold"):asDouble()
	GloblePlayerData.exploit						=	s:getByKey("exploit"):asInt() 
	
	GloblePlayerData.trainings.jump_wand			=	s:getByKey("jump_wand") :asInt() 
	GloblePlayerData.trainings.jump_enable			=	s:getByKey("jump_enable"):asBool() 	
	GloblePlayerData.trainings.training_slot		=	s:getByKey("training_slot"):asInt() 
	GloblePlayerData.trainings.jump_cooldown		=	s:getByKey("jump_cooldown"):asDouble() 
	GloblePlayerData.trainings.server_time			=	s:getByKey("server_time"):asDouble() 
	GloblePlayerData.trainings.training_experience 	=	s:getByKey("training_experience"):asInt() 
end

function campRewardGetItems(items,s,amounts,isreward)
	local ids = {}
	local temp_count = 0
	
	for i = 1 , table.getn(items) do
		local type = items[i]
		local value = 1
		
		if amounts ~= nil and amounts[i] ~= nil then
			value = amounts[i]
		end
		
		if type ~= 0 then
			local item = findItemsByItemCfgId(type)
			
			if item ~= 0 then
				if item.amount + value < item.max_count then
					item.amount = item.amount + value
				else
					if item.effect_type ~= 11 then
						item.amount = item.max_count
					else
						item.id = 0
					end					
				end
				
				local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
				local iteminfo = itemJsonConfig:getByKey(type)
				local name = iteminfo:getByKey("name"):asString()
				alert(name.."数量增加"..value)
			end	
		end
	end
	
	local add_list = s:getByKey("add_item_id_list")
	for i = 1 , add_list:size() do
		ids[i] = add_list:getByIndex(i-1):asInt()
	end
	
	ItemSimple(ids,nil,isreward)
	updateSpecialItemData()
end

function battleGetItems(s,is_table,isreward)
	local type,id,value,showAlert = 0,0,0,0
	
	if is_table ~= nil and is_table then
		type = s[1]
		id = s[2]
		value = (s[3] ~= nil and s[3] ) ~= 0 and s[3] or 1
		showAlert = s[4]
		--showAlert = s[4] ~= nil and s[4] or true
	else
		type = s:getByIndex(0):asInt()
		id = s:getByIndex(1):asInt()
		value = (s:getByIndex(2):asInt() ~= nil and s:getByIndex(2):asInt() ~= 0 ) and s:getByIndex(2):asInt() or 1
		showAlert = s:getByIndex(3):asInt() ~= nil and s:getByIndex(3):asInt() or false
	end
	
	local ids = {}
	
	if type ~= 0 then
		local item = findItemsByItemCfgId(type)
		
		local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
		local iteminfo = itemJsonConfig:getByKey(type)
		local name = iteminfo:getByKey("name"):asString()
				
		if item ~= 0 then
			if item.amount + value < item.max_count then
				item.amount = item.amount + value				
			else
				if item.effect_type ~= 11 then
					item.amount = item.max_count
					if item.max_count - item.amount > 0 then
						ids[1] = id
					end
				else
					item.id = 0
					ids[1] = id
				end
			end
			
			if showAlert then
				local iteminfo = itemJsonConfig:getByKey(type)
				local name = iteminfo:getByKey("name"):asString()
				alert(name.."数量增加"..value)
			end
		else
			ids[1] = id
		end	
	end
	
	ItemSimple(ids,showAlert,isreward)
	updateSpecialItemData()
end

function conmitTaskGetItems(s)
	local task_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_task.json")
	local task_id = s:getByKey("complete_task"):asInt()	
	local task_c = task_cfg:getByKey(task_id)
	local ids = {}
	local temp_count = 0
	
	for i = 1 , 2 do
		local type = task_c:getByKey("reward_item_"..i):asInt()
		local value = task_c:getByKey("reward_item_amount_"..i):asInt()
		
		if type ~= 0 then
			local item = findItemsByItemCfgId(type)

			if item ~= 0 then
				if item.amount + value < item.max_count then
					item.amount = item.amount + value
				else
					if item.effect_type ~= 11 then
						item.amount = item.max_count
					else
						item.id = 0
					end
				end
				
				local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
				local iteminfo = itemJsonConfig:getByKey(type)
				local name = iteminfo:getByKey("name"):asString()
				alert(name.."数量增加"..value)
			end
		end
	end
	
	local add_list = s:getByKey("add_item_id_list")
	local change_list = s:getByKey("change_item_id_list") --这里是放数量，很恶心的做法
	for i = 1 , add_list:size() do
		local type = add_list:getByIndex(i-1):asInt()
		if type==14 then --经验丹
			local amount = change_list:getByIndex(i-1):asInt()
			alert("获得 "..amount.." 颗经验丹")
			GloblePlayerData.trainings.jump_wand = GloblePlayerData.trainings.jump_wand + amount
		elseif type==17 then --朗姆酒
			local amount = change_list:getByIndex(i-1):asInt()
			alert("获得 "..amount.." 瓶朗姆酒")
			GloblePlayerData.ap_wand = GloblePlayerData.ap_wand + amount
		else
			ids[i] = type
		end
	end
	
	ItemSimple(ids)
	updateSpecialItemData()
end
WaitDialog = new({})
WaitDialogTag = 65200
WaitDialog.closePanelFunc = function()
	local scene = DIRECTOR:getRunningScene()
	if scene:getChildByTag(WaitDialogTag) ~= nil then
		scene:removeChildByTag(WaitDialogTag)
	end
end

function showWaitDialog(s)
    local mask = dbUIMask:node()
    local centerWidget = dbUIPanel:panelWithSize(CCSize(1024, 768))
    centerWidget:setAnchorPoint(CCPoint(0.5, 0.5))
    centerWidget:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
    centerWidget:setScale(SCALE)
    mask:addChild(centerWidget)
    
	local waitCircle = dbUIWaitCircle:waitCircleWithText("")
	waitCircle:setPosition(CCPoint(1024/2, 768/2))
	centerWidget:addChild(waitCircle)
	
	local scene = DIRECTOR:getRunningScene()
	scene:addChild(mask,10000,WaitDialogTag)
end

function showWaitDialogNoCircle(s)
    local mask = dbUIMask:node()
    local centerWidget = dbUIPanel:panelWithSize(CCSize(1024, 768))
    centerWidget:setAnchorPoint(CCPoint(0.5, 0.5))
    centerWidget:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
    centerWidget:setScale(SCALE)
    mask:addChild(centerWidget)

	local scene = DIRECTOR:getRunningScene()
	scene:addChild(mask,10000,WaitDialogTag)
end

function closeWait()
	local temp = (WaitDialog ~= nil and WaitDialog.closePanelFunc ~= nil) and WaitDialog.closePanelFunc() or 0
end
ItemDialog = {
	create = function(self,cfg)
		self:initBase(cfg)

		local item = cfg.item
		local width = 380
		local height = 0
		local TO_LEFT = 30

		--创建下划线
		local createLine = function(panel)
			local line = CCSprite:spriteWithFile("UI/baoguoPanel/line.png")
			line:setAnchorPoint(CCPoint(0,0))
			line:setPosition(CCPoint(10,0))
			line:setScaleX((width-20)/line:getContentSize().width)
			panel:addChild(line)
		end
		-----------------------------------------------------------------------------
		--物品名字,星级
		local headHeight = 0
		local headPanel = dbUIPanel:panelWithSize(CCSize(width,headHeight)) --容器panel
		headPanel:setAnchorPoint(CCPoint(0,0))
		
		local starPanelHeight = 0
		if item.type == 2 and false then --武器才有星，现在加星的功能没有，暂时屏蔽
			for i=1,10 do
				local star = ""
				if i==1 then
					star = CCSprite:spriteWithFile("UI/baoguoPanel/xx.png")
				else
					star = CCSprite:spriteWithFile("UI/baoguoPanel/xx_gray.png")
				end
				star:setPosition(CCPoint(TO_LEFT+25*(i-1),12))
				star:setAnchorPoint(CCPoint(0,0))
				headPanel:addChild(star)
			end
			starPanelHeight = 34
		end
		
		local nameLabel = CCLabelTTF:labelWithString(item.name,CCSize(330,0),0, SYSFONT[EQUIPMENT], 32)
		nameLabel:setPosition(CCPoint(TO_LEFT, starPanelHeight+5))
		nameLabel:setAnchorPoint(CCPoint(0,0))
		nameLabel:setColor(ITEM_COLOR[item.quality])
		headPanel:addChild(nameLabel)
		local nameLabelWidth = 30 * string.len(item.name)/3 --中文的宽度是字母的三倍
		if item.type==2 and item.effect_type==11 then --装备碎片
			local countLabel = CCLabelTTF:labelWithString("("..item.amount.."/"..item.max_count..")",CCSize(100,0),0, SYSFONT[EQUIPMENT], 26)
			countLabel:setPosition(CCPoint(TO_LEFT+nameLabelWidth+5, starPanelHeight+8))
			countLabel:setAnchorPoint(CCPoint(0,0))
			countLabel:setColor(ccc3(255,204,151))
			headPanel:addChild(countLabel)
			nameLabelWidth = nameLabelWidth+60
		end
		if item.type == 2 and item.star > 0 then --武器才有等级
			local starLabel = CCLabelTTF:labelWithString("+"..item.star,CCSize(200,0),0, SYSFONT[EQUIPMENT], 32)
			starLabel:setPosition(CCPoint(TO_LEFT+ nameLabelWidth + 20, starPanelHeight+3))
			starLabel:setAnchorPoint(CCPoint(0,0))
			starLabel:setColor(ccc3(204, 51, 204))
			headPanel:addChild(starLabel)
		end
		headHeight = starPanelHeight + 60
		
		createLine(headPanel) --分割线
		---------------------------------------------属性
		--物品属性
		local a,b,c = public_returnEquipAttributeDesc(item)
		local attrCount = table.getn(a)
		local attrLabelHeight = attrCount * 24 + 10

		local descPanel = dbUIPanel:panelWithSize(CCSize(width,0))

		for i = 1 , attrCount do
			local attribute = b[i] .. a[i] .. " +"..c[i]

			local label = CCLabelTTF:labelWithString(b[i],CCSize(150,0),0, SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(TO_LEFT, attrLabelHeight-i*24))
			label:setColor(ccc3(255,204,151))
			descPanel:addChild(label)

			local label = CCLabelTTF:labelWithString(a[i],CCSize(0, 0),0, SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(TO_LEFT+100, attrLabelHeight-i*24))
			label:setColor(ccc3(255,204,151))
			descPanel:addChild(label)
			if item.type ~= 4 then
				local label1 = CCLabelTTF:labelWithString("+"..math.max(0, c[i] * item.star),CCSize(100,0),0, SYSFONT[EQUIPMENT], 22)
				label1:setAnchorPoint(CCPoint(0,0))
				label1:setPosition(CCPoint(label:getPositionX() + label:getContentSize().width + 3, attrLabelHeight-i*24))
				label1:setColor(ccc3(204, 51, 204))
				descPanel:addChild(label1)
			end
		end

		--物品描述
		local descLabelHeight = 0
		local descLabel = CCLabelTTF:labelWithString(item.info,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
		descLabel:setPosition(CCPoint(TO_LEFT, attrLabelHeight+5))
		descLabel:setAnchorPoint(CCPoint(0,0))
		descLabel:setColor(ccc3(153,255,0))
		descPanel:addChild(descLabel)
		descLabelHeight = descLabel:getContentSize().height + 5

		local levelLabelHeight = 30
		local part = 7
		if item.type == 2 then
			part = item.part
		end
		local partLabel = CCLabelTTF:labelWithString(PART_STRING[part],CCSize(300,0),0, SYSFONT[EQUIPMENT], 24)
		partLabel:setPosition(CCPoint(TO_LEFT, attrLabelHeight + descLabelHeight))
		partLabel:setAnchorPoint(CCPoint(0,0))
		partLabel:setColor(ccc3(204, 51, 204))
		descPanel:addChild(partLabel)

		local levelLabel = CCLabelTTF:labelWithString("等级要求："..item.require_level,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
		levelLabel:setPosition(CCPoint(TO_LEFT + 60, attrLabelHeight + descLabelHeight))
		levelLabel:setAnchorPoint(CCPoint(0,0))
		levelLabel:setColor(ccc3(255,204,153))
		descPanel:addChild(levelLabel)

		local descHeight = levelLabelHeight + descLabelHeight + attrLabelHeight

		descPanel:setContentSize(CCSize(width,descHeight))
		createLine(descPanel) --分割线
		----------------------------------------镶嵌
		local holeHeight = 0
		local holePanel = nil
		if item.type == 2 and item.effect_type ~= 11 then
			holeHeight = 440
			holePanel = dbUIPanel:panelWithSize(CCSize(width,holeHeight))

			--镶嵌宝石部分
			local attrLabel = CCLabelTTF:labelWithString("宝石孔：",CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
			attrLabel:setAnchorPoint(CCPoint(0,0))
			attrLabel:setPosition(CCPoint(TO_LEFT,208+200))
			attrLabel:setColor(ccc3(204, 51, 204))
			holePanel:addChild(attrLabel)

			local createLabel = function(text,size,pos,color,anchor,parent)
				local attrLabel = CCLabelTTF:labelWithString(text,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
				attrLabel:setAnchorPoint(CCPoint(0,0))
				attrLabel:setPosition(CCPoint(TO_LEFT,208+200))
				attrLabel:setColor(ccc3(237,72,169))
				holePanel:addChild(attrLabel)
			end

			for k = 1, 6 do
				local hole
				if item.hole[k] ~= nil and  item.hole[k].type ~= nil  then
					local gem_id = item.hole[k].id
					if gem_id ~= 0 then
						local item_info = new(findShowItemInfo(gem_id))
						local gemCfg = {
							item_id = item.item_id,
							item = item_info,
							from  = "dialog",
							mine = self.cfg.mine,
							parent = self,
							gem = {
								item_id = item.item_id,
								hole = k,
								isShow = true,
							}
						}
						hole = createGem(gemCfg)
						createGemDesc(hole,gemCfg)
					else
						local holeCfg = {
							type = item.hole[k].type,
							item_id = item_id,
							hole = k,
							enable = item.hole[k].type > 0,
							parent = self
						}
						hole = createHole(holeCfg)
						createHoleDesc(hole,holeCfg)
					end
				end
				hole:setAnchorPoint(CCPoint(0,0))
				hole:setPosition(CCPoint(TO_LEFT,145-(k-1)*65 + 200))
				holePanel:addChild(hole)
			end
			createLine(holePanel) --分割线
		end
		-----------------------------------
		--底下按钮部分，包括出售价格
		local btnPanelHeight = 120
		local btnPanel = dbUIPanel:panelWithSize(CCSize(width,120))

		local price = public_sellprice(item)
		local priceLabel = CCLabelTTF:labelWithString("出售价格："..price,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
		priceLabel:setAnchorPoint(CCPoint(0,0))
		priceLabel:setPosition(CCPoint(TO_LEFT,80))
		priceLabel:setColor(ccc3(255,204,102))
		btnPanel:addChild(priceLabel)

		local btns = self:createBtns(item,cfg)
		local btnCount = table.getn(btns)
		local offsetX = (width - btnCount*103)/(btnCount+1)
		for i=1,table.getn(btns) do
			local b = btns[i]
			b:setPosition(CCPoint(offsetX*i+(i-1)*103,20))
			b:setAnchorPoint(CCPoint(0, 0))
			b.m_nScriptClickedHandler = function()
				b:action(b.param)
				self:closePanel()
			end
			btnPanel:addChild(b)
		end
		---------------------------------------------------------------
		--弹出框高度计算
		height = height + headHeight
		height = height + descHeight
		height = height + holeHeight
		height = height + btnPanelHeight

		--背景
		local bg = createBG("UI/baoguoPanel/kuang.png",width,height,CCSizeMake(30,30))
		bg:setPosition(CCPoint(0,0))

		self.main = dbUIPanel:panelWithSize(CCSize(width,height))
		self.main:setAnchorPoint(CCPoint(0.5,0.5))
		self.main:setPosition(self.pos)
		self.main:addChild(bg)

		headPanel:setPosition(CCPoint(0,descHeight + holeHeight + btnPanelHeight))
		descPanel:setPosition(CCPoint(0,holeHeight + btnPanelHeight))
		if item.type == 2 and item.effect_type ~= 11 then
			holePanel:setPosition(CCPoint(0,btnPanelHeight))
		end
		btnPanel:setPosition(CCPoint(0,0))

		self.main:addChild(headPanel)
		self.main:addChild(descPanel)
		if item.type == 2 and item.effect_type ~= 11 then
			self.main:addChild(holePanel)
		end
		self.main:addChild(btnPanel)

		self:moveDialog(self.pos,self.pos)

		if item.type == 2 and item.effect_type ~= 11 then
			holePanel.m_nScriptDragMoveHandler = function(ccpBegin,ccpEnd)
				self:moveDialog(ccpBegin,ccpEnd)
			end
		end
		btnPanel.m_nScriptDragMoveHandler = function(ccpBegin,ccpEnd)
			self:moveDialog(ccpBegin,ccpEnd)
		end
		descPanel.m_nScriptDragMoveHandler = function(ccpBegin,ccpEnd)
			self:moveDialog(ccpBegin,ccpEnd)
		end
		headPanel.m_nScriptDragMoveHandler = function(ccpBegin,ccpEnd)
			self:moveDialog(ccpBegin,ccpEnd)
		end

		self.parent:addChild(self.main)
	end,

	--创建底下的按钮
	createBtns = function(self)
		local cfg = self.cfg
		local item = cfg.item

		local btns = {}
		if cfg.from=="hero_baoguo" then --人物装备包裹
			btns[1] = dbUIButtonScale:buttonWithImage("UI/baoguoPanel/zb_btn.png", 1, ccc3(125, 125, 125))
			btns[1].action = UseItem
			btns[1].param = {
				item = item,
				callback = cfg.callbacks.useCallBack,
				self = cfg.sender
			}
			GlobalItemUseBtn = btns[1]

			btns[2] = dbUIButtonScale:buttonWithImage("UI/baoguoPanel/sell.png", 1, ccc3(125, 125, 125))
			btns[2].action = SellItemAction
			btns[2].param = {
				callback = cfg.callbacks.sellCallBack,
				self = cfg.sender,
				item_id = item.item_id,
				name = item.name,
				price = public_chageShowTypeForMoney(item.amount * public_sellprice(item)),
			}
		end
		if cfg.from=="hero_equip" then --人物装备面板
			if cfg.mine then
				local btn = dbUIButtonScale:buttonWithImage("UI/baoguoPanel/xie_xia.png", 1, ccc3(125, 125, 125))
				btn.action = UnladeItem
				btn.param = {
					item_id = item.item_id,
					part = item.part,
				}
				table.insert(btns,btn)
			else
				local btn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
				btn.action = nothing
				table.insert(btns,btn)
			end
		end

		if cfg.from=="baoguo" then  --从背包进入
			if getItemEnable(item) and item.type~=2 then --非装备
				local btn = dbUIButtonScale:buttonWithImage("UI/baoguoPanel/use.png", 1, ccc3(125, 125, 125))
				btn.action = UseItem
				btn.param = {
					item = item,
					callback = cfg.callbacks.useCallBack,
					self = cfg.sender
				}
				GlobalItemUseBtn = btn
				table.insert(btns,btn)
			else
				if item.type == 4 then
					if item.effect_type == 10 then	--升级材料
						local btn = dbUIButtonScale:buttonWithImage("UI/baoguoPanel/sheng_ji.png", 1, ccc3(125, 125, 125))
						btn.action = globleShowShengji
						btn.param = {
							item_id = item.item_id,
							part = item.part,
						}
						table.insert(btns,btn)
					else
						local btn = dbUIButtonScale:buttonWithImage("UI/baoguoPanel/he_cheng.png", 1, ccc3(125, 125, 125))
						btn.action = globleShowHeCheng
						btn.param = {
							item_id = item.item_id,
							part = item.part,
						}
						table.insert(btns,btn)
					end
				end
			end

			local btn = dbUIButtonScale:buttonWithImage("UI/baoguoPanel/sell.png", 1, ccc3(125, 125, 125))
			btn.action = SellItemAction
			btn.param = {
				callback = cfg.callbacks.sellCallBack,
				self = cfg.sender,
				item_id = item.item_id,
				name = item.name,
				price = public_chageShowTypeForMoney(item.amount * public_sellprice(item)),
			}
			table.insert(btns,btn)
		end
		
		if cfg.from == "dialog" then --一般都是点击装备信息框中镶嵌的宝石
			local generalId = cfg.generalId or GloblePlayerData.generals[GloblePanel.curGenerals].general_id
			if cfg.mine then
				local btn = dbUIButtonScale:buttonWithImage("UI/baoguoPanel/cai_chu.png", 1, ccc3(125, 125, 125))
				btn.action = GemDismount
				btn.param = {
					gem = cfg.gem,
					generalId = generalId,
					parent = cfg.parent
				}
				table.insert(btns,btn)
			else
				local btn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
				btn.action = nothing
				table.insert(btns,btn)
			end
		end
		if cfg.from == "view" then
			local btn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
			btn.action = nothing
			table.insert(btns,btn)
		end
		return btns
	end,

	--移动对话框操作
	moveDialog = function(self,ccpBegin,ccpEnd)
		local maxx,maxy = 0,0
		local ccpBegin,ccpEnd = CCPoint(ccpBegin.x/SCALEY,ccpBegin.y/SCALEY),CCPoint(ccpEnd.x/SCALEY,ccpEnd.y/SCALEY)

		maxx = self.parent:getContentSize().width
		maxy = self.parent:getContentSize().height

		local cx, cy = self.main:getPosition()
		local x,y = cx + ccpBegin.x - ccpEnd.x,cy + ccpBegin.y - ccpEnd.y

		if x < 0 + self.main:getContentSize().width/2 then
			x = 0 + self.main:getContentSize().width/2
		elseif x > maxx - self.main:getContentSize().width/2 then
			x = maxx - self.main:getContentSize().width/2
		end

--		if y < 0 + self.main:getContentSize().height/2 then
--			y = 0 + self.main:getContentSize().height/2
--		elseif y > maxy - self.main:getContentSize().height/2 then
--			y = maxy - self.main:getContentSize().height/2
--		end
		self.main:setPosition(CCPoint(x,y))
	end,

	initBase = function(self,cfg)
		self.parent = dbUIPanel:panelWithSize(CCSize(WINSIZE.width/SCALEY,WINSIZE.height/SCALEY))
		self.parent:setAnchorPoint(CCPoint(0.5, 0.5))
		self.parent:setPosition(CCPoint(WINSIZE.width / 2 / SCALEY, WINSIZE.height / 2 / SCALEY))

		local scene = DIRECTOR:getRunningScene()
		self.layer = dbUILayer:node()
		self.layer:addChild(self.parent)
		self.layer:setScale(SCALEY)
		scene:addChild(self.layer, 10000)

		self.cfg = cfg
		self.item = cfg.item
		self.pos = CCPoint(WINSIZE.width /SCALEY / 2, WINSIZE.height /SCALEY / 2)
		if cfg.ccp then
			self.pos = cfg.ccp
		end

		self.parent.m_nScriptClickedHandler = function()
			self:closePanel()
		end
	end,

	closePanel = function(self)
		self.layer:removeFromParentAndCleanup(true)
		GlobalItemUseBtn = nil
	end,

	reflash = function(self,cfg)
		self:closePanel()
		self:create(cfg)
	end,
}

SkillDialog = {
	create = function(self,cfg)
		self:initBase(cfg)
		
		local width = 450
		local height = 40
		local TO_LEFT = 20

		--创建下划线
		local createLine = function()
			local line = CCSprite:spriteWithFile("UI/baoguoPanel/line.png")
			line:setAnchorPoint(CCPoint(0,0))
			line:setPosition(CCPoint(0,0))
			line:setScaleX((width-20)/line:getContentSize().width)
			return line
		end
		
		local createSkill = function(cfg_skill_id, drawLine)
			local skill_json_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_skill.json")
			local skill_icon = skill_json_cfg:getByKey(cfg_skill_id):getByKey("icon"):asInt()
			local skill_name = skill_json_cfg:getByKey(cfg_skill_id):getByKey("name"):asString()
			local skill_desc = skill_json_cfg:getByKey(cfg_skill_id):getByKey("desc"):asString()
			
			local panel = dbUIPanel:panelWithSize(CCSize(430, 130))
			panel:setAnchorPoint(CCPoint(0, 0))
			--技能图标
			local kuang = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			kuang:setAnchorPoint(CCPoint(0, 0.5))
			kuang:setPosition(CCPoint(20, 65))
			panel:addChild(kuang)
			local icon = CCSprite:spriteWithFile("icon/Skill/icon_skill_"..skill_icon..".png")
			icon:setAnchorPoint(CCPoint(0.5, 0.5))
			icon:setPosition(CCPoint(48, 48))
			kuang:addChild(icon)
			--技能名称
			local name = CCLabelTTF:labelWithString(skill_name, CCSize(274, 0), 0, SYSFONT[EQUIPMENT], 28)
			name:setColor(ccc3(204, 51, 201))
			name:setAnchorPoint(CCPoint(0, 0))
			name:setPosition(CCPoint(126, 85))
			panel:addChild(name)
			--技能描述
			local desc = CCLabelTTF:labelWithString(skill_desc, CCSize(284, 0), 0, SYSFONT[EQUIPMENT], 22)
			desc:setColor(ccc3(255, 205, 152))
			desc:setAnchorPoint(CCPoint(0, 1))
			desc:setPosition(CCPoint(126, 85))
			panel:addChild(desc)
			--横线
			if drawLine then
				local line = createLine()
				panel:addChild(line)
			end
			return panel, 130
		end
		
		self.panels = new({})
		for i = 1, #self.skills  do
			local panel, _height = createSkill(self.skills[#self.skills - i + 1].cfg_skill_id, i ~= 1)
			panel:setPosition(CCPoint(10, 20 + (i-1) * _height))
			panel.m_nScriptClickedHandler = function()
				self:closePanel()
			end
			self.panels[i] = panel
			height = height + _height
		end

		--背景
		local bg = createBG("UI/baoguoPanel/kuang.png",width,height,CCSizeMake(30,30))
		bg:setPosition(CCPoint(0,0))

		self.main = dbUIPanel:panelWithSize(CCSize(width,height))
		self.main:setAnchorPoint(CCPoint(0, 1))
		self.main:setPosition(self.pos)
		self.main:addChild(bg)
		
		for i = 1, #self.panels do
			self.main:addChild(self.panels[i])
		end

		self.parent:addChild(self.main)
	end,
	
	initBase = function(self, cfg)
		self.parent = dbUIPanel:panelWithSize(CCSize(WINSIZE.width/SCALEY,WINSIZE.height/SCALEY))
		self.parent:setAnchorPoint(CCPoint(0.5, 0.5))
		self.parent:setPosition(CCPoint(WINSIZE.width / 2 / SCALEY, WINSIZE.height / 2 / SCALEY))

		local scene = DIRECTOR:getRunningScene()
		self.layer = dbUILayer:node()
		self.layer:addChild(self.parent)
		self.layer:setScale(SCALEY)
		scene:addChild(self.layer, 10000)
		
		self.skills = cfg.skills
		self.pos = CCPoint(cfg.pos.x / SCALEY, cfg.pos.y / SCALEY)
		if not self.pos then
			self.pos = CCPoint(WINSIZE.width /SCALEY / 2, WINSIZE.height /SCALEY / 2)
			self.anchor = CCPoint(0.5, 0.5)
		else
			self.anchor = CCPoint(0, 1)
		end

		self.parent.m_nScriptClickedHandler = function()
			self:closePanel()
		end
	end,

	closePanel = function(self)
		self.layer:removeFromParentAndCleanup(true)
	end,

	reflash = function(self,cfg)
		self:closePanel()
		self:create(cfg)
	end,
}

function createHoleDesc(holdBtn,cfg)
	if not cfg.enable then
		local label = CCLabelTTF:labelWithString("未开放",CCSize(100,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(holdBtn:getContentSize().width+10,holdBtn:getContentSize().height/2))
		label:setColor(ccc3(153,153,153))
		holdBtn:addChild(label)
	else
		local label = CCLabelTTF:labelWithString("未镶嵌",CCSize(100,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(holdBtn:getContentSize().width+10,holdBtn:getContentSize().height/2))
		label:setColor(ccc3(153,255,0))
		holdBtn:addChild(label)
	end
end

function createHole(cfg)

	local type = cfg.type
	local item_id = cfg.item_id
	local hole = cfg.hole
	local patent = cfg.patent
	local noHoldBg = cfg.noHoldBg
	local holdBg = cfg.holdBg
	if holdBg==nil then
		holdBg = "UI/baoguoPanel/hold.png"
	end
	if noHoldBg==nil then
		noHoldBg = "UI/baoguoPanel/no_hold.png"
	end
		
	local holdBtn
	if not cfg.enable then
		holdBtn = dbUIButtonScale:buttonWithImage(noHoldBg, 1, ccc3(125, 125, 125))
	else
		holdBtn = dbUIButtonScale:buttonWithImage(holdBg, 1, ccc3(125, 125, 125))
		holdBtn.m_nScriptClickedHandler = function(ccp)
			local dialogCfg = new(basicDialogCfg)
			dialogCfg.bg = "UI/baoguoPanel/kuang.png"
			dialogCfg.corner = CCSizeMake(30,30)
			dialogCfg.position = ccp
			dialogCfg.msg = "该槽可以镶嵌：\n"
			dialogCfg.msgSize = 24
			dialogCfg.panelSize = CCSizeMake(350,150)
			dialogCfg.size = CCSizeMake(450,150)
			dialogCfg.dialogType = 5
			dialogCfg.msgColor = ccc3(255,204,151)
			
			for i = 1 , table.getn(HOLE_CFG[type]) do
				dialogCfg.msg = dialogCfg.msg .. HOLE_CFG[type][i]
				if i ~= table.getn(HOLE_CFG[type]) then
					dialogCfg.msg = dialogCfg.msg .. "、"
				end
			end

			local count = 0
			local btns = {}
			for i = 1 , table.getn(GloblePlayerData.baoshi) do
				local baoshi = GloblePlayerData.baoshi[i]
				if baoshi ~= nil and baoshi.effect ~= nil and baoshi.effect == type then
					count = count + 1

					local btn = dbUIButtonScale:buttonWithImage("UI/public/kuang_96_96.png", 1, ccc3(125, 125, 125))
					btn:setAnchorPoint(CCPoint(0, 0.5))
					btn.m_nScriptClickedHandler = function(ccp)
						local gemInfo = findItemsByItemCfgId1(baoshi.cfg_item_id)

						local desc,tag = public_returnEquipAttributeDesc(gemInfo)
						local msg = "镶嵌\n<"..gemInfo.name..">\n".."可以增加属性"
						for n = 1 , table.getn(desc) do
							msg = msg.."\n"..tag[n]..desc[n]
						end

						local gemDialogCfg = new(basicDialogCfg)
						gemDialogCfg.bg = "UI/baoguoPanel/kuang.png"
						gemDialogCfg.msg = msg
						gemDialogCfg.dialogType = 5
						gemDialogCfg.position = ccp
						new(Dialog):create(gemDialogCfg)
					end

					gemBg = btn

					local ccspr = CCSprite:spriteWithFile("icon/Item/icon_item_"..baoshi.icon..".png")
					ccspr:setPosition(getWidgetCenter(btn))
					ccspr:setAnchorPoint(CCPoint(0.5, 0.5))
					ccspr:setScale(0.95 * btn:getContentSize().width/ccspr:getContentSize().width)
					btn:addChild(ccspr)

					local amount = CCLabelTTF:labelWithString(baoshi.amount, SYSFONT[EQUIPMENT], 22)
					amount:setAnchorPoint(CCPoint(1, 0))
					amount:setPosition(CCPoint(btn:getContentSize().width-10,0))
					btn:addChild(amount)

					btns[count] = btn
				end
			end

			if count ~= 0 then
				dialogCfg.form = dbUIScrollList:scrollList(CCRectMake(0,0,300, btns[count]:getContentSize().height + 20),1)
				dialogCfg.isList = true
			end

			for i = 1 ,count do
				dialogCfg.form:insterDetail(btns[i])
			end

			local dialog = new(Dialog)
			dialog:create(dialogCfg)

			if count ~= 0 then
				dialogCfg.form:setPosition(CCPoint((dialog.bg:getContentSize().width-300)/2, 25))
			end
		end
	end
	return holdBtn
end

							
function createGemDesc(gemBtn,cfg)
	local item_info = cfg.item
	local add,addType = public_returnBaoshiAttribute(item_info)

	local addLabel = CCLabelTTF:labelWithString("+"..add..addType,CCSize(200,0),0, SYSFONT[EQUIPMENT], 22)
	addLabel:setAnchorPoint(CCPoint(0,0.5))
	addLabel:setPosition(CCPoint(gemBtn:getContentSize().width+10,gemBtn:getContentSize().height/2))
	addLabel:setColor(ccc3(153,255,0))
	gemBtn:addChild(addLabel)

	local label = CCLabelTTF:labelWithString("("..item_info.name..")",CCSize(200,0),0, SYSFONT[EQUIPMENT], 22)
	label:setAnchorPoint(CCPoint(0,0.5))
	label:setPosition(CCPoint(gemBtn:getContentSize().width+10+100,gemBtn:getContentSize().height/2))
	label:setColor(ccc3(0,204,255))
	gemBtn:addChild(label)
end

function createGem(cfg)
	local item = new(BaoGuo_BackpackSingleItem)
	item:create(cfg.item,cfg)
	local gemBg = cfg.gemBg
	if gemBg==nil then
		gemBg = "UI/baoguoPanel/hold.png"
	end
		
	local bg = dbUIButtonScale:buttonWithImage(gemBg, 1, ccc3(125, 125, 125))
	item.itemBorder:setScale(bg:getContentSize().width/item.itemBorder:getContentSize().width)
	bg:addChild(item.itemBorder)
	return bg
end
Bar = {
	barbg = nil,
	min = 0,
	max = 100,
	cur = 100,
	--[[
		bg = "UI/bar/boss_hp_bar.png",
		secondBg = "UI/bar/bar_red_thin.png",
		bar = "UI/bar/bar_red.png",
		fontSize = 20,
		position = CCPoint(68,5),
		entityPos = CCPoint(2,0), --里面那个条相对背景条的位置，y为0的话为上下放下剧中，x为0则不会
		cornerWidth = 8
		testShowFull = true  文字是不是全部显示 
	--]]
	create = function(self,max,cfg)
		self.max = max
		self.cornerWidth = cfg.cornerWidth or 0
		self.fontSize = cfg.fontSize or 24
		self.textColor = cfg.textColor or ccc3(255,255,255)
		self.testShowFull = cfg.testShowFull or false
		self.bar = cfg.bar
		self.addtions = cfg.addtions
		
		self.barbg = CCSprite:spriteWithFile(cfg.bg)
		self.barbg:setAnchorPoint(CCPoint(0,0))
		self.barbg:setPosition(cfg.position)
		
		if cfg.secondBg then
			local secondBg = CCSprite:spriteWithFile(cfg.secondBg)
			secondBg:setAnchorPoint(CCPoint(0.5,0.5))
			secondBg:setPosition(CCPoint(self.barbg:getContentSize().width/2,self.barbg:getContentSize().height/2))
			self.barbg:addChild(secondBg,0)
		end

		self.entityPos = cfg.entityPos or CCPoint(0,self.barbg:getContentSize().height/2)
		if self.entityPos.y == 0 then self.entityPos.y = self.barbg:getContentSize().height/2 end
		return self
	end,

	setExtent = function(self,extent,max)
		self.cur = extent
		self.max = max or self.max
		if self.cur > self.max then self.cur = self.max end
		
		if self.progress then self.barbg:removeChild(self.progress,true) end
		if self.corner then self.barbg:removeChild(self.corner,true) end

		local bar = CCSprite:spriteWithFile(self.bar)
		local barSize = bar:getContentSize()
		local texture = bar:getTexture()
		
		local curWidth = barSize.width*(self.cur/self.max) --进度条的宽度
		if curWidth >= self.cornerWidth*2 and curWidth < barSize.width - self.cornerWidth then 
			curWidth = curWidth - self.cornerWidth
		end
		self.progress = CCSprite:spriteWithTexture(texture,CCRectMake(0,0,curWidth,barSize.height))
		self.progress:setAnchorPoint(CCPoint(0,0.5))
		self.progress:setPosition(self.entityPos)	
		self.barbg:addChild(self.progress,0)
		
		if curWidth >= self.cornerWidth*2 and curWidth < barSize.width - self.cornerWidth then  --进度条的宽度如果大于圆角的两倍宽度则补上圆角
			local startX = barSize.width-self.cornerWidth		
			local corner = CCSprite:spriteWithTexture(texture,CCRectMake(startX,0,self.cornerWidth,barSize.height))
			corner:setAnchorPoint(CCPoint(0,0.5))
			corner:setPosition(CCPoint(curWidth+self.entityPos.x,self.barbg:getContentSize().height/2))
			self.barbg:addChild(corner)
			self.corner = corner
		end
		
		if self.text then self.barbg:removeChild(self.text,true) end
		
		local textValue = ""
		if self.testShowFull then
			textValue = self.cur.."/"..self.max
		else
			textValue = public_Wan_Exp(self.cur,true).."/"..public_Wan_Exp(self.max)
		end
		self.text = CCLabelTTF:labelWithString(textValue,SYSFONT[EQUIPMENT],self.fontSize)
		self.text:setAnchorPoint(CCPoint(0.5,0.5))
		self.text:setPosition(CCPoint(self.barbg:getContentSize().width / 2,self.barbg:getContentSize().height / 2))
		self.text:setColor(self.textColor)
		self.barbg:addChild(self.text)
		
		if self.addtions then
			local sectionLabel = CCLabelTTF:labelWithString(self.addtions,SYSFONT[EQUIPMENT], 22)
			sectionLabel:setAnchorPoint(CCPoint(1,0.5))
			sectionLabel:setPosition(CCPoint(self.barbg:getContentSize().width-20,self.barbg:getContentSize().height/2))
			self.barbg:addChild(sectionLabel)
		end
	end,
}

Bar2 = {
	barbg = nil,
	bar = nil,
	text = nil,
	max = 100,
	cur = 100,

	create = function(self,max,barCfg)
		self.max = max
		self.barCfg = barCfg
		--背景条
		self.barbg = dbUIWidgetBGFactory:widgetBG()
		self.barbg:setCornerSize(barCfg.borderCornerSize)
		self.barbg:setBGSize(CCSizeMake(barCfg.borderSize.width,barCfg.borderSize.height))
		self.barbg:createCeil(barCfg.res.border)
		self.barbg:setAnchorPoint(CCPoint(0, 0))
		self.barbg:setPosition(barCfg.position)
	end,

	--设置当前进度
	setExtent = function(self,cur,max)
		if self.bar then
			self.barbg:removeChild(self.bar,true)
			self.bar = nil
		end
		if self.text then
			self.barbg:removeChild(self.text,true)
			self.text = nil
		end

		self.cur = cur
		if max then
			self.max = max
		end
		if self.cur > self.max then
			self.cur = self.max
		end
		local borderOffsetX = 0
		if self.barCfg.borderOffsetX then
			borderOffsetX=self.barCfg.borderOffsetX
		end

		if self.cur>0 and self.cur/self.max>0.02 then --当前进度太小了就不显示了，至少 5%才开始显示
			local barWidth = (self.cur / self.max) * self.barCfg.entitySize.width
			if barWidth < self.barCfg.entityCornerSize.width*2 then
				barWidth = self.barCfg.entityCornerSize.width *2
			end
			if barWidth > self.barCfg.entitySize.width then
				barWidth = self.barCfg.entitySize.width
			end
			self.bar = dbUIWidgetBGFactory:widgetBG()
			self.bar:setCornerSize(self.barCfg.entityCornerSize)
			self.bar:setBGSize(CCSizeMake(barWidth,self.barCfg.entitySize.height))
			self.bar:createCeil(self.barCfg.res.entity)
			self.bar:setAnchorPoint(CCPoint(0,0.5))
			self.bar:setPosition(CCPoint(borderOffsetX,self.barCfg.borderSize.height/2))
			self.barbg:addChild(self.bar,0)
		end

		--文字一定会显示
		if self.barCfg.labelFull and self.barCfg.labelFull == true then
			self.text = CCLabelTTF:labelWithString(self.cur.."/"..self.max, SYSFONT[EQUIPMENT],self.barCfg.fontSize)
		else
			self.text = CCLabelTTF:labelWithString(public_Wan_Exp(self.cur).."/"..public_Wan_Exp(self.max), SYSFONT[EQUIPMENT],self.barCfg.fontSize)
		end
		self.text:setAnchorPoint(CCPoint(0.5, 0.5))
		self.text:setPosition(CCPoint(self.barCfg.borderSize.width / 2, self.barCfg.borderSize.height / 2))
		self.barbg:addChild(self.text,11)
	end,
}
--[[
对话框
local dialogCfg = {
	size = CCSize(361,125),	对话框大小
	bg = {
		bg = "",			背景
		border = "",		边框
		cour = ""			脚
	},						背景材质
	title = "title",		标题内容
	titleSize = 40,			标题大小
	titleAlign = "center",	标题对其方式
	msg = "",				信息内容
	msgAlign = "left",		信息对其
	msgSize = int,			信息字体大小
	form = object,			内容控件
	position = CCPoint,    	创建所在位置
	dialogMoveType = int, 	有值则可以拖动
	dialogType = int, 		1则点击背景关闭，2则点击背景之外任意地方关闭 4为若干秒后关闭 3为拥有(124)种触发 5(12)
	dialogShowTime = int,	如果是若干秒后关闭则为多少秒后关闭。
	parent = object ,		父面板，如果没有父面板则为创建一个全一个全屏的dbUILayer。
}
local dialog = new(Dialog)
dialog:create(dialogCfg)
--]]
basicDialogCfg = {
	size = CCSize(390,125),
	bg = "UI/baoguoPanel/kuang.png",
	--title = TI_SHI,
	titleSize = 40,
	titleAlign = "left",
	msg = "",
	msgAlign = "center",
	msgSize = 30,
	dialogMoveType = 1,
	dialogType = 3,
}

Dialog = {
	bg = nil,
	layer = nil,
	parent = nil,
	title = nil,
	titleColor = ccc3(255,204,153),
	msg = nil,
	msgColor = ccc3(255,204,153),
	form = nil,
	btns = nil,
	closeBtn = nil,
	tickId = nil,
	centerWidget = nil,
	closePanelFunc = nil,
	autoClose = true,
	
	create = function(self,cfg)
		local height = 0
		local size = ""

		if cfg.size == nil then
			size = WINSIZE
		else
			size = cfg.size
		end


		self.parent = dbUIPanel:panelWithSize(CCSize(WINSIZE.width / SCALEY,WINSIZE.height / SCALEY))
		self.parent:setAnchorPoint(CCPoint(0.5, 0.5))
		self.parent:setPosition(CCPoint(WINSIZE.width / 2 / SCALEY, WINSIZE.height / 2 / SCALEY))

		self.layer = dbUILayer:node()
		self.layer:addChild(self.parent)

		local scene = DIRECTOR:getRunningScene()
		scene:addChild(self.layer, 10000)

		--创建对话框内容块
		--如果面板标题不是空的并且不是“提示”就创建提示标题
		if cfg.title ~= nil and cfg.title ~= TI_SHI then
			local titleSize = 30

			if cfg.titleSize ~= nil then
				titleSize = cfg.titleSize
			end

			local l = new(Label)
			local lcfg = new(labelBasicConfig)
			lcfg.fontsize = titleSize

			l:create(cfg.title,lcfg)

			if cfg.titleColor ~= nil then
				self.titleColor = cfg.titleColor
			end
			l.label:setColor(self.titleColor)
			self.title = l.label
			height = height + l.label:getContentSize().height
		end

		if cfg.msg ~= nil then
			local msgSize = 30

			if cfg.msgSize ~= nil then
				msgSize = cfg.msgSize
			end
			local l = new(Label)
			local lcfg = new(labelBasicConfig)
			lcfg.fontsize = msgSize
			if cfg.msgAlign ~=nil then
				lcfg.align = cfg.msgAlign
			end
			
			
			lcfg.size = CCSize(size.width-50,0)
			
			
			l:create(cfg.msg,lcfg)
			self.msg = l.label

			if cfg.msgColor ~= nil then
				self.msgColor = cfg.msgColor
			end
			l.label:setColor(self.msgColor)
             
			if cfg.dialogType == 66 then 
			   height = height + l.label:getContentSize().height + 400   --奖励面板
			else
			   height = height + l.label:getContentSize().height + 30
			end
		end
		local needRemove = true
		local function closePanel()
			if cfg.closeFunc ~= nil then
				cfg.closeFunc()
			end
			if needRemove then
				if self.layer ~= nil then
					self.layer:removeFromParentAndCleanup(true)
					self.layer = nil
				else
					self.bg:removeFromParentAndCleanup(true)
					self.bg = nil
				end
				needRemove = false
			end

			if self.tickClosePanelId ~= nil then
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.tickClosePanelId)
				self.tickClosePanelId = nil
			end
		end

		local needFade = true
		local function PanelFadeOut()
			if needFade then
				local disappearTime = 2

				if cfg.disappearTime ~= nil then
					disappearTime = cfg.disappearTime
				end

				if needRemove then
					self.bg:forEachToRunAction(CCFadeOut:actionWithDuration(disappearTime))
				end

				self.tickClosePanelId = CCScheduler:sharedScheduler():scheduleScriptFunc(closePanel, disappearTime, false)
				needFade = false
			end
		end

		if cfg.form ~= nil then
			self.form = cfg.form
			height = height + self.form:getContentSize().height + 20
		end

		if cfg.closeBtn ~= nil then
		     
		   
			local btn= dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png",1.2)
			btn:setScale(isRetina)
            btn:setAnchorPoint(CCPoint(0.5, 0.5))
			height = height + btn:getContentSize().height*isRetina + 20
			self.closeBtn = btn
			
		end
       if cfg.dialogType == 105 then
			
			height = height  + 40
			
		end
	
		if cfg.btns ~= nil then
			self.btns = new({})
			local count = table.getn(cfg.btns)
			for i = 1 , count do
				local position = ""
				local t = count%2 == 0
				local btn_witdh = cfg.btns[i]:getContentSize().width*isRetina
                    
				if not(t) then
					position = CCPoint(((i-count/2)*2)*btn_witdh/2-btn_witdh/2 + size.width/2,0)
				else
					position = CCPoint(size.width/2 - (count/2 - i)*(btn_witdh+30) - btn_witdh/2,0)
				end
				cfg.btns[i]:setPosition(position)
				cfg.btns[i]:setAnchorPoint(CCPoint(0.5, 0.5))
                cfg.btns[i]:setScale(isRetina)
				cfg.btns[i].m_nScriptClickedHandler = function(ccp)
					if cfg.btns[i].action ~= nil then
						cfg.btns[i].action(ccp,cfg.btns[i].param)
						closePanel()
					end
				end
				self.btns[i] = cfg.btns[i]
                 
				if i == table.getn(cfg.btns) then
					height = height + cfg.btns[i]:getContentSize().height*isRetina + 20
				end
			end
		end

		--判断是否有背景材质
		local bgCfg = {}
		if cfg.bg ~= nil then
			bgCfg.bg = cfg.bg
			bgCfg.panelSize = CCSize(size.width+10,height + 20)
		end
		if self.msg and self.msg:getContentSize().width > size.width-70 then
		
		    local len=0
				 if cfg.dialogType == 105 then
				 len=40
				 end
			bgCfg.panelSize = CCSize(self.msg:getContentSize().width + 70,height + 20-len)
		end
		bgCfg.corner = cfg.corner

		local ubp = new(UiBgPanel)
		ubp:create(bgCfg)
		self.bg = ubp.panel
		if cfg.dialogType == 66 then 
			self.bg = createImagePanel(cfg.bg,size.width,size.height)
		end
		local heightTemp = 0
		if self.title ~= nil then
			public_setAlignForParent(self.title,self.bg,"center",30)
			self.bg:addChild(self.title)
			heightTemp = heightTemp + self.title:getContentSize().height
		end

		if self.msg ~= nil then

			if cfg.dialogType == 66 then   ---------------奖励礼包
				public_setAlignForParent(self.msg,self.bg,"left",heightTemp+30+150)
			else
			    if cfg.dialogType==105 then
					public_setAlignForParent(self.msg,self.bg,"left",heightTemp+30+80)
				else
					public_setAlignForParent(self.msg,self.bg,"left",heightTemp+30)
				end
			end
			self.bg:addChild(self.msg)
			heightTemp = heightTemp + self.msg:getContentSize().height + 10
		end

		if self.btns ~= nil then
			local count = table.getn(self.btns)
			for i = 1 , count do
				local t = count%2 == 0
				local x = self.btns[i]:getPosition()
				local len=0
				if cfg.dialogType==105 then 
				 len=30
				end
				local position = CCPoint(x,self.bg:getContentSize().height - (heightTemp+30+self.btns[i]:getContentSize().height/2-len))
                self.btns[i]:setScale(isRetina)
				self.btns[i]:setPosition(position)
				self.bg:addChild(self.btns[i])
			end
		end

		if self.closeBtn ~= nil then
			local position=nil
			if cfg.dialogType==66 then
				position = CCPoint(self.bg:getContentSize().width/2,60)
			else
				if cfg.dialogType==105 then
					position = CCPoint(self.bg:getContentSize().width-35,self.bg:getContentSize().height-35 )
				else

					position = CCPoint(self.bg:getContentSize().width/2,self.bg:getContentSize().height - (heightTemp+30+self.closeBtn:getContentSize().height/2))
				end
			end
			self.closeBtn:setScale(isRetina)
			self.closeBtn:setAnchorPoint(CCPoint(0.5, 0.5))
			self.closeBtn:setPosition(position)
			self.bg:addChild(self.closeBtn)
			self.closeBtn.m_nScriptClickedHandler = function()
				closePanel()
				if cfg.dialogType == 55 then 
				  globleCreateJueSePanel(5000)
				elseif cfg.dialogType == 1001 then	--打开VIP充值面板
					globleShowVipPanel()
				elseif cfg.dialogType == 1002 then	--打开金转银面板
					GlobleCreateHades()
				end
				
			end
		end

		--移动对话框操作
		local moveDialog = function(ccpBegin,ccpEnd)
			local maxx,maxy = 0,0

			local ccpBegin,ccpEnd = CCPoint(ccpBegin.x/SCALEY,ccpBegin.y/SCALEY),CCPoint(ccpEnd.x/SCALEY,ccpEnd.y/SCALEY)

			maxx = self.parent:getContentSize().width
			maxy = self.parent:getContentSize().height

			local cx, cy = self.bg:getPosition()
			local x,y = cx + ccpBegin.x - ccpEnd.x,cy + ccpBegin.y - ccpEnd.y

			if x < 0 + self.bg:getContentSize().width/2 then
				x = 0 + self.bg:getContentSize().width/2
			elseif x > maxx - self.bg:getContentSize().width/2 then
				x = maxx - self.bg:getContentSize().width/2
			end

			if y < 0 + self.bg:getContentSize().height/2 then
				y = 0 + self.bg:getContentSize().height/2
			elseif y > maxy - self.bg:getContentSize().height/2 then
				y = maxy - self.bg:getContentSize().height/2
			end

			self.bg:setPosition(CCPoint(x,	y))
		end

		--判断对话框是否可以移动
		if cfg.dialogMoveType ~= nil and cfg.dialogMoveType then
			self.bg.m_nScriptDragMoveHandler = function(ccpBegin,ccpEnd)
				moveDialog(ccpBegin,ccpEnd)
			end

			if self.form ~= nil then
				self.form.m_nScriptDragMoveHandler = function(ccpBegin,ccpEnd)
					moveDialog(ccpBegin,ccpEnd)
				end
			end
		end

		if self.form ~= nil then
			if cfg.isList == nil or cfg.isList ~= true then
				public_setAlignForParent(self.form,self.bg,"center",heightTemp+30)
			end

			self.bg:addChild(self.form)

			heightTemp = heightTemp + self.form:getContentSize().height + 30
		end

		self.bg:setContentSize(CCSize(self.bg:getContentSize().width,height))

		--注册部分事件
		local tickFadeOut = function()
			PanelFadeOut()
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.tickFadeOutId)
		end
                                                                                                 --补充生命
		if cfg.dialogType == 1 or cfg.dialogType == 3 or cfg.dialogType == 5 or cfg.dialogType == 55 or cfg.dialogType ==66 then
			self.bg.m_nScriptClickedHandler = function()
				if self.autoClose == true then
					closePanel()
				end
			end
		end
		if cfg.dialogType == 2 or cfg.dialogType == 3 or cfg.dialogType == 5 or cfg.dialogType == 55 or cfg.dialogType == 66 or cfg.dialogType == 105 then
			self.parent.m_nScriptClickedHandler = function()
				if self.autoClose == true then
					closePanel()
				end
			end
		end
		if cfg.dialogType == 4 or cfg.dialogType == 3 then
			local showTime = 2
			if cfg.dialogShowTime ~= nil then
				showTime = cfg.dialogShowTime
			end
			self.tickFadeOutId = CCScheduler:sharedScheduler():scheduleScriptFunc(tickFadeOut, showTime, false)
		end

		if cfg.dialogType == 6  then
			self.parent.m_nScriptClickedHandler = function()
				PanelFadeOut()
			end
		end

		if cfg.dialogType == 6 then
			self.bg.m_nScriptClickedHandler = function()
				PanelFadeOut()
			end
		end
        
		if cfg.dialogType == 99 then
			self.closePanelFunc = closePanel
		end

		local ap = CCPoint(0.5, 0.5)
		local pos = CCPoint(0,0)
		if cfg.anchor ~= nil then
			ap = cfg.anchor
		end
		if cfg.position ~= nil then
			pos = CCPoint(cfg.position.x/SCALEY,cfg.position.y/SCALEY)
		else
			pos = CCPoint(WINSIZE.width/2/SCALEY, WINSIZE.height/2/SCALEY)
		end
		self.bg:setAnchorPoint(ap)
		self.bg:setPosition(pos)
		self.layer:setScale(SCALEY)
		moveDialog(pos,pos)
		self.parent:addChild(self.bg)
	end,
}
--[[
	单选按钮 or tab
	
	根据按钮配置文件创建
	
	必要参数 btnCfg按钮配置
	
	可选参数 texts文本内容表
	
	可选参数 textsColor文本颜色表
--]]

Radio = {
	options = {},
	txts = {},
	create = function (self,btnCfg,texts)
		self.options = new({})
		for i = 1 , table.getn(btnCfg.positions) do
			local text = ""
			local color = nil
			if (texts ~= nil and texts[i] ~= nil) then
				text = texts[i]
				if (btnCfg.textsColor ~= nil and btnCfg.textsColor[i] ~= nil) then
					color = btnCfg.textsColor[i]
				end
			end
			self.options[i],self.txts[i] = self:createRadioButton(btnCfg.positions[i],btnCfg,text,color)			
		end
	end,
	
	createRadioButton = function(self,position,btnCfg,text,textsColor)
		local normalSpr = CCSprite:spriteWithFile(btnCfg.normal)
		local togglelSpr = ""
		
		if btnCfg.toggle ~= nil and btnCfg.toggle ~= "" then
			togglelSpr = CCSprite:spriteWithFile(btnCfg.toggle)
		end
		
		if btnCfg.toggleColor ~= nil then
			togglelSpr = CCSprite:spriteWithFile(btnCfg.normal)
			normalSpr:setColor(btnCfg.toggleColor)
		end
		
		if btnCfg.toggleScale ~= nil then
			togglelSpr = CCSprite:spriteWithFile(btnCfg.normal)
			togglelSpr:setScale(btnCfg.toggleScale)
		end

		if btnCfg.toggleScaleAndColor ~= nil then
			togglelSpr = CCSprite:spriteWithFile(btnCfg.normal)
			togglelSpr:setScale(btnCfg.toggleScaleAndColor.scale)
			togglelSpr:setColor(btnCfg.toggleScaleAndColor.color)
		end
		
		local btn = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
		btn:setPosition(position)
		
		if btnCfg.align ~= nil then
			btn:setAnchorPoint(btnCfg.align)
		end
		
		local txt = nil
		if text ~= nil and text ~= "" then	
			
			txt = CCLabelTTF:labelWithString(text, SYSFONT[EQUIPMENT], btnCfg.fontSize)
			txt:setAnchorPoint(CCPoint(0.5, 0.5))
			if textsColor ~= nil and textsColor ~= "" then	
			txt:setColor(textsColor)
			end
			
			txt:setPosition(CCPoint(btn:getContentSize().width / 2, btn:getContentSize().height / 2))
			btn:addChild(txt)			
		end
		
        return btn,txt
	end
}
--[[
	按钮缩放型
	
	根据图片创建
	
	必要参数 bg按钮素材 sc 按钮点击缩放 col按钮点击变色
	
	可选参数 txt按钮文本内容 tcol按钮内容颜色
--]]
ButtonScale = {
	btn = nil,
	txt = nil,
		
	create = function (self,bg,sc,col,txt,tcol,txtsize)
		local color = ccc3(255,255,255)
		if col ~= nil then
			color = col
		end
		
		self.btn = dbUIButtonScale:buttonWithImage(bg,sc,color)
		
		if txt ~= nil and txt ~= "" then
			if txtsize == nil then
				txtsize = 30
			end
			self.txt = CCLabelTTF:labelWithString(txt, SYSFONT[EQUIPMENT], txtsize)
			self.txt:setAnchorPoint(CCPoint(0.5, 0.5))
			self.txt:setPosition(CCPoint(self.btn:getContentSize().width / 2, self.btn:getContentSize().height / 2))
			if tcol ~= nil then
				self.txt:setColor(tcol)
			end
			self.btn:addChild(self.txt)		
		end
	end
}
Label = {
	label = nil,
	create = function(self,text,labCfg)
		local fontSize = 30
		if labCfg.fontsize ~= nil then
			fontSize = labCfg.fontsize
		end
		
		local ccsize = CCSize(0,0)
		if labCfg.size ~= nil then
			ccsize = labCfg.size
		end

		local align = 0
		if labCfg.align == "left" then
			align = 0
		elseif labCfg.align == "center" then
			align = 1
		elseif labCfg.align == "right" then
			align = 3
		end

		self.label = CCLabelTTF:labelWithString(text,ccsize,align,labCfg.font,fontSize)

		if labCfg.scale ~= nil then
			self.label:setScale(labCfg.scale)
		end
		local align = CCPoint(0, 0.5)

		if labCfg.align == "center" then
			align = CCPoint(0.5, 0.5)
		end

		self.label:setAnchorPoint(align)
		self.label:setPosition(labCfg.position)

		if labCfg.color ~= nil then
			self.label:setColor(labCfg.color)
		end
	end,
}

--[[
create labels
need texts and labCfg
labCfg need positions
]]--

labelBasicConfig = {
	font = SYSFONT[EQUIPMENT],
	fontsize = 30,
	align = "left",
	position = CCPoint(110, 42),
}

Labels = {
	labels = {},
	create = function(self,texts,labCfgs)
		self.labels = new({})
		for i = 1 , table.getn(labCfgs.position) do
			local cfg = new(labelBasicConfig)
			cfg.position = labCfgs.position[i]
			cfg.fontsize = labCfgs.fontsize[i]  		--添加自定义字体大小
			if labCfgs.color ~= nil then
				cfg.color = labCfgs.color[i]
			end
			local l = new(Label)
			l:create(texts[i],cfg)
			self.labels[i] = l.label
		end
	end,
}

--用图片表示数字
NumberLabel = {
	bg = nil,
	imageDir = "UI/numbers/yellow/",
	
	create = function(self,number,cfg)
		self.bg = dbUIPanel:panelWithSize(CCSize(0,0))
		if cfg then
			self.imageDir = cfg.imageDir or "UI/numbers/yellow/"
			self.isPositive = cfg.isPositive or true
		end
		if number<0 then
			self.isPositive = false
			number = -number
		end
		
		local offsetX = 0
		local numbSprHeight = 0
		local createNumber = function(n)
			local spr= CCSprite:spriteWithFile(self.imageDir..n..".png")
			spr:setPosition(CCPoint(offsetX, 0))
			spr:setAnchorPoint(CCPoint(0,0))
			self.bg:addChild(spr)
			offsetX = offsetX - spr:getContentSize().width
			numbSprHeight = spr:getContentSize().height
		end

		local temp = number
		while true do
			local head = math.floor(temp/10)
			createNumber(temp%10)
			if head > 0 then
				temp = head
			else
				break
			end
		end
		
		--负数
		if self.isPositive == false then
			local spr= CCSprite:spriteWithFile(self.imageDir.."-.png")
			spr:setPosition(CCPoint(offsetX, numbSprHeight/2))
			spr:setAnchorPoint(CCPoint(0,0))
			self.bg:addChild(spr)
		end
	end
}

--用图片表示百分数
PercentLabel = {
	bg = nil,
	create = function(self,percent,scale)
		self.bg = dbUIPanel:panelWithSize(CCSize(0,0))
		local bfh= CCSprite:spriteWithFile("UI/numbers/yellow/baifenhao.png")
		if scale~=nil then
		bfh:setScale(scale)
		end
		bfh:setPosition(CCPoint(0, 0))
		bfh:setAnchorPoint(CCPoint(0,0))
		self.bg:addChild(bfh)
		
      
		local offsetX = -20
		 if scale~=nil then
		offsetX = -12
		end
		local createNumber = function(n)
			local spr= CCSprite:spriteWithFile("UI/numbers/yellow/"..n..".png")
			
			if scale~=nil then
		    spr:setScale(scale)
		    end
			spr:setPosition(CCPoint(offsetX, 0))
			spr:setAnchorPoint(CCPoint(0,0))
			self.bg:addChild(spr)
			
			offsetX = offsetX-spr:getContentSize().width
			
			if scale~=nil then
		    offsetX = offsetX+5
		    end
		end

		local temp = math.floor(percent * 100)
		if temp >100 then
			temp=100
		end
		while true do
			local head = math.floor(temp/10)
			createNumber(temp%10)
			if head > 0 then
				temp = head
			else
				break
			end
		end
	end
}
--多色文字，其实是多个串联label
--只能实现单行，多行要多次创建
colorfulLabel = {
	labels = {},
	create = function(self,labCfgs)
		--self.labels = new({})
		for i = 1 , table.getn(labCfgs.text) do
			local cfg = new(labelBasicConfig)
			cfg.position = labCfgs.position
			cfg.fontSize = labCfgs.fontsize[i]
			cfg.text = labCfgs.text[i]
			cfg.color = labCfgs.color[i]
			self.labels[i] = CCLabelTTF:labelWithString(cfg.text,cfg.font,cfg.fontSize)
			self.labels[i]:setColor(cfg.color)
			if i==1 then
				self.labels[i]:setPosition(cfg.position)
			else
				local w,h=self.labels[i-1]:getPosition()
				--local h=self.labels[i-1]:getPosition()
				self.labels[i]:setPosition(CCPoint(w + self.labels[i-1]:getContentSize().width,h))
			end
			self.labels[i]:setAnchorPoint(CCPoint(0, 0))

		end
	end
}
SimpleTipPanel =
{
	tipPanelFadeHand = nil,
	tipPanelClearHand = nil,
	showLayer = nil,
	create = function(self,texts,col,t)

		if self.tipPanelFadeHand ~= nil and self.tipPanelClearHand ~= nil then
			return
		end

		if col == nil or col == "" then
			col = ccc3(255,204,153)
		end

		local sTX = CCLabelTTF:labelWithString(texts, SYSFONT[EQUIPMENT], 28)
		sTX:setAnchorPoint(CCPoint(0.5, 0.5))
		sTX:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
		sTX:setColor(col)

		local success_bg = dbUIWidgetBGFactory:widgetBG()
		success_bg:setCornerSize(CCSizeMake(40,40))
		success_bg:setBGSize(CCSizeMake(sTX:getContentSize().width + 60,sTX:getContentSize().height + 60))
		success_bg:setAnchorPoint(CCPoint(0.5,0.5))
		success_bg:createCeil("UI/baoguoPanel/kuang.png")
		success_bg:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
		
		local fadeOff = function()
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.tipPanelFadeHand)
			if sTX ~= nil then
				sTX:runAction(CCFadeTo:actionWithDuration(0.5,0))
				success_bg:mRunAction(CCFadeTo:actionWithDuration(0.5,0))
			end
			self.tipPanelFadeHand = nil
		end
		
		local unschedule = function()
			if self.tipPanelFadeHand then
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.tipPanelFadeHand)
				self.tipPanelFadeHand = nil
			end
			if self.tipPanelClearHand then
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.tipPanelClearHand)
				self.tipPanelClearHand = nil
			end
		end
		local clear = function()
			unschedule()
			if self.showLayer then
				self.showLayer:removeFromParentAndCleanup(true)
				self.showLayer = nil
			end
		end
		
		self.tipPanelFadeHand = CCScheduler:sharedScheduler():scheduleScriptFunc(fadeOff, 1, false)
		self.tipPanelClearHand = CCScheduler:sharedScheduler():scheduleScriptFunc(clear, 1.5, false)

		local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		mask.m_nScriptClickedHandler = function()
			clear()
		end
		
		mask:addChild(success_bg)
		mask:addChild(sTX)
		mask:setScale(SCALEY)
		
		self.showLayer = dbUILayer:node()
		self.showLayer:addChild(mask)
		self.showLayer:registerScriptHandler(function(eventType)
			if eventType == kCCNodeOnExit then
				unschedule()
			end
		end)
		
		local scene = DIRECTOR:getRunningScene()
		scene:addChild(self.showLayer,6000)
	end,
}

DialogTipPanel =
{
	txt = nil,
	okBtn = nil,
	closeBtn = nil,
	diglogLayer = nil,
	myBG = nil,
	
	create = function(self,texts,col,height,width)
		local scene = DIRECTOR:getRunningScene()
		self.diglogLayer = dbUILayer:node()
		
		self.diglogLayer:setPosition(CCPoint(WINSIZE.width / 2 ,WINSIZE.height / 2))
		self.diglogLayer:setAnchorPoint(CCPoint(0, 0))
		self.diglogLayer:setScale(SCALEY)
		scene:addChild(self.diglogLayer,5000)
		
		if col == nil or col == "" then
			col = ccc3(255,204,153)
		end
		
		--遮掩层
		local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(0, 0)
		mask:setScale(1/SCALEY)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		self.diglogLayer:addChild(mask)
				
		local _height = height==nil and 300 or height
		local _width = width==nil and 450 or width
		self.myBG = dbUIWidgetBGFactory:widgetBG()
		self.myBG:setCornerSize(CCSizeMake(70,70))
		self.myBG:setBGSize(CCSizeMake(_width,_height))
		self.myBG:setAnchorPoint(CCPoint(0.5,0.5))
		self.myBG:createCeil("UI/public/tankuang_bg.png")
		self.myBG:setPosition(0,0)
		self.diglogLayer:addChild(self.myBG)

		if texts ~= nil or texts ~= "" then
			self.txt = CCLabelTTF:labelWithString(texts,CCSizeMake(_width-70, _height-100), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 26)
			self.txt:setAnchorPoint(CCPoint(0.5, 0.5))
			self.txt:setPosition(CCPoint(10,_height/2-70))
			self.txt:setColor(col)
			self.diglogLayer:addChild(self.txt)
		end
		--okBtn
		self.okBtn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
		self.okBtn:setAnchorPoint(CCPoint(0.5,0))
		self.okBtn:setPosition(CCPoint(-80,30-_height/2))
		self.okBtn.m_nScriptClickedHandler = function()
		end
		self.diglogLayer:addChild(self.okBtn)
		
		--closeBtn
		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_btn.png", 1, ccc3(125, 125, 125))
		closeBtn:setAnchorPoint(CCPoint(0.5,0))
		closeBtn:setPosition(CCPoint(80,30 - _height/2))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.diglogLayer:addChild(closeBtn)
		self.closeBtn = closeBtn
		return self
	end,
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.diglogLayer)
        self.diglogLayer = nil
	    self.txt = nil
		self.okBtn = nil
		self.closeBtn = nil
		self.diglogLayer = nil
		self.myBG = nil
	end
}

DialogTipCenterPanel =
{
	txt = nil,
	okBtn = nil,
	closeBtn = nil,
	diglogLayer = nil,
	myBG = nil,
	
	create = function(self,texts,col,height,width)
		local scene = DIRECTOR:getRunningScene()
		self.diglogLayer = dbUILayer:node()
		
		self.diglogLayer:setPosition(CCPoint(WINSIZE.width / 2 ,WINSIZE.height / 2))
		self.diglogLayer:setAnchorPoint(CCPoint(0, 0))
		self.diglogLayer:setScale(SCALEY)
		scene:addChild(self.diglogLayer,5000)
		
		if col == nil or col == "" then
			col = ccc3(255,204,153)
		end
		
		--遮掩层
		local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(0, 0)
		mask:setScale(1/SCALEY)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		self.diglogLayer:addChild(mask)
				
		local _height = height==nil and 300 or height
		local _width = width==nil and 450 or width
		self.width = _width
		self.height = _height
		
		self.myBG = dbUIWidgetBGFactory:widgetBG()
		self.myBG:setCornerSize(CCSizeMake(70,70))
		self.myBG:setBGSize(CCSizeMake(_width,_height))
		self.myBG:setAnchorPoint(CCPoint(0.5,0.5))
		self.myBG:createCeil("UI/public/tankuang_bg.png")
		self.myBG:setPosition(0,0)
		self.diglogLayer:addChild(self.myBG)

		--okBtn
		self.okBtn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
		self.okBtn:setAnchorPoint(CCPoint(0,0))
		self.okBtn:setPosition(CCPoint(0, 30))
		self.okBtn.m_nScriptClickedHandler = function()
		end
		self.myBG:addChild(self.okBtn)
		
		--closeBtn
		self.closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_btn.png", 1, ccc3(125, 125, 125))
		self.closeBtn:setAnchorPoint(CCPoint(0,0))
		self.closeBtn:setPosition(CCPoint(0, 30))
		self.closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.myBG:addChild(self.closeBtn)
		
		if texts ~= nil or texts ~= "" then
			self.txt = CCLabelTTF:labelWithString(texts,CCSizeMake(_width - 70, 0), CCTextAlignmentCenter, SYSFONT[EQUIPMENT], 26)
			self.txt:setAnchorPoint(CCPoint(0, 1))
			self.txt:setPosition(CCPoint(35, 0))
			self.txt:setColor(col)
			self.myBG:addChild(self.txt)
		end
		
		self:resetPosition()
		
		return self
	end,
	
	resetPosition = function(self)
		local availibleWidth = self.width - self.okBtn:getContentSize().width - self.closeBtn:getContentSize().width
		local availibleHeight = self.height - 30 - math.max(self.okBtn:getContentSize().height, self.closeBtn:getContentSize().height)
		self.okBtn:setAnchorPoint(CCPoint(0,0))
		self.okBtn:setPositionX(availibleWidth / 3)
		self.closeBtn:setAnchorPoint(CCPoint(0,0))
		self.closeBtn:setPositionX(availibleWidth / 3 * 2 + self.okBtn:getContentSize().width)
		
		self.txt:setAnchorPoint(CCPoint(0, 0.5))
		self.txt:setPositionY(self.height - availibleHeight / 2)
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.diglogLayer)
        self.diglogLayer = nil
	    self.txt = nil
		self.okBtn = nil
		self.closeBtn = nil
		self.diglogLayer = nil
		self.myBG = nil
	end
}

ConfirmDialog =
{
	cfg = nil, --text必须,onClickOk--必须,onClickClose, width,height,color, fontSize,okImage,closeImage,bgImage
	
	show = function(self,cfg)
		--ccc3(255,206,103)
		cfg.color = cfg.color or ccc3(253,205,156)
		cfg.fontSize = cfg.fontSize or 30
		cfg.okImage = cfg.okImage or "UI/public/ok_btn.png"
		cfg.closeImage = cfg.closeImage or "UI/public/close_btn.png"
		cfg.bgImage = cfg.bgImage or "UI/public/tankuang_bg.png"
		cfg.clickParams = cfg.clickParams or {}
			
		local scene = DIRECTOR:getRunningScene()
		
		self.diglogLayer = dbUILayer:node()
		scene:addChild(self.diglogLayer,5000)
		
		--遮掩层
		local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(CCPoint(WINSIZE.width / 2 ,WINSIZE.height / 2))
		mask:setScale(1/SCALEY)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		mask.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.diglogLayer:addChild(mask)
				
		local textLabel = CCLabelTTF:labelWithString(cfg.text, SYSFONT[EQUIPMENT], cfg.fontSize)
		textLabel:setAnchorPoint(CCPoint(0.5, 1))
		textLabel:setColor(cfg.color)
		
		--okBtn
		local okBtn = dbUIButtonScale:buttonWithImage(cfg.okImage, 1.2, ccc3(125, 125, 125))
		okBtn:setAnchorPoint(CCPoint(0.5,0.5))
		okBtn.m_nScriptClickedHandler = function()
			self:destroy()
			cfg.onClickOk(cfg.clickParams)
		end
		
		--closeBtn
		local closeBtn = dbUIButtonScale:buttonWithImage(cfg.closeImage, 1.2, ccc3(125, 125, 125))
		closeBtn:setAnchorPoint(CCPoint(0.5,0.5))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
			if cfg.onClickClose then cfg.onClickClose() end
		end
		
		local labelSize = textLabel:getContentSize()
		local btnHeight = okBtn:getContentSize().height
		local btnWidth = okBtn:getContentSize().width
		local dialogHeight = cfg.height==nil and labelSize.height + btnHeight + 100 or cfg.height
		local dialogWidth = cfg.width==nil and labelSize.width + 80 or cfg.width
		
		local bg = createBG(cfg.bgImage,dialogWidth,dialogHeight)
		bg:setAnchorPoint(CCPoint(0.5,0.5))
		bg:setPosition(CCPoint(WINSIZE.width / 2 ,WINSIZE.height / 2))
		bg:setScale(HUD_SCALE)
		
		textLabel:setPosition(CCPoint(dialogWidth/2,dialogHeight-40))
		bg:addChild(textLabel)

		okBtn:setPosition(CCPoint(dialogWidth/4,60))
		bg:addChild(okBtn)

		closeBtn:setPosition(CCPoint(dialogWidth*3/4,60))
		bg:addChild(closeBtn)
						
		self.diglogLayer:addChild(bg)
		return self
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.diglogLayer)
	    self.cfg = nil
	end
}

createTipPanelBg = function(width,height)
	local bgLayer = CCLayer:node()

	--遮掩层
	local mask = dbUIPanel:panelWithSize(WINSIZE)
	mask:setPosition(0, 0)
	mask:setScale(1/SCALEY)
	mask:setAnchorPoint(CCPoint(0.5,0.5))
	bgLayer:addChild(mask)
	local w = width==nil and 880 or width
	local h = height==nil and 350 or height
	local bgSize = CCSizeMake(w ,h)
	return bgSize,bgLayer
end


createTipCenterWidget = function(bgLayerSize,bgLayer)
	local uiLayer = dbUILayer:node()

	local parent = dbUIPanel:panelWithSize(WINSIZE)
	parent.m_nScriptClickedHandler = function()
		bgLayer:removeFromParentAndCleanup(true)
		uiLayer:removeFromParentAndCleanup(true)
	end
	uiLayer:addChild(parent)

	local centerWidget = dbUIPanel:panelWithSize(bgLayerSize)
	centerWidget:setAnchorPoint(CCPoint(0.5, 0.5))
	centerWidget:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
	uiLayer:addChild(centerWidget)

	centerWidget:setScale(SCALEY)
	return uiLayer,centerWidget,parent
end
createPanelBg = function()
    local bgLayer = dbUILayer:node()
    --[[
	local bg = dbUIWidgetTiledBG:tiledBG("UI/public/recuit_bg.png",WINSIZE)
	bg:setPosition(WINSIZE.width/2, WINSIZE.height/2)
	bgLayer:addChild(bg)
	
	
	--遮掩层
	local mask = dbUIPanel:panelWithSize(WINSIZE)
	mask:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
	mask:setAnchorPoint(CCPoint(0.5,0.5))
	bgLayer:addChild(mask)
	--]]
	return bgLayer
end
createSystemPanelBg = function()
    local bgLayer = dbUILayer:node()
	--[[
	--遮掩层
	local mask = dbUIPanel:panelWithSize(WINSIZE)
	mask:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
	mask:setAnchorPoint(CCPoint(0.5,0.5))
	bgLayer:addChild(mask)
	--]]
	return bgLayer
end
createCenterWidget = function()
    local uiLayer = dbUIMask:node()
    local centerWidget = dbUIPanel:panelWithSize(CCSize(1010, 702))
    centerWidget:setAnchorPoint(CCPoint(0.5, 0.5))
    centerWidget:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
    centerWidget:setScale(SCALE)
    uiLayer:addChild(centerWidget)
	return uiLayer,centerWidget
end

createMainWidget = function()
	local mainWidget = dbUIPanel:panelWithSize(CCSize(1010, 598))
	mainWidget:setAnchorPoint(CCPoint(0, 0))
	mainWidget:setPosition(CCPoint(0, 0))
	return mainWidget
end

function createBG(bgImage,width,height,cornnerSize)
	local myBG = dbUIWidgetBGFactory:widgetBG()
	if cornnerSize then
		myBG:setCornerSize(cornnerSize)
	else
		myBG:setCornerSize(CCSizeMake(40,40))
	end
	myBG:setBGSize(CCSizeMake(width,height))
	myBG:createCeil(bgImage)
	return myBG
end

function createDarkBG(width,height)
	local myBG = dbUIWidgetBGFactory:widgetBG()
	myBG:setCornerSize(CCSizeMake(80,80))
	myBG:setBGSize(CCSizeMake(width,height))
	myBG:createCeil("UI/public/recuit_dark.png")
	return myBG
end

--不拉伸的，指定背景图和框大小的panel
function createImagePanel(image,width,height)
    local panel = dbUIPanel:panelWithSize(CCSize(width, height))
    panel:setAnchorPoint(CCPoint(0.5,0.5))
    local bg = CCSprite:spriteWithFile(image)
    bg:setAnchorPoint(CCPoint(0.5,0.5))
    bg:setPosition(CCPoint(width/2,height/2))
    panel:addChild(bg)
	return panel
end

function createPanel(image)
    local bg = CCSprite:spriteWithFile(image)
    bg:setAnchorPoint(CCPoint(0.5,0.5))
    bg:setPosition(CCPoint(bg:getContentSize().width/2,bg:getContentSize().height/2))
    
    local panel = dbUIPanel:panelWithSize(bg:getContentSize())
    panel:setAnchorPoint(CCPoint(0,0))
    panel:addChild(bg)
	return panel
end

UiBgPanel = {
	background = nil,
	panel = nil,
	create = function(self,cfg)		
		local bg = "UI/public/dialog_kuang.png"
		local panelSize = WINSIZE
		local corner = {
			widght = 30,
			height = 30,
		}
		
		if cfg.bg ~= nil then
			bg = cfg.bg
		end
		
		if cfg.panelSize ~= nil then
			panelSize = cfg.panelSize
		end
		
		if cfg.corner ~= nil then
			corner = cfg.corner
		end
		
		local uiPanel = dbUIPanel:panelWithSize(panelSize)		
		local bgSpr = dbUIWidgetBGFactory:widgetBG()
		bgSpr:setCornerSize(CCSizeMake(corner.widght,corner.height))
		bgSpr:setBGSize(panelSize)
		bgSpr:createCeil(bg)		
		bgSpr:setPosition(CCPoint(panelSize.width / 2, panelSize.height / 2))
		bgSpr:setAnchorPoint(CCPoint(0.5,0.5))
		
		local dang = CCNode:node()
		dang:setContentSize(panelSize)
		dang:addChild(bgSpr)
		uiPanel:addChild(dang)
		self.background = bgSpr
		self.panel = uiPanel
		return self
	end,
}
--新手引导相关
--UserGuideDirectionLeft = 0
--UserGuideDirectionRight = 1
--UserGuideDirectionUp = 2
--UserGuideDirectionDown = 3

local UserGuide = {}

UserGuide.curUserGuide = nil

---返回引导高亮区域的位置和大小
UserGuide.convertPos = function(node,scale)
	if scale == nil then scale = SCALE end
	
	local x,y = node:getParent():getPosition()
	local px,py = node:getPosition()
	
	--转化成屏幕坐标
	local position = node:getParent():convertToWorldSpace(CCPoint(px,py))

	local ap = node:getAnchorPoint()
	local size = node:getContentSize()
	
	local x = position.x - ap.x * size.width * scale
	local y = position.y - ap.y * size.height * scale
	
	return CCPoint(x,y), multSize(size, scale)
end

---找到背包中的礼包
UserGuide.findGrowGift = function(level)
	local itemKuangs = G_BaoGuoPanel.pagePanels[1].items
	local itemInfos = G_BaoGuoPanel.pagePanels[1].itemInfos

	for i=1,#itemInfos do
		local itemInfo = itemInfos[i]
		local libaoId = (41010001 + math.floor(level/10))
		if itemInfo and itemInfo.cfg_item_id == libaoId then
			return itemKuangs[i]
		end
	end
end

---删除引导层
UserGuide.removeGuideLayer = function()
	if UserGuide.curUserGuide.guideLayer then
		UserGuide.curUserGuide.guideLayer:closeGuide()
		UserGuide.curUserGuide.guideLayer = nil
	end
end

---创建引导层
UserGuide.createUserGuideLayer = function(node,size,position,text,direction,scale)
	if scale == nil then scale = SCALE end
	UserGuide.curUserGuide.guideLayer = UserGuideLayer:create(0)
	UserGuide.curUserGuide.guideLayer:showGuide(node,size,position,scale,text,direction)
end

---打开主界面上的功能展开菜单
UserGuide.openHudOpenBtn = function()
	local hud = dbHUDLayer:shareHUD2Lua()
	local scale = hud:getScale()
	
	if not hud:isOpenHudBtns() then
		local openBtn = hud:getChildByTag(1)
		local x,y = openBtn:getPosition()
		local size = multSize(openBtn:getContentSize(),scale)
		local position = CCPoint((x - openBtn:getContentSize().width) * scale, y * scale + 5)
		UserGuide.createUserGuideLayer(openBtn,size, position ,"点这里",1,scale)
	else
		GotoNextStepGuide()
	end
end

---打开主界面上的功能菜单
UserGuide.openHudBtn = function(tag,direction)
	local hud = dbHUDLayer:shareHUD2Lua()
	local scale = hud:getScale()
	
	local hudBtn = hud:getChildByTag(tag)
	local x,y = hudBtn:getPosition()
	local ap = hudBtn:getAnchorPoint()

	local x = (x - ap.x * hudBtn:getContentSize().width) * scale
	local y = (y - ap.y * hudBtn:getContentSize().height)* scale
	local position = CCPoint(x,y)

	local size = multSize(hudBtn:getContentSize(),scale)
	
	UserGuide.createUserGuideLayer(hudBtn,size,position,"点这里",direction,scale)
end

---所有引导的定义
local GuideDefines = {}

---任务引导
GuideDefines.task = {
	function()
		GotoNextStepGuide()
	end,
	function()
		GotoNextStepGuide()
	end,
	function()
		GotoNextStepGuide()
	end,		
	function()
		if GlobleTaskPanel == nil then
			StopUserGuide()
			dbTaskMgr:getSingletonPtr():taskPathing(1)
			return
		end
		
		local taskBtns = GlobleTaskPanel.btns
		local mainBtn = taskBtns[1]

		local btn = mainBtn
		local position,size = UserGuide.convertPos(btn)

		UserGuide.curUserGuide.guideLayer = UserGuideLayer:create(1)
		UserGuide.curUserGuide.guideLayer:showGuide(btn,size,position,SCALE,"点这里",1)
	end,
	function()
		local btn = GlobleTaskPanel.function_btn
		local position,size = UserGuide.convertPos(btn)

		UserGuide.curUserGuide.guideLayer = UserGuideLayer:create(1)
		UserGuide.curUserGuide.guideLayer:showGuide(btn,size,position,SCALE,"点这里",1)
	end,
}

onTaskPanelClosed = function()
	if UserGuide.curUserGuide and UserGuide.curUserGuide.name == "task" then
		StopUserGuide()
		CloseAutoPath()
		--StartAutoPathGuide()
	end
end

---打开一级礼包
GuideDefines.open_gift_1 = {
	function() 
		UserGuide.openHudOpenBtn()
	end,
	function() 
		UserGuide.openHudBtn(302,3)
	end,
	function() 
		local btn = UserGuide.findGrowGift(1)
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,
	function() 
		local btn = GlobalItemUseBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = G_BaoGuoPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		GotoNextStepGuide()
		StartAutoPathGuide()
	end,
}

---打开十级礼包
GuideDefines.open_gift_10 = {
	function() 
		UserGuide.openHudOpenBtn()
	end,
	function() 
		UserGuide.openHudBtn(302,3)
	end,
	function() 
		local btn = UserGuide.findGrowGift(10)
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,
	function() 
		local btn = GlobalItemUseBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = G_BaoGuoPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		GotoNextStepGuide()
		DispatchEvent("equip")
	end,	
}

---强化装备
GuideDefines.forge = {
	function() 
		UserGuide.openHudOpenBtn()
	end,
	function() 
		UserGuide.openHudBtn(303,3)
	end,
	function() 
		local btn = GlobleQHPanel.qhp.rolePanel.part1
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",3)
	end,
	function() 
		local btn = GlobleQHPanel.qhp.qiang_hua_btn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobleQHPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		GotoNextStepGuide()
		StartAutoPathGuide()
	end,	
}

---穿装备
GuideDefines.equip = {
	function() 
		UserGuide.openHudOpenBtn()
	end,
	function() 
		UserGuide.openHudBtn(301,3)
	end,
	function()
		local btn = GlobleGeneralListPanel.main.rolePanel
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,
	function() 
		local btn = GloblePanel.bbp.bbi.outKuang
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,
	function() 
		local btn = GlobalItemUseBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GloblePanel.top.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		GotoNextStepGuide()
		StartAutoPathGuide()
	end,	
}

---招募
GuideDefines.recruit = {
	function() 
		UserGuide.openHudOpenBtn()
	end,
	function() 
		UserGuide.openHudBtn(307,3)
	end,
	function()
		local btn = GlobleZhaoMuPanel.guidBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",3)
	end,
	function() 
		local btn = GlobleZhaoMuPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		GotoNextStepGuide()
		OpenNextStep()
	end,
}

---阵形升级，宠物上阵
GuideDefines.formation = {
	function() 
		UserGuide.openHudOpenBtn()
	end,
	function() 
		UserGuide.openHudBtn(308,3)
	end,
	function()
		local btn = GlobleZhenFanPanel.upLevelBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function()
		local hand = CCSprite:spriteWithFile("UI/formation/hand.png")
		hand:setPosition(CCPoint(169,475))
		hand:setAnchorPoint(CCPoint(0,0))
		GlobleZhenFanPanel.mainWidget:addChild(hand,10000)

		local moveTo = function()
			local move = CCMoveTo:actionWithDuration(2, CCPoint(650, 300))
			hand:runAction(move)
		end
		moveTo()

		local function update()
			hand:setPosition(CCPoint(169,475))
			moveTo()
		end
		GlobleZhenFanPanel.tick = CCScheduler:sharedScheduler():scheduleScriptFunc(update, 2, false)

		local btn = GlobleNotChuZhanRole
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"拖到右边",1)
	end,	
	function()
		CCScheduler:sharedScheduler():unscheduleScriptEntry(GlobleZhenFanPanel.tick)
		GlobleZhenFanPanel.tick = nil
		local btn = GlobleZhenFanPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
}

---科技
GuideDefines.talent = {
	function() 
		UserGuide.openHudOpenBtn()
	end,
	function() 
		UserGuide.openHudBtn(305,3)
	end,
	function()
		local btn = GlobleTianFuPanel.tfp.updateBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",3)
	end,
	function() 
		local btn = GlobleTianFuPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,	
}

---洗髓
GuideDefines.polish = {
	function() 
		UserGuide.openHudOpenBtn()
	end,
	function() 
		UserGuide.openHudBtn(301,3)
	end,
	function()
		local btn = GlobleGeneralListPanel.main.rolePanel
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,
	function() 
		local btn = GloblePanel.topBtns[2]
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,
	function() 
		local btn = GloblePanel.xsp.btn_PeiYang
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GloblePanel.xsp.btn_TiHuan
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,			
	function() 
		local btn = GloblePanel.top.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
}

---训练
GuideDefines.train = {
	function() 
		UserGuide.openHudOpenBtn()
	end,
	function() 
		UserGuide.openHudBtn(301,3)
	end,
	function()
		local btn = GlobleGeneralListPanel.main.rolePanel
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,
	function() 
		local btn = GloblePanel.topBtns[3]
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,
	function() 
		local btn = GloblePanel.xlp.btnsPanel.startBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,
	function() 
		local btn = GloblePanel.xlp.btnsPanel.startBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,
	function() 
		local btn = GloblePanel.xlp.doJumpBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,	
	function() 
		local btn = GloblePanel.top.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
}

---竞技场
GuideDefines.arena = {
	function() 
		UserGuide.openHudBtn(407,2)
	end,
	function()
		local btn = GlobleArenaPanel.firstArenaPlayer
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		--战斗中，什么也不做
	end,
	function() 
		local btn = GlobleArenaPanel.scoreMallBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local list = GlobleArenaScoreMallPanel.mallContentList
		local y = list:getContentSize().height - list:get_m_content_size().height
		list:m_setPosition(CCPoint(0,0))
		
		local btn = GlobleArenaScoreMallPanel.guideExchangeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,			
	function() 
		local btn = GlobleArenaScoreMallPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobleArenaPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,		
}

---祭星
GuideDefines.fate = {
	function() 
		UserGuide.openHudOpenBtn()
	end,
	function() 
		UserGuide.openHudBtn(306,3)
	end,
	function()
		local btn = GlobleXiaoXingXin
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",0)
	end,
	function() 
		local btn = GlobleFetePanel.getBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",3)
	end,
	function() 
		local btn = gotoBagBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local hand = CCSprite:spriteWithFile("UI/formation/hand.png")
		hand:setPosition(CCPoint(530,450))
		hand:setAnchorPoint(CCPoint(0,0))
		GlobleJiXingPanel.mainWidget:addChild(hand)

		local moveTo = function()
			local move = CCMoveTo:actionWithDuration(2, CCPoint(60, 430))
			hand:runAction(move)
		end
		moveTo()

		GlobleJiXingPanel.tick = nil
		local function update()
			hand:setPosition(CCPoint(530,450))
			moveTo()
		end
		GlobleJiXingPanel.tick = CCScheduler:sharedScheduler():scheduleScriptFunc(update, 2, false)

		local btn = GlobleFirstWuHun
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"拖到左边",1)
	end,			
	function() 
		CCScheduler:sharedScheduler():unscheduleScriptEntry(GlobleJiXingPanel.tick)
		GlobleJiXingPanel.tick = nil
									
		local btn = GlobleJiXingPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobleFetePanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,	
}

---哈迪斯宝库
GuideDefines.hades = {
	function() 
		UserGuide.openHudBtn(418,0)
	end,
	function()
		local btn = GlobleHadesPanel.contributeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobleHadesPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,		
}

---古战场遗址
GuideDefines.ruins = {
	function() 
		UserGuide.openHudBtn(419,0)
	end,
	function()
		local btn = GlobalRuinsPanel.xunbao_btn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobalRuinsPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,		
}

---祈福
GuideDefines.wish = {
	function() 
		UserGuide.openHudBtn(413,0)
	end,
	function()
		local btn = GlobleWishPanel.wishBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobleWishPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,		
}

---战奴劳厂
GuideDefines.slave = {
	function() 
		UserGuide.openHudBtn(408,2)
	end,
	function()
		local btn = GlobleShenYuPanel.nuliBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobleSlaveWorkPanel.items[1].captueBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobleRecommendSlave
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobleCaptueBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,			
}

---佣兵任务
GuideDefines.yongbin = {
	function() 
		UserGuide.openHudBtn(408,2)
	end,
	function()
		local btn = GlobleShenYuPanel.yongBingBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function()
		local btn = GlobleYongBingMainPanel.yb.tasks[1].acceptBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobleYongBingMainPanel.yb.tasks[1].startBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobleYongBingMainPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,
	function() 
		local btn = GlobleShenYuPanel.closeBtn
		local position,size = UserGuide.convertPos(btn)
		
		UserGuide.createUserGuideLayer(btn,size,position,"点这里",1)
	end,				
}

---开始引导
function StartUserGuide(name)
	local hud = dbHUDLayer:shareHUD2Lua()
	if hud == nil then
		Log("StartUserGuide failed!! hud == nil")
		return
	end
	
	if UserGuide.curUserGuide then
		Log("StartUserGuide failed!! UserGuide.curUserGuide not nil")
		return
	end

	local steps = GuideDefines[name]
	if steps == nil then
		Log("no step defined name:"..name)
		return
	end

	CloseAutoPath()
		
	UserGuide.curUserGuide = {}
	UserGuide.curUserGuide.steps = steps
	UserGuide.curUserGuide.name = name
	UserGuide.curUserGuide.curStep = 0
	
	GotoNextStepGuide()
end

---引导下一步
function GotoNextStepGuide()
	local hud = dbHUDLayer:shareHUD2Lua()
	if hud == nil then
		Log("GotoNextStepGuide failed!! hud == nil")
		return
	end
	
	if UserGuide.curUserGuide == nil then
--		Log("no guid started!!")
		return
	end

	UserGuide.removeGuideLayer()

	local steps 	= UserGuide.curUserGuide.steps
	local curStep	= UserGuide.curUserGuide.curStep
	local name		= UserGuide.curUserGuide.name
	curStep = curStep + 1
	
	if curStep > #steps then
		StopUserGuide()
		return
	end
	
	Log("GotoNextStepGuide step: "..curStep.."  name "..UserGuide.curUserGuide.name)

	UserGuide.curUserGuide.curStep = curStep
	steps[curStep]()
end

---直接引导到具体阶段 
function GotoStepGuide(step)
	if UserGuide.curUserGuide == nil then
--		Log("no guid started!!")
		return
	end
	if step > #UserGuide.curUserGuide.steps then
		Log("step is large then the steps len!!")
		return
	end
	if step < UserGuide.curUserGuide.curStep then
		Log("step is done!! step "..step.." cur "..UserGuide.curUserGuide.curStep)
		return
	end
	
	UserGuide.removeGuideLayer()
	Log("GotoStepGuide step: "..step.."  name "..UserGuide.curUserGuide.name)

	if step > #UserGuide.curUserGuide.steps then
		StopUserGuide()
		return
	end
		
	UserGuide.curUserGuide.steps[step]()
	UserGuide.curUserGuide.curStep = step
end

---结束引导 
function StopUserGuide()
	if UserGuide.curUserGuide then
		Log("StopUserGuide "..UserGuide.curUserGuide.name)
		
		UserGuide.removeGuideLayer()
		UserGuide.curUserGuide = nil
	end
end

---判断是否正在引导
function CheckUserGuiding()
	if GolbalEventPanel then
		return 1
	end
	if UserGuide.curUserGuide then
		return 1
	end
	return 0
end

-------------------------------------------------------自动寻路相关--------------------------------------
---自动寻路引导
local AutoPath = nil

--- 显示自动寻路
function StartAutoPathGuide()
	local hud = dbHUDLayer:shareHUD2Lua()
	if hud == nil then
		return
	end
	
	if AutoPath then
		return
	end

	if not CheckNeedAutoPath() then
		return
	end
	
	Log("StartAutoPathGuide.........")
	
	local head = hud:getChildByTag(204)
	
	local guideWidget = CCSprite:spriteWithFile("UI/user_guide/guide_right.png")
	guideWidget:setAnchorPoint(CCPoint(1,0.5))
	guideWidget:setPosition(CCPoint(0,100/2))
	head:addChild(guideWidget)

	local label = CCLabelTTF:labelWithString("点击自动寻路", CCSizeMake(300, 0), CCTextAlignmentRight, "", 32)
	label:setPosition(CCPoint(218, guideWidget:getContentSize().height/2))
	label:setAnchorPoint(CCPoint(1,0.5))
	label:setColor(ccc3(255,209,68));
	guideWidget:addChild(label)

	local guideAction = 
		CCRepeatForever:actionWithAction(
		CCSequence:actionOneTwo(
		CCMoveBy:actionWithDuration(0.5, CCPoint(30, 0)),
		CCMoveBy:actionWithDuration(0.5, CCPoint(-30,0))))
	guideWidget:runAction(guideAction);
	
	AutoPath = guideWidget
end

---关闭自动寻路引导
function CloseAutoPath() 
	if AutoPath then
		AutoPath:removeFromParentAndCleanup(true)
		AutoPath = nil
	end
end

---任务做到一定时候，任务引导就不要了
CheckNeedTaskGuide= function()
	local task = dbTaskMgr:getSingletonPtr():getMainTaskInfo()
	return task and task.mID < 10007
end

---任务做到一定时候寻路就不要了
CheckNeedAutoPath = function()
	local task = dbTaskMgr:getSingletonPtr():getMainTaskInfo()
	return task and task.mID < 10007
end

---刚登录的时候判断需不需要自动寻路引导
GlobleUserGuideCheckTime = 0;
function GlobleCheckAutoPath()
	if GlobleUserGuideCheckTime == 0 then
		local task = dbTaskMgr:getSingletonPtr():getMainTaskInfo()
		if task.mID ~= 10001 then
			StartAutoPathGuide()
		end
		GlobleUserGuideCheckTime = GlobleUserGuideCheckTime + 1
	end
end
---新功能开启相关

GlobalOpenNewFunctionPanel = nil

---新功能开启
local OpenStepList = {}

---升级后如果有新功能开启，则将其加到OpenStepList中
function GlobleAddStepOfficuim(officuim)
	if officuim == 0 then 
		return
	end
	
	---先查找有没有重复的
	for i=1,#OpenStepList do
		if OpenStepList[i] == officuim then
			return
		end
	end
	
	local stepCfg = openJson("cfg/cfg_step.json")

	local keys = Value:new()
	GlobalCfgMgr:getJsonKeys(stepCfg,keys)

	for i=1,keys:size() do
		local func_open = keys:getByIndex(i-1):asString()
		local step = stepCfg:getByKey(func_open)
		local require_officium = step:getByKey("require_officium"):asInt()
		if require_officium == officuim then
			table.insert(OpenStepList,func_open)
		end
	end
	
	OpenNextStep()
end

---打开新功能提示界面
function OpenNextStep()
	local hud = dbHUDLayer:shareHUD2Lua()
	if hud == nil then
		Log("OpenNextStep  hud == nil")
		return
	end
	
	if IsInWordMap() then
		Log("OpenNextStep  IsInWordMap")
		return
	end
	
	if #OpenStepList > 0 then
		local stepCfgJson = openJson("cfg/cfg_step.json")
		local func_open = OpenStepList[#OpenStepList] --取最新一个
		local stepCfg = stepCfgJson:getByKey(func_open)
		
		if GlobleTaskPanel ~= nil then
			GlobleTaskPanel:setIsVisible(false)
		end

		GlobalOpenNewFunctionPanel = new(OpenNewFunction):create(stepCfg)
		table.remove(OpenStepList,#OpenStepList)
	end
end

---开放新功能界面
OpenNewFunction = {
	create = function(self,step)
		local desc = step:getByKey("desc"):asString()
		local icon = step:getByKey("icon"):asString()
		local open = step:getByKey("open"):asString()
		local tag = step:getByKey("tag"):asInt()
		local stepId = step:getByKey("step_id"):asInt()
		
		local hud = dbHUDLayer:shareHUD2Lua()
		hud:updateHudStep(GloblePlayerData.officium)
		if tag > 300 and tag <= 310 then
			hud:showHudBtns()
		end
		local scale = hud:getScale()
		
		local scene = DIRECTOR:getRunningScene()

		local action = function()
			self:destroy()
			local target = hud:getChildByTag(tag)
			if target == nil then
				self:doOpen(open)
			else
				local time = 0.6
				local scheduler = nil
				local function move()
					self:doOpen(open)
					self.spr:removeFromParentAndCleanup(true)
					CCScheduler:sharedScheduler():unscheduleScriptEntry(scheduler)
				end
				scheduler = CCScheduler:sharedScheduler():scheduleScriptFunc(move, time, false)
				local x,y = target:getPosition()
				local action = CCMoveTo:actionWithDuration(time, CCPoint(x,y))
				self.spr:runAction(action)
			end		
		end
		
    	self.bgLayer = createPanelBg()
	    local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		mask.m_nScriptClickedHandler = function()
			action()
		end
		self.bgLayer:addChild(mask)
		
        scene:addChild(self.bgLayer, 3000)
	    
		--背景
		local bg = createPanel("UI/new_func_open/kuang.png")
		bg:setPosition(CCPoint(1010 / 2,702 / 2))
		bg:setPosition(CCPoint(WINSIZE.width / 2,WINSIZE.height / 2))
		bg:setAnchorPoint(CCPoint(0.5,0.5))
		bg.m_nScriptClickedHandler = function()
			action()
		end
		self.bgLayer:addChild(bg)
		self.bg = bg
		
		local title = CCSprite:spriteWithFile("UI/new_func_open/title.png")
		title:setPosition(CCPoint(bg:getContentSize().width / 2 , bg:getContentSize().height - 10))
		title:setAnchorPoint(CCPoint(0.5,0.5))
		bg:addChild(title)		
				
		local label = CCLabelTTF:labelWithString(desc, SYSFONT[EQUIPMENT], 26)
		label:setPosition(CCPoint(bg:getContentSize().width / 2,35))
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setColor(ccc3(254,205,52))
		bg:addChild(label)
		CCSpriteFrameCache:sharedSpriteFrameCache():addSpriteFramesWithFile("UI/HUD/HUD.plist")
		local i,j = string.find(icon,"HUD")
		local btn = nil
		if i == nil then
			btn = CCSprite:spriteWithFile(icon)
		else
			btn = CCSprite:spriteWithSpriteFrameName(icon)
		end
		btn:setPosition(CCPoint(bg:getContentSize().width / 2 - btn:getContentSize().width / 2, bg:getContentSize().height / 2  - btn:getContentSize().height / 2 + 20))
		btn:setAnchorPoint(CCPoint(0, 0))
		bg:addChild(btn)
		
		local sprWidth,sprHeight = WINSIZE.width /scale / 2  - btn:getContentSize().width  /scale/ 2, WINSIZE.height /scale / 2 - btn:getContentSize().width  /scale/ 2 + 20 / scale
		local spr = nil
		if i == nil then
			spr = CCSprite:spriteWithFile(icon)
		else
			spr = CCSprite:spriteWithSpriteFrameName(icon)
		end
		spr:setPosition(CCPoint(sprWidth, sprHeight))
		spr:setAnchorPoint(CCPoint(0, 0))
		hud:addChild(spr)
		self.spr = spr
		
		return self
	end,
	
	doOpen = function(self,open)
		local closeTaskPanel = function()
			if GlobleTaskPanel ~= nil then
				GlobleTaskPanel:destroy()
			end
		end
		closeTaskPanel()

		if open == "forge_open" then --强化
			StartUserGuide("forge")
		elseif open == "zhushou_open" then --升级助手
		elseif open == "zhao_mu_open" then  --招募
			StartUserGuide("recruit")
		elseif open == "formation_open" then  --阵型
			StartUserGuide("formation")
		elseif open == "talent_open" then  --科技
			StartUserGuide("talent")
		elseif open == "xisui_open" then  --洗髓
			StartUserGuide("polish")
		elseif open == "training_open" then --训练
			StartUserGuide("train")
		elseif open == "arena_open" then  --竞技场
			StartUserGuide("arena")
		elseif open == "soul_open" then  --祭星
			StartUserGuide("fate")
		elseif open == "hades_open" then --哈迪斯
			StartUserGuide("hades")
		elseif open == "boss_open" then  --boss战开启
		elseif open == "legion_open" then  --家族
		elseif open == "qifu_open" then  --祈福
			StartUserGuide("wish")
		elseif open == "jing_fuben_open" then --精英副本
			OpenNextStep()
		elseif open == "tuan_fuben_open" then --团队副本
			OpenNextStep()
		elseif open == "zb_sj_open" then  --装备升级
			OpenNextStep()
		elseif open == "xiangqian_open" then  --镶嵌
		elseif open == "shangcheng_open" then  --商城
		elseif open == "hecheng_open" then  --宝石合成
		elseif open == "gu_yiji_open" then  --古战场遗迹
			--StartUserGuide("ruins")
		elseif open == "manor_open" then --神域
			OpenNextStep()
		elseif open == "dock_open" then  --佣兵任务
			StartUserGuide("yongbin")
		elseif open == "nuli_open" then  --战奴劳场
			StartUserGuide("salve")
		elseif open == "gongcheng_open" then  --攻城战
		elseif open == "jicheng_open" then  --宠物继承
		end
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		
		GlobalOpenNewFunctionPanel = nil
	end
}
local bossWarPanel = nil
local SUM_BOSS_HP = 60000000
local BOSS_LEVEL = 1
local BOSS_NAME = ""
local BOSS_FACE = 0
local BOSS_INIT_SECTION = 1 --刚进地图时血的段数，共四段
IN_BOSS_WAR_SCENE = false
local StopPlayHpMove = false
local panelScale = caltScale(CCSize(1280,720))

local WaitForOpenlabel = nil
local WaitForOpenLabelBg = nil
local HUDCountdownTimeHandle = nil

local Panel = {
	cdText = nil ,
	secondHandle = nil ,
	
	weakCooldown = 0, --复活倒计时
	startCountDown = 0, --等待boss战开始倒计时
	endCountDown = 0, --boss战关闭倒计时
	roleNum  = 1,     --当前玩家数量
	
	create = function(self)
		local scene = DIRECTOR:getRunningScene()
		self.layer = dbUILayer:node()
		self.layer:setIsTouchEnabled(true)
		scene:addChild(self.layer,110)

		self.sum_boss_hp = SUM_BOSS_HP 		--总血量
		self.cur_sum_boss_hp = SUM_BOSS_HP 	--当前总血量
		
		self.section = BOSS_INIT_SECTION 	--当前血量是第几段
		self.section_hp = SUM_BOSS_HP/4 	--每一段的血量
		self.cur_section_hp = SUM_BOSS_HP/4 --当前每一段的血量

		self:createBossPanel()
		self:createLeftTip()
		self:createRightTip()
		self:createCooldownPanel()
		self:createEmbravePanel()
		self:createRevivePanel()
		
		self:initSecondHandle()
		self:registBattleCallback()
	end,
	
	--Boss血量头像等
	createBossPanel = function(self)
		local bossPanel = createImagePanel("UI/boss/boss_head_bg.png",477,62)
		bossPanel:setAnchorPoint(CCPoint(0.5,1))
		bossPanel:setPosition(CCPoint(WINSIZE.width/2,WINSIZE.height-20*panelScale))
		bossPanel:setScale(panelScale)
		self.layer:addChild(bossPanel)
		self.bossPanel = bossPanel
		
		local levelLabel = CCLabelTTF:labelWithString(BOSS_NAME .." 等级"..BOSS_LEVEL,SYSFONT[EQUIPMENT], 20)
		levelLabel:setAnchorPoint(CCPoint(0.5, 0))
		levelLabel:setPosition(CCPoint(250 ,36))
		levelLabel:setColor(ccc3(204,51,255))
		bossPanel:addChild(levelLabel)

		local head = CCSprite:spriteWithFile("head/Middle/head_middle_"..BOSS_FACE..".png")
		head:setAnchorPoint(CCPoint(0,0))
		head:setPosition(5,5)
		head:setScaleX(50/head:getContentSize().width)
		head:setScaleY(50/head:getContentSize().height)
		bossPanel:addChild(head)

		local cfg = new(BOSS_HP_BAR_CFG[self.section])
		cfg.addtions = (4-(self.section-1)).."×4"
		self.hpBar = new(Bar)
		self.hpBar:create(self.section_hp,cfg)
		self.hpBar:setExtent(self.cur_section_hp)
		bossPanel:addChild(self.hpBar.barbg)
	end,
		
	--左边战功鼓舞提示
	createLeftTip = function(self)
		local leftTipPanel = createImagePanel("UI/boss/gray_bg.png",283,332)
		leftTipPanel:setAnchorPoint(CCPoint(0,1))
		leftTipPanel:setPosition(CCPoint(20*panelScale,WINSIZE.height-50*panelScale))
		leftTipPanel:setScale(panelScale)
		self.layer:addChild(leftTipPanel)

		local label = CCLabelTTF:labelWithString("金币：", CCSizeMake(80,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(30*panelScale,self.layer:getContentSize().height-15*panelScale))
		label:setColor(ccc3(255,204,151))
		label:setScale(panelScale)
		self.layer:addChild(label)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.gold, CCSizeMake(250,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(80*panelScale,self.layer:getContentSize().height-15*panelScale))
		label:setColor(ccc3(255,102,0))
		label:setScale(panelScale)
		self.layer:addChild(label)
		self.goldLabel = label

		local label = CCLabelTTF:labelWithString("战功：", CCSizeMake(80,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(170*panelScale,self.layer:getContentSize().height-15*panelScale))
		label:setColor(ccc3(255,204,151))
		label:setScale(panelScale)
		self.layer:addChild(label)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.exploit, CCSizeMake(250,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(220*panelScale,self.layer:getContentSize().height-15*panelScale))
		label:setColor(ccc3(255,102,0))
		label:setScale(panelScale)
		self.layer:addChild(label)
		self.exploitLabel = label
		
		--创建一条消息
		local createOneTip = function(cost,costType,up)
			local tipItemPanel = dbUIPanel:panelWithSize(CCSize(283,60))
			local label = CCLabelTTF:labelWithString(costType.."鼓舞：", CCSizeMake(150,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(15,55))
			label:setColor(ccc3(0,204,255))
			tipItemPanel:addChild(label)
			local label = CCLabelTTF:labelWithString("花费", CCSizeMake(60,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(110 ,55))
			label:setColor(ccc3(255,204,151))
			tipItemPanel:addChild(label)
			local label = CCLabelTTF:labelWithString(costType..cost, CCSizeMake(200,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(150 ,55))
			label:setColor(ccc3(255,102,0))
			tipItemPanel:addChild(label)
			
			local label = CCLabelTTF:labelWithString("有可能战斗力", CCSizeMake(350,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 18)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(15,30))
			label:setColor(ccc3(255,204,151))
			tipItemPanel:addChild(label)
			local label = CCLabelTTF:labelWithString("+"..up.."%", CCSizeMake(100,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 18)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(130,30))
			label:setColor(ccc3(153,255,0))
			tipItemPanel:addChild(label)
			return tipItemPanel
		end
		local cost = GloblePlayerData.officium<10 and 200 or math.floor(GloblePlayerData.officium/10)*400-200
		local tip = createOneTip(cost,"战功",10)
		tip:setAnchorPoint(CCPoint(0,1))
		tip:setPosition(CCPoint(15,330))
		leftTipPanel:addChild(tip)
		local tip = createOneTip(10,"金币",10)
		tip:setAnchorPoint(CCPoint(0,1))
		tip:setPosition(CCPoint(15,270))
		leftTipPanel:addChild(tip)
		
		self.list = dbUIList:list(CCRectMake(0,0,283,200),0)
		leftTipPanel:addChild(self.list)
	end,
	
	--创建倒计时面板
	createCooldownPanel = function(self)
		local panel = createImagePanel("UI/boss/cd_bg.png",283,149)
		panel:setAnchorPoint(CCPoint(1,1))
		panel:setPosition(CCPoint(WINSIZE.width-15*panelScale,WINSIZE.height-26*panelScale))
		panel:setScale(panelScale)
		self.layer:addChild(panel)
		
		local title = CCSprite:spriteWithFile("UI/boss/map_name_bg.png")
		title:setAnchorPoint(CCPoint(0.5,1))
		title:setPosition(CCPoint(283/2,149+20))
		panel:addChild(title)
		local label = CCLabelTTF:labelWithString("BOSS地图",SYSFONT[EQUIPMENT], 20)
		label:setPosition(CCPoint(148/2 ,20))
		title:addChild(label)
		
		local label = CCLabelTTF:labelWithString("挑战剩余时间",CCSize(250,0),0,SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(33,94))
		panel:addChild(label)
		self.countDownTypeLabel = label
		
		local timeLabel = CCLabelTTF:labelWithString("00:00",CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
		timeLabel:setAnchorPoint(CCPoint(0,0))
		timeLabel:setPosition(CCPoint(170 ,94))
		timeLabel:setColor(ccc3(254,153,0))
		panel:addChild(timeLabel)
		self.countDownLabel = timeLabel
		
		local label = CCLabelTTF:labelWithString("参与人数",CCSize(150,0),0,SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(83,62))
		panel:addChild(label)
		local numLabel = CCLabelTTF:labelWithString("1",CCSize(100,0),0,SYSFONT[EQUIPMENT], 22)
		numLabel:setAnchorPoint(CCPoint(0,0))
		numLabel:setPosition(CCPoint(175 ,62))
		numLabel:setColor(ccc3(254,153,0))
		panel:addChild(numLabel)
		self.numLabel = numLabel
		
		local leaveBtn = dbUIButtonScale:buttonWithImage("UI/boss/leave_btn.png",1.2,ccc3(125,125,125))
		leaveBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		leaveBtn:setPosition(CCPoint(283/2, 32))
		leaveBtn.m_nScriptClickedHandler = function(ccp)
			local leave = function()
				self:leave()
			end
			local createBtns = function(ccp)
				local btns = {}
				btns[1] = dbUIButtonScale:buttonWithImage("UI/boss/ok.png",1,ccc3(125, 125, 125))
				btns[1].action = leave
	
				btns[2] = dbUIButtonScale:buttonWithImage("UI/boss/cancel.png",1,ccc3(125, 125, 125))
				btns[2].action = nothing
				return btns
			end
			local dialogCfg = new(basicDialogCfg)
			dialogCfg.bg = "UI/boss/cd_bg.png"
			dialogCfg.msg = "确定离开副本"
			dialogCfg.btns = createBtns()
			new(Dialog):create(dialogCfg)
		end
		panel:addChild(leaveBtn)
	end,
	
	--右边排名
	createRightTip = function(self,json)
		if self.rightTipPanel==nil then
		    self.rightTipPanel = CCSprite:spriteWithFile("UI/boss/gray_bg.png")
	   		self.rightTipPanel:setAnchorPoint(CCPoint(1,1))
			self.rightTipPanel:setPosition(CCPoint(WINSIZE.width-15*panelScale,WINSIZE.height-180*panelScale))
			self.rightTipPanel:setScale(panelScale)
			self.layer:addChild(self.rightTipPanel)
		else
			self.rightTipPanel:removeAllChildrenWithCleanup(true)
		end
		if json==nil then return end
		
		--我自己的排名
		local mine_totalDamage = json:getByKey("mine_totalDamage"):asInt()
		local mine_rank = json:getByKey("mine_rank"):asInt()
		local mine_percent = json:getByKey("mine_percent"):asInt()
		local label = nil
		if mine_totalDamage==0 then
			label = CCLabelTTF:labelWithString("你还没对BOSS造成伤害", CCSizeMake(283,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 18)
		else
			label = CCLabelTTF:labelWithString("我的排名:"..mine_rank.." 伤害"..mine_totalDamage.." ("..mine_percent.."%)", CCSizeMake(400,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 18)
		end
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(15,325))
		label:setColor(ccc3(255,204,153))
		self.rightTipPanel:addChild(label)

		local rankList = json:getByKey("rankDataList")
		if rankList==nil then return end

		--创建一条消息
		local createOneTip = function(index,rank,name,damage,percent)
			local linePanel = dbUIPanel:panelWithSize(CCSize(283,30))
			local label = CCLabelTTF:labelWithString(rank.."."..name, CCSizeMake(300,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 18)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(15,25))
			label:setColor(ccc3(255,204,153))
			linePanel:addChild(label)
			local label = CCLabelTTF:labelWithString("伤害"..damage, CCSizeMake(300,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 18)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(145 ,25))
			label:setColor(ccc3(255,204,153))
			linePanel:addChild(label)
			local label = CCLabelTTF:labelWithString("("..percent.."%)", CCSizeMake(100,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 18)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(245,25))
			label:setColor(ccc3(0,204,255))
			linePanel:addChild(label)

			linePanel:setAnchorPoint(CCPoint(0,1))
			linePanel:setPosition(CCPoint(0,330-30*index))
			self.rightTipPanel:addChild(linePanel)
		end
		
		for i=1, rankList:size() do
			local item = rankList:getByIndex(i-1)

			local name = item:getByKey("name"):asString()
			local totalDamage = item:getByKey("totalDamage"):asInt()
			local totalCopper = item:getByKey("totalCopper"):asInt()
			local rank = item:getByKey("rank"):asInt()
			local percent = item:getByKey("percent"):asInt()
			local roleId = item:getByKey("roleId"):asInt()
			createOneTip(i,rank,name,totalDamage,percent)
		end
	end,
	
	--创建鼓舞士气面板，其实就几个按钮
	createEmbravePanel = function(self)
		local panel = dbUIPanel:panelWithSize(CCSize(477,110))
		panel:setAnchorPoint(CCPoint(0.5,1))
		panel:setPosition(CCPoint(WINSIZE.width/2,WINSIZE.height-80*panelScale))
		panel:setScale(panelScale)
		self.layer:addChild(panel)
		
		local btn = dbUIButtonScale:buttonWithImage("UI/boss/embrave_gold.png",1.2,ccc3(125,125,125))
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setPosition(CCPoint(70,37))
		btn.m_nScriptClickedHandler = function(ccp)
			self:embraveRequest(1)
		end
		panel:addChild(btn)

		local btn = dbUIButtonScale:buttonWithImage("UI/boss/embrave_zg.png",1.2,ccc3(125,125,125))
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setPosition(CCPoint(70+180,37))
		btn.m_nScriptClickedHandler = function(ccp)
			self:embraveRequest(2)
		end
		panel:addChild(btn)
		
		local btn = dbUIButtonScale:buttonWithImage("UI/boss/revive.png",1.2,ccc3(125,125,125))
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setPosition(CCPoint(70+170*2,50))
		btn.m_nScriptClickedHandler = function(ccp)
			self:reviveRequest()
		end
		panel:addChild(btn)
	end,
	
	--复活等待时间
	createRevivePanel = function(self)
		local panel = dbUIPanel:panelWithSize(CCSize(0,0))
		self.layer:addChild(panel)
		
		local label = CCLabelTTF:labelWithString("复活倒计时:",SYSFONT[EQUIPMENT],36)
		label:setPosition(CCPoint(WINSIZE.width/2-100*panelScale,WINSIZE.height/2))
		label:setColor(ccc3(138,255,0))
		panel:addChild(label)
		
		local str = getLenQueTime(math.floor(self.weakCooldown))
		self.cdText = CCLabelTTF:labelWithString(str, CCSizeMake(350,0), CCTextAlignmentCenter,SYSFONT[EQUIPMENT],36)
		self.cdText:setAnchorPoint(CCPoint(0.5, 0.5))
		self.cdText:setPosition(CCPoint(WINSIZE.width/2+100*panelScale,WINSIZE.height/2))
		self.cdText:setColor(ccc3(255,102,0))	
		panel:addChild(self.cdText)
		
		panel:setIsVisible(false)
		self.revivePanel = panel
	end,

	--鼓舞信息插入
	insertEmbraveMsg = function(self,json)
		local level = json:getByKey("level"):asInt()
		local sumAddition = json:getByKey("sumAddition"):asInt()

		if level==0 or sumAddition==0 then return end;
		if self.level and self.level==level then return end
		
		self.level = level
		
		local tipItemPanel = dbUIPanel:panelWithSize(CCSize(283,30))
		local label = CCLabelTTF:labelWithString("当前已鼓舞"..level.."层,战力", CCSizeMake(350,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 18)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(15+15,0))
		label:setColor(ccc3(255,204,151))
		tipItemPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("+"..sumAddition.."%", CCSizeMake(100,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 18)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(205,0))
		label:setColor(ccc3(154,255,3))
		tipItemPanel:addChild(label)

		self.list:insterWidgetAtID(tipItemPanel,0)
		local y = self.list:getContentSize().height-self.list:get_m_content_size().height
		self.list:m_setPosition(CCPoint(0,y))
	end,
	
	--处理事件消息
	msgHandler = function(self,msg)
		local msg = msg:getByKey("eventMsg")
		local type = msg:getByKey("type"):asString()
		if type=="boss_hp_section" then --boss掉了一段血
			local addEmbrave = msg:getByKey("addEmbrave"):asInt()
			local sumEmbrave = msg:getByKey("sumEmbrave"):asInt()
			local section = msg:getByKey("section"):asInt()
			
			local tipLine = dbUIPanel:panelWithSize(CCSize(283,60))
			local label = CCLabelTTF:labelWithString("当前boss元气大伤 "..(section-1).." 次", CCSizeMake(300,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(15,30))
			label:setColor(ccc3(255,204,151))
			tipLine:addChild(label)
			local label = CCLabelTTF:labelWithString("你的战力+"..addEmbrave.."% 总战力+"..sumEmbrave.."%", CCSizeMake(300,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(15,0))
			label:setColor(ccc3(154,255,3))
			tipLine:addChild(label)
	
			self.list:insterWidgetAtID(tipLine,0)
			local y = self.list:getContentSize().height-self.list:get_m_content_size().height
			self.list:m_setPosition(CCPoint(0,y))
		end
	end,

	registBattleCallback = function(self)
		local function opBattleFinishCB(s)
			local error_code = s:getByKey("error_code"):asInt()
			if error_code == -1 then
				StopPlayHpMove = true
			end
		end
		NetMgr:registOpLuaFinishedCB(Net.OPT_BattleSimple, opBattleFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_BattleSimple, opFailedCB)
	end,
	
	--设置boss血量并显示动画
	setBossHP = function(self,cur_health_point,boss_hp_section)
		if cur_health_point < self.cur_sum_boss_hp then --血量有减少
			local firstIn = false
			if self.cur_sum_boss_hp == SUM_BOSS_HP then
				firstIn = true
			end
			
			local lostHP = self.cur_sum_boss_hp - cur_health_point --掉血量
			self.cur_sum_boss_hp = cur_health_point
			self.cur_section_hp = cur_health_point%self.section_hp

			if self.section ~= boss_hp_section then --新的一段血
				self.section = boss_hp_section
				self.bossPanel:removeChild(self.hpBar.barbg,true)
				
				local cfg = new(BOSS_HP_BAR_CFG[self.section])
				cfg.addtions =(4-(self.section-1)).."×4"
				
				self.hpBar = new(Bar)
				self.hpBar:create(self.section_hp,cfg)
				self.hpBar:setExtent(self.cur_section_hp)
				self.bossPanel:addChild(self.hpBar.barbg)
			else
				self.hpBar:setExtent(self.cur_section_hp)
			end
			
			if not firstIn then
				if StopPlayHpMove then
					return	
				end

				if self.hpMoveHandler then
					CCScheduler:sharedScheduler():unscheduleScriptEntry(self.hpMoveHandler)
					self.hpMoveHandler = nil
					if self.moveHpLabel then
						self.layer:removeChild(self.moveHpLabel,true)
						self.moveHpLabel = nil
					end
				end
				
				local label = new(NumberLabel)
				label:create(-lostHP,{imageDir="UI/numbers/red_34_38/"})
				label.bg:setAnchorPoint(CCPoint(0.5,0.5))
				label.bg:setPosition(CCPoint(WINSIZE.width/2,WINSIZE.height/2))
				self.moveHpLabel = label.bg
				self.layer:addChild(label.bg)

				local update = function()
					local x,y = label.bg:getPosition()
					y = y + 2
					label.bg:setPosition(CCPoint(x,y))
					if y > WINSIZE.height*0.8 and self.hpMoveHandler then
						CCScheduler:sharedScheduler():unscheduleScriptEntry(self.hpMoveHandler)
						self.hpMoveHandler = nil
						self.layer:removeChild(label.bg,true)
					end
				end
				self.hpMoveHandler = CCScheduler:sharedScheduler():scheduleScriptFunc(update,0,false)		
			end
		end
	end,
	
	heartRequestRegist = function(self)
		local opSuccessCB = function (json)
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				if bossWarPanel==nil then return end
				local boss_hp = json:getByKey("boss_hp"):asInt()
				local boss_hp_section = json:getByKey("boss_hp_section"):asInt()
				
				local server_time = json:getByKey("server_time"):asDouble()
				local weak_time = json:getByKey("weak_time"):asDouble()
				
				self.startCountDown = json:getByKey("startCountDown"):asInt() --战斗开始倒计时
				self.endCountDown = json:getByKey("endCountDown"):asInt()     --战斗结束倒计时
				self.roleNum = json:getByKey("roleNum"):asInt() 			  --玩家人数
				self.weakCooldown = weak_time==0 and 0 or (weak_time - server_time )/1000

				self:setBossHP(boss_hp,boss_hp_section)
				self:insertEmbraveMsg(json)
				self:msgHandler(json)

				local isEnd = json:getByKey("isEnd"):asBool()
				if isEnd then
					self.weakCooldown = 0
					self.endCountDown = 0
					self:endWar(json)
				end
				
				self:createRightTip(json)
			end
		end
		
		local action = Net.OPT_MausoleumCheck
		NetMgr:registOpLuaFinishedCB(action,opSuccessCB)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)
	end,

	--心跳包请求
	heartRequest = function(self)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(Net.OPT_MausoleumCheck, cj)
	end,
		
	--结束BOSS战 
	endWar = function(self,json)
		local hud = dbHUDLayer:shareHUD2Lua()
		if hud==nil then --还没有返回主界面
			return	
		end
		
		local btn = hud:getChildByTag(415) --进入按钮
		local label = btn:getChildByTag(100)
		if label then
			label:setString("")
		end
		
		local reward_copper = json:getByKey("reward_copper"):asInt()
		local reward_exploit = json:getByKey("reward_exploit"):asInt()
		local reward_item_list = json:getByKey("reward_item_list")
		
		local killer_reward = json:getByKey("killer_reward"):asInt()
		
		local mine_totalCopper = json:getByKey("mine_totalCopper"):asInt()
		local mine_rank = json:getByKey("mine_rank"):asInt()
		
		for i=1,reward_item_list:size() do
			local reward_item = reward_item_list:getByIndex(i-1)
			local item = {reward_item:getByKey("item_cfg_id"):asInt(),reward_item:getByKey("item_id"):asInt()}
			battleGetItems(item,true)
		end
		
		local scene = DIRECTOR:getRunningScene()
		
		local bgLayer = createPanelBg()
		local uiLayer,centerWidget = createCenterWidget()

		scene:addChild(bgLayer, 1000-1)
		scene:addChild(uiLayer, 2000-1)
		
		local labels = new({})
		
		local label = CCLabelTTF:labelWithString("你在本次击杀BOSS的活动中，排名第 "..mine_rank,SYSFONT[EQUIPMENT], 26)
		table.insert(labels,label)
		
		if killer_reward>0 then	
			local label = CCLabelTTF:labelWithString("获得最后一击奖励："..killer_reward.." 银币",SYSFONT[EQUIPMENT], 26)
			table.insert(labels,label)
		end

		if reward_copper > 0 then
			local label = CCLabelTTF:labelWithString("获得排名奖励："..reward_copper.."银币",SYSFONT[EQUIPMENT], 26)
			table.insert(labels,label)
		end

		if reward_exploit > 0 then
			local label = CCLabelTTF:labelWithString("获得："..reward_exploit.."战功奖励",SYSFONT[EQUIPMENT], 26)
			table.insert(labels,label)
		end		
		
		for i=1,reward_item_list:size() do
			local reward_item = reward_item_list:getByIndex(i-1)
			local item_info = findShowItemInfo(reward_item:getByKey("item_cfg_id"):asInt())
			local label = CCLabelTTF:labelWithString("获得奖励："..item_info.name.."*"..reward_item:getByKey("item_amount"):asInt(),SYSFONT[EQUIPMENT], 26)
			table.insert(labels,label)
		end

		local label = CCLabelTTF:labelWithString("累计获得银币奖励："..mine_totalCopper,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0.5,1))
		table.insert(labels,label)
		
		local dialogHeight = 60 + #labels * 40;
		local panel = createBG("UI/boss/cd_bg.png",480,dialogHeight)
		panel:setAnchorPoint(CCPoint(0.5,0.5))
		panel:setPosition(CCPoint(1010/2,702/2))
		centerWidget:addChild(panel)
		
		for i=1,#labels do
			local item = labels[i]
			item:setAnchorPoint(CCPoint(0.5,1))
			item:setPosition(CCPoint(480/2,dialogHeight-20-(i-1)*40))
			panel:addChild(item)
		end
		
		local leaveBtn = dbUIButtonScale:buttonWithImage("UI/boss/ok.png",1.2,ccc3(125,125,125))
		leaveBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		leaveBtn:setPosition(CCPoint(480/2, 32))
		leaveBtn.m_nScriptClickedHandler = function(ccp)
			local scene = DIRECTOR:getRunningScene()
			scene:removeChild(uiLayer)
			scene:removeChild(bgLayer)
			self:leave()
		end
		panel:addChild(leaveBtn)
		
		if self.secondHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.secondHandle)
			self.secondHandle = nil
		end		
	end,
	
	--鼓舞士气
	embraveRequest = function(self,type)
		local createMsg = function(json)
			local level = json:getByKey("level"):asInt()
			local sumAddition = json:getByKey("sumAddition"):asInt()
			
			local tipItemPanel = dbUIPanel:panelWithSize(CCSize(283,30))
			local label = CCLabelTTF:labelWithString("当前已鼓舞"..level.."层,战力", CCSizeMake(350,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(15,0))
			label:setColor(ccc3(255,204,151))
			tipItemPanel:addChild(label)
			local label = CCLabelTTF:labelWithString("+"..sumAddition.."%", CCSizeMake(100,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(220,0))
			label:setColor(ccc3(154,255,3))
			tipItemPanel:addChild(label)
			return tipItemPanel		
		end
		
		local opSuccessCB = function (json)
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				if bossWarPanel==nil then return end
			
				local success = json:getByKey("success"):asBool()
				
				GloblePlayerData.gold = json:getByKey("gold"):asInt()
				GloblePlayerData.exploit = json:getByKey("exploit"):asInt()
				
				--updataHUDData()		--不更新HUD数据，离开时更新

				self.goldLabel:setString(GloblePlayerData.gold)
				self.exploitLabel:setString(GloblePlayerData.exploit)
								
				if success then
					alert("鼓舞成功")
					self:insertEmbraveMsg(json)
				else
					alert("鼓舞失败")
				end
			end
		end

		local request = function()
			local action = Net.OPT_MausoleumEmbrave
			NetMgr:registOpLuaFinishedCB(action,opSuccessCB)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("type",type) --1: 金币鼓舞 2  战功鼓舞
			NetMgr:executeOperate(action, cj)
		end
		
		local createBtns = function(ccp)
			local btns = {}
			btns[1] = dbUIButtonScale:buttonWithImage("UI/boss/ok.png",1,ccc3(125, 125, 125))
			btns[1].action = request

			btns[2] = dbUIButtonScale:buttonWithImage("UI/boss/cancel.png",1,ccc3(125, 125, 125))
			btns[2].action = nothing
			return btns
		end

		local cost = GloblePlayerData.officium<11 and 20 or math.floor((GloblePlayerData.officium - 1) / 10)*20
		
		local dialogCfg = new(basicDialogCfg)
		dialogCfg.bg = "UI/boss/cd_bg.png"
		dialogCfg.msg = type==1 and "确定花费10金币鼓舞？" or "确定花费"..cost.."战功鼓舞？"
		dialogCfg.btns = createBtns()
		new(Dialog):create(dialogCfg)
	end,
	
	--快速复活
	reviveRequest = function(self,type)
		local opSuccessCB = function (json)
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				if bossWarPanel==nil then return end
				
				GloblePlayerData.gold = json:getByKey("gold"):asInt()
				self.goldLabel:setString(GloblePlayerData.gold)
				--updataHUDData()		--不更新HUD数据，离开时更新
				self.weakCooldown = 0
				alert("成功复活!")
			end
		end

		local request = function()
			local action = Net.OPT_MausoleumRevive
			NetMgr:registOpLuaFinishedCB(action,opSuccessCB)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(action, cj)		
		end

		local createBtns = function(ccp)
			local btns = {}
			btns[1] = dbUIButtonScale:buttonWithImage("UI/boss/ok.png",1,ccc3(125, 125, 125))
			btns[1].action = request

			btns[2] = dbUIButtonScale:buttonWithImage("UI/boss/cancel.png",1,ccc3(125, 125, 125))
			btns[2].action = nothing
			return btns
		end
		local dialogCfg = new(basicDialogCfg)
		dialogCfg.bg = "UI/boss/cd_bg.png"
		dialogCfg.msg = "确定花费20金币复活？"
		dialogCfg.btns = createBtns()
		new(Dialog):create(dialogCfg)
	end,
	
	--离开副本
	leave = function(self)
		local action = Net.OPT_MausoleumLeave
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(action, cj)
		self:destroy()
	end,

	initSecondHandle = function(self)
		local timesTamp = 0
		local tipShowTime = 0
		local tipShow = true
		
		self:heartRequestRegist()
		
		local secondHandleFunction = function()
			--复活倒计时
			self.weakCooldown = self.weakCooldown -1
			if  self.weakCooldown > 0 then
				self.revivePanel:setIsVisible(true)
				self.cdText:setString(getLenQueTime(math.floor(self.weakCooldown)))
			else
				self.revivePanel:setIsVisible(false)
			end
			
			--心跳包
			timesTamp = timesTamp + 1
			if  timesTamp == 3 then
				self:heartRequest()
				timesTamp = 1
			end
			
			--更新玩家人数
			self.numLabel:setString(self.roleNum)
			
			if self.startCountDown > 0 then --等待战斗开始
				self.startCountDown = self.startCountDown - 1
				self.countDownTypeLabel:setString("等待战斗开始")
				self.countDownLabel:setString(getLenQueTime(self.startCountDown))
			else
				tipShowTime = tipShowTime + 1
				local tip = self.layer:getChildByTag(1)
				if tip == nil and tipShow==true then
					local tip = CCSprite:spriteWithFile("UI/boss/tip_bg.png")
					tip:setPosition(WINSIZE.width/2,WINSIZE.height/2)
					tip:setScale(panelScale)
					self.layer:addChild(tip,0,1)
					
					local label = CCLabelTTF:labelWithString("世界BOSS "..BOSS_NAME.." 挑战开始",SYSFONT[EQUIPMENT], 32)
					label:setPosition(CCPoint(tip:getContentSize().width/2,tip:getContentSize().height/2))
					tip:addChild(label)
				elseif tipShowTime>=3 then
					tipShow = false
					self.layer:removeChild(tip,true)
				end
			end

			if self.startCountDown <= 0 and self.endCountDown > 0 then --战斗结束倒计时
				self.endCountDown = self.endCountDown - 1
				self.countDownTypeLabel:setString("挑战剩余时间")
				self.countDownLabel:setString(getLenQueTime(self.endCountDown))
			end
		end
		
		self:heartRequest()
		self.secondHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(secondHandleFunction,1, false)
	end,
	
	destroy = function(self)
		if self.secondHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.secondHandle)
			self.secondHandle = nil
		end
		
		if self.hpMoveHandler then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.hpMoveHandler)
			self.hpMoveHandler = nil
		end

		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.layer)
		
		removeUnusedTextures()
	end
}

--发起boss战的请求
function globleExecuteBossWar()
	local action = Net.OPT_MausoleumEnter
	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	NetMgr:executeOperate(action, cj)
end

function backBossWar()
	StopPlayHpMove = false
end

--进入boss战地图后的回调
function globlEnterBossWar(bossWarData)
	SUM_BOSS_HP = bossWarData:getByKey("sumBossHP"):asInt()
	BOSS_LEVEL = bossWarData:getByKey("bossLevel"):asInt()
	BOSS_NAME = bossWarData:getByKey("bossName"):asString()
	BOSS_FACE = bossWarData:getByKey("bossFace"):asInt()
	
	BOSS_INIT_SECTION = bossWarData:getByKey("curHPSection"):asInt()
	if BOSS_INIT_SECTION<1 then
		BOSS_INIT_SECTION = 1
	end
	if BOSS_INIT_SECTION>4 then
		BOSS_INIT_SECTION = 4
	end

	bossWarPanel = new(Panel)
	bossWarPanel:create()
	
	local HUD = dbHUDLayer:shareHUD2Lua()
	if HUD ~= nil then
		HUD:setIsVisibleRightUp(false)
	end
	
	IN_BOSS_WAR_SCENE = true
end

--离开地图的时候调用
function globlLeaveBossWar()
	IN_BOSS_WAR_SCENE = false
	local HUD = dbHUDLayer:shareHUD2Lua()
	if HUD ~= nil then
		updataHUDData()
		HUD:setIsVisibleRightUp(true)
	end
	if bossWarPanel then
		bossWarPanel:destroy()
		bossWarPanel = nil
	end
end

--获得奖励提醒
function MausoleumReward (yin)
	local dialogCfg = new(basicDialogCfg)
	dialogCfg.msgAlign = "center"
	dialogCfg.dialogType = 5
	dialogCfg.title="战斗获得"
	dialogCfg.msg = "银币："..yin
	new(Dialog):create(dialogCfg)
end

local clearHUDCountdownTimeHandle = function()
	if HUDCountdownTimeHandle then
		CCScheduler:sharedScheduler():unscheduleScriptEntry(HUDCountdownTimeHandle)
		HUDCountdownTimeHandle = nil
	end
end

--主界面上进入BOSS战的icon
function MausoleumHUD(cdTime)
	local hud = dbHUDLayer:shareHUD2Lua()
	if hud==nil then return end
	
	local setLabelValue = function(text)
		local btn = hud:getChildByTag(415) --Boss战入口按钮

		if WaitForOpenLabelBg==nil and text~="" then
			CCSpriteFrameCache:sharedSpriteFrameCache():addSpriteFramesWithFile("UI/HUD/HUD.plist")
			WaitForOpenLabelBg = CCSprite:spriteWithSpriteFrameName("UI/HUD/top/boss_war_time_load.png")
			WaitForOpenLabelBg:setPosition(CCPoint(btn:getContentSize().width/2,btn:getContentSize().height/2))
			btn:addChild(WaitForOpenLabelBg)
		end
			
		if WaitForOpenlabel == nil then
			WaitForOpenlabel = CCLabelTTF:labelWithString(text,"", 22)
			WaitForOpenlabel:setPosition(CCPoint(btn:getContentSize().width/2,btn:getContentSize().height/2))
			btn:addChild(WaitForOpenlabel)
		else
			WaitForOpenlabel:setString(text)
		end
	end
	
	local update = function()
		if cdTime > 0 then
			cdTime = cdTime - 1
		end
		local text = ""
		if cdTime==0 then
			clearHUDCountdownTimeHandle()
			text = "已开启"
		else
			text = getLenQueTime(cdTime)
		end		
		setLabelValue(text)
	end

	if cdTime > 0 then
		if HUDCountdownTimeHandle == nil then
			HUDCountdownTimeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(update,1,false)
		end
	elseif cdTime == 0 then
		setLabelValue("已开启")
	else --结束了
		clearHUDCountdownTimeHandle()
		if WaitForOpenLabelBg then
			WaitForOpenLabelBg:removeFromParentAndCleanup(true)
			WaitForOpenLabelBg = nil
		end
		if WaitForOpenlabel then
			WaitForOpenlabel:removeFromParentAndCleanup(true)
			WaitForOpenlabel = nil
		end		
	end
end

---注销退出的时候情况Boss战的一些状态
function GlobleClearBossWarStatus()
	clearHUDCountdownTimeHandle()
	WaitForOpenlabel = nil
	WaitForOpenLabelBg = nil
end

BOSS_HP_BAR_CFG = {
	{
		bg = "UI/bar/boss_hp_bar.png",
		secondBg = "UI/bar/bar_blue_thin.png",
		bar = "UI/bar/bar_green_thin.png",
		fontSize = 20,
		position = CCPoint(68,5),
		entityPos = CCPoint(7,0),
		cornerWidth = 8,
		testShowFull = true
	},
	{
		bg = "UI/bar/boss_hp_bar.png",
		secondBg = "UI/bar/bar_purple_thin.png",
		bar = "UI/bar/bar_blue_thin.png",
		fontSize = 20,
		position = CCPoint(68,5),
		entityPos = CCPoint(7,0),
		cornerWidth = 8,
		testShowFull = true
	},
	{
		bg = "UI/bar/boss_hp_bar.png",
		secondBg = "UI/bar/bar_red_thin.png",
		bar = "UI/bar/bar_purple_thin.png",
		fontSize = 20,
		position = CCPoint(68,5),
		entityPos = CCPoint(7,0),
		textColor = ccc3(255,255,255),
		cornerWidth = 8,
		testShowFull = true
	},
	{
		bg = "UI/bar/boss_hp_bar.png",
		bar = "UI/bar/bar_red_thin.png",
		fontSize = 20,
		position = CCPoint(68,5),
		entityPos = CCPoint(7,0),
		cornerWidth = 8,
		testShowFull = true
	},	
}
---攻城战主面板
local Instance = nil --攻城战界面实例对象
local designSize = CCSize(1280,720)
local panelScale = caltScale(designSize)

local HUDCountdownTimeHandle = nil
local WaitForOpenlabel = nil
local WaitForOpenLabelBg = nil

local CITY_HP_BAR_CFG = {
	bg = "UI/bar/league_bar_bg.png",
	bar = "UI/bar/league_bar_green.png",
	fontSize = 20,
	position = CCPoint(0,140),
	entityPos = CCPoint(2,0),
	cornerWidth = 2,
	testShowFull = true
}

--箭头配置，从左到右，一对一对
local ARROW_CFG = {
	{
		posAbove = CCPoint(210,320),
		posBelow = CCPoint(200,230),
		rotationAbove = -20,
		rotationBelow = 20,
	},
	{
		posAbove = CCPoint(210+150,300+80),
		posBelow = CCPoint(200+140,300-140),
		rotationAbove = -20,
		rotationBelow = 20,
	},
	{
		posAbove = CCPoint(510,430),
		posBelow = CCPoint(490,110),
		rotationAbove = 10,
		rotationBelow = 10,
	},
	{
		posAbove = CCPoint(680,420),
		posBelow = CCPoint(690,95),
		rotationAbove = 10,
		rotationBelow = -10,
	},
	{
		posAbove = CCPoint(840,410),
		posBelow = CCPoint(850,123),
		rotationAbove = 20,
		rotationBelow = -30,
	},
	{
		posAbove = CCPoint(990,360),
		posBelow = CCPoint(990,190),
		rotationAbove = 30,
		rotationBelow = -30,
	},
}

--城市配置，从神宫开始顺时针
local CITY_CFG = {
	--神宫
	{
		pos = CCPoint(150,290),
		image = "UI/zhenying/shen_tu.png"
	},
	--上半部分,从左到右
	{
		pos = CCPoint(150+160+10,290+100),
		image = "UI/zhenying/city_green.png"
	},
	{
		pos = CCPoint(150+160*2,290+80*2-20),
		image = "UI/zhenying/city_green.png"
	},
	{
		pos = CCPoint(150+160*3+10,290+80*2-10),
		image = "UI/zhenying/city_center.png"
	},
	{
		pos = CCPoint(150+160*4+10,290+80*2-20),
		image = "UI/zhenying/city_red.png"
	},
	{
		pos = CCPoint(150+160*5,290+100),
		image = "UI/zhenying/city_red.png"
	},
	--魔宫
	{
		pos = CCPoint(150+160*6,290),
		image = "UI/zhenying/mo_tu.png"
	},
	--下半部分,从左到右
	{
		pos = CCPoint(150+160*5,290-70),
		image = "UI/zhenying/city_red.png"
	},
	{
		pos = CCPoint(150+160*4+20,290-70*2+10),
		image = "UI/zhenying/city_red.png"
	},
	{
		pos = CCPoint(150+160*3,290-70*2+10),
		image = "UI/zhenying/city_center.png"
	},
	{
		pos = CCPoint(150+160*2-20,290-70*2+10),
		image = "UI/zhenying/city_green.png"
	},
	{
		pos = CCPoint(150+160*1,290-70),
		image = "UI/zhenying/city_green.png"
	},
}

---移动到下一座城
local moveRequest = function(idx)
	local opSuccessCB = function (json)
		closeWait()
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
		else
			if Instance==nil then return end
			Instance:initData(json)
			Instance:updateUI()
		end
	end

	local request = function()
		showWaitDialogNoCircle("")
		local action = Net.OPT_LeagueMove
		NetMgr:registOpLuaFinishedCB(action,opSuccessCB)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("target_city_idx",idx)
		NetMgr:executeOperate(action, cj)
	end
	request()
end

---鼓舞士气
local encourageRequest = function(type)

	local opSuccessCB = function (json)
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			if Instance==nil then return end
			Instance:initData(json)
			Instance:updateUI()
		end
	end

	local request = function()
		local action = Net.OPT_LeagueEncourage
		NetMgr:registOpLuaFinishedCB(action,opSuccessCB)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("type",type) --1: 战功鼓舞  2 金币鼓舞  3 团队鼓舞
		NetMgr:executeOperate(action, cj)
	end

	local createBtns = function(ccp)
		local btns = {}
		btns[1] = dbUIButtonScale:buttonWithImage("UI/boss/ok.png",1,ccc3(125, 125, 125))
		btns[1].action = request

		btns[2] = dbUIButtonScale:buttonWithImage("UI/boss/cancel.png",1,ccc3(125, 125, 125))
		btns[2].action = nothing
		return btns
	end

	local dialogCfg = new(basicDialogCfg)
	dialogCfg.dialogType = 5
	dialogCfg.bg = "UI/boss/cd_bg.png"
	if type==1 then
		local cost = GloblePlayerData.officium<11 and 20 or math.floor((GloblePlayerData.officium - 1) / 10)*20
		dialogCfg.msg = "确定花费"..cost.."战功鼓舞？"
	elseif type==2 then
		dialogCfg.msg = "确定花费10金币鼓舞？"
	else
		dialogCfg.msg = "确定花费100金币进行团队鼓舞？"
	end
	dialogCfg.btns = createBtns()
	new(Dialog):create(dialogCfg)		
end

---加血
local addHPRequest = function()
	local opSuccessCB = function (json)
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			alert("血已加满")
		end
	end

	local request = function()
		local action = Net.OPT_LeagueAddHp
		NetMgr:registOpLuaFinishedCB(action,opSuccessCB)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(action, cj)
	end

	local createBtns = function(ccp)
		local btns = {}
		btns[1] = dbUIButtonScale:buttonWithImage("UI/boss/ok.png",1,ccc3(125, 125, 125))
		btns[1].action = request

		btns[2] = dbUIButtonScale:buttonWithImage("UI/boss/cancel.png",1,ccc3(125, 125, 125))
		btns[2].action = nothing
		return btns
	end

	local dialogCfg = new(basicDialogCfg)
	dialogCfg.dialogType = 5
	dialogCfg.bg = "UI/boss/cd_bg.png"
	dialogCfg.msg = "确定花费"..(10+Instance.add_hp_times*5).."金币加血吗？"
	dialogCfg.btns = createBtns()
	new(Dialog):create(dialogCfg)
end

---奋勇
local braveRequest = function()
	local opSuccessCB = function (json)
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			alertOK("卑微者的怒吼，在接下来的2次战斗中增加自身攻击和防御各30%",{
				btnImg = "UI/boss/ok.png",
				fontSize = 24,
			})
		end
	end

	local request = function()
		local action = Net.OPT_LeagueBrave
		NetMgr:registOpLuaFinishedCB(action,opSuccessCB)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(action, cj)
	end
	request()
end

---清除冷却时间
local clearCDRequest = function(type)
	local opSuccessCB = function (json)
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			if Instance==nil then return end
			Instance:initData(json)
			Instance:updateUI()
		end
	end

	local request = function()
		local action = Net.OPT_LeagueCoolDown
		NetMgr:registOpLuaFinishedCB(action,opSuccessCB)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("type",type) --1: 加速 2  战斗冷却 3复活冷却
		NetMgr:executeOperate(action, cj)
	end

	if type==1 then
		request()
		return
	end

	local createBtns = function(ccp)
		local btns = {}
		btns[1] = dbUIButtonScale:buttonWithImage("UI/boss/ok.png",1,ccc3(125, 125, 125))
		btns[1].action = request

		btns[2] = dbUIButtonScale:buttonWithImage("UI/boss/cancel.png",1,ccc3(125, 125, 125))
		btns[2].action = nothing
		return btns
	end
		
	local cost = 0
	if type==2 then
		if Instance.fight_cd==0 then
			return
		end
		cost = math.ceil(Instance.fight_cd/3)
	elseif type==3 then
		if Instance.revival_cd==0 then
			return
		end
		cost = math.ceil(Instance.revival_cd/6)
	end
	
	local dialogCfg = new(basicDialogCfg)
	dialogCfg.dialogType = 5
	dialogCfg.bg = "UI/boss/cd_bg.png"
	dialogCfg.msg = "确定花费"..cost.."金币清除冷却吗？"
	dialogCfg.btns = createBtns()
	new(Dialog):create(dialogCfg)
end

local msg_count = 0
local insertMsg = function(msg)
	if msg==nil or msg == "" or Instance==nil then
		return
	end
	
	local color = msg_count%2==0 and ccc3(255,203,156) or ccc3(254,102,1)
	local label = CCLabelTTF:labelWithString(msg, CCSizeMake(245,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
	label:setAnchorPoint(CCPoint(0,0))
	label:setPosition(CCPoint(0,0))
	label:setColor(color)

	local item = dbUIPanel:panelWithSize(CCSize(245,label:getContentSize().height))
	item:addChild(label)

	Instance.msgList:insterWidgetAtID(item,0)
	local y = Instance.msgList:getContentSize().height-Instance.msgList:get_m_content_size().height
	Instance.msgList:m_setPosition(CCPoint(0,y))
	msg_count = msg_count + 1
end
---弹出消息提示
local alertMsg = function(msg)
	if msg~=nil and msg ~= "" then
		alertOK(msg,{
			btnImg = "UI/boss/ok.png",
			fontSize = 24,
		})
	end
end
---离开
local leaveRequest = function()
	local action = Net.OPT_LeagueLeave
	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	NetMgr:executeOperate(action, cj)
end

---结束攻城战
local endLeague = function()
	if Instance==nil then return end
	
	local scene = DIRECTOR:getRunningScene()
	local uiLayer,centerWidget = createCenterWidget()
	scene:addChild(uiLayer, 2000)

	local dialogHeight = 280;
	
	local panel = createBG("UI/boss/cd_bg.png",440,dialogHeight)
	panel:setAnchorPoint(CCPoint(0.5,0.5))
	panel:setPosition(CCPoint(1010/2,702/2))
	centerWidget:addChild(panel)
	
	local createLabel = function(text,pos)
		local label = CCLabelTTF:labelWithString(text,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0.5,1))
		label:setPosition(pos)
		panel:addChild(label)
	end
	
	local win_lose = Instance.win_side==Instance.side and "我方胜利" or "我方失利"
	createLabel("在本次攻城战中"..win_lose,CCPoint(440/2,dialogHeight-20))
	createLabel("我的排名: "..Instance.rank,CCPoint(440/2,dialogHeight-20-35*1))
	createLabel("获得银币奖励："..Instance.reward_copper,CCPoint(440/2,dialogHeight-20-35*2))
	createLabel("获得战功奖励："..Instance.reward_exploit,CCPoint(440/2,dialogHeight-20-35*3))
	createLabel("获得朗姆酒奖励："..Instance.reward_apWand,CCPoint(440/2,dialogHeight-20-35*4))
	createLabel("获得经验丹奖励："..Instance.reward_jump,CCPoint(440/2,dialogHeight-20-35*5))
	
	local leaveBtn = dbUIButtonScale:buttonWithImage("UI/boss/ok.png",1.2,ccc3(125,125,125))
	leaveBtn:setAnchorPoint(CCPoint(0.5, 0.5))
	leaveBtn:setPosition(CCPoint(440/2, 32))
	leaveBtn.m_nScriptClickedHandler = function(ccp)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(uiLayer)
		Instance:destroy()
	end
	panel:addChild(leaveBtn)
	
	if Instance.secondHandle then
		CCScheduler:sharedScheduler():unscheduleScriptEntry(Instance.secondHandle)
		Instance.secondHandle = nil
	end	
end

--攻城战界面定义
local LeaguePanel = {
	create = function(self,json)
		self:initData(json)
		self:initBase()
		
		self:createTop()        
		self:createLeft()                        --左下角面板
		self:createRight()                       --右下角面板
		self:createBottom()                      --底部面板
		self:createCityPanel()                   --中间主要工作面板
		
		insertMsg(self.msg)
		alertMsg(self.alert_msg)
	end,
	
	--更新界面
	updateUI = function(self)
		self.topPanel:removeFromParentAndCleanup(true)
		self:createTop()

		self.leftPanel:removeFromParentAndCleanup(true)
		self:createLeft()
		
		self.bottomPanel:removeFromParentAndCleanup(true)
		self:createBottom()
		
		self.mainPanel:removeFromParentAndCleanup(true)
		self:createCityPanel()

		insertMsg(self.msg)
		alertMsg(self.alert_msg)
		
		if self.is_end then
			endLeague()
		end		
	end,
	
	--更新界面上所有的冷却时间
	updateCooldown = function(self)
		--顶部倒计时
		if self.start_cd>0 then
			self.start_cd = self.start_cd-1
			self.topCountdownTipLabel:setString("攻城战开始还有：")
			self.topCountdownTimeLabel:setString(getLenQueTime(self.start_cd))
		elseif self.end_cd>0 then
			self.end_cd = self.end_cd-1
			self.topCountdownTipLabel:setString("攻城战结束还有：")
			self.topCountdownTimeLabel:setString(getLenQueTime(self.end_cd))
		elseif self.end_cd==0 then
			self.topCountdownTipLabel:setString("攻城战已结束")
			self.topCountdownTimeLabel:setString("")
		end
		
		--更新冷却时间
		local reDrawLeftPanel = function()
			self.leftPanel:removeFromParentAndCleanup(true)
			self:createLeft()
		end
		if self.action_cd>0 then 
			self.action_cd = self.action_cd - 1
			if self.action_cd==0 then
				reDrawLeftPanel()
			else
				self.action_cd_label:setString(getLenQueTime(self.action_cd))
			end
		end
		if self.fight_cd>0 then 
			self.fight_cd = self.fight_cd - 1
			if self.fight_cd==0 then
				reDrawLeftPanel()
			else
				self.fight_cd_label:setString(getLenQueTime(self.fight_cd))
			end	
		end
		if self.revival_cd>0 then 
			self.revival_cd = self.revival_cd - 1 
			if self.revival_cd==0 then
				reDrawLeftPanel()
			else
				self.revival_cd_label:setString(getLenQueTime(self.revival_cd))
			end	
		end
		
	end,

	createTop = function(self)
		local topPanel = dbUIPanel:panelWithSize(CCSize(1006,144+60))
		topPanel:setAnchorPoint(CCPoint(0.5,1))
		topPanel:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height))
		topPanel:setScale(panelScale)
		self.centerWidget:addChild(topPanel)
		self.topPanel = topPanel
		
		local bg = createBG("UI/zhenying/top_bg.png",1006,144,CCSize(80,70))
		bg:setAnchorPoint(CCPoint(0.5,1))
		bg:setPosition(CCPoint(1006/2,topPanel:getContentSize().height))
		topPanel:addChild(bg)
		
		local vs = CCSprite:spriteWithFile("UI/zhenying/moVSshen.png")
		vs:setAnchorPoint(CCPoint(0.5,1))
		vs:setPosition(topPanel:getContentSize().width/ 2,topPanel:getContentSize().height-5*panelScale)
		topPanel:addChild(vs)
		
		local text = "攻城战已结束"
		local cd_time = ""
		if self.start_cd>0 then
			text = "攻城战开始还有："
			cd_time = getLenQueTime(self.start_cd)
		elseif self.end_cd>0 then
			text = "攻城战结束还有："
			cd_time = getLenQueTime(self.end_cd)
		end
		
		local label = CCLabelTTF:labelWithString(text, CCSizeMake(400,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(340,40+60))
		label:setColor(ccc3(173,255,47))
		topPanel:addChild(label)
		self.topCountdownTipLabel = label
		
		local label = CCLabelTTF:labelWithString(cd_time, CCSizeMake(200,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(570,40+60))
		label:setColor(ccc3(250,140,0))
		topPanel:addChild(label)
		self.topCountdownTimeLabel = label
		
		local label = CCLabelTTF:labelWithString("防御+"..self.defence_encourage.."%", CCSizeMake(200,0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(330,7+60))
		label:setColor(ccc3(173,255,47))
		topPanel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("攻击+"..self.attack_encourage.."%", CCSizeMake(200,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(575,7+60))
		label:setColor(ccc3(173,255,47))
		topPanel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("得分："..self.god_score, CCSizeMake(400,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(25,150))
		label:setColor(ccc3(173,255,47))
		topPanel:addChild(label)
		if self.god_double_kill>0 then 
			local label = CCLabelTTF:labelWithString("最大连杀玩家：", CCSizeMake(300,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(40,110))
			label:setColor(ccc3(206,0,255))
			topPanel:addChild(label)
			local label = CCLabelTTF:labelWithString(self.god_double_kill_palyer.." "..self.god_double_kill.." 连杀", CCSizeMake(400,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(40,85))
			label:setColor(ccc3(0,204,255))
			topPanel:addChild(label)		
		end
		
		local label = CCLabelTTF:labelWithString("得分："..self.devil_score, CCSizeMake(400,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(800,150))
		label:setColor(ccc3(173,255,47))
		topPanel:addChild(label)
		if self.devil_double_kill>0 then
			local label = CCLabelTTF:labelWithString("最大连杀玩家：", CCSizeMake(300,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(820,110))
			label:setColor(ccc3(206,0,255))
			topPanel:addChild(label)
			local label = CCLabelTTF:labelWithString(self.devil_double_kill_palyer.." "..self.devil_double_kill.." 连杀", CCSizeMake(400,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(820,85))
			label:setColor(ccc3(0,204,255))
			topPanel:addChild(label)	
		end
		
		--创建战功、金币、团队鼓舞按钮
		local panel = dbUIPanel:panelWithSize(CCSize(443,49))
		panel:setAnchorPoint(CCPoint(0.5,0))
		panel:setPosition(CCPoint(self.topPanel:getContentSize().width / 2, 5))
		self.topPanel:addChild(panel,1)
		
		local btn = dbUIButtonScale:buttonWithImage("UI/zhenying/zhan_gong.png",1.2,ccc3(125,125,125))
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setPosition(CCPoint(135/2,49/2))
		btn.m_nScriptClickedHandler = function(ccp)
			encourageRequest(1)
		end
		panel:addChild(btn,1)

		local btn = dbUIButtonScale:buttonWithImage("UI/zhenying/jin_bi.png",1.2,ccc3(125,125,125))
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setPosition(CCPoint(135/2+155,49/2))
		btn.m_nScriptClickedHandler = function(ccp)
			encourageRequest(2)
		end
		panel:addChild(btn)
		
		local btn = dbUIButtonScale:buttonWithImage("UI/zhenying/tuan_dui.png",1.2,ccc3(125,125,125))
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setPosition(CCPoint(135/2+155*2,49/2))
		btn.m_nScriptClickedHandler = function(ccp)
			encourageRequest(3)
		end
		panel:addChild(btn)
	end,

	--左下角行动、复活、冷却时间提示
	createLeft = function(self)
		local leftPanel = dbUIPanel:panelWithSize(CCSize(300,180))
		leftPanel:setAnchorPoint(CCPoint(0,0))
		leftPanel:setPosition(CCPoint(0,0))
		leftPanel:setScale(panelScale)
		self.centerWidget:addChild(leftPanel)
		self.leftPanel = leftPanel
		
		if self.action_cd==0 and self.revival_cd==0 and self.fight_cd==0 then
			return
		end
		
		local offsetY = 0
		--战斗CD
		if self.fight_cd>0 then
			local label = CCLabelTTF:labelWithString("战斗冷却中：", CCSizeMake(200,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(10,30 + offsetY))
			label:setColor(ccc3(255,203,101))
			leftPanel:addChild(label)
			local label = CCLabelTTF:labelWithString(getLenQueTime(self.fight_cd), CCSizeMake(150,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(130,30 + offsetY))
			label:setColor(ccc3(250,140,0))
			leftPanel:addChild(label)
			self.fight_cd_label = label
			
			local btn = dbUIButtonScale:buttonWithImage("UI/zhenying/qing_chu.png",1.2,ccc3(125,125,125))
			btn:setAnchorPoint(CCPoint(0.5, 0.5))
			btn:setPosition(CCPoint(240,30 + offsetY))
			btn.m_nScriptClickedHandler = function(ccp)
				clearCDRequest(2)
			end
			leftPanel:addChild(btn)
			offsetY = offsetY + 50
		end

		--复活CD
		if self.revival_cd>0 then
			local label = CCLabelTTF:labelWithString("复活冷却中：", CCSizeMake(200,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(10,30 + offsetY))
			label:setColor(ccc3(255,203,101))
			leftPanel:addChild(label)
			local label = CCLabelTTF:labelWithString(getLenQueTime(self.revival_cd), CCSizeMake(150,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(130,30 + offsetY))
			label:setColor(ccc3(250,140,0))
			leftPanel:addChild(label)
			self.revival_cd_label = label

			local btn = dbUIButtonScale:buttonWithImage("UI/zhenying/qing_chu.png",1.2,ccc3(125,125,125))
			btn:setAnchorPoint(CCPoint(0.5, 0.5))
			btn:setPosition(CCPoint(240,30 + offsetY))
			btn.m_nScriptClickedHandler = function(ccp)
				clearCDRequest(3)
			end
			leftPanel:addChild(btn)
			offsetY = offsetY + 50
		end
				
		--行动CD
		if self.action_cd>0 then
			local label = CCLabelTTF:labelWithString("行动冷却中：", CCSizeMake(200,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(10,30 + offsetY))
			label:setColor(ccc3(255,203,101))
			leftPanel:addChild(label)
			local label = CCLabelTTF:labelWithString(getLenQueTime(self.action_cd), CCSizeMake(150,0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 20)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(130,30 + offsetY))
			label:setColor(ccc3(250,140,0))
			leftPanel:addChild(label)
			self.action_cd_label = label
			offsetY = offsetY + 50
		end
		
		local bg = createBG("UI/zhenying/left_right.png",300,10 + offsetY,CCSize(30,30))
		bg:setAnchorPoint(CCPoint(0,0))
		bg:setPosition(CCPoint(0,0))
		leftPanel:addChild(bg,-1)
	end,
	
	--右下角伤害信息提示
	createRight = function(self)
		local rightPanel = dbUIPanel:panelWithSize(CCSize(245,180))
		rightPanel:setAnchorPoint(CCPoint(1,0))
		rightPanel:setPosition(CCPoint(WINSIZE.width,0))
		rightPanel:setScale(panelScale)
		self.centerWidget:addChild(rightPanel)
		self.rightPanel = rightPanel

		local bg = createBG("UI/zhenying/left_right.png",245,180,CCSize(70,70))
		bg:setAnchorPoint(CCPoint(0,0))
		bg:setPosition(CCPoint(0,0))
		rightPanel:addChild(bg)

		self.msgList = dbUIList:list(CCRectMake(5,5,245,170),0)
		rightPanel:addChild(self.msgList)
	end,
	
	--创建底部文字显示和按钮
	createBottom = function(self)
		local panel = dbUIPanel:panelWithSize(CCSize(450,70))
		panel:setAnchorPoint(CCPoint(0.5,0))
		panel:setPosition(CCPoint(WINSIZE.width/2,0))
		panel:setScale(panelScale)
		self.centerWidget:addChild(panel)
		self.bottomPanel = panel
		
		local label = CCLabelTTF:labelWithString("怒气值:",SYSFONT[EQUIPMENT],22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(0,58))
		label:setColor(ccc3(148,0,211))
		panel:addChild(label)
		local label = CCLabelTTF:labelWithString(self.damder,SYSFONT[EQUIPMENT],22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(80,58))
		label:setColor(ccc3(173,255,47))
		panel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("金币:",SYSFONT[EQUIPMENT],22)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(150,58))
		label:setColor(ccc3(148,0,211))
		panel:addChild(label)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.gold,SYSFONT[EQUIPMENT],20)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(150+60,58))
		label:setColor(ccc3(173,255,47))
		panel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("战功:",SYSFONT[EQUIPMENT],22)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(300,58))
		label:setColor(ccc3(148,0,211))
		panel:addChild(label)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.exploit,SYSFONT[EQUIPMENT],22)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(300+60,58))
		label:setColor(ccc3(173,255,47))
		panel:addChild(label)
		
		local createBtn = function(image,type,pos,clickedHandler)
			local btn = dbUIButtonScale:buttonWithImage(image,1.2,ccc3(125,125,125))
			btn:setAnchorPoint(CCPoint(0.5, 0.5))
			btn:setPosition(pos)
			btn.m_nScriptClickedHandler = clickedHandler
			panel:addChild(btn)
			return btn
		end
		local speedRequest = function()
			clearCDRequest(1)
		end
		
		local warnning = function() alert("怒气值不足") end
		if self.damder>=30 then
			createBtn("UI/zhenying/jia_su.png",     1, CCPoint(60+100*0,30), speedRequest)
		else
			createBtn("UI/zhenying/jia_su_dis.png", 1, CCPoint(60+100*0,30), warnning)
		end			
		
		if self.damder>=50 then
			createBtn("UI/zhenying/fen_yong.png",   1, CCPoint(60+100*1,30), braveRequest)
		else
			createBtn("UI/zhenying/fen_yong_dis.png",1, CCPoint(60+100*1,30), warnning)
		end	
		
		createBtn("UI/zhenying/huan_zheng.png", 1, CCPoint(60+100*2,30), globleShowZhenFaPanel)
		createBtn("UI/zhenying/jia_xue.png",    1, CCPoint(60+100*3,30), addHPRequest)
	end,
	
	createCityPanel = function(self)
	    local mainWidget = dbUIPanel:panelWithSize(designSize)
	    mainWidget:setAnchorPoint(CCPoint(0.5, 0.5))
	    mainWidget:setScale(panelScale)
	    mainWidget:setPosition(CCPoint(WINSIZE.width/2, WINSIZE.height/2))
		self.mainPanel = mainWidget
		self.centerWidget:addChild(mainWidget,-1)
		
		local createCity = function(image,pos,index)
			local city = dbUIButtonScale:buttonWithImage(image,1.2,ccc3(125,125,125))
			city:setAnchorPoint(CCPoint(0.5,0.5))
			city:setPosition(pos)
			city.m_nScriptClickedHandler = function(ccp)
				moveRequest(index)
			end
			mainWidget:addChild(city)
			return city
		end

		local createBar = function(hp)
			local cfg = new(CITY_HP_BAR_CFG)
			local bar = new(Bar)
			bar:create(30,cfg)
			bar:setExtent(hp)
			return bar.barbg
		end

		self.cityBtnList = new({})
		for i=1,#CITY_CFG do
			local cfg = CITY_CFG[i]
			local city = createCity(cfg.image,cfg.pos,i)
			if i==1 then
				local sprite = CCSprite:spriteWithFile("UI/zhenying/shen_gong.png")
				sprite:setAnchorPoint(CCPoint(0,0.5))
				sprite:setPosition(city:getContentSize().width,city:getContentSize().height/2)
				city:addChild(sprite)
				
				self.godCityHPBar = createBar(self.godBastionHP)
				city:addChild(self.godCityHPBar)
			elseif i==7 then
				local sprite = CCSprite:spriteWithFile("UI/zhenying/mo_yu.png")
				sprite:setAnchorPoint(CCPoint(1,0.5))
				sprite:setPosition(0,city:getContentSize().height/2)
				city:addChild(sprite)
				
				self.devilCityHPBar = createBar(self.devilBastionHP)
				city:addChild(self.devilCityHPBar)
			end
			
			local ourSide = self.side==1 and self.cityList[i].god_side_num or self.cityList[i].devil_side_num
			local enemySide = self.side==1 and self.cityList[i].devil_side_num or self.cityList[i].god_side_num
			
			local label = CCLabelTTF:labelWithString("敌"..enemySide,SYSFONT[EQUIPMENT], 22)
			label:setPosition(CCPoint(city:getContentSize().width/2,city:getContentSize().height))
			label:setAnchorPoint(CCPoint(0.5,0))
			label:setColor(ccc3(250,140,0))
			city:addChild(label)			
			local label = CCLabelTTF:labelWithString("友"..ourSide,SYSFONT[EQUIPMENT], 22)
			label:setPosition(CCPoint(city:getContentSize().width/2,0))
			label:setAnchorPoint(CCPoint(0.5,1))
			label:setColor(ccc3(173,255,47))
			city:addChild(label)				
			
			self.cityBtnList[i] = city
		end
		
		--当前所在城市 
		local cur_city = self.cityBtnList[self.cur_city_idx]
		local head_bg = CCSprite:spriteWithFile("UI/zhenying/little_head.png")
		head_bg:setAnchorPoint(CCPoint(1,1))
		head_bg:setPosition(CCPoint(cur_city:getContentSize().width,cur_city:getContentSize().height))
		cur_city:addChild(head_bg)
		
		local head = CCSprite:spriteWithFile("head/Round/head_round_"..GloblePlayerData.role_face ..".png")
		head:setPosition(CCPoint(head_bg:getContentSize().width/2,head_bg:getContentSize().height/2))
		head:setScale(0.8*head_bg:getContentSize().width/head:getContentSize().width)
		head_bg:addChild(head)

		local arrow_image = self.side==1 and "UI/zhenying/arrow_ringht.png" or "UI/zhenying/arrow_left.png"
		for i=1,#ARROW_CFG do
			local sprite = CCSprite:spriteWithFile(arrow_image)
			sprite:setFlipY(true)
			sprite:setAnchorPoint(CCPoint(0,0))
			sprite:setPosition(ARROW_CFG[i].posAbove)
			sprite:setRotation(ARROW_CFG[i].rotationAbove)
			mainWidget:addChild(sprite)
			
			local sprite = CCSprite:spriteWithFile(arrow_image)
			sprite:setAnchorPoint(CCPoint(0,0))
			sprite:setPosition(ARROW_CFG[i].posBelow)
			sprite:setRotation(ARROW_CFG[i].rotationBelow)
			mainWidget:addChild(sprite)			
		end
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.uiLayer = dbUIMask:node()
		self.centerWidget = dbUIPanel:panelWithSize(CCSize(WINSIZE.width , WINSIZE.height))
        self.centerWidget:setAnchorPoint(CCPoint(0.5, 0.5))
        self.centerWidget:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
       
        self.uiLayer:addChild(self.centerWidget)	
		scene:addChild(self.uiLayer, 2000)
		
		local bg = CCSprite:spriteWithFile("UI/zhenying/zhen_scene.jpg")
		bg:setAnchorPoint(CCPoint(0.5, 0.5))
		bg:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
		bg:setScale(panelScale)
		self.centerWidget:addChild(bg,-1)

		--帮助按钮
		local helpBtn = new(ButtonScale)
		helpBtn:create("UI/public/helpred.png",1.2,ccc3(255,255,255))			
		helpBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		helpBtn.btn:setPosition(CCPoint(40*panelScale, WINSIZE.height-60*panelScale))
		helpBtn.btn:setScale(panelScale)
		self.centerWidget:addChild(helpBtn.btn,1)
		
		local text =
		"1、加入攻城战，玩家将被随机分配到一方阵营。"..
		"\n2、攻城战开始后，按照箭头指引向前移动，有两条不同路线可攻打至敌方大本营。"..
		"\n3、攻城移动时，只能向相邻的下一个主城行进，不能后退或跳跃前进。"..
		"\n4、战功、金币鼓舞对自身的攻击或防御有随机的加成，最多各加成50%，团队鼓舞每一次对整个己方队伍带来5%的攻击和防御的加成，最多鼓舞10次；战功、金币鼓舞和团队鼓舞的加成可相互叠加。"..
		"\n5、攻城战过程中，生命池不会补充角色血量，需使用“加血”功能进行补血。"..
		"\n6、只有将据点里所有敌人打退，才能移动到该据点，占领中立及敌人的据点可获得一定的据点积分。"..
		"\n7、大本营被敌方玩家点击一次，则损失1点守护血量，当一方大本营守护血量为0时，另一方阵营获胜，攻城战结束；若30分钟内双方大本营血量都不为0，则根据阵营积分计算胜负，阵营积分等于全部玩家的积分加上阵营战结束时占据的中立及敌人据点的积分。"
		helpBtn.btn.m_nScriptClickedHandler = function()
	        local dialogCfg = new(basicDialogCfg)
			dialogCfg.title = "攻城战说明"
			dialogCfg.msg = text
			dialogCfg.msgAlign = "left"
			dialogCfg.bg = "UI/baoguoPanel/kuang.png"
			dialogCfg.dialogType = 5
			dialogCfg.msgSize = 30
			dialogCfg.size = CCSize(1024,0);
			local dialog = new(Dialog)
			dialog:create(dialogCfg)
		end
		
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))		
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn:setPosition(CCPoint(WINSIZE.width-40*panelScale,WINSIZE.height-60*panelScale))
		closeBtn.btn:setScale(panelScale)
		closeBtn.btn.m_nScriptClickedHandler = function()
		     self:destroy()
		end
		self.centerWidget:addChild(closeBtn.btn,1)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.uiLayer)
		
		if self.secondHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.secondHandle)
			self.secondHandle = nil
		end
		leaveRequest()
		removeUnusedTextures()
		Instance = nil
	end,
	
	initData = function(self,json)
		GloblePlayerData.gold = json:getByKey("gold"):asInt()
		GloblePlayerData.copper = json:getByKey("copper"):asInt()
		GloblePlayerData.exploit = json:getByKey("exploit"):asInt()
		GloblePlayerData.ap_wand = json:getByKey("ap_wand"):asInt()
		GloblePlayerData.trainings.jump_wand = json:getByKey("jump_wand"):asInt()		
		updataHUDData()
		
		self.add_hp_times = json:getByKey("add_hp_times"):asInt() --回血次数
		
		self.side = json:getByKey("side"):asInt()  --1 神宫， 2，魔域
		self.cur_city_idx = json:getByKey("cur_city_idx"):asInt()
		
		self.damder = json:getByKey("damder"):asInt() --怒气
		self.defence_encourage = json:getByKey("defence_encourage"):asInt()
		self.attack_encourage = json:getByKey("attack_encourage"):asInt()

		self.god_score = json:getByKey("god_score"):asInt() --神营得分
		self.god_double_kill = json:getByKey("god_double_kill"):asInt() --最大连杀数
		self.god_double_kill_palyer = json:getByKey("god_double_kill_palyer"):asString() --最大连杀玩家

		self.devil_score = json:getByKey("devil_score"):asInt() --魔营得分
		self.devil_double_kill = json:getByKey("devil_double_kill"):asInt() --最大连杀数
		self.devil_double_kill_palyer = json:getByKey("devil_double_kill_palyer"):asString() --最大连杀玩家

		self.end_cd = json:getByKey("end_cd"):asInt() --结束剩余时间
		self.start_cd = json:getByKey("start_cd"):asInt() --开始倒计时
		self.action_cd = json:getByKey("action_cd"):asInt() --行动冷却时间
		self.fight_cd = json:getByKey("fight_cd"):asInt() --战斗冷却时间
		self.revival_cd = json:getByKey("revival_cd"):asInt() --复活冷却时间
		
		local cityList = new({})
		local cityListJson = json:getByKey("city_list")
		for i=1,cityListJson:size() do
			local cityJson = cityListJson:getByIndex(i-1)
			local city = new({})
			city.idx = cityJson:getByKey("idx"):asInt()
			city.owner_side = cityJson:getByKey("owner_side"):asInt()
			
			local num = cityJson:getByKey("role_num"):asInt()
			city.god_side_num = city.owner_side==1 and num or 0 --神营人数
			city.devil_side_num = city.owner_side==2 and num or 0 --魔营人数
			cityList[city.idx] = city
		end
		self.godBastionHP = json:getByKey("god_bastion_hp"):asInt()
		self.devilBastionHP = json:getByKey("devil_bastion_hp"):asInt()
		
		local sortByIdx = function(a,b) return a.idx  < b.idx end
		table.sort(cityList,sortByIdx)
		self.cityList = cityList
		
		self.msg = json:getByKey("msg"):asString() --最近一条消息
		self.alert_msg = json:getByKey("alert_msg"):asString() --alert消息会弹出窗口
		self.is_end = json:getByKey("is_end"):asBool() --是否结束
		if self.is_end then
			self.reward_apWand = json:getByKey("reward_apWand"):asInt()
			self.reward_jump = json:getByKey("reward_jump"):asInt()
			self.reward_exploit = json:getByKey("reward_exploit"):asInt()
			self.reward_copper = json:getByKey("reward_copper"):asInt()
			self.rank = json:getByKey("rank"):asInt()
			self.win_side = json:getByKey("win_side"):asInt()
		end
	end,
}

--初始化定时器
local initSecondHandle = function()
	local opSuccessCB = function (json)
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			if Instance==nil then return end
			Instance:initData(json) --更新数据
			Instance:updateUI() --更新界面
		end
	end
	local action = Net.OPT_LeagueTick
	NetMgr:registOpLuaFinishedCB(action,opSuccessCB)
	NetMgr:registOpLuaFailedCB(action,opFailedCB)

	--心跳包请求
	local tick = function(self)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(Net.OPT_LeagueTick, cj)
	end

	local timesTamp = 0
	local secondHandleFunction = function()
		if timesTamp == 3 then
			timesTamp = 0
			tick() --发送心跳包
		end
		timesTamp = timesTamp + 1

		Instance:updateCooldown() --更新倒计时
	end
	Instance.secondHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(secondHandleFunction,1, false)
end

--进入攻城战
local enterLeagueWar = function()
	local opSuccessCB = function (json)
		closeWait()
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			Instance = new(LeaguePanel)
			Instance:create(json)
			initSecondHandle()
		end
	end

	local request = function()
		showWaitDialog("")
		local action = Net.OPT_LeagueEnter
		NetMgr:registOpLuaFinishedCB(action,opSuccessCB)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)
		
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(action, cj)		
	end
	request()
end

local clearHUDCountdownTimeHandle = function()
	if HUDCountdownTimeHandle then
		CCScheduler:sharedScheduler():unscheduleScriptEntry(HUDCountdownTimeHandle)
		HUDCountdownTimeHandle = nil
	end
end

--更新主界面上攻城战的按钮上的倒计时
local updateLeagueHUD = function(cdTime)
	local hud = dbHUDLayer:shareHUD2Lua()
	if hud==nil then return end
	
	local setLabelValue = function(text)
		local btn = hud:getChildByTag(416) --攻城战入口按钮

		if WaitForOpenLabelBg == nil and text ~= "" then
			CCSpriteFrameCache:sharedSpriteFrameCache():addSpriteFramesWithFile("UI/HUD/HUD.plist")
			WaitForOpenLabelBg = CCSprite:spriteWithSpriteFrameName("UI/HUD/top/boss_war_time_load.png")
			WaitForOpenLabelBg:setPosition(CCPoint(btn:getContentSize().width/2,btn:getContentSize().height/2))
			btn:addChild(WaitForOpenLabelBg)
		end

		if WaitForOpenlabel == nil then
			WaitForOpenlabel = CCLabelTTF:labelWithString(text,"", 20)
			WaitForOpenlabel:setPosition(CCPoint(btn:getContentSize().width/2,btn:getContentSize().height/2))
			btn:addChild(WaitForOpenlabel)
		else
			WaitForOpenlabel:setString(text)
		end
	end
	
	local update = function()
		if cdTime > 0 then
			cdTime = cdTime - 1
		end
		local text = ""
		if cdTime==0 then
			clearHUDCountdownTimeHandle()
			text = "已开启"
		else
			text = getLenQueTime(cdTime)
		end		
		setLabelValue(text)
	end
	
	if cdTime > 0 then
		if HUDCountdownTimeHandle == nil then
			HUDCountdownTimeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(update,1,false)
		end
	elseif cdTime == 0 then
		setLabelValue("已开启")
	else --结束了
		clearHUDCountdownTimeHandle()
		if WaitForOpenLabelBg then
			WaitForOpenLabelBg:removeFromParentAndCleanup(true)
			WaitForOpenLabelBg = nil
		end
		if WaitForOpenlabel then
			WaitForOpenlabel:removeFromParentAndCleanup(true)
			WaitForOpenlabel = nil
		end		
	end
end

---进入攻城战,c++端调用
function GlobleExecuteLeagueWar()
	enterLeagueWar()
end

---更新主界面上攻城战的按钮上的倒计时,opFateFinishCB中调用
function GlobleUpdateLeagueHUD(wait_for_open)
	updateLeagueHUD(wait_for_open)
end

---注销退出的时候情况攻城战的一些状态
function GlobleClearLeagueStatus()
	clearHUDCountdownTimeHandle()
	WaitForOpenlabel = nil
	WaitForOpenLabelBg = nil
end
---任务类型，1：主线；2：支线
local TaskType = 1

---世界地图
local Instance = nil --界面实例对象

local PANEL_SCALE = WINSIZE.height/720

---地图上城市的数据
local MAP_DATA = nil

---在地图上走路的速度
local SPEED = 200

---是否能关闭地图
local closable = true

---是否可以点击地图上的城市
local clickable = true

---当前所在城市
local CurrentSceneId = 0

---地图宽度,没有缩放后的
local MapWidth = 0
---地图高度,没有缩放后的
local MapHeight = 0

---拿来播放动画的节点
local ActionNode = nil

---呼吸动画，及走路动画
local IdleAmimation = nil;
local MoveAmimation = nil;

local runAction = nil
local moveAction = nil

---初始化城市
local initMapData = function()
	local cfgSceneJson = openJson("cfg/cfg_scene.json")
	local keys = Value:new()
	MAP_DATA = new({})
	GlobalCfgMgr:getJsonKeys(cfgSceneJson,keys)

	for i=1,keys:size() do
		local key = keys:getByIndex(i-1):asString()
		local cityCfg = cfgSceneJson:getByKey(key)
		local sceneId = cityCfg:getByKey("scene_id"):asInt()
		local type = cityCfg:getByKey("type"):asInt()
		if GloblePlayerData.sceneMap[sceneId] and type <= 2 then
			local worldMapPosition = lua_string_split(cityCfg:getByKey("world_map_position"):asString()," ")
			local enteryPosition = lua_string_split(cityCfg:getByKey("entry_position"):asString()," ")
			local startPosition = lua_string_split(cityCfg:getByKey("start_position"):asString()," ")
			
			local cityData = {
				sceneId 	 		= cityCfg:getByKey("scene_id"):asInt(),
				name 				= cityCfg:getByKey("name"):asString(),
				worldMapPosition 	= CCPoint(worldMapPosition[1],worldMapPosition[2]),
				startPosition 		= CCPoint(startPosition[1],startPosition[2]),
				enteryPosition 		= CCPoint(enteryPosition[1],enteryPosition[2]),
				type 				= cityCfg:getByKey("type"):asInt(),
				monsterLevel 		= cityCfg:getByKey("monster_level"):asString(),
			}
			MAP_DATA[key] = cityData
		end
	end
end

---更新地图数据
GlobalUpdateMapData = function()
	initMapData()
end

---初始化人物动画
local initAnimation = function(figure)
	local mapObjs = GlobalCfgMgr:getCfgJsonRoot("cfg/mapObjs.json")
	local animations = mapObjs:getByKey(figure):getByKey("animations")
	for i=1, animations:size() do
		local animation = animations:getByIndex(i-1)
		local name = animation:getByKey("name"):asString()
		local id = animation:getByKey("id"):asString()
		if name == "idle" then
			IdleAmimation = dbAnimationMgr:sharedAnimationmgr():getAnimation(id)
		end
		if name == "move" then
			MoveAmimation = dbAnimationMgr:sharedAnimationmgr():getAnimation(id)
		end		
	end
end

---主要是为了房子table索引的时候 key 可能为 number类型导致MAP_DATA[cityId]返回空
local getCity = function(cityId)
	return MAP_DATA[""..cityId]
end

local getPlayerPosition = function(cityPosition)
	return CCPoint(cityPosition.x,cityPosition.y+60)
end

local destroy = function()
	if Instance then
		Instance:destroy()
	end
end

local idle = function()
	local action = CCAnimate:actionWithAnimation(IdleAmimation)
	ActionNode:runAction(CCRepeatForever:actionWithAction(action))
end

local moveScheduler = nil
local unscheduleMoveScheduler = function()
	if moveScheduler then
		CCScheduler:sharedScheduler():unscheduleScriptEntry(moveScheduler)
		moveScheduler = nil
	end
end
local cameraScheduler = nil
local unscheduleCameraScheduler = function()
	if cameraScheduler then
		CCScheduler:sharedScheduler():unscheduleScriptEntry(cameraScheduler)
		cameraScheduler = nil
	end
end

local unscheduleAll = function()
	unscheduleMoveScheduler()
	unscheduleCameraScheduler()
end

--移动到某一个城市 
local moveToCity = function(cityId,callback)
	ActionNode:stopAction(runAction)
	ActionNode:stopAction(moveAction)
	
	local targetCity = getCity(cityId)
	local curCity = getCity(CurrentSceneId)
	
	local curPosition = CCPoint(ActionNode:getPosition())
	local destPosition = getPlayerPosition(targetCity.worldMapPosition)
	
	local action = CCAnimate:actionWithAnimation(MoveAmimation)
	runAction = CCRepeatForever:actionWithAction(action)
	
	local time = Distance(curPosition,destPosition) / SPEED
	moveAction = CCMoveTo:actionWithDuration(time,destPosition)
	
	--当移动的距离很小，不需要移动地图的位置
	local needMoveMap = true
	if math.abs(curPosition.x - destPosition.x) < 100 then
		needMoveMap = false
	end

	unscheduleAll()
	
	ActionNode:runAction(runAction)
	ActionNode:runAction(moveAction)
	ActionNode:setFlipX(destPosition.x < curPosition.x)
	
	local moveEnd = function()
		unscheduleAll()
		
		ActionNode:stopAction(runAction)
		ActionNode:stopAction(moveAction)
		CurrentSceneId = cityId
		
		idle(ActionNode)
		
		if callback then
			callback()
		end
	end
	moveScheduler = CCScheduler:sharedScheduler():scheduleScriptFunc(moveEnd, time, false)
	
	local winWidth = WINSIZE.width * PANEL_SCALE
	local mapWidth = Instance.mapPanel:getContentSize().width
	local toRght = destPosition.x > curPosition.x	  
	
	--设置地图的位置，根据人物走的位置判断
	if needMoveMap then
		local check = function()
			local x,y = ActionNode:getPosition()
			local mapX,mapY = Instance.mapPanel:getPosition()
			local move = SPEED * 0.05
	
			if (x + mapX) > winWidth*0.5 and toRght then
				mapX = mapX - move
				local min = winWidth - mapWidth;
				if mapX < min then mapX = min end
				Instance.mapPanel:setPosition(CCPoint(mapX,0))
			elseif x < mapWidth - winWidth*0.5 and toRght==false then
				mapX = mapX + move
				if mapX > 0 then mapX = 0 end	
				Instance.mapPanel:setPosition(CCPoint(mapX,0))
			end
		end
		cameraScheduler = CCScheduler:sharedScheduler():scheduleScriptFunc(check, 1.0, false)
	end
	
	EndGuaJi()
end

local openFight = function(cityId)
	local city = getCity(cityId);
	--传送到目标城市
	if city.type==1 then
		local response = function(json)
			destroy()
		end
		NetMgr:registOpLuaFinishedCB(Net.OPT_ChangeScene,response)
		G_SceneMgr:changeToNormalScene(cityId, city.startPosition)
	else  --弹出战斗界面
		local cfgSceneJson = openJson("cfg/cfg_scene.json")
		local s = cfgSceneJson:getByKey(""..cityId)
		local campId = s:getByKey("open_camp"):asInt()

		if campId > 0 then
			callCampPanel(campId)
		end
	end
end

--界面定义
local Panel = {
	mapPanel = nil,
	uiLayer  = nil,
	
	create = function(self)
		if not MAP_DATA then initMapData() end
		
		initAnimation(GloblePlayerData.generals[1].figure);
		
		local scene = DIRECTOR:getRunningScene()
		self.uiLayer = dbUIMask:node()
		scene:addChild(self.uiLayer, 2000)
		
		--关闭按钮
		local btn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png", 1.2, ccc3(125, 125, 125))
		btn:setScale(1/isRetina)
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setPosition(CCPoint(WINSIZE.width-40*PANEL_SCALE,WINSIZE.height-60*PANEL_SCALE))
		btn.m_nScriptClickedHandler = function()
			destroy()
		end
		self.uiLayer:addChild(btn,1)

		self:loadMaps()
		self:loadCities()
		self:loadPlayer()
	end,
	
	--显示玩家
	loadPlayer = function(self)
		local sceneId = dbSceneMgr:getSingletonPtr():getCurCityMapId()
		CurrentSceneId = sceneId == 0 and CurrentSceneId or sceneId
		
		local cityData = getCity(CurrentSceneId);
		if not cityData then
			Log("cityData is nil CurrentSceneId: "..CurrentSceneId)
		end
		
		local playerPosition = getPlayerPosition(cityData.worldMapPosition)
		
		ActionNode = CCSprite:spriteWithFile("UI/nothing.png")
		ActionNode:setAnchorPoint(CCPoint(0.5,0.5))
		ActionNode:setPosition(playerPosition)
		ActionNode:setScale(0.8*isRetina)
		self.mapPanel:addChild(ActionNode,0,1)
		
		--设定地图的位置，比如人在地图的右侧看不到了，需要合理地设置地图位置
		local x = playerPosition.x
		local width = WINSIZE.width / PANEL_SCALE

		if x > width/2 then
			local mapX = -(x - width/2)
			local right = width - MapWidth;
			if mapX < right  then mapX = right  end
			self.mapPanel:setPosition(CCPoint(mapX,0))
		end
			
		idle()
	end,

	--根据地图配置载入城市
	loadCities = function(self)
		for key,value in pairs(MAP_DATA) do
			local cityData = value
			local image = cityData.type==1 and "UI/worldMap/city.png" or "UI/worldMap/city_for_fight.png"
			local city = dbUIButtonScale:buttonWithImage(image, 1, ccc3(125, 125, 125))
			city:setAnchorPoint(CCPoint(0.5,0.5))
			city:setPosition(cityData.worldMapPosition)
			city.m_nScriptClickedHandler = function()
				if clickable then
					local callback = function()
						openFight(cityData.sceneId);
					end
					moveToCity(cityData.sceneId,callback)
				end
			end
			self.mapPanel:addChild(city)
			
			local nameBgPos = cityData.type==1 and CCPoint(city:getContentSize().width/2, 10) or CCPoint(city:getContentSize().width/2, 0)
			local nameBg = CCSprite:spriteWithFile("UI/worldMap/city_name_bg.png")
			nameBg:setAnchorPoint(CCPoint(0.5,1))
			nameBg:setPosition(nameBgPos)
			if cityData.monsterLevel == "0" then
				nameBg:setScaleY(0.5)
			end
			city:addChild(nameBg)

			local label = CCLabelTTF:labelWithString(cityData.name, SYSFONT[EQUIPMENT], 21)
			label:setColor(ccc3(255,183,3))
			label:setAnchorPoint(CCPoint(0.5,1))
			label:setPosition(CCPoint(nameBg:getContentSize().width/2,nameBg:getContentSize().height - 5))
			if cityData.monsterLevel == "0" then
				label:setScaleY(2)
			end
			nameBg:addChild(label)
			
			if cityData.monsterLevel~= "0" then
				local label = CCLabelTTF:labelWithString(cityData.monsterLevel, SYSFONT[EQUIPMENT], 21)
				label:setAnchorPoint(CCPoint(0.5,0))
				label:setPosition(CCPoint(nameBg:getContentSize().width/2,3))
				nameBg:addChild(label)
			end
		end
	end,
		
	--加载地图
	loadMaps = function(self)
		local width = 0
		local height = 0
		local maps = {}
		
		for i=1,3 do
			local mapSlice = CCSprite:spriteWithFile("UI/worldMap/word_map_"..i..".jpg")
			mapSlice:setAnchorPoint(CCPoint(0,0))
			mapSlice:setPosition(CCPoint(width,0))
			width = width + mapSlice:getContentSize().width
			height = mapSlice:getContentSize().height
			table.insert(maps,mapSlice)
		end
		MapWidth = width
		MapHeight = height
		
		local mapPanel = nil 
		if MapHeight < WINSIZE.height then
			mapPanel = dbUIPanel:panelWithSize(CCSize(MapWidth * PANEL_SCALE, MapHeight * PANEL_SCALE))
		else
			mapPanel = dbUIPanel:panelWithSize(CCSize(MapWidth, MapHeight))
		end
		mapPanel:setAnchorPoint(CCPoint(0,0))
		mapPanel:setPosition(CCPoint(0,0))
		for i=1, #maps do
			mapPanel:addChild(maps[i])
		end
		self.mapPanel = mapPanel
		
		local scrollArea = dbUIScrollArea:scrollAreaWithWidget(mapPanel,1)
		scrollArea:setAnchorPoint(CCPoint(0,0))
		scrollArea:setPosition(CCPoint(0,0))
		scrollArea:setScale(PANEL_SCALE)
		scrollArea.m_nScriptDragMoveHandler = function(pos,prevPos)
			local x,y = mapPanel:getPosition()
			local right = WINSIZE.width / PANEL_SCALE - MapWidth;
			if x > 0 then x = 0 end
			if x < right  then x = right  end
			mapPanel:setPosition(CCPoint(x,y))
		end
		self.uiLayer:addChild(scrollArea)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.uiLayer)
		unscheduleAll()
		Instance = nil
		TaskType = 1
		
		--关闭地图时才显示新功能开启
		OpenNextStep()
		
		local HUD = dbHUDLayer:shareHUD2Lua()
		if HUD then
			HUD:taskInfoVisible(20111)
		end
	end,
}

--下面的GlobleMoveToCurSceneNPC会用到
local targetNpcId = 0

local moveToNpc = function(destSceneId, npcId)
	local response = function(json)
		local error_code = json:getByKey("error_code"):asInt()
		if error_code == -1 then
			destroy()
		end
	end
	NetMgr:registOpLuaFinishedCB(Net.OPT_ChangeScene,response)
	
	local callback = function()
		local position = getCity(destSceneId).enteryPosition
		G_SceneMgr:changeToNormalScene(destSceneId,position)
	end
	moveToCity(destSceneId,callback)
	targetNpcId = npcId
end

local moveToFight = function(destSceneId)
	local response = function(json) end
	NetMgr:registOpLuaFinishedCB(Net.OPT_ChangeScene,response)
	
	local callback = function()
		local position = getCity(destSceneId).startPosition
		G_SceneMgr:changeToNormalScene(destSceneId,position)
	end
	moveToCity(destSceneId,callback)
end

function GlobleMoveToCurSceneNPC()
	if targetNpcId > 0 then
		dbTaskMgr:getSingletonPtr():pathing2CurSceneWordNpc(targetNpcId)
		targetNpcId = 0
	end
end

---移动到目标位置
function GlobleMoveToTarget(data)
	if not Instance then
		Instance = new(Panel)
		Instance:create()
	end
	
	--[[
		taskPathForNpc 	  = 1, --移动到目标地图中的NPC
		taskPathForFight  = 2, --移动到目标战场
		taskPathForSubmit = 3  --去提交任务
	]]--
	local type = data:getByKey("type"):asInt()
	local dest_scene_id = data:getByKey("dest_scene_id"):asInt()
	
	if type == 1 then
		local npc_id = data:getByKey("npc_id"):asInt()
		moveToNpc(dest_scene_id,npc_id)
	elseif type == 2 then
		--1：主线任务 2：支线任务 
		TaskType = data:getByKey("task_type"):asInt()
		moveToFight(dest_scene_id)
	elseif type == 3 then
		local npc_id = data:getByKey("submit_npc_id"):asInt()
		moveToNpc(dest_scene_id,npc_id)
	end
end

---进入传送阵
function GlobleEnterEntry(data)
	if not Instance then
		Instance = new(Panel)
		Instance:create()
	end

	local dest_scene_id = data:getByKey("dest_scene_id"):asInt()
	local dest_position_x = data:getByKey("dest_position_x"):asInt()
	local dest_position_y = data:getByKey("dest_position_y"):asInt()
	moveToFight(dest_scene_id)
end

---只打开地图
function GlobleOpenWorldMap()
	Instance = new(Panel)
	Instance:create()
end

---判断战斗结束后是否已经完成任务
CheckSubmitAfterBattle = function()
	local task = nil
	if TaskType == 1 then --引导过来的是主线任务
		task = dbTaskMgr:getSingletonPtr():getMainTaskInfo()
	elseif TaskType == 2 then  --引导过来的是支线任务
		task = dbTaskMgr:getSingletonPtr():getBranchTaskInfo()
	end
	
	if task then
        local finishValue = task.mFinishValue
        local doneValue = task.mCurDoneValue
        
        --已经完成
        if doneValue >= finishValue then
       	 	local cfg_npc = openJson("cfg/npc.json")
        	local submit_npc = task.mCategory
        	local dest_scene_id = cfg_npc:getByKey(""..submit_npc):getByKey("cfg_scene_id"):asInt()
        	moveToNpc(dest_scene_id,submit_npc)
        	return true
        end
	end
	
	return false
end

GetCurTaskType = function()
	return TaskType
end

IsInWordMap = function()
	return Instance ~= nil
end
---右下角的消息事件提醒
--onClick,onClosed,onOpen
local EventMap = {
	new_equip = {
		name = "new_equip",
		title = "新的装备",
		content = "您获得了新的装备，立刻点击查看",
		icon = "UI/upgrade_assist/zhuang_bei.png",
		onClick = function(eventPanel)
			StartUserGuide("equip")
			eventPanel:destroy()
		end
	},
	
	equip = {
		name = "equip",
		title = "新的装备",
		content = "您获得了新的装备，立刻点击查看",
		icon = "UI/upgrade_assist/zhuang_bei.png",
		onClick = function(eventPanel)
			globleShowWuJiangPanel()
		end
	},
	
	grow_gift_10 = {
		name = "grow_gift_10",
		title = "10级礼包",
		content = "当前10级成长礼包可以使用，立刻点击查看",
		icon = "icon/Item/icon_item_10000034.png",
		
		onOpen = function()
			for i = 1, #GlobleItemsData do
				if GlobleItemsData[i].cfg_item_id == 41010002 then
					return true
				end
			end
			return false
		end,
		
		onClick = function(eventPanel)
			StartUserGuide("open_gift_10")
			eventPanel:destroy()
		end
	},
	
	zhaomu = {
		name = "zhaomu",
		title = "招募新宠",
		content = "当前可以招募新的宠物，立刻点击查看",
		icon = "UI/HUD/foot/zhao_mu_2.png",
		
		onClick = function(eventPanel)
			createTavernPanel()
		end
	},

	zhenxing = {
		name = "zhenxing",
		title = "升级阵形",
		content = "当前升级阵形，能上阵更多宠物，立刻点击查看",
		icon = "UI/HUD/foot/zhen_xing_2.png",
		
		onClick = function(eventPanel)
			globleShowZhenFaPanel()
		end
	},

	keji = {
		name = "keji",
		title = "升级科技",
		content = "通过升级科技提升全面能力，立刻点击查看",
		icon = "UI/HUD/foot/ke_ji_2.png",
		
		onClick = function(eventPanel)
			globle_create_tian_fu()
			eventPanel:destroy()
		end
	},
	
	qianghua = {
		name = "qianghua",
		title = "强化装备",
		content = "神位30级之前强化无需冷却时间，赶紧去强化",
		icon = "UI/HUD/foot/qiang_hua_2.png",
		
		onClick = function(eventPanel)
			globleShowQHPanel()
			eventPanel:destroy()
		end
	},

	composite = {
		name = "composite",
		title = "装备升级",
		content = "装备升级能提升装备品质，增强战力，点击查看",
		icon = "UI/HUD/foot/qiang_hua_2.png",
		
		onClick = function(eventPanel)
			globleShowComposite()
			eventPanel:destroy()
		end
	},

	xiang_qian = {
		name = "xiang_qian",
		title = "镶嵌宝石",
		content = "镶嵌宝石能极大提高装备属性，点击查看",
		icon = "UI/HUD/foot/qiang_hua_2.png",
		
		onClick = function(eventPanel)
			globleShowXiangQian()
			eventPanel:destroy()
		end
	},
		
	jixin = {
		name = "jixin",
		title = "祭星",
		content = "当前可祭星提高战力，点击查看",
		icon = "UI/HUD/foot/ji_xing_2.png",
		
		onClick = function(eventPanel)
			globleShowJiFete()
			eventPanel:destroy()
		end
	},

	army_sweeping = {
		name = "army_sweeping",
		title = "扫荡完成",
		content = "关卡扫荡完成，立刻点击查看",
		icon = "UI/fight/fight_flag.png",

		onClosed = function()
			finishSweepingSilent()
		end,
				
		onClick = function(eventPanel)
			createBattleSweepPanel(0)
			eventPanel:destroy()
		end
	},
	
	raid_sweeping = {
		name = "raid_sweeping",
		title = "扫荡完成",
		content = "精英副本扫荡完成，立刻点击查看",
		icon = "UI/fight/fight_flag.png",

		onClosed = function()
			executeRaidSweepCheck(true)
		end,
				
		onClick = function(eventPanel)
			executeRaidSweepCheck()
			eventPanel:destroy()
		end
	},
		
	train = {
		name = "train",
		title = "训练",
		content = "训练，提取经验能快速提高角色等级，点击查看",
		icon = "UI/upgrade_assist/xun_lian.png",
		
		onClick = function(eventPanel)
			--找出等级最低的
			local minLevel = 1000
			local minIndex = 0
			for i = 1, #GloblePlayerData.generals do
				local g = GloblePlayerData.generals[i]
				if g.level < GloblePlayerData.officium then
					if g.level < minLevel then
						minLevel = g.level
						minIndex = i
					end
				end
			end
			
			if minIndex > 0 then
				GloblePanel.curGenerals = minIndex
				globleShowXunLianPanel()
			end
			
			eventPanel:destroy()
		end
	},	
}

function DispatchEvent(name)
	if GolbalEventPanel then
		GolbalEventPanel:destroy()
		GolbalEventPanel = nil
	end
	GolbalEventPanel = new(EventPanel)
	GolbalEventPanel:create(name)
end

function CloseEvent(name)
	if GolbalEventPanel and (name == nil or GolbalEventPanel.event.name == name) then
		GolbalEventPanel:destroy()
	end
end

EventPanel = {
	kuang = nil,
	
	create = function(self,eventName)
		Log("DispatchEvent "..eventName)
		
		local hud = dbHUDLayer:shareHUD2Lua()
		if hud == nil then
			Log("DispatchEvent hud == nil "..eventName)
			return
		end
		
		local hudScale = hud:getScale()
		
		local event = EventMap[eventName]
		if event == nil then
			Log("DispatchEvent event == nil "..eventName)
			return
		end
		
		if event.onOpen ~= nil and event.onOpen() == false then
			Log("DispatchEvent event.onOpen == false "..eventName)
			return
		end
		
		self.event = event
		
		--背景
		local isOpenHudBtns = hud:isOpenHudBtns()
		local x = WINSIZE.width/hudScale - 20
		if isOpenHudBtns then
			x = x - 100
		end
		
		local kuang = createBG("UI/public/tankuang_bg.png",440,160,CCSizeMake(80,80))
		kuang:setAnchorPoint(CCPoint(1,0))
		kuang:setPosition(CCPoint(x, 115/hudScale))
		kuang.m_nScriptClickedHandler = function()
			event.onClick(self)
		end
		hud:addChild(kuang,1)
		self.kuang = kuang
		
		local iconBtn = dbUIButtonScale:buttonWithImage("UI/public/kuang_96_96.png", 1, ccc3(125, 125, 125))
		iconBtn:setAnchorPoint(CCPoint(0,0.5))
		iconBtn:setPosition(CCPoint(30,80))
		iconBtn.m_nScriptClickedHandler = function()
			event.onClick(self)
		end
		kuang:addChild(iconBtn)
		
		CCSpriteFrameCache:sharedSpriteFrameCache():addSpriteFramesWithFile("UI/HUD/HUD.plist")
		local i,j = string.find(event.icon,"HUD")
		local icon = nil
		if i == nil then
			icon = CCSprite:spriteWithFile(event.icon)
		else
			icon = CCSprite:spriteWithSpriteFrameName(event.icon)
		end
		icon:setAnchorPoint(CCPoint(0.5,0.5))
		icon:setPosition(CCPoint(48,48))
		icon:setScale(0.8 * iconBtn:getContentSize().width / icon:getContentSize().width)
		iconBtn:addChild(icon)
		
		local titlelabel = CCLabelTTF:labelWithString(event.title,CCSize(200,0),0, SYSFONT[EQUIPMENT], 24)
		titlelabel:setAnchorPoint(CCPoint(0,0))
		titlelabel:setPosition(CCPoint(150,105))
		titlelabel:setColor(ccc3(248,100,0))
		kuang:addChild(titlelabel)

		local contentLabel = CCLabelTTF:labelWithString(event.content,CCSize(250,0),0, SYSFONT[EQUIPMENT], 20)
		contentLabel:setAnchorPoint(CCPoint(0,1))
		contentLabel:setPosition(CCPoint(150,95))
		contentLabel:setColor(ccc3(255,204,153))
		kuang:addChild(contentLabel)
				
		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png", 1, ccc3(125, 125, 125))
		closeBtn:setPosition(CCPoint(420,140))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
			if event.onClosed then
				event.onClosed()
			end
		end
		kuang:addChild(closeBtn)
	end,

	destroy = function(self)
		if self.kuang then
			self.kuang:removeFromParentAndCleanup(true)
			self.kuang = nil
		end
		GolbalEventPanel = nil
	end
}
--人物选择列表
GlobleGeneralListPanel = nil
GeneralListPanel = {
	bgLayer = nil,
    uiLayer = nil, --其实是个dbUIMask
    centerWidget = nil,
    
    create = function(self)
    	local scene = DIRECTOR:getRunningScene()
    	self.bgLayer = createPanelBg()
    	self.uiLayer,self.centerWidget = createCenterWidget()
        scene:addChild(self.bgLayer, 1004)
        scene:addChild(self.uiLayer, 2004)
        
        local bg = CCSprite:spriteWithFile("UI/public/bg.png")
    	bg:setPosition(CCPoint(1010/2, 702/2))
    	
        local mainPanel = dbUIPanel:panelWithSize(CCSize(1010, 702))
        mainPanel:setAnchorPoint(CCPoint(0.5, 0.5))
    	mainPanel:setPosition(CCPoint(1010 / 2, 702 / 2))
        mainPanel:addChild(bg)
        self.centerWidget:addChild(mainPanel)
        self.mainPanel = mainPanel
        
        --头部
		local top = new(GeneralListPanelTop)
		top:create(mainPanel)
		top.closeBtn.m_nScriptClickedHandler = function()
			self:close()
		end
		top.arenaRankBtn.m_nScriptClickedHandler=function()
			self:close()
			globleCreateArena()
		end
		local main = new(GeneralListPanelMain)
		main:create(mainPanel);
		self.main = main
		return self
    end,
  
  	reflash = function(self)
		self.main:reflash(self.mainPanel)
	end,
	  
    close = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
        self.centerWidget = nil
        self.bgLayer = nil
        self.uiLayer = nil
        self.main = nil
		GlobleGeneralListPanel = nil        
    end,
}

--人物列表
GeneralListPanelMain = {
	
	reflash = function(self,mainPanel)
		self.generalScrollPanel:removeAllChildrenWithCleanup(true)
		self:create(mainPanel)
	end,
	
	create = function(self,mainPanel)
		
		local generalScrollPanel = dbUIPanel:panelWithSize(CCSize(915 * 2, 460))
		generalScrollPanel:setAnchorPoint(CCPoint(0, 0))
		generalScrollPanel:setPosition(0,0)
		self.generalScrollPanel = generalScrollPanel
		
		local generals = GloblePlayerData.generals
		local formation = returnFormationInfo(GloblePlayerData.formations[GlobalCurZhenFa])	
		self.total = table.getn(generals)
		self.pageCount = math.ceil(self.total / 5)
		
		--创建十个框用来放置武将，如果武将人数不够就显示没有
		for i=1,self.pageCount do
			local singlePagePanel = dbUIPanel:panelWithSize(CCSize(915, 460))
			singlePagePanel:setAnchorPoint(CCPoint(0, 0))
			singlePagePanel:setPosition((i-1)*915,0)		
			generalScrollPanel:addChild(singlePagePanel)
			for j=1,5 do
				local generalKuangBg = CCSprite:spriteWithFile("UI/public/role_bg_kuang.png")
				generalKuangBg:setAnchorPoint(CCPoint(0, 0))
				generalKuangBg:setPosition(CCPoint(0, 0))
				if i==1 and j==1 then
					self.rolePanel = generalKuangBg 
				end
								
				local generalKuang = dbUIPanel:panelWithSize(CCSize(173, 460))
				generalKuang:addChild(generalKuangBg)
				generalKuang:setAnchorPoint(CCPoint(0, 0))
				generalKuang:setPosition((j-1)*186,0)
				singlePagePanel:addChild(generalKuang)
				
				local general = generals[(i-1)*5 + j]
				if(general) then
					--是否出战				
					local isChuzhan = false
					for j = 1 , table.getn(formation.pos) do
						if formation.pos[j] == general.general_id then
							isChuzhan = true
						end
					end
					if(isChuzhan) then
						local chuzhan = CCSprite:spriteWithFile("UI/generalListPanel/chuzhan.png")
						chuzhan:setPosition(CCPoint(23,423))
						generalKuang:addChild(chuzhan)
					end
					
					--根据评级显示不同颜色的名字
					local nameLbl = CCLabelTTF:labelWithString(general.name,CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
			        nameLbl:setPosition(CCPoint(173/2,390))
			        nameLbl:setColor(PLAYER_COLOR[general.quality])
					generalKuang:addChild(nameLbl)
					
					--等级
					local lvlLbl = CCLabelTTF:labelWithString(general.level.."级",CCSize(0,0),0, SYSFONT[EQUIPMENT], 24)
					lvlLbl:setColor(ReColor[general.reincarnate + 1])
					lvlLbl:setPosition(CCPoint(173/2,355))
					lvlLbl:setColor(ccc3(255,203,153))
					generalKuang:addChild(lvlLbl)
					--形象
					local figure = CCSprite:spriteWithFile("head/Big/head_big_"..general.figure..".png")
					local figureBtn = dbUIButton:buttonWithImage(figure)
					figureBtn:setAnchorPoint(CCPoint(0.5,0.5))
					figureBtn:setScale(0.8 * 173/figure:getContentSize().width)
					figureBtn:setPosition(173/2,460/2)
					figureBtn.m_nScriptClickedHandler = function()
						GloblePanel.curGenerals = (i-1)*5 + j
						globleShowWuJiangPanel()
					end
					generalKuang:addChild(figureBtn)
					
					-- 职业
					local jobJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_job.json")
					local jobName = jobJsonConfig:getByKey(general.job):getByKey("name"):asString()
					local jobNameLabel = CCLabelTTF:labelWithString(jobName,CCSize(0,0),0, SYSFONT[EQUIPMENT], 30)	
					jobNameLabel:setPosition(CCPoint(173/2,40))
					jobNameLabel:setColor(ccc3(81,31,8))
					generalKuang:addChild(jobNameLabel)					
				else
					local normalSpr = CCSprite:spriteWithFile("UI/zhao_mu/bg.png")
					normalSpr:setAnchorPoint(CCPoint(0.5,0.5))
					normalSpr:setPosition(CCPoint(173/2,460/2))
					generalKuang:addChild(normalSpr)
				end			
			end
		end
		
		--滑动的区域
		local scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(generalScrollPanel, 1, self.pageCount)
		scrollArea:setScrollRegion(CCRect(0, 0, 915, 460))
		scrollArea:setAnchorPoint(CCPoint(0, 0))
		scrollArea:setPosition(45,130)
		scrollArea.pageChangedScriptHandler = function(page)
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[page+1])
		end
		mainPanel:addChild(scrollArea)
		
		self:createPage(mainPanel,scrollArea)
	end,
	
	--分页
	createPage = function(self,mainPanel,scrollArea)
		self.pageToggles = {}
		for i=1,self.pageCount do
			local normalSpr = CCSprite:spriteWithFile("UI/public/page_btn_normal.png")
			local togglelSpr = CCSprite:spriteWithFile("UI/public/page_btn_toggle.png")		
			local toggle = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
			toggle:setAnchorPoint(CCPoint(0, 0))
			toggle:setPosition(1010/2-32 + (i-1)*32*2,80)
			toggle.m_nScriptClickedHandler = function()
				scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,self.pageToggles[i])
			end
			mainPanel:addChild(toggle)
			self.pageToggles[i]=toggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[1])
	end
}

--顶部功能。关闭，显示其他一些信息
GeneralListPanelTop = {

	closeBtn  = nil,
	create = function(self,mainPanel)
		
		local topPanelHeight = 105
		local topPanel = dbUIPanel:panelWithSize(CCSize(1010, topPanelHeight))
		topPanel:setAnchorPoint(CCPoint(0,0))
		topPanel:setPosition(CCPoint(0,599))
		
		local niceImage = CCSprite:spriteWithFile("UI/generalListPanel/nice_image.png")
		niceImage:setAnchorPoint(CCPoint(0,0.5))
		niceImage:setPosition(CCPoint(0,topPanelHeight/2))
		topPanel:addChild(niceImage)

		--显示总战斗力
		local fight_power = CCLabelTTF:labelWithString("总战力: "..GloblePlayerData.fight_power, CCSize(300,0),0,SYSFONT[EQUIPMENT], 26)	
		fight_power:setAnchorPoint(CCPoint(0,0.5))
		fight_power:setPosition(CCPoint(400,40))
		fight_power:setColor(ccc3(66,16,5))
		topPanel:addChild(fight_power)
		
		--显示竞技场排名
		local step_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_step.json")
		local arena_open = step_cfg:getByKey("arena_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--竞技场开启
		local arenaRank = CCLabelTTF:labelWithString("竞技排名: "..(arena_open and GloblePlayerData.arena_rank or "未开放"), SYSFONT[EQUIPMENT], 22)	
		arenaRank:setAnchorPoint(CCPoint(0.5,0.5))
		arenaRank:setPosition(CCPoint(95,32))
		arenaRank:setColor(ccc3(254,203,52))

		local arenaRankBtn = dbUIButtonScale:buttonWithImage("UI/generalListPanel/jin_ji_chang.png",1.1)
		arenaRankBtn:setAnchorPoint(CCPoint(0.5,0.5))
		arenaRankBtn:setPosition(CCPoint(760,44))
		arenaRankBtn:addChild(arenaRank)
		topPanel:addChild(arenaRankBtn)
		self.arenaRankBtn=arenaRankBtn
		self.arenaRankBtn:setIsEnabled(arena_open)
		
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))			
		closeBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		topPanel:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
		
		mainPanel:addChild(topPanel)
	end
}
--全局 时间刷新函数 变量  
Tufei_Handle = 0
wuHunInfo = {}
wuHun_equiped_list = {}


--该函数由C++点击主面板背包按钮后调用
function globleShowWuJiangListPanel()
	GlobleGeneralListPanel = new(GeneralListPanel):create()
	GotoNextStepGuide()
end
--武将主面板
function globleShowWuJiangPanel()
	GloblePanel:create(1)
	createWuJiang()
	GotoNextStepGuide()
end
--洗髓
function globleShowXiSuiPanel()
	GloblePanel:create(2)
	createXisui()
end
--训练
function globleShowXunLianPanel()
    GloblePanel:create(3)	
	createXunlian()
end

--创建武将
function createWuJiang()
	createCenterBg(1)
	local bbp = new(BaoGuoWeaponPanel)
	bbp:create()
	GloblePanel.mainWidget:addChild(bbp.bg)
	GloblePanel.bbp = bbp
	
	local hlp = new(HeroLeftPanel)
	hlp:create(true)	
	GloblePanel.mainWidget:addChild(hlp.bg)
	GloblePanel.hlp = hlp
end
--创建洗髓
function createXisui()
	createCenterBg(3)
	local xsp = new(HeroPolishPanel)
	xsp:create(GloblePlayerData.generals[GloblePanel.curGenerals])
	GloblePanel.mainWidget:addChild(xsp.bg)
	GloblePanel.xsp = xsp
	GotoNextStepGuide()
end
--训练
function createXunlian(notRefresh)
	createCenterBg(4)
	--创建训练界面
	local function createXunLian()
		local xl = new(XunLianPanel)
		xl:create()
		GloblePanel.mainWidget:addChild(xl.bg)
		GloblePanel.xlp = xl
	end
	--训练训练中界面
	local function createXunLianZhong()
		local xl = new(XunLianPanelZhong)
		xl:create()
		GloblePanel.mainWidget:addChild(xl.bg)
		GloblePanel.xlp = xl
	end
	local initData = function (s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()		
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else	
			initPlayerTrainData(s)
			if GloblePlayerData.trainings.training_list[GloblePanel.curGenerals].training_end < 1 then 
				createXunLian()
			else
				createXunLianZhong()
			end
		end
		GotoNextStepGuide()
	end
	local sendRequest = function ()
		showWaitDialogNoCircle("waiting TrainingStatus!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_TrainingStatus,initData)
		NetMgr:registOpLuaFailedCB(Net.OPT_TrainingStatus,opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(Net.OPT_TrainingStatus, cj)
	end 
	if notRefresh then		--不需要从服务端更新训练数据
		if GloblePlayerData.trainings.training_list[GloblePanel.curGenerals].training_end < 1 then 
			createXunLian()
		else
			createXunLianZhong()
		end
	else
		sendRequest()
	end
end

function createCenterBg(topid)
	local bgImg = nil
    --人物背包 用浅色背景
    if topid==nil or topid==1 or topid==3 then
      	bgImg = "UI/public/bg_light.png"
    else
      	bgImg = "UI/public/bg.png"
    end
    local bg = CCSprite:spriteWithFile(bgImg)
    bg:setPosition(CCPoint(1010/2, 702/2)) 
    GloblePanel.mainWidget:addChild(bg)
end

--[[
	主面板
	bgLayer -->> 背景层 至于场景层前层 与 UI面板层后面 所在层1000
	uiLayer -->> UI控件层 所在层2000
	centerWidget -->> 该空间为1024*768的容器 居中显示 所有需要显示的内容将添加在这上面

	topBtns -->> 顶部标签按钮 占用 1010*85的空间
	mainWidget -->> 内容容器 1010*683

	create() -->> 创建一个面板 需要参数mainPanel topid(默认按下topBtn)
	clearMainWidget() -->> 清空MainWidget 上面所有的内容
	destroy() -->>
--]]
MainPanel = {
    bgLayer = nil,
    uiLayer = nil,
    topBtns = nil,
    centerWidget = nil,
    mainWidget = nil,

    create = function(self,topid)
    	local scene = DIRECTOR:getRunningScene()
    	self.bgLayer = createPanelBg()
        self.uiLayer,self.centerWidget = createCenterWidget()

		local topbtn = new(TopButton)
		topbtn:create()
		self.top = topbtn
		self.topBtns = topbtn.toggles		
		self.centerWidget:addChild(topbtn.bg,100)
		       
		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
		
        scene:addChild(self.bgLayer, 2003)
	    scene:addChild(self.uiLayer, 2004)

		--注册开关切换事件
		for i = 1 , table.getn(topbtn.toggles) do
			topbtn.toggles[i].m_nScriptClickedHandler = function()
				if (topbtn.toggles[i]:isToggled()) then
                    self:clearMainWidget()
					if i == 1 then
						createWuJiang()
					end
					if i == 2 then
						createXisui()
					end
					if i == 3 then
						createXunlian()
					end
					if i == 4 then
						globalShowGeneralExtend()
						self:destroy()
						return
					end
				end
				topbtn:toggle(i)
			end
		end
		
		--关闭按钮
		topbtn.closeBtn.m_nScriptClickedHandler = function()		
			--executeRoleSimple()
			self:destroy()
			GloblePanel.curGenerals = GloblePlayerData.roleIndex
			if GlobleGeneralListPanel~=nil then
				GlobleGeneralListPanel:close()
				GlobleGeneralListPanel=nil
			end
			GotoNextStepGuide()
		end

		--返回人物选择界面
		topbtn.backBtn.m_nScriptClickedHandler = function()		
			self:destroy()
		end

		--设置默认按下创建时候用到的
		topbtn:toggle(topid)
    end,

	clearMainWidget = function(self)
		if Tufei_Handle ~= 0 then
            CCScheduler:sharedScheduler():unscheduleScriptEntry(Tufei_Handle)
            Tufei_Handle = 0
		end
		self.mainWidget:removeAllChildrenWithCleanup(true)
		GloblePanel.hlp = nil
        GloblePanel.xsp = nil
        GloblePanel.bbp = nil
        GloblePanel.hsr = nil
        GloblePanel.xlp = nil
	end,

    destroy = function(self)
		self:clearMainWidget()
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.top.bg:removeAllChildrenWithCleanup(true)
		
        self.bgLayer = nil
        self.uiLayer = nil
        self.topBtns = nil
        self.centerWidget = nil
        self.mainWidget = nil
        
        GloblePanel.topBtns  = nil
        GloblePanel.hlp = nil
        GloblePanel.xsp = nil
        GloblePanel.bbp = nil
        GloblePanel.hsr = nil
        GloblePanel.xlp = nil
        removeUnusedTextures()
    end
}
TopBtnConfig = {
	{
		normal = "UI/PanelTopButtons/rw_1.png",
		toggle = "UI/PanelTopButtons/rw_2.png",
		position = 	CCPoint(240 - 40, 12),
	},
	{
		normal = "UI/PanelTopButtons/xs_1.png",
		toggle = "UI/PanelTopButtons/xs_2.png",
		position = 	CCPoint(240 - 40 + 138, 12),
	},
	{
		normal = "UI/PanelTopButtons/xl_1.png",
		toggle = "UI/PanelTopButtons/xl_2.png",
		position = 	CCPoint(240 - 40 + 138 * 2, 12),
	},	
	{
		normal = "UI/PanelTopButtons/extend_1.png",
		toggle = "UI/PanelTopButtons/extend_2.png",
		position = 	CCPoint(240 - 40 + 138 * 3, 12),
	},	
}

TopButton = {
	bg = nil,
	toggles = {},
	closeBtn = nil,
	backBtn = nil,
	open_cfg = {},
	
	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 104))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(0,598))
		
		local step_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_step.json")
		local training_open = step_cfg:getByKey("training_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--训练开启
		local xisui_open = step_cfg:getByKey("xisui_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--洗髓开启
		local jicheng_open = step_cfg:getByKey("jicheng_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--宠物继承
		self.open_cfg = {
			true,
			xisui_open,
			training_open,
			jicheng_open
		}
		for i = 1 , table.getn(TopBtnConfig) do
			if self.open_cfg[i]==true then
				local normalSpr = CCSprite:spriteWithFile(TopBtnConfig[i].normal)
				local togglelSpr = CCSprite:spriteWithFile(TopBtnConfig[i].toggle)		
				local btn = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
				btn:setAnchorPoint(CCPoint(0, 0))
				btn:setPosition(TopBtnConfig[i].position)
				self.toggles[i] = btn
				self.bg:addChild(btn)
			end
		end

		--返回按钮
		local backBtn = new(ButtonScale)
		backBtn:create("UI/public/back_btn.png",1.2,ccc3(255,255,255))			
		backBtn.btn:setPosition(CCPoint(60, 44))
		backBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		self.bg:addChild(backBtn.btn)
		self.backBtn = backBtn.btn
		
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))			
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		self.bg:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
	end,
	
	--切换
	toggle = function(self,topid)
		public_toggleRadioBtn(self.toggles,self.toggles[topid])
	end
}
--人物装备面板，只显示人物头像和装备信息,可以支持左右滑动切换人物
RoleZhuangBeiPanel = {
    bg = nil,
	roleCount = 1,
	equips = {},    --保存人物身上的装备btn
    count = 0, --所有的装备数量
    page = 1,
    toggles={}, --选中装备
    create = function(self)
		self.bg = createDarkBG(435,545)
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(40, 38))
    	self.roleCount = table.getn(GloblePlayerData.generals)
    	
    	local scrollPanel = dbUIPanel:panelWithSize(CCSize(435 * self.roleCount, 545))
		scrollPanel:setAnchorPoint(CCPoint(0, 0))
		scrollPanel:setPosition(CCPoint(0, 0))
		for i=1, self.roleCount do
			local singlePanel = self:createSingleRolePanel(i)
			scrollPanel:addChild(singlePanel)
		end
		
		local scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(scrollPanel, 1, self.roleCount)
		scrollArea:setScrollRegion(CCRect(0, 0, 435, 545))
		scrollArea:setAnchorPoint(CCPoint(0, 0))
		scrollArea:setPosition(CCPoint(0, 0))
		scrollArea.pageChangedScriptHandler = function(page)
			self.page = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
		end
		self.bg:addChild(scrollArea)
		self.scrollArea = scrollArea
		self:createPageDot(self.roleCount)
		self.count = 0
		
		self.scrollArea:scrollToPage(self.page-1,false)
    end,

	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 70))
		self.form:setPosition(435/2, 0)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.bg:addChild(self.form)
		self.pageToggles = new({})
		for i=1, pageCount do
			local pageToggle = dbUIButtonToggle:buttonWithImage("UI/public/page_btn_normal.png","UI/public/page_btn_toggle.png")
			pageToggle:setPosition(CCPoint(52*(i-1),35) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
	end,
	    
    --创建单个人物界面
    createSingleRolePanel = function(self,index)
    	local role = GloblePlayerData.generals[index]
    	local panel = dbUIPanel:panelWithSize(CCSize(435, 545))
    	panel:setAnchorPoint(CCPoint(0,0))
    	panel:setPosition(CCPoint((index-1)*435,0))
    	
 		--名字
		local label = CCLabelTTF:labelWithString(role.name,CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)	
        label:setPosition(CCPoint(435/2,494))
        label:setAnchorPoint(CCPoint(0.5, 0))
        --label:setColor(ITEM_COLOR[role.quality])
		label:setColor(PLAYER_COLOR[role.quality])
		panel:addChild(label)
        
		--等级
		local label = CCLabelTTF:labelWithString(role.level.."级",CCSize(0,0),0, SYSFONT[EQUIPMENT], 24)	
		label:setPosition(CCPoint(435/2,465))
		label:setAnchorPoint(CCPoint(0.5, 0))
        label:setColor(ccc3(233,173,121))
		--label:setColor(ReColor[role.reincarnate + 1])
		panel:addChild(label)
		
  		--头像
		local figure = CCSprite:spriteWithFile("head/Big/head_big_"..role.face..".png")
		figure:setAnchorPoint(CCPoint(0.5, 0.5))
		figure:setPosition(panel:getContentSize().width/2,panel:getContentSize().height/2 )
		figure:setScale(0.8 * 173/figure:getContentSize().width)
		panel:addChild(figure)
		--装备位置框
		local equip = {}
		equip[1] = CCSprite:spriteWithFile("UI/wujiangPanel/mz.png")
		equip[2] = CCSprite:spriteWithFile("UI/wujiangPanel/yf.png")			
		equip[3] = CCSprite:spriteWithFile("UI/wujiangPanel/wq.png")			
		equip[4] = CCSprite:spriteWithFile("UI/wujiangPanel/xl.png")
		equip[5] = CCSprite:spriteWithFile("UI/wujiangPanel/jz.png")
		equip[6] = CCSprite:spriteWithFile("UI/wujiangPanel/fw.png")
		for i = 1 , 6 do
			equip[i]:setPosition(QH_ROLE_ZB_POS_CFG[i].x,QH_ROLE_ZB_POS_CFG[i].y)
			equip[i]:setAnchorPoint(CCPoint(0, 0))
			panel:addChild(equip[i],10)
		end
		
		--把人物身上的装备放上去
		self:createEquip(role,panel)
    	return panel
    end,
    
	--创建装备
    createEquip = function(self,role,panel)
    	--1武、2甲、3符文、4手套、5帽子、6戒指
    	
		--装备颜色框，如果选中者为发光的框
		local createQuality = function(item,itemBorder)
			local coloricon = dbUIButtonToggle:buttonWithImage(ITEM_QUALITY[item.quality],"UI/qiang_hua/kuang_light.png")
			coloricon:setPosition(CCPoint(itemBorder:getContentSize().width/2,itemBorder:getContentSize().height/2))
			coloricon:setAnchorPoint(CCPoint(0.5, 0.5))
			self.toggles[self.count] = coloricon
			itemBorder:addChild(coloricon)	
		end
		
		--帽子
		if role.misc ~= 0 then
			local itemInfo = findItemByItemId(role.misc)
			if itemInfo ~= 0 then
				self.count = self.count+1
				local kuang = self:createSingleItem(itemInfo,QH_ROLE_ZB_POS_CFG[1])
				panel:addChild(kuang,12)
				createQuality(itemInfo,kuang)
				
				if self.part5 == nil then self.part5 = kuang end
			end
		end

		--衣服
		if role.armor ~= 0 then
			local itemInfo = findItemByItemId(role.armor)
			if itemInfo ~= 0 then
				self.count = self.count+1
				local kuang = self:createSingleItem(itemInfo,QH_ROLE_ZB_POS_CFG[2])
				panel:addChild(kuang,12)
				createQuality(itemInfo,kuang)
				self.part2 = kuang
				
				if self.part2 == nil then self.part2 = kuang end
			end
		end
		--武器
		if role.weapon ~= 0 then
			local itemInfo = findItemByItemId(role.weapon)
			if itemInfo ~= 0 then
				self.count = self.count+1
				local kuang = self:createSingleItem(itemInfo,QH_ROLE_ZB_POS_CFG[3])
				panel:addChild(kuang,12)
				createQuality(itemInfo,kuang)

				if self.part1 == nil then self.part1 = kuang end
			end
		end				
		--手套
		if role.cloak ~= 0 then
			local itemInfo = findItemByItemId(role.cloak)
			if itemInfo ~= 0 then
				self.count = self.count+1
				local kuang = self:createSingleItem(itemInfo,QH_ROLE_ZB_POS_CFG[4])
				panel:addChild(kuang,12)
				createQuality(itemInfo,kuang)
				
				if self.part4 == nil then self.part4 = kuang end
			end
		end		
		--戒指
		if role.amulet ~= 0 then
			local itemInfo = findItemByItemId(role.amulet)
			if itemInfo ~= 0 then
				self.count = self.count+1
				local kuang = self:createSingleItem(itemInfo,QH_ROLE_ZB_POS_CFG[5])
				panel:addChild(kuang,12)
				createQuality(itemInfo,kuang)
				
				if self.part6 == nil then self.part6 = kuang end
			end
		end
		--符文
		if role.horse ~= 0 then
			local itemInfo = findItemByItemId(role.horse)
			if itemInfo ~= 0 then
				self.count = self.count+1
				local kuang = self:createSingleItem(itemInfo,QH_ROLE_ZB_POS_CFG[6])
				panel:addChild(kuang,12)
				createQuality(itemInfo,kuang)
				
				if self.part3 == nil then self.part3 = kuang end
			end
		end
    end,
    
    createSingleItem = function(self,itemInfo,position)
    	local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
		kuang:setAnchorPoint(CCPoint(0, 0))
		kuang:setPosition(CCPoint(position.x,position.y))
		
    	local btn = dbUIButton:buttonWithImage("icon/Item/icon_item_"..itemInfo.icon..".png")
		btn:setPosition(CCPoint(48,48))
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setScale(0.8 * 96/btn:getContentSize().width)
		kuang:addChild(btn)
		
		self.equips[self.count] = {btn=btn,item=itemInfo}
		return kuang
    end
}

--装备图标的位置
QH_ROLE_ZB_POS_CFG = { 
	{x=15,y=425},
	{x=15,y=425-172},
	{x=15,y=425-172*2},
	{x=323,y=425},
	{x=323,y=425-172},
	{x=323,y=425-172*2},
}
--显示角色信息
function createViewTargetPanel(targetId,name)
	local function opCreateViewFinishCB(s)
		WaitDialog.closePanelFunc()
		if s:getByKey("error_code"):asInt() == -1 then
			if not GlobleRoleInfoPanel then
				GlobleRoleInfoPanel = new(RoleInfoPanel)
			end
			if GlobleRoleInfoPanel.centerWidget then
				GlobleRoleInfoPanel.centerWidget:removeAllChildrenWithCleanup(true)
			end
			GlobleRoleInfoPanel:create(s,name,targetId)
		else
			new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
		end
	end

	local function execCreateView()
		showWaitDialogNoCircle("waiting view data!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_ViewTargetSimple, opCreateViewFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_ViewTargetSimple, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code",ClientData.request_code)
		cj:setByKey("target_id",targetId)
		NetMgr:executeOperate(Net.OPT_ViewTargetSimple, cj)
	end
	execCreateView()
end

RoleInfoPanel = {
	pageCount = 1,
	curPage = 1, --当前页
	nation = nil,
	name = nil,
	roleId = nil,

	create = function (self,data,name,targetId)
		self.name = name
		self.roleId = targetId
		self:initData(data)

		self:initBase()
		self:createTop()
		self:createLeft()
		self:createRight()
	end,

	initData = function(self,data)
		self.officium = data:getByKey("officium"):asInt()
		self.fight_power = data:getByKey("fight_power"):asInt()

		self.wujiangIsRole = new({})
		self.wujiangGeneralId = new({})
		self.wujiangJob = new({})
		self.wujiangLevel = new({})
		self.wujiface = new({})
		self.wujiSkills = new({})

		self.tousi = new({})
		self.tousiHole1 = new({})
		self.tousiHole2 = new({})
		self.tousiHole3 = new({})
		self.tousiHole4 = new({})
		self.tousiHole5 = new({})
		self.tousiHole6 = new({})		
		self.tousiLevel = new({})

		self.pifeng = new({})
		self.pifengHole1 = new({})
		self.pifengHole2 = new({})
		self.pifengHole3 = new({})
		self.pifengHole4 = new({})
		self.pifengHole5 = new({})
		self.pifengHole6 = new({})		
		self.pifengLevel = new({})

		self.yifu = new({})
		self.yifuHole1 = new({})
		self.yifuHole2 = new({})
		self.yifuHole3 = new({})
		self.yifuHole4 = new({})
		self.yifuHole5 = new({})
		self.yifuHole6 = new({})		
		self.yifuLevel = new({})

		self.zuoqi = new({})
		self.zuoqiHole1 = new({})
		self.zuoqiHole2 = new({})
		self.zuoqiHole3 = new({})
		self.zuoqiHole4 = new({})
		self.zuoqiHole5 = new({})
		self.zuoqiHole6 = new({})		
		self.zuoqiLevel = new({})

		self.wuqi = new({})
		self.wuqiHole1 = new({})
		self.wuqiHole2 = new({})
		self.wuqiHole3 = new({})
		self.wuqiHole4 = new({})
		self.wuqiHole5 = new({})
		self.wuqiHole6 = new({})		
		self.wuqiLevel = new({})

		self.bingfu = new({})
		self.bingfuHole1 = new({})
		self.bingfuHole2 = new({})
		self.bingfuHole3 = new({})
		self.bingfuHole4 = new({})
		self.bingfuHole5 = new({})
		self.bingfuHole6 = new({})		
		self.bingfuLevel = new({})

		self.wujiName = new({})
		self.wujiQuality = new({})
		self.wujiType = new({})
		self.wujiPro = new({})
		
		self.strength = new({})
		self.intellect = ({})
		self.stamina = ({})
		self.agility = ({})
		self.physic_attack = ({})
		self.physic_defen = ({})
		self.spell_attack = ({})
		self.spell_defen = ({})
			
		self.speed = new({})
		self.critic = new({})
		self.tough = new({})
		self.hit = new({})
		self.dodge = new({})
		self.unblock = new({})
		self.block = new({})
		
		self.healthPoint = new({})

		local da = data:getByKey("generals")
		self.pageCount = da:size()
		
		for i = 1,da:size() do
			local daIndex = da:getByIndex(i-1)
			self.wujiangIsRole[i] = daIndex:getByKey("is_role"):asInt()
			self.wujiangGeneralId[i] = daIndex:getByKey("cfg_general_id"):asInt()
			
			self.wujiangJob[i] = daIndex:getByKey("job"):asInt()
			self.wujiangLevel[i] = daIndex:getByKey("level"):asInt()
			self.wujiface[i] =	daIndex:getByKey("face"):asInt()

			self.tousi[i] = daIndex:getByKey("misc"):asInt()
			self.tousiHole1[i] = daIndex:getByKey("misc_hole1"):asInt()
			self.tousiHole2[i] = daIndex:getByKey("misc_hole2"):asInt()
			self.tousiHole3[i] = daIndex:getByKey("misc_hole3"):asInt()
			self.tousiHole4[i] = daIndex:getByKey("misc_hole4"):asInt()
			self.tousiHole5[i] = daIndex:getByKey("misc_hole5"):asInt()
			self.tousiHole6[i] = daIndex:getByKey("misc_hole6"):asInt()			
			self.tousiLevel[i] = daIndex:getByKey("misc_level"):asInt()

			self.pifeng[i] = daIndex:getByKey("cloak"):asInt()
			self.pifengHole1[i] = daIndex:getByKey("cloak_hole1"):asInt()
			self.pifengHole2[i] = daIndex:getByKey("cloak_hole2"):asInt()
			self.pifengHole3[i] = daIndex:getByKey("cloak_hole3"):asInt()
			self.pifengHole4[i] = daIndex:getByKey("cloak_hole4"):asInt()
			self.pifengHole5[i] = daIndex:getByKey("cloak_hole5"):asInt()
			self.pifengHole6[i] = daIndex:getByKey("cloak_hole6"):asInt()			
			self.pifengLevel[i] = daIndex:getByKey("cloak_level"):asInt()

			self.yifu[i] = daIndex:getByKey("armor"):asInt()
			self.yifuHole1[i] = daIndex:getByKey("armor_hole1"):asInt()
			self.yifuHole2[i] = daIndex:getByKey("armor_hole2"):asInt()
			self.yifuHole3[i] = daIndex:getByKey("armor_hole3"):asInt()
			self.yifuHole4[i] = daIndex:getByKey("armor_hole4"):asInt()
			self.yifuHole5[i] = daIndex:getByKey("armor_hole5"):asInt()
			self.yifuHole6[i] = daIndex:getByKey("armor_hole6"):asInt()			
			self.yifuLevel[i] = daIndex:getByKey("armor_level"):asInt()

			self.zuoqi[i] = daIndex:getByKey("horse"):asInt()
			self.zuoqiHole1[i] = daIndex:getByKey("horse_hole1"):asInt()
			self.zuoqiHole2[i] = daIndex:getByKey("horse_hole2"):asInt()
			self.zuoqiHole3[i] = daIndex:getByKey("horse_hole3"):asInt()
			self.zuoqiHole4[i] = daIndex:getByKey("horse_hole4"):asInt()
			self.zuoqiHole5[i] = daIndex:getByKey("horse_hole5"):asInt()
			self.zuoqiHole6[i] = daIndex:getByKey("horse_hole6"):asInt()			
			self.zuoqiLevel[i] = daIndex:getByKey("horse_level"):asInt()


			self.wuqi[i] = daIndex:getByKey("weapon"):asInt()
			self.wuqiHole1[i] = daIndex:getByKey("weapon_hole1"):asInt()
			self.wuqiHole2[i] = daIndex:getByKey("weapon_hole2"):asInt()
			self.wuqiHole3[i] = daIndex:getByKey("weapon_hole3"):asInt()
			self.wuqiHole4[i] = daIndex:getByKey("weapon_hole4"):asInt()
			self.wuqiHole5[i] = daIndex:getByKey("weapon_hole5"):asInt()
			self.wuqiHole6[i] = daIndex:getByKey("weapon_hole6"):asInt()			
			self.wuqiLevel[i] = daIndex:getByKey("weapon_level"):asInt()

			self.bingfu[i] = daIndex:getByKey("amulet"):asInt()
			self.bingfuHole1[i] = daIndex:getByKey("amulet_hole1"):asInt()
			self.bingfuHole2[i] = daIndex:getByKey("amulet_hole2"):asInt()
			self.bingfuHole3[i] = daIndex:getByKey("amulet_hole3"):asInt()
			self.bingfuHole4[i] = daIndex:getByKey("amulet_hole4"):asInt()
			self.bingfuHole5[i] = daIndex:getByKey("amulet_hole5"):asInt()
			self.bingfuHole6[i] = daIndex:getByKey("amulet_hole6"):asInt()			
			self.bingfuLevel[i] = daIndex:getByKey("amulet_level"):asInt()

			self.wujiName[i] = daIndex:getByKey("name"):asString()
            self.wujiQuality[i]= daIndex:getByKey("quality"):asInt()
            
			local job = daIndex:getByKey("job"):asInt()
			local jobJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_job.json")
			self.wujiType[i] = jobJsonConfig:getByKey(job):getByKey("name"):asString()
			self.wujiPro[i] = jobJsonConfig:getByKey(job):getByKey("attack_desc"):asString()
		
			self.strength[i] = daIndex:getByKey("strength"):asInt()
			self.intellect[i] = daIndex:getByKey("intellect"):asInt()
			self.stamina[i] = daIndex:getByKey("stamina"):asInt()
			self.agility[i] = daIndex:getByKey("agility"):asInt()
			self.physic_attack[i] = daIndex:getByKey("physical_attack"):asInt()
			self.physic_defen[i] = daIndex:getByKey("physical_defence"):asInt()
			self.spell_attack[i] = daIndex:getByKey("spell_attack"):asInt()
			self.spell_defen[i] = daIndex:getByKey("spell_defence"):asInt()
			
			self.speed[i] = daIndex:getByKey("speed"):asInt()		--速度
			self.critic[i] = daIndex:getByKey("critic"):asInt()		--暴击
			self.tough[i] = daIndex:getByKey("tough"):asInt()		--韧性
			self.hit[i] = daIndex:getByKey("hit"):asInt()			--命中
			self.dodge[i] = daIndex:getByKey("dodge"):asInt()		--闪避
			self.unblock[i] = daIndex:getByKey("unblock"):asInt()	--破击
			self.block[i] = daIndex:getByKey("block"):asInt()		--闪避
			
			self.healthPoint[i] = daIndex:getByKey("healthPoint"):asInt()
			
			local skills = new({})
			local skillList = daIndex:getByKey("skill_list")
			for i = 0, skillList:size() - 1 do
				table.insert(skills,{
					cfg_skill_id = skillList:getByIndex(i):asInt()
				})
			end
			
			self.wujiSkills[i] = skills
		end
	end,

	createLeft = function(self)
		self.left = createDarkBG(463,545)
		self.left:setPosition(CCPoint(38, 38))
		self.mainWidget:addChild(self.left)

		local container = dbUIPanel:panelWithSize(CCSize(463 * self.pageCount,500))
		container:setAnchorPoint(CCPoint(0, 0))
		container:setPosition(0,0)

		for i=1,self.pageCount do
			local singlePage = dbUIPanel:panelWithSize(CCSize(463,500))
			singlePage:setAnchorPoint(CCPoint(0, 0))
			singlePage:setPosition((i-1)*463,0)
			self:loadPage(i,singlePage)
			container:addChild(singlePage)
		end

		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(container, 1, self.pageCount)
		self.scrollArea:setAnchorPoint(CCPoint(0, 0))
		self.scrollArea:setScrollRegion(CCRect(0, 0, 463, 500))
		self.scrollArea:setPosition(0,43)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.curPage = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])

			self.wujiTypeLabel:setString(self.wujiType[self.curPage])
			self.wujiProLabel:setString(self.wujiPro[self.curPage])
		end
		self.left:addChild(self.scrollArea)

		self:createPageDot(self.pageCount)
		self.scrollArea:scrollToPage(self.curPage-1,false)
	end,

	loadPage = function(self,page,panel)
		local label = CCLabelTTF:labelWithString(self.wujiName[page],CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)
		label:setPosition(CCPoint(435/2,453))
		label:setAnchorPoint(CCPoint(0.5, 0))
		label:setColor(ITEM_COLOR[self.wujiQuality[page]])
		panel:addChild(label)

		--等级
		local label = CCLabelTTF:labelWithString(self.wujiangLevel[page].."级",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(435/2,420))
		label:setColor(ccc3(248,100,0))
		panel:addChild(label)

		--技能
		if #self.wujiSkills[page] > 0 then
			local skillBtn = dbUIButtonScale:buttonWithImage("UI/wujiangPanel/skill.png", 1.0, ccc3(125, 125, 125))
			skillBtn:setAnchorPoint(CCPoint(0, 1))
			skillBtn:setPosition(CCPoint(270,410))
			skillBtn.m_nScriptClickedHandler = function(ccp)
				local cfg = {
					skills = self.wujiSkills[page],
					pos = ccp,
				}
				new(SkillDialog):create(cfg)
			end
			panel:addChild(skillBtn)
		end

		local jobJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_job.json")
		local generalJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_general.json")
		local data = nil
		if self.wujiangIsRole[page] == 1 then
			data = jobJsonConfig:getByKey(self.wujiangJob[page])
		else
			data = generalJsonConfig:getByKey(self.wujiangGeneralId[page])
		end
		
		local createAttrLabel = function(label, value, grow, position)
			local labelBg = CCSprite:spriteWithFile("UI/wujiangPanel/label_bg.png")
			labelBg:setPosition(position)
			labelBg:setAnchorPoint(CCPoint(0,0))
			panel:addChild(labelBg)
			local value_label = CCLabelTTF:labelWithString(label..(value or ""),CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
			value_label:setAnchorPoint(CCPoint(0, 0.5))
			value_label:setPosition(CCPoint(12, 13))
			value_label:setColor(ccc3(255,204,154))
			labelBg:addChild(value_label)
			if grow then
				local grow_label = CCLabelTTF:labelWithString("("..grow..")",CCSize(200,0), 0, SYSFONT[EQUIPMENT], 22)
				grow_label:setAnchorPoint(CCPoint(0, 0.5))
				grow_label:setPosition(CCPoint(135, 13))
				grow_label:setColor(ccc3(153,205,0))
				labelBg:addChild(grow_label) 
			end
		end
		local sta_grow = data:getByKey("sta_grow"):asDouble()
		createAttrLabel("耐力：", self.stamina[page], sta_grow,CCPoint(20, 109))
		createAttrLabel("职业：", self.wujiType[page], nil, CCPoint(220 + 20, 109))
		local str_grow = data:getByKey("str_grow"):asDouble()
		createAttrLabel("力量：", self.strength[page], str_grow, CCPoint(20, 109 - 33))
		createAttrLabel("生命：", self.healthPoint[page], nil, CCPoint(220 + 20, 109 - 33))
		local int_grow = data:getByKey("int_grow"):asDouble()
		createAttrLabel("智力：", self.intellect[page], int_grow, CCPoint(20, 109 - 33 * 2))
		createAttrLabel("速度：", self.speed[page], nil, CCPoint(220 + 20, 109 - 33 * 2))
		local agi_grow = data:getByKey("agi_grow"):asDouble()
		createAttrLabel("敏捷：",self.agility[page], agi_grow, CCPoint(20, 109 - 33 * 3))
		createAttrLabel("查看详细信息", nil, nil, CCPoint(220 + 20, 109 - 33 *3))
	
		--区域点击显示详细信息
		local area = dbUIPanel:panelWithSize(CCSize(430, 132))
		area:setAnchorPoint(CCPoint(0, 0))
		area:setPosition(CCPoint(20, 109 - 33 * 3))
		area.m_nScriptClickedHandler = function()
			local general = {
				name = self.wujiName[page],
				level = self.wujiangLevel[page],
				quality = self.wujiQuality[page],
				job = self.wujiangJob[page],
				physical_attack = self.physic_attack[page],
				spell_attack = self.spell_attack[page],
				physical_defence = self.physic_defen[page],
				spell_defence = self.spell_defen[page],
				critic = self.critic[page],
				tough = self.tough[page],
				hit = self.hit[page],
				dodge = self.dodge[page],
				unblock = self.unblock[page],
				block = self.block[page],
				skills = self.wujiSkills[page],
			}
			new(GeneralInfoDialog):create(general)
		end
		panel:addChild(area)	
		
		--头像
		local showSpr = CCSprite:spriteWithFile("head/Big/head_big_"..self.wujiface[page]..".png")
		showSpr:setAnchorPoint(CCPoint(0.5,0.5))
		showSpr:setPosition(panel:getContentSize().width/2,panel:getContentSize().height/2+50)
		showSpr:setScale(0.8 * 173/showSpr:getContentSize().width)
		panel:addChild(showSpr)

		local pos = {
			{x=20,y=150},
			{x=20,y=150+107*1},
			{x=20,y=150+107*2},
			{x=327,y=150},
			{x=327,y=150+107*1},
			{x=327,y=150+107*2},
		}
		local equip = {}
		local itemPanels = {}
		equip[1] = CCSprite:spriteWithFile("UI/wujiangPanel/wq.png")
		equip[2] = CCSprite:spriteWithFile("UI/wujiangPanel/yf.png")
		equip[3] = CCSprite:spriteWithFile("UI/wujiangPanel/mz.png")
		equip[4] = CCSprite:spriteWithFile("UI/wujiangPanel/fw.png")
		equip[5] = CCSprite:spriteWithFile("UI/wujiangPanel/jz.png")
		equip[6] = CCSprite:spriteWithFile("UI/wujiangPanel/xl.png")
		for i = 1, 6 do
			local itemPanel = dbUIPanel:panelWithSize(CCSize(96,96))
			itemPanel:setPosition(pos[i].x,pos[i].y)
			itemPanel:setAnchorPoint(CCPoint(0, 0))
			panel:addChild(itemPanel)
			itemPanels[i] = itemPanel

			equip[i]:setPosition(48,48)
			equip[i]:setAnchorPoint(CCPoint(0.5, 0.5))
			itemPanel:addChild(equip[i])
		end

		self.equipImage = new({})
		for i = 1,6 do
			local item_info = nil
			local typeIdx = 1
			if i == 1 and self.tousi[page] ~= 0 then
				item_info =
				{
					cfg_item_id = self.tousi[page],
					hole1 = self.tousiHole1[page],
					hole2 = self.tousiHole2[page],
					hole3 = self.tousiHole3[page],
					hole4 = self.tousiHole4[page],
					hole5 = self.tousiHole5[page],
					hole6 = self.tousiHole6[page],					
					amount = 1,
					star = self.tousiLevel[page],--等级
					item_id = 0,
					equiped = false
				}
				typeIdx = 3
			elseif i == 2 and self.pifeng[page] ~= 0 then
				item_info =
				{
					cfg_item_id = self.pifeng[page],
					hole1 = self.pifengHole1[page],
					hole2 = self.pifengHole2[page],
					hole3 = self.pifengHole3[page],
					hole4 = self.pifengHole4[page],
					hole5 = self.pifengHole5[page],
					hole6 = self.pifengHole6[page],					
					amount = 1,
					star = self.pifengLevel[page],--等级
					item_id = 0,
					equiped = false
				}
				typeIdx = 6
			elseif i == 3 and self.yifu[page] ~= 0 then
				item_info =
				{
					cfg_item_id = self.yifu[page],
					hole1 = self.yifuHole1[page],
					hole2 = self.yifuHole2[page],
					hole3 = self.yifuHole3[page],
					hole4 = self.yifuHole4[page],
					hole5 = self.yifuHole5[page],
					hole6 = self.yifuHole6[page],					
					amount = 1,
					star = self.yifuLevel[page],--等级
					item_id = 0,
					equiped = false
				}
				typeIdx = 2
			elseif i == 4 and self.zuoqi[page] ~= 0 then
				item_info =
				{
					cfg_item_id = self.zuoqi[page],
					hole1 = self.zuoqiHole1[page],
					hole2 = self.zuoqiHole2[page],
					hole3 = self.zuoqiHole3[page],
					hole4 = self.zuoqiHole4[page],
					hole5 = self.zuoqiHole5[page],
					hole6 = self.zuoqiHole6[page],					
					amount = 1,
					star = self.zuoqiLevel[page],--等级
					item_id = 0,
					equiped = false
				}
				typeIdx = 4
			elseif i == 5 and self.wuqi[page] ~= 0 then
				item_info =
				{
					cfg_item_id = self.wuqi[page],
					hole1 = self.wuqiHole1[page],
					hole2 = self.wuqiHole2[page],
					hole3 = self.wuqiHole3[page],
					hole4 = self.wuqiHole4[page],
					hole5 = self.wuqiHole5[page],
					hole6 = self.wuqiHole6[page],					
					amount = 1,
					star = self.wuqiLevel[page],--等级
					item_id = 0,
					equiped = false
				}
				typeIdx = 1
			elseif i == 6 and self.bingfu[page] ~= 0 then
				item_info =
				{
					cfg_item_id = self.bingfu[page],
					hole1 = self.bingfuHole1[page],
					hole2 = self.bingfuHole2[page],
					hole3 = self.bingfuHole3[page],
					hole4 = self.bingfuHole4[page],
					hole5 = self.bingfuHole5[page],
					hole6 = self.bingfuHole6[page],					
					amount = 1,
					star = self.bingfuLevel[page],--等级
					item_id = 0,
					equiped = false
				}
				typeIdx = 5
			end

			if item_info ~= nil then
				local item_entity = mappedItemSingle(item_info)
				local item = new(BaoGuo_BackpackSingleItem)
				local cfg = {
					item = item_entity,
					from  = "hero_equip",
					mine  = false,
				}
				item:create(item_entity,cfg)

				self.equipImage[i] = item.itemBorder
				self.equipImage[i]:setPosition(CCPoint(48,48))
				self.equipImage[i]:setAnchorPoint(CCPoint(0.5,0.5))
				itemPanels[typeIdx]:addChild(self.equipImage[i])
			end
		end
	end,

	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 44))
		self.form:setPosition(463/2, 0)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.left:addChild(self.form)
		self.pageToggles = {}
		for i=1, pageCount do
			local pageToggle = dbUIButtonToggle:buttonWithImage("UI/public/page_btn_normal.png","UI/public/page_btn_toggle.png")
			pageToggle:setPosition(CCPoint(52*(i-1),20) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[1])
	end,

	createRight = function(self)
		self.right = createDarkBG(453,545)
		self.right:setPosition(CCPoint(513, 38))
		self.mainWidget:addChild(self.right)

		local label = CCLabelTTF:labelWithString(self.name, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5, 0))
		label:setPosition(CCPoint(453/2 , 500))
		label:setColor(ccc3(151,202,0))
		self.right:addChild(label)

		local label = CCLabelTTF:labelWithString("神位:",CCSize(150,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(30 , 400))
		label:setColor(ccc3(255,204,2))
		self.right:addChild(label)
		local label = CCLabelTTF:labelWithString(self.officium.."级",CCSize(150,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(120 , 400))
		label:setColor(ccc3(254,204,153))
		self.right:addChild(label)

		local label = CCLabelTTF:labelWithString("总战力:",CCSize(150,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(200 , 400))
		label:setColor(ccc3(255,204,2))
		self.right:addChild(label)
		local label = CCLabelTTF:labelWithString(self.fight_power,CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(320 , 400))
		label:setColor(ccc3(254,204,153))
		self.right:addChild(label)
		
		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(453/28)
		line:setPosition(0, 372)
		self.right:addChild(line)

		local btn = dbUIButtonScale:buttonWithImage("UI/friend/friend_fight2.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(453/2,283))
		btn.m_nScriptClickedHandler = function(ccp)
			self:toFight()
		end
		self.right:addChild(btn)
	end,

	toAdd = function(self)
		local function opAddFriendFinishCB(s)
			WaitDialog.closePanelFunc()
			if s:getByKey("error_code"):asInt() == -1 then
				new(SimpleTipPanel):create(ADD_FRIEND_SUCCESS,ccc3(255,0,0),0)
			else
				local eId = s:getByKey("error_code"):asInt()
				new(SimpleTipPanel):create(ERROR_CODE_DESC[eId],ccc3(255,0,0),0)
			end
		end

		local function opAddFriendFailedCB(s)
			WaitDialog.closePanelFunc()
		end

		local function execAddFriend()
			showWaitDialogNoCircle("waiting add data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FriendAction, opAddFriendFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FriendAction, opAddFriendFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("target_id",self.roleId) --friend_id
			cj:setByKey("action",1)   --1增加好友，2删除好友
			NetMgr:executeOperate(Net.OPT_FriendAction, cj)
		end
		execAddFriend()
	end,

	toFight = function(self)
		executeBattle(self.roleId, 1)
		--self:destroy()
	end,

	toChat = function(self)
		GolbalCreatePrivateMsg(self.roleId,self.name,false)
		self:destroy()
	end,

	createTop =function(self)
		local top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)
		self.top = top

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.top:addChild(closeBtn.btn)

		-- 职业
		self.wujiTypeLabel = CCLabelTTF:labelWithString(self.wujiType[self.curPage],CCSize(200,0),0, SYSFONT[EQUIPMENT], 32)
		self.wujiTypeLabel:setPosition(CCPoint(30,22))
		self.wujiTypeLabel:setAnchorPoint(CCPoint(0, 0))
		self.wujiTypeLabel:setColor(ccc3(81,31,8))
		self.top:addChild(self.wujiTypeLabel)
		self.wujiProLabel = CCLabelTTF:labelWithString(self.wujiPro[self.curPage],CCSize(600,0),0, SYSFONT[EQUIPMENT], 28)
		self.wujiProLabel:setPosition(CCPoint(120+20,24))
		self.wujiProLabel:setAnchorPoint(CCPoint(0,0))
		self.wujiProLabel:setColor(ccc3(81,31,8))
		self.top:addChild(self.wujiProLabel)
	end,

	--初始化界面，包括头部，背景
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1004)
		scene:addChild(self.uiLayer, 2004)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
		removeUnusedTextures()
	end
}
HeroLeftPanel = {
	bg = nil,
	generalPanel = nil,
	page  =  1,
	
	create = function(self,isEquip)
		self.general = GloblePlayerData.generals[GloblePanel.curGenerals]
		self.pageCount = #GloblePlayerData.generals
		self.page = GloblePanel.curGenerals
		
		self.bg = createDarkBG(435,545)
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(40, 38))
		
		local pagePanelContainer = dbUIPanel:panelWithSize(CCSize(435 * self.pageCount,545))
		pagePanelContainer:setAnchorPoint(CCPoint(0, 0))
		pagePanelContainer:setPosition(0,0)
		
		self.pagePanels = new({})
		for i=1,self.pageCount do
			local generalPanel = new(SingleBasicProPanel)
			generalPanel:create(GloblePlayerData.generals[i],isEquip)
			generalPanel.panel:setAnchorPoint(CCPoint(0, 0))
			generalPanel.panel:setPosition(1 + 435 * (i - 1), 0)
			pagePanelContainer:addChild(generalPanel.panel)
		end
		
		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pagePanelContainer, 1, self.pageCount)
        self.scrollArea:setAnchorPoint(CCPoint(0, 0))
        self.scrollArea:setScrollRegion(CCRect(0, 0, 435, 545))
        self.scrollArea:setPosition(0,0)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.page = page + 1
			GloblePanel.curGenerals = self.page
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
		end
		self.bg:addChild(self.scrollArea)
		self:createPageDot(self.pageCount)
		self.scrollArea:scrollToPage(self.page-1,false)
	end,
	
	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 60))
		self.form:setPosition(217, 0)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.bg:addChild(self.form)
		self.pageToggles = {}
		for i=1, pageCount do
			local normalSpr = CCSprite:spriteWithFile("UI/public/page_btn_normal.png")
			local togglelSpr = CCSprite:spriteWithFile("UI/public/page_btn_toggle.png")		
			local pageToggle = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
			pageToggle:setPosition(CCPoint(52*(i-1),25) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
	end,	
}

---人物属性弹窗
GeneralInfoDialog = {
	create = function(self,general)
		self:initBase()
		local width,height = 370,0
		
		local panel = dbUIPanel:panelWithSize(CCSize(width,height)) --容器panel
		self.layer:addChild(panel)
		
		--创建下划线
		local createLine = function(position)
			local line = CCSprite:spriteWithFile("UI/baoguoPanel/line.png")
			line:setAnchorPoint(CCPoint(0.5,0))
			line:setPosition(position)
			line:setScaleX((width-20)/line:getContentSize().width)
			panel:addChild(line)
		end
		--创建属性
		local createAttr = function(text,position)
			local label = CCLabelTTF:labelWithString(text,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
			label:setPosition(position)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setColor(ccc3(255,204,154))
			panel:addChild(label)
		end
		--创建技能
		local createSkill = function(skill,position)
			local skill_json_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_skill.json")
			local skill_name = skill_json_cfg:getByKey(skill.cfg_skill_id):getByKey("name"):asString()
			local skill_desc = skill_json_cfg:getByKey(skill.cfg_skill_id):getByKey("desc"):asString()
			
			local skillPanel = dbUIPanel:panelWithSize(CCSize(width,0))
			skillPanel:setPosition(position)
			skillPanel:setAnchorPoint(CCPoint(0, 0))
			panel:addChild(skillPanel)
			local height = 0
			--倒序排，计算高度
			--技能描述
			local desc = CCLabelTTF:labelWithString(skill_desc,CCSize(width - 40,0),0, SYSFONT[EQUIPMENT], 20)
			desc:setPosition(CCPoint(30,0))
			desc:setAnchorPoint(CCPoint(0,0))
			desc:setColor(ccc3(255,204,154))
			skillPanel:addChild(desc)	
			height = height + desc:getContentSize().height
			--技能名称
			local name = CCLabelTTF:labelWithString(skill_name,CCSize(width - 40,0),0, SYSFONT[EQUIPMENT], 22)
			name:setAnchorPoint(CCPoint(0, 0))
			name:setPosition(CCPoint(30,height + 5))
			name:setColor(ccc3(255,204,154))
			skillPanel:addChild(name)
			height = height + name:getContentSize().height + 5
			return height
		end
		
		--倒序排版，计算高度
		--确定
		local btn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(width/2,20))
		btn:setAnchorPoint(CCPoint(0.5, 0))
		btn.m_nScriptClickedHandler = function()
			self:closePanel()
		end
		panel:addChild(btn)
		height = height + btn:getContentSize().height + 40

		--技能
		local skillCount = #general.skills
		for i = 1, skillCount do
			local skillHeight = createSkill(general.skills[i],CCPoint(0,height))
			height = height + skillHeight + 10
		end
		
		createLine(CCPoint(width/2,height))
		height = height + 20
		if general.job < 3 then		--战士和刺客，物攻
			createAttr("物攻："..general.physical_attack,CCPoint(30, height + 30 * 8))
		else						--法师和巫师，法攻
			createAttr("法攻："..general.spell_attack,CCPoint(30, height + 30 * 8))
		end
		createAttr("物防："..general.physical_defence,CCPoint(30, height + 30 * 7))
		createAttr("法防："..general.spell_defence,CCPoint(30, height + 30 * 6))	
		createAttr("命中："..general.hit,CCPoint(30, height + 30 * 5))
		createAttr("闪避："..general.dodge,CCPoint(30, height + 30 * 4))	
		createAttr("破击："..general.unblock,CCPoint(30, height + 30 * 3))
		createAttr("格挡："..general.block,CCPoint(30, height + 30 * 2))
		createAttr("暴击："..general.critic,CCPoint(30, height + 30))
		createAttr("韧性："..general.tough,CCPoint(30, height))		
		
		createLine(CCPoint(width/2,height + 30 * 9))
		height = height + 30 * 9
		
		--名字
		local label = CCLabelTTF:labelWithString(general.name,CCSize(0,0),0, SYSFONT[EQUIPMENT], 30)
		label:setPosition(CCPoint(370/2 - 50,height + 20))
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setColor(ITEM_COLOR[general.quality])
		panel:addChild(label)
		--等级
		local label = CCLabelTTF:labelWithString(general.level.."级",CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(370/2 + 70,height + 20))
		label:setColor(ccc3(248,100,0))
		panel:addChild(label)
		height = height + label:getContentSize().height + 40
		
		--背景
		local bg = createBG("UI/baoguoPanel/kuang.png",width,height,CCSizeMake(30,30))
		bg:setPosition(CCPoint(0,0))
		panel:addChild(bg,-1)
		
		local scale = 0.90 * WINSIZE.height / height
		panel:setAnchorPoint(CCPoint(0.5,0.5))
		panel:setScale(scale)
		panel:setPosition(CCPoint(WINSIZE.width / 2 + (370 /2 - 20) * scale, WINSIZE.height / 2 ))
		panel:setContentSize(CCSize(370, height))
	end,

	initBase = function(self,cfg)
		local scene = DIRECTOR:getRunningScene()
		self.layer = dbUILayer:node()
		scene:addChild(self.layer, 10000)

		local parent = dbUIPanel:panelWithSize(CCSize(WINSIZE.width,WINSIZE.height))
		parent:setAnchorPoint(CCPoint(0.5, 0.5))
		parent:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
		parent.m_nScriptClickedHandler = function()
			self:closePanel()
		end
		self.layer:addChild(parent)
	end,

	closePanel = function(self)
		self.layer:removeFromParentAndCleanup(true)
	end,
}

SingleBasicProPanel = {
	panel = nil,
	create = function (self,general,isEquip)
		self.panel = dbUIPanel:panelWithSize(CCSize(435, 545))
		self.panel:setAnchorPoint(CCPoint(0, 0))
		self.panel:setPosition(0, 0)

		local roleShow
		if isEquip then
			roleShow = new(SingleEquipPanel)
		else
			roleShow = new(SingleRoleShowPanel)
		end
		roleShow:create(general)
		self.panel:addChild(roleShow.bg)

		--名字
		local label = CCLabelTTF:labelWithString(general.name,CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)
		label:setPosition(CCPoint(435/2,508))
		label:setColor(ITEM_COLOR[general.quality])
		self.panel:addChild(label)

		--等级
		local label = CCLabelTTF:labelWithString(general.level.."级",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(435/2,468))
		label:setColor(ccc3(248,100,0))
		--label:setColor(ReColor[general.reincarnate + 1])
		self.panel:addChild(label)
		
		--技能
		if #general.skills > 0 then
			local skillBtn = dbUIButtonScale:buttonWithImage("UI/wujiangPanel/skill.png", 1.0, ccc3(125, 125, 125))
			skillBtn:setAnchorPoint(CCPoint(0, 0))
			skillBtn:setPosition(CCPoint(270,420))
			skillBtn.m_nScriptClickedHandler = function(ccp)
				local cfg = {
					skills = general.skills,
					pos = ccp,
				}
				new(SkillDialog):create(cfg)
			end
			self.panel:addChild(skillBtn)
		end
		
		--放生
		local fireBtn = dbUIButtonScale:buttonWithImage("UI/wujiangPanel/fire.png",1.0,ccc3(255,0,0))
		fireBtn:setPosition(CCPoint(435/2, 190))
		fireBtn:setAnchorPoint(CCPoint(0.5,0))
		fireBtn.m_nScriptClickedHandler = function(ccp)
			local fire = function(ccp,general)
				local fm = {
					id = GloblePlayerData.cur_formation
				}
				Formation(fm,4,general.general_id,true)
			end
			local createBtn = function(general)
				local btns = {}
				if general.is_role then
					local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
					btns[1] = btn
					btns[1].action = nothing
				else
					local btn = dbUIButtonScale:buttonWithImage("UI/wujiangPanel/fire.png", 1, ccc3(125, 125, 125))
					btns[1] = btn
					btns[1].action = fire
					btns[1].param = general
				end
				return btns
			end

			local dialogCfg = new(basicDialogCfg)
			dialogCfg.msg = general.is_role and "主角无法被放生！" or "如果宠物不是神宠放生后将无法被召回，神宠可以在神宠图鉴中召回。"
			dialogCfg.btns = createBtn(general)
			new(Dialog):create(dialogCfg)
		end
		self.panel:addChild(fireBtn)
		
		local jobJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_job.json")
		local generalJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_general.json")
		local data = nil
		if general.is_role then
			data = jobJsonConfig:getByKey(general.job)
		else
			data = generalJsonConfig:getByKey(general.cfg_general_id)
		end
		
		local createAttrLabel = function(label, value, grow, position)
			local labelBg = CCSprite:spriteWithFile("UI/wujiangPanel/label_bg.png")
			labelBg:setPosition(position)
			labelBg:setAnchorPoint(CCPoint(0,0))
			self.panel:addChild(labelBg)
			local value_label = CCLabelTTF:labelWithString(label..(value or ""),CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
			value_label:setAnchorPoint(CCPoint(0, 0.5))
			value_label:setPosition(CCPoint(12, 13))
			value_label:setColor(ccc3(255,204,154))
			labelBg:addChild(value_label)
			if grow then
				local grow_label = CCLabelTTF:labelWithString("("..grow..")",CCSize(200,0),0, SYSFONT[EQUIPMENT], 22)
				grow_label:setAnchorPoint(CCPoint(0, 0.5))
				grow_label:setPosition(CCPoint(135, 13))
				grow_label:setColor(ccc3(153,205,0))
				labelBg:addChild(grow_label) 
			end
		end
		local sta_grow = data:getByKey("sta_grow"):asDouble()
		createAttrLabel("耐力：", general.stamina, sta_grow, CCPoint(20, 118+33*1))
		local jobName = jobJsonConfig:getByKey(general.job):getByKey("name"):asString()
		createAttrLabel("职业：", jobName, nil, CCPoint(220, 118+33*1))
		local str_grow = data:getByKey("str_grow"):asDouble()
		createAttrLabel("力量：", general.strength, str_grow, CCPoint(20, 118))
		createAttrLabel("生命：", general.health_point, nil, CCPoint(220, 118))
		local int_grow = data:getByKey("int_grow"):asDouble()
		createAttrLabel("智力：", general.intellect, int_grow, CCPoint(20, 118-33*1))
		createAttrLabel("速度：", general.speed, nil, CCPoint(220, 118-33*1))
		local agi_grow = data:getByKey("agi_grow"):asDouble()
		createAttrLabel("敏捷：", general.agility, agi_grow, CCPoint(20, 118-33*2))
		createAttrLabel("查看详细信息", nil, nil, CCPoint(220, 118-33*2))
		
		--点击区域查看详细信息
		local area = dbUIPanel:panelWithSize(CCSize(430, 132))
		area:setAnchorPoint(CCPoint(0, 0))
		area:setPosition(CCPoint(20, 118 - 33 * 2))
		area.m_nScriptClickedHandler = function()
			new(GeneralInfoDialog):create(general)
		end
		self.panel:addChild(area)
	end,
}

SingleRoleShowPanel = {
	bg = nil,
	create = function(self,general,equip)
		self.bg = dbUIPanel:panelWithSize(CCSize(406, 311))
		self.bg:setAnchorPoint(CCPoint(0.5, 0))
		self.bg:setPosition(435/2, 210)

		local showSpr = CCSprite:spriteWithFile("head/Big/head_big_"..general.face..".png")
		showSpr:setAnchorPoint(CCPoint(0.5, 0.5))
		showSpr:setPosition(self.bg:getContentSize().width/2,self.bg:getContentSize().height/2 - 20)
		showSpr:setScale(0.8 * 173/showSpr:getContentSize().width)
		self.bg:addChild(showSpr)

		if equip ~= nil then
			local pos = {
				{x=0,y=0},
				{x=0,y=107},
				{x=0,y=107*2},
				{x=307,y=0},
				{x=307,y=107},
				{x=307,y=107*2},
			}
			local equip = {}
			equip[1] = CCSprite:spriteWithFile("UI/wujiangPanel/wq.png")
			equip[2] = CCSprite:spriteWithFile("UI/wujiangPanel/yf.png")
			equip[3] = CCSprite:spriteWithFile("UI/wujiangPanel/mz.png")
			equip[4] = CCSprite:spriteWithFile("UI/wujiangPanel/fw.png")
			equip[5] = CCSprite:spriteWithFile("UI/wujiangPanel/jz.png")
			equip[6] = CCSprite:spriteWithFile("UI/wujiangPanel/xl.png")
			for i = 1 , 6 do
				equip[i]:setPosition(pos[i].x,pos[i].y)
				equip[i]:setAnchorPoint(CCPoint(0, 0))
				self.bg:addChild(equip[i],10)
			end
			self.equips = equip
		end
	end,
}

--装备面板
SingleEquipPanel = {
	bg = nil,
	grids = nil,
	create = function(self,general)
		local srsp = new(SingleRoleShowPanel)
		srsp:create(general,true)
		self.bg = srsp.bg

		self.grids = new({})
		local equipKuang = srsp.equips
		local pos = {
			{x=0,y=0},
			{x=0,y=107},
			{x=0,y=107*2},
			{x=307,y=0},
			{x=307,y=107},
			{x=307,y=107*2},
		}
		
		--武器
		if general.weapon ~= 0 then
			local itemInfo = findItemByItemId(general.weapon)
			if itemInfo ~= 0 then
				local item = new(BaoGuo_BackpackSingleItem)
				item:create(itemInfo,{item = itemInfo,from = "hero_equip",mine=true})
				item.itemBorder:setAnchorPoint(CCPoint(0, 0))
				item.itemBorder:setPosition(pos[1].x,pos[1].y)
				self.bg:addChild(item.itemBorder,12)
			end
		end
		--衣服
		if general.armor ~= 0 then
			local itemInfo = findItemByItemId(general.armor)
			if itemInfo ~= 0 then
				local item = new(BaoGuo_BackpackSingleItem)
				item:create(itemInfo,{item = itemInfo,from  = "hero_equip",mine=true})
				item.itemBorder:setAnchorPoint(CCPoint(0, 0))
				item.itemBorder:setPosition(pos[2].x,pos[2].y)
				self.bg:addChild(item.itemBorder,12)
			end
		end
		--帽子
		if general.misc ~= 0 then
			local itemInfo = findItemByItemId(general.misc)
			if itemInfo ~= 0 then
				local item = new(BaoGuo_BackpackSingleItem)
				item:create(itemInfo,{item = itemInfo,from  = "hero_equip",mine=true})
				item.itemBorder:setAnchorPoint(CCPoint(0, 0))
				item.itemBorder:setPosition(pos[3].x,pos[3].y)
				self.bg:addChild(item.itemBorder,12)
			end
		end		
		--符文
		if general.horse ~= 0 then
			local itemInfo = findItemByItemId(general.horse)
			if itemInfo ~= 0 then
				local item = new(BaoGuo_BackpackSingleItem)
				item:create(itemInfo,{item = itemInfo,from  = "hero_equip",mine=true})
				item.itemBorder:setAnchorPoint(CCPoint(0, 0))
				item.itemBorder:setPosition(pos[4].x,pos[4].y)
				self.bg:addChild(item.itemBorder,12)
			end
		end
		--手套
		if general.cloak ~= 0 then
			local itemInfo = findItemByItemId(general.cloak)
			if itemInfo ~= 0 then
				local item = new(BaoGuo_BackpackSingleItem)
				item:create(itemInfo,{item = itemInfo,from  = "hero_equip",mine=true})
				item.itemBorder:setAnchorPoint(CCPoint(0, 0))
				item.itemBorder:setPosition(pos[6].x,pos[6].y)
				self.bg:addChild(item.itemBorder,12)
			end
		end
		--戒指
		if general.amulet ~= 0 then
			local itemInfo = findItemByItemId(general.amulet)
			if itemInfo ~= 0 then
				local item = new(BaoGuo_BackpackSingleItem)
				item:create(itemInfo,{item = itemInfo,from  = "hero_equip",mine=true})
				item.itemBorder:setAnchorPoint(CCPoint(0, 0))
				item.itemBorder:setPosition(pos[5].x,pos[5].y)
				self.bg:addChild(item.itemBorder,12)
			end
		end		
	end,
}
--[[
4 宠物店老板娘
5 千貨商
6 阵营接引人
7 土地公
]]--

--任务操作的状态，是否成功操作
function globalGetTaskOpStatus(error_code)
	if error_code == -1 then
		return 1
	elseif error_code == 2001 then
		alert("背包空间不足，无法提交任务。")
	end
	return 0
end

---任务提交后更新神位等级
function GlobleUpdateOfficum(officium)
	if GloblePlayerData.officium ~= officium then
		
		GolbalCreateEffect(2) --1为等级升级特效 2为神位升级特效 3为任务完成特效
		
		GloblePlayerData.officium = officium

		GlobleAddStepOfficuim(officium)
		
		if officium == 10 then
			DispatchEvent("grow_gift_10")
		elseif officium == 20 then
			DispatchEvent("zhaomu")
		elseif officium == 24 then
			DispatchEvent("keji")
		elseif officium == 29 then
			DispatchEvent("qianghua")
		elseif officium == 30 then
			DispatchEvent("composite")			
		elseif officium == 32 then
			DispatchEvent("xiang_qian")	
		elseif officium == 34 then
			DispatchEvent("jixin")	
		end
	end
end

----- OPT_Task 任务 ------------------------------------
local function execTask(taskid, npcid, opt)
	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	cj:setByKey("cfg_task_id", taskid)
	cj:setByKey("npc_id", npcid)
	cj:setByKey("do_value", opt)

	NetMgr:setOpUnique(Net.OPT_TaskSimple)
	NetMgr:executeOperate(Net.OPT_TaskSimple, cj)
end

----- OPT_Battle 战斗 ------------------------------------
function execNetBattleOp(targetid, typeid)
	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	cj:setByKey("target_id", targetid)
	cj:setByKey("type", typeid)

	dbSceneMgr:getSingletonPtr():setCurBattleType(typeid)
	NetMgr:executeOperate(Net.OPT_BattleSimple, cj)
end

local function onTaskOpFinished(s)
	local action = s:getByKey("action"):asInt()
	if action == 3 then -- 1 继续 2 接受任务 3 提交任务
		GolbalCreateEffect(3) --1为等级升级特效 2为神位升级特效 3为任务完成特效
		conmitTaskGetItems(s)
	elseif action==2 then  --接收任务后调用
		--[[
		Log("npc task onTaskOpFinished step:  "..step)
		GloblePlayerData.step = s:getByKey("step"):asInt()
		local HUD  = dbHUDLayer:shareHUD2Lua()
		if HUD ~= nil then
			HUD:updateHudStep(GloblePlayerData.step)
		end
		--]]
		StartAutoPathGuide()
	end
end

local function onTaskOpFailed(s)
end

local function createTaskPanelWithCfg(cfg)
    if GlobleTaskPanel ~= nil then
        GlobleTaskPanel:destroy()
    end
    
    if CheckUserGuiding() == 1 then
    	return
    end
    
	local taskPanel = new(TaskPanel)
	taskPanel:create(cfg)
	GlobleTaskPanel = taskPanel
	
	if CheckNeedTaskGuide() then
		StartUserGuide("task")
	end
end

function GlobalNpcTaskNativeWord(s)
	---如果有新功能开启，任务就不出来
	if GlobalOpenNewFunctionPanel then
		return
	end

	local task_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_task.json")
	local npc_word_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_word.json")
	
	local npc_id = s:getByKey("NpcID"):asInt()
	local task = s:getByKey("task")
	local taskTable = {}
	for i = 1, task:size() do
		local content = task:getByIndex(i-1)
		local contentTable = {}
		contentTable.related_taskid = content:getByKey("TaskID"):asInt()
		contentTable.cur_done_value = content:getByKey("CurDoneValue"):asInt()
		contentTable.finish_value = content:getByKey("FinishValue"):asInt()
		taskTable[i] = contentTable
	end

	local npc_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/npc.json")
	local npc_talk = {
		id = npc_id,
		image = "head/Big/head_big_" .. npc_cfg:getByKey(npc_id):getByKey("face"):asInt() .. ".png", -- 通过 cfg_npc 找到id为 npc_id 的face id
		npcName = npc_cfg:getByKey(npc_id):getByKey("name"):asString(), -- 通过 cfg_npc 找到id为 npc_id 的名字
		taskInfo = {},
	}
	
	-- 1.继续 2.接任务 3.交任务 4.傳送 5.商店 9.杀敌 10.宠物店 11.秦陵秘境杀敌 12.众神墓地 13.众神墓地战斗 99.石獅子特殊战斗
	local function doOp(oType, data)
		if oType == 2 then	--接受任务
			execTask(data,npc_id,oType)
		elseif oType == 3 then	--提交任务
			execTask(data,npc_id,oType)
		elseif oType == 10 then	--宠物店
			createTavernPanel()				
		elseif oType == 11 then	--道具店
			GlobleCreateShopping()
		elseif oType == 12 then	--祭星
			globleShowJiFete()
		elseif oType == 20 then  --世界boss
			execNetBattleOp(npc_id, 8)
		end
	end
	
	local showHudTaskInfo = function(type)
		local HUD = dbHUDLayer:shareHUD2Lua()
		if HUD then
			if type == 1 then
				HUD:taskInfoVisible(20111)
			else
				HUD:taskInfoVisible(20211)
			end
		end
	end
	
	local function setTaskReward(task)
		local task_item = task_cfg:getByKey(task.task_id)
		if not task_item:isNull() then
			local rc = task_item:getByKey("reward_copper"):asInt()	-- 银币
			local rp = task_item:getByKey("reward_prestige"):asInt()	-- 神力
			local rt1 = task_item:getByKey("reward_item_1"):asInt()
			local rt2 = task_item:getByKey("reward_item_2"):asInt()
			task.rewards = {}
			local idx = 1
	        if rp > 0 then
	            task.rewards[idx] = {}
	            task.rewards[idx].itemid = 80000004
	            task.rewards[idx].itemcount = rp
	            idx = idx + 1
	        end
	        
	        if rc > 0 then
	            task.rewards[idx] = {}
	            task.rewards[idx].itemid = 80000002
	            task.rewards[idx].itemcount = rc
	            idx = idx + 1
	        end
	        
	        if rt1 > 0 then
	            task.rewards[idx] = {}
	            task.rewards[idx].itemid = rt1
	            task.rewards[idx].itemcount = task_cfg:getByKey(task.task_id):getByKey("reward_item_amount_1"):asInt()
	            idx = idx + 1
	        end
	        
	        if rt2 > 0 then
	            task.rewards[idx] = {}
	            task.rewards[idx].itemid = rt2
	            task.rewards[idx].itemcount = task_cfg:getByKey(task.task_id):getByKey("reward_item_amount_2"):asInt()
	            idx = idx + 1
	        end
		end
	end
	--获取对话npc普通状态下的信息
	local getNpcInfo = function()
		local wc = npc_word_cfg:getByKey(npc_id):getByKey("word_content"):asString()
		local oe = npc_word_cfg:getByKey(npc_id):getByKey("option_effect_1"):asInt()
		if oe ~= 0 then
			local oc = npc_word_cfg:getByKey(npc_id):getByKey("option_content_1"):asString()
            npc_talk.content = wc
            npc_talk.answer = oc
            npc_talk.oprateType = oe
            npc_talk.answerFunction = function()
				doOp(oe)
				GlobleTaskPanel:destroy()
			end
		else
            npc_talk.content = wc
		end
	end
	--获取任务信息
	local getTaskInfo = function(type)
		local jTask = task_cfg:getByKey(taskTable[type].related_taskid)
		if jTask:isNull() then 
			return
		end
	
		local getNpc = jTask:getByKey("get_npc"):asInt()
		local submitNpc = jTask:getByKey("submit_npc"):asInt()
	
		local index = #npc_talk.taskInfo + 1
		local task = nil
		local word_id = 0
		if taskTable[type].cur_done_value == -1 then								--可接任务
			if npc_id == getNpc then	
				npc_talk.taskInfo[index] = {}
				task = npc_talk.taskInfo[index]
				if jTask:getByKey("require_officium"):asInt() > GloblePlayerData.officium then --未到达可接任务等级
					task.status = -2
					task.require_officium = jTask:getByKey("require_officium"):asInt()
				else
					task.status = -1
				end
				word_id = jTask:getByKey("get_word"):asInt()
			end
		elseif taskTable[type].cur_done_value ~= taskTable[type].finish_value then	--已接，未完成
			if npc_id == getNpc then
				npc_talk.taskInfo[index] = {}
				task = npc_talk.taskInfo[index]
				task.status = 0
				word_id = jTask:getByKey("get_word"):asInt()
			end
		elseif taskTable[type].cur_done_value == taskTable[type].finish_value then	--完成
			if npc_id == submitNpc then
				npc_talk.taskInfo[index] = {}
				task = npc_talk.taskInfo[index]
				task.status = 1
				word_id = jTask:getByKey("submit_word"):asInt()
			end
		end	
		if task then
			task.task_id = taskTable[type].related_taskid
			task.type = type
			task.name = jTask:getByKey("name"):asString()
			task.content = npc_word_cfg:getByKey(word_id):getByKey("word_content"):asString()
			task.answer = npc_word_cfg:getByKey(word_id):getByKey("option_content_1"):asString()
			task.answerFunction = function()
				if task.status ~= 1 then
					showHudTaskInfo(type)
				end
				
				if task.status == 0 then
					dbTaskMgr:getSingletonPtr():taskPathing(type)
				else
					local oe = npc_word_cfg:getByKey(word_id):getByKey("option_effect_1"):asInt()
	            	doOp(oe, task.task_id)
	            end
	            
	            if GlobleTaskPanel then
		            GlobleTaskPanel:destroy()
		        end
			end
			setTaskReward(task)
		end
	end
	
	getNpcInfo()
	--获取主线任务
	getTaskInfo(1)
	--获取支线任务
	getTaskInfo(2)
	
	--世界boss，直接开战
	if npc_talk.oprateType ~= nil and npc_talk.oprateType==20 then
		execNetBattleOp(npc_id, 8)
	else
		createTaskPanelWithCfg(npc_talk)
	end
end

function GlobalOnAcceptTaskById(tid)
end

function GlobalOnAcceptTask(jTask)
	local tid = jTask:getByKey("cfg_task_id"):asInt()
	GlobalOnAcceptTaskById(tid)
end

function GlobalOnSubmitTaskById(tid)
    if tid == 10003 then
    	DispatchEvent("new_equip")
    end
end

function GlobalOSubmitTask(jTask)
	local tid = jTask:getByKey("cfg_task_id"):asInt()
	GlobalOnSubmitTaskById(tid)
end

NetMgr:registOpLuaFinishedCB(Net.OPT_TaskSimple, onTaskOpFinished)
NetMgr:registOpLuaFailedCB(Net.OPT_TaskSimple, onTaskOpFailed)
--任务对话面板
TaskPanel =
{
	bgLayer = nil,
	uiLayer = nil,
	centerWidget = nil,
	touchPanel = nil,
	bgLayerSize = nil,

	closeBtn = nil,
	bg = nil,

	npcId = nil,

	create = function(self, cfg)
		local bgSprWidth  = 722
		local bgSprHeight = 372
		self.task_cfg = cfg
		
		local scene = DIRECTOR:getRunningScene()
		self.bgLayerSize, self.bgLayer = createTipPanelBg(746,353)
		self.uiLayer,self.centerWidget ,self.touchPanel = createTipCenterWidget(self.bgLayerSize,self.bgLayer)
		
		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		self.touchPanel.m_nScriptClickedHandler = function()
			self:destroy()
		end

		self.bg = createBG("UI/task/task_bg.png",bgSprWidth,bgSprHeight)
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition((self.bgLayerSize.width - bgSprWidth) / 2, (self.bgLayerSize.height -  bgSprHeight) / 2)
		self.centerWidget:addChild(self.bg)

		if cfg ~= nil and cfg ~= "" then
			self.npcId = cfg.id

			local headImage = CCSprite:spriteWithFile(cfg.image)
			headImage:setPosition(CCPoint(-100, 58))
			headImage:setAnchorPoint(CCPoint(0, 0))
			self.bg:addChild(headImage,1,2)

			local dialog_bg_triangle = CCSprite:spriteWithFile("UI/task/dialog_bg_triangle.png")
			dialog_bg_triangle:setAnchorPoint(CCPoint(1, 0))
			dialog_bg_triangle:setPosition(CCPoint(260, 258))
			self.bg:addChild(dialog_bg_triangle)
			local dialog_bg = createBG("UI/task/dialog_bg.png",412,145,CCSizeMake(30,30))
			dialog_bg:setAnchorPoint(CCPoint(0, 1))
			dialog_bg:setPosition(260, 348)
			self.dialog_bg = dialog_bg
			self.bg:addChild(dialog_bg)

			self.talkNameLabel = CCLabelTTF:labelWithString(cfg.npcName.."：", CCSizeMake(456, 0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 26)
			self.talkNameLabel:setColor(ccc3(1,153,203))
			self.talkNameLabel:setPosition(CCPoint(18, dialog_bg:getContentSize().height - 10))
			self.talkNameLabel:setAnchorPoint(CCPoint(0,1))
			dialog_bg:addChild(self.talkNameLabel)

			self.talkContentLabel = CCLabelTTF:labelWithString(cfg.content or " ", CCSizeMake(395, 0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 21)
			self.talkContentLabel:setAnchorPoint(CCPoint(0, 1))
			self.talkContentLabel:setPosition(CCPoint(18, dialog_bg:getContentSize().height - 40))
			self.talkContentLabel:setColor(ccc3(148,195,1))
			dialog_bg:addChild(self.talkContentLabel)
			
			local startX = dialog_bg:getPositionX()
			local startY = dialog_bg:getPositionY() - dialog_bg:getContentSize().height - 10
			self.btns = new({})
			for i = 1, #cfg.taskInfo do
				local task = cfg.taskInfo[i]
				local task_bg = dbUIButtonScale:buttonWithImage("UI/task/task_info_bg.png", 1, ccc3(125, 125, 125))
				task_bg:setAnchorPoint(CCPoint(0, 1))
				task_bg:setPosition(CCPoint(startX, startY))
				task_bg.m_nScriptClickedHandler = function()
					self:showTaskDetail(task)
					GotoNextStepGuide()
				end
				task_bg.taskType = task.type
				task_bg.taskType = task.type
				self.btns[i] = task_bg
				self.bg:addChild(task_bg)
				
				startY = startY - (10 + task_bg:getContentSize().height)
				local taskStr = nil
				if task.type == 1 then	--主线任务
					taskStr = "【主】"..task.name
				else
					taskStr = "【支】"..task.name
				end
				local taskLabel = CCLabelTTF:labelWithString(taskStr or " ", CCSizeMake(0, 0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 22)
				taskLabel:setAnchorPoint(CCPoint(0, 0.5))
				taskLabel:setPosition(CCPoint(10, task_bg:getContentSize().height / 2))
				taskLabel:setColor(ccc3(255, 204, 103))
				task_bg:addChild(taskLabel)
				local taskStatus = nil
				local color = nil
				if task.status == -2 then
					taskStatus = "（"..task.require_officium.."级可接）"
					color = ccc3(255, 0, 0)
					task_bg.m_nScriptClickedHandler = function()
						alert("神位等级未达到，完成支线\n任务或扫荡关卡可提升神位等级")
					end
				elseif task.status == -1 then	
					taskStatus = "（可接）"
					color = ccc3(255, 153, 0)
				elseif task.status == 0 then
					taskStatus = "（已接）"
					color = ccc3(255, 255, 255)
				else
					taskStatus = "（完成）"
					color = ccc3(151, 206, 1)	
				end		
				local taskStatusLabel = CCLabelTTF:labelWithString(taskStatus or " ", CCSizeMake(450, 0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 22)
				taskStatusLabel:setAnchorPoint(CCPoint(0, 0.5))
				taskStatusLabel:setPosition(CCPoint(15 + taskLabel:getContentSize().width, task_bg:getContentSize().height / 2))
				taskStatusLabel:setColor(color)
				task_bg:addChild(taskStatusLabel)
			end
			--部分NPC具有其他功能，宠物店，道具店
			if cfg.answer then
				local flag = true
				local step_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_step.json")
				if cfg.oprateType and cfg.oprateType == 10 then
					flag = step_cfg:getByKey("zhao_mu_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium
				end
				if cfg.oprateType and cfg.oprateType == 11 then
					flag = step_cfg:getByKey("shangcheng_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium
				end
				if cfg.oprateType and cfg.oprateType == 12 then
					flag = step_cfg:getByKey("soul_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium
				end
				if flag then
					local npcFunction = dbUIButtonScale:buttonWithImage("UI/task/task_info_bg.png", 1, ccc3(125, 125, 125))
					npcFunction:setAnchorPoint(CCPoint(0, 1))
					npcFunction:setPosition(CCPoint(startX, startY))
					npcFunction.m_nScriptClickedHandler = cfg.answerFunction
					
					local npcFunctionLabel = CCLabelTTF:labelWithString(cfg.answer or " ", CCSizeMake(0, 0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 22)
					npcFunctionLabel:setAnchorPoint(CCPoint(0, 0.5))
					npcFunctionLabel:setPosition(CCPoint(10, npcFunction:getContentSize().height / 2))
					npcFunction:addChild(npcFunctionLabel)
		
					self.btns[#self.btns + 1] = npcFunction
					self.bg:addChild(npcFunction)
				end
			end
		end

		self.closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png", 1.2, ccc3(125, 125, 125))
		self.closeBtn:setAnchorPoint(CCPoint(0.5,0.5))
		self.closeBtn:setPosition(CCPoint(bgSprWidth - 10, bgSprHeight - 10))
		self.closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.bg:addChild(self.closeBtn)

		return self
	end,
	
	showTaskDetail = function(self, task)
		--增高对话框
		self.dialog_bg:setScaleY(230 / 145)
		self.talkNameLabel:setPosition(CCPoint(18, self.dialog_bg:getContentSize().height - 10))
		self.talkContentLabel:setPosition(CCPoint(18, self.dialog_bg:getContentSize().height - 40))
		--修改对话内容
		self.talkContentLabel:setString(task.content)
		--增加任务奖励
		if task.rewards ~= nil and #task.rewards > 0 then
			for i = 1, #task.rewards do 
				local item = task.rewards[i]
				local icon = nil
				local type = nil
				if item.itemid == 80000004 then	--神力
					icon = "icon/prestige.png"
				elseif item.itemid == 80000002 then --银币
					icon = "icon/copper.png"
				else
					local item_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
					icon = "icon/Item/icon_item_"..item_cfg:getByKey(item.itemid):getByKey("icon"):asInt()..".png"
				end
				local kuang = dbUIWidget:widgetWithImage("UI/public/kuang_96_96.png")
				kuang:setAnchorPoint(CCPoint(1, 0))
				kuang:setPosition(CCPoint(self.dialog_bg:getContentSize().width - 100 * (i-1) - 3, 3))
				self.dialog_bg:addChild(kuang)
				local itemSpr = dbUIButtonScale:buttonWithImage(icon, 1, ccc3(125, 125, 125))
				itemSpr:setScale(90 / itemSpr:getContentSize().width)
				itemSpr:setAnchorPoint(CCPoint(0.5, 0.5))
				itemSpr:setPosition(CCPoint(48, 48))
				itemSpr.m_nScriptClickedHandler = function()
					if item.itemid == 80000004 then
						alert("神力*"..item.itemcount)
					elseif item.itemid == 80000002 then
						alert("银币*"..item.itemcount)
					else
						local cfg = {
							item = findShowItemInfo(item.itemid),
							from = "view"
						}
						ItemClickHandler(cfg)
					end
				end
				kuang:addChild(itemSpr)
			end
		end
		--将原来的按钮去掉
		for i = 1, #self.btns do
			self.btns[i]:removeFromParentAndCleanup(true)
		end
		--添加接取任务，这就前去，提交任务按钮
		local function_btn = dbUIButtonScale:buttonWithImage("UI/task/task_info_bg.png", 1, ccc3(125, 125, 125))
		function_btn:setAnchorPoint(CCPoint(0, 1))
		function_btn:setPosition(CCPoint(self.dialog_bg:getPositionX(), self.dialog_bg:getPositionY() - self.dialog_bg:getContentSize().height - 10))
		function_btn.m_nScriptClickedHandler = task.answerFunction
		local functionLabel = nil
		if task.status == -1 then
			functionLabel = CCLabelTTF:labelWithString("接取任务", CCSizeMake(300, 0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 22)
		elseif task.status == 0 then 
			functionLabel = CCLabelTTF:labelWithString("这就前去", CCSizeMake(300, 0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 22)
		else
			functionLabel = CCLabelTTF:labelWithString("提交任务", CCSizeMake(300, 0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 22)
		end		
		functionLabel:setAnchorPoint(CCPoint(0, 0.5))
		functionLabel:setPosition(CCPoint(10, function_btn:getContentSize().height / 2))
		functionLabel:setColor(ccc3(255, 204, 103))
		function_btn:addChild(functionLabel)
		function_btn.taskId = task.task_id
		self.function_btn = function_btn
		self.bg:addChild(function_btn)
	end,
	
	setIsVisible = function(self, visible)
		self.uiLayer:setIsVisible(visible)
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil

		self.answerBtnParent = nil
		
		onTaskPanelClosed()
		
		GlobleTaskPanel = nil
		removeUnusedTextures()
	end
}
---id: 1为等级升级 2为神位升级 3为任务完成
--GolbalCreateEffect(id)
function GolbalCreateEffect(id)
	local fcp = new(EffectPanel)
	fcp:create(id)
end

local function preLoadEffectSound()
	local effsoud=dbAudioManager:sharedAudioManager()
	effsoud:preloadSoundEffect("sounds/misscom.mp3")
	effsoud:preloadSoundEffect("sounds/update.mp3")
end

EffectPanel = {
	m_panel = nil,
	tipPanelClearHand = nil,

	create = function(self,id)
		preLoadEffectSound()
		
		local sceneTag = DIRECTOR:getRunningScene():getTag()

		if sceneTag ~= 0 then
			return
		end

		local scene = DIRECTOR:getRunningScene()
		self.m_panel  = dbUILayer:node()
		self.m_panel:setScaleY(SCALEY)
		self.m_panel:setScaleX(SCALEX)

		local spr = CCSprite:spriteWithFile("UI/nothing.png")
		spr:setAnchorPoint(CCPoint(0.5,0.5))
		spr:setPosition(CCPoint(512, 384))
		spr:setScale(isRetina)
		self.m_panel:addChild(spr,1000000)
		
		local animation = nil
		local action = nil
		local effsoud=dbAudioManager:sharedAudioManager()
		if id == 1 then
			animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("level_update")
			action = CCAnimate:actionWithAnimation(animation)
			effsoud:playSoundEffect("sounds/update.mp3")
		elseif id == 2 then
			spr:setScaleX(0)
			local a1 = CCSequence:actionOneTwo(CCScaleTo:actionWithDuration(0.2,1.5),CCScaleTo:actionWithDuration(0.1,1))
			animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("guang_update")
			action = CCSpawn:actionOneTwo(CCAnimate:actionWithAnimation(animation),a1)
			spr:setPosition(CCPoint(512, 384))
			effsoud:playSoundEffect("sounds/update.mp3")
		elseif id == 3 then
			animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("task_success")
			action = CCAnimate:actionWithAnimation(animation)
			spr:setPosition(CCPoint(512, 384 + 50))
			effsoud:playSoundEffect("sounds/misscom.mp3")
		elseif id == 4 then
		end
		if id ~= 4 then
			spr:runAction(action)
		end
		local toClear = function()
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.tipPanelClearHand)
			self.tipPanelClearHand = nil
			self:destroy()
		end
		self.tipPanelClearHand = CCScheduler:sharedScheduler():scheduleScriptFunc(toClear, 2.3, false)
		scene:addChild(self.m_panel, 10100)
	end,

	destroy = function(self)
		if self.tipPanelClearHand ~= nil then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.tipPanelClearHand)
			self.tipPanelClearHand = nil
		end
		self.m_panel:removeFromParentAndCleanup(true)
		self.m_panel = nil
		removeUnusedTextures()
	end
}
local RewardOnlineCDTime = {
	1*60,
	5*60,
	15*60,
	30*60,
	45*60,
	90*60,
}
local MAX_STEP = table.getn(RewardOnlineCDTime)
local RewardOnlineInstance = nil

local RewardOnline = {
	timeHandle  = nil,
	cd_time 	= 0,
	step        = 0, --现在领到第几个了，下一个是step+1

	setBtnVisible = function(self,v)
		local HUDLayer = dbHUDLayer:shareHUD2Lua()
		if HUDLayer then
			HUDLayer:getChildByTag(409):setIsVisible(v)
		end
	end,

	removeRewardOnline = function (self)
		if self.timeHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
			self.timeHandle = nil
		end
	end,

	getReward = function(self,data)
		if data.cfg_item_id and data.cfg_item_id==16 then --精力
			ShowReward("在线礼包奖励：".."\n".."恭喜你获得 "..data.amount.." 精力")
		elseif data.cfg_item_id and data.cfg_item_id==14 then  --经验丹
			ShowReward("在线礼包奖励：".."\n".."恭喜你获得 "..data.amount.." 经验丹")
		elseif data.cfg_item_id and data.cfg_item_id==0 then  --银币
			GloblePlayerData.copper= GloblePlayerData.copper+data.amount
			ShowReward("在线礼包奖励：".."\n".."恭喜你获得 "..data.amount.." 银币")
		elseif data.cfg_item_id and data.cfg_item_id==1 then  --金币
			GloblePlayerData.gold=GloblePlayerData.gold+data.amount
			ShowReward("在线礼包奖励：".."\n".."恭喜你获得 "..data.amount.." 金币")
		elseif data.cfg_item_id and data.cfg_item_id==42200002 then  --二级宝石袋
			ShowReward("在线礼包奖励：".."\n".."恭喜你获得 "..data.amount.." 个二级宝石袋")
		end

		if data.add_item_id_list[1] and data.add_item_id_list[1]> 0 then
			local map2Bag = new ({})
			map2Bag[1] = data.cfg_item_id
			map2Bag[2] = data.add_item_id_list[1]
			battleGetItems(map2Bag,true)
		end

		if data.change_item_id_list[1] and data.change_item_id_list[1]> 0 then
			local map2Bag = new ({})
			map2Bag[1] = data.cfg_item_id
			map2Bag[2] = data.change_item_id_list[1]
			battleGetItems(map2Bag,true)
		end

		updataHUDData()
		self:update()
	end,

	update = function(self)
		if self.step == -1 then
			self:removeRewardOnline()
			self:setBtnVisible(false)
		else
			self:setBtnVisible(true)
			self.cd_time = RewardOnlineCDTime[self.step+1]
			self.step = self.step+1 --直接这里改step
			if self.step == 7 then
				self:removeRewardOnline()
				self:setBtnVisible(false)
				self.step = -1
			end
		end
	end,

	initReward  = function(self)
		self.step = ClientData.online_act_step
		self.daily_online = ClientData.daily_online

		local function handler ()
			local HUDLayer = dbHUDLayer:shareHUD2Lua()
			--不管在不在主界面，计时器不停止
			if self.cd_time >0 then
				self.cd_time = self.cd_time -1
			end
			if HUDLayer then
				HUDLayer:updateReWardHandler(self.cd_time<=0 and "-1" or getLenQueTime(self.cd_time))
			end
		end
		if self.timeHandle == nil then
			self.timeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(handler,1,false)
		end

		self:update()
	end,
}

--c++调用
function globle_Create_RewardOnline()
	if  RewardOnlineInstance ==nil then

		RewardOnlineInstance = new (RewardOnline)
		RewardOnlineInstance:initReward()
	end
end

--c++调用,在线礼包是否可以继续领取
function globalRewardOnlineFinished()
	return ((ClientData.online_act_step and ClientData.online_act_step ~= -1) and 0 or 1)
end

--退出游戏的时候调用
function destroyRewardOnline()
	if  RewardOnlineInstance then
		RewardOnlineInstance:removeRewardOnline()
		RewardOnlineInstance = nil
	end
end

--心跳包更新在线数据
--基本不需要用了
function updateRewardOnlineData (json)
	if RewardOnlineInstance.step >= 1 then
		RewardOnlineInstance.cd_time =RewardOnlineCDTime[RewardOnlineInstance.step] - json:getByKey("last_time"):asInt()
	end
end

--领取在线奖励
function globleRewardOnline()
	local successCallBack = function(json)
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			if error_code == 307 then
				dbHUDLayer:shareHUD2Lua():setIsReWardOnLineVisible()
				ClientData.online_act_step = -1
			elseif error_code == 2001 then
				alert("背包空间不足，礼包领取失败，请整理背包后重新领取。")
			else
				ShowErrorInfoDialog(error_code)
			end
		else
			RewardOnlineInstance.step = json:getByKey("online_act_step"):asInt()
			RewardOnlineInstance.daily_online = json:getByKey("daily_online"):asInt()
			ClientData.daily_online = RewardOnlineInstance.daily_online
			ClientData.online_act_step = RewardOnlineInstance.step

			local RewardData = new({})
			RewardData.cfg_item_id = json:getByKey("cfg_item_id"):asInt()
			RewardData.amount = json:getByKey("amount"):asInt()
			RewardData.add_item_id_list = new ({})
			RewardData.change_item_id_list = new ({})

			local add_item_id_list  =  json:getByKey("add_item_id_list")
			for i  = 1 , add_item_id_list:size() do
				RewardData.add_item_id_list[i] = add_item_id_list:getByIndex(i-1):asInt()
			end

			local change_item_id_list  =  json:getByKey("change_item_id_list")
			for i  = 1 , change_item_id_list:size() do
				RewardData.change_item_id_list[i] = change_item_id_list:getByIndex(i-1):asInt()
			end

			RewardOnlineInstance:getReward(RewardData)
		end
	end

	NetMgr:registOpLuaFinishedCB(Net.OPT_RewardOnline,successCallBack)
	NetMgr:registOpLuaFailedCB(Net.OPT_RewardOnline,opFailedCB)
	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)

	NetMgr:setOpUnique(Net.OPT_RewardOnline)
	NetMgr:executeOperate(Net.OPT_RewardOnline, cj)
end
function SetNewManRewardVisible(visible)
	if visible then
		if globalRewardNewMan == nil then
			globalRewardNewMan = new(RewardNewManPanel)
			globalRewardNewMan:create()
		end
	end
end

--领取新手奖励
globleRewardNew = function()
	local callBack = function(json)
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			if error_code == 307 then
				ShowErrorInfoDialog(error_code)
			end
		else
			local jsonList  =  json:getByKey("add_item_id_list")
			local add_item_id_list = new({})
			for i  = 1 , jsonList:size() do
				add_item_id_list[i] = jsonList:getByIndex(i-1):asInt()
			end

			local cfg_item_id = json:getByKey("cfg_item_id"):asInt()
	
			local map2Bag = new ({})
			map2Bag[1] = cfg_item_id
			map2Bag[2] = add_item_id_list[1]
			map2Bag[3] = 1
			map2Bag[4] = true
			battleGetItems(map2Bag,true,3)

			ClientData.new_man_reward = false
			if globalRewardNewMan ~= nil then
				globalRewardNewMan:destroy()
				globalRewardNewMan = nil
			end
		end
	end
	local excue_OPT = function ()
		NetMgr:registOpLuaFinishedCB(Net.OPT_RewardNewMan,callBack)
		NetMgr:registOpLuaFailedCB(Net.OPT_RewardNewMan,opFailedCB)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:setOpUnique(Net.OPT_RewardNewMan)
		NetMgr:executeOperate(Net.OPT_RewardNewMan, cj)
	end
	excue_OPT();
end

GlobleShowXinShouLiBaoOkClickGuide = function(okBtn)
	local guide =  CCSprite:spriteWithFile("UI/user_guide/guide_right.png")
	guide:setPosition(CCPoint(-230, okBtn:getContentSize().height/2-55))
	guide:setAnchorPoint(CCPoint(0.5, 0))
	okBtn:addChild(guide)

	local label = CCLabelTTF:labelWithString("点这里", SYSFONT[EQUIPMENT], 32)
	label:setAnchorPoint(CCPoint(0.5,0))
	label:setColor(ccc3(255,209,68))
	label:setPosition(CCPoint(guide:getContentSize().width/2,40))
	guide:addChild(label)

	local moveActionRight = CCMoveBy:actionWithDuration(0.5, CCPoint(30, 0))
	local moveActionLeft = CCMoveBy:actionWithDuration(0.5, CCPoint(-30, 0))
	local moveAction = CCSequence:actionOneTwo(moveActionRight,moveActionLeft)
	local action =  CCRepeatForever:actionWithAction(moveAction)
	guide:runAction(action)
end
	
RewardNewManPanel = {
	create = function(self)
		local scene = DIRECTOR:getRunningScene()
		self.bgLayer = createSystemPanelBg()
		self.uiLayer, self.centerWidget = createCenterWidget()
		
		scene:addChild(self.bgLayer, 2000)
		scene:addChild(self.uiLayer, 3000)
		
		local newManReward = dbUIButtonScale:buttonWithImage("UI/gift/new_man.png", 1.2, ccc3(125, 125, 125))
		newManReward:setAnchorPoint(CCPoint(0.5, 0.5))
		newManReward:setPosition(CCPoint(505, 702))
		newManReward.m_nScriptClickedHandler = function()
			globleRewardNew()
			if self.guideSpr then
				self.guideSpr:removeFromParentAndCleanup(true)
				self.guideSpr = nil
			end
		end

		self.centerWidget:addChild(newManReward)
		
		local moveTo = CCMoveTo:actionWithDuration(1, CCPoint(505, 351))
		local EaseBackOut = CCEaseBackOut:actionWithAction(moveTo)
		newManReward:runAction(EaseBackOut)
		
		local secondHandle = nil
		local times = 0
		local handle = function()
			if times == 1 then
				CCScheduler:sharedScheduler():unscheduleScriptEntry(secondHandle)
				self:showGuide(newManReward)
			end
			times = times + 1
		end
		secondHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(handle,1, false)
	end,
	
	showGuide = function(self,newManReward)
		local guide =  CCSprite:spriteWithFile("UI/user_guide/guide_right.png")
		guide:setPosition(CCPoint(-200, newManReward:getContentSize().height/2-50))
		guide:setAnchorPoint(CCPoint(0.5, 0))
		newManReward:addChild(guide)

		local label = CCLabelTTF:labelWithString("点这里", SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setColor(ccc3(255,209,68))
		label:setPosition(CCPoint(guide:getContentSize().width/2,40))
		guide:addChild(label)

		local moveActionRight = CCMoveBy:actionWithDuration(0.5, CCPoint(30, 0))
		local moveActionLeft = CCMoveBy:actionWithDuration(0.5, CCPoint(-30, 0))
        local moveAction = CCSequence:actionOneTwo(moveActionRight,moveActionLeft)
        local action =  CCRepeatForever:actionWithAction(moveAction)
        guide:runAction(action)
        self.guideSpr = guide
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
	end
}

--祈愿树
WishPanel = {
	pray_index = 0,
	
	create = function(self)
		if not self.mainWidget then
			self:initBase()
		end
		self.cfg_item = self.cfg_item ~= nil and self.cfg_item or GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")

		local bg = CCSprite:spriteWithFile("UI/wish/bg.png")
		bg:setAnchorPoint(CCPoint(0.5, 0))
		bg:setPosition(CCPoint(1010/2, 220))
		self.mainWidget:addChild(bg)
		--查看宝箱
		local btn = dbUIButtonScale:buttonWithImage("UI/wish/view.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0,0))
		btn:setPosition(CCPoint(47,236))
		btn.m_nScriptClickedHandler = function()
			GlobalCreateWishGiftPanel()
		end
		self.mainWidget:addChild(btn)
		local label = CCLabelTTF:labelWithString("祈福奖品库", CCSize(300,0),0,SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(14,51/2))
		label:setColor(ccc3(254,205,50))
		btn:addChild(label)
		local label = CCLabelTTF:labelWithString("【查看】", CCSize(200,0),0,SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(170,51/2))
		label:setColor(ccc3(4,196,245))
		btn:addChild(label)

		self.UIList = dbUIList:list(CCRectMake(563, 232, 385, 337),0)
		self.mainWidget:addChild(self.UIList)

		local panel = dbUIPanel:panelWithSize(CCSize(914,169))
		panel:setAnchorPoint(CCPoint(0.5, 0))
		panel:setPosition(CCPoint(1010/2, 37))
		self.mainWidget:addChild(panel)
		local CFG = {
			names = {"福禄持光","七彩圣言","诸神庇佑"},
			moneys = {"10","100","500"},
			times = {1,10,50}
		}
		for i=1,3 do
			local item = createDarkBG(285,167)
			item:setAnchorPoint(CCPoint(0, 0))
			item:setPosition(CCPoint((i-1)*312, 0))
			panel:addChild(item,-i)

			local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
			kuang:setAnchorPoint(CCPoint(0, 0))
			kuang:setPosition(19,55)
			item:addChild(kuang)

			local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			icon:setPosition(0,0)
			icon:setAnchorPoint(CCPoint(0, 0))
			kuang:addChild(icon)

			local btn = dbUIButtonScale:buttonWithImage("UI/wish/"..i..".png", 1, ccc3(125, 125, 125))
			btn:setAnchorPoint(CCPoint(0.5,0.5))
			btn:setPosition(CCPoint(48,48))
			btn.m_nScriptClickedHandler = function()
			end
			kuang:addChild(btn)

			local label = CCLabelTTF:labelWithString(CFG.names[i], CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(135,120))
			label:setColor(ccc3(238,143,0))
			item:addChild(label)

			local label = CCLabelTTF:labelWithString("祈福次数：", CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(135,88))
			label:setColor(ccc3(248,196,97))
			item:addChild(label)
			local label = CCLabelTTF:labelWithString(" "..CFG.times[i], CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(230,88))
			label:setColor(ccc3(255,101,4))
			item:addChild(label)

			local label = CCLabelTTF:labelWithString("需要金币：", CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(135,63))
			label:setColor(ccc3(248,196,97))
			item:addChild(label)
			local label = CCLabelTTF:labelWithString(" "..CFG.moneys[i], CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(230,63))
			label:setColor(ccc3(255,101,4))
			item:addChild(label)
			local btn = dbUIButtonScale:buttonWithImage("UI/wish/qf.png", 1, ccc3(125, 125, 125))
			btn:setAnchorPoint(CCPoint(0,0))
			btn:setPosition(CCPoint(135,7))
			btn.m_nScriptClickedHandler = function()
				self:blessYou(i-1)
			end
			item:addChild(btn)
			if i == 1 then
				self.wishBtn = btn
			end
		end
	end,

	addPray = function(self)
		local function opCreatePrayFinishCB(s)		
			if s:getByKey("error_code"):asInt() == -1 then
				--if self.mainWidget then
					--self:addPrayData(s)
				--end
			else
				new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
			end
		end

		local function execCreatePray()
			NetMgr:registOpLuaFinishedCB(Net.OPT_PrayHistory, opCreatePrayFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_PrayHistory, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("idx",self.pray_index)
			
			NetMgr:setOpUnique(Net.OPT_PrayHistory)
			NetMgr:executeOperate(Net.OPT_PrayHistory, cj)
		end
		execCreatePray()
	end,
	
	addPrayData = function(self,data)
		self.pray_index = data:getByKey("last_index"):asInt()
		local length = data:getByKey("message_list"):size()
		for i = 1,length do 
			local messageList = data:getByKey("message_list"):getByIndex(length - i)
			local amount = messageList:getByKey("amount"):asInt()
			local name = messageList:getByKey("name"):asString()
			local item_id = messageList:getByKey("cfg_item_id"):asInt()
			local item_quality = self.cfg_item:getByKey(item_id..""):getByKey("quality"):asInt()
			local cell = dbUIWidget:widgetWithImage("UI/leitai/nothing.png")
			local nameTX = CCLabelTTF:labelWithString(name, SYSFONT[EQUIPMENT], 22) 
			nameTX:setAnchorPoint(CCPoint(0, 0))
			nameTX:setColor(ccc3(255,255,0))
			
			local NINE_ASKTX = CCLabelTTF:labelWithString(NINE_ASK, SYSFONT[EQUIPMENT], 22) 
			NINE_ASKTX:setAnchorPoint(CCPoint(0, 0))
			NINE_ASKTX:setPosition(CCPoint(nameTX:getContentSize().width,0))
			NINE_ASKTX:setColor(ccc3(255,255,255))
			
			local itemTx = CCLabelTTF:labelWithString(self.cfg_item:getByKey(item_id..""):getByKey("name"):asString().."*"..amount, SYSFONT[EQUIPMENT], 22) 
			itemTx:setAnchorPoint(CCPoint(0, 0))
			itemTx:setPosition(CCPoint(nameTX:getContentSize().width + NINE_ASKTX:getContentSize().width,0))
			
			itemTx:setColor(ITEM_COLOR[item_quality])
			
			cell:setContentSize(CCSizeMake(330,nameTX:getContentSize().height + 10)) 
			cell:addChild(nameTX)
			cell:addChild(NINE_ASKTX)
			cell:addChild(itemTx)
			
			self.UIList:insterWidgetAtID(cell,0)
		end
		self.UIList:m_setPosition(CCPoint(0,0))
	end,
	
	blessYou = function(self,index)
		local function opCreateBlessFinishCB(s)
			local error_code = s:getByKey("error_code"):asInt()
			if error_code == -1 or error_code == 2001 then
				local reward_list = s:getByKey("reward_list")
				local items,amounts = {},{}

				for i = 1 , reward_list:size() do
					items[i] = reward_list:getByIndex(i-1):getByKey("cfgItemId"):asInt()
					amounts[i] = reward_list:getByIndex(i-1):getByKey("cfgItem_count"):asInt()
				end
				campRewardGetItems(items,s,amounts)
				GloblePlayerData.gold = s:getByKey("gold"):asInt()
				updataHUDData()
				
				self:addPray()
				if self.mainWidget then
					self:blessYouData(s,index)
				end
				if error_code == 2001 then
					alert("背包已满，无法继续祈福。")
				end
			elseif error_code == 214 then
				new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()]..NINE_FUCK,ccc3(255,255,255),0)
			else
				new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
			end
			GotoNextStepGuide()
		end

		local function execCreateBless()
			NetMgr:registOpLuaFinishedCB(Net.OPT_DragonPraySimple, opCreateBlessFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_DragonPraySimple, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("type",index)

			NetMgr:setOpUnique(Net.OPT_DragonPraySimple)
			NetMgr:executeOperate(Net.OPT_DragonPraySimple, cj)
		end
		execCreateBless()
	end,
--祈福成功结果
	blessYouData = function(self,data,index)
		local length = data:getByKey("reward_list"):size()
		for i = 1,length do
			local messageList = data:getByKey("reward_list"):getByIndex(length - i)
			local item_id = messageList:getByKey("cfgItemId"):asInt()
			local item_count = messageList:getByKey("cfgItem_count"):asInt()
			local item_quality = self.cfg_item:getByKey(item_id..""):getByKey("quality"):asInt()

			local cell = dbUIWidget:widgetWithImage("UI/nothing.png")
			cell:setContentSize(CCSizeMake(330,30))

			local itemTx = CCLabelTTF:labelWithString("祈福获得", CCSize(150,0),0,SYSFONT[EQUIPMENT], 22)
			itemTx:setAnchorPoint(CCPoint(0,0))
			itemTx:setPosition(CCPoint(10,0))
			itemTx:setColor(ccc3(248,196,97))
			cell:addChild(itemTx)

			local itemTx = CCLabelTTF:labelWithString(self.cfg_item:getByKey(item_id..""):getByKey("name"):asString().."*"..item_count, CCSize(350,0),0, SYSFONT[EQUIPMENT], 22)
			itemTx:setAnchorPoint(CCPoint(0, 0))
			itemTx:setPosition(CCPoint(120,0))
			itemTx:setColor(ccc3(255,101,4))
			cell:addChild(itemTx)

			self.UIList:insterWidgetAtID(cell, 0)
		end
		self.UIList:m_setPosition(CCPoint(0,- self.UIList:get_m_content_size().height + self.UIList:getContentSize().height ))
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)

		self.top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(self.top)

		--面板提示图标
		local title_tip_bg = CCSprite:spriteWithFile("UI/wish/tree_tip.png")
		title_tip_bg:setPosition(CCPoint(0, 10))
		title_tip_bg:setAnchorPoint(CCPoint(0, 0))
		self.top:addChild(title_tip_bg)

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			GotoNextStepGuide()
			self:destroy()
		end
		self.top:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
		GlobleWishPanel = nil
		removeUnusedTextures()
	end,
}

function GlobalCreateWishPanel()
	local function opCreateNineFinishCB(s)
		closeWait()
		if s:getByKey("error_code"):asInt() == -1 then
			GlobleWishPanel = new(WishPanel)
			GlobleWishPanel:create(s)
			GotoNextStepGuide()
		elseif s:getByKey("error_code"):asInt() == 214 then
			new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()]..NINE_FUCK,ccc3(255,255,255),0)
		else
			new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
		end
	end

	local function execCreateNine()
		showWaitDialog("waiting tavern data!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_DragonPraySimple, opCreateNineFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_DragonPraySimple, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code",ClientData.request_code)
		cj:setByKey("type",-1)
		NetMgr:executeOperate(Net.OPT_DragonPraySimple, cj)
	end
	execCreateNine()
end
--祈愿树

WishGiftPanel = {

	create = function(self)
		if not self.mainWidget then
			self:initBase()
		end
		self.cfg_item = self.cfg_item ~= nil and self.cfg_item or GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")

		local bg = createDarkBG(930,545)
		bg:setAnchorPoint(CCPoint(0.5, 0))
		bg:setPosition(CCPoint(1010/2, 38))
		self.mainWidget:addChild(bg)

	  local NINE_REWARD =
	  {
		41060001,12100001,12100002,12110001,41070001,41090002,41060003,41060004,12100003,12100004,41060005,41050001,41100002,42200001,13030001,42200002,41070002,12110002,12110003,41050002,42200003,41070003,42200004,41090003,41100001,42200005,42200006,41050003
	  }

		self.UIList = dbUIList:list(CCRectMake(0, 0, 930, 545),0)
		bg:addChild(self.UIList)

		local last_row = 0
		local cur_row_panel = nil
		for i = 1,table.getn(NINE_REWARD) do
			local row = math.floor((i-1)/4)+1
			local column = (i-1)%4 + 1
			if last_row~=row then
				last_row = row
				cur_row_panel = dbUIPanel:panelWithSize(CCSize(930, 136))
				cur_row_panel:setAnchorPoint(CCPoint(0, 0))
				cur_row_panel:setPosition(CCPoint(0,598))
				--分割线
				local line = CCSprite:spriteWithFile("UI/public/line_2.png")
				line:setAnchorPoint(CCPoint(0,0))
				line:setScaleX(930/28)
				line:setPosition(0,0)
				cur_row_panel:addChild(line)
				self.UIList:insterWidget(cur_row_panel)
			end

			local item_info = findShowItemInfo(NINE_REWARD[i])

			local box_panel = dbUIPanel:panelWithSize(CCSize(177, 136))
			box_panel:setAnchorPoint(CCPoint(0,0.5))
			box_panel:setPosition(30+(column-1)*228,136/2)
			box_panel.m_nScriptClickedHandler = function(ccp)
				ItemClickHandler({item=item_info,from="view"})
			end
			cur_row_panel:addChild(box_panel)
			
			local box = CCSprite:spriteWithFile("UI/wish/box_bg.png")
			box:setAnchorPoint(CCPoint(0,0.5))
			box:setPosition(0,136/2)
			box_panel:addChild(box)
			
			local item_panel = dbUIPanel:panelWithSize(CCSize(80, 80))
			item_panel:setPosition(CCPoint(-20, 75/2+65))
			item_panel:setAnchorPoint(CCPoint(0,0.5))
			box_panel:addChild(item_panel)
			
			local item1 = new(BaoGuo_BackpackSingleItem):create(item_info,{item=item_info,from="view",qualityBorder=false})
			item1:setPosition(CCPoint(40, 40))
			item1:setAnchorPoint(CCPoint(0.5,0.5))
			item_panel:addChild(item1)

			local item_quality = self.cfg_item:getByKey(NINE_REWARD[i]..""):getByKey("quality"):asInt()
			local itemTx = CCLabelTTF:labelWithString(self.cfg_item:getByKey(NINE_REWARD[i]..""):getByKey("name"):asString(),CCSize(200,0),0, SYSFONT[EQUIPMENT], 22)
			itemTx:setAnchorPoint(CCPoint(0,0.5))
			itemTx:setPosition(CCPoint(55,136/2))
			itemTx:setColor(ITEM_COLOR[item_quality])
			box_panel:addChild(itemTx)
		end
		self.UIList:m_setPosition(CCPoint(0,- self.UIList:get_m_content_size().height + self.UIList:getContentSize().height ))
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)

		self.top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(self.top)

		--面板提示图标
		local title_tip_bg = CCSprite:spriteWithFile("UI/wish/jp.png")
		title_tip_bg:setPosition(CCPoint(0, 10))
		title_tip_bg:setAnchorPoint(CCPoint(0, 0))
		self.top:addChild(title_tip_bg)

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.top:addChild(closeBtn.btn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
		removeUnusedTextures()
	end,
}

function GlobalCreateWishGiftPanel()
	GlobleWishGiftPanel = new(WishGiftPanel)
	GlobleWishGiftPanel:create(s)
end
--处理物品点击事件
function ItemClickHandler(cfg)
	if cfg.callbacks==nil then
		cfg.callbacks= {}
	end
	new(ItemDialog):create(cfg)
end

--刷新背包處理
function RefreshItem(callback)
	--OPT_Item
	local function opItemFinishCB(s)
		WaitDialog.closePanelFunc()
		local error_code = s:getByKey("error_code"):asInt()		
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else	
			--获取全部道具	
			GloblePlayerData.xiang = nil
			GloblePlayerData.xiang = new({})
			GloblePlayerData.xiang[1] = 0
			GloblePlayerData.xiang[2] = 0
			GloblePlayerData.xiang[3] = 0
			GloblePlayerData.xiang[4] = 0
			GloblePlayerData.xiang[5] = 0
			GloblePlayerData.bingfu = nil
			GloblePlayerData.bingfu = new({})
			GloblePlayerData.baoshi = nil
			GloblePlayerData.baoshi = new({})
			GloblePlayerData.skill_reset_operator = 0
			mappedItemData(s)
			
			if callback then
				callback()
			end
		end
		checkBaoguoCapacityEnough()		--检查背包状态
	end	
	
	local function execItem()
		showWaitDialogNoCircle("waiting Item!")
		local action = Net.OPT_Item
		NetMgr:registOpLuaFinishedCB(action, opItemFinishCB)
		NetMgr:registOpLuaFailedCB(action, opFailedCB)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(action, cj)
	end
	execItem()
end

--使用物品
function UseItem(ccp,param,callback)
	local item = param.item~=nil and param.item or param
	local callback = param.callback~=nil and param.callback or callback
	local self = param.self
	
	local isUsingAll = false
	if item.id == 0 then
		return
	end

	local function opUsingFinishCB(s)
		closeWait()
		
		local error_code = s:getByKey("error_code"):asInt()		
		if error_code > 0 and error_code~=708 then
			if error_code == 2001 then
				alert("背包空间不足，无法打开礼包。")
			else
				ShowErrorInfoDialog(error_code)
			end
		else
			local general_id = s:getByKey("general_base_data"):getByKey("general_id"):asInt()
			--原来的宠物属性
			local general = findGeneralByGeneralId(general_id)
			local old_hp = general.health_point_max
			local old_physical_attack = general.physical_attack
			local old_physical_defence = general.physical_defence
			local old_spell_attack = general.spell_attack
			local old_spell_defence = general.spell_defence
			local old_speed = general.speed
			local old_critic = general.critic
			local old_hit = general.hit
			local old_dodge = general.dodge
			------------------------------
			
			local im = nil
			
			if item.item_id==777777 then --把金币当作物品，特殊处理
				im = {amount=item.amount,type=777777}
			else
				im = findItemByItemId(item.item_id)
			end
			
			local tick_time = 2
			--是否是装备
			if im.amount <= 1 and im.type ~= 2 or isUsingAll then
				im.id = 0
			elseif im.type ~= 2 then
				im.amount = im.amount - 1
			end
			needRefreshItems = false
			
			showWaitDialogNoCircle()
			mappedPlayerUsingSimpleData(s,general_id)
			--新旧差值
			local data={
					 general.health_point_max - old_hp,
					 general.physical_attack - old_physical_attack,
					 general.physical_defence - old_physical_defence,
					 general.spell_attack - old_spell_attack,
					 general.spell_defence - old_spell_defence,
					 general.speed - old_speed,
					 general.critic - old_critic,
					 general.hit - old_hit,
					 general.dodge - old_dodge 
			}
			--属性差值
			local text={
						data[1]==0 and "" or "生命" .. ((data[1]>0 and "+" or "") .. data[1] .."\n"),
						data[2]==0 and "" or "物攻" .. ((data[2]>0 and "+" or "") .. data[2] .."\n"),
						data[3]==0 and "" or "物防" .. ((data[3]>0 and "+" or "") .. data[3] .."\n"),
						data[4]==0 and "" or "法攻" .. ((data[4]>0 and "+" or "") .. data[4] .."\n"),
						data[5]==0 and "" or "法防" .. ((data[5]>0 and "+" or "") .. data[5] .."\n"),
						data[6]==0 and "" or "速度" .. ((data[6]>0 and "+" or "") .. data[6] .."\n"),
						data[7]==0 and "" or "暴击" .. ((data[7]>0 and "+" or "") .. data[7] .."\n"),
						data[8]==0 and "" or "命中" .. ((data[8]>0 and "+" or "") .. data[8] .."\n"),
						data[9]==0 and "" or "闪避" .. ((data[9]>0 and "+" or "") .. data[9]),
			}
			--整合成一串文字
			local strings=""
			for i=1,9 do
				strings=strings .. text[i]
			end
			text={}
			--如果文字有内容说明 属性有变换，执行动画
			if strings ~=nil and strings ~= "" and im.type == 2 then
				local scene = DIRECTOR:getRunningScene()
				local bgLayer = createCenterWidget()
				local attrmovelabel = CCLabelTTF:labelWithString(strings,SYSFONT[EQUIPMENT],32)
				attrmovelabel:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
				scene:addChild(bgLayer, 99999)
				bgLayer:addChild(attrmovelabel)
				local action = CCMoveTo:actionWithDuration(1, CCPoint(WINSIZE.width / 2, WINSIZE.height / 2+100))
				attrmovelabel:runAction(action)
				local tick_rv
				local function rvlabel()
					local w,h=attrmovelabel:getPosition()
					if	h == WINSIZE.height / 2+100 then
						bgLayer:removeFromParentAndCleanup(true)
						CCScheduler:sharedScheduler():unscheduleScriptEntry(tick_rv)
					end
				end
				tick_rv = CCScheduler:sharedScheduler():scheduleScriptFunc(rvlabel, 0.2, false)
			end
			
			
			if im.type == 2 then
				needRefreshItems = true
				CloseEvent("equip")
			end

 			local tick_id	
			local callbackStaut = true
			local function tick()
				if GloblePanel.mainWidget ~= nil and needRefreshItems then
					GloblePanel:clearMainWidget()
					createWuJiang()
					closeWait()
					needRefreshItems = false
					CCScheduler:sharedScheduler():unscheduleScriptEntry(tick_id)
				elseif needRefreshItems then
					closeWait()
					needRefreshItems = false
					CCScheduler:sharedScheduler():unscheduleScriptEntry(tick_id)
				end
				
				if callback ~= nil and callbackStaut then
					callbackStaut = false
					callback(self)
				end
				GotoNextStepGuide()
			end
			tick_id = CCScheduler:sharedScheduler():scheduleScriptFunc(tick, 0.4, false)
			
			---ERROR_CODE_DESC[708] = "所加体力还不够回满所有\n宠物的血,再吃一个试试"
			if error_code==708 then
				ShowErrorInfoDialog(error_code)
			end
		end
		--使用物品，更新背包状态
		globalUpdateRoleCellCount(s)
	end
	
	local function execUsing(ccp,item)
		showWaitDialogNoCircle("waiting useing!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_UsingSimple, opUsingFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_UsingSimple, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("general_id", GloblePlayerData.generals[GloblePanel.curGenerals].general_id)
		cj:setByKey("item_id", item.item_id)
		NetMgr:executeOperate(Net.OPT_UsingSimple, cj)
	end
	
	local function execUsingAll(ccp,item)
		isUsingAll = true
		showWaitDialogNoCircle("waiting useing!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_UsingAllSimple, opUsingFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_UsingAllSimple, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("general_id", GloblePlayerData.generals[GloblePanel.curGenerals].general_id)
		cj:setByKey("item_id", item.item_id)
		NetMgr:executeOperate(Net.OPT_UsingAllSimple, cj)
	end
	
	if item.amount > 1 and not(item.type == 3 and item.effect_type == 19) then		
		local createBtns = function()
			local btns = {}
			
			local bs = new(ButtonScale)
			bs:create("UI/baoguoPanel/all.png",1.2)
			btns[1] = bs.btn
			btns[1].action = execUsingAll
			btns[1].param = item
				
			local bs = new(ButtonScale)
			bs:create("UI/baoguoPanel/one.png",1.2)
			btns[2] = bs.btn
			btns[2].action = execUsing
			btns[2].param = item
			return btns
		end
		
		local dialogCfg = new(basicDialogCfg)
		local msg = "你拥有多个"..item.name..",您是否要全部使用？"

		dialogCfg.msg = msg
		dialogCfg.btns = createBtns()
		new(Dialog):create(dialogCfg)		
	else
		execUsing(ccp,item)
	end
end

function SellItemAction(ccp,item)
	local createBtns = function()
		local btns = {}
		
		local bs = new(ButtonScale)
		bs:create("UI/public/ok_btn.png",1.2)
		btns[1] = bs.btn
		btns[1].action = SellItem
		btns[1].param = item
			
		local bs = new(ButtonScale)
		bs:create("UI/public/close_btn.png",1.2)
		btns[2] = bs.btn
		btns[2].action = nothing
		return btns
	end
	
	local dialogCfg = new(basicDialogCfg)
	dialogCfg.msg =  "你确定要出售"..item.name..",出售后您将获得"..item.price
	dialogCfg.btns = createBtns()
	new(Dialog):create(dialogCfg)
end

function SellItem(ccp,param)	
	local callback = param.callback
	local self = param.self
	
	local function opSellFinishCB(s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()
		
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			local item = findItemByItemId(param.item_id)
			item.id = 0
			updateSpecialItemData()
			if callback then
				callback(self)
			else
				GloblePanel:clearMainWidget()
				createWuJiang()
			end
		end
		--出售物品，更新背包状态
		globalUpdateRoleCellCount(s)
	end
	
	local function execSell()
		showWaitDialogNoCircle("waiting Selling!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_SellSimple, opSellFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_SellSimple, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("item_id", param.item_id)
		NetMgr:executeOperate(Net.OPT_SellSimple, cj)
	end
	execSell()
end

function UnladeItem(ccp,item)
	local function opUnladeFinishCB(s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()		
		if error_code > 0 then
			if error_code == 2001 then
				alert("背包空间不足，无法卸下装备")
			else
				ShowErrorInfoDialog(error_code)
			end
		else
			local general_id = s:getByKey("general_base_data"):getByKey("general_id"):asInt()
			mappedPlayerUsingSimpleData(s,general_id)
			GloblePanel:clearMainWidget()
			createWuJiang()
			--卸下装备，更新背包状态
			globalUpdateRoleCellCount(s)
		end
	end
	
	local function execUnlade()
		showWaitDialogNoCircle("waiting Unladeing!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_UnEquipSimple, opUnladeFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_UnEquipSimple, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("general_id", GloblePlayerData.generals[GloblePanel.curGenerals].general_id)
		cj:setByKey("part", item.part)
		NetMgr:executeOperate(Net.OPT_UnEquipSimple, cj)
	end
	execUnlade()
end
--物品排序
function itemSort(items)
	local sortFunc = function(a,b)
		if a.require_level ~= b.require_level then
			return a.require_level > b.require_level
		elseif a.quality ~= b.quality then
			return a.quality > b.quality
		elseif a.cfg_item_id ~= b.cfg_item_id then
			return a.cfg_item_id > b.cfg_item_id
		elseif a.part ~= b.part then
			return a.part > b.part	
		else
			return a.item_id > b.item_id
		end		
	end
	table.sort(items,sortFunc)
end
--給C++調用
function getItemBorder(item_id,amount)
	local item_info = findShowItemInfo(item_id)
	if amount ~= nil then
		item_info.amount = amount
	end
	local item = new(BaoGuo_BackpackSingleItem)
	item:create(item_info,{item=item_info,from="view"})
	return item.itemBorder
end

--更新背包格子数
globalUpdateRoleCellCount = function(s)
	if s:getByKey("cell_count"):asInt() > 0 then
		GloblePlayerData.cell_count = s:getByKey("cell_count"):asInt()
	end
	checkBaoguoCapacityEnough()	--更新背包格子数后，更新背包状态
end

--向服务器端发扩展背包请求
function execExtendBaoguo(extendCount, callback)
	local function opExtendBaoguoFinishedCB(s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()
		if error_code == -1 then
			globalUpdateRoleCellCount(s)
			GloblePlayerData.gold = s:getByKey("gold"):asInt()
			updataHUDData()
			if callback then
				callback()
			end
		else
			ShowErrorInfoDialog(error_code)
		end
	end
	local function opExtendBaoguoFailedCB(s)
		closeWait()
	end
	
	showWaitDialogNoCircle("waiting extendBaoguo data")
	NetMgr:registOpLuaFinishedCB(Net.OPT_CellIncrease, opExtendBaoguoFinishedCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_CellIncrease, opExtendBaoguoFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code",ClientData.request_code)
	cj:setByKey("extend_count", extendCount)
	NetMgr:executeOperate(Net.OPT_CellIncrease, cj)
end

--获取放在背包里的物品数量
function getBaoguoItemCount()
	local count = 0
	for i = 1 , #GlobleItemsData do
		if not(GlobleItemsData[i].isEquip)	and GlobleItemsData[i].id ~= 0 
		   and not(GlobleItemsData[i].type==5 and GlobleItemsData[i].effect_type==17) --勋章不显示
		then	
			count = count + 1
		end
	end
	return count
end
--背包是否有足够的空间存放物品，更新HUD中的状态
capacityEnough = nil		--满
function checkBaoguoCapacityEnough()
	local baoguoCount = getBaoguoItemCount()
	if GloblePlayerData.cell_count <= baoguoCount then
		--更新HUD中背包的"满"
		local hud = dbHUDLayer:shareHUD2Lua()
		if not hud then return end
		local baoguo = hud:getChildByTag(302)
		if not capacityEnough then
			CCSpriteFrameCache:sharedSpriteFrameCache():addSpriteFramesWithFile("UI/HUD/HUD.plist")
			capacityEnough =  CCSprite:spriteWithSpriteFrameName("UI/HUD/full.png")
			capacityEnough:setAnchorPoint(CCPoint(0, 0.5))
			capacityEnough:setPosition(CCPoint(15, 70))
			capacityEnough:registerScriptHandler(function(eventType)
				if eventType == kCCNodeOnExit then
					capacityEnough = nil
				end
			end)
			baoguo:addChild(capacityEnough)
		end
		capacityEnough:setIsVisible(true)
	else
		--去除HUD中背包的"满"
		if capacityEnough then
			capacityEnough:setIsVisible(false)
		end
	end
end
--[[
	背包 面板  只显示武器，在武将界面用到
]]--
BaoGuoWeaponPanel = {
    scrollArea = nil,
    bg = nil,
	form = nil,
	page = nil,
	bbi = nil,
	
    create = function (self)
		local bg = createDarkBG(485,545)
		bg:setAnchorPoint(CCPoint(0, 0))
		bg:setPosition(487, 38)
		self.bg = bg
		
		local innerPanel = dbUIPanel:panelWithSize(CCSize(485,545))
		innerPanel:setAnchorPoint(CCPoint(0, 0))
		innerPanel:setPosition(2,82)
		self.bg:addChild(innerPanel)
		
        local bbi = new(BaoGuo_Backpack)
		bbi:create(GlobleItemsData)
		self.bbi = bbi
		local backpackPanel,backpackCount = bbi.backpackPanel,bbi.pageCount
		
		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(backpackPanel, 1, backpackCount)
        self.scrollArea:setAnchorPoint(CCPoint(0, 0))
        self.scrollArea:setScrollRegion(CCRect(0, 0, 485, 456))
        self.scrollArea:setPosition(0,0)
		self.scrollArea.pageChangedScriptHandler = function(page)
			GloblePanel.curItemPackbackPage = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[page+1])
			bbi:create(GlobleItemsData)
		end
		innerPanel:addChild(self.scrollArea)
		
		self:createPageDot(backpackCount)
		
		local tempPage = GloblePanel.curItemPackbackPage
		if tempPage~=1 then
			self.scrollArea:scrollToPage(tempPage-1,false)
		end
    end,
	
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 80))
		self.form:setPosition(485/2, 0)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.bg:addChild(self.form)
		
		self.pageToggles = {}
		for i=1, pageCount do
			local normalSpr = CCSprite:spriteWithFile("UI/public/page_btn_normal.png")
			local togglelSpr = CCSprite:spriteWithFile("UI/public/page_btn_toggle.png")		
			local pageToggle = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
			pageToggle:setPosition(CCPoint(52*(i-1),40) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[1])
	end,
}

BaoGuo_Backpack = {
	showItems = nil,
	backpackPanel = nil,
	singlePanel = nil,
	pageCount = nil,
	itemPos = nil, --供新手引导用的
	
	create = function(self,items)
		local class = GloblePanel.curItemPackbackClass
		local page = GloblePanel.curItemPackbackPage
		local count = 0
		self.showItems = new({})
		for i = 1 , table.getn(items) do
			if (
				(class == 99  or (class == 2 and class == items[i].type) or 
					(class == 3 and class == items[i].type and items[i].effect_type ~= 0 and items[i].effect_type ~= 9 and items[i].effect_type ~= 11)
				) or 
				(class == 4 and 
					( class == items[i].type or items[i].effect_type == 11 or items[i].effect_type == 9 or 
						(items[i].effect_type == 0 and items[i].type ~= 2 ) or
						(items[i].type == 3 and items[i].effect_type == 19)
					)
				)
			) and not(items[i].isEquip) and items[i].id ~= 0 and items[i].type == 2 and items[i].effect_type ~= 11 then
				count = count + 1
				self.showItems[count] = items[i]
			end
		end
		itemSort(self.showItems)
		self.pageCount = (count - count%16) / 16 + 1
        self.backpackPanel = dbUIPanel:panelWithSize(CCSize(485 * self.pageCount, 456))
		
		if self.singlePanel == nil then
			self.singlePanel = new(BaoGuo_BackpackSinglePage)
			self.singlePanel:create(self.pageCount)
			for i = 1, table.getn(self.singlePanel.panel) do
				self.singlePanel.panel[i]:setPosition(CCPoint((i - 1) * 485, 0))
				self.backpackPanel:addChild(self.singlePanel.panel[i])
			end
		end

        local count = 1 
		local cellCount = table.getn(self.showItems) - table.getn(self.showItems)%16 + 16
	    for i = 1 , cellCount do
			if i > (page-1)*16 and i <= page*16 then
				local itembg = dbUIWidget:widgetWithImage("UI/public/kuang_96_96.png")
				itembg:setAnchorPoint(CCPoint(0, 0))
				itembg:setTag(6533)
				local outKuang = self.singlePanel.items[count]
				outKuang:addChild(itembg)
				local classItem = new(BaoGuo_BackpackSingleItem)
				local cfg = {
					item = self.showItems[count],
					mine = true,
					from = "hero_baoguo",
				}
				if classItem:create(self.showItems[count],cfg) then
					classItem.itemBorder:setTag(6532)
					self.singlePanel.items[count]:addChild(classItem.itemBorder)
	                self.singlePanel.classItems[count] = classItem
					
					if i == 1 and self.itemPos==nil then
						local x,y = outKuang:getPosition()
						self.itemPos = {x=x,y=y} --新手引导时用到
						self.outKuang = outKuang
					end	
				end
			else
				local item = self.singlePanel.items[count]:getChildByTag(6532)
				local bg = self.singlePanel.items[count]:getChildByTag(6533)
				
				if item ~= nil then
					item:removeFromParentAndCleanup(true)
				end
				
				if bg ~= nil then
					bg:removeFromParentAndCleanup(true)
				end
			end
			count = count + 1
		end	
	end,
}
BaoGuo_BackpackSinglePage = {
    panel = {},
    row = 4,
    col = 4,
	items = {},
	classItems = {},
    
    create = function (self,backpackCount)
		self.items = new({})
		self.panel = new({})
		local count = 1
		for k = 1 , backpackCount do		
			self.panel[k] = dbUIPanel:panelWithSize(CCSize(485,456))
			self.panel[k]:setPosition(0, 0)			
			for i = 1, self.row do
				for j = 1, self.col do
					local itembg = dbUIPanel:panelWithSize(CCSize(96, 96))
					itembg:setAnchorPoint(CCPoint(0, 0))
					itembg:setPosition(CCPoint(20+(j - 1) * 115, (self.row - i) * 115))
					self.panel[k]:addChild(itembg)
					
					self.items[count] = itembg
					count = count + 1
				end
			end
		end
    end
}

BaoGuo_BackpackSingleItem = {
	itemBorder = nil,
	itemCount = nil,
	itemEntity = nil,
	
	create = function(self,item,cfg)
		if item == nil then
			return nil
		end
		self.itemBorder = dbUIPanel:panelWithSize(CCSize(96,96)) 
		self.itemBorder:setAnchorPoint(CCPoint(0, 0))
		self.itemBorder:setPosition(CCPoint(0,0))

		--装备品质
		if item.quality>1 and (cfg.qualityBorder==nil or cfg.qualityBorder==true) then
			local coloricon = CCSprite:spriteWithFile(ITEM_QUALITY[item.quality])
			coloricon:setPosition(0,0)
			coloricon:setAnchorPoint(CCPoint(0, 0))
			self.itemBorder:addChild(coloricon)
		end

		local btn = dbUIButtonScale:buttonWithImage("icon/Item/icon_item_"..item.icon..".png",1.2,ccc3(152,203,0))
		self.itemEntity = btn
		self.itemEntity:setPosition(CCPoint(self.itemBorder:getContentSize().width / 2,self.itemBorder:getContentSize().height / 2))
		self.itemEntity:setAnchorPoint(CCPoint(0.5, 0.5))
		self.itemEntity:setScale(0.8*96/btn:getContentSize().width)
		self.itemEntity.m_nScriptClickedHandler = function(ccp)
			ItemClickHandler(cfg)
			GotoNextStepGuide()
		end
		self.itemBorder:addChild(self.itemEntity)

		if item.amount > 1 then
			self.itemCount = CCLabelTTF:labelWithString(item.amount, SYSFONT[EQUIPMENT], 37)
			self.itemCount:setAnchorPoint(CCPoint(1, 0))
			self.itemCount:setPosition(CCPoint(64,0))
			self.itemBorder:addChild(self.itemCount)
		end
				
		return self.itemBorder
	end,
}
local getExtendCost = function(n)
		local autoExtendCellInfo = {
			{lv = 50, cell = 8},
			{lv = 60, cell = 8},
			{lv = 70, cell = 8},
			{lv = 80, cell = 8},
		} 
		local baseCell = 24
		local count = GloblePlayerData.cell_count - 24
		for i = 1, #autoExtendCellInfo  do
			if GloblePlayerData.officium >= autoExtendCellInfo[i].lv then
				count = count - autoExtendCellInfo[i].cell
			else
				break
			end
		end
		
		local d = 2
		local a1 = 2 * (count + 1)
		local sum = a1 * n + n * (n - 1) / 2 * d
		return sum
end

--显示背包界面
function globleShowBaoGuoPanel()
	local baoGuoPanel = new(BaoGuoPanel)
	baoGuoPanel:create()
	G_BaoGuoPanel = baoGuoPanel
	GotoNextStepGuide()
end

--给宝石增加等级标志
function AddLevelForBaoshi(baoshiBtn,cfg_item_id,pos)
	local label = CCLabelTTF:labelWithString(""..cfg_item_id % 100, SYSFONT[EQUIPMENT], 24)
	label:setAnchorPoint(CCPoint(0, 1))
	label:setPosition(CCPoint(10,80))
	baoshiBtn:addChild(label,10,10)
end

BaoGuoPanel = {
    darkBg = nil,
	pageCount = 1,
	page = 1, --当前页
	pagePanels = nil, -- {panel=singlePagePanel,items={},page=page,loaded=false}
	mainWidget = nil,
	showItems = {},
	kuangs  ={}, --物品展位框
	class = 99, --装备分类，若这里是99则进入默认是“全部”
	
	itemSelectedEffectNeedRemove = false,	--物品选中效果在切换时是否需要释放，因为flash()之后会自动删除选中效果
	itemSelectedEffectIndex = nil,			--物品消耗后，由于flash(),故需要保存选中物品的index
	
    create = function (self)
    	self:initBase()
    	self:initCallbacks()
    	self:loadShowItems()
		self:createMain()
    end,
    
	createMain = function(self)
    	self.darkBg = createDarkBG(932,546)
    	self.darkBg:setAnchorPoint(CCPoint(0.5, 0))
    	self.darkBg:setPosition(CCPoint(1010/2,38))
    	self.mainWidget:addChild(self.darkBg)
    	
    	if self.class == 99 then	--在全部下，才显示背包容量
    		local capacity = #self.showItems.."/"..GloblePlayerData.cell_count
    		local capacityLabel = CCLabelTTF:labelWithString(capacity, CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 26)
    		capacityLabel:setAnchorPoint(CCPoint(0, 0.5))
    		capacityLabel:setPosition(CCPoint(40, 40))
    		if #self.showItems >= GloblePlayerData.cell_count - 2 then
    			capacityLabel:setColor(ccc3(255, 0, 0))
    		else
    			capacityLabel:setColor(ccc3(255, 204, 153))
    		end
    		self.darkBg:addChild(capacityLabel)
    	end
    	
   		self:createPageScroll()
    	self:loadPage(self.page)
	end,
	
	--切换标签时刷新背包
	reflash = function(self,class)
		if class~= self.class then
			self.page = 1
		end
		if self.darkBg then
			self.mainWidget:removeAllChildrenWithCleanup(true)
			self.kuangs = {}
			self.showItems = {}
			self.pagePanels = {}
			self.pageCount = 1
			self.class = class
			self.itemSelectedEffectNeedRemove = false	--由于self.mainWidget:removeAllChildrenWithCleanup(true),选中效果已经remove,故无需再释放
		end
		
    	self:loadShowItems()
		self:createMain()
	end,
	
	initCallbacks = function(self)
		self.callbacks = {
			useCallBack = function(self)
				self:reflash(self.class)
			end,
			sellCallBack = function(self)
				self:reflash(self.class)
			end,
		}
	end,
	
	--创建滑动分页部分
	createPageScroll = function(self)
		local pagePanelContainer = dbUIPanel:panelWithSize(CCSize(932 * self.pageCount,431))
		pagePanelContainer:setAnchorPoint(CCPoint(0, 0))
		pagePanelContainer:setPosition(0,0)
		
		self.pagePanels = new({})
		for i=1,self.pageCount do
			local singlePage = self:createSinglePage(i)
			pagePanelContainer:addChild(singlePage)
		end
		
		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pagePanelContainer, 1, self.pageCount)
        self.scrollArea:setAnchorPoint(CCPoint(0, 0))
        self.scrollArea:setScrollRegion(CCRect(0, 0, 932, 431))
        self.scrollArea:setPosition(0,85)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self:removeItemSelectedEffect()		--换页，物品选中效果消失
			self.page = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
			self:loadPage(self.page)
		end
		self.darkBg:addChild(self.scrollArea)
		self:createPageDot(self.pageCount)
		self.scrollArea:scrollToPage(self.page-1,false)
	end,
	
	createSinglePage = function(self,page)
		local singlePagePanel = dbUIPanel:panelWithSize(CCSize(932,431))
		singlePagePanel:setAnchorPoint(CCPoint(0, 0))
        singlePagePanel:setPosition((page-1)*932,0)
       
        local pagePanel = {panel=singlePagePanel,items={},itemInfos={},page=page,loaded=false}
        self.pagePanels[page] = pagePanel
        return singlePagePanel
	end,
	
	--加载某一页的数据
	loadPage = function(self,page)
		local pagePanel = self.pagePanels[page]
		if pagePanel.loaded then
			return
		end
		
		local sum = table.getn(self.showItems)				--物品总数
		local start = (page-1)*32 + 1						--该页上需要放置的物品起始
		local ends = start-1+32>sum and sum or start+32-1	--该页上需要放置的物品终止
		
		
		--空的框框
		for row=1, 4 do
			for column=1,8 do
				--当前位置
				local offset = (row-1) * 8 + column		--当前页的偏移
				local index = (page-1) * 32 + offset	--总数量的index
				
				local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
				icon:setPosition(0,0)
				icon:setAnchorPoint(CCPoint(0, 0))
				
				local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
				kuang:setAnchorPoint(CCPoint(0, 0))
				kuang:setPosition(23+(column-1)*112, 333-(row-1)*110)
				kuang:addChild(icon)
				pagePanel.panel:addChild(kuang)
				pagePanel.items[offset] = kuang
				
				--全部分类下该位置还未解锁
				if self.class == 99 and index > GloblePlayerData.cell_count then
					local itemBtn = new(ButtonScale)
					itemBtn:create("UI/baoguoPanel/lock.png", 1)
					itemBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
					itemBtn.btn:setPosition(96/2, 96/2)
					itemBtn.btn.m_nScriptClickedHandler = function(ccp)
						local extendCnt = index - GloblePlayerData.cell_count
						local extendCost = getExtendCost(extendCnt)
						local nextExtendLevel = 50
						local unlock_dtp = new(DialogTipCenterPanel)
						unlock_dtp:create(nextExtendLevel.."级自动解锁8个格子\n是否花"..(extendCost).."金币解锁"..extendCnt.."个格子",ccc3(255,204,153),180)
						unlock_dtp.okBtn.m_nScriptClickedHandler = function()
							unlock_dtp:destroy()
							local function unlockBaoguo()
								self:reflash(self.class)
							end
							execExtendBaoguo(extendCnt, unlockBaoguo)
						end
					end
					kuang:addChild(itemBtn.btn)
				
				--该位置需要放物品
				elseif start + offset - 1 <= ends then
					local item = self.showItems[start + offset - 1]
					--装备的不同框的颜色不同
					if  (item.type==2 or (item.type==4 and item.effect_type==9)) and item.quality>1 then
						local coloricon = CCSprite:spriteWithFile(ITEM_QUALITY[item.quality])
						coloricon:setPosition(0,0)
						coloricon:setAnchorPoint(CCPoint(0, 0))
						kuang:addChild(coloricon)
					end
					--物品按钮
					local itemBtn = new(ButtonScale)
					itemBtn:create("icon/Item/icon_item_"..item.icon..".png",1.2)
					itemBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
					itemBtn.btn:setPosition(96/2, 96/2)
					itemBtn.btn:setScale(96/itemBtn.btn:getContentSize().width)
					itemBtn.btn.m_nScriptClickedHandler = function(ccp)
						self:createItemSelectedEffect(kuang, offset)	--index范围1~32
						local cfg = {
							item = item,
							--ccp = ccp,
							sender = self,
							callbacks = self.callbacks,
							from  = "baoguo",
							mine = true,
							parent = self
						}
						ItemClickHandler(cfg)
						GotoNextStepGuide()
					end
					kuang:addChild(itemBtn.btn)
					pagePanel.itemInfos[offset] = item

					--数量
					if item.amount > 1 then
						local text = item.type ~= 99 and item.amount or public_chageShowTypeForMoney(item.amount,true,9999)
						local countLabel = CCLabelTTF:labelWithString(text, SYSFONT[EQUIPMENT], 37)
						countLabel:setAnchorPoint(CCPoint(1, 0))
						countLabel:setPosition(CCPoint(kuang:getContentSize().width-3,0))
						kuang:addChild(countLabel)
					end
					
					--宝石
					if item.type==4 and item.effect_type==9 then
						AddLevelForBaoshi(kuang,item.cfg_item_id,CCPoint(19,60))
					end	
				end 
			end
		end
		
		--flash之后， 如果index不为nil,且该空格上有物品，则自动选中
		if self.itemSelectedEffectIndex ~= nil then
			local itemCnt = ends - start + 1	--当前页显示的总数量
			if self.itemSelectedEffectIndex < itemCnt then 
				self:createItemSelectedEffect(pagePanel.items[self.itemSelectedEffectIndex], self.itemSelectedEffectIndex)
			else
				self.itemSelectedEffectIndex = nil
			end
		end
		
		pagePanel.loaded = true
	end,
	
	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 80))
		self.form:setPosition(932/2, 0)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.darkBg:addChild(self.form)
		self.pageToggles = {}
		for i=1, pageCount do
			local normalSpr = CCSprite:spriteWithFile("UI/public/page_btn_normal.png")
			local togglelSpr = CCSprite:spriteWithFile("UI/public/page_btn_toggle.png")		
			local pageToggle = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
			pageToggle:setPosition(CCPoint(52*(i-1),40) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
		
		--刷新按钮
		local reflashBtn = new(ButtonScale)
		reflashBtn:create("UI/baoguoPanel/reflash.png",1.2)
		reflashBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		reflashBtn.btn:setPosition(830, 43)
		reflashBtn.btn.m_nScriptClickedHandler = function(ccp)
			RefreshItem()
			self:reflash(self.class)
		end
		self.darkBg:addChild(reflashBtn.btn)
	end,
	
	--加载要显示的物品
	loadShowItems = function(self)
		local count = 0
		local items,class = GlobleItemsData,self.class
		self.showItems = new({})
		for i = 1 , table.getn(items) do
			if (
				class == 99
				or (class == 2 and class == items[i].type)
				or (class == 3 and class == items[i].type and items[i].effect_type ~= 0 )
				or (class == 4 and 
					( 
					  class == items[i].type 
					  or items[i].effect_type == 9 
					  or (items[i].effect_type == 0 and items[i].type ~= 2)
					)
				)
			) and not(items[i].isEquip)
			  and not(items[i].type==5 and items[i].effect_type==17) --勋章不显示
			  and items[i].id ~= 0 then
				count = count + 1
				self.showItems[count] = items[i]
			end
		end
		itemSort(self.showItems)
		if class == 99 then --只在全部下才显示锁定格子
			self.pageCount = math.max(4, getPageCount(GloblePlayerData.cell_count,32))
		else
			self.pageCount = getPageCount(count,32)
		end
		if self.page > self.pageCount then
			self.page = self.pageCount
		end
	end,
	
	--初始化界面，包括头部，背景
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

    	self.bgLayer = createPanelBg()
        self.uiLayer,self.centerWidget = createCenterWidget()
       
		self.mainWidget = createMainWidget()

        scene:addChild(self.bgLayer, 1000)
	    scene:addChild(self.uiLayer, 2000)

	    local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
	    bg:setPosition(CCPoint(1010/2, 702/2)) 
	    self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)
    
		local topbtn = new(BaoGuoTopButton)
		topbtn:create()
		self.topBtns = topbtn.toggles
		self.closeBtn = topbtn.closeBtn		
		self.centerWidget:addChild(topbtn.bg,100)
		topbtn:toggle(1)	
		--注册开关切换事件
		for i = 1 , table.getn(topbtn.toggles) do
			topbtn.toggles[i].m_nScriptClickedHandler = function()
				if (topbtn.toggles[i]:isToggled()) then
					if i == 1 then
						self:reflash(99)
					end
					if i == 2 then
						self:reflash(3)
					end
					if i == 3 then
						self:reflash(2)
					end
					if i == 4 then
						self:reflash(4)
					end
				end
				topbtn:toggle(i)
			end
		end
		
		--关闭按钮
		topbtn.closeBtn.m_nScriptClickedHandler = function()		
			self:destroy()
			GotoNextStepGuide()
		end		
	end,
	
	--创建物品选中时的效果
	createItemSelectedEffect = function(self, item, index)
		if self.itemSelectedEffectNeedRemove then
			if self.itemSelectedEffect ~= nil then
				self.itemSelectedEffect:removeFromParentAndCleanup(true)
				self.itemSelectedEffect = nil
			end
		else
			self.itemSelectedEffect = nil
		end
		self.itemSelectedEffect = CCSprite:spriteWithFile("UI/qiang_hua/kuang_light.png")
		self.itemSelectedEffect:setAnchorPoint(CCPoint(0.5, 0.5))
		self.itemSelectedEffect:setPosition(CCPoint(item:getContentSize().width / 2, item:getContentSize().height / 2))
		self.itemSelectedEffect:setScale(self.itemSelectedEffect:getContentSize().width / item:getContentSize().width)
		
		self.itemSelectedEffectNeedRemove = true
		self.itemSelectedEffectIndex = index
		
		item:addChild(self.itemSelectedEffect)
	end, 
	removeItemSelectedEffect = function(self)
		if self.itemSelectedEffectNeedRemove then
			if self.itemSelectedEffect ~= nil then
				self.itemSelectedEffect:removeFromParentAndCleanup(true)
				self.itemSelectedEffect = nil
			end
			self.itemSelectedEffectNeedRemove = false
			self.itemSelectedEffectIndex = nil	--只在手动remove的时候置nil，自动remove的时候用来保存flash之后的值，重新create
		else
			self.itemSelectedEffect = nil
		end
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
        self.bgLayer = nil
        self.uiLayer = nil
        self.topBtns = nil
        self.centerWidget = nil
        self.mainWidget = nil
        G_BaoGuoPanel= nil
        removeUnusedTextures()
    end
}

BaoGuoTopButton = {
	bg = nil,
	toggles = {},
	closeBtn = nil,
	backBtn = nil,
	
	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(0,598))
		for i = 1 , table.getn(BaoGuoTopBtnConfig) do		
			local btn = dbUIButtonToggle:buttonWithImage(BaoGuoTopBtnConfig[i].normal,BaoGuoTopBtnConfig[i].toggle)
			btn:setAnchorPoint(CCPoint(0, 0))
			btn:setPosition(BaoGuoTopBtnConfig[i].position)
			self.toggles[i] = btn
			self.bg:addChild(btn)
		end

		--面板提示图标
		local nice = CCSprite:spriteWithFile("UI/baoguoPanel/nice.png")			
		nice:setPosition(CCPoint(0, 10))
		nice:setAnchorPoint(CCPoint(0, 0))
		self.bg:addChild(nice)
		--帮助按钮
		local helpBtn = new(ButtonScale)
		helpBtn:create("UI/public/helpred.png",1.2,ccc3(255,255,255))			
		helpBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		helpBtn.btn:setPosition(CCPoint(874, 44))
		self.bg:addChild(helpBtn.btn,1)
		
		local text = "当神位等级达到50级、60级、70级、80级、90级，系统将自动解锁8格背包，花费金币可以无视等级条件直接解锁。"
		helpBtn.btn.m_nScriptClickedHandler = function()
	        local dialogCfg = new(basicDialogCfg)
			--dialogCfg.title = "攻城战说明"
			dialogCfg.msg = text
			dialogCfg.msgAlign = "center"
			dialogCfg.bg = "UI/baoguoPanel/kuang.png"
			dialogCfg.dialogType = 5
			dialogCfg.msgSize = 30
			dialogCfg.size = CCSize(1010 / 2,0);
			local dialog = new(Dialog)
			dialog:create(dialogCfg)
		end
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))			
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		self.bg:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
	end,
	
	--切换
	toggle = function(self,topid)
		public_toggleRadioBtn(self.toggles,self.toggles[topid])
	end
}
BaoGuoTopBtnConfig = {
	{
		normal = "UI/baoguoPanel/all_1.png",
		toggle = "UI/baoguoPanel/all_2.png",
		position = 	CCPoint(260, 12),
	},
	{
		normal = "UI/baoguoPanel/xh_1.png",
		toggle = "UI/baoguoPanel/xh_2.png",
		position = 	CCPoint(260 + 142, 12),
	},	
	{
		normal = "UI/baoguoPanel/zb_1.png",
		toggle = "UI/baoguoPanel/zb_2.png",
		position = 	CCPoint(260 + 142*2, 12),
	},
	{
		normal = "UI/baoguoPanel/cl_1.png",
		toggle = "UI/baoguoPanel/cl_2.png",
		position = 	CCPoint(260 + 142*3, 12),
	},	
}
--创建挂机面板
function globle_Create_Guaji()
	--挂机10级以后开
	if GloblePlayerData.officium < 10 then
		return
	end
	
	local response = function(j)
		local error_code = j:getByKey("error_code"):asInt()
		if error_code ~= -1 then return end
		
		if GlobleGuaJiPanel == nil then
			GlobleGuaJiPanel = new(GuajiPanel)
			GlobleGuaJiPanel:create()
		end
	end

	NetMgr:registOpLuaFinishedCB(Net.OPT_BotStart,response)
	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	NetMgr:executeOperate(Net.OPT_BotStart, cj)
end

function globle_Create_GuajiJiangLi(s)
	local itemid = s:getByKey("cfgItemId"):asInt()
	local prestige = s:getByKey("prestige"):asInt()
	local copper = s:getByKey("copper"):asInt()
	local officium = s:getByKey("officium"):asInt()
	if prestige > 0 or copper > 0 then
		local dialogCfg = new(basicDialogCfg);
		dialogCfg.msg = "挂机获得\n神力："..prestige.."\n银币："..copper
		new(Dialog):create(dialogCfg)
	end
	globalUpdateRoleCellCount(s)
	GlobleUpdateOfficum(officium)
end

function resetWaitHuaJiTime()
	ClientData.waitTime = 0
end

function unscheduleGuaJiTimeHandle()
	ClientData.waitTime = 0
	if GuaJiTimeHandle then
		CCScheduler:sharedScheduler():unscheduleScriptEntry(GuaJiTimeHandle)
		GuaJiTimeHandle = nil
	end
end

function WaitForGuaJi()
	ClientData.waitTime = 0
	local updateTime = function()
		ClientData.waitTime = ClientData.waitTime + 1
		if ClientData.waitTime >= 60 * 5 then  --开始挂机
			unscheduleGuaJiTimeHandle()
			globle_Create_Guaji()
		end
	end

	if GuaJiTimeHandle == nil then
		GuaJiTimeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(updateTime,1,false)
	end
end

function EndGuaJi()
	resetWaitHuaJiTime()
	if GlobleGuaJiPanel then
		GlobleGuaJiPanel:endBot()
	end
end

GuajiPanel = {
	lengQueTx = nil,    	--冷却时间显示
	lengQueTimeTX = nil,    --冷却时间文本
	lengQueTime = nil,    	--冷却时间 秒为单位
	timeHandle = nil,		--时间回调
	exp = nil,
	silver= nil,

	create = function(self)
		self:initBase()

		CCSpriteFrameCache:sharedSpriteFrameCache():addSpriteFramesWithFile("UI/HUD/HUD.plist")
		local bg = CCSprite:spriteWithSpriteFrameName("UI/HUD/gua_ji.png")
		bg:setPosition(CCPoint(512,300))
		self.mainWidget:addChild(bg)

		self.exp = CCLabelTTF:labelWithString("获得 0神力",CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
		self.exp:setAnchorPoint(CCPoint(0,0))
		self.exp:setPosition(CCPoint(113,60))
		self.exp:setColor(ccc3(255,203,101))
		bg:addChild(self.exp)

		self.silver = CCLabelTTF:labelWithString("获得 0银币",CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
		self.silver:setAnchorPoint(CCPoint(0,0))
		self.silver:setPosition(CCPoint(113,37))
		self.silver:setColor(ccc3(255,203,101))
		bg:addChild(self.silver)

		self.lengQueTime = 0
		self.lengQueTimeTX = CCLabelTTF:labelWithString("时间 "..getLenQueTime(self.lengQueTime),CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
		self.lengQueTimeTX:setAnchorPoint(CCPoint(0,0))
		self.lengQueTimeTX:setPosition(CCPoint(113,12))
		self.lengQueTimeTX:setColor(ccc3(255,203,101))
		bg:addChild(self.lengQueTimeTX)
		
		local minutes = 1
		local prestige = math.ceil(GloblePlayerData.officium * GloblePlayerData.officium / 60 + 1)
		local copper = math.ceil(GloblePlayerData.officium * GloblePlayerData.officium / 30 + 3)
		
		local setLengQueTime = function()
			self.lengQueTime = self.lengQueTime + 1
			self.lengQueTimeTX:setString("时间 "..getLenQueTime(self.lengQueTime))
			local m = math.floor(self.lengQueTime / 60)
			if m > minutes and m <=480 then
				self.silver:setString("获得 "..(copper * m).. "银币")
				self.exp:setString("获得 "..(prestige * m).. "神力")
			end
		end

		if self.timeHandle == nil then
			self.timeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(setLengQueTime,1,false)
		end
	end,

	endBot = function(self)
		local response = function(j)
			local error_code = j:getByKey("error_code"):asInt()
			if error_code ~= -1 then return end
			globle_Create_GuajiJiangLi(j)
			self:destroy()
			WaitForGuaJi()
		end

		NetMgr:registOpLuaFinishedCB(Net.OPT_BotEnd,response)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(Net.OPT_BotEnd, cj)
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)

		local bg = dbUIPanel:panelWithSize(WINSIZE)
		bg:setAnchorPoint(CCPoint(0.5,0.5))
		bg:setPosition(WINSIZE.width/2, WINSIZE.height/2)
		self.uiLayer:addChild(bg)
	
		scene:addChild(self.bgLayer, 1000-1)
		scene:addChild(self.uiLayer, 2000-1)

		bg.m_nScriptClickedHandler = function()
			self:endBot()
		end
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer,true)
		scene:removeChild(self.uiLayer,true)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		if self.timeHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
			self.timeHandle = nil
		end
		
		GlobleGuaJiPanel = nil
	end,
}
GlobleZhenFanPanel = nil
GlobalCurZhenFa = nil
function globleShowZhenFaPanel()
	GlobleZhenFanPanel = new(DuiXingPanel):create()
	GotoNextStepGuide()
end
--队形
DuiXingPanel = {
	bgLayer = nil,
	uiLayer = nil,

	create = function (self)
		self:initBase()
		self:createMain()
		return self
	end,

	createMain = function(self)
		self:createBG()
		self:createTop()
		self:createLeft()
		self:createCenter()
	    self:createRight()
	end,
	
	reflash = function(self)
		self:destroyScheduler()
		self.mainWidget:removeAllChildrenWithCleanup(true)
		self.top:removeAllChildrenWithCleanup(true)
		self:createMain()
	end,
	
	createBG = function(self)
		local bg = createDarkBG(282,545)
		bg:setAnchorPoint(CCPoint(0, 0))
		bg:setPosition(CCPoint(40,38))
		self.mainWidget:addChild(bg)

		local bg = createDarkBG(460,545)
		bg:setAnchorPoint(CCPoint(0, 0))
		bg:setPosition(CCPoint(334,38))
		self.mainWidget:addChild(bg)

		local bg = createDarkBG(166,545)
		bg:setAnchorPoint(CCPoint(0, 0))
		bg:setPosition(CCPoint(807,38))
		self.mainWidget:addChild(bg)
	end,
	
	getSelectedFormation = function(self)
		local formation = nil
		if GlobalCurZhenFa==nil or GlobalCurZhenFa<1 then
			local list = GloblePlayerData.formations
			for i = 1 , table.getn(list) do
				if list[i].cfg_formation_id == GloblePlayerData.cur_formation then
					GlobalCurZhenFa	= i
				end
			end
			formation = returnFormationInfo(GloblePlayerData.formations[GlobalCurZhenFa])
		else
			formation = returnFormationInfo(GloblePlayerData.formations[GlobalCurZhenFa])
		end
		return formation
	end,
	
	createTop = function(self)
		local formation = self:getSelectedFormation()
		local top = self.top
		
		--空的框框
		local nice = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		nice:setPosition(CCPoint(-5,16))
		nice:setAnchorPoint(CCPoint(0,0))
		top:addChild(nice)
				
		--名称
		local label = CCLabelTTF:labelWithString(formation.name,CCSize(0,0),0, SYSFONT[EQUIPMENT], 36)
		label:setPosition(CCPoint(10,30))
		label:setAnchorPoint(CCPoint(0.1, 0))
		label:setColor(ccc3(255,204,154))
		top:addChild(label)		

		--等级
		local label = CCLabelTTF:labelWithString(formation.level,CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)
		label:setPosition(CCPoint(135,30))
		label:setAnchorPoint(CCPoint(1, 0))
		label:setColor(ccc3(153,204,1))
		top:addChild(label)
		local label = CCLabelTTF:labelWithString("级",CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)
		label:setPosition(CCPoint(145,30))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(255,204,154))
		top:addChild(label)
		
		local label = CCLabelTTF:labelWithString(string.format(formation.desc,formation.level .. "%"),CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(217,52))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(254,205,52))
		top:addChild(label)
		
		local label = CCLabelTTF:labelWithString("升级要求:",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(470,52))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(254,205,52))
		top:addChild(label)
		local label = CCLabelTTF:labelWithString("神位"..formation.officium,CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(605,52))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(254,205,52))
		top:addChild(label)
		local label = CCLabelTTF:labelWithString("需要战功:",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(217,15))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(254,205,52))
		top:addChild(label)					
		local label = CCLabelTTF:labelWithString(formation.exploit_need,CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(350,15))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(254,205,52))
		top:addChild(label)
		local label = CCLabelTTF:labelWithString("剩余战功:",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(470,15))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(254,205,52))
		top:addChild(label)	
		local label = CCLabelTTF:labelWithString(GloblePlayerData.exploit,CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(605,15))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(254,205,52))
		top:addChild(label)
		label:setString(GloblePlayerData.exploit)
		
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 46))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
			GotoNextStepGuide()
		end
		top:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
	end,
	
	createLeft = function(self)
		local formation = self:getSelectedFormation()
		for i=1, 10 do
			--空的框框
			local kuang = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			kuang:setPosition(DuiXingHeroListConfig[i][1])
			kuang:setAnchorPoint(CCPoint(0,0))
			self.mainWidget:addChild(kuang)
			
			local role = GloblePlayerData.generals[i]
			if role and not(role.is_del) then
				local dragable = dbUIWidgetDragable:widgetDragable(CCSprite:spriteWithFile("head/Middle/head_middle_"..role.face..".png"))
				dragable:setAnchorPoint(CCPoint(0, 0))
				dragable:setPosition(DuiXingHeroListConfig[i][2])
				self.mainWidget:addChild(dragable)
				
				--显示是否出战
				local isZhan = false
				for j = 1 , table.getn(formation.pos) do
					if formation.pos[j] == role.general_id then
						local z = CCSprite:spriteWithFile("UI/formation/is_select.png")
						z:setAnchorPoint(CCPoint(1,1))
						z:setPosition(CCPoint(kuang:getContentSize().width-5,kuang:getContentSize().height-5))
						kuang:addChild(z)
						isZhan = true
					end
				end
				if not isZhan then
					GlobleNotChuZhanRole = dragable
				end
				dragable.m_nScriptClickedHandler = function(ccp)	
					local role_name = GloblePlayerData.generals[i].name
					local level = GloblePlayerData.generals[i].level
					local health_max = GloblePlayerData.generals[i].health_point_max
					local health = GloblePlayerData.generals[i].health_point
									
					local physical_attack = GloblePlayerData.generals[i].physical_attack
					local physical_defence = GloblePlayerData.generals[i].physical_defence
									
					local spell_attack = GloblePlayerData.generals[i].spell_attack
					local spell_defence = GloblePlayerData.generals[i].spell_defence
									
					local speed = GloblePlayerData.generals[i].speed
					local critic = GloblePlayerData.generals[i].critic
					local hit = GloblePlayerData.generals[i].hit
					local dodge = GloblePlayerData.generals[i].dodge
					
					local roleInfo = "等级:"..level.."\n生命:"..health.."/"..health_max.."\n物理攻击:"..physical_attack.."\n物理防御:"..physical_defence.."\n法术攻击:"..spell_attack.."\n法术防御:"..spell_defence.."\n出手速度:"..speed.."\n暴击机率:"..critic.."\n命中机率:"..hit.."\n闪避机率:"..dodge
							
					local dialogCfg = new(basicDialogCfg)
					dialogCfg.title = role_name
					dialogCfg.bg = "UI/baoguoPanel/kuang.png"
					dialogCfg.titleAlign = "center"
					dialogCfg.msg = roleInfo
					dialogCfg.msgSize = 25
					dialogCfg.msgAlign = "left"
					
					dialogCfg.position = ccp
					
					local dialog = new(Dialog)
					dialog:create(dialogCfg)
				end
								
				if isZhan then
					dragable.m_nScriptCollisionHandler = function(item)
						dragable:setPosition(DuiXingHeroListConfig[i][2])
					end
				else
					dragable.m_nScriptCollisionHandler = function(other)
						local x,y = other:getPosition()
						if dragable == other then
							dragable:setPosition(DuiXingHeroListConfig[i][2])
						else
							local op = {}
							for k = 1 , table.getn(DuiXingConfig) do
								if x == DuiXingConfig[k].x and y == DuiXingConfig[k].y then
									op.on = true
									op.pos = k
								end
							end
							dragable:setPosition(DuiXingHeroListConfig[i][2])
							if op.on ~= nil then
								op.general_id = role.general_id
								Formation(formation,3,op)
							end
						end
					end
				end
			end
		end
	end,

	createCenter = function(self)
		local formation = self:getSelectedFormation()

		for i = 1 , table.getn(DuiXingConfig) do
			--空的框框
			local kuang = CCSprite:spriteWithFile("UI/formation/pos_kuang.png")
			kuang:setPosition(DuiXingConfig[i])
			kuang:setAnchorPoint(CCPoint(0,0))
			self.mainWidget:addChild(kuang)

			local border = dbUIWidgetDragable:widgetDragable(CCSprite:spriteWithFile("UI/formation/border_nothing.png"))
			border:setIsVisible(false)
			border:setAnchorPoint(CCPoint(0,0))
			border:setPosition(DuiXingConfig[i])
			self.mainWidget:addChild(border)

			if formation.pos[i] ~= -1 then
				if formation.pos[i] > 0 then
					local general = findGeneralByGeneralId(formation.pos[i])
					if general ~= 0 then
						--空的框框
						local kuang = CCSprite:spriteWithFile("UI/formation/pos_head_bg.png")
						kuang:setPosition(DuiXingConfig[i])
						kuang:setAnchorPoint(CCPoint(0,0))
						self.mainWidget:addChild(kuang)
						
						local headSpr = CCSprite:spriteWithFile("head/Middle/head_middle_"..general.face..".png")
						local icon = dbUIWidgetDragable:widgetDragable(headSpr)
						icon:setAnchorPoint(CCPoint(0,0))
						icon:setPosition(CCPoint(DuiXingConfig[i].x+22,DuiXingConfig[i].y+14))
						self.mainWidget:addChild(icon,50)

						icon.m_nScriptCollisionHandler = function(item)
							local x,y = item:getPosition()
							local op = {}
							op.on = false
							op.pos = i
							for k = 1 , table.getn(DuiXingConfig) do
								if x == DuiXingConfig[k].x and y == DuiXingConfig[k].y then
									op.on = true
									op.pos = k
									break
								end
							end
							icon:setPosition(CCPoint(DuiXingConfig[i].x+22,DuiXingConfig[i].y+14))
							if op.on ~= nil then
								op.general_id = general.general_id
								Formation(formation,3,op)
							end
						end
					end
				end
			else
				local icon = CCSprite:spriteWithFile("UI/formation/pos_closed.png")
				icon:setAnchorPoint(CCPoint(0,0))
				icon:setPosition(0,0)
				kuang:addChild(icon,50)
			end
		end
		
		
		local width = 490
		if not(formation.is_default) then
			width = 400
		end
		local upLevelBtn = new(ButtonScale)
		upLevelBtn:create("UI/equip_composite/composite_enable.png",1.2)
		upLevelBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		upLevelBtn.btn:setPosition(CCPoint(width+90,90))
		upLevelBtn.btn.m_nScriptClickedHandler = function(ccp)
			Formation(formation,2)
		end
		self.mainWidget:addChild(upLevelBtn.btn)
		self.upLevelBtn = upLevelBtn.btn
		
		if not(formation.is_default) then
			local startBtn = new(ButtonScale)
			startBtn:create("UI/formation/formation_run.png",1.2)
			startBtn.btn:setAnchorPoint(CCPoint(0,0))
			startBtn.btn:setPosition(CCPoint(583,60))
			startBtn.btn.m_nScriptClickedHandler = function(ccp)
				Formation(formation,1)
			end
			self.mainWidget:addChild(startBtn.btn)
		end
	end,
    
	createRight = function(self)
		local duiXingList = dbUIScrollList:scrollList(CCRectMake(810,40,166,530),0)
		self.mainWidget:addChild(duiXingList)
		local numofi=nil
		local list = GloblePlayerData.formations
		for i=1, table.getn(list) do
			local bs = new(ButtonScale)
			bs:create("UI/formation/border_nothing.png",1,ccc3(0,255,255))
			bs.btn:setAnchorPoint(CCPoint(0, 0))
			bs.btn:setContentSize(CCSize(96,110))
			bs.btn.m_nScriptClickedHandler = function(ccp)
				if GlobalCurZhenFa ~= i then
					GlobalCurZhenFa = i
					self:reflash()
				end
			end

			local icon
			if GlobalCurZhenFa ~= nil and GlobalCurZhenFa == i then
				icon = CCSprite:spriteWithFile("UI/formation/"..list[i].cfg_formation_id.."_2.png")
			else
				icon = CCSprite:spriteWithFile("UI/formation/"..list[i].cfg_formation_id.."_1.png")
			end
			icon:setPosition(CCPoint(96/2,110/2))
			icon:setAnchorPoint(CCPoint(0.5, 0.5))
			bs.btn:addChild(icon)

			if GloblePlayerData.cur_formation ~= nil and list[i].cfg_formation_id == GloblePlayerData.cur_formation then
				numofi=i
				local border = CCSprite:spriteWithFile("UI/formation/is_select.png")
				border:setAnchorPoint(CCPoint(0, 0))
				border:setPosition(CCPoint(15-5-2, 20-5))
				bs.btn:addChild(border)
			end

			duiXingList:insterDetail(bs.btn)
		end
		duiXingList:stopDetailsActions()
	end,

	--初始化界面，包括头部，背景
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1004)
		scene:addChild(self.uiLayer, 2004)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		local top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)
		self.top = top
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
		self.upLevelBtn = nil
		GlobleNotChuZhanRole = nil
		GlobleZhenFanPanel = nil
		removeUnusedTextures()
		
		self:destroyScheduler()
	end,
	
	destroyScheduler = function(self)
		if GlobleZhenFanPanel and GlobleZhenFanPanel.tick then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(GlobleZhenFanPanel.tick)
			GlobleZhenFanPanel.tick = nil
		end
	end
}
DuiXingHeroListConfig = {
	{
		CCPoint(70,     470),
		CCPoint(70+5,   470+5)
	},
	{
		CCPoint(70+126,   470),
		CCPoint(70+126+5, 470+5)
	},

	{
		CCPoint(70,   470-105),
		CCPoint(70+5, 470-105+5)
	},
	{
		CCPoint(70+126,     470-105),
		CCPoint(70+126+5,   470-105+5),
	},
	{
		CCPoint(70,   470-105*2),
		CCPoint(70+5, 470-105*2+5)
	},
	{
		CCPoint(70+126,     470-105*2),
		CCPoint(70+126+5,   470-105*2+5),
	},
	{
		CCPoint(70,   470-105*3),
		CCPoint(70+5, 470-105*3+5)
	},
	{
		CCPoint(70+126,     470-105*3),
		CCPoint(70+126+5,   470-105*3+5),
	},
	{
		CCPoint(70,   470-105*4),
		CCPoint(70+5, 470-105*4+5)
	},
	{
		CCPoint(70+126,     470-105*4),
		CCPoint(70+126+5,   470-105*4+5),
	}
}
DuiXingConfig = {
	CCPoint(358+143*2,439),
	CCPoint(358+143*2,439-149),
	CCPoint(358+143*2,439-149*2),
	
	CCPoint(358+143,439),
	CCPoint(358+143,439-149),
	CCPoint(358+143,439-149*2),

	CCPoint(358,439),
	CCPoint(358,439-149),
	CCPoint(358,439-149*2),
}
------------------------------------------
function Formation(fm,t,op,sf)
	local function opFormationFinishCB(s)
		local error_code = s:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			if t == 4 then
				local general = findGeneralIndexByGeneralId(op)
				table.remove(GloblePlayerData.generals,general)
				checkUpRoleIndex()
				alert("宠物已经放生!")

				if sf ~= nil and sf then
					if GloblePanel.mainWidget ~= nil then
						GlobleGeneralListPanel:reflash()
						GloblePanel:destroy()
						globleShowWuJiangPanel()
					end
				end
			end
			mappedPlayerFormations(s)
		
			if t == 2 then
				GloblePlayerData.gold = s:getByKey("gold"):asInt()
				GloblePlayerData.copper = s:getByKey("copper"):asInt()
				GloblePlayerData.exploit = s:getByKey("exploit"):asInt()
				updataHUDData()
			end
		
			if sf == nil or not(sf) then
				if GlobleZhenFanPanel then
					GlobleZhenFanPanel:reflash()
				end
			end
			
			if GlobleFightDialogPanel and GlobleFightDialogPanel.centerWidget then
				GlobleFightDialogPanel:createMain()
			end
		end
		
		if t == 2 then --队形已经升级
			GotoNextStepGuide()
		end
		if t == 3 then --出战
			GotoNextStepGuide()
		end

		if GolbalEventPanel and GolbalEventPanel.event.name == "zhenxing" and #GloblePlayerData.generals >= 3 then 
			CloseEvent("zhenxing")
			DispatchEvent("train")
		end
	end

	local function execFormation()
		local action = Net.OPT_FormationDefaultSimple

		if t == 2 then
			action = Net.OPT_FormationLevelUpSimple
		end

		if t == 3 then
			action = Net.OPT_FormationSimple
		end

		if t == 4 then
			action = Net.OPT_FireSimple
		end

		NetMgr:registOpLuaFinishedCB(action, opFormationFinishCB)
		NetMgr:registOpLuaFailedCB(action, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("cfg_formation_id", fm.id)

		if t == 3 then
			cj:setByKey("general_id",op.general_id )
			cj:setByKey("pos",op.pos)
			cj:setByKey("on",op.on)
		end

		if t == 4 then
			cj:setByKey("general_id", op)
		end
		
		NetMgr:setOpUnique(action)
		NetMgr:executeOperate(action, cj)
	end
	execFormation()
end
----------------------------

function returnFormationInfo(formation)
	local zhenFaInfo = {}
	local id = formation.cfg_formation_id

	local level = formation.level

	local officium 	= 0		--神位
	local exploit_need = 0	--升级需求战功

	local zhenFaConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_formation.json")
	local data = zhenFaConfig:getByKey(id)
	local zhenFaLevelConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_level_formation.json")
	for i = 1 , zhenFaLevelConfig:size() do
		local zhenfa = zhenFaLevelConfig:getByKey(i)
		if zhenfa:getByKey("cfg_formation_id"):asInt() == id and zhenfa:getByKey("level"):asInt() == level + 1 then
			officium	= zhenfa:getByKey("officium"):asInt()
			exploit_need = zhenfa:getByKey("exploit_need"):asInt()
		end
	end
	zhenFaInfo.id = id
	zhenFaInfo.level = level
	zhenFaInfo.is_default = formation.is_default
	zhenFaInfo.name = data:getByKey("name"):asString()
	zhenFaInfo.desc = data:getByKey("desc"):asString()
	zhenFaInfo.position = data:getByKey("position"):asInt()
	zhenFaInfo.officium = officium
	zhenFaInfo.exploit_need = exploit_need
	zhenFaInfo.pos = formation.pos
	zhenFaInfo.add_type = data:getByKey("add_type"):asInt()

	return zhenFaInfo
end
--登陆选择服务器面板

GlobleChooseServerPanel = nil
ServerListPanel = nil

MyServerMainPanel = {

	serverLayer = nil,

	curPage = nil,		--当前页碼
	curPageTX = nil,	--页碼顯示文本
	pages_count = nil,	--总共页数
	serverBtns = nil,
	myBG = nil,

	createFixed = function(self)
		self.serverLayer = dbUILayer:node()

		--遮掩層
		local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
		mask:setScale(1/SCALEY)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		self.serverLayer:addChild(mask)

		return self.serverLayer
	end,
	
	--最近登录
	createRecently = function(self,jValue)
		local layer = self.serverLayer
		local text = CCLabelTTF:labelWithString("最近登录",CCSizeMake(200, 0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 32)
		text:setAnchorPoint(CCPoint(0, 0))
		text:setPosition(CCPoint(72,615))
		text:setColor(ccc3(153,205,0))
		layer:addChild(text)

		if not jValue:getByKey("0") then
			return false
		end

		local passport = jValue:getByKey("passport"):asString()
		local url = jValue:getByKey("0"):getByKey("url"):asString()
		local state = jValue:getByKey("0"):getByKey("state"):asInt()
		local timeStr = jValue:getByKey("0"):getByKey("open_time"):asString()
		local server_id = jValue:getByKey("0"):getByKey("server_id"):asInt()
		local desc = jValue:getByKey("0"):getByKey("desc"):asString()
		if passport=="" or url=="" then
			return false
		end
		
		local image = self:getImageByState(state)
		local btn = dbUIButtonScale:buttonWithImage(image,1.2)
		btn:setScale(isRetina)
		btn:setPosition(CCPoint(72+134 ,500+44))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		layer:addChild(btn)
		
		local text = CCLabelTTF:labelWithString(desc,CCSizeMake(0, 0), 1,SYSFONT[EQUIPMENT], 32/isRetina)
		text:setAnchorPoint(CCPoint(0.5, 0.5))
		text:setPosition(CCPoint(btn:getContentSize().width/2,btn:getContentSize().height/2))
		text:setColor(ccc3(255,204,102))
		btn:addChild(text)

		btn.m_nScriptClickedHandler = function()
			if state<0 then
				local dtp = new(DialogTipPanel)
				dtp:create("服务器将在 "..string.sub(timeStr,6,-6).." 开启,敬请期待","")
				dtp.okBtn.m_nScriptClickedHandler = function()
					dtp:destroy()
				end
			else
				self:clickLogin(url, server_id,passport)
			end
		end
		
		return true
	end,

	createList = function(self,jValue,hasRecently)
		local layer = self.serverLayer

		local text = CCLabelTTF:labelWithString("全部服务器",CCSizeMake(300, 0), CCTextAlignmentLeft,SYSFONT[EQUIPMENT], 32)
		text:setAnchorPoint(CCPoint(0, 0))
		text:setPosition(CCPoint(72,420))
		text:setColor(ccc3(153,205,0))
		layer:addChild(text)

		local panel = dbUIPanel:panelWithSize(CCSize(0,0))
		local passport = jValue:getByKey("passport"):asString()
		local index = 0
		local line = 1
		local height = jValue:size()/3*120
		local endSize = hasRecently==true and jValue:size()-2 or jValue:size()-1
		for i=1, endSize do

			local server_id = jValue:getByKey(i..""):getByKey("server_id"):asInt()
			local url = jValue:getByKey(i..""):getByKey("url"):asString()
			local state = jValue:getByKey(i..""):getByKey("state"):asInt()
			local timeStr = jValue:getByKey(i..""):getByKey("open_time"):asString()
			local desc = jValue:getByKey(i..""):getByKey("desc"):asString()

			if index > 2 then
				index = 0
				line = line +1
			end
			index = index +1

			local image = self:getImageByState(state,i==1)
			
			local btn = dbUIButtonScale:buttonWithImage(image,1.1)
			btn:setScale(isRetina)
			btn:setPosition(CCPoint(72 + (index-1)*307+135 ,height-(line)*120+45))
			btn:setAnchorPoint(CCPoint(0.5,0.5))
			panel:addChild(btn)
			local text = CCLabelTTF:labelWithString(desc,CCSizeMake(0, 0), 1,SYSFONT[EQUIPMENT], 32/isRetina)
			text:setAnchorPoint(CCPoint(0.5, 0.5))
			text:setPosition(CCPoint(btn:getContentSize().width/2,btn:getContentSize().height/2))
			text:setColor(ccc3(255,204,102))
			btn:addChild(text)

			btn.m_nScriptClickedHandler = function()
				if state<0 then --维护状态
					local dtp = new(DialogTipPanel)
					dtp:create("服务器将在 "..string.sub(timeStr,6,-6).." 开启,敬请期待","")
					dtp.okBtn.m_nScriptClickedHandler = function()
						dtp:destroy()
					end
				else
					self:clickLogin(url, server_id,passport)
				end
			end
		end

		panel:setContentSize(CCSize(900,height))
		local textList = dbUIList:list(CCRectMake(0,40,1000,380),0)
		textList:insterWidget(panel)
		textList:m_setPosition(CCPoint(0,- textList:get_m_content_size().height + textList:getContentSize().height ))
		layer:addChild(textList)
	end,
	
	getImageByState = function(self,state,first)
		local image = "UI/chooseServer/normal.png"
		if first~=nil and first==true then --第一个就是最新的
			image = "UI/chooseServer/newServer.png"
		elseif state ==1 then --火爆的
			image = "UI/chooseServer/hot.png"
		elseif state ==-1  then --新区，还没开放的
			image = "UI/chooseServer/normal.png"
		elseif state ==-2  then --新区，还没开放的
			image = "UI/chooseServer/normal.png"
		end
		return image
	end,
	
	clickLogin = function (self,url, server_id,passport)
		url = url .. "/messagebroker/amf"
		NetMgr:resetGameServerUrl(url, server_id.."")

		local lj = Value:new()
		lj:setByKey("passport", passport)
		NetMgr:executeOperate(Net.OPT_Enter, lj)
		GlobleChooseServerPanel:destroy()
	end,

	destroy = function(self)
		GlobleChooseServerPanel.centerWidget:removeChild(self.serverLayer)
		self.serverLayer = nil
		removeUnusedTextures()
	end,
}

ChooseServerMainPanel =
{
	bgLayer = nil,
	uiLayer = nil,
	centerWidget = nil,

	create = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		local bg = CCSprite:spriteWithFile("login/login_bg_dark.png")
		bg:setPosition(0, 0)
		bg:setAnchorPoint(CCPoint(0,0))
		winSize = CCDirector:sharedDirector():getWinSize()
		bgSize = bg:getContentSize()
		bg:setScaleX(winSize.width / bgSize.width)
		bg:setScaleY(winSize.height / bgSize.height)
		self.bgLayer:addChild(bg)

		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil

		GlobleChooseServerPanel = nil
		removeUnusedTextures()
	end
}

function  GlobalCreateServerList(jValue)
	if GlobleChooseServerPanel == nil then
		GlobalCreateChooseServer()
	end
	local hasRecently = ServerListPanel:createRecently(jValue)
	ServerListPanel:createList(jValue,hasRecently)
end

function GlobalCreateChooseServer()
	GlobleChooseServerPanel = new(ChooseServerMainPanel)
	GlobleChooseServerPanel:create()
	ServerListPanel= new(MyServerMainPanel)
	local sL = ServerListPanel:createFixed()
	GlobleChooseServerPanel.centerWidget:addChild(sL,2001)
end
function globleActivity()
	globleActivityPanel = new (ActivityPanel)
	globleActivityPanel:create()
end

ActivityPanel = {
    bgLayer = nil,		--背景层
	uiLayer = nil,		--mask
	closebtn=nil,
	centerWidget = nil,
	toggles={},

    create = function (self)
    	self:initBase()
  	    
	    self.leftBg  = createBG("UI/public/recuit_dark.png",584,468)
		self.leftBg:setAnchorPoint(CCPoint(0,0))
		self.leftBg:setPosition(CCPoint(40,38))
		self.mainWidget:addChild(self.leftBg)
		
		self.leftPanel = dbUIPanel:panelWithSize(CCSize(584,468))
		self.leftPanel:setAnchorPoint(CCPoint(0,0))
		self.leftPanel:setPosition(CCPoint(0,0))
		self.leftBg:addChild(self.leftPanel)

 	    self.rightBg = createBG("UI/public/recuit_dark.png",336,468)
		self.rightBg:setAnchorPoint(CCPoint(0,0))
		self.rightBg:setPosition(CCPoint(635,38))
		self.mainWidget:addChild(self.rightBg)
		
		self.rightPanel = dbUIPanel:panelWithSize(CCSize(336,468))
		self.rightPanel:setAnchorPoint(CCPoint(0,0))
		self.rightPanel:setPosition(CCPoint(0,0))
		self.rightBg:addChild(self.rightPanel)
						  	
    	self:loadActivitys()
    end,
	
	createMain = function(self)
		self:createActivityList()
	end,
	
	--创建顶上的活动列表
	createActivityList = function(self)
		self.activityToggles = new({})
		
		self.activityPanel = dbUIPanel:panelWithSize(CCSize(932,100))
		self.activityPanel:setPosition(CCPoint(1010/2,500))
		self.activityPanel:setAnchorPoint(CCPoint(0.5,0))
		self.mainWidget:addChild(self.activityPanel)
		local activityScrollList = nil
		
		local prevBtn = dbUIButtonScale:buttonWithImage("UI/public/prev_enable.png",1.2,ccc3(0,255,255))
		prevBtn:setPosition(CCPoint(prevBtn:getContentSize().width/2, 50))
		prevBtn.m_nScriptClickedHandler = function(ccp)
			local p = activityScrollList:getContentPosition()
			activityScrollList:setContentPosition(CCPoint(p.x-100,p.y))
		end
		self.activityPanel:addChild(prevBtn)

		local nextBtn = dbUIButtonScale:buttonWithImage("UI/public/next_enable.png",1.2,ccc3(0,255,255))
		nextBtn:setPosition(CCPoint(932-nextBtn:getContentSize().width/2, 50))
		nextBtn.m_nScriptClickedHandler = function(ccp)
			local p = activityScrollList:getContentPosition()
			activityScrollList:setContentPosition(CCPoint(p.x+100,p.y))
		end
		self.activityPanel:addChild(nextBtn)
	
		activityScrollList = dbUIScrollList:scrollList(CCRectMake(prevBtn:getContentSize().width+10,0,932-prevBtn:getContentSize().width*2-20,100),1)
		self.activityPanel:addChild(activityScrollList)
		
	    local createItem = function(i)
		    local btnPanel = dbUIPanel:panelWithSize(CCSize(222, 70))
		    btnPanel:setAnchorPoint(CCPoint(0,0.5))
		    
		    local btn = dbUIButtonToggle:buttonWithImage("UI/activity/activity_btn_bg_normal.png","UI/activity/activity_btn_bg_pressed.png")
		    btn:setAnchorPoint(CCPoint(0.5, 0.5))
		    btn:setPosition(CCPoint(222/2,35))
		    btnPanel:addChild(btn)
		    self.activityToggles[i] = btn

			local label = CCLabelTTF:labelWithString(self.activity_list[i].name,CCSize(0,0),CCTextAlignmentCenter,SYSFONT[EQUIPMENT],32)
			label:setPosition(CCPoint(222/2,35))
			label:setColor(ccc3(255,239,102))
			btnPanel:addChild(label)
		    
		    return btnPanel
		end

		for i = 1, table.getn(self.activity_list) do
			local btn = createItem(i)
			activityScrollList:insterDetail(btn)
		end
		
		--注册切换事件
		for i = 1,table.getn(self.activity_list) do
			self.activityToggles[i].m_nScriptClickedHandler = function()
				public_toggleRadioBtn(self.activityToggles,self.activityToggles[i])		
				self:showActivityStep(self.activity_list[i])
			end
		end
		
		if table.getn(self.activity_list)>0 then
			self.activityToggles[1]:toggled(true)
			self:showActivityStep(self.activity_list[1])
		end
	end,
	
	showActivityStep = function(self,activity)
		if activity == nil then
			return
		end
		local steps = activity.activity_step_list
		
		self.stepToggles = new({})
		
		local leftPanel = self.leftPanel
	    leftPanel:removeAllChildrenWithCleanup(true)
	    
	    local rightPanel = self.rightPanel
		rightPanel:removeAllChildrenWithCleanup(true)
		
		local btnList = dbUIList:list(CCRectMake(5,5,290,440),0)
		rightPanel:addChild(btnList)
	    
	    local createBtn = function(i)
		    local btnPanel = dbUIPanel:panelWithSize(CCSize(290, 100))
		   
		    local btn = dbUIButtonToggle:buttonWithImage("UI/public/big_btn_bg.png","UI/public/big_btn_bg_toggle.png")
		    btn:setAnchorPoint(CCPoint(0.5, 0.5))
		    btn:setPosition(CCPoint(336/2,100/2))
		    btnPanel:addChild(btn)
		    self.stepToggles[i] = btn

			local label = CCLabelTTF:labelWithString(steps[i].step_name,CCSize(0,0),CCTextAlignmentCenter,SYSFONT[EQUIPMENT],32)
			label:setPosition(CCPoint(336/2,100/2))
			label:setColor(ccc3(255,239,102))
			btnPanel:addChild(label)
			
		    return btnPanel
		end
		
		for i = 1, #steps do
			local btn = createBtn(i)
			btnList:insterWidget(btn)
		end
		
		--注册切换事件
		for i = 1, #steps do
			self.stepToggles[i].m_nScriptClickedHandler = function()
				public_toggleRadioBtn(self.stepToggles,self.stepToggles[i])
				self:showStepInfo(activity,steps[i])
			end
		end
		btnList:m_setPosition(CCPoint(0,-btnList:get_m_content_size().height + btnList:getContentSize().height ))
	
		local findNextStep = function()
			for i=1,#activity.activity_step_list do
				local s = activity.activity_step_list[i]
				if s.reward_fetch==false then
					return s
				end
			end
		end
		
		local nextStep = findNextStep()
		if nextStep == nil and #steps>0 then
			nextStep = steps[1]
		end
		
		if nextStep then
			self.stepToggles[nextStep.step_id]:toggled(true)
			self:showStepInfo(activity,nextStep)		
		end
	end,
	
	showStepInfo = function(self,activity,step)
		self.leftPanel:removeAllChildrenWithCleanup(true)
		
		if activity == nil or step == nil then
			return
		end
		local t = os.time();
		local label = CCLabelTTF:labelWithString("活动时间：",CCSize(250, 0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT],32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(10,419))
		label:setColor(ccc3(254,153,0))
		self.leftPanel:addChild(label)
		
		local labelText = "";
		if activity.startTime==0 or activity.endTime==0 then
			labelText = "不限时间"
		else
			labelText = os.date("%Y-%m-%d", activity.startTime/1000).."到"..os.date("%Y-%m-%d",activity.endTime/1000)
		end
		local label = CCLabelTTF:labelWithString(labelText,CCSize(600,0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT],26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(38,386))
		label:setColor(ccc3(244,196,147))
		self.leftPanel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("活动内容：",CCSize(250,0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT],32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(10,328))
		label:setColor(ccc3(254,153,0))
		self.leftPanel:addChild(label)
		local label = CCLabelTTF:labelWithString(step.reward_desc,CCSize(800,0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT],26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(38,298))
		label:setColor(ccc3(244,196,147))
		self.leftPanel:addChild(label)

		local label = CCLabelTTF:labelWithString("活动奖励：",CCSize(250, 0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT],32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(10,237))
		label:setColor(ccc3(254,153,0))
		self.leftPanel:addChild(label)
		
		local reward_list = step.reward_list
		for i=1,#reward_list do
			local amount = reward_list[i].amount
			local cfg_itme_id = reward_list[i].cfg_item_id
			local name = reward_list[i].name
			
			local kuang = dbUIPanel:panelWithSize(CCSize(94, 94))
			kuang:setAnchorPoint(CCPoint(0, 0))
			kuang:setPosition(34+140*(i-1), 128)
			self.leftPanel:addChild(kuang)

			local kuang_94_94 = CCSprite:spriteWithFile("UI/public/kuang_94_94.png")
			kuang_94_94:setPosition(47, 47)
			kuang_94_94:setAnchorPoint(CCPoint(0.5, 0.5))
			kuang:addChild(kuang_94_94)
			
			local dropWood = nil
			if cfg_itme_id==0 then
				dropWood = CCSprite:spriteWithFile("icon/copper.png")
			elseif cfg_itme_id==1 then
				dropWood = CCSprite:spriteWithFile("icon/gold.png")
			elseif cfg_itme_id==14 then
				dropWood = CCSprite:spriteWithFile("icon/jin_yan_dan.png")
			else
				dropWood = getItemBorder(reward_list[i].cfg_item_id)
			end
			dropWood:setAnchorPoint(CCPoint(0.5, 0.5))
			dropWood:setPosition(CCPoint(47,47))
			kuang:addChild(dropWood)
			
			local label = CCLabelTTF:labelWithString(name.."*"..amount,SYSFONT[EQUIPMENT],22)
			label:setAnchorPoint(CCPoint(0.5,1))
			label:setPosition(CCPoint(47,-10))
			label:setColor(ccc3(244,196,147))
			kuang:addChild(label)			
		end
		
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(584/28)
		line:setPosition(0, 80)
		self.leftPanel:addChild(line)
		
		--需要奖励按钮
		if activity.button_type==1 then
			local btnImage = step.reward_fetch and "UI/activity/yilingqu.png" or "UI/activity/linqu.png" 
	        local btn = dbUIButtonScale:buttonWithImage(btnImage,1.2,ccc3(125,125,125))
			btn:setAnchorPoint(CCPoint(0.5, 0.5))
			btn:setPosition(CCPoint(615/2,40))
			btn:setIsEnabled(not step.reward_fetch)
			btn.m_nScriptClickedHandler = function(ccp)
				self:getReward(activity,step.step_id,btn)
			end
			self.leftPanel:addChild(btn)			
		end
	end,
		
	--初始化界面，包括头部，背景
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

    	self.bgLayer = createPanelBg()
        self.uiLayer,self.centerWidget = createCenterWidget()
       
		self.mainWidget = createMainWidget()

        scene:addChild(self.bgLayer, 1000)
	    scene:addChild(self.uiLayer, 2000)

	    local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
	    bg:setPosition(CCPoint(1010/2, 702/2)) 
	    self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)
		
		local nice = CCSprite:spriteWithFile("UI/activity/nice.png")			
		nice:setPosition(CCPoint(1010/2, 702-80)) 
		nice:setAnchorPoint(CCPoint(0.5, 0))
		self.centerWidget:addChild(nice)

		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))			
		closeBtn.btn:setPosition(CCPoint(952, 650))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()		
			self:destroy()
		end
		self.centerWidget:addChild(closeBtn.btn)
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
        self.bgLayer = nil
        self.uiLayer = nil
        self.centerWidget = nil
        self.mainWidget = nil
        removeUnusedTextures()
    end,

	getReward = function(self,activity,step,btn)
		local callBack = function (json)
			local temp = (WaitDialog ~= nil and WaitDialog.closePanelFunc ~= nil) and WaitDialog.closePanelFunc() or 0
			local error_code = json:getByKey("error_code"):asInt()
			
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
				btn:setIsEnabled(true)
			else
				btn:setIsEnabled(false)
				btn:setNormalImage(CCSprite:spriteWithFile("UI/activity/yilingqu.png"))
				activity.activity_step_list[step].reward_fetch = true	

				GloblePlayerData.gold = json:getByKey("gold"):asInt()
				GloblePlayerData.copper = json:getByKey("copper"):asInt()
				GloblePlayerData.trainings.jump_wand = json:getByKey("jump_wand"):asInt()
				GloblePlayerData.ap_wand = json:getByKey("ap_wand"):asInt()
				updataHUDData()
								
				local dialogCfg = new(basicDialogCfg)
				dialogCfg.msgAlign = "center"
				dialogCfg.position = CCPoint(WINSIZE.width / 2, WINSIZE.height / 2)
				dialogCfg.dialogType = 5
				dialogCfg.msg = "恭喜您，领取奖励成功！"
				new(Dialog):create(dialogCfg)
				RefreshItem()
			end
		end
			
		local sendRequest = function ()
			local action = Net.OPT_GetReward
			showWaitDialogNoCircle("waiting OPT_GetReward!")
			NetMgr:registOpLuaFinishedCB(action,callBack)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("P1", activity.activity_id)
			cj:setByKey("P2",step)
			NetMgr:executeOperate(action, cj)
		end 
		sendRequest()
	end,
	    
    loadActivitys = function(self)
		local callBack = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				self.activity_list = new ({})
				local activity_list = json:getByKey("activity_list")
				for i=1 ,activity_list:size() do
					local activity = activity_list:getByIndex(i-1)
					if activity~= nil then
						self.activity_list[i] = new ({})
						self.activity_list[i].content = activity:getByKey("content"):asString()
						self.activity_list[i].idx = activity:getByKey("idx"):asInt()
						self.activity_list[i].activity_id = activity:getByKey("activity_id"):asInt()
						self.activity_list[i].name = activity:getByKey("name"):asString()
						self.activity_list[i].button_type = activity:getByKey("button_type"):asInt()
						self.activity_list[i].tips = activity:getByKey("tips"):asString()
						self.activity_list[i].type = activity:getByKey("type"):asInt()
						self.activity_list[i].startTime = activity:getByKey("startTime"):asDouble()
						self.activity_list[i].endTime = activity:getByKey("endTime"):asDouble()
						
						self.activity_list[i].banner = activity:getByKey("banner"):asString() --- 不知道什么玩意
						self.activity_list[i].activity_step_list = new ({})
						local activity_step_list = activity:getByKey("activity_step_list")
						for x=1, activity_step_list:size() do
							local activity_step = activity_step_list:getByIndex(x-1)
							self.activity_list[i].activity_step_list[x] = new ({})
							self.activity_list[i].activity_step_list[x].reward_desc = activity_step:getByKey("reward_desc"):asString()
							self.activity_list[i].activity_step_list[x].step_name = activity_step:getByKey("step_name"):asString()
							self.activity_list[i].activity_step_list[x].step_id = activity_step:getByKey("step_id"):asInt()
							self.activity_list[i].activity_step_list[x].reward_fetch = activity_step:getByKey("reward_fetch"):asBool()
						
							self.activity_list[i].activity_step_list[x].reward_list = new ({})
							local activity_reward_list = activity_step:getByKey("activity_reward_list")
							for y=1, activity_reward_list:size() do
								local reward = activity_reward_list:getByIndex(y-1)
								self.activity_list[i].activity_step_list[x].reward_list[y] = new ({})
								self.activity_list[i].activity_step_list[x].reward_list[y].name = reward:getByKey("name"):asString()
								self.activity_list[i].activity_step_list[x].reward_list[y].reward_type = reward:getByKey("reward_type"):asInt()
								self.activity_list[i].activity_step_list[x].reward_list[y].cfg_item_id = reward:getByKey("cfg_item_id"):asInt()
								self.activity_list[i].activity_step_list[x].reward_list[y].amount = reward:getByKey("amount"):asInt()
							end
						end
						--按 step 排序
						local sortByStepFunc = function(a,b)
							return a.step_id  < b.step_id
						end
						table.sort(self.activity_list[i].activity_step_list,sortByStepFunc)
					end

					local sortFunc = function(a,b)
						return a.idx  < b.idx
					end
					table.sort(self.activity_list,sortFunc)
				end
				
				self:createMain()	
			end
		end
		
		local sendRequest = function ()
			local action = Net.OPT_Activity
			showWaitDialogNoCircle("waiting OPT_Activity!")
			NetMgr:registOpLuaFinishedCB(action,callBack)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(action, cj)
		end 
		sendRequest()
	end,
}
--[[
   洗髓面板
]]--

local POLISH_RARE_COST = { 5,10,12,14,16,18,20 }--潜能
local POLISH_EPIC_COST = { 50,60,70,80,90,100 } --醍醐

---洗髓进度条配置
local XI_SUI_BAR_CFG = {
	{
		res = {border = "UI/bar/bar_bg.png",entity = "UI/bar/bar_red.png",},
		borderSize = {width = 380,height = 32},
		entitySize = {width = 380,height = 28},
		fontSize = 24,
		position = CCPoint(110, 490),
		borderCornerSize = CCSize(11,16),
		entityCornerSize = CCSize(10,14)
	},
	{
		res = {border = "UI/bar/bar_bg.png",entity = "UI/bar/bar_purple.png",},
		borderSize = {width = 380,height = 32},
		entitySize = {width = 380,height = 28},
		fontSize = 24,
		position = CCPoint(110, 490-92),
		borderCornerSize = CCSize(11,16),
		entityCornerSize = CCSize(10,14)
	},
	{
		res = {border = "UI/bar/bar_bg.png",entity = "UI/bar/bar_green.png",},
		borderSize = {width = 380,height = 32},
		entitySize = {width = 380,height = 28},
		fontSize = 24,
		position = CCPoint(110, 490-92*2),
		borderCornerSize = CCSize(11,16),
		entityCornerSize = CCSize(10,14)
	},
	{
		res = {border = "UI/bar/bar_bg.png",entity = "UI/bar/bar_blue.png",},
		borderSize = {width = 380,height = 32},
		entitySize = {width = 380,height = 28},
		fontSize = 24,
		position = CCPoint(110, 490-92*3),
		borderCornerSize = CCSize(11,16),
		entityCornerSize = CCSize(10,14)
	},			
}

local XI_SUI_CFG = {
	{
		type = 1,
		toggle1 = "UI/xi_sui_panel/qianghua_normal_1.png",
		toggle2 = "UI/xi_sui_panel/qianghua_selected_1.png",
		disable = "",		
		requireVip = 0,
		requireOfficium = 0,
		requireTip = ""
	},
	{
		type = 2,
		toggle1 = "UI/xi_sui_panel/qianghua_normal_2.png",
		toggle2 = "UI/xi_sui_panel/qianghua_selected_2.png",
		disable = "UI/xi_sui_panel/qianghua_locked2.png",		
		requireVip = 1,
		requireOfficium = 30,
		requireTip = "神位30级或VIP1级开启"
	},
	{
		type = 3,
		toggle1 = "UI/xi_sui_panel/qianghua_normal_3.png",
		toggle2 = "UI/xi_sui_panel/qianghua_selected_3.png",
		disable = "UI/xi_sui_panel/qianghua_locked3.png",		
		requireVip = 3,
		requireOfficium = 0,
		requireTip = "VIP 3  级开启"
	},
	{
		type = 4,
		toggle1 = "UI/xi_sui_panel/qianghua_normal_4.png",
		toggle2 = "UI/xi_sui_panel/qianghua_selected_4.png",
		disable = "UI/xi_sui_panel/qianghua_locked4.png",		
		requireVip = 6,
		requireOfficium = 0,
		requireTip = "VIP 6  级开启"
	}			
}

---计算消耗
local calculateCost = function(type)
	---没有洗过count为0
	local count = GloblePlayerData.cultivate_count
	local next = count + 1
	
	if type == 1 then
		--髓银币消耗=神位等级<31?100:向上取整（（神位等级-20）/10）*向上取整（（神位等级-20）/10）*向下取整（（神位等级-1）/10）* 50
		local officim = GloblePlayerData.officium
		return officim < 31 and 100 or math.ceil((officim - 20)/10) * math.ceil((officim - 20)/10) * math.floor((officim - 1)/10) * 50
	elseif type == 2 then
		return 2
	elseif type == 3 then
		if next > #POLISH_RARE_COST then next = #POLISH_RARE_COST end
		return POLISH_RARE_COST[next]
	else
		if next > #POLISH_EPIC_COST then next = #POLISH_EPIC_COST end
		return POLISH_EPIC_COST[next]	
	end
end

---判断是否开启
local checkEnable = function(cfg)
	if GloblePlayerData.vip_level >= cfg.requireVip then
		return true
	elseif GloblePlayerData.officium >= cfg.requireOfficium and cfg.requireOfficium~= 0 then
		return true
	else
		return false
	end
end

---面板定义
HeroPolishPanel = {
	bg = nil,
	leftPanel = nil,
	rightPanel = nil,
	chooseTypeBtns = {},
	selectIdx = 1,
	
	--创建面板
	create = function(self,role)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010,598))
		self:createLeft()
		self:createRight()
	end,
	
	--创建左面板
	createLeft = function(self)
		if self.leftPanel~=nil then
			self.leftPanel:removeAllChildrenWithCleanup(true)
			self.leftPanel = nil
		end
		
		local role = GloblePlayerData.generals[GloblePanel.curGenerals]
		
		local leftPanel = dbUIPanel:panelWithSize(CCSize(234, 546))
		leftPanel:setAnchorPoint(CCPoint(0, 0))
		leftPanel:setPosition(CCPoint(28, 40))
		self.bg:addChild(leftPanel)
		self.leftPanel = leftPanel
		
		--名字

		local label = CCLabelTTF:labelWithString(role.name.." "..role.level.."级",SYSFONT[EQUIPMENT], 26)	
		label:setPosition(CCPoint(117,515))
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setColor(ITEM_COLOR[role.quality])
		self.leftPanel:addChild(label)
		--等级
		--local nameWidth = label:getContentSize().width
		--local label = CCLabelTTF:labelWithString(role.level.."级",CCSize(150,0),0, SYSFONT[EQUIPMENT], 23)	
        --label:setPosition(CCPoint(10+nameWidth,515))
		--label:setAnchorPoint(CCPoint(0,0))
		--label:setColor(ReColor[role.reincarnate + 1])
		--self.leftPanel:addChild(label)
		
		--"洗髓方式“
		local type = CCSprite:spriteWithFile("UI/xi_sui_panel/xisuifangshi.png")
		type:setAnchorPoint(CCPoint(0.5, 1))
		type:setPosition(CCPoint(234/2, 546-37))
		self.leftPanel:addChild(type)
		
		for i = 1, 4 do
			local cfg = XI_SUI_CFG[i]
			local cost = calculateCost(cfg.type)
			local enable = checkEnable(cfg)
			if enable then
				local btn = dbUIButtonToggle:buttonWithImage(cfg.toggle1,cfg.toggle2)
				btn:setAnchorPoint(CCPoint(0.5, 1))
				btn:setPosition(CCPoint(234/2, 444 - (i-1)*106))
				self.leftPanel:addChild(btn)
				self.chooseTypeBtns[i] = btn
				local label = CCLabelTTF:labelWithString("消耗"..cost..(i==1 and "银币" or "金币"),SYSFONT[EQUIPMENT], 22)
				label:setPosition(CCPoint(234/2, 444 - 60 - (i-1)*106))
				label:setColor(ccc3(131,85,35))
				label:setAnchorPoint(CCPoint(0.5,1))
				self.leftPanel:addChild(label)
			else
				local spr = CCSprite:spriteWithFile(cfg.disable)
				spr:setAnchorPoint(CCPoint(0.5, 1))
				spr:setPosition(CCPoint(234/2, 444 - (i-1)*106))
				self.leftPanel:addChild(spr)
				local label = CCLabelTTF:labelWithString(cfg.requireTip,SYSFONT[EQUIPMENT], 22)
				label:setPosition(CCPoint(234/2, 444 - 60 - (i-1)*106))
				label:setColor(ccc3(131,85,35))
				label:setAnchorPoint(CCPoint(0.5,1))
				self.leftPanel:addChild(label)				
			end
		end
		
		--设置单选模式
		for i=1,table.getn(self.chooseTypeBtns) do
			self.chooseTypeBtns[i].m_nScriptClickedHandler = function(ccp)
				public_toggleRadioBtn(self.chooseTypeBtns,self.chooseTypeBtns[i])
				self.selectIdx = i
			end	
		end
		--默认选中第一个
		public_toggleRadioBtn(self.chooseTypeBtns,self.chooseTypeBtns[self.selectIdx])
	end,
	
	--创建右面板
	createRight=function(self)
		if self.rightPanel~=nil then
			self.rightPanel:removeAllChildrenWithCleanup(true)
			self.rightPanel = nil
		end
		self.rightPanel = createDarkBG(710,546)
		self.rightPanel:setPosition(CCPoint(262, 38))
		self.bg:addChild(self.rightPanel)
		
		self:createShowInfo()
		self:createAttrs()
		self:createBtns()
		self:createChange() --培养后改变的值
		self:refurbishState()
	end,
	
	--培养信息
	createShowInfo = function(self)
		local general = GloblePlayerData.generals[GloblePanel.curGenerals]
		
		local ceil = general.level * 3 + 20 --上线

		--属性图片标签
		local createImgLabel = function(img,row)
			local name = CCSprite:spriteWithFile(img)
			name:setAnchorPoint(CCPoint(0, 0))
			name:setPosition(CCPoint(33, 490-(row-1)*92))
			self.rightPanel:addChild(name)
		end

		--属性描述
		local createDesc = function(text,row)
			local descLabel = CCLabelTTF:labelWithString(text,CCSize(500,0),0, SYSFONT[EQUIPMENT], 22)
			descLabel:setColor(ccc3(254,205,102))
			descLabel:setPosition(CCPoint(33, 457-(row-1)*92))
			descLabel:setAnchorPoint(CCPoint(0,0))
			self.rightPanel:addChild(descLabel)
		end
		
		--分割线
		local createCutLine = function(row)
			local cut = CCSprite:spriteWithFile("UI/public/line_2.png")
			cut:setPosition(CCPoint(0, 444 - (row-1)*92))
			cut:setAnchorPoint(CCPoint(0,0))
			cut:setScaleX(710/28)
			self.rightPanel:addChild(cut)	
		end

		--百分比
		local createPercent = function(percent,row)
			local label= new(PercentLabel)
			label:create(percent)
			label.bg:setPosition(CCPoint(545, 490 - (row-1)*92))
			label.bg:setAnchorPoint(CCPoint(0,0))
			self.rightPanel:addChild(label.bg)	
		end
			
		--耐力
		createImgLabel("UI/xi_sui_panel/naili.png",1)
		createDesc("耐力成长影响生命值上限",1)
		createCutLine(1)
		createPercent(general.sta_grow/ceil,1)
		local bar = new(Bar2)
        bar:create(ceil, XI_SUI_BAR_CFG[1])
		bar:setExtent(general.sta_grow)	
		self.rightPanel:addChild(bar.barbg)	
			
		--力量
		createImgLabel("UI/xi_sui_panel/liliang.png",2)
		createDesc("力量成长影响物攻、物防",2)
		createCutLine(2)
		createPercent(general.str_grow/ceil,2)
		local bar = new(Bar2)
        bar:create(ceil, XI_SUI_BAR_CFG[2])
		bar:setExtent(general.str_grow)	
		self.rightPanel:addChild(bar.barbg)
		
		--智力
		createImgLabel("UI/xi_sui_panel/zhili.png",3)
		createDesc("智力成长影响法攻、法防",3)
		createCutLine(3)
		createPercent(general.int_grow/ceil,3)
		local bar = new(Bar2)
        bar:create(ceil, XI_SUI_BAR_CFG[3])
		bar:setExtent(general.int_grow)	
		self.rightPanel:addChild(bar.barbg)

		--敏捷
		createImgLabel("UI/xi_sui_panel/minjie.png",4)
		createDesc("敏捷成长影响速度",4)
		createPercent(general.agi_grow/ceil,4)
		local bar = new(Bar2)
        bar:create(ceil, XI_SUI_BAR_CFG[4])
		bar:setExtent(general.agi_grow)	
		self.rightPanel:addChild(bar.barbg)
	end,

	--培养改变
	createChange = function(self)
		if not self:trainButtonState() then
			return
		end
		local general = GloblePlayerData.generals[GloblePanel.curGenerals]
		
		local data = {
				general.temp_sta_grow - general.sta_grow,
				general.temp_str_grow - general.str_grow,
				general.temp_int_grow - general.int_grow,
				general.temp_agi_grow - general.agi_grow,
			}

		for i=1,table.getn(data) do
			local value = data[i]
			local up_or_down = nil
			if value<0 then
				value = -value
				up_or_down = "UI/public/ars_down.png"
			else
				up_or_down = "UI/public/ars_up.png"
			end
			local spr = CCSprite:spriteWithFile(up_or_down)
			spr:setPosition(CCPoint(595, 490-(i-1)*92))
			spr:setAnchorPoint(CCPoint(0,0))
			self.rightPanel:addChild(spr)
						
			local label = new(NumberLabel)
			label:create(value)
			label.bg:setPosition(CCPoint(650, 490-(i-1)*92))
			label.bg:setAnchorPoint(CCPoint(0,0))
			self.rightPanel:addChild(label.bg)
		end
	end,

	--创建人物属性框
	createAttrs = function(self)
		local general = GloblePlayerData.generals[GloblePanel.curGenerals]
		
		--黄色小背景
		self.attrsPanel = createBG("UI/xi_sui_panel/small_bg.png",644,159)
		self.attrsPanel:setAnchorPoint(CCPoint(0.5,0))
		self.attrsPanel:setPosition(CCPoint(710/2, 15))
		self.rightPanel:addChild(self.attrsPanel)
		
		--生命
		local label = CCLabelTTF:labelWithString("生命："..general.health_point,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)	
		label:setPosition(CCPoint(25,125))
		label:setColor(ccc3(109,58,1))
		label:setAnchorPoint(CCPoint(0, 0))
		self.attrsPanel:addChild(label)
		
		--物/法攻
		local attack = nil
		if general.job < 3 then	--物攻
			attack = "物攻："..general.physical_attack
		else					--法攻
			attack = "法攻："..general.spell_attack
		end
		local label = CCLabelTTF:labelWithString(attack,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)	
		label:setPosition(CCPoint(25 + 160 * 1,125))
		label:setColor(ccc3(109,58,1))
		label:setAnchorPoint(CCPoint(0, 0))
		self.attrsPanel:addChild(label)
		
		--物防
		label = CCLabelTTF:labelWithString("物防："..general.physical_defence,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)	
		label:setPosition(CCPoint(25,100))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(109,58,1))
		self.attrsPanel:addChild(label)
		
		--法防
		label = CCLabelTTF:labelWithString("法防："..general.spell_defence,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)	
		label:setPosition(CCPoint(25+160*1,100))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(109,58,1))
		self.attrsPanel:addChild(label)
	
		--速度
		label = CCLabelTTF:labelWithString("速度："..general.speed,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)	
		label:setPosition(CCPoint(25+160*2,100))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(109,58,1))
		self.attrsPanel:addChild(label)	
	end,
	
	--按钮
	createBtns = function(self)
		self.btn_WeiChi = dbUIButtonScale:buttonWithImage("UI/xi_sui_panel/weichi.png",1.2,ccc3(0,255,255))
		self.btn_WeiChi:setPosition(CCPoint(710/2-105, 55))
		self.btn_WeiChi:setAnchorPoint(CCPoint(0.5,0.5))

		self.btn_TiHuan = dbUIButtonScale:buttonWithImage("UI/xi_sui_panel/tihuan.png",1.2,ccc3(0,255,255))
		self.btn_TiHuan:setPosition(CCPoint(710/2+105, 55))
		self.btn_TiHuan:setAnchorPoint(CCPoint(0.5,0.5))

		self.btn_PeiYang = dbUIButtonScale:buttonWithImage("UI/xi_sui_panel/xisui.png",1.2,ccc3(0,255,255))
		self.btn_PeiYang:setPosition(CCPoint(710/2, 55))
		self.btn_PeiYang:setAnchorPoint(CCPoint(0.5,0.5))
		
		self.rightPanel:addChild(self.btn_WeiChi)
		self.rightPanel:addChild(self.btn_TiHuan)
		self.rightPanel:addChild(self.btn_PeiYang)
		
		--维持
		self.btn_WeiChi.m_nScriptClickedHandler = function()
			local polishRequest = {
				type = "conmit",
				action = 1,
			}
			self:Polish(polishRequest)			
		end
		--替换
		self.btn_TiHuan.m_nScriptClickedHandler = function()
			local polishRequest = {
				type = "conmit",
				action = 2,
			}
			self:Polish(polishRequest)
		end
		--培养按钮事件
		self.btn_PeiYang.m_nScriptClickedHandler = function(ccp)
			self.choose = public_getToggleRadioBtn(self.chooseTypeBtns)
			if self.choose == 0 then
				ShowInfoDialog(String_tip2)
				return
			end
			local polishRequest = {
				type = "polish",
				quality = self.choose,
			}
			self:Polish(polishRequest)			
		end
	end,
	
	refurbishState = function(self)
		local state = self:trainButtonState()
		self:changeTrainButtonState(state)
	end,
	
	trainButtonState = function(self)
		local general = GloblePlayerData.generals[GloblePanel.curGenerals]
		return general.temp_str_grow ~= 0 or general.temp_int_grow ~= 0 or general.temp_sta_grow ~= 0 or general.temp_agi_grow ~= 0
	end,
	
	changeTrainButtonState = function(self,state)
		if state then
			self.btn_WeiChi:setIsVisible(true)
			self.btn_TiHuan:setIsVisible(true)
			self.btn_PeiYang:setIsVisible(false)
		else
			self.btn_WeiChi:setIsVisible(false)
			self.btn_TiHuan:setIsVisible(false)
			self.btn_PeiYang:setIsVisible(true)
		end
	end,
	
	Polish = function(self,polish)
		local function opPolishFinishCB(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()	
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				GloblePlayerData.cultivate_count = s:getByKey("cultivate_count"):asInt()	--今天洗髓次数
				local general = GloblePlayerData.generals[GloblePanel.curGenerals]
				
				if polish.type == "polish" then --培养
					mappedPlayerPolishSimpleData(s)
					GloblePlayerData.gold = s:getByKey("gold"):asInt()
					GloblePlayerData.copper = s:getByKey("copper"):asInt()
					updataHUDData()
				elseif polish.action == 2 then --替换
					mappedPlayerPolishConfirmSimple(s)
					general.str_grow = general.temp_str_grow
					general.int_grow = general.temp_int_grow 
					general.sta_grow = general.temp_sta_grow
					general.agi_grow = general.temp_agi_grow
					general.temp_str_grow = 0
					general.temp_int_grow = 0
					general.temp_sta_grow = 0
					general.temp_agi_grow = 0
					
					if GlobleGeneralListPanel then
						GlobleGeneralListPanel:reflash()
					end
					GloblePlayerData.gold = s:getByKey("gold"):asInt()
					GloblePlayerData.copper = s:getByKey("copper"):asInt()
					updataHUDData()
				elseif polish.action == 1 then --维持
					general.temp_str_grow = 0
					general.temp_int_grow = 0
					general.temp_sta_grow = 0
					general.temp_agi_grow = 0
				end
				self:createRight()
				self:createLeft()
				GotoNextStepGuide()
			end
		end
		
		local function execPolish()
			showWaitDialogNoCircle("waiting polish!")
	
			local cj = Value:new()
			
			if polish.type == "polish" then
				NetMgr:registOpLuaFinishedCB(Net.OPT_PolishSimple, opPolishFinishCB)
				NetMgr:registOpLuaFailedCB(Net.OPT_PolishSimple, opFailedCB)
				cj:setByKey("role_id", ClientData.role_id)
				cj:setByKey("request_code", ClientData.request_code)
				cj:setByKey("general_id", GloblePlayerData.generals[GloblePanel.curGenerals].general_id)
				cj:setByKey("type", polish.quality)
				
				NetMgr:executeOperate(Net.OPT_PolishSimple, cj)
			end
			
			if polish.type == "conmit" then
				NetMgr:registOpLuaFinishedCB(Net.OPT_PolishConfirmSimple, opPolishFinishCB)
				NetMgr:registOpLuaFailedCB(Net.OPT_PolishConfirmSimple, opFailedCB)
				cj:setByKey("role_id", ClientData.role_id)
				cj:setByKey("request_code", ClientData.request_code)
				cj:setByKey("general_id", GloblePlayerData.generals[GloblePanel.curGenerals].general_id)
				cj:setByKey("action", polish.action)
				NetMgr:executeOperate(Net.OPT_PolishConfirmSimple, cj)
			end
		end
		execPolish()
	end
}

function globleShowJiFete()
	GlobleFetePanel = new(FetePanel)
	GlobleFetePanel:create()
end

function createFeteBg()
	local bgLayer = dbUILayer:node()

	local bg =  CCSprite:spriteWithFile("UI/ji_xing/bg.jpg")
	bg:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
	bg:setAnchorPoint(CCPoint(0.5,0.5))
	bg:setScaleX(WINSIZE.width / bg:getContentSize().width)
	bg:setScaleY(WINSIZE.height / bg:getContentSize().height)
	bgLayer:addChild(bg)

	local mask = dbUIPanel:panelWithSize(WINSIZE)
	mask:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
	mask:setAnchorPoint(CCPoint(0.5,0.5))
	bgLayer:addChild(mask)

	return bgLayer
end

local fete_item_cfg = {
	{
		itemid  = 10000074,
		part = 0,
	},
	{
		itemid  = 10000075,
		part = 0,
	},
	{
		itemid  = 10000076,
		part = 0,
	},
	{
		itemid  = 10000077,
		part = 0,
	},
	{
		itemid  = 10000078,
		part = 0,
	}
}

FetePanel = {
	form = nil,
	bgLayer = nil,
	uiLayer = nil,
	souls = {},
	m_items = {},
	m_btns = {},
	souls_spr = {},
	dexcText = {
		"7000银币",
		"9000银币",
		"18000银币",
		"38000银币",
		"100金币",
	},
	other = {},

	chooseViporGold = function(self,m_type,is)
		local vip = 5
		for i = 0, 9 do
			if cfg_vip_data[i+1].auto_fate~=nil and cfg_vip_data[i+1].auto_fate==1 then
				vip = i
				break
			end
		end

		local toupdate = function(ccp)
			local now = GloblePlayerData.vip_charge
			tovip5=cfg_vip_data[6].total_charge-now
			GlobalCreatePayPanel()
		end
		
		local fivegold = function(ccp)
			self:feteAction(m_type,is)
		end

		local btns = {}
		local bs = new(ButtonScale)
		bs:create("UI/ji_xing/jb.png",1.2,ccc3(100,100,100)," ")
		local bsn = new(ButtonScale)
		bsn:create("UI/ji_xing/cz.png",1.2,ccc3(100,100,100)," ")
		btns[1] = bs.btn
		btns[1].action = fivegold
		btns[2] = bsn.btn
		btns[2].action = toupdate

		local dialogCfg = new(basicDialogCfg)
		dialogCfg.title =""
		dialogCfg.msg = "花费5金币     VIP"..vip.."免费"
		dialogCfg.msgAlign="center"
		dialogCfg.dialogType = 105
		dialogCfg.btns = btns
		new(Dialog):create(dialogCfg)
	end,
	create = function(self)
		---------------------------------------------------------------------------
		local scene = DIRECTOR:getRunningScene()
		self.bgLayer = createFeteBg()
		self.uiLayer,self.mainWidget = createCenterWidget()
		scene:addChild(self.bgLayer, 3000)
		scene:addChild(self.uiLayer, 3004)

		-------关闭按鈕
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/ji_xing/close.png",1.2)
		closeBtn.btn:setScale(isRetina)
        closeBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		closeBtn.btn:setPosition(CCPoint(self.mainWidget:getContentSize().width-closeBtn.btn:getContentSize().width/2,self.mainWidget:getContentSize().height-closeBtn.btn:getContentSize().height/2))
		self.mainWidget:addChild(closeBtn.btn)
		closeBtn.btn.m_nScriptClickedHandler = function(ccp)
			self.uiLayer:removeFromParentAndCleanup(true)
			self.bgLayer:removeFromParentAndCleanup(true)
			GlobleFetePanel = nil
			GlobleXiaoXingXin = nil
			GlobleFirstFete = nil
			gotoBagBtn = nil
			GlobleGetSoulOk = nil
			self.getBtn = nil
			GotoNextStepGuide()
		end
		GlobleFetePanel.closeBtn = closeBtn.btn

		local btn_kuang_panel = dbUIPanel:panelWithSize(CCSize(793,75))
		btn_kuang_panel:setAnchorPoint(CCPoint(0.5,0.5))
		btn_kuang_panel:setPosition(CCPoint(1010/2,700/2-100))
		self.mainWidget:addChild(btn_kuang_panel)
		local btn_bg = CCSprite:spriteWithFile("UI/ji_xing/btn_bg.png")
		btn_bg:setPosition(CCPoint(793/2,75/2))
		btn_kuang_panel:addChild(btn_bg)

		-------說明
		local feteBtn = new(ButtonScale)
		feteBtn:create("UI/ji_xing/sm.png",1.2)
		feteBtn.btn:setScale(isRetina)
        feteBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		feteBtn.btn:setPosition(CCPoint(25+72,75/2))
		btn_kuang_panel:addChild(feteBtn.btn)

		local text =
		"1、选择一个星位进行祭星，有机会免费开启更高等级的星位。"..
		"\n2、一键卖出仅卖掉面板上所有的煞星。"..
		"\n3、一键拾取直接将面板上所有除煞星以外的星魂放入星魂背包中。"..
		"\n4、星魂品质依次为：白<绿<蓝<紫<橙。"..
		"\n5、自动祭星时，系统从低级星位开始祭星，当出现高级星位时，自动使用高级星位祭星，至触发超新星时停止。"

		feteBtn.btn.m_nScriptClickedHandler = function(ccp)
			local dialogCfg = new(basicDialogCfg)
			dialogCfg.title = "祭星说明"
			dialogCfg.msg = text
			dialogCfg.msgAlign = "left"
			dialogCfg.bg = "UI/baoguoPanel/kuang.png"
			dialogCfg.position = CCPoint(WINSIZE.width / 2, WINSIZE.height / 2)
			dialogCfg.dialogType = 5
			dialogCfg.msgSize = 30
			dialogCfg.size = CCSize(1024,0);
			dialogCfg.btns = btns
			local dialog = new(Dialog)
			dialog:create(dialogCfg)
		end
		-------一鍵賣出
		local sellBtn = new(ButtonScale)
		sellBtn:create("UI/ji_xing/mai_chu.png",1.2)
		sellBtn.btn:setScale(isRetina)
        sellBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		sellBtn.btn:setPosition(CCPoint(25+72+195,75/2))
		btn_kuang_panel:addChild(sellBtn.btn)
		sellBtn.btn.m_nScriptClickedHandler = function(ccp)
			self:oneKeyAction(2)
		end
		-------一鍵拾取
		local getBtn = new(ButtonScale)
		getBtn:create("UI/ji_xing/get.png",1.2)
		--getBtn.btn:setScale(isRetina)
        getBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		getBtn.btn:setScale(isRetina)
        getBtn.btn:setPosition(CCPoint(25+72+195*2,75/2))
		btn_kuang_panel:addChild(getBtn.btn)
		getBtn.btn.m_nScriptClickedHandler = function(ccp)
			for  i = 1 , table.getn(self.souls_spr) do
				self.souls_spr[i]:runAction(CCMoveTo:actionWithDuration(1,CCPoint(775,90)))
				self.souls_spr[i]:runAction(CCFadeTo:actionWithDuration(1,0))
			end
			self:oneKeyAction(1)
		end
		self.getBtn = getBtn.btn

		-------一鍵疾星
		local feteBtn = new(ButtonScale)
		feteBtn:create("UI/ji_xing/zi_dong.png",1.2)
		feteBtn.btn:setScale(isRetina)
        feteBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		feteBtn.btn:setPosition(CCPoint(25+72+195*3,75/2))
		feteBtn.btn.m_nScriptClickedHandler = function(ccp)
			if #FeteData.soul_list >=20 then
				alert("祭星已满！")
				return
			end
						
			local vip = GloblePlayerData.vip_level
			local now = GloblePlayerData.vip_charge
			local m_type = 1
			for  i = 1 , table.getn(FeteData.soul_alter) do
				if FeteData.soul_alter[table.getn(FeteData.soul_alter)-i] then
					m_type = table.getn(FeteData.soul_alter)-i
					break
				end
			end
			if vip >= 5 then
				self:feteAction(m_type,true)
			else
				self:chooseViporGold(m_type,true)
			end
		end
		btn_kuang_panel:addChild(feteBtn.btn)
		self:initData()
	end,


	createSouldPos  =  function(self)
		local x_pos = 0
		local y_pos = 0
		self.m_items = new ({})
		self.souls_spr = new ({})
		for  i = 1 , table.getn(FeteData.soul_list) do
			local item = dbUIPanel:panelWithSize(CCSize(80,120))
			item:setAnchorPoint(CCPoint(0,0))
			item:setPosition(67+x_pos*90,568 - y_pos*160 )
			local spr = CCSprite:spriteWithFile("UI/ji_xing/fete_sprite_bg"..(i%2+1)..".png")
			--spr:setScale(isRetina)
            spr:setAnchorPoint(CCPoint(0.5,0.5))
			spr:setScale(0.7*isRetina)
			spr:setPosition(item:getContentSize().width/2,75)
			item:addChild(spr,1)
			----添加動畫
			local spr = CCSprite:spriteWithFile("UI/ji_xing/fete_sprite_bg2.png")
			spr:setScale(0.7*isRetina)
			spr:setAnchorPoint(CCPoint(0.5,0.5))
			local animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("soul/soul_"..FeteData.soul_list[i].icon)
			local action = CCAnimate:actionWithAnimation(animation)
			spr:runAction(CCRepeatForever:actionWithAction(action))
			spr:setPosition(item:getContentSize().width/2,75)
			item:addChild(spr,1)
			------名字
			local txt = CCLabelTTF:labelWithString(FeteData.soul_list[i].name, SYSFONT[EQUIPMENT], 19)
			txt:setColor(SOUL_COLOR[FeteData.soul_list[i].quality])
			txt:setAnchorPoint(CCPoint(0.5, 0))
			txt:setPosition(CCPoint( item:getContentSize().width/2, 0))
			item:addChild(txt,1)
			------------------------------------------item 事件
			item.m_nScriptClickedHandler = function()
				local dialogCfg = new(basicDialogCfg)
				dialogCfg.title = ""..FeteData.soul_list[i].name
				dialogCfg.titleColor = SOUL_COLOR[FeteData.soul_list[i].quality]
				dialogCfg.dialogType = 5
				local btns = {}
				local bs = new(ButtonScale)
				bs:create("UI/public/noTextBtn.png",1.2,ccc3(255,255,255),"卖出")
				btns[1]=bs.btn
				btns[1].action = function()
					self:soulAction(1,FeteData.soul_list[i].soul_id)
				end
				----------------------如果不是碎魂
				if FeteData.soul_list[i].icon == 1 then
					dialogCfg.msg = "\n"
				else
					dialogCfg.msg =  soul_ability_type[FeteData.soul_list[i].ability_type].."+"..FeteData.soul_list[i].ability_base.."\n"
					bs = new(ButtonScale)
					bs:create("UI/public/noTextBtn.png",1.2,ccc3(255,255,255),"拾取")
					btns[2]=bs.btn
					btns[2].action = function()
						self:soulAction(2,FeteData.soul_list[i].soul_id)
					end
				end
				dialogCfg.btns = btns
				new(Dialog):create(dialogCfg)
			end
			self.mainWidget:addChild(item,1)

			x_pos = x_pos +1
			if x_pos == 10 then
				x_pos = 0
				y_pos = 1
			end

			self.m_items[i] = item
		end
	end,
	creatBtns = function(self)
		self.btns = new ({})
		self.other = new ({})
		local BTN_POS = {
			CCPoint(700-150*4,130),
			CCPoint(700-150*3,130),
			CCPoint(700-150*2,130),
			CCPoint(700-150,130),
			CCPoint(720,130),
		}

		for  i = 1 , table.getn(FeteData.soul_alter) do
			self.mainWidget:removeChildByTag(100+i)

			local btn = dbUIButtonToggle:buttonWithImage("UI/ji_xing/jz_"..i.."_2.png","UI/ji_xing/jz_"..i..".png")
			--btn:setScale(isRetina)
            btn:setPosition(BTN_POS[i])
			btn:setScale(0.6*isRetina)
			btn:setAnchorPoint(CCPoint(0.5,0.5))
			if i>1 and i<5 then
				local to = CCSprite:spriteWithFile("UI/ji_xing/to.png")
				if i==5 then
					to:setPosition(CCPoint(i*150-127+5,130))
				else
					to:setPosition(CCPoint(i*150-127,130))
				end
                to:setScale(isRetina)
				self.mainWidget:addChild(to)
			end

			if 	FeteData.soul_alter[i] then
				btn:toggled(true)
				btn:setIsEnabled(true)
				btn.m_nScriptClickedHandler = function()
					if #FeteData.soul_list >=20 then
						alert("祭星已满！")
						btn:toggled(false)
						return
					end
					self:feteAction(i)
				end
			else
				btn:toggled(false)
				btn:setIsEnabled(false)
				btn.m_nScriptClickedHandler = function()
					if #FeteData.soul_list >=20 then
						alert("祭星已满！")
						return
					end
					if GloblePlayerData.xiang[i] ~= nil and GloblePlayerData.xiang[i] ~= 0 then
						btn:toggled(false)
						local dialogCfg = new(basicDialogCfg)
						dialogCfg.msg = "是否使用超新星牌,点亮超新星,您拥有"..GloblePlayerData.xiang[i].."个！"
						dialogCfg.msgAlign = "center"
						dialogCfg.bg = "UI/baoguoPanel/kuang.png"
						local a,b = btn:getPosition()
						dialogCfg.position = CCPoint(a,b)
						dialogCfg.dialogType = 5
						local btns = {}
						local bs = new(ButtonScale)
						bs:create("UI/public/noTextBtn.png",1.2,ccc3(255,255,255),"确定")
						btns[1]=bs.btn
						local useCallback = function()
							FeteData.soul_alter[i] = true
							btn:toggled(true)
							btn:setIsEnabled(true)
							btn.m_nScriptClickedHandler = function( )
								self:feteAction(i)
							end
						end
						local localUseItem = function(ccp,item)
							UseItem(ccp,item,useCallback)
							GloblePlayerData.xiang[i] = GloblePlayerData.xiang[i] - 1
						end
						btns[1].action = localUseItem

						local items = findItemsByItemCfgId1(fete_item_cfg[i].itemid)

						btns[1].param = items

						dialogCfg.btns = btns
						local dialog = new(Dialog)
						dialog:create(dialogCfg)

					elseif i==5 then
						btn:toggled(false)
						local can = true
						local msg = "是否花费100金币点亮超新星"
						if GloblePlayerData.gold<100 then
							can = false
							msg = "您的金币不足100金了"
						end
						local dialogCfg = new(basicDialogCfg)
						dialogCfg.msg = msg
						dialogCfg.msgAlign = "center"
						dialogCfg.bg = "UI/baoguoPanel/kuang.png"
						local a,b = btn:getPosition()
						dialogCfg.position = CCPoint(a,b)
						dialogCfg.dialogType = 5

						local btns = {}
						local bs = new(ButtonScale)
						bs:create("UI/public/noTextBtn.png",1.2,ccc3(255,255,255),"确定")
						btns[1] = bs.btn

						local useCallback = function()
							GloblePlayerData.gold = GloblePlayerData.gold - 100
							updataHUDData()

							local index = 0
							for i=1,table.getn(self.other) do
								if self.other[i]==self.moneyLabel then
									index = i
									break;
								end
							end

							if index>0 then
								self.moneyLabel:removeFromParentAndCleanup(true)
								self.moneyLabel = nil

								local str  = ("UI/ji_xing/jin_bi.png,0|"..getShotNumber(GloblePlayerData.gold)..",0,FFFFFF|   |UI/ji_xing/yin_bi.png,0|"..getShotNumber(GloblePlayerData.copper)..",0,FFFFFF")
								local  message = dbUILabel:colorText(str,SYSFONT[EQUIPMENT], 20)
								message:setPosition(CCPoint(20,710))
								self.mainWidget:addChild(message,2)
								self.moneyLabel = message
								self.other[index] = message
							end

							FeteData.soul_alter[i] = true
							btn:toggled(true)
							btn:setIsEnabled(true)
							btn.m_nScriptClickedHandler = function( )
								self:feteAction(i)
							end
						end
						local localUseItem = function(ccp,item)
							UseItem(ccp,item,useCallback)
						end
						local items = findItemsByItemCfgId1(fete_item_cfg[i].itemid)
						btns[1].action = can==true and localUseItem or nothing
						btns[1].param = {id=1,item_id=777777,amount=1,name="金币"}
						dialogCfg.btns = btns
						new(Dialog):create(dialogCfg)
					end
				end
			end

			if i==5 then
				btn:setIsEnabled(true)
				btn:toggled(FeteData.soul_alter[5])
			end
			if i==1 then --新手引导时用到
				GlobleXiaoXingXin = btn
			end
			local txt = CCLabelTTF:labelWithString(self.dexcText[i], SYSFONT[EQUIPMENT], 22/isRetina)
			txt:setAnchorPoint(CCPoint(0.5, 1))
			txt:setPosition(CCPoint(btn:getContentSize().width/2,-20))
			txt:setScale(1/0.6)
			btn:addChild(txt)

			self.mainWidget:addChild(btn,1,100+i)
			self.btns[i] = btn
			self.other[i] = txt
		end
		gotoBagBtn = dbUIButtonScale:buttonWithImage("UI/ji_xing/beibao.png",1.2)
		--closeBtn.btn
        gotoBagBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		gotoBagBtn:setPosition(CCPoint(900,120))
		gotoBagBtn:setScale(0.7*isRetina)
		gotoBagBtn.m_nScriptClickedHandler = function( )
			globleShowJiXingPanel()
		end
		self.mainWidget:addChild(gotoBagBtn,2)
		self.other[table.getn(self.other)+1] = gotoBagBtn

		local str  = ("UI/ji_xing/jin_bi.png,0|"..getShotNumber(GloblePlayerData.gold)..",0,FFFFFF|   |UI/ji_xing/yin_bi.png,0|"..getShotNumber(GloblePlayerData.copper)..",0,FFFFFF")
		local  message = dbUILabel:colorText(str,SYSFONT[EQUIPMENT], 20)
		message:setPosition(CCPoint(20,710))
		self.mainWidget:addChild(message,2)
		self.moneyLabel = message
		self.other[table.getn(self.other)+1] = message

		local message_bg = dbUIWidgetBGFactory:widgetBG()
		message_bg:setCornerSize(CCSizeMake(20,10))
		message_bg:setBGSize(CCSizeMake(250,43))
		message_bg:setAnchorPoint(CCPoint(0,0))
		message_bg:createCeil("UI/ji_xing/jin_bi_bg.png")
		message_bg:setPosition(20,690 )
		self.mainWidget:addChild(message_bg,1)
		self.other[table.getn(self.other)+1] = message_bg
	end,

	initData = function(self)
		local Reponse = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				initFeteData(json)
				self:createSouldPos()
				self:creatBtns()
				
				GotoStepGuide(3)
			end
		end

		local sendRequest = function ()
			showWaitDialogNoCircle("waiting skillLock!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_SoulAltar,Reponse)
			NetMgr:registOpLuaFailedCB(Net.OPT_SoulAltar,opFailedCB)
			local cj = Value:new()

			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(Net.OPT_SoulAltar, cj)
		end
		sendRequest()
	end,
	------------祭祀
	feteAction = function(self,m_type,isAuto)
		local send = nil
		isAuto = isAuto or false
		
		local count = table.getn(FeteData.soul_list)
		local Reponse = function (json)
			closeWait()
			GlobleJiXingFinished = true
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				self:m_removeAll()
				initFeteData(json)
				self:createSouldPos()
				self:creatBtns()
				if isAuto then
					if FeteData.soul_alter[5] then
						local dialogCfg = new(basicDialogCfg)
						dialogCfg.title = "提示"
						dialogCfg.msg = "已触发超新星，自动祭星停止"
						dialogCfg.dialogType = 5
						new(Dialog):create(dialogCfg)
						self.btns[5]:toggled(true)
					else
						m_type = 1
						for  i = 1 , table.getn(FeteData.soul_alter) do
							if FeteData.soul_alter[table.getn(FeteData.soul_alter)-i] then
								m_type = table.getn(FeteData.soul_alter)-i
								break
							end
						end
						if count < 20 then
							send(false)
						end
						count = count +1
					end
				end
				GlobleFirstFete = true
				GotoNextStepGuide()
			end
		end

		local sendRequest = function (is_auto)
			showWaitDialogNoCircle("waiting skillLock!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_SoulWorShip,Reponse)
			NetMgr:registOpLuaFailedCB(Net.OPT_SoulWorShip,opFailedCB)
			local cj = Value:new()

			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("type", m_type)
			cj:setByKey("is_auto",is_auto)
			NetMgr:executeOperate(Net.OPT_SoulWorShip, cj)
		end
		send = sendRequest
		sendRequest(isAuto)
	end,
	------------  一鍵 祭祀 賣出
	oneKeyAction = function(self,m_type)
		local Reponse = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()

			if error_code > 0 and error_code~=2002 then
				ShowErrorInfoDialog(error_code)
			else
				----判斷是不是拾取
				if m_type == 1 then
					GlobleGetSoulOk = true
					local last_list = FeteData.soul_list
					initFeteData(json)
					self:copySprites(last_list,FeteData.soul_list)
					GotoNextStepGuide()
				else
					initFeteData(json)
					self:m_removeAll()
					self:createSouldPos()
					self:creatBtns()
				end

				if error_code==2002 then
					ShowErrorInfoDialog(error_code)
				end
			end
		end
		local sendRequest = function ()
			--發送請求
			local action = Net.OPT_SoulGetAll
			if m_type == 1 then
				action = Net.OPT_SoulGetAll
			elseif m_type == 2 then
				action = Net.OPT_SoulSellAll
			end
			showWaitDialogNoCircle("waiting skillLock!")
			NetMgr:registOpLuaFinishedCB(action,Reponse)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,
	------------賣出  或者 拾取
	soulAction = function(self,m_type,soul_id)
		local Reponse = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				self:m_removeAll()
				initFeteData(json)
				self:createSouldPos()
				self:creatBtns()
			end
		end
		local sendRequest = function ()
			--發送請求   1 賣出   2  拾取
			local action = Net.OPT_SoulSell
			if m_type == 1 then
				action = Net.OPT_SoulSell
			elseif m_type == 2 then
				action = Net.OPT_SoulGet
			end
			showWaitDialogNoCircle("waiting skillLock!")
			NetMgr:registOpLuaFinishedCB(action,Reponse)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("soul_id",soul_id)
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,
	copySprites = function(self,lastSouls,nowSouls)
		local spitesWillKill = ({})
		for x=1 , table.getn(lastSouls) do
			local isHas = false
			for y=1 , table.getn(nowSouls) do
				if lastSouls[x].soul_id == nowSouls[y].soul_id then
					isHas = true
				end
			end
			if not(isHas) then
				spitesWillKill[table.getn(spitesWillKill)+1] = lastSouls[x]
				spitesWillKill[table.getn(spitesWillKill)].lastIndex = x
			end
		end
		self.souls_spr = ({})
		for i = 1 , table.getn(spitesWillKill) do
			local item = self.m_items[spitesWillKill[i].lastIndex]
			local m_x,m_y = item:getPosition()
			local temp_spr = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			temp_spr:setAnchorPoint(CCPoint(0.5,0.5))
			local animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("soul/soul_"..spitesWillKill[i].icon)
			local action = CCAnimate:actionWithAnimation(animation)
			temp_spr:runAction(CCRepeatForever:actionWithAction(action))
			temp_spr:setPosition(m_x+item:getContentSize().width/2,m_y+75)
			self.souls_spr[table.getn(self.souls_spr)+1] = temp_spr
			self.mainWidget:addChild(temp_spr,10)

		end
		for  i = 1 , table.getn(self.souls_spr) do
			self.souls_spr[i]:runAction(CCMoveTo:actionWithDuration(1,CCPoint(900,90)))
			self.souls_spr[i]:runAction(CCFadeTo:actionWithDuration(1,0))
		end
		local callback = function()
			closeWait()
			self:m_removeAll()
			self:createSouldPos()
			self:creatBtns()
		end
		local j = 1
		j = callback
		local array = CCArray:arrayWithCapacity(2)
		array:addObject(CCDelayTime:actionWithDuration(1.1))
		array:addObject(dbDoScriptFuncAction:actionWithScirptFunc(j))
		local seq = CCSequence:actionsWithArray(array)
		showWaitDialogNoCircle("")
		self.mainWidget:runAction(seq)
	end,
	m_removeAll = function(self)
		for i = 1 , table.getn(self.m_items) do
			self.m_items[i]:removeFromParentAndCleanup(true)
		end
		for i = 1 , table.getn(self.m_btns) do
			self.m_btns[i]:removeFromParentAndCleanup(true)
		end
		for i = 1 , table.getn(self.other) do
			self.other[i]:removeFromParentAndCleanup(true)
		end
		for  i = 1 , table.getn(self.souls_spr) do
			self.souls_spr[i]:removeFromParentAndCleanup(true)
		end
	end
}
FeteData = {
	soul_list = {},
	soul_alter = {},
}
function initFeteData(json)
	local m_soul_list = json:getByKey("soul_list")
	local m_soul_alter = json:getByKey("soul_alter")
	GloblePlayerData.gold = json:getByKey("gold"):asInt()
	GloblePlayerData.copper = json:getByKey("copper"):asInt()
	GloblePlayerData.soul_cell_count =json:getByKey("soul_cell_count"):asInt()
	updataHUDData()
	FeteData = new({})
	FeteData.soul_list = new({})
	FeteData.soul_alter = new({})

	for i = 1,m_soul_alter:size() do
		FeteData.soul_alter[i] = m_soul_alter:getByIndex(i-1):asBool()
	end
	local soul_json_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_soul.json")
	for i = 1,m_soul_list:size() do
		local cfg_data  = soul_json_cfg:getByKey(tostring(m_soul_list:getByIndex(i-1):getByKey("cfg_soul_id"):asInt()))
		local data =  m_soul_list:getByIndex(i-1)
		FeteData.soul_list[i] = new({})
		FeteData.soul_list[i].soul_id = data:getByKey("soul_id"):asInt()
		FeteData.soul_list[i].cfg_soul_id = data:getByKey("cfg_soul_id"):asInt()
		-----------cfg
		FeteData.soul_list[i].ability_base = cfg_data:getByKey("ability_base"):asInt()
		FeteData.soul_list[i].ability_grow =cfg_data:getByKey("ability_grow"):asInt()
		FeteData.soul_list[i].ability_type =cfg_data:getByKey("ability_type"):asInt()
		FeteData.soul_list[i].eat_exp =cfg_data:getByKey("eat_exp"):asInt()
		FeteData.soul_list[i].icon =cfg_data:getByKey("icon"):asInt()
		FeteData.soul_list[i].level_param =cfg_data:getByKey("level_param"):asInt()
		FeteData.soul_list[i].name =cfg_data:getByKey("name"):asString()
		FeteData.soul_list[i].quality =cfg_data:getByKey("quality"):asInt()
		FeteData.soul_list[i].sell_price =cfg_data:getByKey("sell_price"):asInt()
		--soul_cell_count
	end
end
--祭星
function globleShowJiXingPanel()
	local function opSoulBagFinishCB(json)
		closeWait()
		local error_code = json:getByKey("error_code"):asInt()

		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			getWunHunInfo(json)
			GlobleJiXingPanel = new(JiXingPanel):create()
			GotoNextStepGuide()
		end
	end
	local function opSoulBagFailedCB()
	end
	local function execSoulBag()
		showWaitDialog("waiting execSoulBag!")

		NetMgr:registOpLuaFinishedCB(Net.OPT_SoulBag,opSoulBagFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_SoulBag,opSoulBagFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(Net.OPT_SoulBag, cj)
	end
	execSoulBag()
end

JiXingPanel = {
	role = nil,
	usingKuang = {},
	curGeneralIndex = 1,
	
	create = function (self)

		self.role = GloblePlayerData.generals[self.curGeneralIndex]
		
		self:initBase()
		self:createMain()
		return self
	end,

	createMain = function(self)
	  --Log("create"..self.role.name)
		self.panel = dbUIPanel:panelWithSize(CCSize(933,545))
		self.panel:setAnchorPoint(CCPoint(0, 0))
		self.panel:setPosition(CCPoint(40, 38))
		self.mainWidget:addChild(self.panel)
		
		self.leftBg = createDarkBG(435,545)
		self.leftBg:setAnchorPoint(CCPoint(0, 0))
		self.leftBg:setPosition(CCPoint(0,0))
		self.panel:addChild(self.leftBg,-1)

		self.rightBg = createDarkBG(485,545)
		self.rightBg:setAnchorPoint(CCPoint(0, 0))
		self.rightBg:setPosition(CCPoint(446, 0))
		self.panel:addChild(self.rightBg,-1)

		self:createLeft()
		self:createRight()
	end,

	reflash = function(self)
	self:destroyScheduler()
	-------------------相当费解啊------------------------------------
	 self.role = GloblePlayerData.generals[self.curGeneralIndex]
	 ----------------------------------------------------------------------
	 --Log("reflashfirset__mem_soul_1:"..self.role.general.mem_soul_1.."\n".."mem_soul_2:"..self.role.general.mem_soul_2.."\n".."mem_soul_3:"..self.role.general.mem_soul_3.."\n".."mem_soul_4"..self.role.general.mem_soul_4.."\n".."mem_soul_5"..self.role.general.mem_soul_5.."\n".."mem_soul_6"..self.role.general.mem_soul_6.."\n")
		self.mainWidget:removeAllChildrenWithCleanup(true)
		self:createMain()
	end,

	createLeft = function(self)
		local general = self.role
		local panel = self.panel

		--名字
		local label = CCLabelTTF:labelWithString(general.name,CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)
		label:setPosition(CCPoint(435/2,380))
		label:setAnchorPoint(CCPoint(0.5, 0))
		label:setColor(ccc3(153,204,1))
		panel:addChild(label)

		--等级
		local label = CCLabelTTF:labelWithString(general.level.."级",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(435/2,380-35))
		label:setAnchorPoint(CCPoint(0.5, 0))
		label:setColor(ccc3(248,100,0))
		panel:addChild(label)

		--头像
		local figure = CCSprite:spriteWithFile("head/Big/head_big_"..general.face..".png")
		figure:setAnchorPoint(CCPoint(0, 0.5))
		figure:setPosition((486 - figure:getContentSize().width)/2,panel:getContentSize().height/2)
		figure:setScale(0.8)
		panel:addChild(figure,-1)
		--职业
		local jobJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_job.json")
		local jobName = jobJsonConfig:getByKey(general.job):getByKey("name"):asString()
		local label = CCLabelTTF:labelWithString(jobName,CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)
		label:setPosition(CCPoint(435/2,119))
		label:setAnchorPoint(CCPoint(0.5, 0))
		label:setColor(ccc3(153,204,1))
		panel:addChild(label)

		--前一个按钮
		local img = nil
		local enable = true
		if self.curGeneralIndex==1 then
			img = "UI/public/prev_disable.png"
			enable = false
		else
			img = "UI/public/prev_enable.png"
		end
		local pre = new(ButtonScale)
		pre:create(img,1.2)
		pre.btn:setAnchorPoint(CCPoint(0, 0))
		pre.btn:setPosition(120, 45)
		pre.btn:setIsEnabled(enable)
		pre.btn.m_nScriptClickedHandler = function(ccp)
			self.curGeneralIndex = self.curGeneralIndex - 1
			self.role = GloblePlayerData.generals[self.curGeneralIndex]
			self:reflash()
		end
		panel:addChild(pre.btn)

		--后一个按钮
		local roleCount = table.getn(GloblePlayerData.generals)
		local img = nil
		local enable = true
		if self.curGeneralIndex==roleCount then
			img = "UI/public/next_disable.png"
			enable = false
		else
			img = "UI/public/next_enable.png"
		end
		local next = new(ButtonScale)
		next:create(img,1.2)
		next.btn:setAnchorPoint(CCPoint(0, 0))
		next.btn:setPosition(260, 45)
		next.btn:setIsEnabled(enable)
		next.btn.m_nScriptClickedHandler = function(ccp)
			self.curGeneralIndex = self.curGeneralIndex + 1
			self.role = GloblePlayerData.generals[self.curGeneralIndex]
			self:reflash()
		end
		panel:addChild(next.btn)
		-- GloblePlayerData.officium=60
		--星魂位置框
		open_line=3
		local level = general.level
		if level>=60 and level<75 then
			open_line=4
		elseif level>=75 and level<90 then
			open_line=5
		elseif level>=90 then
			open_line=6
		end

		for i = 1 , 6 do
			local kuang = dbUIPanel:panelWithSize(CCSize(96,96))
			kuang:setAnchorPoint(CCPoint(0, 0))
			kuang:setPosition(JI_XING_ROLE_XH_POS_CFG[i].x,JI_XING_ROLE_XH_POS_CFG[i].y)


			local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			icon:setPosition(CCPoint(48,48))
			icon:setAnchorPoint(CCPoint(0.5, 0.5))
			kuang:addChild(icon,-1)
			if i > open_line then
				local lock = CCSprite:spriteWithFile("UI/public/locked_k.png")
				local desc = CCLabelTTF:labelWithString(JI_XING_OPEN_DESC[i-3],CCSize(0,0),0, SYSFONT[EQUIPMENT], 22)

				desc:setAnchorPoint(CCPoint(0.5, 0.5))
				desc:setPosition(CCPoint(48, 48))
				desc:setColor(ccc3(123,235,223))

				lock:setAnchorPoint(CCPoint(0.5, 0.5))
				lock:setPosition(CCPoint(48, 48))
				kuang:addChild(lock)
				kuang:addChild(desc)

			end
			panel:addChild(kuang,-1)
			self.usingKuang[i] = kuang
		end

		--把人物身上的星魂放上去
		self:createUsingXingHun(general,panel)
	end,

	--创建使用中的星魂
	createUsingXingHun = function(self,general,panel)
		getUsingList(general)
		self.usingItems = {}
		local count = 1
		for i=1,6 do
			local wuhun = wuHunUsing[i]
			if wuhun.soul_id ~= 0 then
				if wuhun.quality >1 then
					local icon = CCSprite:spriteWithFile(ITEM_QUALITY[wuhun.quality])
					icon:setPosition(CCPoint(0,0))
					icon:setAnchorPoint(CCPoint(0, 0))
					self.usingKuang[i]:addChild(icon)	
				end
				--同时有两个动画，这是低下的动画，这样拖动后还能显示
				local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
				icon:setPosition(JI_XING_ROLE_XH_POS_CFG[i].x,JI_XING_ROLE_XH_POS_CFG[i].y)
				icon:setAnchorPoint(CCPoint(0, 0))
				icon:setScale(isRetina)
				panel:addChild(icon)
				local animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("soul/soul_"..wuhun.icon)
				local action = CCAnimate:actionWithAnimation(animation)
				icon:runAction(CCRepeatForever:actionWithAction(action))

				local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
				icon:setPosition(CCPoint(48,48))
				icon:setAnchorPoint(CCPoint(0.5, 0.5))
                icon:setScale(isRetina)
				local animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("soul/soul_"..wuhun.icon)
				local action = CCAnimate:actionWithAnimation(animation)
				icon:runAction(CCRepeatForever:actionWithAction(action))

				local item = dbUIWidgetDragable:widgetDragable(icon)
				item:setContentSize(CCSize(96,96))
				item:setPosition(CCPoint(JI_XING_ROLE_XH_POS_CFG[i].x,JI_XING_ROLE_XH_POS_CFG[i].y))
				item:setAnchorPoint(CCPoint(0, 0))
				item.m_nScriptClickedHandler = function(ccp)
					self:handlerWuHunClick(wuhun,item)
				end
				item.m_nScriptCollisionHandler = function(other)
					self:u_collisionHandler(item,other,wuhun,i)
				end
				panel:addChild(item)
				self.usingItems[count]=item
				count = count+1
				--Log("###@@@@"..i)
			end
		end
	end,

	--使用中的星魂拖动事件
	u_collisionHandler = function(self,item,other,wuhun,i)
		local inRight = self:isInRight(item)
		--移动回去
		local moveback = function()
			local action = CCMoveTo:actionWithDuration(0.5,CCPoint(JI_XING_ROLE_XH_POS_CFG[i].x,JI_XING_ROLE_XH_POS_CFG[i].y));
			item:runAction(action)
		end

		if not inRight then
			moveback()
		else
		   --alert(table.getn(self.items))
			if other~=item then
				moveback()
				local other_data = nil
				for n = 1 , table.getn(self.items) do
					if self.items[n] == other then
						other_data = wuHunInfo[n]
					end
				end
				if other_data == nil then
					for n = 1 , 6 do
						if self.usingItems[n] == other then
							other_data = wuHunUsing[n]
						end
					end
				end
				if other_data then
					self:tunshi(other,wuhun,other_data)
					return
				end
			end
			---------下方
			if numofGrid <=table.getn(self.items) then
			 moveback()
			 else
			self:unequip(item,i)
			end
		end
	end,
	
	--吞噬
	tunshi = function(self,other,src_data,target_data)
		local function opSoulEatFinishCB(json)
			WaitDialog.closePanelFunc()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				local dialogCfg = new(basicDialogCfg)
				dialogCfg.title = "提示"
				dialogCfg.msg = ERROR_CODE_DESC[error_code]
				dialogCfg.dialogType = 5
				new(Dialog):create(dialogCfg)
			else
				getWunHunInfo(json)
				self:reflash()
			end
		end

		local test = function()
			showWaitDialogNoCircle()
			NetMgr:registOpLuaFinishedCB(Net.OPT_SoulEatSimple,opSoulEatFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_SoulEatSimple,opFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("general_id", self.role.general_id )
			cj:setByKey("target_soul_id",src_data.soul_id)
			cj:setByKey("soul_id", target_data.soul_id)
			NetMgr:executeOperate(Net.OPT_SoulEatSimple, cj)
		end
		local eatEXP = target_data.eat_exp + target_data.experience
		local m_msg =  SHI_FOU_RANG..src_data.name..TUN_SHI.."\n"..target_data.name.."\n"..HUO_DE..eatEXP..JING_YAN
		local a,b = other:getPosition()

		local btns = {}
		local bs = new(ButtonScale)
		bs:create("UI/public/noTextBtn.png",1.2,ccc3(100,100,100),"吞噬")
		btns[1] = bs.btn
		btns[1].action = test

		local dialogCfg = new(basicDialogCfg)
		dialogCfg.title = ""..src_data.name
		dialogCfg.titleColor = SOUL_COLOR[src_data.quality]
		dialogCfg.msg = m_msg
		dialogCfg.dialogType = 5
		dialogCfg.btns = btns
		new(Dialog):create(dialogCfg)
	end,
	
	------卸下------
	unequip = function(self,item,i)
		local opSoulUnEquipFinishCB= function(json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
				local action = CCMoveTo:actionWithDuration(0.5,CCPoint(JI_XING_ROLE_XH_POS_CFG[i].x,JI_XING_ROLE_XH_POS_CFG[i].y));
				item:runAction(action)
			else
				getWunHunInfo(json)
				self:reflash()
			end
		end
		local opSoulUnEquipFailedCB= function()
			closeWait()
		end
		local httpRequest = function()
			showWaitDialogNoCircle("waiting SoulUnEquip!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_SoulUnequipSimple,opSoulUnEquipFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_SoulUnequipSimple,opSoulUnEquipFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("general_id", self.role.general_id )
			cj:setByKey("position",i)
			NetMgr:executeOperate(Net.OPT_SoulUnequipSimple, cj)
		end
		httpRequest()
	end,
	
	isInRight = function(self,item)
		local x,y = item:getPosition()
		--CCLuaLog("x,y "..x.."  "..y)
		return x<(900) and x>(410) and y>0 and y<500
	end,

	--找到原来位置
	getUsingOldPos = function(self,item)
		for i=1, table.getn(self.usingItems) do
			if self.usingItems[i]==item then
				return self.usingKuang[i]:getPosition()
			end
		end
	end,
   
	createRight = function(self)
		local panel = self.panel
		 numofGrid=GloblePlayerData.soul_cell_count
		self.items = new({})
		self.kuangs = new({})
		--空的框框
		local close = function()	
		end
		local opFinishCB = function(s)
		
		end
		local curnum=10
		
		self.item_buttom_pos = {}
		local count=1
		for row=1, 5 do
			for column=1,5 do
				local wuhun = wuHunInfo[(row-1)*5+column]
				local kuang_bg = "UI/public/kuang_96_96.png"
				if wuhun and wuhun.quality >1 then --1是白色的碎魂 不需要加框
					kuang_bg = ITEM_QUALITY[wuhun.quality]
				end
				
				
				local icon_length=90
				local icon = CCSprite:spriteWithFile(kuang_bg)
				icon:setScale(0.75)
				icon:setPosition(473+(column-1)*icon_length, 350-(row-1)*icon_length + 95)
				icon:setAnchorPoint(CCPoint(0, 0))
				panel:addChild(icon)
				self.kuangs[(row-1)*5+column] = icon
				self.item_buttom_pos[(row-1)*5+column]= {
					x = (column-1)*icon_length + 473,
					y = 350-(row-1)*icon_length+95 ,
				}
				
				
				
		
		
				if count>numofGrid then
				
				local lock_btn = new(ButtonScale)
				lock_btn:create("UI/baoguoPanel/lock.png",1.2)
				lock_btn.btn:setScale(0.75)
				lock_btn.btn:setPosition(473+(column-1)*icon_length, 350-(row-1)*icon_length + 95)
				lock_btn.btn:setAnchorPoint(CCPoint(0,0))--(column-1)*icon_length + 473, 350-(row-1)*icon_length+95))
				--lock:setScale(0.75)
				
				--btns[2]=bs1.btn
				
				       panel:addChild(lock_btn.btn)
				       lock_btn.btn.m_nScriptClickedHandler = function(ccp)
					   
					           local test = function()	
									NetMgr:registOpLuaFinishedCB(Net.OPT_AddXinHunBagCount,opFinishCB)
									NetMgr:registOpLuaFailedCB(Net.OPT_AddXinHunBagCount,opFailedCB)
									local cj = Value:new()
									cj:setByKey("role_id", ClientData.role_id)
									cj:setByKey("request_code", ClientData.request_code)
									cj:setByKey("count", (row-1)*5+column )
									
									NetMgr:executeOperate(Net.OPT_AddXinHunBagCount, cj)
									
									
									
									GloblePlayerData.soul_cell_count=(row-1)*5+column
									--alert(numofGrid)
									self:reflash()
									GotoNextStepGuide()
		                        end
							local btns = {}
							local bs = new(ButtonScale)
							bs:create("UI/public/noTextBtn.png",1.2,ccc3(100,100,100),"是")
							local bsn = new(ButtonScale)
							bsn:create("UI/public/noTextBtn.png",1.2,ccc3(100,100,100),"否")
							btns[1] = bs.btn
							btns[1].action = test
                             btns[2] = bsn.btn
							btns[2].action = close
							local danjia=10
							local dialogCfg = new(basicDialogCfg)
							dialogCfg.title ="" 
							--dialogCfg.titleColor = ITEM_COLOR[src_data.level]
							local second=(row-1)*5+column
							local num=second-numofGrid
							local sum=0
							if num>=2 then
							  sum=second+numofGrid+1-2*10
							else
							  sum=(second-10)*2
							end
							crunum=(row-1)*5+column
							dialogCfg.msg = "是否花费"..5*(sum*num/2).."金币解锁"..((row-1)*5+column-numofGrid).."个格子"
							dialogCfg.dialogType = 5
							dialogCfg.btns = btns
							new(Dialog):create(dialogCfg)
							
							
		                end
				end
				
				count=count+1
			end
		end

		for i = 1 , table.getn(wuHunInfo) do
			if i > 25 then
				break
			end
			local wuhun = wuHunInfo[i]
			if wuhun then
				local pos = CCPoint(self.item_buttom_pos[i].x, self.item_buttom_pos[i].y)

				--同时有两个动画，这是低下的动画，这样拖动后还能显示
				local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
				icon:setPosition(pos.x,pos.y)
				icon:setAnchorPoint(CCPoint(0, 0))
				icon:setScale(0.75*isRetina)
				panel:addChild(icon)
				local animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("soul/soul_"..wuhun.icon)
				local action = CCAnimate:actionWithAnimation(animation)
				icon:runAction(CCRepeatForever:actionWithAction(action))

				local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
				local animation = dbAnimationMgr:sharedAnimationmgr():getAnimation("soul/soul_"..wuhun.icon)
				local action = CCAnimate:actionWithAnimation(animation)
				icon:runAction(CCRepeatForever:actionWithAction(action))

				local item = dbUIWidgetDragable:widgetDragable(icon)
				item:setScale(0.75*isRetina)
				item:setContentSize(CCSize(icon:getContentSize().width*0.85*isRetina,icon:getContentSize().height*0.85*isRetina))
				item:setPosition(pos)
				item:setAnchorPoint(CCPoint(0, 0))
				panel:addChild(item)
				self.items[i] = item
				
				if i==1 then
					GlobleFirstWuHun = item
				end
				
				item.m_nScriptClickedHandler = function(ccp)
					self:handlerWuHunClick(wuhun,item)
				end
				item.m_nScriptCollisionHandler = function(other)
					self:collisionHandler(item,other,wuhun,i)
				end
			end
		end

		--一键合成按钮
		local btn = new(ButtonScale)
		btn:create("UI/ji_xing/compose.png",1.2)
		btn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn.btn:setPosition(140+446+100, 40)
		btn.btn.m_nScriptClickedHandler = function(ccp)
			local Reponse = function (json)
				WaitDialog.closePanelFunc()
				local error_code = json:getByKey("error_code"):asInt()
				if error_code > 0 then
					ShowErrorInfoDialog(error_code)
				else
					getWunHunInfo(json)
					self:reflash()
				end
			end
			local sendRequest = function ()
				showWaitDialogNoCircle()

				NetMgr:registOpLuaFinishedCB(Net.OPT_SoulCombine,Reponse)
				NetMgr:registOpLuaFailedCB(Net.OPT_SoulCombine,opFailedCB)
				local cj = Value:new()
				cj:setByKey("role_id", ClientData.role_id)
				cj:setByKey("request_code", ClientData.request_code)

				NetMgr:executeOperate(Net.OPT_SoulCombine, cj)
			end
			sendRequest()
		end
		panel:addChild(btn.btn)

		--前往祭坛按钮
	--[[	local btn = new(ButtonScale)
		btn:create("UI/ji_xing/goto.png",1.2)
		btn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn.btn:setPosition(344+446, 40)
		btn.btn.m_nScriptClickedHandler = function(ccp)
			self:destroy()
			globleShowJiFete()
		end
		--]]
		--panel:addChild(btn.btn)
		GlobleGoToFeteBtn = btn.btn
	end,

	--拖动响应事件
	collisionHandler = function(self,item,other,wuhun,i)
		--移动回去
		local moveback = function()
			local action = CCMoveTo:actionWithDuration(0.5,CCPoint(self.item_buttom_pos[i].x,self.item_buttom_pos[i].y))
			item:runAction(action)
		end
		local inLeft = self:isInLeft(item)
		if inLeft~=0 then --移动到左边的框框中
			local action = CCMoveTo:actionWithDuration(0.5,CCPoint(JI_XING_ROLE_XH_POS_CFG[inLeft].x,JI_XING_ROLE_XH_POS_CFG[inLeft].y))
			item:runAction(action)
			local opFinishCB = function(json)
				WaitDialog.closePanelFunc()
				local error_code = json:getByKey("error_code"):asInt()
				if error_code > 0 then
					ShowErrorInfoDialog(error_code)
					moveback()
				else
					getWunHunInfo(json)
					self:reflash()
					GotoNextStepGuide()
					--CCLuaLog("self:reflash():")
				end
			end
			local opFailedCB = function()
				WaitDialog.closePanelFunc()
			end
			local httpRequest = function()
				showWaitDialogNoCircle()
				NetMgr:registOpLuaFinishedCB(Net.OPT_SoulEquipSimple,opFinishCB)
				NetMgr:registOpLuaFailedCB(Net.OPT_SoulEquipSimple,opFailedCB)
				local cj = Value:new()
				cj:setByKey("role_id", ClientData.role_id)
				cj:setByKey("request_code", ClientData.request_code)
				cj:setByKey("general_id", self.role.general_id )
				cj:setByKey("soul_id",wuhun.soul_id)
				cj:setByKey("position",inLeft)
				NetMgr:executeOperate(Net.OPT_SoulEquipSimple, cj)
			end
			httpRequest()
		else
			moveback()
			if other ~= item then --吞噬
				local other_data = 0, nil
				for n = 1 , table.getn(self.items) do
					if self.items[n] == other then
						other_data = wuHunInfo[n]
					end
				end
				if other_data  then
					self:tunshi(other,wuhun,other_data)
				end
			end
		end
	end,

	--判断拖动的星魂是否在左边的框框位置中
	isInLeft = function(self,item)
		local x,y = item:getPosition()
		--CCLuaLog("######################"..open_line)
		for i=1,open_line do
		      if x<JI_XING_ROLE_XH_POS_CFG[i].x+40 and x>JI_XING_ROLE_XH_POS_CFG[i].x-40 and y<JI_XING_ROLE_XH_POS_CFG[i].y+50 and y>JI_XING_ROLE_XH_POS_CFG[i].y-50 then
			  --CCLuaLog("#x:"..x.." #Y:"..y.." #i"..i.." posx:"..JI_XING_ROLE_XH_POS_CFG[i].x.." pos:y"..JI_XING_ROLE_XH_POS_CFG[i].y)
			  return i
			  
			  end
		end
		--[[
		if x<(50) and x>(-20) and y>356 and y<466 then
			return 1
		end
		if x<(50) and x>(-20) and y>280 and y<340 then
			return 2
		end
		if x<(50) and x>(-20) and y>120 and y<270 then
			return 3
		end
		if x<(400) and x>(290) and y>356 and y<466 then
			return 4
		end
		if x<(400) and x>(290) and y>280 and y<340 then
			return 5
		end
		if x<(400) and x>(290) and y>120 and y<270 then
			return 6
		end
		--]]
		return 0
	end,

	--点击星魂时显示星魂信息
	handlerWuHunClick = function(self,wuhun,dragable)
		local dialogCfg = new(basicDialogCfg)
		dialogCfg.title = ""..wuhun.name.." LV "..wuhun.level
		dialogCfg.titleColor = SOUL_COLOR[wuhun.quality]
		local xhab = (wuhun.level-1)*wuhun.ability_grow + wuhun.ability_base
		dialogCfg.msg =  WU_HUN_JING_YAN..":"..wuhun.experience.."/"..wuhun.level_param * (2^wuhun.level).."\n"..soul_ability_type[wuhun.ability_type].."+"..xhab.."\n"
		dialogCfg.msgAlign = "left"
		local a,b = dragable:getPosition()
		dialogCfg.position = CCPoint(a*SCALEX,b*SCALEY)
		dialogCfg.dialogType = 5
		new(Dialog):create(dialogCfg)
	end,

	--初始化界面，包括头部，背景
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 4004)
		scene:addChild(self.uiLayer, 5004)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		local top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)

		--面板提示图标
		local nice = CCSprite:spriteWithFile("UI/ji_xing/nice.png")
		nice:setPosition(CCPoint(-10, 10))
		nice:setAnchorPoint(CCPoint(0, 0))
		top:addChild(nice)

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
			GotoNextStepGuide()
		end
		top:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
		self:destroyScheduler()
		
		GlobleGoToFeteBtn = nil
		GlobleJiXingPanel = nil
		removeUnusedTextures()
	end,
	
	destroyScheduler = function(self)
		if GlobleJiXingPanel and GlobleJiXingPanel.tick then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(GlobleJiXingPanel.tick)
			GlobleJiXingPanel.tick = nil
		end
	end
}

getUsingList = function(general)
	wuHunUsing = new ({})
	wuHunUsing[1]={soul_id = 0,}
	wuHunUsing[2]={soul_id = 0,}
	wuHunUsing[3]={soul_id = 0,}
	wuHunUsing[4]={soul_id = 0,}
	wuHunUsing[5]={soul_id = 0,}
	wuHunUsing[6]={soul_id = 0,}
	local mem_soul_1 = general.mem_soul_1
	local mem_soul_2 = general.mem_soul_2
	local mem_soul_3 = general.mem_soul_3
	local mem_soul_4 = general.mem_soul_4
	local mem_soul_5 = general.mem_soul_5
	local mem_soul_6 = general.mem_soul_6
	--Log(general.name)
	--Log("getUsingListmem_soul_1:"..general.mem_soul_1.."\n".."mem_soul_2:"..general.mem_soul_2.."\n".."mem_soul_3:"..general.mem_soul_3.."\n".."mem_soul_4"..general.mem_soul_4.."\n".."mem_soul_5"..general.mem_soul_5.."\n".."mem_soul_6"..general.mem_soul_6.."\n")
	
	for i = 1 ,  table.getn(wuHun_equiped_list) do
		if  mem_soul_1 == wuHun_equiped_list[i].soul_id then
			wuHunUsing[1] = wuHun_equiped_list[i]
		end
		if  mem_soul_2 == wuHun_equiped_list[i].soul_id  then
			wuHunUsing[2] = wuHun_equiped_list[i]
		end
		if  mem_soul_3 == wuHun_equiped_list[i].soul_id  then
			wuHunUsing[3] = wuHun_equiped_list[i]
		end
		if  mem_soul_4 == wuHun_equiped_list[i].soul_id then
			wuHunUsing[4] = wuHun_equiped_list[i]
		end
		if  mem_soul_5 == wuHun_equiped_list[i].soul_id  then
			wuHunUsing[5] = wuHun_equiped_list[i]
		end
		if  mem_soul_6 == wuHun_equiped_list[i].soul_id  then
			wuHunUsing[6] = wuHun_equiped_list[i]
		end
		--Log("i:"..i.." wuHun_equiped_list:"..wuHun_equiped_list[i].soul_id)
	end
end

--装备的星魂图标的位置
JI_XING_ROLE_XH_POS_CFG = {
    {x=15,y=422},
	{x=15,y=301},
	{x=15,y=180},
	{x=318,y=422},
	{x=318,y=301},
	{x=318,y=180},
}
JI_XING_OPEN_DESC=
{
"60级开启",
"75级开启",
"90级开启",
}
--训练模块
local trainCost = function()
	--神位等级<31?3000:向上取整（（神位等级-20）/10）*向下取整（（神位等级-1）/10）*1000。
	local officium = GloblePlayerData.officium
	local cost = officium < 31 and 3000 or math.ceil((officium - 20)/10) * math.floor((officium - 1)/10) * 1000
	return cost
end

XunLianPanel = {
	bg      = nil,
	toggles = {}, --训练按钮开关
	type    =  1, --选择训练的类型
	xun_lian_zhong = false,

	--加载动画
	localAnimation = function(self)
		local root = GlobalCfgMgr:getCfgJsonRoot("cfg/animations.json")
		local idle = root:getByKey("warCharacter"):getByKey(self.role.figure):getByKey("idle")

		local plist = idle:getByKey("dataFiles"):getByIndex(0):getByKey("plist"):asString()
		local texture = idle:getByKey("dataFiles"):getByIndex(0):getByKey("texture"):asString()
		CCSpriteFrameCache:sharedSpriteFrameCache():addSpriteFramesWithFile(plist,texture)

		local prefix = idle:getByKey("frames"):getByKey("prefix"):asString()
		local suffix = idle:getByKey("frames"):getByKey("suffix"):asString()
		local start = idle:getByKey("frames"):getByKey("start"):asInt()
		local ends = idle:getByKey("frames"):getByKey("end"):asInt()
		local delay = idle:getByKey("delay"):asFloat()

		local frameArray = CCMutableArray_CCSpriteFrame__:new(ends-start+1)
		for i=start,ends do
			local frameName = prefix..i..suffix
			frameArray:addObject(CCSpriteFrameCache:sharedSpriteFrameCache():spriteFrameByName(frameName))
		end
		return CCAnimation:animationWithFrames(frameArray, delay)
	end,

	create = function (self,father)
		self.toggles = new({})
		self.role = GloblePlayerData.generals[GloblePanel.curGenerals]
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 702))
		local figure_panel=dbUIPanel:panelWithSize(CCSize(0, 0))
		figure_panel:setPosition(CCPoint(450,300))
		figure_panel:setAnchorPoint(CCPoint(0,0))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		figure_panel:setScale(isRetina)
		self.bg:addChild(figure_panel)
		local vip = GloblePlayerData.vip_level
		--创建介绍信息框
		self:createInfoKuang()

		--木桩
		local muzhuangBg = CCSprite:spriteWithFile("UI/xun_lian_panel/mu_zhuang.png")
		muzhuangBg:setPosition(CCPoint(460,297))
		muzhuangBg:setAnchorPoint(CCPoint(0,0))
		self.bg:addChild(muzhuangBg)

		--主角形象
		local figure = CCSprite:spriteWithFile("UI/nothing.png")
		figure:setPosition(CCPoint(0,0))
		figure:setAnchorPoint(CCPoint(0,0))
		figure:setScale(2.0)
		figure_panel:addChild(figure)

		local animation = self:localAnimation()
		local action = CCRepeatForever:actionWithAction(CCAnimate:actionWithAnimation(animation))
		figure:setFlipX(true)
		figure:runAction(action)

		local TRAIN_VIP_CFG = {
			{
				open_condition1 = true,
				open_condition2 = true,
				open_desc = "开启",
				cast_label="消耗"..trainCost().."银币",
				type = 1,
				lock="UI/xun_lian_panel/normal.png",
				toggle_1="UI/xun_lian_panel/normal.png",
				toggle_2="UI/xun_lian_panel/normal_toggled.png",
				callback =  self.startXunLian,
			},
			{
				open_condition1 = GloblePlayerData.officium >= 30,
				open_condition2 = vip >= 1,
				open_desc = "神位30级或VIP1级开启",
				cast_label="消耗5金币",
				type = 2,
				lock="UI/xun_lian_panel/qiang_hua_locked.png",
				toggle_1="UI/xun_lian_panel/qiang_hua.png",
				toggle_2="UI/xun_lian_panel/qiang_hua_toggled.png",
				callback =  self.startXunLian,
			},
			{
				open_condition1 = false,
				open_condition2 = vip >= 3,
				open_desc = "VIP3级开启",
				cast_label="消耗30金币",
				type = 3,
				lock="UI/xun_lian_panel/super_locked.png",
				toggle_1="UI/xun_lian_panel/super.png",
				toggle_2="UI/xun_lian_panel/super_toggled.png",
				callback =  self.startXunLian,
			},
			{
				open_condition1 = false,
				open_condition2 = vip >= 7,
				open_desc = "VIP7级开启",
				cast_label="消耗200金币",
				type = 4,
				lock="UI/xun_lian_panel/mo_gui_locked.png",
				toggle_1="UI/xun_lian_panel/mo_gui.png",
				toggle_2="UI/xun_lian_panel/mo_gui_toggled.png",
				callback =  self.startXunLian,
			},			
		}
		local TOGGLE_TEXT_CFG = {
			toggle1 = {
				normal = "UI/xun_lian_panel/xunlian_mode_1.png",
				toggle =   "UI/xun_lian_panel/xunlian_mode_2.png",
			},
			toggle2 = {
				normal = "UI/xun_lian_panel/xunlian_slot_1.png",
				toggle =   "UI/xun_lian_panel/xunlian_slot_2.png",
			}
		}
		local cfg = {
			train_cfg = TRAIN_VIP_CFG,
			toggle_cfg = TOGGLE_TEXT_CFG,
			from = self,
		}
		self.btnsPanel = new(XunLianBottomPanel)
		self.btnsPanel:create(cfg)
		self.bg:addChild(self.btnsPanel.bg)
	end,

	--创建介绍信息框
	createInfoKuang = function(self)
		if self.infoKuang then
			self.bg:removeChild(self.infoKuang,true)
			self.infoKuang = nil
		end

		local role = self.role
		--描述信息的的框
		local infoKuang = createBG("UI/xun_lian_panel/info_kuang.png",327,281)
		infoKuang:setPosition(CCPoint(50,286))
		infoKuang:setAnchorPoint(CCPoint(0,0))
		self.bg:addChild(infoKuang)

		--名字
		local label = CCLabelTTF:labelWithString(role.name, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(26,240))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ITEM_COLOR[role.quality])
		infoKuang:addChild(label)
		--等级
		local nameWidth = label:getContentSize().width
		local label = CCLabelTTF:labelWithString(role.level.."级",CCSize(150,0),0, SYSFONT[EQUIPMENT], 26)
		label:setPosition(CCPoint(40+nameWidth,240))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ReColor[role.reincarnate + 1])
		infoKuang:addChild(label)

		--经验条
		local levelExperienceConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_level_experience.json")
		local levelExp = levelExperienceConfig:getByKey(role.level):asInt()	--升级还需经验
		local bar = new(Bar2)
		bar:create(levelExp,EXP_BAR_CFG)
		bar:setExtent(role.experience,levelExp)
		infoKuang:addChild(bar.barbg)

		--经验丹数量
		local label = CCLabelTTF:labelWithString("经验丹数量：",CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
		label:setPosition(CCPoint(26,160))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(255,203,153))
		infoKuang:addChild(label)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.trainings.jump_wand,CCSize(250,0),0, SYSFONT[EQUIPMENT], 24)
		label:setPosition(CCPoint(180,160))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(153,204,1))
		infoKuang:addChild(label)

		local label = CCLabelTTF:labelWithString("金币：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 26)
		label:setPosition(CCPoint(26,120))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(255,203,153))
		infoKuang:addChild(label)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.gold,CCSize(250,0),0, SYSFONT[EQUIPMENT], 24)
		label:setPosition(CCPoint(100,120))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(153,204,1))
		infoKuang:addChild(label)

		--战功
		local label = CCLabelTTF:labelWithString("战功：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 26)
		label:setPosition(CCPoint(26,80))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(255,203,153))
		infoKuang:addChild(label)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.exploit,CCSize(250,0),0, SYSFONT[EQUIPMENT], 24)
		label:setPosition(CCPoint(100,80))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(153,204,1))
		infoKuang:addChild(label)

		self.infoKuang = infoKuang
	end,

	--开始训练
	startXunLian = function(self,type)
		local createTrainingSlotBtns = function(ccp)
			local btns = {}

			local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
			btns[1] = btn
			btns[1].action = TrainingSlotOpen

			local btn = dbUIButtonScale:buttonWithImage("UI/public/cancel_btn.png", 1, ccc3(125, 125, 125))
			btns[2] = btn
			btns[2].action = nothing

			return btns
		end
		local createReincarnateBtns = function(ccp)
			local btns = {}

			local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
			btns[1] = btn
			btns[1].action = Reincarnate
			btns[1].param = GloblePlayerData.generals[GloblePanel.curGenerals].general_id

			local btn = dbUIButtonScale:buttonWithImage("UI/public/cancel_btn.png", 1, ccc3(125, 125, 125))
			btns[2] = btn
			btns[2].action = nothing

			return btns
		end
		local Reponse = function(json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				local vip_level = GloblePlayerData.vip_level
				local training_slot = GloblePlayerData.trainings.training_slot - 1
				local training_slot_max = cfg_vip_data[vip_level + 1].training_slot_max - 1
				if error_code == 222 and training_slot < training_slot_max then
					local price = {
						"50金币","100金币","200金币","500金币","1000金币","2000金币","5000金币","10000金币"
					}
					local dialogCfg = new(basicDialogCfg)
					dialogCfg.bg = "UI/baoguoPanel/kuang.png"
					dialogCfg.msg = training_slot <= 10 and "是否消耗"..price[training_slot].."增加训练位！" or "您的训练位已经满了"
					dialogCfg.msgSize = 24
					dialogCfg.position = CCPoint(WINSIZE.width/2,WINSIZE.height/2)
					dialogCfg.dialogType = 5
					dialogCfg.btns = createTrainingSlotBtns()

					local dialog = new(Dialog)
					dialog:create(dialogCfg)
				elseif error_code == 330 then
					local dialogCfg = new(basicDialogCfg)
					dialogCfg.bg = "UI/baoguoPanel/kuang.png"
					dialogCfg.msg = "是否转生？"
					dialogCfg.msgSize = 24
					dialogCfg.dialogType = 5
					dialogCfg.btns = createReincarnateBtns()
					new(Dialog):create(dialogCfg)
			    elseif error_code == 202 then
				    shortofgold()
				else
					ShowErrorInfoDialog(error_code)
					GotoStepGuide(7)
				end
			else
				GloblePlayerData.gold = json:getByKey("gold"):asInt()
				GloblePlayerData.copper = json:getByKey("copper"):asInt()
				updataHUDData()
				
				mappedPlayerTrainSimpleData(json)
				GloblePanel:clearMainWidget()
				createXunlian(type)
				GotoNextStepGuide()
			end
			
		end
		local sendRequest = function ()
			showWaitDialogNoCircle("waiting useing!")

			NetMgr:registOpLuaFinishedCB(Net.OPT_TrainingStartSimple,Reponse)
			NetMgr:registOpLuaFailedCB(Net.OPT_TrainingStartSimple,opFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("general_id", GloblePlayerData.generals[GloblePanel.curGenerals].general_id )
			cj:setByKey("ratio_type", type-1)
			cj:setByKey("time_type", type-1)
			NetMgr:executeOperate(Net.OPT_TrainingStartSimple, cj)
		end

		sendRequest()
	end
}

--开启训练位
function TrainingSlotOpen(ccp, param)
	local function opTrainingSlotOpenFinishCB(s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()

		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			mappedPlayerTrainSimpleData(s)
			alert("恭喜你！你现在有"..GloblePlayerData.trainings.training_slot.."个训练位了。")
			
			GloblePlayerData.gold = s:getByKey("gold"):asInt()
			GloblePlayerData.copper = s:getByKey("copper"):asInt()
			updataHUDData()
			--更新金币信息
			GloblePanel.xlp:createInfoKuang()
			
			if param and param.callback then
				param.callback()
			end
		end
	end
	local function execTrainingSlotOpen()
		local action = Net.OPT_TrainingSlotOpen

		NetMgr:registOpLuaFinishedCB(action, opTrainingSlotOpenFinishCB)
		NetMgr:registOpLuaFailedCB(action, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)

		NetMgr:executeOperate(action, cj)
	end

	execTrainingSlotOpen()
end

--转世
function Reincarnate(ccp)
	local role = GloblePlayerData.generals[GloblePanel.curGenerals]
	local general_id = role.general_id

	local function opReincarnateFinishCB(s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()

		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			alert("进化成功！！！")
			local general = findGeneralByGeneralId(general_id)
			mappedPlayerBaseAttribute(general,s)
			if GloblePanel.xlp.infoKuang then
				GloblePanel.xlp:createInfoKuang()
			end
		end
	end

	local function execReincarnate()
		showWaitDialogNoCircle("waiting Reincarnate!")

		local action = Net.OPT_ReincarnateSimple
		NetMgr:registOpLuaFinishedCB(action, opReincarnateFinishCB)
		NetMgr:registOpLuaFailedCB(action, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("general_id", general_id)

		NetMgr:executeOperate(action, cj)
	end

	execReincarnate()
end

get_xun_lian_Jing_yan_by_type = function (type)
	local TRAINING_RATIO = {
		1.0, 1.5, 4.0, 12.0
	}
	local officium = GloblePlayerData.officium
	local trainingExp = math.ceil(1 * officium * officium * officium + 10 * officium * officium + 150000);	
	return math.floor(trainingExp * TRAINING_RATIO[type])
end

--经验条配置
EXP_BAR_CFG = {
	res = {border = "UI/bar/bar_bg.png",entity = "UI/bar/bar_green.png",},
	borderSize = {width = 280,height = 32},
	entitySize = {width = 280,height = 28},
	fontSize = 30,
	position = CCPoint(26, 200),
	borderCornerSize = CCSize(13,16),
	entityCornerSize = CCSize(13,14)
}
--训练中模块
XunLianPanelZhong = {
	bg      = nil,
	dots    = {},
	dotIndex = 1,
	xun_lian_zhong = true,
	
	--加载动画
	localAnimation = function(self)
		local root = GlobalCfgMgr:getCfgJsonRoot("cfg/animations.json")
        local attack = root:getByKey("warCharacter"):getByKey(self.role.figure):getByKey("attack")
       
        local plist = attack:getByKey("dataFiles"):getByIndex(0):getByKey("plist"):asString()
        local texture = attack:getByKey("dataFiles"):getByIndex(0):getByKey("texture"):asString()
		CCSpriteFrameCache:sharedSpriteFrameCache():addSpriteFramesWithFile(plist,texture)
       
        local prefix = attack:getByKey("frames"):getByKey("prefix"):asString()
        local suffix = attack:getByKey("frames"):getByKey("suffix"):asString()
		local start = attack:getByKey("frames"):getByKey("start"):asInt()
		local ends = attack:getByKey("frames"):getByKey("end"):asInt()
		local delay = attack:getByKey("delay"):asFloat()
		
		local frameArray = CCMutableArray_CCSpriteFrame__:new(ends-start+1)
		for i=start,ends do
			local frameName = prefix..i..suffix
			frameArray:addObject(CCSpriteFrameCache:sharedSpriteFrameCache():spriteFrameByName(frameName))
		end
		return CCAnimation:animationWithFrames(frameArray, delay)
	end,
	
	create = function (self)
		self.role = GloblePlayerData.generals[GloblePanel.curGenerals]
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 702))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		
		local vip = GloblePlayerData.vip_level
		--左上角
		self:createInfoKuang()
	
		--木桩
        local action =  CCSequence:actionOneTwo(
            CCRotateTo:actionWithDuration(0.5, -5),
            CCRotateTo:actionWithDuration(0.5, 5))
        local repeatForever = CCRepeatForever:actionWithAction(action)
		local muzhuangBg = CCSprite:spriteWithFile("UI/xun_lian_panel/mu_zhuang.png")
		muzhuangBg:setPosition(CCPoint(520,420))
		muzhuangBg:setAnchorPoint(CCPoint(0.5,0.5))
		muzhuangBg:runAction(repeatForever)
		self.bg:addChild(muzhuangBg)
		
		local figure_panel=dbUIPanel:panelWithSize(CCSize(0, 0))
		figure_panel:setPosition(CCPoint(410,260))
		figure_panel:setAnchorPoint(CCPoint(0,0))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		figure_panel:setScale(isRetina)
		self.bg:addChild(figure_panel)
		--主角形象
		local figure = CCSprite:spriteWithFile("UI/nothing.png")
		figure:setPosition(CCPoint(0,0))
		figure:setAnchorPoint(CCPoint(0,0))
		figure:setScale(2.0)
		figure_panel:addChild(figure)
		
		local animation = self:localAnimation()
		local action = CCRepeatForever:actionWithAction(CCAnimate:actionWithAnimation(animation))
		figure:setFlipX(true)
		figure:runAction(action)

		--训练中提示文字
		local mo_gui_xun_lian_zhong_txt = CCSprite:spriteWithFile("UI/xun_lian_panel/xun_lian_zhong.png")
		mo_gui_xun_lian_zhong_txt:setPosition(CCPoint(554/2,164/2))
		local xun_lian_tip = dbUIPanel:panelWithSize(CCSize(554,164))
		xun_lian_tip:setPosition(CCPoint(550,425))
		xun_lian_tip:setAnchorPoint(CCPoint(0.5,0.5))
		xun_lian_tip:addChild(mo_gui_xun_lian_zhong_txt)
		self.bg:addChild(xun_lian_tip,10)
				
		--结束训练
		local endBtn = new(ButtonScale)
		endBtn:create("UI/xun_lian_panel/stop_train.png",1.0,ccc3(169,121,60))
		endBtn.btn:setPosition(CCPoint(554/2-100,20))
		endBtn.btn:setAnchorPoint(CCPoint(0,0))
		endBtn.btn.m_nScriptClickedHandler = function(ccp)
			self:stopXunLian()
		end
		xun_lian_tip:addChild(endBtn.btn)	
			
		local TRAIN_VIP_CFG = {
			{
				open_condition1 = true,
				open_condition2 = true,
				open_desc = "开启",
				cast_label="消耗经验丹/战功",
				type = 1,
				lock="UI/xun_lian_panel/tq_pt.png",
				toggle_1="UI/xun_lian_panel/tq_pt.png",
				toggle_2="UI/xun_lian_panel/tq_pt2.png",
				callback = self.selectJumpWand,
			},
			
			{
				open_condition1 = GloblePlayerData.officium >= 30,
				open_condition2 = vip >= 2,
				open_desc = "神位30级或VIP2级开启",
				cast_label="消耗5金币",
				type = 2,
				lock="UI/xun_lian_panel/tq_gj_locked.png",
				toggle_1="UI/xun_lian_panel/tq_gj.png",
				toggle_2="UI/xun_lian_panel/tq_gj2.png",
				callback = self.jump,
			},
			{
				open_condition1 = vip >= 4,
				open_desc = "VIP4级开启",
				cast_label="消耗10金币",
				type = 3,
				lock="UI/xun_lian_panel/tq_cj_locked.png",
				toggle_1="UI/xun_lian_panel/tq_cj.png",
				toggle_2="UI/xun_lian_panel/tq_cj2.png",
				callback = self.jump,
			},		
			{
				open_condition1 = vip >= 8,
				open_desc = "VIP8级开启",
				cast_label="消耗20金币",
				type = 4,
				lock="UI/xun_lian_panel/tq_mg3.png",
				toggle_1="UI/xun_lian_panel/tq_mg.png",
				toggle_2="UI/xun_lian_panel/tq_mg2.png",
				callback = self.jump,
			},			
		}
		local TOGGLE_TEXT_CFG = {
			toggle1 = {
				normal = "UI/xun_lian_panel/jump_mode_1.png",
				toggle =   "UI/xun_lian_panel/jump_mode_2.png",
			},
			toggle2 = {
				normal = "UI/xun_lian_panel/xunlian_slot_1.png",
				toggle =   "UI/xun_lian_panel/xunlian_slot_2.png",
			}
		}
		local cfg = {
			train_cfg = TRAIN_VIP_CFG,
			toggle_cfg = TOGGLE_TEXT_CFG,
			from = self,
		}
		self.btnsPanel = new(XunLianBottomPanel)
		self.btnsPanel:create(cfg)
		self.bg:addChild(self.btnsPanel.bg)
	end,
	
	--创建信息框
	createInfoKuang = function(self)
		if self.infoKuang then
			self.bg:removeChild(self.infoKuang,true)
			self.infoKuang = nil
		end
		
		local role = GloblePlayerData.generals[GloblePanel.curGenerals]
		local train = GloblePlayerData.trainings.training_list[GloblePanel.curGenerals]
		
		--描述信息的的框
		local infoKuang = createBG("UI/xun_lian_panel/info_kuang.png",327,281)
		infoKuang:setPosition(CCPoint(50,286))
		infoKuang:setAnchorPoint(CCPoint(0,0))
		self.bg:addChild(infoKuang)
		
		--名字
		local label = CCLabelTTF:labelWithString(role.name,SYSFONT[EQUIPMENT], 28)	
        label:setPosition(CCPoint(26,240))
		label:setAnchorPoint(CCPoint(0,0))
        label:setColor(ITEM_COLOR[role.quality])
		infoKuang:addChild(label)
		--等级
		local nameWidth = label:getContentSize().width
		local label = CCLabelTTF:labelWithString(role.level.."级",CCSize(150,0),0, SYSFONT[EQUIPMENT], 26)	
        label:setPosition(CCPoint(40+nameWidth,240))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ReColor[role.reincarnate + 1])
		infoKuang:addChild(label)
		
		--经验条
		local levelExperienceConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_level_experience.json")
		local levelExp = levelExperienceConfig:getByKey(role.level):asInt()	--升级还需经验
		local bar = new(Bar2)
        bar:create(levelExp,EXP_BAR_CFG)
		bar:setExtent(role.experience,levelExp)	
		infoKuang:addChild(bar.barbg)

		--预计可获得经验
		local label = CCLabelTTF:labelWithString("预计可获得经验：",CCSize(400,0),0, SYSFONT[EQUIPMENT], 26)
		label:setPosition(CCPoint(26,160))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(255,203,153))
		infoKuang:addChild(label)
		local label = CCLabelTTF:labelWithString(get_xun_lian_Jing_yan_by_type(train.training_type),CCSize(400,0),0, SYSFONT[EQUIPMENT], 24)
		label:setPosition(CCPoint(230,160))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(153,204,1))
		infoKuang:addChild(label)
				
		--经验丹数量
		local label = CCLabelTTF:labelWithString("经验丹数量：",CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)	
        label:setPosition(CCPoint(26,130))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(255,203,153))
		infoKuang:addChild(label)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.trainings.jump_wand,CCSize(250,0),0, SYSFONT[EQUIPMENT], 24)	
        label:setPosition(CCPoint(180,130))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(153,204,1))
		infoKuang:addChild(label)

		local label = CCLabelTTF:labelWithString("金币：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 26)	
        label:setPosition(CCPoint(26,100))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(255,203,153))
		infoKuang:addChild(label)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.gold,CCSize(250,0),0, SYSFONT[EQUIPMENT], 24)	
        label:setPosition(CCPoint(100,100))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(153,204,1))
		infoKuang:addChild(label)
		
		--战功
		local label = CCLabelTTF:labelWithString("战功：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 26)	
        label:setPosition(CCPoint(26,70))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(255,203,153))
		infoKuang:addChild(label)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.exploit,CCSize(250,0),0, SYSFONT[EQUIPMENT], 24)	
        label:setPosition(CCPoint(100,70))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(153,204,1))
		infoKuang:addChild(label)

		--训练剩余时间
		local label = CCLabelTTF:labelWithString("剩余时间：",CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)	
        label:setPosition(CCPoint(26,40))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(255,203,153))
		infoKuang:addChild(label)
		self.lengQueTime = math.floor((train.training_end - GloblePlayerData.trainings.server_time)/1000)	
		self.lengQueTimeTX = CCLabelTTF:labelWithString(getLenQueTime(self.lengQueTime),CCSize(300,0),0, SYSFONT[EQUIPMENT], 24)
		self.lengQueTimeTX:setAnchorPoint(CCPoint(0, 0))
		self.lengQueTimeTX:setPosition(CCPoint(150,40))
		self.lengQueTimeTX:setColor(ccc3(153,204,1))
		infoKuang:addChild(self.lengQueTimeTX)
		local lengQueTimeCallback = function()
			self:setLengQueTime()
		end
		if self.lengQueTime > 0 then
			if self.timeHandle == nil then
				self.timeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(lengQueTimeCallback,1,false)
				Tufei_Handle = self.timeHandle
			end
		end
		
		--经验丹冷却
		self.cooldown = math.floor((GloblePlayerData.trainings.jump_cooldown-GloblePlayerData.trainings.server_time)/1000)	
		self.cooldown_spr = CCLabelTTF:labelWithString("战功冷却时间：",CCSize(400,0),0, SYSFONT[EQUIPMENT], 24)	
        self.cooldown_spr:setPosition(CCPoint(26,10))
		self.cooldown_spr:setAnchorPoint(CCPoint(0,0))
		self.cooldown_spr:setColor(ccc3(255,203,153))
		infoKuang:addChild(self.cooldown_spr)		
		self.cooldown_label = CCLabelTTF:labelWithString(getLenQueTime(self.cooldown), SYSFONT[EQUIPMENT], 26)
        self.cooldown_label:setPosition(CCPoint(220,10))
		self.cooldown_label:setAnchorPoint(CCPoint(0,0))
		self.cooldown_label:setColor(ccc3(153,204,1))
		infoKuang:addChild(self.cooldown_label)
		if self.cooldown < 1 then
			self.cooldown_spr:setIsVisible(false)
			self.cooldown_label:setIsVisible(false)
		end

		self.infoKuang=infoKuang
		--信息框 End	
	end,
	
	--选择提取的经验丹数量
	selectJumpWand = function(self)
		if GloblePlayerData.trainings.jump_wand <= 0 then		--没有经验丹，直接战功提取
			self:jump(1)
			return 
		end
		local dialogBg = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		dialogBg.m_nScriptClickedHandler = function(ccp)
			dialogBg:removeFromParentAndCleanup(true)
		end
		self.bg:addChild(dialogBg,100000)

		local createbg = createBG("UI/public/dialog_kuang.png",600,270)
		createbg:setAnchorPoint(CCPoint(0.5, 0.5))
		createbg:setPosition(CCPoint(512, 384))
		dialogBg:addChild(createbg)
		local darkbg = createBG("UI/public/recuit_dark2.png",520, 130)
		darkbg:setAnchorPoint(CCPoint(0.5, 0))
		darkbg:setPosition(CCPoint(300,100))
		createbg:addChild(darkbg)
		
		local wandLabel = CCLabelTTF:labelWithString("经验丹*1",CCSize(0,0),0, SYSFONT[EQUIPMENT], 30)
		wandLabel:setAnchorPoint(CCPoint(0, 0))
		wandLabel:setPosition(CCPoint(45, 190))
		wandLabel:setColor(ccc3(255, 205, 103))
		createbg:addChild(wandLabel)

		--滑动条
		local cfg = {
			res = {border = "UI/bar/wand_bar_bg.png", entity = "UI/bar/bar_green.png",},
			borderSize = {width = 400,height = 31},
			entitySize = {width = 400,height = 28},
			fontSize = 30,
			position = CCPoint(60, 140),
			borderCornerSize = CCSize(13,14),
			entityCornerSize = CCSize(13,12)
		}
		local all = GloblePlayerData.trainings.jump_wand
		local bar = new(Bar2)
		bar:create(all, cfg)
		bar:setExtent(1)
		createbg:addChild(bar.barbg)

		--滑动区间
		local m_temp = 60 + 1 / all * 400
		local t_temp = 460
	
		local image = CCSprite:spriteWithFile("UI/jia_zu/la.png")
		local drag =  dbUIWidget:widgetWithSprite(image)
		drag:setAnchorPoint(CCPoint(0.5,0.5))
		drag:setPosition(CCPoint(m_temp,155))
		drag.m_nScriptDragMoveHandler = function(pos,prevPos)
			local pos1 = drag:convertToNodeSpace(pos)
			local prevPos1 = drag:convertToNodeSpace(prevPos)
			local m_pos = drag:getPositionX()-prevPos1.x + pos1.x
			if m_pos <m_temp or m_pos>t_temp then
				return
			end
			if m_pos >= 459 then
				m_pos = 460
			end
			drag:setPositionX(m_pos)
			bar:setExtent(math.max(1, all*(drag:getPositionX()-60)/400))
			wandLabel:setString("经验丹*"..getShotNumber(bar.cur))
		end
		createbg:addChild(drag,100)

		--max
		local max_btn = dbUIButtonScale:buttonWithImage("UI/xun_lian_panel/max.png", 1, ccc3(125, 125, 125))
		max_btn:setAnchorPoint(CCPoint(0, 0.5))
		max_btn:setPosition(CCPoint(485, 155))
		max_btn.m_nScriptClickedHandler = function()
			drag:setPositionX(460)
			bar:setExtent(all)
		end
		createbg:addChild(max_btn)

		--确定按钮
		local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(600/2-120,60))
		btn.m_nScriptClickedHandler = function(ccp)
			dialogBg:removeFromParentAndCleanup(true)
			self.doJumpBtn = nil
			self:jump(1, math.floor(bar.cur))
		end
		createbg:addChild(btn,10)
		self.doJumpBtn = btn
		
		--取消
		local btn = dbUIButtonScale:buttonWithImage("UI/public/cancel_btn.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(600/2+ 120,60))
		btn.m_nScriptClickedHandler = function(ccp)
			dialogBg:removeFromParentAndCleanup(true)
			self.doJumpBtn = nil
		end
		createbg:addChild(btn,10)
		
		GotoNextStepGuide()
	end,
	
	--提取
	jump = function(self,type, amount)
		--用经验丹,且冷却时间不为0
		if type==1 and self.cooldown>0 then
			ShowInfoDialog("战功未冷却")
			return
		end
		local createReincarnateBtns = function(ccp)
			local btns = {}
		
			local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
			btns[1] = btn
			btns[1].action = Reincarnate
			btns[1].param = GloblePlayerData.generals[GloblePanel.curGenerals].general_id
				
			local btn = dbUIButtonScale:buttonWithImage("UI/public/cancel_btn.png", 1, ccc3(125, 125, 125))
			btns[2] = btn
			btns[2].action = nothing
			return btns
		end
		
		local Response = function(json)
			WaitDialog.closePanelFunc()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				if error_code == 330 then
					local dialogCfg = new(basicDialogCfg)
					dialogCfg.bg = "UI/baoguoPanel/kuang.png"
					dialogCfg.msg = "是否转生？"
					dialogCfg.msgSize = 24
					dialogCfg.dialogType = 5
					dialogCfg.btns = createReincarnateBtns()
					new(Dialog):create(dialogCfg)
				elseif error_code==202 then 
				      shortofgold()
				else
					ShowErrorInfoDialog(error_code)
				end
			else
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
				self.timeHandle = nil
				mappedPlayerTrainSimpleData(json)
				self:createInfoKuang()
   				
				local msg = tufei_ok..GloblePlayerData.trainings.training_experience..JING_YAN
				alert(msg)
					
				local generalId	= json:getByKey("generalId"):asInt()
				local train = findTrainByGeneralId(generalId)
				if train.needShowLevelUp ~= nil and train.needShowLevelUp then
					train.needShowLevelUp = false
					GolbalCreateEffect(1) --1为等级升级特效 2为神位升级特效 3为任务完成特效
				end
				
				if GlobleGeneralListPanel then
					GlobleGeneralListPanel:reflash()
				end
				
				GloblePlayerData.gold = json:getByKey("gold"):asInt()
				GloblePlayerData.copper = json:getByKey("copper"):asInt()
				updataHUDData()
			end
			GlobleJumpSuccess = true
			GotoNextStepGuide()
		end
		
		local sendRequest = function ()
			showWaitDialogNoCircle()
			NetMgr:registOpLuaFinishedCB(Net.OPT_JumpSimple,Response)
			NetMgr:registOpLuaFailedCB(Net.OPT_JumpSimple,opFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("general_id", GloblePlayerData.generals[GloblePanel.curGenerals].general_id )
			cj:setByKey("type",type)
			cj:setByKey("amount",amount or 1)
			NetMgr:executeOperate(Net.OPT_JumpSimple, cj)
		end 
		sendRequest()
	end,
	
	--停止训练
	stopXunLian = function(self)
		local Reponse = function (json)
			WaitDialog.closePanelFunc()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
			    if error_code==202 then 
				 shortofgold()
				 else
				ShowErrorInfoDialog(error_code)
				end
			else
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
				self.timeHandle = nil
				mappedPlayerTrainSimpleData(json)
				GloblePanel.mainWidget:removeAllChildrenWithCleanup(true)
				createXunlian()
				local addExp = json:getByKey("addExp"):asInt()
				ShowInfo("获得经验："..addExp)
				
				GloblePlayerData.gold = json:getByKey("gold"):asInt()
				GloblePlayerData.copper = json:getByKey("copper"):asInt()
				updataHUDData()
			end
		end
		
		local sendRequest = function ()
			showWaitDialogNoCircle()
			NetMgr:registOpLuaFinishedCB(Net.OPT_TrainingStopSimple,Reponse)
			NetMgr:registOpLuaFailedCB(Net.OPT_TrainingStopSimple,opFailedCB)
			local cj = Value:new()
						
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("general_id", GloblePlayerData.generals[GloblePanel.curGenerals].general_id )
			NetMgr:executeOperate(Net.OPT_TrainingStopSimple, cj)
		end 

		local dtp = new(DialogTipPanel)
		dtp:create("是否花费2金币停止训练",ccc3(255,204,153),180)
		dtp.okBtn.m_nScriptClickedHandler = function()
			sendRequest()
			dtp:destroy()
		end
	end,

	--更新结束时间
	setLengQueTime = function(self)
		--冷却倒计时
		if self.cooldown > 0 then
			self.cooldown = self.cooldown - 1
			self.cooldown_label:setString(getLenQueTime(self.cooldown))
		else
			self.cooldown_label:setIsVisible(false)
			self.cooldown_spr:setIsVisible(false)
		end
		if self.cooldown > 3600 then 
			self.cooldown_label:setColor(ccc3(255,0,0))
		else
			self.cooldown_label:setColor(ccc3(0,255,0))
		end
		--训练倒计时
		if self.lengQueTime > 0 then
			self.lengQueTime = self.lengQueTime - 1
			self.lengQueTimeTX:setString(getLenQueTime(self.lengQueTime))
		else
			self.lengQueTimeTX:setString(getLenQueTime(self.lengQueTime))
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
			self.timeHandle = nil
			
			GloblePanel.mainWidget:removeAllChildrenWithCleanup(true)
			createXunlian()
		end
	end
}

get_xun_lian_Jing_yan = function (radio)
	local time = 0
	if radio==100 then
		time = 8
	elseif radio==120 then
		time = 12
	elseif radio==150 then
		time = 24
	elseif radio==200 then
		time = 48		
	end
	local level_prestige_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_level_prestige.json")
	local jingyan =level_prestige_cfg:getByIndex(ClientData.officium-1):getByKey("training_exp"):asInt()*time*3.75
	return jingyan
end
globalXunlianBottonPanel = nil
--训练下部分功能
XunLianBottomPanel = {
	btnsPanel = nil,
	
	create = function(self, cfg)
		globalXunlianBottonPanel = self
		self.config = cfg
		self.bg = dbUIPanel:panelWithSize(CCSize(917,213))
		self.bg:setAnchorPoint(CCPoint(0,0))
		self.bg:setPosition(CCPoint(44,50))
		--按钮框背景
		local btnKuangBg = CCSprite:spriteWithFile("UI/xun_lian_panel/btns_kuang.png")
		btnKuangBg:setAnchorPoint(CCPoint(0,0))
		btnKuangBg:setPosition(CCPoint(0, 0))
		self.bg:addChild(btnKuangBg)
		--模式及槽切换卡
		self:createToggleBtns(cfg.toggle_cfg)
		--按钮组panel
		self.btnsPanel = dbUIPanel:panelWithSize(CCSize(917,213 - 71))
		self.btnsPanel:setAnchorPoint(CCPoint(0,0))
		self.btnsPanel:setPosition(CCPoint(0,0))
		self.bg:addChild(self.btnsPanel)
		self:createLeftBtns(cfg.train_cfg)
	end,
	--创建标签
	createToggleBtns = function(self, toggle_cfg)
		self.toggleBtns = new({})		--按钮
		self.toggleTexts = new({})	--按钮上的文字
		--选择训练/提取模式
		local normal = CCSprite:spriteWithFile("UI/xun_lian_panel/toggle_bg.png")
		local focus = CCSprite:spriteWithFile("UI/nothing.png")
		focus:setContentSize(normal:getContentSize())
		self.toggleBtns[1] = dbUIButtonToggle:buttonWithImage(normal, focus)
		self.toggleBtns[1]:setAnchorPoint(CCPoint(0, 1))
		self.toggleBtns[1]:setPosition(CCPoint(0, 213))
		
		self.toggleTexts[1] = dbUIButtonToggle:buttonWithImage(toggle_cfg.toggle1.normal, toggle_cfg.toggle1.toggle)
		self.toggleTexts[1]:setAnchorPoint(CCPoint(0.5, 0.5))
		self.toggleTexts[1]:setPosition(CCPoint(459 / 2, 71 / 2))
		self.toggleTexts[1]:setIsEnabled(false)
		self.toggleBtns[1]:addChild(self.toggleTexts[1])
		--选择训练位
		local normal = CCSprite:spriteWithFile("UI/xun_lian_panel/toggle_bg.png")
		normal:setFlipX(true)
		local focus = CCSprite:spriteWithFile("UI/nothing.png")
		focus:setContentSize(normal:getContentSize())
		self.toggleBtns[2] = dbUIButtonToggle:buttonWithImage(normal, focus)
		self.toggleBtns[2]:setAnchorPoint(CCPoint(1, 1))
		self.toggleBtns[2]:setPosition(CCPoint(917, 213))
		self.toggleTexts[2] = dbUIButtonToggle:buttonWithImage(toggle_cfg.toggle2.normal, toggle_cfg.toggle2.toggle)
		self.toggleTexts[2]:setAnchorPoint(CCPoint(0.5, 0.5))
		self.toggleTexts[2]:setPosition(CCPoint(459 / 2, 71 / 2))
		self.toggleTexts[2]:setIsEnabled(false)
		self.toggleBtns[2]:addChild(self.toggleTexts[2])
		
		public_toggleRadioBtn(self.toggleBtns, self.toggleBtns[1])
		self.toggleTexts[1]:toggled(true)
		
		for i = 1, #self.toggleBtns do
			local btn = self.toggleBtns[i]
			self.bg:addChild(btn)
			
			btn.m_nScriptClickedHandler = function() 
				if (btn:isToggled()) then
					if i == 1 then
						self.toggleTexts[1]:toggled(true)
						self.toggleTexts[2]:toggled(false)
						self:createLeftBtns(self.config.train_cfg)
					else
						self.toggleTexts[2]:toggled(true)
						self.toggleTexts[1]:toggled(false)
						self:createRightBtns()
					end
				end
				public_toggleRadioBtn(self.toggleBtns,btn)
			end
		end
	end,
	--创建训练/提取 按钮组
	createLeftBtns = function(self, train_cfg)
		self.btnsPanel:removeAllChildrenWithCleanup(true)
		for i = 1, #train_cfg do
			local cfg = train_cfg[i]
			if cfg.open_condition1 or cfg.open_condition2 then
				local btn = dbUIButtonScale:buttonWithImage(CCSprite:spriteWithFile(cfg.toggle_1),1.2,ccc3(125, 125, 125))
				btn:setPosition(CCPoint(150+200*(i-1),90))
				btn:setAnchorPoint(CCPoint(0.5,0.5))
				btn.m_nScriptClickedHandler = function(ccp)
					cfg.callback(self.config.from, cfg.type)
				end
				self.btnsPanel:addChild(btn)
				local label = CCLabelTTF:labelWithString(cfg.cast_label,SYSFONT[EQUIPMENT], 20)
				label:setAnchorPoint(CCPoint(0.5,1))
				label:setColor(ccc3(132,84,36))
				label:setPosition(CCPoint(btn:getContentSize().width/2,-10))
				btn:addChild(label)
				--特殊处理，--新手引导时会用到
				if i==1 then
					self.startBtn = btn 
				end
			else
				local spr = CCSprite:spriteWithFile(cfg.lock)--高级
				spr:setPosition(CCPoint(150+200*(i-1),90))
				spr:setAnchorPoint(CCPoint(0.5,0.5))
				self.btnsPanel:addChild(spr)
				local label = CCLabelTTF:labelWithString(cfg.open_desc,SYSFONT[EQUIPMENT], 20)
				label:setAnchorPoint(CCPoint(0.5,1))
				label:setColor(ccc3(132,84,36))
				label:setPosition(CCPoint(spr:getContentSize().width/2,-10))
				spr:addChild(label)
			end
		end
	end,
	--创建训练槽 按钮组
	createRightBtns = function(self)
		self.btnsPanel:removeAllChildrenWithCleanup(true)
		--获取训练中的generals
		local trainGeneralIds = {}
		for i = 1, #GloblePlayerData.trainings.training_list do 
			if GloblePlayerData.trainings.training_list[i].training_end >= 1 then
				table.insert(trainGeneralIds, GloblePlayerData.trainings.training_list[i].generalId)
			end
		end
		for i = 1, 5 do
			local slot = nil
			if i <= GloblePlayerData.trainings.training_slot then
				if i <= #trainGeneralIds then 
					slot = dbUIButtonScale:buttonWithImage("UI/xun_lian_panel/put_slot.png")
					local general = findGeneralByGeneralId(trainGeneralIds[i])
					local figureBtn = dbUIButtonScale:buttonWithImage("head/Big/head_big_"..general.figure..".png", 1, ccc3(125, 125, 125))
					figureBtn:setAnchorPoint(CCPoint(0.5,0))
					figureBtn:setScale((general.is_role and 0.5 or 0.8) * 173/figureBtn:getContentSize().width)
					figureBtn:setPosition(118 / 2 , general.is_role and 20 or 0)
					figureBtn.m_nScriptClickedHandler = function()
						GloblePanel.curGenerals = findGeneralIndexByGeneralId(general.general_id)
						GloblePanel:clearMainWidget()
						createXunlian()
					end
					slot:addChild(figureBtn)
				else
					slot = dbUIButtonScale:buttonWithImage("UI/xun_lian_panel/empty_slot.png", 1, ccc3(125, 125, 125))
					slot.m_nScriptClickedHandler = function(ccp)
						local function toCenterWidgetPostion(pos)
							return ccpAdd(pos, CCPoint(44, 50))
						end
						local centerWidgetPos = toCenterWidgetPostion(CCPoint(slot:getPositionX() + 118 / 2, slot:getPositionY() + 118 + 5))
						self:selectGeneral(centerWidgetPos)
					end
				end
			else
				slot = dbUIButtonScale:buttonWithImage("UI/xun_lian_panel/lock_slot.png", 1, ccc3(125, 125, 125))
				slot.m_nScriptClickedHandler = function()	
					self.openSlot()
				end
			end
			slot:setAnchorPoint(CCPoint(0, 0))
			slot:setPosition(CCPoint(75 + 160 * (i - 1), 15))
			self.btnsPanel:addChild(slot)
		end
	end,
	--选择宠物
	selectGeneral = function(self, pos)
		--获取未训练的general
		local notInTrainGeneral = {}
		for i = 1, #GloblePlayerData.generals do 
			local general = GloblePlayerData.generals[i]
			local trainGeneral = findTrainByGeneralId(general.general_id)
			if trainGeneral ~= 0 and trainGeneral.training_end >= 1 then
			else
				table.insert(notInTrainGeneral, general)
			end
		end
		if #notInTrainGeneral == 0 then
			alert("没有未训练的宠物")
		else
			new(generalSelectDialog):create(notInTrainGeneral, pos)
		end
	end,
	--开启训练位对话框
	openSlot = function(self)
		local createTrainingSlotBtns = function(ccp)
			local btns = {}
			local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
			btns[1] = btn
			btns[1].action = TrainingSlotOpen
			btns[1].param = {
				callback = updateRightBtns,
			}
 
			local btn = dbUIButtonScale:buttonWithImage("UI/public/cancel_btn.png", 1, ccc3(125, 125, 125))
			btns[2] = btn
			btns[2].action = nothing
			return btns
		end
		local price = {
			"50金币","100金币","200金币","500金币","1000金币","2000金币","5000金币","10000金币"
		}
		local training_slot = GloblePlayerData.trainings.training_slot - 1
		local dialogCfg = new(basicDialogCfg)
		dialogCfg.bg = "UI/baoguoPanel/kuang.png"
		dialogCfg.msg = "是否消耗"..price[training_slot].."增加训练位！" 
		dialogCfg.msgSize = 24
		dialogCfg.position = CCPoint(WINSIZE.width/2,WINSIZE.height/2)
		dialogCfg.dialogType = 5
		dialogCfg.btns = createTrainingSlotBtns()
		local dialog = new(Dialog)
		dialog:create(dialogCfg)
	end
}

generalSelectDialog = {
	create = function(self, generals, pos)
		self:initBase(pos)
		
		local width = 300
		local height = 395
		
		self.main = dbUIPanel:panelWithSize(CCSize(width,height))
		self.main:setAnchorPoint(CCPoint(0.5, 0))
		self.main:setPosition(self.pos)
		self.mask:addChild(self.main)
		--背景
		local bg = createBG("UI/baoguoPanel/kuang.png",width,height - 36,CCSizeMake(30,30))
		bg:setAnchorPoint(CCPoint(0.5, 1))
		bg:setPosition(CCPoint(width / 2, height))
		self.main:addChild(bg)
		--箭头
		local arrow = CCSprite:spriteWithFile("UI/xun_lian_panel/arrow.png")
		arrow:setAnchorPoint(CCPoint(0.5, 0))
		arrow:setPosition(CCPoint(width / 2, 0))
		self.main:addChild(arrow)
		--滚动列表
		self.generalList = dbUIList:list(CCRectMake(20, 10, width - 40, height - 56),0);		--210， 210
		bg:addChild(self.generalList)
		
		local createGeneral = function(general)
			local panel = dbUIPanel:panelWithSize(CCSize(width - 40, 50))
			--名字居中
			local name = CCLabelTTF:labelWithString(general.name, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 24)
			name:setColor(PLAYER_COLOR[general.quality])
			name:setAnchorPoint(CCPoint(0.5, 0.5))
			name:setPosition(CCPoint((width - 40) / 2, 50 / 2))
			panel:addChild(name)
			--是否出战
			local isChuZhan = generalIsInFormation(general.general_id)
			if isChuZhan then
				local chuzhan = CCSprite:spriteWithFile("UI/generalListPanel/chuzhan.png")
				chuzhan:setAnchorPoint(CCPoint(0, 0.5))
				chuzhan:setPosition(CCPoint(0,50 / 2))
				panel:addChild(chuzhan)
			end
			--等级
			local level = CCLabelTTF:labelWithString(general.level.."级", CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 24)
			level:setColor(ccc3(205, 170, 104))
			level:setAnchorPoint(CCPoint(1, 0.5))
			level:setPosition(CCPoint(width - 40, 50 / 2))
			panel:addChild(level)
			
			panel.m_nScriptClickedHandler = function()
				self:closePanel()
				GloblePanel.curGenerals = findGeneralIndexByGeneralId(general.general_id)
				GloblePanel:clearMainWidget()
				createXunlian(true)
			end
			return panel
		end
		for i = 1, #generals do
			local panel = createGeneral(generals[i])
			self.generalList:insterWidget(panel)
		end
		self.generalList:m_setPosition(CCPoint(0, -self.generalList:get_m_content_size().height + self.generalList:getContentSize().height))
	end,
	
	initBase = function(self, pos)
		self.mask = dbUIPanel:panelWithSize(CCSize(1010, 702))
		GloblePanel.centerWidget:addChild(self.mask, 10000)

		if not pos then
			self.pos = CCPoint(505, 351)
		else
			self.pos = pos
		end
		self.mask.m_nScriptClickedHandler = function()
			self:closePanel()
		end
	end,
	closePanel = function(self)
		self.mask:removeFromParentAndCleanup(true)
	end,
}

updateRightBtns = function()
	globalXunlianBottonPanel:createRightBtns()
end
--礼包
GlobalCreateGiftPanel = function()
	GlobalGiftPanel = new(GiftPanel)
	GlobalGiftPanel:create()
end

GiftPanel = {
	create = function(self)
		self:initBase()
		self:createRight()
		self:createLeft()
	end,

	--创建左面板
	createLeft = function(self)
		local leftPanel = createDarkBG(216,536)
		leftPanel:setAnchorPoint(CCPoint(0, 0))
		leftPanel:setPosition(CCPoint(42, 40))
		self.mainWidget:addChild(leftPanel)
		self.leftPanel = leftPanel

		self.chooseTypeBtns = new({})

		local btn = dbUIButtonToggle:buttonWithImage("UI/gift/sc_1.png","UI/gift/sc_2.png")
		btn:setAnchorPoint(CCPoint(0.5, 0))
		btn:setPosition(CCPoint(216/2, 300))
		self.leftPanel:addChild(btn)
		self.chooseTypeBtns[1] = btn

		local btn = dbUIButtonToggle:buttonWithImage("UI/gift/lj_1.png","UI/gift/lj_2.png")
		btn:setAnchorPoint(CCPoint(0.5, 0))
		btn:setPosition(CCPoint(216/2, 80))
		self.leftPanel:addChild(btn)
		self.chooseTypeBtns[2] = btn

		local callbackFirst = function(self,json)
			if self.mainWidget then
				self:createSouCong(json)
			end
		end
		for i=1,2 do
			self.chooseTypeBtns[i].m_nScriptClickedHandler = function(ccp)
				if (self.chooseTypeBtns[i]:isToggled()) then
					if i==1 then --首次
						self:checkFirstPay(callbackFirst)
					elseif i==2 then--累计
						self:createLeiJi()
					end
				end
				public_toggleRadioBtn(self.chooseTypeBtns,self.chooseTypeBtns[i])
			end
		end

		--默认选中第一个
		public_toggleRadioBtn(self.chooseTypeBtns,self.chooseTypeBtns[1])
		self:checkFirstPay(callbackFirst)
	end,

	--创建右面板
	createRight=function(self)
		self.rightBg = createDarkBG(694,536)
		self.rightBg:setPosition(CCPoint(273, 40))
		self.mainWidget:addChild(self.rightBg)

		self.rightPanel = dbUIPanel:panelWithSize(CCSize(694,536))
		self.rightPanel:setAnchorPoint(CCPoint(0,0))
		self.rightPanel:setPosition(CCPoint(0,0))
		self.rightBg:addChild(self.rightPanel)
	end,

	--累计充值礼包
	createLeiJi = function(self)
		local rightPanel = self.rightPanel
		rightPanel:removeAllChildrenWithCleanup(true)

		local lj_head = CCSprite:spriteWithFile("UI/gift/lj_head.png")
		lj_head:setAnchorPoint(CCPoint(0.5,0))
		lj_head:setPosition(CCPoint(694/2, 435))
		rightPanel:addChild(lj_head)

		local itemList = dbUIList:list(CCRectMake(0,10,694,420),0)
		rightPanel:addChild(itemList)

		for i=1,table.getn(total_reward_cfg) do
			local data = total_reward_cfg[i]

			local numofgift= table.getn(data[2])   ----礼物分行
			local numline=math.ceil(1.0*numofgift/4)   ----行数
			local listed=0                         -----以列物品数

			local panel = dbUIPanel:panelWithSize(CCSize(694, 112+numline*138))
			panel:setAnchorPoint(CCPoint(0, 0))
			panel:setPosition(30+(i-1)*135, 230)
			itemList:insterWidget(panel)

			local label = CCLabelTTF:labelWithString("累计充值", CCSize(150,0),0,SYSFONT[EQUIPMENT], 27)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(20,107+numline*138))
			label:setColor(ccc3(255,204,102))
			panel:addChild(label)
			local moneyLabel = CCLabelTTF:labelWithString(data[1], CCSize(0,0),0,SYSFONT[EQUIPMENT], 27)
			moneyLabel:setAnchorPoint(CCPoint(0,1))
			moneyLabel:setPosition(CCPoint(145,107+numline*138))
			moneyLabel:setColor(ccc3(252,255,0))
			panel:addChild(moneyLabel)
			local label = CCLabelTTF:labelWithString("金币，即可领取：", CCSize(250,0),0,SYSFONT[EQUIPMENT], 27)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(145+moneyLabel:getContentSize().width+10,107+numline*138))
			label:setColor(ccc3(255,204,102))
			panel:addChild(label)

			for k=1,numline do
				for j=1,4 do
					if listed==numofgift then
						break
					end

					local reward = data[2][listed+1]
					local kuang = CreateItemInfoForGift(reward.id,reward.count)
					kuang:setPosition(40+(j-1)*170, 138*numline-(k-1)*138-30)  --138*numline-(k-1)*138-24
					panel:addChild(kuang)
					listed=listed+1
				end
			end

			local btn = dbUIButtonScale:buttonWithImage("UI/gift/get.png",1,ccc3(152,203,0))
			btn:setPosition(CCPoint(600, 40))
			btn.m_nScriptClickedHandler = function(ccp)
				local callback = function(self,json)
					local error_code = json:getByKey("error_code"):asInt()
					if error_code == -1 then
						local addList = json:getByKey("add_item_id_list")
						local changeList = json:getByKey("change_item_id_list")
						local itemId = addList:size()==0 and changeList:getByIndex(0):asInt() or addList:getByIndex(0):asInt()
						local item = {
							json:getByKey("cfg_item_id"):asInt(),
							itemId,
							1,
							true
						}
						battleGetItems(item,true)
					elseif error_code==363 then
						alert("不能重复领取")
					elseif error_code==369 then
						globleShowVipPanel()
					end
				end
				self:openReward({class=4,idx=i,type=0},callback)
			end
			panel:addChild(btn)

			--分割线
			local line = CCSprite:spriteWithFile("UI/public/line_2.png")
			line:setAnchorPoint(CCPoint(0,0))
			line:setScaleX(694/28)
			line:setPosition(0, 0)
			panel:addChild(line)
		end

		itemList:m_setPosition(CCPoint(0,- itemList:get_m_content_size().height + itemList:getContentSize().height ))
	end,

	--创建首充礼包
	createSouCong = function(self,json)
		local enable = json:getByKey("enable"):asBool()

		local first_pay_info = {
			{ id = 	0, 		  count = 500000,	name = "银币"},
			{ id = 	14,  	  count = 50,		name = "经验丹"},
			{ id = 	42200001, count = 4,		name = "一级宝石袋"},
			{ id = 	14010001, count = 1,		name = "灵狐宠物蛋"},
		}

		local rightPanel = self.rightPanel
		rightPanel:removeAllChildrenWithCleanup(true)

		local sc_head = CCSprite:spriteWithFile("UI/gift/sc_head.png")
		sc_head:setAnchorPoint(CCPoint(0.5,0))
		sc_head:setPosition(CCPoint(694/2, 435))
		rightPanel:addChild(sc_head)

		local text = enable and "首次充值可领取以下礼包！" or "已领取！"
		local label = CCLabelTTF:labelWithString(text, CCSize(0,0),1,SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5, 0))
		label:setPosition(CCPoint(694/2,350))
		label:setColor(ccc3(152,203,0))
		rightPanel:addChild(label)

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(694/28)
		line:setPosition(0, 300)
		rightPanel:addChild(line)

		for i=1,4 do
			local kuang = CreateItemInfoForGift(first_pay_info[i].id,first_pay_info[i].count)
			kuang:setPosition(35+(i-1)*133, 190)
			rightPanel:addChild(kuang)
		end

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(694/28)
		line:setPosition(0, 145)
		rightPanel:addChild(line)

		local btn = dbUIButtonScale:buttonWithImage("UI/gift/get.png",1,ccc3(152,203,0))
		btn:setPosition(CCPoint(694/2, 80))
		btn.m_nScriptClickedHandler = function(ccp)
			local callback = function(self,json)
				local error_code = json:getByKey("error_code"):asInt()
				if error_code == 363 then
					alert("首充礼包已经领取过了，不能重复领取")
				elseif error_code == 369 then
					globleShowVipPanel()
					alert("首次充值后才可以领取")
				elseif error_code == -1 then
					local addList = json:getByKey("add_item_id_list")
					local changeList = json:getByKey("change_item_id_list")
					local itemId = addList:size()==0 and changeList:getByIndex(0):asInt() or addList:getByIndex(0):asInt()
					local item = {
						json:getByKey("cfg_item_id"):asInt(),
						itemId,
					}
					battleGetItems(item,true)	
				end
			end
			self:openReward({class=5},callback)
		end
		rightPanel:addChild(btn)
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light_small.png")
		bg:setPosition(CCPoint(1010/2, 665/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		self.top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,588))
		self.centerWidget:addChild(self.top)

		--面板提示图标
		local head = CCSprite:spriteWithFile("UI/gift/head.png")
		head:setPosition(CCPoint(1010/2, 12))
		head:setAnchorPoint(CCPoint(0.5, 0))
		self.top:addChild(head)

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.top:addChild(closeBtn.btn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
		removeUnusedTextures()
	end,

	openReward = function(self,param,callback)
		local respsonse = function (json)
			callback(self,json)
			local error_code = json:getByKey("error_code"):asInt()
			if error_code == -1 then
				local gift_enable = json:getByKey("gift_enable"):asBool()
				ClientData.gift_enable = gift_enable
				GiftEnable(ClientData.gift_enable)
			elseif error_code == 2001 then
				alert("背包空间不足，礼包领取失败，请整理背包后重新领取。")
			end			
		end

		local request = function()
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)

			local net_opt = 0
			if param.class ==1 then
				net_opt = Net.OPT_RewardNewLogin
			end
			if param.class ==2 then
				net_opt = Net.OPT_RewardLogin
			end
			if param.class ==3 then
				net_opt = Net.OPT_RewardSinglePay
				cj:setByKey("type", param.type)
			end
			if param.class ==4 then
				net_opt = Net.OPT_RewardTotal
				cj:setByKey("idx", param.idx)
				cj:setByKey("type", param.type)
			end
			if param.class ==5 then
				net_opt = Net.OPT_RewardFirstPay
			end
			if net_opt ~= 0 then
				NetMgr:registOpLuaFinishedCB(net_opt,respsonse)
				NetMgr:registOpLuaFailedCB(net_opt,opFailedCB)
				NetMgr:setOpUnique(net_opt)
				NetMgr:executeOperate(net_opt, cj)
			else
				alert("礼包错误！")
			end
		end
		request()
	end,

	checkFirstPay = function(self,callback)
		local respsonse = function (json)
			callback(self,json)
		end

		local request = function()
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			
			local net_opt = Net.OPT_CheckFirstPayEnable
			
			NetMgr:registOpLuaFinishedCB(net_opt,respsonse)
			NetMgr:registOpLuaFailedCB(net_opt,opFailedCB)
			NetMgr:setOpUnique(net_opt)
			NetMgr:executeOperate(net_opt, cj)
		end
		request()
	end	
}
--开服礼包
GlobalCreateServerOpenGiftPanel = function()
	GlobalServerOpenGiftPanel = new(ServerOpenGiftPanel)
	GlobalServerOpenGiftPanel:create()
end

---textDirection： 1 文字在下，2 文字在右
CreateItemInfoForGift = function(cfgItemId,amount,textDirection,fontSize,noLabel)
	if textDirection==nil then textDirection = 1 end
	if fontSize == nil then fontSize = 22 end
	if noLabel == nil then noLabel = false end
	
	local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
	kuang:setAnchorPoint(CCPoint(0, 0))

	local kuang_94_94 = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
	kuang_94_94:setPosition(48, 48)
	kuang_94_94:setAnchorPoint(CCPoint(0.5, 0.5))
	kuang:addChild(kuang_94_94)

	local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
	local itemJson = itemJsonConfig:getByKey(cfgItemId)
		
	if cfgItemId==0 or cfgItemId==1 then --银币或金币
		local item = CCSprite:spriteWithFile((cfgItemId==0 and "icon/copper.png" or "icon/gold.png"))
		item:setAnchorPoint(CCPoint(0.5, 0.5))
		item:setPosition(CCPoint(48,48))
		kuang:addChild(item)

		if noLabel == false then
			local pic_path=cfgItemId==0 and "icon/copper_small.png" or "icon/gold_small.png"
			local moneypic = CCSprite:spriteWithFile(pic_path)
			moneypic:setPosition(10, -7)
			moneypic:setAnchorPoint(CCPoint(0.5, 1))
			kuang:addChild(moneypic)
			local label = CCLabelTTF:labelWithString("*"..amount, CCSize(0,0),1,SYSFONT[EQUIPMENT], fontSize)
			label:setAnchorPoint(CCPoint(0.5,1))
			label:setPosition(CCPoint(58,-5))
			label:setColor(ccc3(255,204,102))
			kuang:addChild(label)
		end
	elseif cfgItemId==14 then
		local item = CCSprite:spriteWithFile("icon/jin_yan_dan.png" )
		item:setAnchorPoint(CCPoint(0.5, 0.5))
		item:setPosition(CCPoint(48,48))
		kuang:addChild(item)
		
		if noLabel == false then
			local label = nil
			if textDirection == 1 then
				label = CCLabelTTF:labelWithString(itemJson:getByKey("name"):asString().."*"..amount, CCSize(0,0),1,SYSFONT[EQUIPMENT], fontSize)
				label:setAnchorPoint(CCPoint(0.5,1))
				label:setPosition(CCPoint(50,-3))
			elseif textDirection == 2 then
				label = CCLabelTTF:labelWithString(itemJson:getByKey("name"):asString().."*"..amount, CCSize(300,0),0,SYSFONT[EQUIPMENT], fontSize)
				label:setAnchorPoint(CCPoint(0,0.5))
				label:setPosition(CCPoint(92,45))
			end
			label:setColor(ccc3(255,204,102))
			kuang:addChild(label)
		end
	else
		local item = getItemBorder(cfgItemId)
		item:setAnchorPoint(CCPoint(0.5, 0.5))
		item:setPosition(CCPoint(48,48))
		kuang:addChild(item)
		
		if noLabel == false then
			local label = nil
			if textDirection == 1 then
				label = CCLabelTTF:labelWithString(itemJson:getByKey("name"):asString().."*"..amount, CCSize(0,0),1,SYSFONT[EQUIPMENT], fontSize)
				label:setAnchorPoint(CCPoint(0.5,1))
				label:setPosition(CCPoint(50,-3))
			elseif textDirection == 2 then
				label = CCLabelTTF:labelWithString(itemJson:getByKey("name"):asString().."*"..amount, CCSize(300,0),0,SYSFONT[EQUIPMENT], fontSize)
				label:setAnchorPoint(CCPoint(0,0.5))
				label:setPosition(CCPoint(92,45))
			end
			label:setColor(ccc3(255,204,102))
			kuang:addChild(label)
		end
	end
	return kuang
end

ServerOpenGiftPanel = {
	create = function(self)
		self:initBase()
		self:createRight()
		self:createLeft()
	end,

	--创建左面板
	createLeft = function(self)
		local leftPanel = createDarkBG(216,536)
		leftPanel:setAnchorPoint(CCPoint(0, 0))
		leftPanel:setPosition(CCPoint(42, 40))
		self.mainWidget:addChild(leftPanel)
		self.leftPanel = leftPanel

	    local createItem = function(i)
		    local btnPanel = dbUIPanel:panelWithSize(CCSize(216, 90))
		    btnPanel:setAnchorPoint(CCPoint(0,0))
		    --  local btn = dbUIButtonToggle:buttonWithImage("UI/gift_server_open/togglr_1.png","UI/gift_server_open/togglr_2.png")
		    local btn = dbUIButtonToggle:buttonWithImage("UI/activity/activity_btn_bg_normal.png","UI/activity/activity_btn_bg_pressed.png")
		    btn:setAnchorPoint(CCPoint(0.5, 0.5))
		    btn:setPosition(CCPoint(216/2,35))
		    btn:setScaleX(0.9)
			btn.m_nScriptClickedHandler = function(ccp)
				self.rightPanel:removeAllChildrenWithCleanup(true)
				local handle = SERVER_OPEN_GIFT_CFG[i].handle;
				self[handle](self)
				public_toggleRadioBtn(self.chooseTypeBtns,self.chooseTypeBtns[i])
			end
		    btnPanel:addChild(btn)
		    self.chooseTypeBtns[i] = btn

			local label = CCLabelTTF:labelWithString(SERVER_OPEN_GIFT_CFG[i].title,SYSFONT[EQUIPMENT],24)
			label:setPosition(CCPoint(216/2,47))
			label:setColor(ccc3(255,235,149))
			btn:addChild(label)
			
			local label = CCLabelTTF:labelWithString(SERVER_OPEN_GIFT_CFG[i].sub_title,SYSFONT[EQUIPMENT],20)
			label:setPosition(CCPoint(216/2,22))
			label:setColor(ccc3(254,255,101))
			btn:addChild(label)
					    
		    return btnPanel
		end

		self.chooseTypeBtns = new({})
		self.UIList = dbUIList:list(CCRectMake(0, 0, 216, 536),0)
		self.leftPanel:addChild(self.UIList)
		for i = 1, #SERVER_OPEN_GIFT_CFG do
			local btn = createItem(i)
			self.UIList:insterWidget(btn)
		end
		local y = self.UIList:getContentSize().height-self.UIList:get_m_content_size().height
		self.UIList:m_setPosition(CCPoint(0,y))
		
		--默认选中第一个
		public_toggleRadioBtn(self.chooseTypeBtns,self.chooseTypeBtns[1])
		self:showFirstPay()
	end,

	--创建右面板
	createRight = function(self)
		self.rightBg = createDarkBG(694,536)
		self.rightBg:setPosition(CCPoint(273, 40))
		self.mainWidget:addChild(self.rightBg)

		self.rightPanel = dbUIPanel:panelWithSize(CCSize(694,536))
		self.rightPanel:setAnchorPoint(CCPoint(0,0))
		self.rightPanel:setPosition(CCPoint(0,0))
		self.rightBg:addChild(self.rightPanel)
	end,

	--创建首充礼包
	showFirstPay = function(self,json)
		local rightPanel = self.rightPanel

		local first_pay_info = {
			{ id = 	0, 		  count = 500000,	name = "银币"},
			{ id = 	14,  	  count = 50,		name = "经验丹"},
			{ id = 	42200001, count = 4,		name = "一级宝石袋"},
			{ id = 	14010001, count = 1,		name = "灵狐宠物蛋"},
		}

		local sc_head = CCSprite:spriteWithFile("UI/gift/sc_head.png")
		sc_head:setAnchorPoint(CCPoint(0.5,0))
		sc_head:setPosition(CCPoint(694/2, 435))
		rightPanel:addChild(sc_head)

		local label = CCLabelTTF:labelWithString("首次充值可领取以下礼包！",SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5, 0))
		label:setPosition(CCPoint(694/2,350))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(694/28)
		line:setPosition(0, 300)
		rightPanel:addChild(line)

		for i=1,#first_pay_info do
			local kuang = CreateItemInfoForGift(first_pay_info[i].id,first_pay_info[i].count)
			kuang:setPosition(35+(i-1)*133, 190)
			rightPanel:addChild(kuang)
		end

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(694/28)
		line:setPosition(0, 145)
		rightPanel:addChild(line)

		local btn = dbUIButtonScale:buttonWithImage("UI/gift/get.png",1,ccc3(152,203,0))
		btn:setPosition(CCPoint(694/2, 80))
		btn.m_nScriptClickedHandler = function(ccp)
			local respsonse = function (json)
				btn:setIsEnabled(true)
				local error_code = json:getByKey("error_code"):asInt()
				if error_code == 363 then
					alert("首充礼包已经领取过了，不能重复领取")
				elseif error_code == 369 then
					alert("首次充值后才可以领取")
					globleShowVipPanel()
				elseif error_code == 2001 then
					alert("背包空间不足，礼包领取失败，请整理背包后重新领取。")	
				elseif error_code == -1 then
					local addList = json:getByKey("add_item_id_list")
					local changeList = json:getByKey("change_item_id_list")
					local itemId = addList:size()==0 and changeList:getByIndex(0):asInt() or addList:getByIndex(0):asInt()
					local item = {
						json:getByKey("cfg_item_id"):asInt(),
						itemId,
					}
					battleGetItems(item,true)	
				end
			end

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)

			NetMgr:registOpLuaFinishedCB(Net.OPT_RewardFirstPay,respsonse)
			NetMgr:registOpLuaFailedCB(Net.OPT_RewardFirstPay,opFailedCB)
			NetMgr:setOpUnique(Net.OPT_RewardFirstPay)
			NetMgr:executeOperate(Net.OPT_RewardFirstPay, cj)
			btn:setIsEnabled(false)
		end
		rightPanel:addChild(btn)
	end,

	--新手礼包
	showGreenhorn = function(self)
		local reward = {
			{ id = 	41090003, count = 2,name = "高级勋章包"},
			{ id = 	41060005, count = 1,name = "聚银宝盆"},
			{ id = 	14010001, count = 1,name = "半打金朗姆酒"},
		}
		
		local rightPanel = self.rightPanel
		local sc_head = CCSprite:spriteWithFile("UI/gift_server_open/2.png")
		sc_head:setAnchorPoint(CCPoint(0.5,0))
		sc_head:setPosition(CCPoint(694/2, 430))
		rightPanel:addChild(sc_head)

		local label = CCLabelTTF:labelWithString("【活动日期】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,404))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("开服之日起",CCSize(300,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(220,404))
		label:setColor(ccc3(254,0,0))
		rightPanel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("【活动内容】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,364))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("为庆祝《诸神Q传》的新服开启，我们将赠送豪华新手大礼包给所有喜欢和支持《诸神Q传》的玩家，新手礼包内容：",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,350))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)

		for i=1,#reward do
			local kuang = CreateItemInfoForGift(reward[i].id,reward[i].count)
			kuang:setPosition(140+(i-1)*150, 165)
			rightPanel:addChild(kuang)
		end
		
		local label = CCLabelTTF:labelWithString("【奖品发放】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,100))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("玩家加入妖精无语VIP群（群号：140960949）后小窗妖精MM（QQ：154566502），领取新手大礼包",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,87))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
	end,
	
	---首充返利100%
	showPayReturn = function(self)
		local rightPanel = self.rightPanel
		local sc_head = CCSprite:spriteWithFile("UI/gift_server_open/2.png")
		sc_head:setAnchorPoint(CCPoint(0.5,0))
		sc_head:setPosition(CCPoint(694/2, 430))
		rightPanel:addChild(sc_head)

		local label = CCLabelTTF:labelWithString("【活动日期】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,360))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("开服三天内",CCSize(300,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(220,360))
		label:setColor(ccc3(254,0,0))
		rightPanel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("【活动内容】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,320))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("活动期间玩家在获得首充礼包的同时，无论充值多少，都可以获得当次充值100%的金币数量作为返利，只是首次哦，冲的越多，返的越多！",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,305))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local btn = dbUIButtonScale:buttonWithImage("UI/gift/get.png",1,ccc3(152,203,0))
		btn:setPosition(CCPoint(694/2, 80))
		btn.m_nScriptClickedHandler = function(ccp)
			globleShowVipPanel()
		end
		rightPanel:addChild(btn)
	end,

	---天降幸运大礼包
	showLuckGift = function(self)
		local reward = {
			{ id = 	0, 		  count = 500000,	name = "银币"},
		}
		
		local rightPanel = self.rightPanel
		local sc_head = CCSprite:spriteWithFile("UI/gift_server_open/2.png")
		sc_head:setAnchorPoint(CCPoint(0.5,0))
		sc_head:setPosition(CCPoint(694/2, 430))
		rightPanel:addChild(sc_head)

		local label = CCLabelTTF:labelWithString("【活动日期】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,404))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("开服5天内",CCSize(300,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(220,404))
		label:setColor(ccc3(254,0,0))
		rightPanel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("【活动内容】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,364))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("新服开启后一周将随机抽取10名玩家获得幸运大礼！幸运玩家获得幸运红包奖励：",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,350))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)

		local kuang = CreateItemInfoForGift(reward[1].id,reward[1].count)
		kuang:setAnchorPoint(CCPoint(0.5,0))
		kuang:setPosition(CCPoint(694/2, 165))
		rightPanel:addChild(kuang)
		
		local label = CCLabelTTF:labelWithString("【奖品发放】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,100))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("开服5天内每天中午12点在妖精物语VIP交流群(群号:140690949)内公布获奖名单并发放奖励",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,87))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
	end,
	
	---冲击富豪榜
	showRich = function(self)
		local reward = {
			{ id = 	1, count = 3000,name = "金币",rank="第一名"},
			{ id = 	1, count = 2000,name = "金币",rank="第二名"},
			{ id = 	1, count = 1000,name = "金币",rank="第三~五名"},
		}
		
		local rightPanel = self.rightPanel
		local sc_head = CCSprite:spriteWithFile("UI/gift_server_open/2.png")
		sc_head:setAnchorPoint(CCPoint(0.5,0))
		sc_head:setPosition(CCPoint(694/2, 430))
		rightPanel:addChild(sc_head)

		local label = CCLabelTTF:labelWithString("【活动日期】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,404))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("开服之日起",CCSize(300,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(220,404))
		label:setColor(ccc3(254,0,0))
		rightPanel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("【活动内容】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,364))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("在活动结束后玩家充值额度排名前五的能获得以下奖励!",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,350))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)

		for i=1,#reward do
			local kuang = CreateItemInfoForGift(reward[i].id,reward[i].count)
			kuang:setPosition(140+(i-1)*150, 165)
			rightPanel:addChild(kuang)
			local label = CCLabelTTF:labelWithString(reward[i].rank,SYSFONT[EQUIPMENT], 24)
			label:setAnchorPoint(CCPoint(0.5,0))
			label:setPosition(CCPoint(48,110))
			label:setColor(ccc3(254,0,0))
			kuang:addChild(label)
		end
		
		local label = CCLabelTTF:labelWithString("【奖品发放】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,100))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("活动结束后将在妖精物语VIP交流群(群号:140690949)内公布获奖名单并发放奖励",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,87))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)	
	end,

	---冲级大奖赏
	showLevelUp = function(self)
		local level_reward_cfg = {
			{
				level = "40~45级",
				reward = {
					{ id = 	41050002, count = 5,name = "大金袋"},
					{ id = 	41090003, count = 5,name = "高级勋章包"},
					{ id = 	14010001, count = 3,name = "聚银宝盆"},
				}
			},
			{
				level = "46~49级",
				reward = {
					{ id = 	41050002, count = 8,name = "大金袋"},
					{ id = 	41090003, count = 8,name = "高级勋章包"},
					{ id = 	14010001, count = 4,name = "聚银宝盆"},
				}
			},
			{
				level = "50级以上",
				reward = {
					{ id = 	41050002, count = 10,name = "大金袋"},
					{ id = 	41090003, count = 10,name = "高级勋章包"},
					{ id = 	14010001, count = 5,name = "聚银宝盆"},
				}
			}						
		}
		
		local rightPanel = self.rightPanel
		local sc_head = CCSprite:spriteWithFile("UI/gift_server_open/2.png")
		sc_head:setAnchorPoint(CCPoint(0.5,0))
		sc_head:setPosition(CCPoint(694/2, 430))
		rightPanel:addChild(sc_head)

		local label = CCLabelTTF:labelWithString("【活动日期】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,404))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("开服起3天内",CCSize(300,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(220,404))
		label:setColor(ccc3(254,0,0))
		rightPanel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("【活动内容】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,364))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("开服前3天,凡是冲级到40级以上的玩家,将会获得对应的奖励！",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,350))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)

		for i=1,#level_reward_cfg do
			local cfg = level_reward_cfg[i]
			local reward = cfg.reward
			
			local label = CCLabelTTF:labelWithString(cfg.level,CCSize(250,0),0,SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(50, 310 - (i * 60)))
			label:setColor(ccc3(253,231,49))
			rightPanel:addChild(label)
			
			local scale = 0.55
			for j=1,#reward do
				local kuang = CreateItemInfoForGift(reward[j].id,reward[j].count,2,20 /scale )
				kuang:setScale(scale)
				kuang:setPosition(160+(j-1)*175, 300 - (i * 60))
				rightPanel:addChild(kuang)
			end
		end
		
		local label = CCLabelTTF:labelWithString("【奖品发放】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,80))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("活动结束后将在妖精物语VIP交流群(群号:140690949)内公布获奖名单并发放奖励",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,65))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
	end,
	
	---实力前三位
	showArenaRank = function(self)
		local level_reward_cfg = {
			{
				level = "第一名",
				reward = {
					{ id = 	41050002, count = 5,name = "大金袋"},
					{ id = 	41090003, count = 5,name = "高级勋章包"},
					{ id = 	14010001, count = 10,name = "聚银宝盆"},
					{ id = 	42200005, count = 1,name = "五级宝石袋"},
				}
			},
			{
				level = "第二名",
				reward = {
					{ id = 	41050002, count = 4,name = "大金袋"},
					{ id = 	41090003, count = 4,name = "高级勋章包"},
					{ id = 	14010001, count = 8,name = "聚银宝盆"},
					{ id = 	42200004, count = 1,name = "四级宝石袋"},
				}
			},
			{
				level = "第三名",
				reward = {
					{ id = 	41050002, count = 3,name = "大金袋"},
					{ id = 	41090003, count = 4,name = "高级勋章包"},
					{ id = 	14010001, count = 5,name = "聚银宝盆"},
					{ id = 	42200003, count = 1,name = "三级宝石袋"},
				}
			}						
		}
		
		local rightPanel = self.rightPanel
		local sc_head = CCSprite:spriteWithFile("UI/gift_server_open/2.png")
		sc_head:setAnchorPoint(CCPoint(0.5,0))
		sc_head:setPosition(CCPoint(694/2, 430))
		rightPanel:addChild(sc_head)

		local label = CCLabelTTF:labelWithString("【活动日期】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,404))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("开服一周后",CCSize(300,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(220,404))
		label:setColor(ccc3(254,0,0))
		rightPanel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("【活动内容】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,364))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("活动时间内，荣登竞技场排行榜前3位玩家将获得礼包奖励！",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,350))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)

		for i=1,#level_reward_cfg do
			local cfg = level_reward_cfg[i]
			local reward = cfg.reward
			
			local label = CCLabelTTF:labelWithString(cfg.level,CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(120, 350 - (i * 80)))
			label:setColor(ccc3(253,231,49))
			rightPanel:addChild(label)
			
			local scale = 0.7
			for j=1,#reward do
				local kuang = CreateItemInfoForGift(reward[j].id,reward[j].count,2,nil,true )
				kuang:setScale(scale)
				kuang:setPosition(225+(j-1)*120, 320 - (i * 80))
				rightPanel:addChild(kuang)
				
				local label = CCLabelTTF:labelWithString("*"..reward[j].count, CCSize(50,0),0,SYSFONT[EQUIPMENT], 32)
				label:setAnchorPoint(CCPoint(0,0.5))
				label:setPosition(CCPoint(100,54))
				label:setColor(ccc3(255,204,102))
				kuang:addChild(label)
			end
		end
		
		local label = CCLabelTTF:labelWithString("【奖品发放】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,75))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("活动结束后将在妖精物语VIP交流群(群号:140690949)内公布获奖名单并发放奖励",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,65))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)	
	end,

	---成长礼包
	showGrowGift = function(self)
		local level_reward_cfg = {
			{
				level = "10级",
				reward = "成长20级礼包、青铜长剑*1、青铜法杖*1、青铜铠甲*1、青铜法袍*1、青铜手套*1、青铜头盔*1、青铜之戒*1、青铜符文*1、战功*4000"
			},
			{
				level = "20级",
				reward = "成长30级礼包、青铜长剑*1、青铜法杖*1、青铜铠甲*1、青铜法袍*1、青铜手套*1、青铜头盔*1、青铜之戒*1、青铜符文*1、战功*6000"
			},
			{
				level = "30级",
				reward = "成长40级礼包、金刚之剑卷轴*1、金刚之杖卷轴*1、黑铁矿*4、金刚晶石*40、战功*10000"
			},
			{
				level = "40级",
				reward = "成长50级礼包、金刚手套卷轴*1、金刚头盔卷轴*1、金刚铠甲卷轴*1、金刚法袍卷轴*1、战功*15000"
			},
			{
				level = "40级",
				reward = "裂空之剑卷轴*1、裂空之杖卷轴*1、裂空铠甲卷轴*1、裂空法袍卷轴*1、战功*20000"
			},									
		}
		
		local rightPanel = self.rightPanel
		local sc_head = CCSprite:spriteWithFile("UI/gift_server_open/2.png")
		sc_head:setAnchorPoint(CCPoint(0.5,0))
		sc_head:setPosition(CCPoint(694/2, 430))
		rightPanel:addChild(sc_head)

		local label = CCLabelTTF:labelWithString("【活动日期】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,404))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("永久有效",CCSize(250,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(220,404))
		label:setColor(ccc3(254,0,0))
		rightPanel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("【活动内容】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,364))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("首次登录游戏即可获得成长礼包，达到相应等级时打开即可获得丰厚奖励!",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,350))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)

	    local createItem = function(i)
		    local item = dbUIPanel:panelWithSize(CCSize(560, 90))
		    item:setAnchorPoint(CCPoint(0,0))

			local label = CCLabelTTF:labelWithString(level_reward_cfg[i].level,CCSize(50,0),0,SYSFONT[EQUIPMENT],24)
			label:setAnchorPoint(CCPoint(0, 1))
			label:setPosition(CCPoint(0,85))
			label:setColor(ccc3(255,235,149))
			item:addChild(label)
			
			local label = CCLabelTTF:labelWithString(level_reward_cfg[i].reward,CCSize(520,0),0,SYSFONT[EQUIPMENT],24)
			label:setAnchorPoint(CCPoint(0, 1))
			label:setPosition(CCPoint(70,85))
			label:setColor(ccc3(254,255,101))
			item:addChild(label)
					    
		    return item
		end

		local list = dbUIList:list(CCRectMake(60, 60, 600, 235),0)
		rightPanel:addChild(list)
		for i = 1, #level_reward_cfg do
			local item = createItem(i)
			list:insterWidget(item)
		end
		local y = list:getContentSize().height-list:get_m_content_size().height
		list:m_setPosition(CCPoint(0,y))	
		
		local label = CCLabelTTF:labelWithString("【奖品发放】:即时",CCSize(350,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,15))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
	end,

	---登陆大礼包
	showLoginGift = function(self)
		local level_reward_cfg = {
			{
				days = "登录1天",
				reward = "银币*10000，经验丹*4，金币*10"
			},
			{
				days = "连续登录2天",
				reward = "银币*100000，经验丹*10，一级宝石袋*1，金币*20"
			},
			{
				days = "连续登录3天",
				reward = "银币*40000，经验丹*6，金币*15"
			},
			{
				days = "连续登录4天",
				reward = "银币*70000，经验丹*8，金币*15"
			},	
			{
				days = "连续登录5天",
				reward = "银币*100000，经验丹*10，金币*20"
			},	
			{
				days = "连续登录6天",
				reward = "银币*150000，经验丹*10，一级宝石袋*1，金币*20"
			},	
			{
				days = "连续登录7天",
				reward = "银币*200000，经验丹*15，一级宝石袋*1，金币*30"
			},															
		}
		
		local rightPanel = self.rightPanel
		local sc_head = CCSprite:spriteWithFile("UI/gift_server_open/2.png")
		sc_head:setAnchorPoint(CCPoint(0.5,0))
		sc_head:setPosition(CCPoint(694/2, 430))
		rightPanel:addChild(sc_head)

		local label = CCLabelTTF:labelWithString("【活动日期】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,404))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("永久有效",CCSize(250,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(220,404))
		label:setColor(ccc3(254,0,0))
		rightPanel:addChild(label)
		
		local label = CCLabelTTF:labelWithString("【活动内容】:",CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,364))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString("首次登录游戏即可获得成长礼包，达到相应等级时打开即可获得丰厚奖励!",CCSize(635,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(33,350))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)

	    local createItem = function(i)
		    local item = dbUIPanel:panelWithSize(CCSize(500, 90))
		    item:setAnchorPoint(CCPoint(0,0))

			local label = CCLabelTTF:labelWithString(level_reward_cfg[i].days,CCSize(200,0),0,SYSFONT[EQUIPMENT],24)
			label:setAnchorPoint(CCPoint(0, 1))
			label:setPosition(CCPoint(0,85))
			label:setColor(ccc3(255,235,149))
			item:addChild(label)
			
			local label = CCLabelTTF:labelWithString(level_reward_cfg[i].reward,CCSize(500,0),0,SYSFONT[EQUIPMENT],24)
			label:setAnchorPoint(CCPoint(0, 1))
			label:setPosition(CCPoint(150,85))
			label:setColor(ccc3(254,255,101))
			item:addChild(label)
					    
		    return item
		end

		local list = dbUIList:list(CCRectMake(30, 60, 630, 235),0)
		rightPanel:addChild(list)
		for i = 1, #level_reward_cfg do
			local item = createItem(i)
			list:insterWidget(item)
		end
		local y = list:getContentSize().height-list:get_m_content_size().height
		list:m_setPosition(CCPoint(0,y))	
		
		local label = CCLabelTTF:labelWithString("【奖品发放】:即时",CCSize(350,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(33,15))
		label:setColor(ccc3(253,231,49))
		rightPanel:addChild(label)
	end,
					
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light_small.png")
		bg:setPosition(CCPoint(1010/2, 665/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		self.top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,588))
		self.centerWidget:addChild(self.top)

		--面板提示图标
		local head = CCSprite:spriteWithFile("UI/gift_server_open/head.png")
		head:setPosition(CCPoint(1010/2, 12))
		head:setAnchorPoint(CCPoint(0.5, 0))
		self.top:addChild(head)

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.top:addChild(closeBtn.btn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
		removeUnusedTextures()
	end,
}

SERVER_OPEN_GIFT_CFG = {
	{
		title = "首充感谢礼包",
		sub_title = "送绝版灵狐宠物",
		handle = "showFirstPay",
	},
	{
		title = "豪华新手礼包",
		sub_title = "送豪华奖励",
		handle = "showGreenhorn",
	},
	{
		title = "首充返利100%",
		sub_title = "充多少，返多少",
		handle = "showPayReturn",
	},
	{
		title = "天降幸运大礼包",
		sub_title = "幸运礼包等你拿",
		handle = "showLuckGift",
	},	
	{
		title = "冲击富豪榜",
		sub_title = "冲击富豪榜送大礼",
		handle = "showRich",
	},
	{
		title = "冲级大奖赏",
		sub_title = "冲级争夺豪华大奖",
		handle = "showLevelUp",
	},
	{
		title = "实力前三位",
		sub_title = "冲击竞技场前3获大奖",
		handle = "showArenaRank",
	},			
	{
		title = "成长礼包",
		sub_title = "礼包祝你快速成长",
		handle = "showGrowGift",
	},	
	{
		title = "登陆大礼包",
		sub_title = "领取每日登陆奖励",
		handle = "showLoginGift",
	},						
}
--显示背包界面
function GlobleCreateShopping()
	local shopPanelPanel = new(ShopPanel)
	shopPanelPanel:create()
end

ShopPanel = {
	pageCount = 1,
	page = 1, --当前页
	pagePanels = nil, -- {panel=singlePagePanel,items={},page=page,loaded=false}
	mainWidget = nil,
	showItems = {},
	curClass = 3, --当前分类
	zb = {}, --装备
	cl = {}, --材料
	xh = {}, --消耗
	
    create = function (self)
    	self:initBase()
    	self:initData()
		self:createMain(1)
    end,
    
	createMain = function(self,class)
--		if class==2 then
--			self.showItems = self.zb
--		elseif class==3 then
--			self.showItems = self.xh
--		else
--			self.showItems = self.cl
--		end
		
		local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
		local sort = function(aa,bb)
			local a = itemJsonConfig:getByKey(aa.cfg_item_id)
			local b = itemJsonConfig:getByKey(bb.cfg_item_id)
			local al = a:getByKey("require_level"):asInt()
			local bl = b:getByKey("require_level"):asInt()
			return al < bl
		end
		table.sort(self.showItems,sort)	
		
		local count = table.getn(self.showItems)
		self.pageCount = getPageCount(count,9)
		if self.page > self.pageCount then
			self.page = self.pageCount
		end
   		self:createPageScroll()
    	self:loadPage(self.page)
	end,
	
	initData = function(self)
		local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
		local sellJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_sell.json")
		self.zb = new({})
		self.xh = new({})
		self.cl = new({})
		self.showItems = new({})
		for s = 1 , sellJsonConfig:size() do
			local itemType = itemJsonConfig:getByKey(sellJsonConfig:getByKey(s):getByKey("cfg_item_id"):asInt()):getByKey("type"):asInt()
			local effect_type = itemJsonConfig:getByKey(sellJsonConfig:getByKey(s):getByKey("cfg_item_id"):asInt()):getByKey("effect_type"):asInt()
			if ( 2 == itemType) then	
				self.zb[table.getn(self.zb) + 1 ] = new  ({})
				self.zb[table.getn(self.zb)].record_id = sellJsonConfig:getByKey(s):getByKey("record_id"):asInt()
				self.zb[table.getn(self.zb)].cfg_item_id = sellJsonConfig:getByKey(s):getByKey("cfg_item_id"):asInt()
				self.zb[table.getn(self.zb)].price = sellJsonConfig:getByKey(s):getByKey("price"):asInt()
				self.zb[table.getn(self.zb)].money_type = sellJsonConfig:getByKey(s):getByKey("money_type"):asInt()
			end
			if ( 3 == itemType) then	
				self.xh[table.getn(self.xh) + 1 ] = new  ({})
				self.xh[table.getn(self.xh)].record_id = sellJsonConfig:getByKey(s):getByKey("record_id"):asInt()
				self.xh[table.getn(self.xh)].cfg_item_id = sellJsonConfig:getByKey(s):getByKey("cfg_item_id"):asInt()
				self.xh[table.getn(self.xh)].price = sellJsonConfig:getByKey(s):getByKey("price"):asInt()
				self.xh[table.getn(self.xh)].money_type = sellJsonConfig:getByKey(s):getByKey("money_type"):asInt()
			end
			if ( 4 == itemType) then
				self.cl[table.getn(self.cl) + 1 ] = new  ({})
				self.cl[table.getn(self.cl)].record_id = sellJsonConfig:getByKey(s):getByKey("record_id"):asInt()
				self.cl[table.getn(self.cl)].cfg_item_id = sellJsonConfig:getByKey(s):getByKey("cfg_item_id"):asInt()
				self.cl[table.getn(self.cl)].price = sellJsonConfig:getByKey(s):getByKey("price"):asInt()
				self.cl[table.getn(self.cl)].money_type = sellJsonConfig:getByKey(s):getByKey("money_type"):asInt()
			end
			self.showItems[table.getn(self.showItems) + 1 ] = new  ({})
			self.showItems[table.getn(self.showItems)].record_id = sellJsonConfig:getByKey(s):getByKey("record_id"):asInt()
			self.showItems[table.getn(self.showItems)].cfg_item_id = sellJsonConfig:getByKey(s):getByKey("cfg_item_id"):asInt()
			self.showItems[table.getn(self.showItems)].price = sellJsonConfig:getByKey(s):getByKey("price"):asInt()
			self.showItems[table.getn(self.showItems)].money_type = sellJsonConfig:getByKey(s):getByKey("money_type"):asInt()
		end
	end,
	
	--切换标签时刷新背包
	reflash = function(self,class)
		if class~= self.curClass then
			self.page = 1
		end
		if self.mainWidget then
			self.mainWidget:removeAllChildrenWithCleanup(true)
			self.pagePanels = {}
			self.pageCount = 1
			self.curClass = class
		end
		self:createMain(class)
	end,
	
	--创建滑动分页部分
	createPageScroll = function(self)
		local pagePanelContainer = dbUIPanel:panelWithSize(CCSize(956 * self.pageCount,470))
		pagePanelContainer:setAnchorPoint(CCPoint(0, 0))
		pagePanelContainer:setPosition(0,0)
		
		self.pagePanels = new({})
		for i=1,self.pageCount do
			local singlePage = dbUIPanel:panelWithSize(CCSize(956,470))
			singlePage:setAnchorPoint(CCPoint(0, 0))
	        singlePage:setPosition((i-1)*956,0)
			pagePanelContainer:addChild(singlePage)
	        self.pagePanels[i] = {panel=singlePage,items={},page=i,loaded=false}
		end
		
		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pagePanelContainer, 1, self.pageCount)
        self.scrollArea:setAnchorPoint(CCPoint(0, 0))
        self.scrollArea:setScrollRegion(CCRect(0, 0, 956, 470))
        self.scrollArea:setPosition(25,100)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.page = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
			self:loadPage(self.page)
		end
		self.mainWidget:addChild(self.scrollArea)
		self:createPageDot(self.pageCount)
		self.scrollArea:scrollToPage(self.page-1,false)
	end,
	
	--加载某一页的数据
	loadPage = function(self,page)
		local pagePanel = self.pagePanels[page]
		if pagePanel.loaded then
			return
		end
		local type = self.curClass
		--空的框框
		for row=1, 3 do
			for column=1,3 do
				local itemBg = createDarkBG(290,135)
		    	itemBg:setAnchorPoint(CCPoint(0, 0))
		    	itemBg:setPosition((column-1)*300 + 32, 332-(row-1)*165)
    			pagePanel.panel:addChild(itemBg)
				pagePanel.items[(row-1)*3+column] = itemBg
			end
		end
		local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
		local showItems = self.showItems
		local sum = table.getn(showItems)
		local start = (page-1)*9 + 1
		local ends = start-1+9>sum and sum or start+9-1
		for i = start,ends do
			local sellItem = showItems[i]
			local itemInfo = itemJsonConfig:getByKey(sellItem.cfg_item_id)
			local itemBg = pagePanel.items[i-(page-1)*9]
			local require_level = itemInfo:getByKey("require_level"):asInt()
			
			--物品按钮
			local itemBtn = new(ButtonScale)
			itemBtn:create("icon/Item/icon_item_"..itemInfo:getByKey("icon"):asInt()..".png",1.2)
			itemBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
			itemBtn.btn:setPosition(96/2, 96/2)
			itemBtn.btn:setScale(0.8 * 96/itemBtn.btn:getContentSize().width)
			itemBtn.btn.m_nScriptClickedHandler = function(ccp)
				self:openBuy(itemInfo,sellItem)
			end
			
			local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			icon:setPosition(0,0)
			icon:setAnchorPoint(CCPoint(0, 0))
			
			local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
			kuang:setAnchorPoint(CCPoint(0, 0))
			kuang:setPosition(15, 18)
			kuang:addChild(icon)
			kuang:addChild(itemBtn.btn)
			itemBg:addChild(kuang)

			--名称
			local label = CCLabelTTF:labelWithString(itemInfo:getByKey("name"):asString(),CCSize(500,0),0, SYSFONT[EQUIPMENT], 30)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setPosition(CCPoint(120,90))
			label:setColor(ccc3(153,204,1))
			itemBg:addChild(label)

			--价格
			local money_type = (sellItem.money_type==0 and "银币" or "金币")
			local label = CCLabelTTF:labelWithString(money_type..": "..sellItem.price,CCSize(300,0),0,SYSFONT[EQUIPMENT], 30)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setPosition(CCPoint(120,55))
			label:setColor(ccc3(255,152,3))
			itemBg:addChild(label)

			--等级
			local label = CCLabelTTF:labelWithString("等级："..require_level,CCSize(300,0),0,SYSFONT[EQUIPMENT], 30)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setPosition(CCPoint(120,20))
			label:setColor(ccc3(153,204,1))
			itemBg:addChild(label)			
		end
		pagePanel.loaded = true
	end,
	
	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 100))
		self.form:setPosition(1010/2, 0)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.mainWidget:addChild(self.form)
		self.pageToggles = {}
		for i=1, pageCount do
			local normalSpr = CCSprite:spriteWithFile("UI/public/page_btn_normal.png")
			local togglelSpr = CCSprite:spriteWithFile("UI/public/page_btn_toggle.png")		
			local pageToggle = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
			pageToggle:setPosition(CCPoint(52*(i-1),50) )
			pageToggle:setAnchorPoint(CCPoint(0,0))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
	end,
	
	--打开购买面板
	openBuy = function(self,itemInfo,sellInfo)
		local scene = DIRECTOR:getRunningScene()
 		local uiMask = dbUIMask:node()
 		local centerWidget = dbUIPanel:panelWithSize(CCSize(WINSIZE.width*isRetina, WINSIZE.height*isRetina))
	    centerWidget:setAnchorPoint(CCPoint(0.5, 0.5))
	    centerWidget:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
	    centerWidget:setScale(SCALEY)
  		centerWidget.m_nScriptClickedHandler = function()
			uiMask:removeFromParentAndCleanup(true)
			scene:removeChild(uiMask)
		end
    	uiMask:addChild(centerWidget)
		scene:addChild(uiMask, 2001)
		
		
		--以下是购买面板的详细内容
		local cfg_item_id = itemInfo:getByKey("cfg_item_id"):asInt()
		local name = itemInfo:getByKey("name"):asString()
		local icon = itemInfo:getByKey("icon"):asInt()
		local require_level = itemInfo:getByKey("require_level"):asInt()
		
		local ability = itemInfo:getByKey("ability"):asInt()
		local ability_type = itemInfo:getByKey("ability_type"):asInt()
		local ability_grow = itemInfo:getByKey("ability_grow"):asInt()
		
		local ability_2 = itemInfo:getByKey("ability_2"):asInt()
		local ability_type_2 = itemInfo:getByKey("ability_type_2"):asInt()
		local ability_grow_2 = itemInfo:getByKey("ability_grow_2"):asInt()
				
		--名称
		local nameLabel = CCLabelTTF:labelWithString(name,SYSFONT[EQUIPMENT], 36)
		nameLabel:setAnchorPoint(CCPoint(0.5,0))
		nameLabel:setColor(ccc3(103,51,1))
		
		--图标
		local icon = CCSprite:spriteWithFile("icon/Item/icon_item_"..icon..".png")
		icon:setAnchorPoint(CCPoint(0.5, 0.5))
		icon:setScale(0.8*96/icon:getContentSize().width)
		icon:setPosition(96/2, 96/2)
		local iconKuang = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
		iconKuang:setAnchorPoint(CCPoint(0, 0))
		iconKuang:addChild(icon)

		local money_type = (sellInfo.money_type==0 and "银币" or "金币")
		local moneyLabel = CCLabelTTF:labelWithString(money_type..": "..sellInfo.price,CCSize(300,0),0,SYSFONT[EQUIPMENT], 32)
		moneyLabel:setAnchorPoint(CCPoint(0, 0))
		moneyLabel:setColor(ccc3(103,51,1))
		
		local requireLevel = CCLabelTTF:labelWithString("等级要求："..require_level,CCSize(300,0),0,SYSFONT[EQUIPMENT], 32)
		requireLevel:setAnchorPoint(CCPoint(0, 0))
		requireLevel:setColor(ccc3(103,51,1))
		
		local count = 1
		local lineHeight = 30 --每行描述的间隔
				
		local labels = {}
		
		local item = {
			ability = ability,
			ability_type = ability_type,
			ability_grow = ability_grow,

			ability_2 = ability_2,
			ability_type_2 = ability_type_2,
			ability_grow_2 = ability_grow_2,
		}
		
		local attrs,tags,grows = public_returnEquipAttributeDesc(item)
		for i = 1, #attrs do
			local label = CCLabelTTF:labelWithString(tags[i]..": "..attrs[i],CCSize(300,0),0,SYSFONT[EQUIPMENT], 32)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setColor(ccc3(103,51,1))
			labels[count] = label
			count = count + 1
		end
		
		count = count - 1
		
		local dyHeight = table.getn(labels) * 40
		local height = 240 + dyHeight --对话框高度需要计算
		
		local buyPanel = createBG("UI/public/dialog_kuang.png",730,height)
		buyPanel:setAnchorPoint(CCPoint(0.5, 0.5))
		buyPanel:setPosition(CCPoint(WINSIZE.width / 2*isRetina, WINSIZE.height / 2*isRetina))
		centerWidget:addChild(buyPanel)

		for i=1,count do
			labels[i]:setPosition(CCPoint(50,40+(count-i)*40))
			buyPanel:addChild(labels[i])
		end

		nameLabel:setPosition(CCPoint(730/2,  170+dyHeight))
		iconKuang:setPosition(CCPoint(50,     60+dyHeight))
		moneyLabel:setPosition(CCPoint(160,   110 + dyHeight))
		requireLevel:setPosition(CCPoint(160, 60+dyHeight))

		buyPanel:addChild(nameLabel)
		buyPanel:addChild(iconKuang)
		buyPanel:addChild(moneyLabel)
		buyPanel:addChild(requireLevel)

		--右边部分
		--购买数量
		local title_bg = createBG("UI/shopping/title_bg.png",155,54,CCSize(20,26))
		title_bg:setPosition(CCPoint(435,100 + dyHeight))
		title_bg:setAnchorPoint(CCPoint(0,0))
		buyPanel:addChild(title_bg)
		self.buyAmount = 1

		local input = dbUIWidgetInput:inputWithText(1,SYSFONT[EQUIPMENT],30,false,3,CCRectMake(490,110 + dyHeight,100,35))
		input:setNeedFocus(true)
		buyPanel:addChild(input)
		
		local jian = dbUIButtonScale:buttonWithImage("UI/shopping/jian.png",1.1)
		jian:setAnchorPoint(CCPoint(0.5, 0.5))
		jian:setPosition(CCPoint(400,   128 + dyHeight))
		jian.m_nScriptClickedHandler = function()
			if self.buyAmount > 1 then
				if string.find(input:getString(),"%D") ~= nil or tonumber(input:getString()) == nil then
					alert("请输入数字")
					return
				end
				self.buyAmount = tonumber(input:getString())
				self.buyAmount = self.buyAmount-1
				input:setString(self.buyAmount)
			end
		end
		buyPanel:addChild(jian)
		
		local jia = dbUIButtonScale:buttonWithImage("UI/shopping/jia.png",1.1)
		jia:setAnchorPoint(CCPoint(0.5, 0.5))
		jia:setPosition(CCPoint(630,   128 + dyHeight))
		jia.m_nScriptClickedHandler = function()
			if string.find(input:getString(),"%D") ~= nil or tonumber(input:getString()) == nil then
				alert("请输入数字")
				return
			end
			self.buyAmount = tonumber(input:getString())
			self.buyAmount = self.buyAmount+1
			input:setString(self.buyAmount)
		end
		buyPanel:addChild(jia)		
		--购买按钮
		local buyBtn = dbUIButtonScale:buttonWithImage("UI/shopping/buy.png",1.1)
		buyBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		buyBtn:setPosition(CCPoint(510,   53 + dyHeight))
		buyBtn.m_nScriptClickedHandler = function(ccp)
				if string.find(input:getString(),"%D") ~= nil or tonumber(input:getString()) == nil then
					alert("请输入数字")
					return
				end
				self.buyAmount = tonumber(input:getString())
				local dialogCfg = new(basicDialogCfg)
				dialogCfg.msg = "是否花费"..sellInfo.price*self.buyAmount..money_type.."购买".. name
				dialogCfg.position = CCPoint(WINSIZE.width / 2, WINSIZE.height / 2)
				dialogCfg.dialogType = 5
				
				local callback = function()
					uiMask:removeFromParentAndCleanup(true)
					scene:removeChild(uiMask)
				end
				local ok = function(ccp,item)
					sellNet(self,cfg_item_id,self.buyAmount,callback)
				end
				
				local btns = {}
				local bs = new(ButtonScale)
				bs:create("UI/public/noTextBtn.png",1.2,ccc3(255,255,255),"购买")
				btns[1]=bs.btn
				local bs = new(ButtonScale)
				bs:create("UI/public/noTextBtn.png",1.2,ccc3(255,255,255),"取消")
				btns[2]=bs.btn
				btns[1].action = ok
				btns[2].action = nothing
				dialogCfg.btns = btns
				new(Dialog):create(dialogCfg)		
		end
		buyPanel:addChild(buyBtn)		

	end,
	
	--初始化界面，包括头部，背景
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

    	self.bgLayer = createPanelBg()
        self.uiLayer,self.centerWidget = createCenterWidget()
       
		self.mainWidget = createMainWidget()

        scene:addChild(self.bgLayer, 1000)
	    scene:addChild(self.uiLayer, 2000)

	    local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
	    bg:setPosition(CCPoint(1010/2, 702/2)) 
	    self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)
    
		local topbtn = new(ShopTopButton)
		topbtn:create()
		self.topBtns = topbtn.toggles		
		self.centerWidget:addChild(topbtn.bg,100)
		topbtn:toggle(2)
		self.top = topbtn
			
		--注册开关切换事件
		for i = 1 , table.getn(topbtn.toggles) do
			topbtn.toggles[i].m_nScriptClickedHandler = function()
				if (topbtn.toggles[i]:isToggled()) then
					if i == 1 then
						self:reflash(3)
					end
					if i == 2 then
						self:reflash(4)
					end
				end
				topbtn:toggle(i)
			end
		end
		
		--关闭按钮
		topbtn.closeBtn.m_nScriptClickedHandler = function()		
			self:destroy()
		end
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
        self.bgLayer = nil
        self.uiLayer = nil
        self.topBtns = nil
        self.centerWidget = nil
        self.mainWidget = nil
        removeUnusedTextures()
    end
}

ShopTopButton = {
	bg = nil,
	toggles = {},
	closeBtn = nil,
	backBtn = nil,
	
	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(0,598))
		for i = 1 , table.getn(ShopTopBtnConfig) do		
			local btn = dbUIButtonToggle:buttonWithImage(ShopTopBtnConfig[i].normal,ShopTopBtnConfig[i].toggle)
			btn:setAnchorPoint(CCPoint(0, 0))
			btn:setPosition(ShopTopBtnConfig[i].position)
			btn:setIsVisible(false)
			self.toggles[i] = btn
			self.bg:addChild(btn)
		end

		local label = CCLabelTTF:labelWithString("金币："..public_chageShowTypeForMoney(GloblePlayerData.gold,true),CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(620,45))
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setColor(ccc3(254,205,52))
		self.bg:addChild(label)
		self.goldLabel = label
		
		--充值按钮
		local payBtn = new(ButtonScale)
		payBtn:create("UI/shopping/pay.png",1.2,ccc3(255,255,255))			
		payBtn.btn:setPosition(CCPoint(800, 44))
		payBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		payBtn.btn.m_nScriptClickedHandler = function()		
			globleShowVipPanel()
		end
		self.bg:addChild(payBtn.btn)
		self.payBtn = payBtn.btn

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))			
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		self.bg:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
	end,
	
	--切换
	toggle = function(self,topid)
		public_toggleRadioBtn(self.toggles,self.toggles[topid])
	end
}

ShopTopBtnConfig = {
	{
		normal = "UI/baoguoPanel/xh_1.png",
		toggle = "UI/baoguoPanel/xh_2.png",
		position = 	CCPoint(20 + 12, 12),
	},
	{
		normal = "UI/baoguoPanel/cl_1.png",
		toggle = "UI/baoguoPanel/cl_2.png",
		position = 	CCPoint(20 + 142, 12),
	}
}

sellNet = function(panel,cfg_id,amount,callback)
	local cfg_item_id = 0
	local sellNetCB = function (json)
		closeWait()
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			if error_code == 2001 then
				alert("背包已满，无法继续购买。")
			else
				ShowErrorInfoDialog(error_code)
			end
		else
			local itemID = json:getByKey("add_item_id_list"):getByIndex(0):asInt()
			local item = {cfg_id,itemID,amount}
			battleGetItems(item,true)
			
			local dialogCfg = new(basicDialogCfg)
			dialogCfg.msg = "物品已经购买"
			dialogCfg.dialogType = 5
			new(Dialog):create(dialogCfg)
			
			GloblePlayerData.gold = json:getByKey("gold"):asInt()
			GloblePlayerData.copper = json:getByKey("copper"):asInt()
			updataHUDData()
			panel.top.goldLabel:setString("金币："..public_chageShowTypeForMoney(GloblePlayerData.gold,true))
			RefreshItem();
			if callback then
				callback()
			end
		end
	end
	local sendRequest = function ()
		local action = Net.OPT_Buy
		showWaitDialogNoCircle("waiting OPT_Buy!")
		NetMgr:registOpLuaFinishedCB(action,sellNetCB)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("gem_id", cfg_id)
		cj:setByKey("amount", amount)
		NetMgr:executeOperate(action, cj)
	end 
	sendRequest()
end
function globleShowVipPanel()
	local vipPanel = new(VipPanel)
	vipPanel:create()
end

local VIP_BAR_CFG = {
	res = {border = "UI/bar/bar_bg.png",entity = "UI/bar/bar_green.png",},
	borderSize = {width = 420,height = 32},
	entitySize = {width = 420,height = 28},
	fontSize = 30,
	position = CCPoint(290, 535),
	borderCornerSize = CCSize(13,16),
	entityCornerSize = CCSize(13,14)
}

VipPanel={
	bgLayer = nil,		--背景层
	uiLayer = nil,		--mask
	closebtn=nil,
	centerWidget = nil,
	toggles={},
	create = function(self)
		self:initBase()
		self:createTop()

		self:createLeft()
		self:createDesc()
	end,
	
	createTop = function(self)
		local cur_vip_level = CCSprite:spriteWithFile("UI/vip_panel/cur_vip_level.png")
		cur_vip_level:setAnchorPoint(CCPoint(0,0))
		cur_vip_level:setPosition(CCPoint(43, 518+18))
		self.mainWidget:addChild(cur_vip_level)
		
		local lavel = CCLabelTTF:labelWithString("VIP"..GloblePlayerData.vip_level,CCSize(300,0),0,SYSFONT[EQUIPMENT],37)
		lavel:setAnchorPoint(CCPoint(0,0))
		lavel:setPosition(CCPoint(43+cur_vip_level:getContentSize().width+10,516+18))
		lavel:setColor(ccc3(103,51,53))
		self.mainWidget:addChild(lavel)
		
		--VIP经验条
		local vip = GloblePlayerData.vip_level
		local nextVip = vip+1
		if nextVip>10 then
			nextVip = 10
		end
		local max = cfg_vip_data[nextVip+1].total_charge
		local now = GloblePlayerData.vip_charge
		local bar = new(Bar2)
		bar:create(max, VIP_BAR_CFG)
		bar:setExtent(now)
		self.mainWidget:addChild(bar.barbg)

		local btn = dbUIButtonScale:buttonWithImage("UI/playerInfos/cz.png", 1, ccc3(125, 125, 125))		
		btn:setAnchorPoint(CCPoint(0,0))
		btn:setPosition(CCPoint(730,505+15))
		btn.m_nScriptClickedHandler = function(ccp)
			if ClientData.sdk=="umi" then
				dbHUDLayer:shareHUD2Lua():gotoPay(0)
			elseif ClientData.sdk=="91" then
				GlobalCreatePayPanel()
				self:destroy()
			elseif ClientData.sdk=="joy7" then
				GlobalCreatePayPanel()
				self:destroy()
			else
				GlobalCreatePayPanel()
				self:destroy()
			end
		end
		self.mainWidget:addChild(btn)
			
		local lavel = CCLabelTTF:labelWithString("再充"..(max-now).."金币，你将成为VIP"..(nextVip),CCSize(500,0),0,SYSFONT[EQUIPMENT],26)
		lavel:setAnchorPoint(CCPoint(0,0))
		lavel:setPosition(CCPoint(310,500))
		lavel:setColor(ccc3(102,50,0))
		if vip<10 then 
		self.mainWidget:addChild(lavel)
		end
	end,
	
	createLeft = function(self)
		local myBG = createBG("UI/public/recuit_dark.png",290,450)
		myBG:setAnchorPoint(CCPoint(0,0))
		myBG:setPosition(CCPoint(45,38))
		self.mainWidget:addChild(myBG)
				
		local btnList = dbUIList:list(CCRectMake(5,5,280,440),0)
		myBG:addChild(btnList)
		
		local createBtn = function(i)
			local btnPanel = dbUIPanel:panelWithSize(CCSize(290, 100))
			local btn = dbUIButtonToggle:buttonWithImage("UI/public/big_btn_bg.png","UI/public/big_btn_bg_toggle.png")
			btn:setAnchorPoint(CCPoint(0.5, 0.5))
			btn:setPosition(CCPoint(290/2,100/2))
			self.toggles[i] = btn
			btnPanel:addChild(btn)
			
			local vip_level_prefix = CCSprite:spriteWithFile("UI/vip_panel/vip_level_prefix.png")
			vip_level_prefix:setPosition(CCPoint(100, 83/2))
			btn:addChild(vip_level_prefix)		
				
			local vip_level_num = CCSprite:spriteWithFile("UI/vip_panel/vip_level_"..i..".png")
			vip_level_num:setPosition(CCPoint(140, 83/2))
			btn:addChild(vip_level_num)		
			return btnPanel
		end
		
		for i = 1, 10 do
			local btn = createBtn(i)
			btnList:insterWidget(btn)
		end
		--注册切换事件
		for i = 1, 10 do
			self.toggles[i].m_nScriptClickedHandler = function()
				public_toggleRadioBtn(self.toggles,self.toggles[i])
				self:updateContent(i)
			end
		end
		
		btnList:m_setPosition(CCPoint(0,-btnList:get_m_content_size().height + btnList:getContentSize().height ))
	end,
	
	--创建VIP特权描述
	createDesc=function(self)
		local myBG = createBG("UI/public/recuit_dark.png",615,450)
		myBG:setAnchorPoint(CCPoint(0,0))
		myBG:setPosition(CCPoint(350,38))
		self.mainWidget:addChild(myBG)

		local label = CCLabelTTF:labelWithString("您开通VIP后，可获得以下特权",CCSize(800, 0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT],27)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(10,390))
		label:setColor(ccc3(254,153,0))
		myBG:addChild(label)
		self.viplabel=label
		local nextVip = GloblePlayerData.vip_level
		if nextVip>9 then
			nextVip = 9
		end
				
		local desc = cfg_vip_data[nextVip+2].desc
		local desc = CCLabelTTF:labelWithString(desc,CCSize(615, 0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT],23)
		desc:setAnchorPoint(CCPoint(0,1))
		desc:setPosition(CCPoint(20,370))
		desc:setColor(ccc3(254,204,153))
		myBG:addChild(desc)
		self.descLabel = desc
	end,

	updateContent=function(self,vip_level)
		if vip_level > 10 then
			vip_level = 10
		end
		local desc = cfg_vip_data[vip_level+1].desc
		local total_charge = cfg_vip_data[vip_level+1].total_charge
		self.descLabel:setString(desc)
		self.viplabel:setString("开通VIP "..vip_level .."级 ("..total_charge.."金币)".."，享有如下特权")
	end,
	
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1002)
		scene:addChild(self.uiLayer, 2002)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light_small.png")
		bg:setPosition(CCPoint(1010/2, 665/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		self.top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,588))
		self.centerWidget:addChild(self.top)

		--面板提示图标
		local head = CCSprite:spriteWithFile("UI/vip_panel/vip_title.png")
		head:setPosition(CCPoint(1010/2, 12))
		head:setAnchorPoint(CCPoint(0.5, 0))
		self.top:addChild(head)

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 35))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.top:addChild(closeBtn.btn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer,true)
		scene:removeChild(self.uiLayer,true)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		removeUnusedTextures()
	end,
}
		
--支付界面
GlobalCreatePayPanel = function()
	GlobalPayPanel = new(PayPanel)
	GlobalPayPanel:create()
end

PayPanel = {
	create = function(self)
		self:initBase()
		self:createMain()
	end,

	--创建左面板
	createMain = function(self)
		local createPayBtn = function(amount,x)
			local pay_btn = dbUIButtonScale:buttonWithImage("UI/pay/pay_"..amount..".png", 1, ccc3(125, 125, 125))
			pay_btn:setAnchorPoint(CCPoint(0.5,0.5))
			pay_btn:setPosition(CCPoint(x,263))
			pay_btn.m_nScriptClickedHandler = function(ccp)
				dbHUDLayer:shareHUD2Lua():gotoPay(amount)
			end
			self.centerWidget:addChild(pay_btn)		
		end
		
		createPayBtn(100,168)
		createPayBtn(1000,168+270)
		createPayBtn(5000,168+270*2)
		
		local inputPanel = dbUIPanel:panelWithSize(CCSize(797, 53))
	    inputPanel:setAnchorPoint(CCPoint(0.5, 0.5))
	 	inputPanel:setPosition(CCPoint(891/2, 148))
	 	self.centerWidget:addChild(inputPanel)
		local pay_input_bg = CCSprite:spriteWithFile("UI/pay/pay_input_bg.png")
		pay_input_bg:setPosition(CCPoint(797/2, 53/2))
		inputPanel:addChild(pay_input_bg)

		local defaultText = "输入金币数(10金币=1RMB)"
		if tovip5~=nil then
		  defaultText=tovip5
		  tovip5=nil
		  end
		local input = dbUIWidgetInput:inputWithText(defaultText,SYSFONT[EQUIPMENT],30,false,10,CCRectMake(10,10,790,50))
		input:setNeedFocus(true)
		input:setColor(ccc3(0,0,0))
		input.m_nScriptClickedHandler = function(ccp)
			local text = input:getString()
			if text == defaultText then
				input:setString("")
			end
		end
		inputPanel:addChild(input)
				
		local btn_ok = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
		btn_ok:setAnchorPoint(CCPoint(0.5,0.5))
		btn_ok:setPosition(CCPoint(891/2,40))
		btn_ok.m_nScriptClickedHandler = function(ccp)
			if string.find(input:getString(),"%D") ~= nil or tonumber(input:getString()) == nil then
				alert("请输入数字")
				return
			end
			local amount = tonumber(input:getString())
			dbHUDLayer:shareHUD2Lua():gotoPay(amount)
		end
		self.centerWidget:addChild(btn_ok)				
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

	    self.centerWidget = dbUIPanel:panelWithSize(CCSize(891, 490))
	    self.centerWidget:setAnchorPoint(CCPoint(0.5, 0.5))
	    self.centerWidget:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
	    self.centerWidget:setScale(SCALE)
		
		self.uiLayer = dbUIMask:node()
		self.uiLayer:addChild(self.centerWidget)
		scene:addChild(self.uiLayer, 20000)

		local bg = CCSprite:spriteWithFile("UI/pay/pay_bg.png")
		bg:setPosition(CCPoint(891/2, 490/2))
		self.centerWidget:addChild(bg)

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(870, 410))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.centerWidget:addChild(closeBtn.btn)
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.uiLayer)
		self.uiLayer = nil
		self.centerWidget = nil
		removeUnusedTextures()
	end,	
}
local Instance = nil
local HADES_SHOW_CONFIRM = true
local data = new({})

local initData = function(json)
	data.copper = json:getByKey("copper"):asInt()
	data.gold = json:getByKey("gold"):asInt()
	
	data.gain_copper = json:getByKey("gain_copper"):asInt()
	data.hades_count = json:getByKey("hades_count"):asInt()
end

---type 1 捐献，2，批量捐献
local contribute = function(type,copper)
	local callBack = function (json)
		local error_code = json:getByKey("error_code"):asInt()

		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			GotoNextStepGuide()
		
			GloblePlayerData.gold = json:getByKey("gold"):asInt()
			GloblePlayerData.copper = json:getByKey("copper"):asInt()
			updataHUDData()
			
			alert("捐献成功，获得银币："..copper)
			initData(json)
			if Instance and Instance.mainWidget then
				Instance:createMain()
			end
			
			GlobleContributeSuccess = true
		end
	end

	local sendRequest = function ()
		local action = Net.OPT_HadesContribute
		NetMgr:registOpLuaFinishedCB(action,callBack)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("type",type)
		
		NetMgr:setOpUnique(action)
		NetMgr:executeOperate(action, cj)
	end
	sendRequest()
end

local calculate = function()
	local count = data.hades_count
	local vipLevel = GloblePlayerData.vip_level
	
	local costGold = (count) * 2
	local gainCopper = data.gain_copper

	local all = (vipLevel + 1) * 10
	local left = all - count

	local normalLeft = 10 - count
	normalLeft = normalLeft < 0 and 0 or normalLeft
	
	local vipLeft = 0
	if all > 10 then
		if data.hades_count <= 10 then
			vipLeft = all - 10
		else
			vipLeft = all - count
		end
	end
	
	if count >= all then
		costGold = 0
		gainCopper = 0
		normalLeft = 0
		vipLeft = 0
	end
	
	return new({
		costGold = costGold,
		gainCopper = gainCopper,
		normalLeft = normalLeft,
		vipLeft = vipLeft,
	})
end

local calculateBatch = function()
	local count = data.hades_count
	local vipLevel = GloblePlayerData.vip_level
	local gainCopper = data.gain_copper
	
	local all = (vipLevel + 1) * 10
	local left = all - count
	if left > 10 then left = 10 end
	
	local sumGold = 0;

	local start = count + 1
	local ends = count + 10
	if ends > all then ends = all end
	
	for i = start,ends do
		sumGold = sumGold + i*2
	end
	
	return sumGold,left,gainCopper*(ends-start+1)
end

local showConfirm = function()
	local scene = DIRECTOR:getRunningScene()

	local uiLayer,centerWidget = createCenterWidget()
	scene:addChild(uiLayer, 2000)

	centerWidget.m_nScriptClickedHandler = function(ccp)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(uiLayer)
	end

	local dialogPanel = createBG("UI/public/dialog_kuang.png",560,310,CCSize(70,70))
	dialogPanel:setAnchorPoint(CCPoint(0.5, 0.5))
	dialogPanel:setPosition(CCPoint(1010/2,702/2))
	centerWidget:addChild(dialogPanel)

	local kuang = createBG("UI/public/recuit_dark2.png",510,190,CCSize(40,40))
	kuang:setAnchorPoint(CCPoint(0.5, 0))
	kuang:setPosition(CCPoint(560/2, 80))
	dialogPanel:addChild(kuang)

	local costGold,left,copper = calculateBatch()
	
	local label = CCLabelTTF:labelWithString("消耗"..costGold.."金币捐献"..left.."次，可获得"..copper.."银币",CCSize(700,0),0, SYSFONT[EQUIPMENT], 26)
	label:setAnchorPoint(CCPoint(0,0))
	label:setPosition(CCPoint(15,135))
	label:setColor(ccc3(254,203,156))
	kuang:addChild(label)

	local toggle = dbUIButtonToggle:buttonWithImage("UI/shen_yu/yong_bing/toggle_no.png","UI/shen_yu/yong_bing/toggle_on.png")
	toggle:setAnchorPoint(CCPoint(0,0))
	toggle:setPosition(CCPoint(25, 42))
	toggle.m_nScriptClickedHandler = function()
		HADES_SHOW_CONFIRM = not toggle:isToggled()
	end
	kuang:addChild(toggle)
	local label = CCLabelTTF:labelWithString("不再提示",CCSize(200,0),0, SYSFONT[EQUIPMENT], 28)
	label:setAnchorPoint(CCPoint(0,0))
	label:setPosition(CCPoint(100,60))
	label:setColor(ccc3(189,132,51))
	kuang:addChild(label)
	
	local btn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1.2, ccc3(125, 125, 125))
	btn:setAnchorPoint(CCPoint(0.5,0.5))
	btn:setPosition(CCPoint(190,50))
	btn.m_nScriptClickedHandler = function()
		contribute(2,copper)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(uiLayer)
	end
	dialogPanel:addChild(btn)

	local btn = dbUIButtonScale:buttonWithImage("UI/public/close_btn.png",1.2, ccc3(125, 125, 125))
	btn:setAnchorPoint(CCPoint(0.5,0.5))
	btn:setPosition(CCPoint(380,50))
	btn.m_nScriptClickedHandler = function()
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(uiLayer)
	end
	dialogPanel:addChild(btn)
end

local HadesPanel = {

    create = function (self)
    	self:initBase()
  	 
  	   	self:createMain()
    end,
	
	createMain = function(self)
		self.mainWidget:removeAllChildrenWithCleanup(true)
		
		local label = CCLabelTTF:labelWithString("金币:"..GloblePlayerData.gold,CCSize(200,0),CCTextAlignmentRight,SYSFONT[EQUIPMENT],22)
		label:setAnchorPoint(CCPoint(1,0))
		label:setPosition(CCPoint(1010-50,550))
		label:setColor(ccc3(254,205,102))
		self.mainWidget:addChild(label)
		
		local label = CCLabelTTF:labelWithString("银币:"..GloblePlayerData.copper,CCSize(200,0),CCTextAlignmentRight,SYSFONT[EQUIPMENT],22)
		label:setAnchorPoint(CCPoint(1,0))
		label:setPosition(CCPoint(1010-50,520))
		label:setColor(ccc3(254,205,102))
		self.mainWidget:addChild(label)

		local temp = calculate()
	
  	    local label = CCLabelTTF:labelWithString("消耗"..temp.costGold.."金币捐献1次，可获得"..temp.gainCopper.."银币",SYSFONT[EQUIPMENT],26)
		label:setPosition(CCPoint(1010/2,170))
		label:setColor(ccc3(254,205,102))
		self.mainWidget:addChild(label)
		
		local text = "今日可捐献次数："..temp.normalLeft
		if temp.vipLeft > 0 then
			text = text.."+"..temp.vipLeft.."（VIP"..GloblePlayerData.vip_level.."）"
		end
		
  	    local label = CCLabelTTF:labelWithString(text,SYSFONT[EQUIPMENT],26)
		label:setPosition(CCPoint(1010/2,140))
		label:setColor(ccc3(254,205,102))
		self.mainWidget:addChild(label)

  	    local btn = dbUIButtonScale:buttonWithImage("UI/hades/contribute.png", 1.2, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(374,85))
		btn.m_nScriptClickedHandler = function()
			contribute(1,data.gain_copper)
		end
		self.mainWidget:addChild(btn)
		self.contributeBtn = btn
		
  	    local btn = dbUIButtonScale:buttonWithImage("UI/hades/contribute_batch.png", 1.2, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(636,85))
		btn.m_nScriptClickedHandler = function()
			if GloblePlayerData.vip_level > 0 then
				if HADES_SHOW_CONFIRM then
					showConfirm()
				else
					local costGold,left,copper = calculateBatch()
					contribute(2,copper)
				end
			else
				alert("VIP才可以使用该功能")
			end
		end
		self.mainWidget:addChild(btn)
	end,
	
	--初始化界面，包括头部，背景
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

    	self.bgLayer = createPanelBg()
        self.uiLayer,self.centerWidget = createCenterWidget()
       
		self.mainWidget = createMainWidget()

        scene:addChild(self.bgLayer, 1000)
	    scene:addChild(self.uiLayer, 2000)

	    local bg = CCSprite:spriteWithFile("UI/public/bg.png")
	    bg:setPosition(CCPoint(1010/2, 702/2)) 
	    self.centerWidget:addChild(bg)
	    
	    local bg = CCSprite:spriteWithFile("UI/hades/hades_bg.jpg")
	    bg:setPosition(CCPoint(1010/2, 702/2 - 35)) 
	    self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)
		
		local nice = CCSprite:spriteWithFile("UI/hades/hades_head.png")			
		nice:setPosition(CCPoint(1010/2, 702-90)) 
		nice:setAnchorPoint(CCPoint(0.5, 0))
		self.centerWidget:addChild(nice)

		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))			
		closeBtn.btn:setPosition(CCPoint(952, 650))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()		
			self:destroy()
			GotoNextStepGuide()
		end
		self.closeBtn = closeBtn.btn
		self.centerWidget:addChild(closeBtn.btn)
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
        self.bgLayer = nil
        self.uiLayer = nil
        self.centerWidget = nil
        self.mainWidget = nil
        GlobleHadesPanel = nil
        GlobleContributeSuccess = nil
        removeUnusedTextures()
    end,
}

function GlobleCreateHades()
	local callBack = function (json)
		initData(json)
		
		Instance = new (HadesPanel)
		Instance:create()
		GlobleHadesPanel = Instance
		GotoNextStepGuide()
	end

	local action = Net.OPT_Hades
	NetMgr:registOpLuaFinishedCB(action,callBack)
	NetMgr:registOpLuaFailedCB(action,opFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	NetMgr:setOpUnique(action)
	NetMgr:executeOperate(action, cj)
end
--宠物继承
local Instance = nil
function globalShowGeneralExtend()
	Instance = new(GeneralExtendPanel):create()
end

local sumExp = function(general)
	local cfg_level_experience = openJson("cfg/cfg_level_experience.json")
	local level = general.level
	local sum = general.experience
	for i=1,level-1 do
		local need = cfg_level_experience:getByKey(""..i):asInt()
		sum = sum + need
	end
	return sum
end

local calculateLevel = function(main,senc)
	local mainExp = sumExp(main)
	local sencExp = sumExp(senc)
	local full = Instance.toggle_on
	
	local cfg_level_experience = openJson("cfg/cfg_level_experience.json")
	local addExp = full and sencExp * 0.8 or mainExp >= sencExp / 2 and 0 or sencExp / 2 - mainExp
	local addLevel = 0
	
	for i = main.level, 200 do
		local need = cfg_level_experience:getByKey(""..i):asInt()
		if need == 0 then
			break
		end
		addExp = addExp - need
		if addExp <= 0 then
			break
		end
		addLevel = addLevel + 1
	end
	return addLevel + main.level
end

local extendRequest = function(main_general_id,senc_general_id,isFull)
	local function opFinishCB(s)
		closeWait()
		local errorCode = s:getByKey("error_code"):asInt()
		if errorCode ~= -1 then
			if errorCode == 2001 then
				alert("背包空间不足，无法存放副宠装备，请整理背包后重试。")	
			else
				ShowErrorInfoDialog(errorCode)
			end
		else
			table.remove(GloblePlayerData.generals,senc)
			checkUpRoleIndex()
			mappedPlayerGeneralData(s)
			executeGenerals()
			RefreshItem()
			
	        GloblePlayerData.gold = s:getByKey("gold"):asInt()
			updataHUDData()

			if GlobleGeneralListPanel then
				GlobleGeneralListPanel:reflash()
			end
							
			Instance.rightGeneral = findGeneralByGeneralId(main_general_id)
			Instance.leftGeneral = nil
			Instance:reflash()
		end
	end

	showWaitDialogNoCircle("")
	NetMgr:registOpLuaFinishedCB(Net.OPT_GeneralExtend, opFinishCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_GeneralExtend, opFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code",ClientData.request_code)
	cj:setByKey("main_general",main_general_id)
	cj:setByKey("senc_general",senc_general_id)
	cj:setByKey("is_full",isFull)
	NetMgr:executeOperate(Net.OPT_GeneralExtend, cj)
end

GeneralExtendPanel = {
	toggle_on = false,
	
	create = function (self)
		self:initBase()
		self:createMain()
		return self
	end,
	
	createMain = function(self)
		local toggle = dbUIButtonToggle:buttonWithImage("UI/shen_yu/yong_bing/toggle_no.png","UI/shen_yu/yong_bing/toggle_on.png")
		toggle:setAnchorPoint(CCPoint(0,0))
		toggle:setPosition(CCPoint(80, 40))
		toggle.m_nScriptClickedHandler = function()
			self.toggle_on = not self.toggle_on
			self:reflash()
		end
		toggle:toggled(self.toggle_on)
		self.mainWidget:addChild(toggle)
		self.toggle = toggle
		
		local label = CCLabelTTF:labelWithString("花费?金币100%继承宠物属性",CCSize(550,0),0, SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(156,56))
		label:setColor(ccc3(255,204,102))
		self.mainWidget:addChild(label)
		self.costLabel = label
		
		local btn = dbUIButtonScale:buttonWithImage("UI/general_extend/do_extend_btn.png", 1, ccc3(125, 125, 125))		
		btn:setPosition(CCPoint(764, 44))
		btn:setAnchorPoint(CCPoint(0, 0))
		btn.m_nScriptClickedHandler = function()
			if self.rightGeneral == nil or self.leftGeneral == nil then
				alert("请选择要继承的宠物")
				return
			end
			if toggle:isToggled() then
				new(ConfirmDialog):show({
					text = "确定花费"..self.costGold.."金继承宠物吗？",
					width = 440,
					onClickOk = function()
						extendRequest(
							self.rightGeneral.general_id,
							self.leftGeneral.general_id,
							toggle:isToggled()
						)
					end
				})
			else
				extendRequest(self.rightGeneral.general_id, self.leftGeneral.general_id, toggle:isToggled())
			end
		end
		self.mainWidget:addChild(btn)
		
		self:createAttr()
		self:createSelect()		
	end,
	
	reflash = function(self)
		self.mainWidget:removeAllChildrenWithCleanup(true)
		self:createMain()
	end,
	
	---宠物选择
	createSelect = function(self)
		--创建下拉列表
		local createGeneralList = function(parent,itemClick)
			local list = dbUIList:list(CCRectMake(0,0,277,205),0)
			for i=1,#GloblePlayerData.generals do
				local general = GloblePlayerData.generals[i]
				
				if not general.is_role then
					local rowPanel = dbUIPanel:panelWithSize(CCSize(277,45))
					rowPanel.m_nScriptClickedHandler = function()
						itemClick(i)
					end
					
					local line = CCSprite:spriteWithFile("UI/general_extend/line_x.png")
					line:setScaleX(275/line:getContentSize().width)
					line:setPosition(CCPoint(0,0))
					line:setAnchorPoint(CCPoint(0,0))
					rowPanel:addChild(line)
					
					local label = CCLabelTTF:labelWithString(general.name,CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
					label:setColor(ccc3(255,254,154))
					label:setAnchorPoint(CCPoint(0,0))
					label:setPosition(CCPoint(31,8))
					rowPanel:addChild(label)
					local label = CCLabelTTF:labelWithString(general.level.."级",CCSize(150,0),0, SYSFONT[EQUIPMENT], 26)
					label:setColor(ccc3(255,254,154))
					label:setAnchorPoint(CCPoint(0,0))
					label:setPosition(CCPoint(190,8))
					rowPanel:addChild(label)
									
					list:insterWidget(rowPanel)
				end
			end
			
			parent:addChild(list)
			return list
		end
		
		local create = function(position,general,onListItemClick,isMain)
			local panel = dbUIPanel:panelWithSize(CCSize(277,262))
			panel:setAnchorPoint(CCPoint(0, 0))
			panel:setPosition(position)
			self.mainWidget:addChild(panel)
			
			local generalList = nil
			local onHeadClick = function()
				if generalList then
					generalList:removeFromParentAndCleanup(true)
					generalList = nil
				else
					generalList = createGeneralList(panel, onListItemClick)
				end
			end
			
			local btn = dbUIButtonScale:buttonWithImage("UI/general_extend/select_title_bg.png", 1, ccc3(125, 125, 125))
			btn:setPosition(CCPoint(0, 260))
			btn:setAnchorPoint(CCPoint(0, 1))
			btn.m_nScriptClickedHandler = onHeadClick
			panel:addChild(btn)
			
			local btn = dbUIButtonScale:buttonWithImage("UI/general_extend/down_btn.png", 1, ccc3(125, 125, 125))
			btn:setPosition(CCPoint(220, 211))
			btn:setAnchorPoint(CCPoint(0, 0))
			btn.m_nScriptClickedHandler = onHeadClick
			panel:addChild(btn)
			
			if general == nil then
				local spr = CCSprite:spriteWithFile("UI/general_extend/select_bg.png")
				spr:setPosition(CCPoint(0, 0))
				spr:setAnchorPoint(CCPoint(0, 0))
				panel:addChild(spr,-1)
				
				local spr = CCSprite:spriteWithFile(isMain and "UI/general_extend/main_general_label.png" or "UI/general_extend/senc_general_label.png")
				spr:setPosition(CCPoint(45, 217))
				spr:setAnchorPoint(CCPoint(0, 0))
				panel:addChild(spr)
			else
				local spr = CCSprite:spriteWithFile("UI/general_extend/general_stage.png")
				spr:setPosition(CCPoint(0, 0))
				spr:setAnchorPoint(CCPoint(0, 0))
				panel:addChild(spr, -1)
			
				local title = CCLabelTTF:labelWithString(general.name.." "..general.level.."级",CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
				title:setColor(ccc3(255,254,154))
				title:setAnchorPoint(CCPoint(0,0))
				title:setPosition(CCPoint(31,224))
				panel:addChild(title)
				local spr = CCSprite:spriteWithFile("UI/general_extend/general_bg.png")
				spr:setPosition(CCPoint(277/2, 35))
				spr:setAnchorPoint(CCPoint(0.5, 0))
				panel:addChild(spr)	
				local spr = CCSprite:spriteWithFile("UI/general_extend/general_bg2.png")
				spr:setPosition(CCPoint(277/2, 35))
				spr:setAnchorPoint(CCPoint(0.5, 0))
				panel:addChild(spr)	
								
				local figure = CCSprite:spriteWithFile("head/Big/head_big_"..general.figure..".png")
				figure:setAnchorPoint(CCPoint(0.5,0))
				figure:setScale(150/figure:getContentSize().width)
				figure:setPosition(277/2,50)
				panel:addChild(figure)
			end
			return panel
		end
		
		--创建左侧部分
		local onListItemClick = function(i)
			if self.rightGeneral and GloblePlayerData.generals[i].level <= self.rightGeneral.level then
				alert("主宠的等级必须小于副宠的等级")
				return
			end
			if self.rightGeneral and GloblePlayerData.generals[i].name == self.rightGeneral.name then
				alert("不能选一样的宠物")
			else
				self.leftGeneral = GloblePlayerData.generals[i]
				self:reflash()
			end
		end
		create(CCPoint(50,313),self.leftGeneral,onListItemClick,false)
	
		--创建右侧部分
		local onListItemClick = function(i)
			if self.leftGeneral and GloblePlayerData.generals[i].level >= self.leftGeneral.level then
				alert("主宠的等级必须小于副宠的等级")
				return
			end
			
			if self.leftGeneral and GloblePlayerData.generals[i].name == self.leftGeneral.name then
				alert("不能选一样的宠物")
			else
				self.rightGeneral = GloblePlayerData.generals[i]
				self:reflash()
			end
		end
		local rightPanel = create(CCPoint(680,313),self.rightGeneral,onListItemClick,true)
		
		if self.leftGeneral and self.rightGeneral then
			local mainGeneral = self.rightGeneral
			local sencGeneral = self.leftGeneral
			local max = GloblePlayerData.officium * 3 + 20
			local isFull = self.toggle:isToggled()
			
			local label = CCLabelTTF:labelWithString(mainGeneral.level.."级",CCSize(150,0),0, SYSFONT[EQUIPMENT], 22)
			label:setColor(ccc3(254,103,0))
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(80,5))
			rightPanel:addChild(label)			

			local up_level = CCSprite:spriteWithFile("UI/general_extend/up_level.png")
			up_level:setPosition(CCPoint(277/2, 5))
			up_level:setAnchorPoint(CCPoint(0.5,0))
			rightPanel:addChild(up_level)

			local toLevel = calculateLevel(mainGeneral,sencGeneral)
			local label = CCLabelTTF:labelWithString(toLevel.."级",CCSize(150,0),0, SYSFONT[EQUIPMENT], 22)
			label:setColor(ccc3(255,254,154))
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(165,5))
			rightPanel:addChild(label)
		end		
	end,
	
	createAttr = function(self)
		local createLine = function(panel,position,wh,image,d)
			local line = CCSprite:spriteWithFile(image)
			if d == 1 then
				line:setScaleX(wh/line:getContentSize().width)
			else
				line:setScaleY(wh/line:getContentSize().height)
			end
			line:setPosition(position)
			line:setAnchorPoint(CCPoint(0, 0))
			panel:addChild(line)		
		end
		
		local create = function(position,general)
			local panel = createBG("UI/public/kuang_126.png",442,200)
			panel:setPosition(position)
			panel:setAnchorPoint(CCPoint(0, 0))
			self.mainWidget:addChild(panel)

			createLine(panel,CCPoint(3,38),440,"UI/general_extend/line_x.png",1)
			createLine(panel,CCPoint(3,80),440,"UI/general_extend/line_x.png",1)
			createLine(panel,CCPoint(3,119),440,"UI/general_extend/line_x.png",1)
			createLine(panel,CCPoint(3,159),440,"UI/general_extend/line_x.png",1)
			
			createLine(panel,CCPoint(83,3),195,"UI/general_extend/line_y.png",2)
			createLine(panel,CCPoint(247,3),195,"UI/general_extend/line_y.png",2)
			
			local spr = CCSprite:spriteWithFile("UI/general_extend/attr_label.png")
			spr:setPosition(CCPoint(25, 10))
			spr:setAnchorPoint(CCPoint(0, 0))
			panel:addChild(spr)
	
			local spr = CCSprite:spriteWithFile("UI/general_extend/base_attr.png")
			spr:setPosition(CCPoint(120, 167))
			spr:setAnchorPoint(CCPoint(0, 0))
			panel:addChild(spr)
			
			local spr = CCSprite:spriteWithFile("UI/general_extend/xi_sui_attr.png")
			spr:setPosition(CCPoint(300, 167))
			spr:setAnchorPoint(CCPoint(0, 0))
			panel:addChild(spr)
			
			if general then
				local createAttr = function(value,position)
					local label = CCLabelTTF:labelWithString(value,CCSize(150,0),0, SYSFONT[EQUIPMENT], 26)
					label:setColor(ccc3(254,103,0))
					label:setAnchorPoint(CCPoint(0,0))
					label:setPosition(position)
					panel:addChild(label)			
				end
				
				createAttr(general.strength,CCPoint(126,127))
				createAttr(general.intellect,CCPoint(126,87))
				createAttr(general.stamina,CCPoint(126,47))
				createAttr(general.agility,CCPoint(126,7))

				createAttr(general.str_grow,CCPoint(300,127))
				createAttr(general.int_grow,CCPoint(300,87))
				createAttr(general.sta_grow,CCPoint(300,47))
				createAttr(general.agi_grow,CCPoint(300,7))
			end
			
			return panel
		end
		
		create(CCPoint(50, 106),self.leftGeneral)
		local rightPanel = create(CCPoint(516, 106),self.rightGeneral)
		
		if self.leftGeneral and self.rightGeneral then
			local mainGeneral = self.rightGeneral
			local sencGeneral = self.leftGeneral
			local max = GloblePlayerData.officium * 3 + 20
			local isFull = self.toggle:isToggled()
			
			local createAddAttr = function(value,position)
				local label = CCLabelTTF:labelWithString("+"..value,CCSize(150,0),0, SYSFONT[EQUIPMENT], 26)
				label:setColor(ccc3(255,254,154))
				label:setAnchorPoint(CCPoint(0,0))
				label:setPosition(position)
				rightPanel:addChild(label)
			end

			local addStrGrow = isFull and sencGeneral.str_grow or (mainGeneral.str_grow >= sencGeneral.str_grow / 2 and 0 or math.ceil(sencGeneral.str_grow / 2 - mainGeneral.str_grow));
			addStrGrow = (addStrGrow + mainGeneral.str_grow > max and addStrGrow + mainGeneral.str_grow - max or addStrGrow)

			local addIntGrow = isFull and sencGeneral.int_grow or (mainGeneral.int_grow >= sencGeneral.int_grow / 2 and 0 or math.ceil(sencGeneral.int_grow / 2 - mainGeneral.int_grow));
			addIntGrow = (addIntGrow + mainGeneral.int_grow > max and addIntGrow + mainGeneral.int_grow - max or addIntGrow)

			local addStaGrow = isFull and sencGeneral.sta_grow or (mainGeneral.sta_grow >= sencGeneral.sta_grow / 2 and 0 or math.ceil(sencGeneral.sta_grow / 2 - mainGeneral.sta_grow));
			addStaGrow = (addStaGrow + mainGeneral.sta_grow > max and addStaGrow + mainGeneral.sta_grow - max or addStaGrow)
						
			local addAgiGrow = isFull and sencGeneral.agi_grow or (mainGeneral.agi_grow >= sencGeneral.agi_grow / 2 and 0 or math.ceil(sencGeneral.agi_grow / 2 - mainGeneral.agi_grow));
			addAgiGrow = (addAgiGrow + mainGeneral.agi_grow > max and addAgiGrow + mainGeneral.agi_grow - max or addAgiGrow)
																		
			createAddAttr(addStrGrow,CCPoint(360,127))
			createAddAttr(addIntGrow,CCPoint(360,87))
			createAddAttr(addStaGrow,CCPoint(360,47))
			createAddAttr(addAgiGrow,CCPoint(360,7))

			local addStrGrowAll = math.min(sencGeneral.str_grow + mainGeneral.str_grow,max) - mainGeneral.str_grow
			local addIntGrowAll = math.min(sencGeneral.int_grow + mainGeneral.int_grow,max) - mainGeneral.int_grow
			local addStaGrowAll = math.min(sencGeneral.sta_grow + mainGeneral.sta_grow,max) - mainGeneral.sta_grow
			local addAgiGrowAll = math.min(sencGeneral.agi_grow + mainGeneral.agi_grow,max) - mainGeneral.agi_grow
			
			local addAll = addStrGrowAll + addIntGrowAll + addStaGrowAll + addAgiGrowAll
			local gold = sencGeneral.level * 10 + math.floor((addAll / 4)) *3
			if gold < 0 then gold = 0 end
			self.costGold = gold
			self.costLabel:setString("花费"..gold.."金币100%继承宠物属性")

			local toLevel = calculateLevel(mainGeneral,sencGeneral)
			local addLevel = toLevel - mainGeneral.level
			
			local cfg_general_json = openJson("cfg/cfg_general.json")
			local cfg_general = cfg_general_json:getByKey(""..mainGeneral.cfg_general_id)
			
			local str_grow = cfg_general:getByKey("str_grow"):asDouble()
			local agi_grow = cfg_general:getByKey("agi_grow"):asDouble()
			local sta_grow = cfg_general:getByKey("sta_grow"):asDouble()
			local int_grow = cfg_general:getByKey("int_grow"):asDouble()
			
			local addStr = math.ceil(str_grow * addLevel)
			local addInt = math.ceil(int_grow * addLevel)
			local addSta = math.ceil(sta_grow * addLevel)
			local addAgi = math.ceil(agi_grow * addLevel)

			createAddAttr(addStr,CCPoint(190,127))
			createAddAttr(addInt,CCPoint(190,87))
			createAddAttr(addSta,CCPoint(190,47))
			createAddAttr(addAgi,CCPoint(190,7))
		end
	end,

	--初始化界面，包括头部，背景
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1004)
		scene:addChild(self.uiLayer, 2004)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		local bg = CCSprite:spriteWithFile("UI/general_extend/bg.jpg")
		bg:setPosition(CCPoint(1010/2, 35))
		bg:setAnchorPoint(CCPoint(0.5, 0))
		self.centerWidget:addChild(bg)

		local mid = CCSprite:spriteWithFile("UI/general_extend/mid.png")
		mid:setPosition(CCPoint(1010/2, 390))
		mid:setAnchorPoint(CCPoint(0.5, 0))
		self.centerWidget:addChild(mid)

		local top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
		
		--面板提示图标
		local nice = CCSprite:spriteWithFile("UI/general_extend/title.png")
		nice:setPosition(CCPoint(0, 10))
		nice:setAnchorPoint(CCPoint(0, 0))
		top:addChild(nice)

		--帮助
		local helpBtn = new(ButtonScale)
		helpBtn:create("UI/public/helpred.png",1.2,ccc3(255,255,255))			
		helpBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		helpBtn.btn:setPosition(CCPoint(860, 44))
		
		local text =
		"1、宠物继承可以将宠物身上的经验和洗髓获得的属性转接给其他宠物。"..
		"\n2、副宠等级大于主宠等级才能继承。"..
		"\n3、主宠最高可继承副宠洗髓属性、经验的50%，主宠实力可以提升至副宠的一半。"..
		"\n4、费金币，主宠最高可获得80%的经验和100%的洗髓属性继承，主宠实力能接近于副宠的当前实力。"..
		"\n5、继承后，副宠将消失，神宠不能作为副宠。"
		helpBtn.btn.m_nScriptClickedHandler = function()
	        local dialogCfg = new(basicDialogCfg)
			dialogCfg.title = "宠物继承说明"
			dialogCfg.msg = text
			dialogCfg.msgAlign = "left"
			dialogCfg.bg = "UI/baoguoPanel/kuang.png"
			dialogCfg.dialogType = 5
			dialogCfg.msgSize = 30
			dialogCfg.size = CCSize(1024,0);
			local dialog = new(Dialog)
			dialog:create(dialogCfg)
		end
		top:addChild(helpBtn.btn)
		
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		top:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
		
		removeUnusedTextures()
	end
}
--团队副本
function globleShowTeamFubenPanel()
	if not GlobleFubenPanel then
		GlobleFubenPanel = new(FubenMainPanel)
	end
	GlobleFubenPanel:create(1)
	createTeamFubenPanel()
end

function globleShowJingYingFubenPanel()
	if not GlobleFubenPanel then
		GlobleFubenPanel = new(FubenMainPanel)
	end
	GlobleFubenPanel:create(2)
	createJingYingFubenPanel()
end

function createTeamFubenPanel()
--	local function opCampThumbFinishCB(s)
--		closeWait()
--		local error_code = s:getByKey("error_code"):asInt()
--		if error_code ~= -1 then
--			ShowErrorInfoDialog(error_code)
--		else
--			local tfp = new(TeamFubenPanel):create(s)
--			GlobleFubenPanel.mainWidget:addChild(tfp.bg)
--			GlobleFubenPanel.tfp = tfp
--		end
--	end
--
--	local function loadBattles()
--		showWaitDialog("waiting CampThumb data")
--		NetMgr:registOpLuaFinishedCB(Net.OPT_CampThumb, opCampThumbFinishCB)
--		NetMgr:registOpLuaFailedCB(Net.OPT_CampThumb, opFailedCB)
--
--		local cj = Value:new()
--		cj:setByKey("role_id", ClientData.role_id)
--		cj:setByKey("request_code", ClientData.request_code)
--		NetMgr:executeOperate(Net.OPT_CampThumb, cj)
--	end
--	loadBattles()
	
	local tfp = new(TeamFubenPanel):create()
	GlobleFubenPanel.mainWidget:addChild(tfp.bg)
	GlobleFubenPanel.tfp = tfp
end


function createJingYingFubenPanel()
--	local function opFinishCB(s)
--		closeWait()
--		local error_code = s:getByKey("error_code"):asInt()
--		if error_code ~= -1 then
--			ShowErrorInfoDialog(error_code)
--		else
--			if GlobleFubenPanel.jyp then
--				GlobleFubenPanel:clearMain()
--			end
--			local jyp = new(JingYingFubenPanel):create(s)
--			GlobleFubenPanel.mainWidget:addChild(jyp.bg)
--			GlobleFubenPanel.jyp = jyp
--		end
--	end
--
--	local function loadBattles()
--		showWaitDialog("")
--		NetMgr:registOpLuaFinishedCB(Net.OPT_RaidCheck, opFinishCB)
--		NetMgr:registOpLuaFailedCB(Net.OPT_RaidCheck, opFailedCB)
--
--		local cj = Value:new()
--		cj:setByKey("role_id", ClientData.role_id)
--		cj:setByKey("request_code", ClientData.request_code)
--
--		NetMgr:executeOperate(Net.OPT_RaidCheck, cj)
--	end
--	loadBattles()
	if GlobleFubenPanel.jyp then
		GlobleFubenPanel:clearMain()
	end
	local jyp = new(JingYingFubenPanel):create()
	GlobleFubenPanel.mainWidget:addChild(jyp.bg)
	GlobleFubenPanel.jyp = jyp
end

FubenMainPanel = {
	mainWidget = nil,
	centerWidget = nil,
	titleLabel  = nil,

	create = function (self,topId)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		local topbtn = new(FubenTopButton):create(topId)
		self.topBtns = topbtn.toggles
		self.titleLabel = topbtn.titleLabel
		self.centerWidget:addChild(topbtn.bg,100)
		topbtn:toggle(topId)

		--注册开关切换事件
		for i = 1 , table.getn(topbtn.toggles) do
			topbtn.toggles[i].m_nScriptClickedHandler = function()
				if (topbtn.toggles[i]:isToggled()) then
					if i == 1 then
						self.titleLabel:setString("团队副本")
						self:clearMain()
						createTeamFubenPanel()
					end
					if i == 2 then
						if GloblePlayerData.officium < 30 then
							alert("精英副本30级以后开放")
							topbtn:toggle(1)
							return
						end
						self.titleLabel:setString("精英副本")
						self:clearMain()
						createJingYingFubenPanel()
					end
				end
				topbtn:toggle(i)
			end
		end

		--关闭按钮
		topbtn.closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
	end,

	clearMain = function(self)
		self.mainWidget:removeAllChildrenWithCleanup(true)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
	end
}

FubenTopButton = {
	bg = nil,
	toggles = {},
	closeBtn = nil,
	backBtn = nil,
	titleLabel = nil,

	create = function(self,topId)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(0,598))

		for i = 1 , table.getn(FubenTopBtnConfig) do
			local btn = dbUIButtonToggle:buttonWithImage(FubenTopBtnConfig[i].normal,FubenTopBtnConfig[i].toggle)
			btn:setAnchorPoint(CCPoint(0, 0))
			btn:setPosition(FubenTopBtnConfig[i].position)
			self.toggles[i] = btn
			self.bg:addChild(btn)
		end

		--面板提示图标
		local title_tip_bg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		title_tip_bg:setPosition(CCPoint(0, 12))
		title_tip_bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:addChild(title_tip_bg)
		
		local text = topId==1 and "团队副本" or "精英副本"
		local label = CCLabelTTF:labelWithString(text, SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setPosition(CCPoint(100,35))
		label:setColor(ccc3(255,203,153))
		title_tip_bg:addChild(label)
		self.titleLabel = label

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		self.bg:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
		return self
	end,

	--切换
	toggle = function(self,topid)
		public_toggleRadioBtn(self.toggles,self.toggles[topid])
	end
}
FubenTopBtnConfig = {
	{
		normal = "UI/fuben/team_1.png",
		toggle = "UI/fuben/team_2.png",
		position = 	CCPoint(230, 12),
	},
	
	{
		normal = "UI/fuben/jing_ying_1.png",
		toggle = "UI/fuben/jing_ying_2.png",
		position = 	CCPoint(230 + 190, 12),
	},
}
--团队副本
TeamFubenPanel = {
	bg = nil,
	pageCount = 1,
	curPage = 1, --当前页
	total = 0,

	create = function(self)
		self.bg = createDarkBG(927,540)
		self.bg:setPosition(CCPoint(40,40))
		self.camps = new({})

		for k,v in pairs(cfg_camp_data) do
			if GloblePlayerData.officium >= v.require_officium and v.type == 3 then
				self.total = self.total + 1
				table.insert(self.camps,v)
			end
		end
		table.sort(self.camps,function(a,b)
			return a.idx < b.idx
		end)
		
		self.pageCount = math.ceil(self.total / 8)
		if self.pageCount < 1 then self.pageCount = 1 end
		
		local pageContainer = dbUIPanel:panelWithSize(CCSize(927 * self.pageCount,490))
		pageContainer:setAnchorPoint(CCPoint(0, 0))
		pageContainer:setPosition(0,0)

		for i=1,self.pageCount do
			local singlePage = dbUIPanel:panelWithSize(CCSize(927,490))
			singlePage:setAnchorPoint(CCPoint(0, 0))
			singlePage:setPosition((i-1)*927,0)
			self:loadPage(singlePage,i)
			pageContainer:addChild(singlePage)
		end

		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pageContainer, 1, self.pageCount)
		self.scrollArea:setAnchorPoint(CCPoint(0, 0))
		self.scrollArea:setScrollRegion(CCRect(0, 0, 927, 490))
		self.scrollArea:setPosition(0,540-490)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.curPage = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
		end
		self.bg:addChild(self.scrollArea)
		self:createPageDot(self.pageCount)

		self.scrollArea:scrollToPage(self.curPage-1,false)
		return self
	end,

	--加载某一页的数据
	loadPage = function(self,pagePanel,page)
		--判断每页的个数
		local page_size = 0
		if page < self.pageCount then
			page_size = 8
		else
			if self.total % 8 == 0 then
				page_size = 8
			else
				page_size = self.total % 8
			end
		end
		local order = self.order
		local dataStart = 8*(page-1)
		local row,column=1,0

		for i=1,page_size do
			local camp = self.camps[dataStart+i]
			if camp == nil then
				break
			end
			
			local campId = camp.cfg_camp_id
			local name = camp.name

			column = column+1
			if column>4 then
				row = row+1
				column=1
			end

			local itemPanel = dbUIPanel:panelWithSize(CCSize(195,195))
			itemPanel:setPosition(CCPoint(30+(column-1)*228,254-(row-1)*228))

			local itemBg = CCSprite:spriteWithFile("UI/fuben/yuan.png")
			itemBg:setPosition(195/2,195/2)
			itemBg:setScale(195/165)
			itemPanel:addChild(itemBg)
			
			local btn = dbUIButtonScale:buttonWithImage("FightResource/fuben/"..cfg_camp_data[campId].battle_thumb..".png", 1, ccc3(125, 125, 125))
			btn:setPosition(195/2,195/2)
			btn:setScale(195/165)
			btn.m_nScriptClickedHandler = function()
				local function opTeamFinishCB(s)
					closeWait()
					local error_code = s:getByKey("error_code"):asInt()
					if error_code ~= -1 then
						ShowErrorInfoDialog(error_code)
					else
						globalShowFubenTeamListOrMine(campId,s)
					end
				end

				showWaitDialogNoCircle("waiting Team data")
				NetMgr:registOpLuaFinishedCB(Net.OPT_Team, opTeamFinishCB)
				NetMgr:registOpLuaFailedCB(Net.OPT_Team, opFailedCB)

				local cj = Value:new()
				cj:setByKey("role_id", ClientData.role_id)
				cj:setByKey("request_code", ClientData.request_code)
				cj:setByKey("cfg_camp_id", campId)
				NetMgr:executeOperate(Net.OPT_Team, cj)
			end
			itemPanel:addChild(btn)

			local name_bg = CCSprite:spriteWithFile("UI/fuben/name_bg.png")
			name_bg:setAnchorPoint(CCPoint(0.5, 0))
			name_bg:setPosition(CCPoint(195/2,20))
			itemPanel:addChild(name_bg)
			local name = CCLabelTTF:labelWithString(name, SYSFONT[EQUIPMENT], 22)
			name:setAnchorPoint(CCPoint(0.5, 0.5))
			name:setPosition(CCPoint(152/2,20))
			name:setColor(ccc3(253,204,102))
			name_bg:addChild(name)

			pagePanel:addChild(itemPanel)
		end
	end,

	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 50))
		self.form:setPosition(927/2, 0)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.bg:addChild(self.form)
		self.pageToggles = new({})
		for i=1, pageCount do
			local pageToggle = dbUIButtonToggle:buttonWithImage("UI/public/page_btn_normal.png","UI/public/page_btn_toggle.png")
			pageToggle:setPosition(CCPoint(52*(i-1),25) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
	end,
}

function globalShowFubenTeamListOrMine(cfg_camp_id,s)
	local team_id = s:getByKey("team_id"):asInt()
	if team_id==0 or s:getByKey("team_list"):size()==0 then
		globalShowFubenTeamListPanel(cfg_camp_id,s)
	else
		globalShowFubenTeamMinePanel(cfg_camp_id,s)
	end
end
--团队副本 团队列表  面板

function globalShowFubenTeamListPanel(cfg_camp_id,jValue)
	if GlobleFubenTeamListPanel == nil then
		GlobleFubenTeamListPanel = new(FubenTeamlistPanel)
	elseif GlobleFubenTeamListPanel.mainWidget then
		GlobleFubenTeamListPanel:clearMain()
	end
	GlobleFubenTeamListPanel:create(jValue,cfg_camp_id)
end

FubenTeamlistPanel = {
	mainWidget = nil,
	curPage = 1,
	pageCount = 1,
	selectTeamId = 0,
	selectTeam_require_level = 0,
	team_list = {},
	reset_count	= 0,
	
	initData = function(self,jValue)
		local list = jValue:getByKey("team_list")
		self.win_count = jValue:getByKey("win_count"):asInt()
		self.reset_count = jValue:getByKey("reset_count"):asInt()
		
		self.total = list:size()
		self.team_list = new({})
		for i=1, list:size() do
			local team = list:getByIndex(i-1)

			local leader_name = team:getByKey("leader_name"):asString()
			local leader_officium = team:getByKey("leader_officium"):asInt()
			local size = team:getByKey("size"):asInt()
			local require_level = team:getByKey("require_level"):asInt()
			local figure = team:getByKey("figure"):asInt()
			local team_id = team:getByKey("team_id"):asInt()

			self.team_list[i]={
				leader_name = leader_name,
				leader_officium = leader_officium,
				size = size,
				require_level = require_level,
				figure = figure,
				team_id = team_id,
			}
		end
	end,

	--选择第一个作为默认
	defaultSelect = function(self)
		if table.getn(self.team_list)>0 then
			if self.selectedBg and table.getn(self.selectedBg)>0 then
				self.selectedBg[1]:setIsVisible(true)
			end
			self.selectTeamId = self.team_list[1].team_id
			self.selectTeam_require_level = self.team_list[1].require_level
			return self.team_list[1]
		else
			return {
				leader_name = "--",
				leader_officium = "",
				size = "0",
				require_level = "",
				figure = "",
				team_id = 0,
			}
		end
	end,

	create = function(self,jValue,cfg_camp_id)
		self.cfg_camp_id = cfg_camp_id
		self:initData(jValue)

		if not self.mainWidget then
			self:initBase()
		end

		self:createRight(jValue)

		local defaultTeam = self:defaultSelect()
		self:createLeft(defaultTeam)
		
		local function teamCallBack()
			self:teamListUpdate()
		end
		if self.teamCheckHandle == nil then
			self.teamCheckHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(teamCallBack,5,false)
		end
		return self
	end,

	createLeft = function(self,teamInfo)
		if self.left then
			self.left:removeFromParentAndCleanup(true)
			self.left = nil
		end
		self.left = createDarkBG(380,540)
		self.left:setPosition(CCPoint(38,40))
		self.mainWidget:addChild(self.left)

		local label = CCLabelTTF:labelWithString("团队信息", CCSize(200,0),0,SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(15,486))
		label:setColor(ccc3(152,203,0))
		self.left:addChild(label)

		local label = CCLabelTTF:labelWithString("团长：", CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(40,440))
		label:setColor(ccc3(244,196,147))
		self.left:addChild(label)
		local label = CCLabelTTF:labelWithString(teamInfo.leader_name.." ("..teamInfo.leader_officium.."级)", CCSize(300,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(120,440))
		label:setColor(ccc3(255,152,3))
		self.left:addChild(label)
		
		local label = CCLabelTTF:labelWithString("当前人数： ", CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(40,410))
		label:setColor(ccc3(244,196,147))
		self.left:addChild(label)
		local label = CCLabelTTF:labelWithString(teamInfo.size, CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(160,410))
		label:setColor(ccc3(255,152,3))
		self.left:addChild(label)

		local label = CCLabelTTF:labelWithString("加入限制： ", CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(40,380))
		label:setColor(ccc3(244,196,147))
		self.left:addChild(label)
		local label = CCLabelTTF:labelWithString("神位大于"..teamInfo.require_level, CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(160,380))
		label:setColor(ccc3(255,152,3))
		self.left:addChild(label)

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(380/28)
		line:setPosition(0, 360)
		self.left:addChild(line)

		local camp_army_list = cfg_camp_data[self.cfg_camp_id].cfg_army_data
		local army_count = #camp_army_list 
		local max_level = 0
		local min_level = 1000
		
		local reward_exploit = 0
		local reward_exp = 0
		local reward_copper = 0
		local reward_item_list = {}

		local addRewardItem = function(reward_item)
			for i =1, #reward_item_list do
				if reward_item_list[i] == reward_item then
					return
				end
			end
			table.insert(reward_item_list,reward_item)
		end

		for i = 1, army_count do
			local cfg_army_id = camp_army_list[i]
			local army = cfg_army_data[cfg_army_id]
			
			if army.level > max_level then
				max_level = army.level
			end
			if army.level < min_level then
				min_level = army.level
			end
			
			reward_exploit = reward_exploit + army.reward_exploit
			reward_exp = reward_exp + army.reward_exp
			reward_copper = reward_copper + army.reward_copper
			
			if army.reward_item > 0 then
				addRewardItem(army.reward_item)
			end
			if army.reward_item2 > 0 then
				addRewardItem(army.reward_item2)
			end			
		end
		
		local createLabel = function(label,value,position1,position2)
			local label = CCLabelTTF:labelWithString(label, CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setPosition(position1)
			label:setColor(ccc3(244,196,147))
			self.left:addChild(label)
			local label = CCLabelTTF:labelWithString(value, CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setPosition(position2)
			label:setColor(ccc3(255,152,3))
			self.left:addChild(label)
		end
		
		local level_scope = min_level == max_level and min_level or min_level.."-"..max_level
		createLabel("怪物等级： ",level_scope, CCPoint(15,320),CCPoint(115,320))
		createLabel("怪物数量： ",army_count,  CCPoint(200,320),CCPoint(300,320))
		
		createLabel("战功奖励： ",reward_exploit,CCPoint(15,290),CCPoint(115,290))
		createLabel("经验奖励： ",reward_exp,CCPoint(200,290),CCPoint(300,290))
		
		createLabel("银币奖励： ",reward_copper,CCPoint(15,260),CCPoint(115,260))

		local label = CCLabelTTF:labelWithString("掉落： ", CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(15,225))
		label:setColor(ccc3(244,196,147))
		self.left:addChild(label)

		for i = 1, #reward_item_list do
			local line = i%3 == 0 and i/3 or math.ceil(i/3)
			local row  = i%3 == 0 and 3 or i%3
			
			local reward_item = reward_item_list[i]
			local kuang = createPanel("UI/public/kuang_94_94.png")
			kuang:setPosition(20 + 120 * (row - 1), 120 - (line - 1) * 110)
			self.left:addChild(kuang)

			local dropWood = getItemBorder(reward_item)
			dropWood:setAnchorPoint(CCPoint(0.5, 0.5))
			dropWood:setPosition(CCPoint(47,47))
			kuang:addChild(dropWood)			
		end
	end,

	createRight = function(self,jValue)
		self.right = createDarkBG(536,540)
		self.right:setPosition(CCPoint(430,40))
		self.mainWidget:addChild(self.right)

		local label = CCLabelTTF:labelWithString("团队列表", CCSize(200,0),0,SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(15,486))
		label:setColor(ccc3(152,203,0))
		self.right:addChild(label)
		--创建队伍列表
		self:createTeamList(jValue)

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(536/28)
		line:setPosition(0, 100)
		self.right:addChild(line)

		--创建队伍
		local btn = new(ButtonScale)
		btn:create("UI/fuben/team/create_btn.png",1.2,ccc3(255,255,255))
		btn.btn:setPosition(CCPoint(167, 50))
		btn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn.btn.m_nScriptClickedHandler = function(ccp)
			--创建团队之前先校验阵型
			if checkFormationIsEmpty() then
				return
			end
			if GloblePlayerData.cell_count - getBaoguoItemCount() < 4 then
				new(ConfirmDialog):show({
					text = "背包剩余空间不多，是否继续？",
					width = 480,
					color = ccc3(253,205,156),
					onClickOk = function()
						self:createTeamDialog()
					end
				})
			else
				self:createTeamDialog()
			end
		end
		self.right:addChild(btn.btn)

		--加入队伍
		local btn = new(ButtonScale)
		btn:create("UI/fuben/team/join_btn.png",1.2,ccc3(255,255,255))
		btn.btn:setPosition(CCPoint(366, 50))
		btn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn.btn.m_nScriptClickedHandler = function(ccp)
			--加入团队之前先校验阵型和血量
			if checkFormationIsEmpty() then
				return
			end
			if GloblePlayerData.cell_count - getBaoguoItemCount() < 4 then
				new(ConfirmDialog):show({
					text = "背包剩余空间不多，是否继续？",
					width = 480,
					color = ccc3(253,205,156),
					onClickOk = function()
						self:joinTeam()
					end
				})
			else
				self:joinTeam()
			end
		end
		self.right:addChild(btn.btn)
	end,

	--定时刷新队伍列表
	teamListUpdate = function (self)
		local function opTeamCheckFinishCB(s)
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				globalShowFubenTeamListPanel(self.cfg_camp_id,s)
			end
		end

		NetMgr:registOpLuaFinishedCB(Net.OPT_Team, opTeamCheckFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_Team, opFailedCB)
		
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("cfg_camp_id", self.cfg_camp_id)
		NetMgr:executeOperate(Net.OPT_Team, cj)
	end,
	
	joinTeam = function(self)
		if self.selectTeamId ==0 then
			alert("请选择一支队伍加入!")
			return
		end
		if GloblePlayerData.officium < self.selectTeam_require_level then
			local dtp = new(DialogTipPanel)
			dtp:create("等级不够，无法加入","")
			dtp.okBtn.m_nScriptClickedHandler = function()
				dtp:destroy()
			end
			return
		end

		local function opTeamJoinFinishCB(s)
			closeWait()

			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				self:destroy()
				globalShowFubenTeamMinePanel(self.cfg_camp_id,s)
			end
		end

		showWaitDialogNoCircle("waiting Team data")
		NetMgr:registOpLuaFinishedCB(Net.OPT_TeamJoin, opTeamJoinFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_TeamJoin, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("team_id", self.selectTeamId)
		cj:setByKey("cfg_camp_id", self.cfg_camp_id )
		NetMgr:executeOperate(Net.OPT_TeamJoin, cj)
	end,

	--创建队伍
	createTeamDialog = function(self)
		local createJunPanel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		createJunPanel.m_nScriptClickedHandler = function(ccp)
			createJunPanel:removeFromParentAndCleanup(true)
		end
		self.centerWidget:addChild(createJunPanel,100000)

		local createbg = createBG("UI/public/dialog_kuang.png",500,270)
		createbg:setAnchorPoint(CCPoint(0.5, 0.5))
		createbg:setPosition(CCPoint(512,384))
		createJunPanel:addChild(createbg)

		local label = CCLabelTTF:labelWithString("团队加入限制",CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(500/2,200))
		label:setColor(ccc3(51,102,1))
		createbg:addChild(label)

		local label = CCLabelTTF:labelWithString("神位大于：",CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(40,100))
		label:setColor(ccc3(102,50,0))
		createbg:addChild(label)
		local yinLabel = CCLabelTTF:labelWithString("0",CCSize(500,0),0, SYSFONT[EQUIPMENT], 32)
		yinLabel:setAnchorPoint(CCPoint(0,0))
		yinLabel:setPosition(CCPoint(180,100))
		yinLabel:setColor(ccc3(248,100,0))
		createbg:addChild(yinLabel)

		--滑动条
		local cfg = new(COMMON_BAR_CFG)
		cfg.position = CCPoint(35, 150)
		cfg.borderSize =  {width = 400,height = 32}
		cfg.entitySize = {width = 400,height = 28}

		local all = GloblePlayerData.officium
		local bar = new(Bar2)
		bar:create(all, cfg)
		bar:setExtent(0)
		createbg:addChild(bar.barbg)

		--滑动的点
		local m_temp = 280
		local t_temp = 680
		local image = CCSprite:spriteWithFile("UI/jia_zu/la.png")
		local drag =  dbUIWidget:widgetWithSprite(image)
		drag:setAnchorPoint(CCPoint(0,0))
		drag:setPosition(CCPoint(280,390))
		drag.m_nScriptDragMoveHandler = function(pos,prevPos)
			local pos1 = drag:convertToNodeSpace(pos)
			local prevPos1 = drag:convertToNodeSpace(prevPos)
			local m_pos = drag:getPositionX()-prevPos1.x + pos1.x
			if m_pos <m_temp or m_pos>t_temp then
				return
			end
			drag:setPositionX(m_pos)
			bar:setExtent(all*(drag:getPositionX()-m_temp)/380)
			yinLabel:setString(getShotNumber(bar.cur))
		end
		createJunPanel:addChild(drag,100)

		--确定按钮
		local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(500/2-91,60))
		btn.m_nScriptClickedHandler = function(ccp)
			self:createMyTeam(getShotNumber(bar.cur))
			createJunPanel:removeFromParentAndCleanup(true)
		end
		createbg:addChild(btn,10)

		local btn = dbUIButtonScale:buttonWithImage("UI/public/cancel_btn.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(500/2+91,60))
		btn.m_nScriptClickedHandler = function(ccp)
			createJunPanel:removeFromParentAndCleanup(true)
		end
		createbg:addChild(btn,10)
	end,

	createMyTeam = function(self,level)
		local function opTeamCreateFinishCB(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				self:destroy()
				globalShowFubenTeamMinePanel(self.cfg_camp_id,s)
			end
		end

		showWaitDialogNoCircle("waiting TeamCreate data")
		NetMgr:registOpLuaFinishedCB(Net.OPT_TeamCreate, opTeamCreateFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_TeamCreate, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("cfg_camp_id", self.cfg_camp_id )
		cj:setByKey("require_level", tonumber(level))
		NetMgr:executeOperate(Net.OPT_TeamCreate, cj)
	end,

	--创建队伍列表
	createTeamList = function(self,jValue)
		local team_list = jValue:getByKey("team_list")
		self.total = team_list:size()
		self.pageCount = math.ceil(self.total / 4)
		if self.pageCount < 1 then
			self.pageCount = 1
		end
		if self.curPage > self.pageCount then
			self.curPage = self.pageCount
		end

		local pageContainer = dbUIPanel:panelWithSize(CCSize(536 * self.pageCount,300))
		pageContainer:setAnchorPoint(CCPoint(0, 0))
		pageContainer:setPosition(0,0)
		self.selectedBg = new({})
		for i=1,self.pageCount do
			local singlePage = dbUIPanel:panelWithSize(CCSize(536,300))
			singlePage:setAnchorPoint(CCPoint(0, 0))
			singlePage:setPosition((i-1)*536,10)
			self:loadPage(singlePage,i,team_list)
			pageContainer:addChild(singlePage)
		end

		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pageContainer, 1, self.pageCount)
		self.scrollArea:setAnchorPoint(CCPoint(0, 0))
		self.scrollArea:setScrollRegion(CCRect(0, 0, 536, 300))
		self.scrollArea:setPosition(0,170)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.curPage = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
		end
		self.right:addChild(self.scrollArea)
		self:createPageDot(self.pageCount)

		self.scrollArea:scrollToPage(self.curPage-1,false)
	end,

	--加载某一页的数据
	loadPage = function(self,pagePanel,page,team_list)
		local POS = {
			CCPoint(30,160),
			CCPoint(277,160),
			CCPoint(30,15),
			CCPoint(277,15)
		}
		local POS_SELECTED = {
			CCPoint(20,150),
			CCPoint(267,150),
			CCPoint(20,5),
			CCPoint(267,5)
		}
		local selected = createBG("UI/public/kuang_120.png",243,147,CCSize(40,40))
		selected:setPosition(POS_SELECTED[1])
		selected:setAnchorPoint(CCPoint(0,0))
		selected:setIsVisible(false)
		pagePanel:addChild(selected)
		self.selectedBg[page] = selected

		local createItem = function(i,team)
			local item = createBG("UI/public/kuang_96_96.png",223,127,CCSize(40,40))
			item:setPosition(POS[i-4*(page-1)])
			item:setAnchorPoint(CCPoint(0,0))
			pagePanel:addChild(item)
			local teamId = team:getByKey("team_id"):asInt()
			local require_level = team:getByKey("require_level"):asInt()
			item.m_nScriptClickedHandler = function(ccp)
				self.selectTeamId = teamId
				self.selectTeam_require_level = require_level
				self.selectedBg[page]:setIsVisible(true)
				self.selectedBg[page]:setPosition(POS_SELECTED[i-4*(page-1)])
				self:createLeft(self.team_list[i])
			end

			local kuang_94_94 = CCSprite:spriteWithFile("UI/public/kuang_94_94.png")
			kuang_94_94:setAnchorPoint(CCPoint(0, 0.5))
			kuang_94_94:setPosition(10, 127/2)
			item:addChild(kuang_94_94)
			local head = CCSprite:spriteWithFile("head/Middle/head_middle_"..team:getByKey("figure"):asInt()..".png")
			head:setPosition(47, 47)
			head:setAnchorPoint(CCPoint(0.5, 0.5))
			kuang_94_94:addChild(head)

			local label = CCLabelTTF:labelWithString(team:getByKey("leader_name"):asString(), CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(110,65))
			label:setColor(ccc3(152,203,0))
			item:addChild(label)

			local label = CCLabelTTF:labelWithString(team:getByKey("size"):asInt().."/5", CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(110,30))
			label:setColor(ccc3(255,152,3))
			item:addChild(label)
		end

		local dataStart = 4*(page-1)
		local endIndex = (dataStart+4) > self.total and self.total or (dataStart+4)
		for i=dataStart+1,endIndex do
			createItem(i,team_list:getByIndex(i-1))
		end
	end,

	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 90))
		self.form:setPosition(536/2, 100)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.right:addChild(self.form)

		self.pageToggles = new({})
		for i=1, pageCount do
			local pageToggle = dbUIButtonToggle:buttonWithImage("UI/public/page_btn_normal.png","UI/public/page_btn_toggle.png")
			pageToggle:setPosition(CCPoint(52*(i-1),45) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
	end,

	clearMain = function(self)
		self.mainWidget:removeAllChildrenWithCleanup(true)
		self.left = nil
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		self.top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(self.top)

		--面板提示图标
		local title_tip_bg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		title_tip_bg:setPosition(CCPoint(0, 12))
		title_tip_bg:setAnchorPoint(CCPoint(0, 0))
		self.top:addChild(title_tip_bg)
		local label = CCLabelTTF:labelWithString("团队副本", SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setPosition(CCPoint(100,35))
		label:setColor(ccc3(255,203,153))
		title_tip_bg:addChild(label)

		if self.win_count > 0 and GloblePlayerData.vip_level > 0 then
			local label = CCLabelTTF:labelWithString("今日已挑战", SYSFONT[EQUIPMENT], 24)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(550,35))
			label:setColor(ccc3(51,0,0))
			self.top:addChild(label)
			self.winTipLabel = label
			
			local btn = dbUIButtonScale:buttonWithImage("UI/fuben/reset_btn.png", 1, ccc3(125, 125, 125))
			btn:setAnchorPoint(CCPoint(0,0))
			btn:setPosition(CCPoint(720,20))
			btn.m_nScriptClickedHandler = function()
				local cost = 50
				if self.reset_count == 1 then
					cost = 100
				elseif self.reset_count >= 2 then
					cost = 200
				end
				new(ConfirmDialog):show({
					text = "是否花费"..cost.."金币重置该副本？",
					width = 460,
					color = ccc3(253,205,156),
					onClickOk = function()
						self:resetTeamRaid()
					end
				})
			end
			self.top:addChild(btn)
			self.resetBtn = btn
		end
		
		--帮助按钮
		local helpBtn = new(ButtonScale)
		helpBtn:create("UI/public/helpred.png",1.2,ccc3(255,255,255))			
		helpBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		helpBtn.btn:setPosition(CCPoint(875, 44))
		self.top:addChild(helpBtn.btn,1)
		
		local text = "每天只可获取1次奖励，可花费金币进行重置。\nVIP4级可重置1次，VIP6级可重置2次，VIP8级可重置3次。\n当天奖励次数用完，可继续协助别人挑战副本，但不会获得奖励。"
		helpBtn.btn.m_nScriptClickedHandler = function()
	        local dialogCfg = new(basicDialogCfg)
			dialogCfg.title = "说明"
			dialogCfg.msg = text
			dialogCfg.msgAlign = "left"
			dialogCfg.bg = "UI/baoguoPanel/kuang.png"
			dialogCfg.dialogType = 5
			dialogCfg.msgSize = 30
			dialogCfg.size = CCSize(1024,0);
			local dialog = new(Dialog)
			dialog:create(dialogCfg)
		end
		
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.top:addChild(closeBtn.btn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil

		self.left = nil
		self.right = nil
		self.curPage = 1
		self.pageCount = 1
		self.selectTeamId = 0
		self.selectTeam_require_level = 0
		self.selectedBg = nil
		self.team_list = {}
		
		if self.teamCheckHandle ~= nil then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.teamCheckHandle)
			self.teamCheckHandle = nil
		end		
	end,
	
	resetTeamRaid = function(self)
		local function opFinishCB(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				if self.resetBtn then
					self.resetBtn:setIsVisible(false)
					self.winTipLabel:setIsVisible(false)
					self.reset_count = self.reset_count + 1
				end
			end
		end

		showWaitDialogNoCircle("")
		NetMgr:registOpLuaFinishedCB(Net.OPT_TeamReset, opFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_TeamReset, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("cfg_camp_id", self.cfg_camp_id )
		NetMgr:executeOperate(Net.OPT_TeamReset, cj)
	end,
}

--团队副本 我加入的队伍  面板
local FubenTeamCampId = 0

function globalShowFubenTeamMinePanel(cfg_camp_id,jValue)
	if GlobleFubenTeamMinePanel == nil then
		GlobleFubenTeamMinePanel = new(FubenTeamMinePanel)
	elseif GlobleFubenTeamMinePanel.mainWidget then
		GlobleFubenTeamMinePanel:clearMain()
	end
	GlobleFubenTeamMinePanel:create(jValue,cfg_camp_id)
	
	--保存cfg_camp_id，在destory之后，可以调用
	FubenTeamCampId = cfg_camp_id
end

--获取该副本中怪物属性，供C++调用
function globalGetTeamBattleArmyData(armyData)
	if FubenTeamCampId > 0 then
		local camp_army_list = cfg_camp_data[FubenTeamCampId].cfg_army_data
		local army_list = Value:new()
		
		for i = 1, #camp_army_list do
			local cfg_army_id = camp_army_list[i]
			
			local army = Value:new()
			army:setByKey("name", cfg_army_data[cfg_army_id].name)
			army:setByKey("face", cfg_army_data[cfg_army_id].face)
			army_list:append(army)
		end
		armyData:setByKey("army_list", army_list) 
	end
end

FubenTeamMinePanel = {

	member_list = nil,
	team_info   = nil,
	leader_id   = nil,
	team_id     = nil,
	is_leader   = false,
	autoFight	= false,
	reset_count	= 0,
	
	initData = function(self,jValue)
		self.team_id = jValue:getByKey("team_id"):asInt()
		self.leader_id = jValue:getByKey("leader_id"):asInt()
		self.win_count = jValue:getByKey("win_count"):asInt()
		self.reset_count = jValue:getByKey("reset_count"):asInt()

		local list = jValue:getByKey("team_list")
		self.team_list = new({})
		for i=1, list:size() do
			local team = list:getByIndex(i-1)
			if self.team_id==team:getByKey("team_id"):asInt() then
				local leader_name = team:getByKey("leader_name"):asString()
				local leader_officium = team:getByKey("leader_officium"):asInt()
				local size = team:getByKey("size"):asInt()
				local require_level = team:getByKey("require_level"):asInt()
				local figure = team:getByKey("figure"):asInt()
				local team_id = team:getByKey("team_id"):asInt()
				self.team_info={
					leader_name = leader_name,
					leader_officium = leader_officium,
					size = size,
					require_level = require_level,
					figure = figure,
					team_id = team_id,
				}
				break
			end
		end

		if ClientData.role_id==self.leader_id then
			self.is_leader = true
		else
			self.is_leader = false
		end

		local list = jValue:getByKey("member_list")
		self.member_list = new({})
		for i=1, list:size() do
			local member = list:getByIndex(i-1)

			local name = member:getByKey("name"):asString()
			local role_id = member:getByKey("role_id"):asInt()
			local officium = member:getByKey("officium"):asInt()
			local figure = member:getByKey("figure"):asInt()
			self.member_list[i]={
				name = name,
				role_id = role_id,
				officium = officium,
				figure = figure,
			}
		end
	end,

	create = function(self,jValue,cfg_camp_id)
		self.cfg_camp_id = cfg_camp_id
		self:initData(jValue)

		if not self.mainWidget then
			self:initBase()
		end

		self:createLeft(self.team_info)
		self:createRight()
		return self
	end,

	createLeft = function(self,teamInfo)
		self.left = createDarkBG(380,540)
		self.left:setPosition(CCPoint(38,40))
		self.mainWidget:addChild(self.left)

		local label = CCLabelTTF:labelWithString("团队信息", CCSize(200,0),0,SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(15,486))
		label:setColor(ccc3(152,203,0))
		self.left:addChild(label)

		local label = CCLabelTTF:labelWithString("团长：", CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(40,440))
		label:setColor(ccc3(244,196,147))
		self.left:addChild(label)
		local label = CCLabelTTF:labelWithString(teamInfo.leader_name.." ("..teamInfo.leader_officium.."级)", CCSize(300,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(120,440))
		label:setColor(ccc3(255,152,3))
		self.left:addChild(label)
		
		local label = CCLabelTTF:labelWithString("当前人数： ", CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(40,410))
		label:setColor(ccc3(244,196,147))
		self.left:addChild(label)
		local label = CCLabelTTF:labelWithString(teamInfo.size, CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(160,410))
		label:setColor(ccc3(255,152,3))
		self.left:addChild(label)

		local label = CCLabelTTF:labelWithString("加入限制： ", CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(40,380))
		label:setColor(ccc3(244,196,147))
		self.left:addChild(label)
		local label = CCLabelTTF:labelWithString("神位大于"..teamInfo.require_level, CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(160,380))
		label:setColor(ccc3(255,152,3))
		self.left:addChild(label)

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(380/28)
		line:setPosition(0, 360)
		self.left:addChild(line)
		
		local camp_army_list = cfg_camp_data[self.cfg_camp_id].cfg_army_data
		local army_count = #camp_army_list 
		local max_level = 0
		local min_level = 1000
		
		local reward_exploit = 0
		local reward_exp = 0
		local reward_copper = 0
		local reward_item_list = {}

		local addRewardItem = function(reward_item)
			for i =1, #reward_item_list do
				if reward_item_list[i] == reward_item then
					return
				end
			end
			table.insert(reward_item_list,reward_item)
		end

		for i = 1, army_count do
			local cfg_army_id = camp_army_list[i]
			local army = cfg_army_data[cfg_army_id]
			
			if army.level > max_level then
				max_level = army.level
			end
			if army.level < min_level then
				min_level = army.level
			end
			
			reward_exploit = reward_exploit + army.reward_exploit
			reward_exp = reward_exp + army.reward_exp
			reward_copper = reward_copper + army.reward_copper
			
			if army.reward_item > 0 then
				addRewardItem(army.reward_item)
			end
			if army.reward_item2 > 0 then
				addRewardItem(army.reward_item2)
			end			
		end
		
		local createLabel = function(label,value,position1,position2)
			local label = CCLabelTTF:labelWithString(label, CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setPosition(position1)
			label:setColor(ccc3(244,196,147))
			self.left:addChild(label)
			local label = CCLabelTTF:labelWithString(value, CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setPosition(position2)
			label:setColor(ccc3(255,152,3))
			self.left:addChild(label)
		end
		
		local level_scope = min_level == max_level and min_level or min_level.."-"..max_level
		createLabel("怪物等级： ",level_scope, CCPoint(15,320),CCPoint(115,320))
		createLabel("怪物数量： ",army_count,  CCPoint(200,320),CCPoint(300,320))
		
		createLabel("战功奖励： ",reward_exploit,CCPoint(15,290),CCPoint(115,290))
		createLabel("经验奖励： ",reward_exp,CCPoint(200,290),CCPoint(300,290))
		
		createLabel("银币奖励： ",reward_copper,CCPoint(15,260),CCPoint(115,260))

		local label = CCLabelTTF:labelWithString("掉落： ", CCSize(200,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(15,225))
		label:setColor(ccc3(244,196,147))
		self.left:addChild(label)

		for i = 1, #reward_item_list do
			local line = i%3 == 0 and i/3 or math.ceil(i/3)
			local row  = i%3 == 0 and 3 or i%3
			
			local reward_item = reward_item_list[i]
			local kuang = createPanel("UI/public/kuang_94_94.png")
			kuang:setPosition(20 + 120 * (row - 1), 120 - (line - 1) * 110)
			self.left:addChild(kuang)

			local dropWood = getItemBorder(reward_item)
			dropWood:setAnchorPoint(CCPoint(0.5, 0.5))
			dropWood:setPosition(CCPoint(47,47))
			kuang:addChild(dropWood)			
		end
	end,

	createRight = function(self)
		self.right = createDarkBG(536,540)
		self.right:setPosition(CCPoint(430,40))
		self.mainWidget:addChild(self.right)

		local label = CCLabelTTF:labelWithString("成员列表", CCSize(200,0),0,SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(15,486))
		label:setColor(ccc3(152,203,0))
		self.right:addChild(label)

		--创建队伍列表
		for i=1,table.getn(self.member_list) do
			local member = self.member_list[i]
			local name = member.name
			local role_id = member.role_id
			local figure = member.figure
			local officium = member.officium

			local item = dbUIPanel:panelWithSize(CCSize(536, 78))
			item:setAnchorPoint(CCPoint(0, 0))
			item:setPosition(0, 400-(i-1)*78)
			self.right:addChild(item)

			--分割线
			local line = CCSprite:spriteWithFile("UI/public/line_2.png")
			line:setAnchorPoint(CCPoint(0,1))
			line:setScaleX(536/28)
			line:setPosition(0,78)
			item:addChild(line)

			local kuang_94_94 = CCSprite:spriteWithFile("UI/public/kuang_94_94.png")
			kuang_94_94:setPosition(30,78/2)
			kuang_94_94:setAnchorPoint(CCPoint(0,0.5))
			kuang_94_94:setScale(0.7)
			item:addChild(kuang_94_94)
			local head = CCSprite:spriteWithFile("head/Middle/head_middle_"..figure..".png")
			head:setPosition(47, 47)
			kuang_94_94:addChild(head)

			local label = CCLabelTTF:labelWithString(name, CCSize(400,0),0,SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(120,40))
			label:setColor(ccc3(255,152,3))
			item:addChild(label)

			local label = CCLabelTTF:labelWithString("神位：", CCSize(100,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setPosition(CCPoint(120,10))
			label:setColor(ccc3(244,196,147))
			item:addChild(label)
			local label = CCLabelTTF:labelWithString(officium, CCSize(50,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(180,10))
			label:setColor(ccc3(255,152,3))
			item:addChild(label)

			if self.is_leader and ClientData.role_id~=role_id then
				local kick = dbUIButtonScale:buttonWithImage("UI/fuben/team/kick.png",1,ccc3(152,203,0))
				kick:setAnchorPoint(CCPoint(0,0))
				kick:setPosition(CCPoint(300, 20))
				kick.m_nScriptClickedHandler = function()
					self:teamKick(role_id)
				end
				item:addChild(kick)
			end
		end

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(536/28)
		line:setPosition(0, 95)
		self.right:addChild(line)

		local panel = dbUIPanel:panelWithSize(CCSize(200, 40))
		panel:setAnchorPoint(CCPoint(0,0))
		panel:setPosition(CCPoint(320,120))
		panel.m_nScriptClickedHandler = function(ccp)
			self:callMember()
		end
		self.right:addChild(panel)
		local label = CCLabelTTF:labelWithString("（点击召唤队友）", SYSFONT[EQUIPMENT], 24)
		label:setAnchorPoint(CCPoint(0.5,0.5))
		label:setPosition(CCPoint(100,20))
		label:setColor(ccc3(152,203,0))
		panel:addChild(label)
						
		--你是队长
		if self.is_leader then
			local toggle = dbUIButtonToggle:buttonWithImage("UI/shen_yu/yong_bing/toggle_no.png","UI/shen_yu/yong_bing/toggle_on.png")
			toggle:setAnchorPoint(CCPoint(0,0))
			toggle:setPosition(CCPoint(60, 110))
			toggle.m_nScriptClickedHandler = function()
				self.autoFight = toggle:isToggled()
			end
			toggle:toggled(self.autoFight)
			self.right:addChild(toggle)
			
			local label = CCLabelTTF:labelWithString("满员自动挑战",CCSize(300,0),0, SYSFONT[EQUIPMENT], 28)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(130,125))
			label:setColor(ccc3(189,132,51))
			self.right:addChild(label)
		
			--开始挑战
			local btn = new(ButtonScale)
			btn:create("UI/fuben/team/kssd.png",1.2,ccc3(99,99,99))
			btn.btn:setPosition(CCPoint(167, 50))
			btn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
			btn.btn.m_nScriptClickedHandler = function(ccp)
				self:teamStart()
			end
			self.right:addChild(btn.btn)

			--解散队伍
			local btn = new(ButtonScale)
			btn:create("UI/fuben/team/qstd.png",1.2,ccc3(99,99,99))
			btn.btn:setPosition(CCPoint(366, 50))
			btn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
			btn.btn.m_nScriptClickedHandler = function(ccp)
				self:teamKick(ClientData.role_id)
			end
			self.right:addChild(btn.btn)
		else
			--退出队伍
			local btn = new(ButtonScale)
			btn:create("UI/fuben/team/tctd.png",1.2,ccc3(99,99,99))
			btn.btn:setPosition(CCPoint(536/2, 50))
			btn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
			btn.btn.m_nScriptClickedHandler = function(ccp)
				self:teamKick(ClientData.role_id)
			end
			self.right:addChild(btn.btn)
		end

		self:registTeamCheck()
		local function teamCallBack()
			self:teamCheck(self.team_id)
		end
		if self.teamCheckHandle == nil then
			self.teamCheckHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(teamCallBack,3,false)
		end
	end,
	
	registTeamCheck = function(self)
		local function opTeamCheckFinishCB(s)
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				if s:getByKey("battle_data_list"):isNull() == false then
					if self.teamCheckHandle ~= nil then
						CCScheduler:sharedScheduler():unscheduleScriptEntry(self.teamCheckHandle)
						self.teamCheckHandle = nil
					end
					self:destroy()
				else
					self.team_id = s:getByKey("team_id"):asInt()
					if self.team_id == 0 then
						self:destroy()
						globalShowFubenTeamListOrMine(self.cfg_camp_id,s)
					else
						self.right:removeFromParentAndCleanup(true)
						self.right = nil
						self:initData(s)
						self:createRight()
						
						if self.is_leader and self.autoFight and #self.member_list == 3 then
							self:teamStart()
						end
					end
				end
			end
		end

		NetMgr:registOpLuaFinishedCB(Net.OPT_TeamCheck, opTeamCheckFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_TeamCheck, opFailedCB)
	end,
	
	teamCheck = function (self,team_id)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("cfg_camp_id", self.cfg_camp_id)
		cj:setByKey("team_id", team_id)
		cj:setByKey("auto_fight", self.autoFight)
		NetMgr:executeOperate(Net.OPT_TeamCheck, cj)
	end,

	teamStart = function(self)
		local function opTeamStartFinishCB(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				if self.teamCheckHandle ~= nil then
					CCScheduler:sharedScheduler():unscheduleScriptEntry(self.teamCheckHandle)
					self.teamCheckHandle = nil
				end
				self:destroy()
			end
		end
		showWaitDialogNoCircle("waiting Team data")
		NetMgr:registOpLuaFinishedCB(Net.OPT_TeamStart, opTeamStartFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_TeamStart, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("cfg_camp_id", self.cfg_camp_id )

		globalRoleSimpleOnce = true
		G_SceneMgr:setCurBattleType(-1)		--设置战斗类型为-1
		NetMgr:executeOperate(Net.OPT_TeamStart, cj)
	end,

	teamKick = function(self, target_id)
		local function opTeamKickFinishCB(s)
			closeWait()

			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				self:destroy()
				globalShowFubenTeamListOrMine(self.cfg_camp_id,s)
			end
		end

		showWaitDialogNoCircle("waiting Team data")
		NetMgr:registOpLuaFinishedCB(Net.OPT_TeamKick, opTeamKickFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_TeamKick, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("target_id", target_id)
		cj:setByKey("cfg_camp_id", self.cfg_camp_id )
		NetMgr:executeOperate(Net.OPT_TeamKick, cj)
	end,

	clearMain = function(self)
		self.mainWidget:removeAllChildrenWithCleanup(true)
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		self.top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(self.top)

		--面板提示图标
		local title_tip_bg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		title_tip_bg:setPosition(CCPoint(0, 12))
		title_tip_bg:setAnchorPoint(CCPoint(0, 0))
		self.top:addChild(title_tip_bg)
		local label = CCLabelTTF:labelWithString("团队副本", SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setPosition(CCPoint(100,35))
		label:setColor(ccc3(255,203,153))
		title_tip_bg:addChild(label)

		if self.win_count > 0 and GloblePlayerData.vip_level > 0 then
			local label = CCLabelTTF:labelWithString("今日已挑战", SYSFONT[EQUIPMENT], 24)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(550,35))
			label:setColor(ccc3(51,0,0))
			self.top:addChild(label)
			self.winTipLabel = label
			
			local btn = dbUIButtonScale:buttonWithImage("UI/fuben/reset_btn.png", 1, ccc3(125, 125, 125))
			btn:setAnchorPoint(CCPoint(0,0))
			btn:setPosition(CCPoint(720,20))
			btn.m_nScriptClickedHandler = function()
				local cost = 50
				if self.reset_count == 1 then
					cost = 100
				elseif self.reset_count >= 2 then
					cost = 200
				end
				new(ConfirmDialog):show({
					text = "是否花费"..cost.."金币重置该副本？",
					width = 460,
					color = ccc3(253,205,156),
					onClickOk = function()
						self:resetTeamRaid()
					end
				})
			end
			self.top:addChild(btn)
			self.resetBtn = btn
		end
		
		--帮助按钮
		local helpBtn = new(ButtonScale)
		helpBtn:create("UI/public/helpred.png",1.2,ccc3(255,255,255))			
		helpBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		helpBtn.btn:setPosition(CCPoint(875, 44))
		self.top:addChild(helpBtn.btn,1)
		
		local text =
		"每天只可获取1次奖励，可花费金币进行重置。\nVIP4级可重置1次，VIP6级可重置2次，VIP8级可重置3次。\n当天奖励次数用完，可继续协助别人挑战副本，但不会获得奖励。"
		helpBtn.btn.m_nScriptClickedHandler = function()
	        local dialogCfg = new(basicDialogCfg)
			dialogCfg.title = "说明"
			dialogCfg.msg = text
			dialogCfg.msgAlign = "left"
			dialogCfg.bg = "UI/baoguoPanel/kuang.png"
			dialogCfg.dialogType = 5
			dialogCfg.msgSize = 30
			dialogCfg.size = CCSize(1024,0);
			local dialog = new(Dialog)
			dialog:create(dialogCfg)
		end
		
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			local dtp = new(DialogTipPanel)
			dtp:create("当前正在队伍中，请先退出队伍",ccc3(255,204,153),180)
			dtp.okBtn.m_nScriptClickedHandler = function()
				dtp:destroy()
				if self.teamCheckHandle ~= nil then
					CCScheduler:sharedScheduler():unscheduleScriptEntry(self.teamCheckHandle)
					self.teamCheckHandle = nil
				end
			end
		end
		self.top:addChild(closeBtn.btn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
		if self.teamCheckHandle ~= nil then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.teamCheckHandle)
			self.teamCheckHandle = nil
		end
	end,

	resetTeamRaid = function(self)
		local function opFinishCB(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				if self.resetBtn then
					self.resetBtn:setIsVisible(false)
					self.winTipLabel:setIsVisible(false)
					self.reset_count = self.reset_count + 1
				end
			end
		end

		showWaitDialogNoCircle("")
		NetMgr:registOpLuaFinishedCB(Net.OPT_TeamReset, opFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_TeamReset, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("cfg_camp_id", self.cfg_camp_id )
		NetMgr:executeOperate(Net.OPT_TeamReset, cj)
	end,

	callMember = function(self)
		local function opFinishCB(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				alert("两次发送间隔至少为1分钟")
			else
				alert("公告已发出")
			end
		end

		showWaitDialogNoCircle("")
		NetMgr:registOpLuaFinishedCB(Net.OPT_TeamCallMember, opFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_TeamCallMember, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("cfg_camp_id", self.cfg_camp_id )
		NetMgr:executeOperate(Net.OPT_TeamCallMember, cj)
	end,	
}

--精英副本
JingYingFubenPanel = {
	bg = nil,
	pageCount = 1,
	curPage = 1, --当前页
	total  = 0,

	create = function(self)
		self.bg = createDarkBG(927,540)
		self.bg:setPosition(CCPoint(40,40))
		self.camps = new({})
		
		for k,v in pairs(cfg_camp_data) do
			if GloblePlayerData.officium >= v.require_officium and v.type == 2 then
				self.total = self.total + 1
				table.insert(self.camps,v)
			end
		end
		table.sort(self.camps,function(a,b)
			return a.idx < b.idx
		end)
		
		self.pageCount = math.ceil(self.total / 8)

		local pageContainer = dbUIPanel:panelWithSize(CCSize(927 * self.pageCount,490))
		pageContainer:setAnchorPoint(CCPoint(0, 0))
		pageContainer:setPosition(0,0)

		for i=1,self.pageCount do
			local singlePage = dbUIPanel:panelWithSize(CCSize(927,490))
			singlePage:setAnchorPoint(CCPoint(0, 0))
			singlePage:setPosition((i-1)*927,0)
			self:loadPage(singlePage,i)
			pageContainer:addChild(singlePage)
		end

		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pageContainer, 1, self.pageCount)
		self.scrollArea:setAnchorPoint(CCPoint(0, 0))
		self.scrollArea:setScrollRegion(CCRect(0, 0, 927, 490))
		self.scrollArea:setPosition(0,540-490)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.curPage = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
		end
		self.bg:addChild(self.scrollArea)
		self:createPageDot(self.pageCount)

		self.scrollArea:scrollToPage(self.curPage-1,false)
		return self
	end,

	--加载某一页的数据
	loadPage = function(self,pagePanel,page)
		--判断每页的个数
		local page_size = 0
		if page < self.pageCount then
			page_size = 8
		else
			if self.total % 8 == 0 then
				page_size = 8
			else
				page_size = self.total % 8
			end
		end
		local order = self.order
		local dataStart = 8*(page-1)
		local row,column=1,0

		for i=1,page_size do
			local location = dataStart+i
			local item = self.camps[location]
			local name = item.name

			column = column+1
			if column>4 then
				row = row+1
				column=1
			end

			local itemPanel = dbUIPanel:panelWithSize(CCSize(195,195))
			itemPanel:setPosition(CCPoint(30+(column-1)*228,254-(row-1)*228))

			local itemBg = CCSprite:spriteWithFile("UI/fuben/yuan.png")
			itemBg:setPosition(195/2,195/2)
			itemBg:setScale(195/165)
			itemPanel:addChild(itemBg)
			
			local btn = dbUIButtonScale:buttonWithImage("FightResource/fuben/"..item.battle_thumb..".png", 1, ccc3(125, 125, 125))
			btn:setPosition(195/2,195/2)
			btn:setScale(195/165)
			btn.m_nScriptClickedHandler = function(ccp)
				createFubenFightPanel(item.cfg_camp_id)
			end
			itemPanel:addChild(btn)

			local name_bg = CCSprite:spriteWithFile("UI/fuben/name_bg.png")
			name_bg:setAnchorPoint(CCPoint(0.5, 0))
			name_bg:setPosition(CCPoint(195/2,20))
			itemPanel:addChild(name_bg)
			local name = CCLabelTTF:labelWithString(name, SYSFONT[EQUIPMENT], 22)
			name:setAnchorPoint(CCPoint(0.5, 0.5))
			name:setPosition(CCPoint(152/2,20))
			name:setColor(ccc3(253,204,102))
			name_bg:addChild(name)
			pagePanel:addChild(itemPanel)
		end
	end,

	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 50))
		self.form:setPosition(927/2, 0)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.bg:addChild(self.form)
		self.pageToggles = new({})
		for i=1, pageCount do
			local pageToggle = dbUIButtonToggle:buttonWithImage("UI/public/page_btn_normal.png","UI/public/page_btn_toggle.png")
			pageToggle:setPosition(CCPoint(52*(i-1),25) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
	end,
}
---精英副本怪物列表面板
local fightPanel = nil
local sweepArmy = 0 	--可以扫荡的怪数量
local winArmy = 0	 	--打赢过的怪数量

local parseJson = function(s,cfg_camp_id)
	local armyDataList = {}
	sweepArmy = 0
	
	local resetGold = s:getByKey("reset_gold"):asInt()

	--已经打过的怪
	local memRaidArmyList = s:getByKey("mem_raid_army_list")
	for i=1, memRaidArmyList:size() do
		local raidArmy = memRaidArmyList:getByIndex(i-1)
		local raidArmyId = raidArmy:getByKey("raid_army_id"):asInt()
		local fightCount = raidArmy:getByKey("fight_count"):asInt()

		local cfg_raid_army = cfg_army_data[raidArmyId]
		local armyData = new(cfg_raid_army)
		armyData.fightCount = fightCount
		armyData.cur = false
		table.insert(armyDataList, armyData)
		
		if fightCount==0 then
			sweepArmy = sweepArmy + 1
		end
	end
	winArmy = memRaidArmyList:size()
	
	--下一个可攻击的怪
	local camp_data = cfg_camp_data[cfg_camp_id]
	local raid_army_id_data = camp_data["cfg_army_data"]
	local raid_army_id_list = {}
	
	for i=1, #raid_army_id_data do
		local armyId = raid_army_id_data[i]
		local armyData = cfg_army_data[armyId]
		if armyData.level <= GloblePlayerData.officium then
			table.insert(raid_army_id_list,armyId)
		end
	end
	
	if memRaidArmyList:size() < #raid_army_id_list then
		local curArmyId = raid_army_id_list[memRaidArmyList:size()+1]
		local curArmyData = cfg_army_data[curArmyId]

		local armyData = new(curArmyData)
		armyData.fightCount = 0
		armyData.cur = true
		table.insert(armyDataList, armyData)
	end
	
	return armyDataList,camp_data,resetGold
end

local resetRequest = function(cfg_camp_id)
	local function opFinishCB(s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()
		if error_code ~= -1 then
			ShowErrorInfoDialog(error_code)
		else
			if fightPanel then
				local armyDataList,raid_data,resetGold = parseJson(s,cfg_camp_id)
				fightPanel:create(armyDataList,raid_data,resetGold)
			end
		end
	end

	showWaitDialogNoCircle("")
	NetMgr:registOpLuaFinishedCB(Net.OPT_RaidReset, opFinishCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_RaidReset, opFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	cj:setByKey("cfg_raid_id", cfg_camp_id)
	NetMgr:executeOperate(Net.OPT_RaidReset, cj)
end

local Panel = {
	mainWidget = nil,
	total = 0,
	curPage = 1,
	pageCount =1,

	create = function(self,armyData,campData,resetGold)
		self.campData = campData
		self.resetGold = resetGold
		self.armyData = armyData
		
		if not self.mainWidget then
			self:initBase()
		else
			self.mainWidget:removeAllChildrenWithCleanup(true)
		end

		self.bg = createDarkBG(927,540)
		self.bg:setPosition(CCPoint(40,40))
		self.mainWidget:addChild(self.bg)
		
		self.total = #armyData
		self.pageCount = math.ceil(self.total / 8)

		local pageContainer = dbUIPanel:panelWithSize(CCSize(927 * self.pageCount,490))
		pageContainer:setAnchorPoint(CCPoint(0, 0))
		pageContainer:setPosition(0,0)

		for i=1,self.pageCount do
			local singlePage = dbUIPanel:panelWithSize(CCSize(927,490))
			singlePage:setAnchorPoint(CCPoint(0, 0))
			singlePage:setPosition((i-1)*927,0)
			self:loadPage(singlePage,i,armyData)
			pageContainer:addChild(singlePage)
		end

		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pageContainer, 1, self.pageCount)
		self.scrollArea:setAnchorPoint(CCPoint(0, 0))
		self.scrollArea:setScrollRegion(CCRect(0, 0, 927, 490))
		self.scrollArea:setPosition(0,540-490)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.curPage = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
		end
		self.bg:addChild(self.scrollArea)
		self:createPageDot(self.pageCount)

		self.scrollArea:scrollToPage(self.curPage-1,false)
		return self
	end,

	loadPage = function(self,pagePanel,page,data)
		--判断每页的个数
		local page_size = 0
		if page < self.pageCount then
			page_size = 8
		else
			if self.total % 8 == 0 then
				page_size = 8
			else
				page_size = self.total % 8
			end
		end
		local dataStart = 8*(page-1)
		local row,column=1,0

		for i=1,page_size do
			local item = data[dataStart+i]
			local name = item.name

			column = column+1
			if column>4 then
				row = row+1
				column=1
			end

			local itemPanel = dbUIPanel:panelWithSize(CCSize(166,166))
			itemPanel:setPosition(CCPoint(30+(column-1)*228,254-(row-1)*228))
			pagePanel:addChild(itemPanel)

			local yuan = dbUIButtonScale:buttonWithImage("UI/fuben/yuan.png", 1, ccc3(125, 125, 125))
			yuan:setAnchorPoint(CCPoint(0.5, 0.5))
			yuan:setPosition(CCPoint(83,83))
			if item.cur then
				local fight_flag = CCSprite:spriteWithFile("UI/fight/fight_flag.png")
				fight_flag:setPosition(CCPoint(-15,195+15))
				fight_flag:setAnchorPoint(CCPoint(0,1))
				itemPanel:addChild(fight_flag)
			end
			itemPanel:addChild(yuan)
			
			local face = CCSprite:spriteWithFile("head/MonsterFull/head_full_"..item.face..".png")
			face:setPosition(CCPoint(83,83+20))
			face:setAnchorPoint(CCPoint(0.5,0.5))
			itemPanel:addChild(face)
			
			if item.fightCount > 0 then
				face:setColor(ccc3(60,60,60))
			else
				yuan.m_nScriptClickedHandler = function()
					globalFightDialogPanel = new(FightDialogPanel)
					globalFightDialogPanel:create(item,9,false)
				end
			end
			
			local name_bg = CCSprite:spriteWithFile("UI/fuben/name_bg.png")
			name_bg:setAnchorPoint(CCPoint(0.5, 0))
			name_bg:setPosition(CCPoint(83,20))
			itemPanel:addChild(name_bg)
			local name = CCLabelTTF:labelWithString(name, SYSFONT[EQUIPMENT], 22)
			name:setAnchorPoint(CCPoint(0.5, 0.5))
			name:setPosition(CCPoint(152/2,20))
			name:setColor(ccc3(253,204,102))
			name_bg:addChild(name)
		end
	end,

	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 50))
		self.form:setPosition(927/2, 0)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.bg:addChild(self.form)
		
		self.pageToggles = new({})
		for i=1, pageCount do
			local pageToggle = dbUIButtonToggle:buttonWithImage("UI/public/page_btn_normal.png","UI/public/page_btn_toggle.png")
			pageToggle:setPosition(CCPoint(52*(i-1),25) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		self.top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(self.top)

		--面板提示图标
		local title_tip_bg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		title_tip_bg:setPosition(CCPoint(0, 12))
		title_tip_bg:setAnchorPoint(CCPoint(0, 0))
		self.top:addChild(title_tip_bg)
		local label = CCLabelTTF:labelWithString(self.campData.name, SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setPosition(CCPoint(100,35))
		label:setColor(ccc3(255,203,153))
		title_tip_bg:addChild(label)

		--重置
--		if GloblePlayerData.vip_level>=4 and self.resetGold > 0 then
			local reset = dbUIButtonScale:buttonWithImage("UI/fuben/reset_btn.png", 1.2, ccc3(125, 125, 125))
			reset:setAnchorPoint(CCPoint(0.5,0.5))
			reset:setPosition(CCPoint(700, 44))
			reset.m_nScriptClickedHandler = function()
				if winArmy==0 then
					alertOK("不需要重置")
				elseif sweepArmy == winArmy then
					alertOK("不需要重置")
				elseif self.resetGold==0 then
					alertOK("重置次数到达上限")
				else
					new(ConfirmDialog):show({
						text = "确定花费"..self.resetGold.."金重置副本吗？",
						width = 440,
						onClickOk = function()
							resetRequest(self.campData.cfg_camp_id)
						end
					})
				end
			end
			self.top:addChild(reset)
--		end
		
		--扫荡
		local sweep = dbUIButtonScale:buttonWithImage("UI/fuben/sweep_btn.png", 1.2, ccc3(125, 125, 125))
		sweep:setAnchorPoint(CCPoint(0.5,0.5))
		sweep:setPosition(CCPoint(830, 44))
--		sweep:setIsVisible(#self.armyData>1)
		sweep.m_nScriptClickedHandler = function()
			if GloblePlayerData.action_point == 0 then
				alert("精力不足，无法扫荡")
				return
			end
			if sweepArmy == 0 then
				alertOK("没有可以扫荡的怪")
			else
				local max = math.floor(GloblePlayerData.action_point / 10)
				sweepArmy = math.min(max,sweepArmy)
				createFubenSaoDangPanel(self.campData.cfg_camp_id,self.armyData,sweepArmy)
			end
		end
		self.top:addChild(sweep)
--		self.sweepBtn = sweep
		
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.top:addChild(closeBtn.btn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
		fightPanel = nil
	end,
}

--有副本在扫荡，弹出小提示框
function ViewRaidSweeping()
	local scene = DIRECTOR:getRunningScene()
   	local bgLayer = createPanelBg()
    local uiLayer,centerWidget = createCenterWidget()
	scene:addChild(bgLayer, 1002)
	scene:addChild(uiLayer, 2002)

	local close = function()
		scene:removeChild(bgLayer)
		scene:removeChild(uiLayer)
	end
		
	local kuang = createBG("UI/public/tankuang_bg.png",440,160,CCSizeMake(80,80))
	kuang:setAnchorPoint(CCPoint(0.5,0.5))
	kuang:setPosition(CCPoint(1010/2, 702/2))
	kuang.m_nScriptClickedHandler = function()
		executeRaidSweepCheck()
		close()
	end
	centerWidget:addChild(kuang)

	local contentLabel = CCLabelTTF:labelWithString("精英副本正在扫荡中，点击查看", SYSFONT[EQUIPMENT], 24)
	contentLabel:setAnchorPoint(CCPoint(0.5,1))
	contentLabel:setPosition(CCPoint(440/2,130))
	contentLabel:setColor(ccc3(255,204,153))
	kuang:addChild(contentLabel)

	local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
	btn:setAnchorPoint(CCPoint(0.5,0))
	btn:setPosition(CCPoint(440/2,25))
	btn.m_nScriptClickedHandler = function()
		executeRaidSweepCheck()
		close()
	end
	kuang:addChild(btn)
	
	local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png", 1, ccc3(125, 125, 125))
	closeBtn:setPosition(CCPoint(420,140))
	closeBtn.m_nScriptClickedHandler = function()
		close()
	end
	kuang:addChild(closeBtn)
end

function createFubenFightPanel(cfg_camp_id)
	local function opFinishCB(s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()
		if error_code ~= -1 then
			if error_code == 457 then --有别的副本在扫荡
				ViewRaidSweeping()
			elseif error_code == 4571 then --进入的是当前扫荡的副本
				executeRaidSweepCheck()
			else
				ShowErrorInfoDialog(error_code)
			end
		else
			local armyDataList,raid_data,resetGold = parseJson(s,cfg_camp_id)
			
			if fightPanel == nil then
				fightPanel = new(Panel)
			end
			fightPanel:create(armyDataList,raid_data,resetGold)
		end
	end

	showWaitDialogNoCircle("wait raid data")
	NetMgr:registOpLuaFinishedCB(Net.OPT_RaidEnter, opFinishCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_RaidEnter, opFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	cj:setByKey("cfg_raid_id", cfg_camp_id)
	NetMgr:executeOperate(Net.OPT_RaidEnter, cj)
end
--精英副本扫荡 面板
local firstCheck = true

function createFubenSaoDangPanel(cfg_raid_id,armyData,sweepArmy)
	local panel = new(FubenSaoDangPanel)
	panel.armyData = armyData
	panel.sweepArmy = sweepArmy
	panel:create(cfg_raid_id)
end

FubenSaoDangPanel = {
	mainWidget = nil,
	sao_dang_ing = false,
	armyData = {},
	sweepArmy = 0,  --可以扫荡的怪数量
	curPage = 1,
	
	create = function(self,cfg_raid_id)
		if not self.mainWidget then
			self:initBase()
		end
		self.cfg_raid_id = cfg_raid_id
		self:createLeft()
		self:createRight()
		return self
	end,

	createLeft = function(self)
		self.left = createDarkBG(368,540)
		self.left:setPosition(CCPoint(40,40))
		self.mainWidget:addChild(self.left)

		self.UIList = dbUIList:list(CCRectMake(30, 10, 340, 430),0)
		self.left:addChild(self.UIList)

		local label = CCLabelTTF:labelWithString("扫荡说明：",CCSize(330,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(30,515))
		label:setColor(ccc3(255,203,153))
		self.left:addChild(label)
		self.labelDescTitle = label

		local label = CCLabelTTF:labelWithString(FUBEN_SAODAN,CCSize(600, 0),0,SYSFONT[EQUIPMENT],32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(30,478))
		label:setColor(ccc3(255,203,153))
		label:setIsVisible(false)
		self.left:addChild(label)
		self.labelSweeping = label
		
		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(364/28)
		line:setPosition(2,458)
		self.left:addChild(line)
		
		local label = CCLabelTTF:labelWithString("1、挂机扫荡时，请保证背包有足够空间来拾取奖励物品。 \n\n2、可关闭扫荡界面进行其他操作 ，但扫荡过程中不能再进行关卡或副本的战斗。",CCSize(330,0),0, SYSFONT[EQUIPMENT], 24)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(30,450))
		label:setColor(ccc3(255,203,153))
		self.left:addChild(label)
		self.labelDesc = label	
	end,

	createRight = function(self)
		self.right = createDarkBG(530,540)
		self.right:setPosition(CCPoint(430,40))
		self.mainWidget:addChild(self.right)

		local label = CCLabelTTF:labelWithString("扫荡怪物："..self.sweepArmy,CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(34,490))
		label:setColor(ccc3(255,204,103))
		self.right:addChild(label)
		self.labelSweepArmyCount = label
		
		local label = CCLabelTTF:labelWithString("扫荡时间：",CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(34,450))
		label:setColor(ccc3(255,204,103))
		self.right:addChild(label)

		local label = CCLabelTTF:labelWithString((self.sweepArmy * 3).."分钟",CCSize(400,0),0, SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(180,450))
		label:setColor(ccc3(153,204,1))
		self.right:addChild(label)
		self.labelCooldown = label
		
		self:createDrop()
		self:createFootBtn()
	end,

	setTimeLeft = function(self,jValue)
		self.timeLimit = math.floor(jValue:getByKey("raid_sweep_cooldown"):asDouble())
	end,

	--开始扫荡后，更新一些状态
	afterStartSweep = function(self,jValue)
		self.sao_dang_ing = true
		self.UIList:removeAllWidget(true)
		
		self.labelDescTitle:setIsVisible(false)
		self.labelDesc:setIsVisible(false)
		self.labelSweeping:setIsVisible(true)

		self.startBtn:setIsVisible(false)
		self.finishBtn:setIsVisible(true)
		self.closeBtn:setIsVisible(true)
		self.times = 0

		self:setTimeLeft(jValue)
		self.labelCooldown:setString(getLenQueTime(self.timeLimit))
		
		if self.timeLimit==0 then
			self:finishSweep()
			return
		end
		
		local function opFinishCB(s)
			local sweep_success_time = s:getByKey("sweep_success_time"):asInt()
			self.sweepArmy = self.sweepArmy - sweep_success_time
				
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				self:finishSweep()
				if error_code == 2001 or error_code == 252 then
					self:updateReword(s)
				end
				ShowErrorInfoDialog(error_code)
			else
				self:updateReword(s)
				self.times = self.times + s:getByKey("all_rewards"):size()
				self:setTimeLeft(s)
			end
		end
				
		local callSweepCheck = function()
			NetMgr:registOpLuaFinishedCB(Net.OPT_RaidSweepCheckSimple, opFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_RaidSweepCheckSimple, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("first_check", firstCheck)
			NetMgr:executeOperate(Net.OPT_RaidSweepCheckSimple, cj)
		end
				
		local dot = 0
		local setLenQueTime = function()
			if self.timeLimit > 0 then
				self.timeLimit = self.timeLimit - 1
				self.labelCooldown:setString(getLenQueTime(self.timeLimit))
				---三分钟一个怪,推后1秒发
				if (self.timeLimit+1) % 20 ==0 then
					callSweepCheck()
				end
			else
				self.sweepArmy = 0
				self:finishSweep()
				return
			end

			if dot == 1 then
				self.labelSweeping:setString(FUBEN_SAODAN..".")
				dot = dot + 1
			elseif dot == 2 then
				self.labelSweeping:setString(FUBEN_SAODAN.."..")
				dot = dot + 1
			else
				self.labelSweeping:setString(FUBEN_SAODAN.."...")
				dot = 1
			end
		end
		if self.timeHandle == nil then
			self.timeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
		end
		if self.checkHandle == nil then
			self.checkHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(callSweepCheck,30,false)
		end
	end,

	finishSweep = function(self)
		if self.timeHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
			self.timeHandle = nil
		end
		if self.checkHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.checkHandle)
			self.checkHandle = nil
		end
		
		self.sao_dang_ing = false
		
		self.UIList:removeAllWidget(true)
		
		self.labelDescTitle:setIsVisible(true)
		--self.labelDesc:setIsVisible(true)
		self.labelSweeping:setIsVisible(false)
		
		self.startBtn:setIsVisible(true)
		self.finishBtn:setIsVisible(false)
		self.closeBtn:setIsVisible(false)
		
		self.labelSweepArmyCount:setString("扫荡怪物："..self.sweepArmy)
		self.labelCooldown:setString((self.sweepArmy * 3).."分钟")
	end,

	updateReword = function(self,s)
		local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
						
		for i=1, s:getByKey("all_rewards"):size() do
			local rewordStr = "第"..(i+self.times).."个怪扫荡完成。\n"
			local v = s:getByKey("all_rewards"):getByIndex(i-1)

			if v:getByKey("reward_copper"):asInt() ~= 0 then
				rewordStr = rewordStr.."获得了"..v:getByKey("reward_copper"):asInt().."银币。\n"
			end
			if v:getByKey("reward_exploit"):asInt() ~= 0 then
				rewordStr = rewordStr.."获得了"..v:getByKey("reward_exploit"):asInt().."战功。\n"
			end			
			if v:getByKey("reward_prestige"):asInt() ~= 0 then
				rewordStr = rewordStr.."获得了"..v:getByKey("reward_prestige"):asInt().."神力。\n"
			end

			for j=1, v:getByKey("reward_item_list"):size() do
				local cfg_item_id = v:getByKey("reward_item_list"):getByIndex(j-1):getByKey("reward_cfg_item_id"):asInt()
				local amount = v:getByKey("reward_item_list"):getByIndex(j-1):getByKey("reward_amount"):asInt()
				local name = itemJsonConfig:getByKey(cfg_item_id..""):getByKey("name"):asString()
				rewordStr = rewordStr.."获得了"..name.."*"..amount.."。\n"
			end
			rewordStr = rewordStr.."\n\n"
			
			local label = CCLabelTTF:labelWithString(rewordStr,CCSize(300, 0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT],22)
			label:setAnchorPoint(CCPoint(0,1))
			label:setColor(ccc3(255,203,153))
			self.UIList:insterWidgetAtID(dbUIWidget:widgetWithSprite(label), self.UIList:getContent())
			
			globalGetRewardItem(v)
		end
		
		executeRoleSimple()
	end,

	getDropItems = function(self)
		local dropItems = {}
		for i=1,#self.armyData do
			if i > self.sweepArmy then break end
			
			local army = self.armyData[i]
			if army.reward_item>0 and army.cur==false and army.fightCount==0 then
				table.insert(dropItems,army.reward_item)
			end	
		end
		return dropItems
	end,

	--掉落物品
	createDrop = function(self)
		local label = CCLabelTTF:labelWithString("概率掉落：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(30,370))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)
		
		local dropItems = self:getDropItems()

		self.total = #dropItems
		self.pageCount = math.ceil(self.total / 8)
		
		local pageContainer = dbUIPanel:panelWithSize(CCSize(480 * self.pageCount,215))
		pageContainer:setAnchorPoint(CCPoint(0, 0))
		pageContainer:setPosition(0,0)

		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pageContainer, 1, self.pageCount)
		self.scrollArea:setAnchorPoint(CCPoint(0, 0))
		self.scrollArea:setScrollRegion(CCRect(0, 0, 480, 215))
		self.scrollArea:setPosition(30,140)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.curPage = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
		end
		self.right:addChild(self.scrollArea)

		for page=1,self.pageCount do
			local singlePage = dbUIPanel:panelWithSize(CCSize(480,215))
			singlePage:setAnchorPoint(CCPoint(0, 0))
			singlePage:setPosition((page-1)*480,0)
			pageContainer:addChild(singlePage)
			
			for k=1, 8 do
				local row =  math.ceil(k / 4)
				local column = k-(row-1)*4
	
				local kuang_96_96 = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
				kuang_96_96:setPosition(0,0)
				kuang_96_96:setAnchorPoint(CCPoint(0, 0))
				
				local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
				kuang:setAnchorPoint(CCPoint(0, 0))
				kuang:setPosition((column-1)*122, 114-(row-1)*110)
				kuang:addChild(kuang_96_96)
				singlePage:addChild(kuang)
				
				local index = (page-1)*8 + k
				if index <= #dropItems then
					local dropWood = getItemBorder(dropItems[index])
					dropWood:setAnchorPoint(CCPoint(0.5, 0.5))
					dropWood:setPosition(CCPoint(48,48))
					kuang:addChild(dropWood)
				end
			end
		end
		
		self:createPageDot(self.pageCount)
	end,

	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		if pageCount < 1 then return end
		
		local width = pageCount*33 + (pageCount-1)*19
		local form = dbUIPanel:panelWithSize(CCSize(width, 50))
		form:setPosition(530/2, 90)
		form:setAnchorPoint(CCPoint(0.5,0))
		self.right:addChild(form)
		
		self.pageToggles = new({})
		for i=1, pageCount do
			local pageToggle = dbUIButtonToggle:buttonWithImage("UI/public/page_btn_normal.png","UI/public/page_btn_toggle.png")
			pageToggle:setPosition(CCPoint(52*(i-1),25) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
	end,
	
	--按钮
	createFootBtn = function(self)
		local btnPanel = dbUIPanel:panelWithSize(CCSize(450, 100))
		btnPanel:setIsVisible(true)
		btnPanel:setAnchorPoint(CCPoint(0.5, 0))
		btnPanel:setPosition(CCPoint(530/2 , 0))
		self.right:addChild(btnPanel)

		--开始扫荡
		local btn = dbUIButtonScale:buttonWithImage("UI/fuben/start_sd.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(450/2,100/2))
		btn.m_nScriptClickedHandler = function(ccp)
			if GloblePlayerData.action_point == 0 then
				alert("精力不足，无法扫荡")
				return
			end
			if GloblePlayerData.cell_count - getBaoguoItemCount() < 5 then
				new(ConfirmDialog):show({
					text = "背包剩余空间不多，是否继续？",
					width = 480,
					color = ccc3(253,205,156),
					onClickOk = function()
						self:startRaidSweep()
					end
				})
			else
				self:startRaidSweep()
			end
		end
		btnPanel:addChild(btn)
		self.startBtn = btn

		local btn = dbUIButtonScale:buttonWithImage("UI/fuben/sssd.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0,0.5))
		btn:setPosition(CCPoint(40,106/2))
		btn:setIsVisible(false)
		btn.m_nScriptClickedHandler = function(ccp)
			local cost = self.sweepArmy * 3
			new(ConfirmDialog):show({
				text = "是否花费"..cost.."金币快速完成扫荡？",
				width = 480,
				color = ccc3(253,205,156),
				onClickOk = function()
					self:fastSweep()
				end
			})
		end
		btnPanel:addChild(btn)
		self.finishBtn = btn

		--取消扫荡
		local btn = dbUIButtonScale:buttonWithImage("UI/fuben/cancel.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(1,0.5))
		btn:setPosition(CCPoint(410,106/2))
		btn:setIsVisible(false)
		btn.m_nScriptClickedHandler = function(ccp)
			new(ConfirmDialog):show({
				text = "真的要取消本次扫荡吗？",
				width = 400,
				color = ccc3(253,205,156),
				onClickOk = function()
					self:cancelSweep()
				end
			})
		end
		btnPanel:addChild(btn)
		self.closeBtn = btn
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1002)
		scene:addChild(self.uiLayer, 2002)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		self.top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(self.top)

		--面板提示图标
		local title_tip_bg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		title_tip_bg:setPosition(CCPoint(0, 12))
		title_tip_bg:setAnchorPoint(CCPoint(0, 0))
		self.top:addChild(title_tip_bg)
		local label = CCLabelTTF:labelWithString("副本扫荡", SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setPosition(CCPoint(100,35))
		label:setColor(ccc3(255,203,153))
		title_tip_bg:addChild(label)
		--关闭按钮

		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.top:addChild(closeBtn.btn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		if self.timeHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
			self.timeHandle = nil
		end
		if self.checkHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.checkHandle)
			self.checkHandle = nil
		end
		--createFubenFightPanel(self.cfg_raid_id)
	end,
	
	--神速扫荡
	fastSweep = function(self)
		local opFinishCB = function(s)
			closeWait()
			
			local sweep_success_time = s:getByKey("sweep_success_time"):asInt()
			self.sweepArmy = self.sweepArmy - sweep_success_time
			
			self:finishSweep()
			
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				if error_code == 2001 or error_code == 252 then
					self:updateReword(s)
				end
				ShowErrorInfoDialog(error_code)
			else
				self.timeLimit = 0
				self:updateReword(s)
				
				if error_code == 2001 then
					alert("背包已满，停止扫荡")
				end
			end
		end

		local executeFastSweep = function()
			showWaitDialog("waiting RaidSpike data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_RaidSweepSpikeSimple, opFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_RaidSweepSpikeSimple, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(Net.OPT_RaidSweepSpikeSimple, cj)
		end
		executeFastSweep()
	end,

	--取消扫荡
	cancelSweep = function(self)
		local opFinishCB = function(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				self:destroy()
			end
		end
		local executeCancelSweep = function()
			showWaitDialog("waiting RaidCancle data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_RaidSweepCancle, opFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_RaidSweepCancle, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(Net.OPT_RaidSweepCancle, cj)
		end
		executeCancelSweep()
	end,

	--开始扫荡
	startRaidSweep = function(self)
		local opFinishCB = function(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				self:afterStartSweep(s)
			end
		end

		local executeRaidSweep = function()
			showWaitDialog("waiting RaidCancle data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_RaidSweep, opFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_RaidSweep, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("type", 0)
			cj:setByKey("cfg_raid_id", self.cfg_raid_id)
			NetMgr:executeOperate(Net.OPT_RaidSweep, cj)
		end
		executeRaidSweep()
	end,	
}

function executeRaidSweepCheck(silent)
	--是否打开扫荡界面，主界面关闭扫荡提示的时候这个参数会是 true
	if silent == nil then silent = false end
	
	local function opFinishCB(s)
		local error_code = s:getByKey("error_code"):asInt()
		if error_code ~= -1 then
			ShowErrorInfoDialog(error_code)
		else
			GloblePlayerData.action_point = s:getByKey("action_point"):asInt()
			
			if silent then
				local reward_list = s:getByKey("all_rewards")
				for i = 1, reward_list:size() do
					local v = reward_list:getByIndex(i - 1)
					globalGetRewardItem(v)
				end
				executeRoleSimple()	--可能升级，需要更新信息
			else
				local armyDataList = {}
				local sweepArmy = 0
				local memRaidArmyList = s:getByKey("mem_raid_army_list")
				for i=1, memRaidArmyList:size() do
					local raidArmy = memRaidArmyList:getByIndex(i-1)
					local raidArmyId = raidArmy:getByKey("raid_army_id"):asInt()
					local fightCount = raidArmy:getByKey("fight_count"):asInt()
	
					local cfg_raid_army = cfg_army_data[raidArmyId]
					
					local armyData = new(cfg_raid_army)
					armyData.fightCount = fightCount
					armyData.cur = false
					
					table.insert(armyDataList, armyData)
					
					if fightCount == 0 then
						sweepArmy = sweepArmy + 1
					end
				end	
				
				local max = math.floor(GloblePlayerData.action_point / 10)
				sweepArmy = math.min(max,sweepArmy)
				
				local panel = new(FubenSaoDangPanel)
				panel.armyData = armyDataList
				panel.sweepArmy = sweepArmy
				panel:create(s:getByKey("raid_sweep_id"):asInt())
				panel:afterStartSweep(s)
				panel:updateReword(s)
				panel.times = panel.times + s:getByKey("all_rewards"):size()
			end
		end
	end

	NetMgr:registOpLuaFinishedCB(Net.OPT_RaidSweepCheckSimple, opFinishCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_RaidSweepCheckSimple, opFailedCB)
	
	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	cj:setByKey("first_check", firstCheck)
	NetMgr:executeOperate(Net.OPT_RaidSweepCheckSimple, cj)
	firstCheck = false
end
--竞技场面板
function globleCreateArena()
	local function opLeiTaiFinishCB(s)
		closeWait()
		if s:getByKey("error_code"):asInt() == -1 then
			if GlobleArenaPanel ~= nil then
				GlobleArenaPanel:destroy()
				GlobleArenaPanel = nil
			end
			GlobleArenaPanel = new(ArenaPanel)
			GlobleArenaPanel:create(s)
			GotoNextStepGuide()
		else
			ShowErrorInfoDialog(error_code)
		end
	end

	local function execLeiTai()
		if dbSceneMgr:getSingletonPtr():getMainScene() ~= nil then
			showWaitDialog("waiting arena data")
		end
		NetMgr:registOpLuaFinishedCB(Net.OPT_Arena, opLeiTaiFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_Arena, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code",ClientData.request_code)

		NetMgr:executeOperate(Net.OPT_Arena, cj)
	end
	execLeiTai()
end

ArenaPanel = {
	data  =       nil,
	currentRank = nil, --当前排名
	currentPoint = nil,	--当前积分
	rewardSliver = nil, --奖励银币
	rewardCoolDown = nil, --可领取奖励剩余时间
	rewardCopper = nil,		--可领取奖励数额
	
	initData = function(self,data)
		self.data = data
		self.currentRank = data:getByKey("arena_rank"):asInt()
		self.rewardSliver = data:getByKey("arena_rank_copper"):asInt()
		self.rewardCoolDown = data:getByKey("arena_reward_cooldown"):asDouble() / 1000
	end,

	create = function(self,data)
		self:initData(data)
		self:initBase()

		self:Announce()
		self:createMid()
		self:createFoot(data)
		return self
	end,

	--创建底部
	createFoot = function(self,data)
		local panel = dbUIPanel:panelWithSize(CCSize(938,210))
		panel:setAnchorPoint(CCPoint(0,0))
		panel:setPosition(CCPoint(35,35))
		self.mainWidget:addChild(panel)

		local label = CCLabelTTF:labelWithString("胜场: ",CCSize(300,0),0,SYSFONT[EQUIPMENT],26)
		label:setColor(ccc3(244,196,147))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(30,175))
		panel:addChild(label)
		local label = CCLabelTTF:labelWithString(data:getByKey("arena_win_count"):asInt(),CCSize(300,0),0,SYSFONT[EQUIPMENT],26)
		label:setColor(ccc3(235,172,0))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(100,175))
		panel:addChild(label)

		local label = CCLabelTTF:labelWithString("失败: ",CCSize(300,0),0,SYSFONT[EQUIPMENT],26)
		label:setColor(ccc3(244,196,147))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(30,175-30*1))
		panel:addChild(label)
		local label = CCLabelTTF:labelWithString(data:getByKey("arena_loss_count"):asInt(),CCSize(300,0),0,SYSFONT[EQUIPMENT],26)
		label:setColor(ccc3(235,172,0))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(100,175-30*1))
		panel:addChild(label)

		local label = CCLabelTTF:labelWithString("积分: ",CCSize(300,0),0,SYSFONT[EQUIPMENT],26)
		label:setColor(ccc3(244,196,147))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(30,175-30*2))
		panel:addChild(label)
		
		self.currentPoint = data:getByKey("arena_point"):asInt();
		local label = CCLabelTTF:labelWithString(self.currentPoint,CCSize(300,0),0,SYSFONT[EQUIPMENT],26)
		label:setColor(ccc3(235,172,0))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(100,175-30*2))
		panel:addChild(label)
		self.arena_point_label = label

		--[[
		local label = CCLabelTTF:labelWithString("当日排名: ",CCSize(300,0),0,SYSFONT[EQUIPMENT],26)
		label:setColor(ccc3(244,196,147))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(30,175-30*3))
		panel:addChild(label)
		local label = CCLabelTTF:labelWithString(data:getByKey("arena_daily_rank"):asInt(),CCSize(300,0),0,SYSFONT[EQUIPMENT],26)
		label:setColor(ccc3(235,172,0))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(145,175-30*3))
		panel:addChild(label)]]--

		--查看所有排名
		local btn = dbUIButtonScale:buttonWithImage("UI/arena/rank.png",1,ccc3(244,196,147))
		btn:setPosition(CCPoint(30+152/2, 175-30*4-10))
		btn.m_nScriptClickedHandler = function()
			globleArenaPaiHangPanel()
			--globleShowRankPanel()
		end
		panel:addChild(btn)
		self.foot_panel = panel
		self:createPlayers(data)
	end,

	--创建对手
	createPlayers = function(self,data)
		local panel = self.foot_panel

		for i = 1,data:getByKey("opponent_list"):size() do
			local mdata = data:getByKey("opponent_list"):getByIndex(i-1)

			local headPanel = dbUIPanel:panelWithSize(CCSize(94,94))
			headPanel:setAnchorPoint(CCPoint(0,0))
			headPanel:setPosition(CCPoint(250 + (i-1)*140,96))
			panel:addChild(headPanel)

			local kuang = CCSprite:spriteWithFile("UI/public/kuang_94_94.png")
			kuang:setAnchorPoint(CCPoint(0,0))
			kuang:setPosition(CCPoint(0,0))
			headPanel:addChild(kuang)

			local role_id = mdata:getByKey("id"):asInt()
			local arena_count = data:getByKey("arena_count"):asInt()
			local btn = dbUIButtonScale:buttonWithImage("head/Middle/head_middle_"..(mdata:getByKey("face"):asInt())..".png",1,ccc3(244,196,147))
			btn:setAnchorPoint(CCPoint(0.5,0.5))
			btn:setPosition(CCPoint(94/2,94/2))
			btn.m_nScriptClickedHandler = function()
				if checkFormationIsEmpty() then
					return
				end
				local function opChallengeOpponentFinishCB(s)
					if s:getByKey("error_code"):asInt() == -1 then
						if self.mainWidget then
							self.lenQueTime = 0
							self.foot_panel:removeAllChildrenWithCleanup(true)
							self:createFoot(s)
						end
					else
						ShowErrorInfoDialog(error_code)
					end
					
					GotoNextStepGuide()
				end

				local function excuteChallengeOpponent()
					NetMgr:registOpLuaFinishedCB(Net.OPT_ArenaBattle, opChallengeOpponentFinishCB)
					NetMgr:registOpLuaFailedCB(Net.OPT_ArenaBattle, opFailedCB)
					NetMgr:setOpUnique(Net.OPT_ArenaBattle)
					
					GlobleSetCanSeeResult(0)  --竞技场不能直接看结果
					dbSceneMgr:getSingletonPtr():changeToBattleScene(role_id)
				end

				local function checkVipLevel(arena_count)  --当前vip等级竞技场次数是否用完
					if arena_count >= 10 and GloblePlayerData.vip_level < 1 then
						return true
					end
					if arena_count >= 12 and GloblePlayerData.vip_level < 3 then
						return true
					end
					if arena_count >= 15 and GloblePlayerData.vip_level < 5 then
						return true
					end
					if arena_count >= 20 and GloblePlayerData.vip_level < 7 then
						return true
					end
					return false
				end

				if arena_count < 10 then
					excuteChallengeOpponent()
				else
					local count = arena_count - 10

					if count >= 5 then
						count = 4
					end

					local dtp = new(DialogTipPanel)
					dtp:create(LEITEI_FREE1..(10 + count*5)..LEITEI_FREE2,ccc3(255,204,153),180)
					dtp.okBtn.m_nScriptClickedHandler = function()
						dtp:destroy()
						excuteChallengeOpponent()
					end
				end
			end
			headPanel:addChild(btn)
			if i == 1 then
				self.firstArenaPlayer = btn
			end
			
			local label = CCLabelTTF:labelWithString(mdata:getByKey("name"):asString(),CCSize(200,0),0,SYSFONT[EQUIPMENT],22)
			label:setColor(ccc3(1,153,203))
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(0,-5))
			headPanel:addChild(label)

			local label = CCLabelTTF:labelWithString("排名: ",CCSize(150,0),0,SYSFONT[EQUIPMENT],22)
			label:setColor(ccc3(244,196,147))
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(250+ (i-1)*140,40))
			panel:addChild(label)
			
			local rank = mdata:getByKey("arena_rank"):asInt()
			
			local label = CCLabelTTF:labelWithString(rank,CCSize(150,0),0,SYSFONT[EQUIPMENT],22)
			label:setColor(ccc3(235,172,0))
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(250+55+ (i-1)*140,40))
			panel:addChild(label)

			local label = CCLabelTTF:labelWithString("神位: ",CCSize(150,0),0,SYSFONT[EQUIPMENT],22)
			label:setColor(ccc3(244,196,147))
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(250+ (i-1)*140,10))
			panel:addChild(label)
			local label = CCLabelTTF:labelWithString(mdata:getByKey("officium"):asInt(),CCSize(150,0),0,SYSFONT[EQUIPMENT],22)
			label:setColor(ccc3(235,172,0))
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(250+55+ (i-1)*140,10))
			panel:addChild(label)
		end
	end,

	createMid = function(self)
		local data = self.data
		
		local label = CCLabelTTF:labelWithString("免费剩余次数：",CCSize(250,0),0,SYSFONT[EQUIPMENT],22)
		label:setColor(ccc3(244,196,147))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(440,290))
		self.mainWidget:addChild(label)
		
		
		local finishcount=data:getByKey("arena_count"):asInt()
		if finishcount>10 then
			finishcount=10
		end
		local label = CCLabelTTF:labelWithString(10 -finishcount ,CCSize(100,0),0,SYSFONT[EQUIPMENT],22)
		label:setColor(ccc3(153,205,0))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(590,290))
		self.mainWidget:addChild(label)
        

		self.combatLenQueTime = math.ceil((data:getByKey("arena_battle_cooldown"):asDouble() - data:getByKey("server_time"):asDouble() )/ 1000) --战斗冷却时间
		if self.combatLenQueTime >0 then
			local label = CCLabelTTF:labelWithString("冷却时间：",CCSize(250,0),0,SYSFONT[EQUIPMENT],22)
			label:setColor(ccc3(244,196,147))
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(440,260))
			self.mainWidget:addChild(label)
			self.combatLenQueTimeTx = label
			local label = CCLabelTTF:labelWithString(getLenQueTime(self.combatLenQueTime),CCSize(100,0),0,SYSFONT[EQUIPMENT],22)
			label:setColor(ccc3(255,102,2))
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(590,260))
			self.mainWidget:addChild(label)
			self.combatLenQueTimeTxValue = label

			local combatLenQueTimeBack = function()
				if self.combatLenQueTime > 0 then
					self.luequeBtn:setIsVisible(true)
					self.combatLenQueTimeTx:setIsVisible(true)
					self.combatLenQueTimeTxValue:setIsVisible(true)
					self.combatLenQueTime = self.combatLenQueTime - 1
				else
					self.luequeBtn:setIsVisible(false)
					self.combatLenQueTimeTx:setIsVisible(false)
					self.combatLenQueTimeTxValue:setIsVisible(false)
					CCScheduler:sharedScheduler():unscheduleScriptEntry(self.combatLenQueTimeHandle)
					self.combatLenQueTimeHandle = nil
				end
				self.combatLenQueTimeTxValue:setString(getLenQueTime(self.combatLenQueTime))
			end
			self.combatLenQueTimeHandle  = CCScheduler:sharedScheduler():scheduleScriptFunc(combatLenQueTimeBack,1,false)
			--冷却
			self.luequeBtn = dbUIButtonScale:buttonWithImage("UI/arena/cooldown.png",1,ccc3(244,196,147))
			self.luequeBtn:setPosition(CCPoint(720, 290))
			self.luequeBtn.m_nScriptClickedHandler = function()
				local dtp = new(DialogTipPanel)
				dtp:create("是否花 "..(math.ceil(self.combatLenQueTime/60)).." 金币 清除冷却",ccc3(255,204,153),180)
				dtp.okBtn.m_nScriptClickedHandler = function()
					self:LenQue()
					dtp:destroy()
				end
			end
			self.mainWidget:addChild(self.luequeBtn)
		end

		--原刷新选手功能，替换为积分商城
		local scoreMallBtn = dbUIButtonScale:buttonWithImage("UI/arena/score_mall.png",1,ccc3(244,196,147))
		scoreMallBtn:setPosition(CCPoint(876, 290))
		scoreMallBtn.m_nScriptClickedHandler = function()
			--服务器返回后进入商城
			self:gotoScoreMall()
		end
		self.mainWidget:addChild(scoreMallBtn)
		self.scoreMallBtn = scoreMallBtn
	end,

	LenQue = function(self)
		local function opLenQueFinishCB(s)
			if s:getByKey("error_code"):asInt() == -1 then
				self.combatLenQueTime = 0
		        GloblePlayerData.gold = s:getByKey("gold"):asInt()
				updataHUDData()
			else
				ShowErrorInfoDialog(error_code)
			end
		end

		local function execLenQue()
			NetMgr:registOpLuaFinishedCB(Net.OPT_ArenaSpike, opLenQueFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_ArenaSpike, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			NetMgr:setOpUnique(Net.OPT_ArenaSpike)
			NetMgr:executeOperate(Net.OPT_ArenaSpike, cj)
		end
		execLenQue()
	end,
	
	--通过服务器回调进入积分商城
	gotoScoreMall = function(self)
		local function opGotoScoreMallFinishCB(s)
			if s:getByKey("error_code"):asInt() == -1 then
				GlobleArenaScoreMallPanel = new(ArenaScoreMallPanel):create(s)
				GotoNextStepGuide()
			else
				ShowErrorInfoDialog(error_code)
			end
		end
		
		local function execGotoScoreMall()
			NetMgr:registOpLuaFinishedCB(Net.OPT_ArenaScoreMall, opGotoScoreMallFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_ArenaScoreMall, opFailedCB)
			
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			
			NetMgr:setOpUnique(Net.OPT_ArenaScoreMall)
			NetMgr:executeOperate(Net.OPT_ArenaScoreMall, cj)
		end
		execGotoScoreMall()
	end,
	
	---公告
	Announce = function(self)
		local label = CCLabelTTF:labelWithString("",CCSize(310,130),0,SYSFONT[EQUIPMENT],22)
		label:setColor(ccc3(1,153,203))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(290,446))
		self.mainWidget:addChild(label)

		local function opAnnounceFinishCB(s)
			if s:getByKey("error_code"):asInt() == -1 then
				label:setString(s:getByKey("arena_announce"):asString())
				self:ZhanBao()
			else
				ShowErrorInfoDialog(error_code)
			end
		end

		local function opAnnounceFailedCB(s)
			self:ZhanBao()
		end

		local function execAnnounce()
			NetMgr:registOpLuaFinishedCB(Net.OPT_ArenaAnnounce, opAnnounceFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_ArenaAnnounce, opAnnounceFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)

			NetMgr:setOpUnique(Net.OPT_ArenaAnnounce)
			NetMgr:executeOperate(Net.OPT_ArenaAnnounce, cj)
		end
		execAnnounce()
	end,

	ZhanBao = function(self)
		local function opZhanBaoFinishCB(s)
			if s:getByKey("error_code"):asInt() == -1 then
				if self.mainWidget then
					self:createZhanBaoSimple(s)
				end
			else
				ShowErrorInfoDialog(error_code)
			end
		end

		local function execZhanBao()
			NetMgr:registOpLuaFinishedCB(Net.OPT_ArenaReplay, opZhanBaoFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_ArenaReplay, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)

			NetMgr:setOpUnique(Net.OPT_ArenaReplay)
			NetMgr:executeOperate(Net.OPT_ArenaReplay, cj)
		end
		execZhanBao()
	end,

	--战报
	createZhanBaoSimple = function(self,data)
		self.zhangBaoTx = new({})
		self.zhangBaoBtn = new({})

		local scroll_list =  dbUIList:list(CCRectMake(600,443,380,156),0);
		self.mainWidget:addChild(scroll_list)

		local cnt = 0
		for i = math.max(data:getByKey("replays"):size()-1,1), data:getByKey("replays"):size() do
			cnt = cnt + 1
			local mdata = data:getByKey("replays"):getByIndex(i-1)
			if (mdata ~= nil) and (mdata:getByKey("target_name"):asString() ~= nil) and (mdata:getByKey("target_name"):asString() ~= "") then
				local itemPanel = dbUIPanel:panelWithSize(CCSize(380,40))

				local label = CCLabelTTF:labelWithString("你",CCSize(150,0),0,SYSFONT[EQUIPMENT],22)
				label:setColor(ccc3(255,102,2))
				label:setAnchorPoint(CCPoint(0,0.5))
				label:setPosition(CCPoint(0,20))
				itemPanel:addChild(label)

				if mdata:getByKey("is_win"):asBool() == true then
					label = CCLabelTTF:labelWithString("打败了",CCSize(150,0),0, SYSFONT[EQUIPMENT], 22)
					label:setColor(ccc3(161,208,0))
				else
					label = CCLabelTTF:labelWithString("输给了",CCSize(150,0),0, SYSFONT[EQUIPMENT], 22)
					label:setColor(ccc3(103,102,100))
				end
				label:setAnchorPoint(CCPoint(0,0.5))
				label:setPosition(CCPoint(30,20))
				itemPanel:addChild(label)

				local label = CCLabelTTF:labelWithString((mdata:getByKey("target_name"):asString()),CCSize(300,0),0,SYSFONT[EQUIPMENT],22)
				label:setColor(ccc3(255,102,2))
				label:setAnchorPoint(CCPoint(0,0.5))
				label:setPosition(CCPoint(100,20))
				itemPanel:addChild(label)

				local repName = mdata:getByKey("replay_name"):asString()
				local label = CCLabelTTF:labelWithString("【查看】",CCSize(0,0),0, SYSFONT[EQUIPMENT], 24)
				label:setAnchorPoint(CCPoint(1,0.5))
				label:setPosition(CCPoint(380,20))
				label:setColor(ccc3(255,102,2))

				itemPanel.m_nScriptClickedHandler = function()
					Log("【查看】")
					showWaitDialog("waiting replay data")
					NetMgr:registOpLuaFinishedCB(Net.OPT_GetReplay, opFailedCB)
					NetMgr:registOpLuaFailedCB(Net.OPT_GetReplay, opFailedCB)
					GlobleSetCanSeeResult(1)
					dbSceneMgr:getSingletonPtr():changeToBattleScene(repName)
				end
				itemPanel:addChild(label)
				scroll_list:insterWidgetAtID(itemPanel,0)
			end
		end
	end,

	createTop = function(self)
		local top = dbUIPanel:panelWithSize(CCSize(1010,106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)

		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setPosition(CCPoint(952, 35+10))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
			GotoNextStepGuide()
		end
		top:addChild(closeBtn)
		self.closeBtn = closeBtn

		--面板提示图标
		local title_tip_bg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		title_tip_bg:setPosition(CCPoint(0, 35+10))
		title_tip_bg:setAnchorPoint(CCPoint(0,0.5))
		top:addChild(title_tip_bg)
		local label = CCLabelTTF:labelWithString("竞技场", SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setPosition(CCPoint(100,35))
		label:setColor(ccc3(255,203,153))
		title_tip_bg:addChild(label)
		--当前排名及奖励银币数额
		local head_panel = dbUIPanel:panelWithSize(CCSize(484,40))
		head_panel:setAnchorPoint(CCPoint(0, 0.5))
		head_panel:setPosition(CCPoint(220,35+10))
		top:addChild(head_panel)
		local head_bg = CCSprite:spriteWithFile("UI/arena/head_bg.png")
		head_bg:setPosition(CCPoint(0, 0))
		head_bg:setAnchorPoint(CCPoint(0, 0))
		head_panel:addChild(head_bg)
		--当前排名
		local label = CCLabelTTF:labelWithString("当前排名：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0.5))
		label:setPosition(CCPoint(10,20))
		label:setColor(ccc3(255,204,103))
		head_panel:addChild(label)		
		local label = CCLabelTTF:labelWithString(self.currentRank,CCSize(100,0),0, SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0.5))
		label:setPosition(CCPoint(140,20))
		label:setColor(ccc3(248,100,0))
		head_panel:addChild(label)
		
		--银币数额
		local label = CCLabelTTF:labelWithString("奖励：",CCSize(200,0),0, SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0.5))
		label:setPosition(CCPoint(240,20))
		label:setColor(ccc3(255,204,103))
		head_panel:addChild(label)
		if self.rewardSliver~=0 then
		        if self.rewardSliver>10000 then 
				     local wans=self.rewardSliver/10000
					   rewardSliver=wans.."万银币"
			    else		   
		        rewardSliver=self.rewardSliver.."银币"
				end
		else
			rewardSliver=0
		end
		local label = CCLabelTTF:labelWithString((self.rewardSliver > 0 and rewardSliver or "已领取"),CCSize(200,0),0, SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0, 0.5))
		label:setPosition(CCPoint(320,20))
		label:setColor(ccc3(248,100,0))
		head_panel:addChild(label)
		self.rewardSliverTx = label	
		
		--倒计时
		local rewardCoolDownTimer = function()
			if self.rewardCoolDown > 0 then
				self.rewardCoolDown = self.rewardCoolDown - 1
			end
		end
		self.rewardCoolDownHandler  = CCScheduler:sharedScheduler():scheduleScriptFunc(rewardCoolDownTimer,1,false)
		
		--领取
		local btn = dbUIButtonScale:buttonWithImage("UI/arena/get.png",1.2,ccc3(248,100,0))
		btn:setPosition(CCPoint(800, 35+10))
		btn.m_nScriptClickedHandler = function()
			self:rewardRank()
		end
		top:addChild(btn)
		self.rewardBtn = btn
	end,

	--领取排名奖励
	rewardRank = function(self)
		local function opRewardRankFinishCB(s)
			if s:getByKey("error_code"):asInt() == -1 then
				GloblePlayerData.copper = s:getByKey("copper"):asInt()
				updataHUDData()
				
				new(SimpleTipPanel):create(LEITEI_GAIN_SUCCESS,ccc3(255,0,0),0)
				self.rewardCoolDown = s:getByKey("arena_reward_cooldown"):asDouble() / 1000
				if self.rewardSliverTx then
					self.rewardSliverTx:setString("已领取")
				end
			else
				ShowErrorInfoDialog(error_code)
			end
		end
		local function execRewardRank()
			NetMgr:registOpLuaFinishedCB(Net.OPT_ArenaRankReward, opRewardRankFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_ArenaRankReward, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)

			NetMgr:setOpUnique(Net.OPT_ArenaRankReward)
			NetMgr:executeOperate(Net.OPT_ArenaRankReward, cj)
		end
		if self.rewardCoolDown > 0 	then	--领取时间未到，提示剩余时间
			local leftTime = self.rewardCoolDown
			local hours = math.floor(leftTime / (60 * 60))
			leftTime = leftTime - hours * (60 * 60)
			local minutes = math.floor(leftTime / 60)
			local seconds = math.floor(leftTime - minutes * 60)
			
			if hours < 10 then
				hours = "0"..hours
			end
			if minutes < 10 then
				minutes = "0"..minutes
			end
			if seconds < 10 then
				seconds = "0"..seconds
			end
			new(SimpleTipPanel):create("距离领奖剩余时间："..hours.."小时"..minutes.."分"..seconds.."秒", ccc3(255,0,0),0)
		else
			execRewardRank()
		end
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)
		--外框背景
		local bg = CCSprite:spriteWithFile("UI/public/bg.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)
		--竞技场背景
		local arena_bg = CCSprite:spriteWithFile("UI/arena/bg.jpg")
		arena_bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(arena_bg)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)

		self:createTop()
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		
		if self.combatLenQueTimeHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.combatLenQueTimeHandle)
			self.combatLenQueTimeHandle = nil
		end
		if self.rewardCoolDownHandler then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.rewardCoolDownHandler)
			self.rewardCoolDownHandler = nil
		end
		removeUnusedTextures()
		GlobleArenaPanel = nil
	end,
}

--积分商城
ArenaScoreMallPanel = {
	mallLayer = nil,
	mallCenterWidget = nil,
	mallContentArea = nil,
	curCountLabel = {},
	curCountGeLabel = {},
	create = function(self, data)
		local scene = DIRECTOR:getRunningScene()
	
		self.mallLayer, self.mallCenterWidget = createCenterWidget()
		scene:addChild(self.mallLayer, 3000)
		
		--背景
		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setAnchorPoint(CCPoint(0.5, 0.5))
		bg:setPosition(CCPoint(1010 / 2, 702 / 2))
		self.mallCenterWidget:addChild(bg)
		--积分商城
		local titleImage = CCSprite:spriteWithFile("UI/arena/score_mall_tag.png")
		titleImage:setAnchorPoint(CCPoint(0, 1.0))
		titleImage:setPosition(CCPoint(-5, 698))
		self.mallCenterWidget:addChild(titleImage)		

		--当前排名
		local cur_rank = CCSprite:spriteWithFile("UI/arena/cur_rank.png")
		cur_rank:setAnchorPoint(CCPoint(1.0, 0.5))
		cur_rank:setPosition(CCPoint(545, 643))
		self.mallCenterWidget:addChild(cur_rank)
		local cur_rank_label = CCLabelTTF:labelWithString(GlobleArenaPanel.currentRank, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 28)
		cur_rank_label:setAnchorPoint(CCPoint(0, 0.5))
		cur_rank_label:setPosition(CCPoint(cur_rank:getPositionX() + 5, 643))
		cur_rank_label:setColor(ccc3(255, 204, 51))
		self.mallCenterWidget:addChild(cur_rank_label)
		
		--当前积分
		local cur_score = CCSprite:spriteWithFile("UI/arena/cur_score.png")
		cur_score:setAnchorPoint(CCPoint(1.0, 0.5))
		cur_score:setPosition(CCPoint(750, 643))
		self.mallCenterWidget:addChild(cur_score)
		local cur_score_label = CCLabelTTF:labelWithString(GlobleArenaPanel.currentPoint, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 28)
		--local label_rank_req = CCLabelTTF:labelWithString(9999, CCSize(650,100), 0, SYSFONT[EQUIPMENT], 26)
		cur_score_label:setAnchorPoint(CCPoint(0, 0.5))
		cur_score_label:setPosition(CCPoint(cur_score:getPositionX() + 5, 643))
		cur_score_label:setColor(ccc3(255, 204, 51))
		self.mallCenterWidget:addChild(cur_score_label)
		self.score_label = cur_score_label
		
		--关闭按钮
		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png", 1.2, ccc3(255, 255, 255))
		closeBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn:setPosition(CCPoint(952, 643))
		closeBtn.m_nScriptClickedHandler = function()
			scene:removeChild(self.mallLayer, true)
			GotoNextStepGuide()
		end
		self.mallCenterWidget:addChild(closeBtn)
		self.closeBtn = closeBtn
		
		--内容背景
		local myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(70, 70))
		myBG:setBGSize(CCSizeMake(930, 550))
		myBG:setAnchorPoint(CCPoint(0.5, 0.5))
		myBG:createCeil("UI/public/kuang_xiao_mi_shu.png")
		myBG:setPosition(CCPoint(self.mallCenterWidget:getContentSize().width/2, self.mallCenterWidget:getContentSize().height/2 - 40))
		self.mallCenterWidget:addChild(myBG)
		
		--local myBG_LD_x = myBG:getPositionX() - myBG:getContentSize().width / 2
		--local myBG_LD_y = myBG:getPositionY() - myBG:getContentSize().height / 2
		self.mallContentList = dbUIList:list(CCRectMake(0, 15, 930, 520), 0)
		myBG:addChild(self.mallContentList)
		self:createScoreMallList(data)
		
		return self
	end,
	
	--创建兑换内容
	createScoreMallList = function(self, data)
		if data ~= nil then 
			local itemCnt = data:getByKey("arena_reward_list"):size()
			for i = 1, itemCnt do
				local item = data:getByKey("arena_reward_list"):getByIndex(i - 1)
				local itemPanel = dbUIPanel:panelWithSize(CCSize(930, 120))
				--itemPanel:setAnchorPoint(CCPoint(0.5, 0.5))
				--itemPanel:setPosition(CCPoint(0, self.mallContentArea:getPositionY() + 520 - i * 100)) 
				--颜色差异
				if i % 2 == 0 then
					local diffBG = dbUIWidgetBGFactory:widgetBG()
					diffBG:setCornerSize(CCSizeMake(50, 50))
					diffBG:setBGSize(CCSizeMake(924, 120))
					--myBG:setAnchorPoint(CCPoint(0.5, 0.5))
					diffBG:createCeil("UI/arena/diff_color.png")
					diffBG:setPosition(CCPoint(3, 0))
					itemPanel:addChild(diffBG)
				end
				
				--下方直线
				local line = CCSprite:spriteWithFile("UI/public/line_2.png")
				line:setAnchorPoint(CCPoint(0,0))
				line:setScaleX(924/28)
				line:setPosition(3, 0)
				itemPanel:addChild(line)
				
				--宝石袋
				local bagKuang = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
				bagKuang:setAnchorPoint(CCPoint(0, 0.5))
				bagKuang:setPosition(CCPoint(20, 60))
				itemPanel:addChild(bagKuang)
				
				local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
	            local item_icon = itemJsonConfig:getByKey(item:getByKey("cfgItemId"):asInt())
				local bag = CCSprite:spriteWithFile("icon/Item/icon_item_"..item_icon:getByKey("icon"):asInt()..".png")
				bag:setAnchorPoint(CCPoint(0.5, 0.5))
				bag:setPosition(CCPoint(bagKuang:getPositionX() + bagKuang:getContentSize().width / 2, bagKuang:getPositionY()))
				itemPanel:addChild(bag)
			
				--宝石袋等级
				local label_level = CCLabelTTF:labelWithString(item:getByKey("cfgItemName"):asString(), CCSize(0,120), 0, SYSFONT[EQUIPMENT], 26)
				label_level:setAnchorPoint(CCPoint(0, 0.5))
				label_level:setPosition(CCPoint(130, 57))
				label_level:setColor(ccc3(255,214,109))
				itemPanel:addChild(label_level)
				--名次需求
				local label_rank_req_tx = CCLabelTTF:labelWithString("需名次", CCSize(200,120), 0, SYSFONT[EQUIPMENT], 26)
				label_rank_req_tx:setAnchorPoint(CCPoint(0, 0.5))
				label_rank_req_tx:setPosition(CCPoint(265, 57))
				label_rank_req_tx:setColor(ccc3(255,214,109))
				itemPanel:addChild(label_rank_req_tx)
				local label_rank_req = CCLabelTTF:labelWithString(item:getByKey("needRank"):asInt(), CCSize(650,100), 0, SYSFONT[EQUIPMENT], 24)
				--local label_rank_req = CCLabelTTF:labelWithString(9999, CCSize(650,100), 0, SYSFONT[EQUIPMENT], 26)
				label_rank_req:setAnchorPoint(CCPoint(0, 0.5))
				label_rank_req:setPosition(CCPoint(350, 57))
				label_rank_req:setColor(ccc3(13,200,245))
				itemPanel:addChild(label_rank_req)
				--积分需求
				local label_score_req_tx = CCLabelTTF:labelWithString("需积分", CCSize(200,120), 0, SYSFONT[EQUIPMENT], 26)
				label_score_req_tx:setAnchorPoint(CCPoint(0, 0.5))
				label_score_req_tx:setPosition(CCPoint(403, 57))
				label_score_req_tx:setColor(ccc3(255,214,109))
				itemPanel:addChild(label_score_req_tx)
				local label_score_req = CCLabelTTF:labelWithString(item:getByKey("needPoint"):asInt(), CCSize(650,100), 0, SYSFONT[EQUIPMENT], 24)
				--local label_score_req = CCLabelTTF:labelWithString(9999999, CCSize(650,100), 0, SYSFONT[EQUIPMENT], 26)
				label_score_req:setAnchorPoint(CCPoint(0, 0.5))
				label_score_req:setPosition(CCPoint(488, 57))
				label_score_req:setColor(ccc3(13,200,245))
				itemPanel:addChild(label_score_req)
				
				--当前数量
				local label_cur_count_tx = CCLabelTTF:labelWithString("当前数量", CCSize(200,120), 0, SYSFONT[EQUIPMENT], 26)
				label_cur_count_tx:setAnchorPoint(CCPoint(0, 0.5))
				label_cur_count_tx:setPosition(CCPoint(567, 57))
				label_cur_count_tx:setColor(ccc3(255,214,109))
				itemPanel:addChild(label_cur_count_tx)
				local label_cur_count = CCLabelTTF:labelWithString(item:getByKey("amount"):asInt(), CCSize(0,0), 0, SYSFONT[EQUIPMENT], 24)
				--local label_cur_count = CCLabelTTF:labelWithString(9999, CCSize(0,0), 0, SYSFONT[EQUIPMENT], 26)
				label_cur_count:setAnchorPoint(CCPoint(0, 0.5))
				label_cur_count:setPosition(CCPoint(675, 57))
				label_cur_count:setColor(ccc3(13,200,245))
				itemPanel:addChild(label_cur_count)
				self.curCountLabel[i] = label_cur_count
				--个
				local label_ge = CCLabelTTF:labelWithString("个", CCSize(650,120), 0, SYSFONT[EQUIPMENT], 26)
				label_ge:setAnchorPoint(CCPoint(0, 0.5))
				label_ge:setPosition(CCPoint(680 + label_cur_count:getContentSize().width, 57))
				label_ge:setColor(ccc3(255,214,109))
				itemPanel:addChild(label_ge)
				self.curCountGeLabel[i] = label_ge
				
				--兑换
				local exchangeBtn = dbUIButtonScale:buttonWithImage("UI/arena/exchange.png", 1.2, ccc3(125, 125, 125))
				exchangeBtn:setAnchorPoint(CCPoint(0.5, 0.5))
				exchangeBtn:setPosition(CCPoint(910 - exchangeBtn:getContentSize().width / 2, 60))
				exchangeBtn.m_nScriptClickedHandler = function()
					self:exchange(i)
				end
				itemPanel:addChild(exchangeBtn)
				if i == itemCnt then
					self.guideExchangeBtn = exchangeBtn
				end
				self.mallContentList:insterWidget(itemPanel)
				--self.mallContentArea:stopDetailsActions()
			end
			self.mallContentList:m_setPosition(CCPoint(0, -self.mallContentList:get_m_content_size().height + self.mallContentList:getContentSize().height))
		end
	end,
	
	exchange = function(self, exchangeType)
		local function opExchangeFinishCB(s)
			local error_code = s:getByKey("error_code"):asInt()
			if error_code == -1 then
				local arena_point = s:getByKey("arena_point"):asInt()
				local addList = s:getByKey("add_item_id_list")
				local changeList = s:getByKey("change_item_id_list")
				if addList:size()>0 then
					local itemId = addList:getByIndex(0):asInt()
					local item = {
						s:getByKey("cfg_item_id"):asInt(),
						itemId,
					}
					battleGetItems(item,true)
				elseif changeList:size()>0 then
					local itemId = changeList:getByIndex(0):asInt()
					local item = {
						s:getByKey("cfg_item_id"):asInt(),
						itemId,
						1,
						true
					}
					battleGetItems(item,true)
				end
				if GlobleArenaPanel ~= nil then
					--更新当前积分
					GlobleArenaPanel.currentPoint = arena_point;
					GlobleArenaPanel.arena_point_label:setString(GlobleArenaPanel.currentPoint)
				end
				if self.mallCenterWidget then
					self.score_label:setString(arena_point)
					self.curCountLabel[exchangeType]:setString(s:getByKey("arena_mall_leftAmount"):asInt())
					self.curCountGeLabel[exchangeType]:setPosition(CCPoint(671 + self.curCountLabel[exchangeType]:getContentSize().width, 57))
				end	
			elseif error_code == 2001 then
				alert("背包已满，无法继续兑换。")
			else
				ShowErrorInfoDialog(error_code)
			end
			GlobleArenaExchangeFinish = true
			GotoNextStepGuide()
		end
		local function execExchange()
			NetMgr:registOpLuaFinishedCB(Net.OPT_ArenaScoreMallExchange, opExchangeFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_ArenaScoreMallExchange, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("type", exchangeType)	--兑换类型
			
			NetMgr:setOpUnique(Net.OPT_ArenaScoreMallExchange)
			NetMgr:executeOperate(Net.OPT_ArenaScoreMallExchange, cj)
		end
		execExchange()
	end
}
--竞技场 排行榜  面板
globleArenaPaiHangPanel = function()
	new(ArenaPaiHangPanel):create()
end

ArenaPaiHangPanel = {
	bg = nil,
	page = 1,
	pageCount = 1,
	pagePanels = {},
	roleList  = {},
	myRank  = 0,

	create = function(self)
		self:initBase()
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 598))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(0,0)
		self.mainWidget:addChild(self.bg)

		local listBg = createBG("UI/public/kuang_xiao_mi_shu.png",650,560)
		listBg:setAnchorPoint(CCPoint(0, 0))
		listBg:setPosition(CCPoint(320, 35))
		self.bg:addChild(listBg)
		self.listBg = listBg

		--头
		local list_head_bg = createBG("UI/ri_chang/list_head_bg.png",650,60,CCSize(23,23))
		list_head_bg:setAnchorPoint(CCPoint(0, 0))
		list_head_bg:setPosition(CCPoint(0, 500))
		listBg:addChild(list_head_bg)

		local createTitile = function(text,offsetX,width)
			local title_bg = createBG("UI/public/title_bg2.png",width,37,CCSize(15,15))
			title_bg:setAnchorPoint(CCPoint(0, 0.5))
			title_bg:setPosition(CCPoint(offsetX, 30))
			list_head_bg:addChild(title_bg)
			
			local label = CCLabelTTF:labelWithString(text,SYSFONT[EQUIPMENT], 28)
			label:setAnchorPoint(CCPoint(0.5,0.5))
			label:setPosition(CCPoint(width/2,37/2))
			label:setColor(ccc3(255,152,3))
			title_bg:addChild(label)
		end
		createTitile("排名",37,80)
		createTitile("玩家名",167+35-6,93)
		--createTitile("阵营",305+30,80)
		createTitile("胜场",415-32-14,80)
		createTitile("胜率",532,80)
		
		self:rank()
		return self
	end,

	--创建排名分页
	createRankPage = function(self)
		self.pageCount = getPageCount(table.getn(self.roleList),15)

		local pagePanelContainer = dbUIPanel:panelWithSize(CCSize(650 * self.pageCount,430))
		pagePanelContainer:setAnchorPoint(CCPoint(0, 0))
		pagePanelContainer:setPosition(0,0)

		for i=1,self.pageCount do
			local singlePage = dbUIPanel:panelWithSize(CCSize(650,430))
			singlePage:setAnchorPoint(CCPoint(0, 0))
			singlePage:setPosition((i-1)*650,0)

			local pagePanel = {panel=singlePage,items={},page=i,loaded=false}
			self.pagePanels[i] = pagePanel
			pagePanelContainer:addChild(singlePage)
		end

		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pagePanelContainer, 1, self.pageCount)
		self.scrollArea:setAnchorPoint(CCPoint(0, 0))
		self.scrollArea:setScrollRegion(CCRect(0, 0, 650, 430))
		self.scrollArea:setPosition(0,57)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.page = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
			self:loadPage(self.page)
		end
		self.listBg:addChild(self.scrollArea)
		self:createPageDot(self.pageCount)
		self.scrollArea:scrollToPage(self.page-1,false)
	end,

	loadPage = function(self,page)
		local pagePanel = self.pagePanels[page]
		if pagePanel.loaded then
			return
		end
		local panel = pagePanel.panel

		local createItem = function(text,offsetX,offsetY,width)
			local labelPanel = dbUIPanel:panelWithSize(CCSize(width,37))
			labelPanel:setAnchorPoint(CCPoint(0, 0))
			labelPanel:setPosition(CCPoint(offsetX, offsetY))
			panel:addChild(labelPanel)
			local label = CCLabelTTF:labelWithString(text,SYSFONT[EQUIPMENT], 28)
			label:setAnchorPoint(CCPoint(0.5,0.5))
			label:setPosition(CCPoint(width/2,37/2))
			label:setColor(ccc3(254,205,102))
			labelPanel:addChild(label)
		end

		local roleList = self.roleList
		local count = table.getn(roleList)
		local start = (page-1)*15 + 1
		local ends = start-1+15>count and count or start+15-1

		local index = 1
		for i=start,ends do
		
			local rank = roleList[i].rank
			local name = roleList[i].name
			local nation = roleList[i].nation
			local win_count = roleList[i].win_count
			local win_rate = roleList[i].win_rate

			createItem(rank,37,400-(index-1)*28,80)
			createItem(name,167+35-6,400-(index-1)*28,93)
			--createItem(nation,305,400-(index-1)*28,80)
			createItem(win_count,415-32-14,400-(index-1)*28,80)
			createItem(win_rate,532,400-(index-1)*28,80)
			index = index+1
		end
		pagePanel.loaded = true
	end,

	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 45))
		self.form:setPosition(650/2, 10)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.listBg:addChild(self.form)
		self.pageToggles = {}
		for i=1, pageCount do
			local pageToggle = dbUIButtonToggle:buttonWithImage("UI/public/page_btn_normal.png","UI/public/page_btn_toggle.png")
			pageToggle:setPosition(CCPoint(52*(i-1),20) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
	end,

	rank = function(self,page)
		local p = page ~= nil and page or 0
		local function opRankFinishCB(s)
			local error_code = s:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			elseif self.bgLayer then
				local roleList = self.roleList
				local myRank = 0
				for i = 1 , public_ternaryOperation(s:getByKey("arena_list"):size() < 100 , s:getByKey("arena_list"):size() , 100) do
					local idx = i - 1
					local rank = s:getByKey("arena_list"):getByIndex(idx):getByKey("rank"):asInt()
					local name = s:getByKey("arena_list"):getByIndex(idx):getByKey("name"):asString()
					local nation = NATION[s:getByKey("arena_list"):getByIndex(idx):getByKey("nation"):asInt()+1]
					local win_count = s:getByKey("arena_list"):getByIndex(idx):getByKey("arena_win_count"):asInt()
					local win_rate = s:getByKey("arena_list"):getByIndex(idx):getByKey("win_rate"):asInt()
					roleList[i] = { rank=rank,name=name,nation = nation,win_count=win_count,win_rate=win_rate}
					if GloblePlayerData.role_name == name then
						myRank = rank
					end
				end
				
				self.myRank = myRank
				self:createRankPage()
				self:loadPage(1)
			end
		end

		local function execRank()
			local action = Net.OPT_GetArenaRank
			local cj = Value:new()
			NetMgr:registOpLuaFinishedCB(action, opRankFinishCB)
			NetMgr:registOpLuaFailedCB(action, opFailedCB)
			NetMgr:executeOperate(action, cj)
		end
		execRank()
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/arena/bg.jpg")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)

		local top = dbUIPanel:panelWithSize(CCSize(1010,106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)

		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setPosition(CCPoint(952, 35+10))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		top:addChild(closeBtn)
		
		--面板提示图标
		local title_tip_bg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		title_tip_bg:setPosition(CCPoint(0, 35+10))
		title_tip_bg:setAnchorPoint(CCPoint(0,0.5))
		top:addChild(title_tip_bg)
		local label = CCLabelTTF:labelWithString("竞技场排名", SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setPosition(CCPoint(100,35))
		label:setColor(ccc3(255,203,153))
		title_tip_bg:addChild(label)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		removeUnusedTextures()
	end,
}
function showBootyPanel()
	local bp = new(bootyPanel)
	local booty = {
		gold = 10000,
		copper = 1000,
		jump_wand = 10,
		item_1 = 80000001,
		item_2 = 80000002,
	}
	bp:create(booty)
end

bootyPanel = {
	form = nil,
    uiLayer = nil,
	create = function(self,booty)
		local scene = DIRECTOR:getRunningScene()	
		self.uiLayer,self.form = createCenterWidget()
	    scene:addChild(self.uiLayer, 2005)
		
		local myBG = createBG("UI/gift/get_reward.png",544,490)
		self.form:addChild(myBG)
		myBG:setAnchorPoint(CCPoint(0.5,0.5))
		myBG:setPosition(CCPoint(512,384))
		
		
		--[[
		local title  = CCSprite:spriteWithFile("UI/public/desc_bg.png")	
		title:setAnchorPoint(CCPoint(0.5,0))	
		title:setPosition(CCPoint(myBG:getContentSize().width/2,myBG:getContentSize().height - title:getContentSize().height - 14))	
		myBG:addChild(title)
		--]]
		
       --[[local myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(20,20))
		myBG:setBGSize(CCSizeMake(485,310))
		myBG:createCeil("UI/public/recuit_dark2.png")
		myBG:setAnchorPoint(CCPoint(0,0))
		myBG:setPosition(CCPoint(27+20,93+20))
		myBG:addChild(myBG)
		--]]
		--[[local label = CCLabelTTF:labelWithString("奖励",CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)	
		label:setAnchorPoint(CCPoint(0.5,1))
		label:setColor(ccc3(150,200,0))
		label:setPosition(CCPoint(myBG:getContentSize().width/2,myBG:getContentSize().height-55-80))
		myBG:addChild(label)
		--]]
		--分割线
	--[[	local splite=CCSprite:spriteWithFile("UI/public/line_2.png")
		splite:setAnchorPoint(CCPoint(0,0))
		splite:setPosition(CCPoint(56,236+80))
		splite:setScaleX(458/28)
		myBG:addChild(splite)
		--]]
		local msg = ""	
		local txtwidth=50+20
		local txtheight=193	
		if booty.gold ~= nil and booty.gold ~= 0 then
			local label = CCLabelTTF:labelWithString("金币*", SYSFONT[EQUIPMENT], 26)
			label:setColor(ccc3(255,203,153))	
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(txtwidth,txtheight+80))
			myBG:addChild(label)
			txtwidth = txtwidth + label:getContentSize().width
			--数额
			local label = CCLabelTTF:labelWithString(booty.gold, SYSFONT[EQUIPMENT], 26)	
			label:setColor(ccc3(247,195,96))
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(txtwidth,txtheight+80))
			myBG:addChild(label)
			txtwidth = txtwidth + label:getContentSize().width+25
		end
		
		if booty.copper ~= nil and booty.copper ~= 0 then
			local label = CCLabelTTF:labelWithString("银币*", SYSFONT[EQUIPMENT], 26)
			label:setColor(ccc3(255,203,153))	
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(txtwidth,txtheight+80))
			myBG:addChild(label)
			txtwidth = txtwidth + label:getContentSize().width
			--数额
			local label = CCLabelTTF:labelWithString(booty.copper, SYSFONT[EQUIPMENT], 26)
			label:setColor(ccc3(247,195,96))	
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(txtwidth,txtheight+80))
			myBG:addChild(label)
			txtwidth = txtwidth + label:getContentSize().width+25
		end
		
		if booty.jump_wand ~= nil and booty.jump_wand ~= 0 then
			local label = CCLabelTTF:labelWithString("经验丹*", SYSFONT[EQUIPMENT], 26)	
			label:setColor(ccc3(255,203,153))
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(txtwidth,txtheight+80))
			myBG:addChild(label)
			txtwidth = txtwidth + label:getContentSize().width
			--数额
			local label = CCLabelTTF:labelWithString(booty.jump_wand, SYSFONT[EQUIPMENT], 26)
			label:setColor(ccc3(247,195,96))	
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(txtwidth,txtheight+80))
			myBG:addChild(label)
			txtwidth = txtwidth + label:getContentSize().width
		end
		
		--[[
		--分割线
		local splite=CCSprite:spriteWithFile("UI/public/line_2.png")
		splite:setAnchorPoint(CCPoint(0,0))
		splite:setPosition(CCPoint(56,174+80))
		splite:setScaleX(458/28)
		myBG:addChild(splite)
		--]]

		if booty.item_1 ~= nil and booty.item_1 ~= 0 then
			local kuang=CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			kuang:setAnchorPoint(CCPoint(0, 0))
			kuang:setPosition(CCPoint(70, 144))
			myBG:addChild(kuang)
			local item_info = findShowItemInfo(booty.item_1)
			--item_info.amount = 999999
			local item = new(BaoGuo_BackpackSingleItem)
			item:create(item_info,{item=item_info,from="view"})
			item.itemBorder:setAnchorPoint(CCPoint(0, 0))
			item.itemBorder:setPosition(CCPoint(70, 144))
			myBG:addChild(item.itemBorder)
		end
		
		if booty.item_2 ~= nil and booty.item_2 ~= 0 then
			local kuang=CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			kuang:setAnchorPoint(CCPoint(0, 0))
			kuang:setPosition(CCPoint(200, 144))
			myBG:addChild(kuang)
			local item_info = findShowItemInfo(booty.item_2)
			local item = new(BaoGuo_BackpackSingleItem)
			--item_info.amount = 9999
			item:create(item_info,{item=item_info,from="view"})
			item.itemBorder:setAnchorPoint(CCPoint(0, 0))
			item.itemBorder:setPosition(CCPoint(200, 144))
			myBG:addChild(item.itemBorder)
		end		
		
		myBG.m_nScriptClickedHandler = function()
				self.uiLayer:removeFromParentAndCleanup(true)
			end
		local close = new(ButtonScale)
		close:create("UI/public/btn_ok.png",1.2,ccc3(255,255,255))
		close.btn:setAnchorPoint(CCPoint(0.5,0.5))	
		close.btn:setPosition(CCPoint(myBG:getContentSize().width/2,myBG:getContentSize().height-55-385))		
		close.btn.m_nScriptClickedHandler = function(ccp)
			self.uiLayer:removeFromParentAndCleanup(true)
		end		
		myBG:addChild(close.btn)
	end,
}
--战役 面板
BattlePanel = {
	bg = nil,
	battleBtns = nil,
	namesTX = nil,
	which = 1,
	curPage = 1,
	pageCount = 1,
	pageSize = 8,
	total  = 0,
	centerWidget =nil,
	order = nil,

	createFixed = function(self,armyData,jValue)
		if self.centerWidget and self.mainWidget then
			self.mainWidget:removeAllChildrenWithCleanup(true)
		end

		self.bg = createDarkBG(927,540)
		self.bg:setPosition(CCPoint(40,40))
		self.mainWidget:addChild(self.bg)

		self.total = jValue:getByKey("camp_list"):size()
		self.pageCount = math.ceil(self.total / 8)

		local pageContainer = dbUIPanel:panelWithSize(CCSize(927 * self.pageCount,490))
		pageContainer:setAnchorPoint(CCPoint(0, 0))
		pageContainer:setPosition(0,0)

		for i=1,self.pageCount do
			local singlePage = dbUIPanel:panelWithSize(CCSize(927,490))
			singlePage:setAnchorPoint(CCPoint(0, 0))
			singlePage:setPosition((i-1)*927,0)
			self:loadPage(singlePage,i,armyData,jValue:getByKey("camp_list"))
			pageContainer:addChild(singlePage)
		end

		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pageContainer, 1, self.pageCount)
		self.scrollArea:setAnchorPoint(CCPoint(0, 0))
		self.scrollArea:setScrollRegion(CCRect(0, 0, 927, 490))
		self.scrollArea:setPosition(0,540-490)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.curPage = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
		end
		self.bg:addChild(self.scrollArea)
		self:createPageDot(self.pageCount)

		self.scrollArea:scrollToPage(self.curPage-1,false)
		return self.bg
	end,

	--加载某一页的数据
	loadPage = function(self,pagePanel,page,armyData,camp_list)
		--判断每页的个数
		local page_size = 0
		if page < self.pageCount then
			page_size = 8
		else
			if self.total % 8 == 0 then
				page_size = 8
			else
				page_size = self.total % 8
			end
		end
		local order = self.order
		local dataStart = 8*(page-1)
		local row,column=1,0

		for i=1,page_size do
			local camp = camp_list:getByIndex(dataStart+i-1)
			local campId = camp:getByKey("cfg_camp_id"):asInt()
			local name = armyData[campId].name

			column = column+1
			if column>4 then
				row = row+1
				column=1
			end

			local itemPanel = dbUIPanel:panelWithSize(CCSize(195,195))
			itemPanel:setPosition(CCPoint(30+(column-1)*228,254-(row-1)*228))

			local itemBg = CCSprite:spriteWithFile("UI/fuben/yuan.png")
			itemBg:setPosition(195/2,195/2)
			itemBg:setScale(195/165)
			itemPanel:addChild(itemBg)

			local btn = dbUIButtonScale:buttonWithImage("FightResource/fuben/"..campId..".png", 1, ccc3(125, 125, 125))
			btn:setPosition(195/2,195/2)
			btn:setScale(195/165)
			btn.m_nScriptClickedHandler = function()
				callCampPanel(campId)
			end
			itemPanel:addChild(btn)

			if i == self.total then
				local tip = CCSprite:spriteWithFile("UI/fight/fight_flag.png")
				tip:setAnchorPoint(CCPoint(0, 1))
				tip:setPosition(CCPoint(-15,195+15))
				itemPanel:addChild(tip)
			end
			
			local name_bg = CCSprite:spriteWithFile("UI/fuben/name_bg.png")
			name_bg:setAnchorPoint(CCPoint(0.5, 0))
			name_bg:setPosition(CCPoint(195/2,20))
			itemPanel:addChild(name_bg)
			local name = CCLabelTTF:labelWithString(name, SYSFONT[EQUIPMENT], 22)
			name:setAnchorPoint(CCPoint(0.5, 0.5))
			name:setPosition(CCPoint(152/2,20))
			name:setColor(ccc3(253,204,102))
			name_bg:addChild(name)

			pagePanel:addChild(itemPanel)
		end
	end,

	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 50))
		self.form:setPosition(927/2, 0)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.bg:addChild(self.form)
		self.pageToggles = new({})
		for i=1, pageCount do
			local pageToggle = dbUIButtonToggle:buttonWithImage("UI/public/page_btn_normal.png","UI/public/page_btn_toggle.png")
			pageToggle:setPosition(CCPoint(52*(i-1),25) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.curPage])
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1001)
		scene:addChild(self.uiLayer, 2001)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)


		local top = dbUIPanel:panelWithSize(CCSize(1010,106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)

		local title_tip_bg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		title_tip_bg:setPosition(CCPoint(0, 15))
		title_tip_bg:setAnchorPoint(CCPoint(0, 0))
		top:addChild(title_tip_bg)
		
		local name = CCLabelTTF:labelWithString("冒  险", SYSFONT[EQUIPMENT], 32)
		name:setAnchorPoint(CCPoint(0.5, 0.5))
		name:setPosition(CCPoint(200/2,32))
		name:setColor(ccc3(255,203,153))
		title_tip_bg:addChild(name)
					
		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setPosition(CCPoint(952, 44))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		top:addChild(closeBtn)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
		return self
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		removeUnusedTextures()
	end
}

local function opCampThumbFinishCB(s)
	closeWait()

	local error_code = s:getByKey("error_code"):asInt()
	if error_code ~= -1 then
		ShowErrorInfoDialog(error_code)
		return
	end
	if not GlobleBattlePanel then
		GlobleBattlePanel = new(BattlePanel)
	end
	if not GlobleBattlePanel.centerWidget then
		GlobleBattlePanel:initBase()
	end
	GlobleBattlePanel:createFixed(cfg_camp_data, s)
	GlobleBattlePanel.hasBattleLayer = true
end

function GlobalCreateBattle()
	showWaitDialog("waiting CampThumb data")
	NetMgr:registOpLuaFinishedCB(Net.OPT_CampThumb, opCampThumbFinishCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_CampThumb, opFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	NetMgr:executeOperate(Net.OPT_CampThumb, cj)
end
--战役战斗选择面板
local CanSeeResult = 0  --是否可以直接看战斗结果,1:可以,0:不可以
GlobleGetCanSeeResult = function()  --供C++调用
	return CanSeeResult
end

GlobleSetCanSeeResult = function(i)  --供C++调用
	CanSeeResult = i
end

local PanelInstance = nil

GlobleFightDialogPanel = nil

local PAGE_SIZE = 5
local campSceneName = ""
local campSceneId = 0
local campMapId = 0

BattleFightPanel = {
	curPage = 1,
	pageCount = 1,
	total  = 0,
	centerWidget = nil,
	order = nil,

	createFixed = function(self,armyData,current_order)
		self.mainWidget:removeAllChildrenWithCleanup(true)
		self.armyPanel = nil
		self.preBtn = nil
		self.nextBtn = nil
		
		self.armyData = armyData
		self.order = current_order
		self.total = table.getn(armyData);
		self.pageCount = math.ceil(self.total / PAGE_SIZE)
		
		local o = (self.order + 1) > #armyData and #armyData or (self.order + 1)
		self.curPage = math.ceil( o / PAGE_SIZE)
		if self.curPage== 0 then self.curPage = 1 end
		
		self:loadPage(self.curPage)
		self:createPageBtns()		
	end,

	--加载某一页的数据
	loadPage = function(self,page)
		if self.armyPanel then
			self.armyPanel:removeFromParentAndCleanup(true)
			self.armyPanel = nil
		end
		
		self.curPage = page
		
		local panel = dbUIPanel:panelWithSize(CCSize(788,277))
		panel:setPosition(CCPoint(1010/2,20))
		panel:setAnchorPoint(CCPoint(0.5,0))
		self.mainWidget:addChild(panel)
		self.armyPanel = panel
		
		local start = (page - 1) * PAGE_SIZE + 1
		local offsetX = 0
		
		for i = start, start + PAGE_SIZE - 1 do
			if i > #self.armyData then break end

			local data = self.armyData[i]

			local p = dbUIPanel:panelWithSize(CCSize(146,180))
			p:setPosition(CCPoint(offsetX,0))
			p:setAnchorPoint(CCPoint(0,0))
			panel:addChild(p,-i)

			local btn = dbUIButtonScale:buttonWithImage("UI/fight/yuan.png", 1, ccc3(125, 125, 125))
			btn:setPosition(146/2,70)
			btn:setAnchorPoint(CCPoint(0.5,0))
			btn.m_nScriptClickedHandler = function()
				local canResult = false
				if i < self.order or self.order == -1 then --只有已击破的战役可以直接看结果
					canResult = true
				end
				GlobleFightDialogPanel = new(FightDialogPanel)
				GlobleFightDialogPanel:create(data,3,canResult)
			end
			p:addChild(btn)

			local head = CCSprite:spriteWithFile( "head/MonsterFull/head_full_"..data.face..".png")
			head:setAnchorPoint(CCPoint(0.5,0))
			head:setPosition(btn:getContentSize().width/2,20)
			btn:addChild(head)
			
			if i <= self.order or self.order == -1 or GetCurTaskType() == 2 then 
				local saoDangBtn = dbUIButtonScale:buttonWithImage("UI/fight/sao_dang.png",1.0,ccc3(99,99,99))
				saoDangBtn:setPosition(146/2,15)
				saoDangBtn:setAnchorPoint(CCPoint(0.5,0))
				saoDangBtn.m_nScriptClickedHandler = function()
					createBattleSweepPanel(data.cfg_army_id)
				end
				p:addChild(saoDangBtn)
			end
			
			if self.order == i - 1 then --当前攻击对象
				local flag = CCSprite:spriteWithFile("UI/fight/flag.png")
				flag:setAnchorPoint(CCPoint(0.5, 0))
				flag:setPosition(CCPoint(130,170 + 20))
				p:addChild(flag)
				
				--支线
				if GetCurTaskType() == 2 then
					local task = dbTaskMgr:getSingletonPtr():getBranchTaskInfo()
					
					local labelBranch = CCSprite:spriteWithFile("UI/fight/label_branch.png")
					labelBranch:setAnchorPoint(CCPoint(0.5, 1))
					labelBranch:setPosition(CCPoint(flag:getContentSize().width/2,72))
					flag:addChild(labelBranch)
					
					local tip = CCLabelTTF:labelWithString(task.mCurDoneValue.."/"..task.mFinishValue, SYSFONT[EQUIPMENT], 20)
					tip:setAnchorPoint(CCPoint(0.5, 1))
					tip:setPosition(CCPoint(flag:getContentSize().width/2,52))
					tip:setColor(ccc3(253,0,0))
					flag:addChild(tip)
					self.tip = tip
				else --主线
					local labelBranch = CCSprite:spriteWithFile("UI/fight/label_main.png")
					labelBranch:setAnchorPoint(CCPoint(0.5, 1))
					labelBranch:setPosition(CCPoint(flag:getContentSize().width/2,62))
					flag:addChild(labelBranch)			
				end
				
			elseif self.order < i and self.order ~=-1 and GetCurTaskType() == 1 then --不能打的
				head:setColor(ccc3(125, 125, 125))
				btn:setIsEnabled(false)
			end

			local name_bg = CCSprite:spriteWithFile("UI/fight/name_bg.png")
			name_bg:setAnchorPoint(CCPoint(0.5, 0))
			name_bg:setPosition(btn:getContentSize().width/2,20)
			btn:addChild(name_bg)
			
			local name = CCLabelTTF:labelWithString(data.name, SYSFONT[EQUIPMENT], 22)
			name:setAnchorPoint(CCPoint(0.5, 0.5))
			name:setPosition(CCPoint(name_bg:getContentSize().width / 2,18))
			name:setColor(ccc3(253,204,102))
			name_bg:addChild(name)

			offsetX = offsetX + 165
		end
	end,

	createPageBtns = function(self)
		if self.preBtn then
			self.preBtn:removeFromParentAndCleanup(true)
			self.preBtn = nil
		end
		if self.nextBtn then
			self.nextBtn:removeFromParentAndCleanup(true)
			self.nextBtn = nil
		end
		local curOrder  = self.order
		local pageCount = self.pageCount
		local curPage   = self.curPage
		local main      = self.mainWidget
		
		--前一页
		local preBtn = nil
		if curPage == 1 then
			preBtn = dbUIButtonScale:buttonWithImage("UI/public/prev_disable.png", 1, ccc3(125, 125, 125))
			preBtn:setPosition(60,146)
			preBtn:setAnchorPoint(CCPoint(0.5,0.5))
			main:addChild(preBtn)
		else
			preBtn = dbUIButtonScale:buttonWithImage("UI/public/prev_enable.png", 1, ccc3(125, 125, 125))
			preBtn:setPosition(60,146)
			preBtn:setAnchorPoint(CCPoint(0.5,0.5))
			preBtn.m_nScriptClickedHandler = function()
				self:loadPage(curPage - 1)
				self:createPageBtns()
			end
			main:addChild(preBtn)			
		end
		self.preBtn = preBtn
		
		--后一页
		local nextBtn = nil
		if curPage == pageCount then
			nextBtn = dbUIButtonScale:buttonWithImage("UI/public/next_disable.png", 1, ccc3(125, 125, 125))
			nextBtn:setPosition(1010 - 60,146)
			nextBtn:setAnchorPoint(CCPoint(0.5,0.5))
			main:addChild(nextBtn)
		else
			nextBtn = dbUIButtonScale:buttonWithImage("UI/public/next_enable.png", 1, ccc3(125, 125, 125))
			nextBtn:setPosition(1010 - 60, 146)
			nextBtn:setAnchorPoint(CCPoint(0.5,0.5))
			nextBtn.m_nScriptClickedHandler = function()
				self:loadPage(curPage + 1)
				self:createPageBtns()
			end
			main:addChild(nextBtn)			
		end
		self.nextBtn = nextBtn
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1001)
		scene:addChild(self.uiLayer, 2001)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		local bg = CCSprite:spriteWithFile("FightResource/map/"..campMapId..".jpg")
		bg:setAnchorPoint(CCPoint(0.5,0))
		bg:setPosition(CCPoint(1010/2, 300))
		bg:setScale(isRetina)
		self.centerWidget:addChild(bg)

		local listBg = createBG("UI/fight/army_list_bg.png",972,277,CCSize(80,135))
		listBg:setPosition(CCPoint(1010/2,20))
		listBg:setAnchorPoint(CCPoint(0.5,0))
		self.centerWidget:addChild(listBg)		
				
		local top = dbUIPanel:panelWithSize(CCSize(1010,106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,590))
		self.centerWidget:addChild(top)

		local title_tip_bg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		title_tip_bg:setPosition(CCPoint(0, 15))
		title_tip_bg:setAnchorPoint(CCPoint(0, 0))
		top:addChild(title_tip_bg)
		
		local name = CCLabelTTF:labelWithString(campSceneName, SYSFONT[EQUIPMENT], 32)
		name:setAnchorPoint(CCPoint(0.5, 0.5))
		name:setPosition(CCPoint(170/2,32))
		name:setColor(ccc3(255,203,153))
		title_tip_bg:addChild(name)
		
		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setPosition(CCPoint(952, 44))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		top:addChild(closeBtn)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
		return self
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		self.curPage = 1
		PanelInstance = nil
		removeUnusedTextures()
	end
}

-- 因为要给C++调用，做成全局
function GlobalOpCampFinished(s)
	local error_code = s:getByKey("error_code"):asInt()
	if error_code ~= -1 then
		ShowErrorInfoDialog(error_code)
		return
	end
	
	local armyData = {}
	local campId = s:getByKey("current_camp"):asInt()
	local camp_data = cfg_camp_data[campId]
	local army_id_list = camp_data.cfg_army_data
	local task_finish_army_order = s:getByKey("task_finish_army_order"):asInt()
	local current_order = s:getByKey("current_order"):asInt()

	local cfgSceneJson = openJson("cfg/cfg_scene.json")
	campSceneName = cfgSceneJson:getByKey(""..campId):getByKey("name"):asString()
	campMapId = cfgSceneJson:getByKey(""..campId):getByKey("battle_map_id"):asInt()
	campSceneId = campId

	for i = 1, table.getn(army_id_list) do
		local army = cfg_army_data[army_id_list[i]]

		local flag = false
		if current_order == -1 then
			flag = true
		elseif army.require <= current_order and army.order <= task_finish_army_order then
			flag = true
		end

		if flag then
			table.insert(armyData, army)
		end
	end
	
	table.sort(armyData, function(a, b)
		return a.order < b.order
	end)
	
	if not PanelInstance then
		PanelInstance = new(BattleFightPanel)
		PanelInstance:initBase()
	end

	--支线任务
	if GetCurTaskType() == 2 then
		local task = dbTaskMgr:getSingletonPtr():getBranchTaskInfo()
		local targetArmyId = task.mCategory
		--判断支线任务的怪是否在当前camp中
		for i = 1, table.getn(army_id_list)-1 do
			if army_id_list[i] == targetArmyId then
				local army = cfg_army_data[targetArmyId]
				if army then
					current_order = army.order - 1 -- 减一是因为主线任务是打order的下一个怪，支线任务则打order的怪
				else
					current_order = -1
				end
				break;
			end
		end
	end
	PanelInstance:createFixed(armyData, current_order)
end

local function opCampFinishCB(s)
	GlobalOpCampFinished(s)
	closeWait()
end

local function opCampFailedCB(s)
	closeWait()
end

function callCampPanel(cfg_camp_id)
	showWaitDialogNoCircle("waiting camp data")
	NetMgr:registOpLuaFinishedCB(Net.OPT_Camp, opCampFinishCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_Camp, opCampFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	cj:setByKey("cfg_camp_id", cfg_camp_id)
	NetMgr:executeOperate(Net.OPT_Camp, cj)
end

function GlobleCloseBattleFightPanel()
	if PanelInstance then
		PanelInstance:destroy()
		PanelInstance = nil
	end
end

function GlobleUpdateBranckBattleFinished()
	if PanelInstance and GetCurTaskType() == 2 then
		local task = dbTaskMgr:getSingletonPtr():getBranchTaskInfo()
		PanelInstance.tip:setString(task.mCurDoneValue.."/"..task.mFinishValue)
	end
end
--关卡扫荡 面板
local RewardList 	= {}	--奖励信息保存
local MonsterList 	= {}	--怪物列表

local cfgArmyId		= 0
local curSweep      = 0
 
local SweepInfo 	= {
	CDTime 		= 0	,		--倒计时
	sweepTimes	= 0	,		--一共扫荡的次数
	sweepIndex	= 0 ,		--当前已扫荡的次数
}

local setMonsterList = function(monster_list)
	MonsterList = new({})
	for i = 1,monster_list:size() do
		local m = monster_list:getByIndex(i - 1)
		table.insert(MonsterList,{
			name = m:getByKey("name"):asString(),
			level = m:getByKey("level"):asInt()
		})
	end
end

local setSweepInfo = function(sweep_info)
	SweepInfo.CDTime = sweep_info:getByKey("cd_time"):asInt()
	SweepInfo.sweepTimes = sweep_info:getByKey("sweep_times"):asInt()
	SweepInfo.sweepIndex = sweep_info:getByKey("sweep_index"):asInt()
end

---计算默认扫荡次数
local getDefaultTimes = function()
	local times = 5
	if GetCurTaskType() == 2 then
		local task = dbTaskMgr:getSingletonPtr():getBranchTaskInfo()
		if task.mCategory == cfgArmyId and task.mFinishValue > task.mCurDoneValue then
			times = task.mFinishValue - task.mCurDoneValue
		end
	end
	
	local max = math.floor(GloblePlayerData.action_point / 5)
	times = math.min(times,max)
	
	return times
end

local getMaxTimes = function()
	return math.floor(GloblePlayerData.action_point / 5)
end

function createBattleSweepPanel(cfg_army_id)
	if GloblePlayerData.action_point == 0 then
		alert("精力值不足，无法进行扫荡")
		return
	end

	local function opFinishCB(json)
		closeWait()
		local error_code = json:getByKey("error_code"):asInt()
		if error_code ~= -1 then
			ShowErrorInfoDialog(error_code)
		else
			cfgArmyId = json:getByKey("cfg_army_id"):asInt()
			local monster_list = json:getByKey("monster_list")
			local sweep_info = json:getByKey("sweep_info")
			local reward_list = json:getByKey("reward_list")

			GloblePlayerData.action_point = json:getByKey("action_point"):asInt()

			setMonsterList(monster_list)
			
			if sweep_info:isNull() then
				local panel = new(BattleSweepPanel)
				panel:create()
			else
				setSweepInfo(sweep_info)
				local panel = new(BattleSweepingPanel)
				panel:create()
				panel:updateReword(reward_list)
				if SweepInfo.CDTime == 0 then
					panel:finishSweep()
				else
					panel:initScheduler()
				end
			end
			
			curSweep = SweepInfo.sweepIndex
		end
	end

	local request = function()
		showWaitDialog("")
		local action = Net.OPT_ArmySweepEnter
		NetMgr:registOpLuaFinishedCB(action, opFinishCB)
		NetMgr:registOpLuaFailedCB(action, opFailedCB)
		
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("cfg_army_id", cfg_army_id)
		NetMgr:executeOperate(action, cj)
	end
	
	request()
end

function viewSweeping()
	local scene = DIRECTOR:getRunningScene()
   	local bgLayer = createPanelBg()
    local uiLayer,centerWidget = createCenterWidget()
	scene:addChild(bgLayer, 1002)
	scene:addChild(uiLayer, 2002)

	local close = function()
		scene:removeChild(bgLayer)
		scene:removeChild(uiLayer)
	end
		
	local kuang = createBG("UI/public/tankuang_bg.png",440,160,CCSizeMake(80,80))
	kuang:setAnchorPoint(CCPoint(0.5,0.5))
	kuang:setPosition(CCPoint(1010/2, 702/2))
	kuang.m_nScriptClickedHandler = function()
		createBattleSweepPanel(0)
		close()
	end
	centerWidget:addChild(kuang)

	local contentLabel = CCLabelTTF:labelWithString("关卡副本正在扫荡中，点击查看", SYSFONT[EQUIPMENT], 24)
	contentLabel:setAnchorPoint(CCPoint(0.5,1))
	contentLabel:setPosition(CCPoint(440/2,130))
	contentLabel:setColor(ccc3(255,204,153))
	kuang:addChild(contentLabel)

	local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
	btn:setAnchorPoint(CCPoint(0.5,0))
	btn:setPosition(CCPoint(440/2,25))
	btn.m_nScriptClickedHandler = function()
		createBattleSweepPanel(0)
		close()
	end
	kuang:addChild(btn)
	
	local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png", 1, ccc3(125, 125, 125))
	closeBtn:setPosition(CCPoint(420,140))
	closeBtn.m_nScriptClickedHandler = function()
		close()
	end
	kuang:addChild(closeBtn)
end

---主界面上扫荡完成的通知窗口关闭时调用，不会跳转到扫荡界面，但后台会自动获取奖励
function finishSweepingSilent()
	local function opFinishCB(json)
		local reward_list = json:getByKey("reward_list")
		if reward_list:size() > 0 then
			GloblePlayerData.action_point = json:getByKey("action_point"):asInt()
			for i = 1, reward_list:size() do
				local v = reward_list:getByIndex(i - 1)
				globalGetRewardItem(v)
			end
			
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(Net.OPT_TaskGet, cj)
			NetMgr:executeOperate(Net.OPT_NPC, cj)
			executeRoleSimple()	--可能升级，需要更新信息
		end
	end

	local request = function()
		local action = Net.OPT_ArmySweepEnter
		NetMgr:registOpLuaFinishedCB(action, opFinishCB)
		NetMgr:registOpLuaFailedCB(action, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("cfg_army_id", 0)
		NetMgr:executeOperate(action, cj)
	end

	request()
end

---开始扫荡界面
BattleSweepPanel = {
	sweepTimes = 0,
	
	create = function(self)
		self:initBase()
		self:createLeft()
		self:createRight()
		return self
	end,

	createLeft = function(self)
		self.left = createDarkBG(368,540)
		self.left:setPosition(CCPoint(40,40))
		self.mainWidget:addChild(self.left)

		local label = CCLabelTTF:labelWithString("小提示：",CCSize(150,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(30,510))
		label:setColor(ccc3(255,204,103))
		self.left:addChild(label)

		local label = CCLabelTTF:labelWithString("1,挂机扫荡时,请保证背包有足够空间来领取奖励物品。",CCSize(320, 0),0,SYSFONT[EQUIPMENT],22)
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(30,470))
		label:setColor(ccc3(255,203,153))
		self.left:addChild(label)
	
		local label = CCLabelTTF:labelWithString("2,可关闭扫荡界面进行其他操作 ，但扫荡过程中不能再进行关卡或副本的战斗。",CCSize(320, 0),0,SYSFONT[EQUIPMENT],22)
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(30,405))
		label:setColor(ccc3(255,203,153))
		self.left:addChild(label)		
	end,

	createRight = function(self)
		self.right = createDarkBG(530,540)
		self.right:setPosition(CCPoint(430,40))
		self.mainWidget:addChild(self.right)
		
		self.sweepTimes = getDefaultTimes(cfgArmyId)
		
		local label = CCLabelTTF:labelWithString("所需时间：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(34,515))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)
		
		local label = CCLabelTTF:labelWithString(getLenQueTime(self.sweepTimes * 3 * 60),SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5,1))
		label:setPosition(CCPoint(530/2,480))
		label:setColor(ccc3(153,204,1))
		self.right:addChild(label)
		self.labelCooldown = label

		local label = CCLabelTTF:labelWithString("扫荡次数：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(34,418))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)

		local jian = dbUIButtonScale:buttonWithImage("UI/shopping/jian.png",1,ccc3(99,99,99))
		jian:setAnchorPoint(CCPoint(0, 0))
		jian:setPosition(CCPoint(64, 335))
		jian.m_nScriptClickedHandler = function()
			if self.sweepTimes > 1 then
				self.sweepTimes = self.sweepTimes - 1
				self.sweepTimesLabel:setString(self.sweepTimes)
				self.actionPointNeedLabel:setString(self.sweepTimes * 5)
				self.labelCooldown:setString(getLenQueTime(self.sweepTimes * 3 * 60))
			end
		end
		self.right:addChild(jian)

		local title_bg = CCSprite:spriteWithFile("UI/fight/num_bg.png")
		title_bg:setAnchorPoint(CCPoint(0, 0))
		title_bg:setPosition(CCPoint(132, 335))
		self.right:addChild(title_bg)
			
		local label = CCLabelTTF:labelWithString(self.sweepTimes,SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5,0.5))
		label:setPosition(CCPoint(150/2,25))
		label:setColor(ccc3(255,204,103))
		title_bg:addChild(label)
		self.sweepTimesLabel = label
		
		local jia = dbUIButtonScale:buttonWithImage("UI/shopping/jia.png",1,ccc3(99,99,99))
		jia:setAnchorPoint(CCPoint(0, 0))
		jia:setPosition(CCPoint(300, 335))
		jia.m_nScriptClickedHandler = function()
			if self.sweepTimes < getMaxTimes() then
				self.sweepTimes = self.sweepTimes + 1
				self.sweepTimesLabel:setString(self.sweepTimes)
				self.actionPointNeedLabel:setString(self.sweepTimes * 5)
				self.labelCooldown:setString(getLenQueTime(self.sweepTimes * 3 * 60))
			end
		end
		self.right:addChild(jia)

		local max = dbUIButtonScale:buttonWithImage("UI/fight/max.png",1,ccc3(99,99,99))
		max:setAnchorPoint(CCPoint(0, 0))
		max:setPosition(CCPoint(370, 335))
		max.m_nScriptClickedHandler = function()
			self.sweepTimes = getMaxTimes()
			self.sweepTimesLabel:setString(self.sweepTimes)
			self.actionPointNeedLabel:setString(self.sweepTimes * 5)
			self.labelCooldown:setString(getLenQueTime(self.sweepTimes * 3 * 60))
		end
		self.right:addChild(max)
		
		local label = CCLabelTTF:labelWithString("当前精力："..GloblePlayerData.action_point,CCSize(250,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(64,293))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)

		local label = CCLabelTTF:labelWithString("消耗精力：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(273,293))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)
		local label = CCLabelTTF:labelWithString(self.sweepTimes * 5,CCSize(150,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(390,293))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)
		self.actionPointNeedLabel = label
		
		local label = CCLabelTTF:labelWithString("怪物信息：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(34,235))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)
		
		for i = 1, #MonsterList do
			local monster = MonsterList[i]
			local row =  math.floor((i + 1) / 2)
			local cell = (i - 1) % 2 == 0 and 1 or 2
			
			local label = CCLabelTTF:labelWithString(monster.name.." LV"..monster.level,CCSize(500,0),0, SYSFONT[EQUIPMENT], 28)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(34 + (cell - 1) * 250,190 - (row - 1) * 35))
			label:setColor(ccc3(222,183,129))
			self.right:addChild(label)		
		end
		
		local btn = dbUIButtonScale:buttonWithImage("UI/fuben/start_sd.png", 1, ccc3(125, 125, 125))
		btn:setPosition(530/2,28)
		btn:setAnchorPoint(CCPoint(0.5,0))
		btn.m_nScriptClickedHandler = function()
			if GloblePlayerData.cell_count - getBaoguoItemCount() < 5 then
				new(ConfirmDialog):show({
					text = "背包剩余空间不多，是否继续？",
					width = 480,
					color = ccc3(253,205,156),
					onClickOk = function()
						self:startSweep()
					end
				})
			else
				self:startSweep()
			end
		end
		self.right:addChild(btn)
	end,
	
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1002)
		scene:addChild(self.uiLayer, 2002)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		self.top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(self.top)

		--面板提示图标
		local title_tip_bg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		title_tip_bg:setPosition(CCPoint(0, 12))
		title_tip_bg:setAnchorPoint(CCPoint(0, 0))
		self.top:addChild(title_tip_bg)
		local label = CCLabelTTF:labelWithString("关卡扫荡", SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setPosition(CCPoint(100,35))
		label:setColor(ccc3(255,203,153))
		title_tip_bg:addChild(label)
		--关闭按钮

		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			RewardList = {}
			MonsterList = {}
			self:destroy()
		end
		self.top:addChild(closeBtn.btn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		curSweep = 0
	end,

	--开始扫荡
	startSweep = function(self)
		local opFinishCB = function(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				self:destroy()
				
				local sweep_info = s:getByKey("sweep_info")
				setSweepInfo(sweep_info)
				
				local panel = new(BattleSweepingPanel)
				panel:create()
				panel:initScheduler()
			end
		end

		local executeSweep = function()
			showWaitDialog("waiting RaidCancle data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_ArmySweepStart, opFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_ArmySweepStart, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("cfg_army_id", cfgArmyId)
			cj:setByKey("sweep_times", self.sweepTimes)
			NetMgr:executeOperate(Net.OPT_ArmySweepStart, cj)
		end
		executeSweep()
	end,	
}

---扫荡中界面
BattleSweepingPanel = {
	
	create = function(self)
		self:initBase()
		self:createLeft()
		self:createRight()
		return self
	end,

	createLeft = function(self)
		self.left = createDarkBG(368,540)
		self.left:setPosition(CCPoint(40,40))
		self.mainWidget:addChild(self.left)

		self.UIList = dbUIList:list(CCRectMake(30, 10, 340, 430),0)
		self.left:addChild(self.UIList)

		local label = CCLabelTTF:labelWithString("正在扫荡...",CCSize(250,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0, 1))
		label:setPosition(CCPoint(30,520))
		label:setColor(ccc3(255,203,153))
		self.sweepingLabel = label
		self.left:addChild(label)

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(364/28)
		line:setPosition(2,458)
		self.left:addChild(line)
	end,

	createRight = function(self)
		self.right = createDarkBG(530,540)
		self.right:setPosition(CCPoint(430,40))
		self.mainWidget:addChild(self.right)

		local label = CCLabelTTF:labelWithString("所需时间：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(34,515))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)
		
		local label = CCLabelTTF:labelWithString(getLenQueTime(SweepInfo.CDTime),SYSFONT[EQUIPMENT], 36)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(530/2,430))
		label:setColor(ccc3(153,204,1))
		self.right:addChild(label)
		self.labelCooldown = label

		local label = CCLabelTTF:labelWithString("扫荡次数：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(34,370))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)

		local label = CCLabelTTF:labelWithString("剩余 "..(SweepInfo.sweepTimes - SweepInfo.sweepIndex).." 次",SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(180,370))
		label:setColor(ccc3(255,204,103))
		self.right:addChild(label)
		self.sweepTimesLabel = label
		
		local label = CCLabelTTF:labelWithString("当前精力："..GloblePlayerData.action_point,CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(34,315))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)
		self.actionPointLabel = label

		local label = CCLabelTTF:labelWithString("怪物信息：",CCSize(250,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(34,235))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)
		
		for i = 1, #MonsterList do
			local monster = MonsterList[i]
			local row =  math.floor((i + 1) / 2)
			local cell = (i - 1) % 2 == 0 and 1 or 2
			
			local label = CCLabelTTF:labelWithString(monster.name.." LV"..monster.level,CCSize(500,0),0, SYSFONT[EQUIPMENT], 28)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(34 + (cell - 1) * 250,190 - (row - 1) * 35))
			label:setColor(ccc3(222,183,129))
			self.right:addChild(label)		
		end
		
		local btn = dbUIButtonScale:buttonWithImage("UI/fuben/sssd.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0,0))
		btn:setPosition(CCPoint(100,28))
		btn.m_nScriptClickedHandler = function()
			local cost = (SweepInfo.sweepTimes - SweepInfo.sweepIndex) * 3
			new(ConfirmDialog):show({
				text = "是否花费"..cost.."金币快速完成扫荡？",
				width = 480,
				color = ccc3(253,205,156),
				onClickOk = function()
					self:fastSweep()
				end
			})
		end
		self.right:addChild(btn)
		self.fastSweepBtn = btn
		
		local btn = dbUIButtonScale:buttonWithImage("UI/fuben/cancel.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0,0))
		btn:setPosition(CCPoint(290,28))
		btn.m_nScriptClickedHandler = function()
			new(ConfirmDialog):show({
				text = "真的要取消本次扫荡吗？",
				width = 400,
				color = ccc3(253,205,156),
				onClickOk = function()
					self:cancelSweep()
				end
			})
		end
		self.right:addChild(btn)
		self.cancelSweepBtn = btn

		local btn = dbUIButtonScale:buttonWithImage("UI/fight/fh.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0))
		btn:setPosition(CCPoint(530/2,28))
		btn.m_nScriptClickedHandler = function()
			self:destroy()
			curSweep = 0	--扫荡返回后，清除curSweep
			local panel = new(BattleSweepPanel)
			panel:create()
		end
		btn:setIsVisible(false)
		self.right:addChild(btn)
		self.backSweepBtn = btn
	end,
	
	initScheduler = function(self)
		local setLenQueTime = function()
			if SweepInfo.CDTime > 0 then
				SweepInfo.CDTime = SweepInfo.CDTime - 1
				self.labelCooldown:setString(getLenQueTime(SweepInfo.CDTime))
			else
				self:sweepCheck()
			end
		end
		if self.timeHandle == nil then
			self.timeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
		end
		
		local check = function()
			self:sweepCheck()
		end		
		if self.checkHandle == nil then
			self.checkHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(check,16,false)
		end
	end,
	
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1002)
		scene:addChild(self.uiLayer, 2002)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		self.top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(self.top)

		--面板提示图标
		local titleTipBg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		titleTipBg:setPosition(CCPoint(0, 12))
		titleTipBg:setAnchorPoint(CCPoint(0, 0))
		self.top:addChild(titleTipBg)
		local label = CCLabelTTF:labelWithString("关卡扫荡", SYSFONT[EQUIPMENT], 37)
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setPosition(CCPoint(100,35))
		label:setColor(ccc3(255,203,153))
		titleTipBg:addChild(label)

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			RewardList = {}
			MonsterList = {}
			self:destroy()
		end
		self.top:addChild(closeBtn.btn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		curSweep = 0
		if self.timeHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
			self.timeHandle = nil
		end
		if self.checkHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.checkHandle)
			self.checkHandle = nil
		end
	end,

	finishSweep = function(self)
		if self.timeHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
			self.timeHandle = nil
		end
		if self.checkHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.checkHandle)
			self.checkHandle = nil
		end
		
		self.backSweepBtn:setIsVisible(true)
		self.fastSweepBtn:setIsVisible(false)
		self.cancelSweepBtn:setIsVisible(false)
		self.labelCooldown:setString("00:00")
		self.sweepingLabel:setString("扫荡已完成")
		self.sweepTimesLabel:setString(""..SweepInfo.sweepIndex.."次")
	end,
	
	updateReword = function(self,reward_list)
		local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
		for i = 1, reward_list:size() do
			curSweep = curSweep + 1
			local v = reward_list:getByIndex(i - 1)
			
			local rewordStr = "第"..curSweep.."轮扫荡完成。\n"

			if v:getByKey("reward_copper"):asInt() ~= 0 then
				rewordStr = rewordStr.."获得了"..v:getByKey("reward_copper"):asInt().."银币。\n"
			end
			if v:getByKey("reward_exploit"):asInt() ~= 0 then
				rewordStr = rewordStr.."获得了"..v:getByKey("reward_exploit"):asInt().."战功。\n"
			end			
			if v:getByKey("reward_prestige"):asInt() ~= 0 then
				rewordStr = rewordStr.."获得了"..v:getByKey("reward_prestige"):asInt().."神力。\n"
			end
			if v:getByKey("reward_exp"):asInt() ~= 0 then
				rewordStr = rewordStr.."获得了"..v:getByKey("reward_exp"):asInt().."经验。\n"
			end
			
			local reward_item_list = v:getByKey("reward_item_list")
			for j=1, reward_item_list:size() do
				local item = reward_item_list:getByIndex(j-1)
				local cfg_item_id = item:getByKey("reward_cfg_item_id"):asInt()
				local amount = item:getByKey("reward_amount"):asInt()
				local name = itemJsonConfig:getByKey(cfg_item_id..""):getByKey("name"):asString()
				rewordStr = rewordStr.."获得了"..name.."*"..amount.."。\n"
			end
			rewordStr = rewordStr.."\n\n"
			
			local label = CCLabelTTF:labelWithString(rewordStr,CCSize(300, 0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT],22)
			label:setAnchorPoint(CCPoint(0,1))
			label:setColor(ccc3(255,203,153))
			self.UIList:insterWidgetAtID(dbUIWidget:widgetWithSprite(label), self.UIList:getContent())
			
			globalGetRewardItem(v)
			table.insert(RewardList,rewordStr)
		end

		if reward_list:size() > 0 then
			local task = dbTaskMgr:getSingletonPtr():getBranchTaskInfo()
			if task and task.mCategory == cfgArmyId then
				local opFinishCB = function(s)
					GlobleUpdateBranckBattleFinished()
				end
				NetMgr:registOpLuaFinishedCB(Net.OPT_TaskGet, opFinishCB)
				
				local cj = Value:new()
				cj:setByKey("role_id", ClientData.role_id)
				cj:setByKey("request_code", ClientData.request_code)
				NetMgr:executeOperate(Net.OPT_TaskGet, cj)
				NetMgr:executeOperate(Net.OPT_NPC, cj)
			end
		end
		
		executeRoleSimple()	--可能升级，需要更新信息
	end,

	--定时检查
	sweepCheck = function(self)
		local opFinishCB = function(s)
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
				self:finishSweep()
				return
			end
			
			globalUpdateRoleCellCount(s)
			
			GloblePlayerData.action_point = s:getByKey("action_point"):asInt()

			local sweep_info = s:getByKey("sweep_info")
			setSweepInfo(sweep_info)

			local reward_list = s:getByKey("reward_list")
			self:updateReword(reward_list)
			
			self.sweepTimesLabel:setString("剩余 "..(SweepInfo.sweepTimes - SweepInfo.sweepIndex).." 次")
			self.actionPointLabel:setString("当前精力："..GloblePlayerData.action_point)
			if SweepInfo.CDTime == 0 then
				self:finishSweep()
			end
		end

		local executeRaidSweep = function()
			NetMgr:registOpLuaFinishedCB(Net.OPT_ArmySweepCheck, opFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_ArmySweepCheck, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("cfg_army_id", cfgArmyId)
			NetMgr:executeOperate(Net.OPT_ArmySweepCheck, cj)
		end
		executeRaidSweep()
	end,
	
	--神速扫荡
	fastSweep = function(self)
		local opFinishCB = function(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			end
			
			globalUpdateRoleCellCount(s)
			
			GloblePlayerData.action_point = s:getByKey("action_point"):asInt()

			local sweep_info = s:getByKey("sweep_info")
			setSweepInfo(sweep_info)
			
			local reward_list = s:getByKey("reward_list")
			self:updateReword(reward_list)

			self.sweepTimesLabel:setString("剩余 "..(SweepInfo.sweepTimes - SweepInfo.sweepIndex).." 次")
			self.actionPointLabel:setString("当前精力："..GloblePlayerData.action_point)
			
			self:finishSweep()
		end

		local executeFastSweep = function()
			showWaitDialog("")
			NetMgr:registOpLuaFinishedCB(Net.OPT_ArmySweepSpike, opFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_ArmySweepSpike, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("cfg_army_id", cfgArmyId)
			NetMgr:executeOperate(Net.OPT_ArmySweepSpike, cj)
		end
		executeFastSweep()
	end,

	--取消扫荡
	cancelSweep = function(self)
		local opFinishCB = function(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				self:destroy()
			end
		end
		local executeCancelSweep = function()
			showWaitDialog("")
			NetMgr:registOpLuaFinishedCB(Net.OPT_ArmySweepCancel, opFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_ArmySweepCancel, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("cfg_army_id", cfgArmyId)
			NetMgr:executeOperate(Net.OPT_ArmySweepCancel, cj)
		end
		executeCancelSweep()
	end,
}
--战斗前提示面板

local current_camp = 0  --当前正在进行的战役
local reward_copper = 0

globalSetBossWarBattleReward = function(jValue)
	reward_copper = jValue:getByKey("copper"):asInt()
end

FightDialogPanel =
{
	centerWidget = nil,
	mainWidget = nil,

	create = function(self,data,battleType,canResult)
		self.data = data
		self.battleType = battleType
		self.canResult = canResult

		self:initBase()
		self:createMain()
	end,

	createMain = function(self)
		if self.mainWidget then
			self.mainWidget:removeAllChildrenWithCleanup(true)
		end

		local data = self.data
		local battleType = self.battleType
		local canResult = self.canResult

		--左边
		--显示阵型
		local zxBg = createBG("UI/public/kuang_xiao_mi_shu.png",262,533)
		zxBg:setAnchorPoint(CCPoint(0, 0))
		zxBg:setPosition(CCPoint(40, 50))
		self.centerWidget:addChild(zxBg)
		local txt = CCLabelTTF:labelWithString("当前阵型：",CCSizeMake(250, 0), CCTextAlignmentLeft,  SYSFONT[EQUIPMENT], 28)
		txt:setAnchorPoint(CCPoint(0,0))
		txt:setPosition(CCPoint(30,472))
		txt:setColor(ccc3(153,205,0))
		zxBg:addChild(txt)
		local zhenFaConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_formation.json")
		local zf = zhenFaConfig:getByKey(GloblePlayerData.cur_formation)
		local txt = CCLabelTTF:labelWithString(zf:getByKey("name"):asString(),CCSizeMake(280, 0), CCTextAlignmentLeft,  SYSFONT[EQUIPMENT], 32)
		txt:setAnchorPoint(CCPoint(0,0))
		txt:setPosition(CCPoint(30,430))
		txt:setColor(ccc3(255,204,103))
		zxBg:addChild(txt)
		
		local btn = new(ButtonScale)
		btn:create("UI/fight/hz.png",1.2)
		btn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn.btn:setPosition(CCPoint(262/2,355))
		btn.btn.m_nScriptClickedHandler = function(ccp)
			globleShowZhenFaPanel()
		end
		zxBg:addChild(btn.btn)
		--阵形功能未开启时，不显示换阵按钮
		local stepCfg = openJson("cfg/cfg_step.json")
		local requireOfficium = stepCfg:getByKey("formation_open"):getByKey("require_officium"):asInt()
		if GloblePlayerData.officium < requireOfficium then
			btn.btn:setIsVisible(false)
		end
		
		local btn = new(ButtonScale)
		btn:create("UI/fight/gl.png",1.2)
		btn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn.btn:setPosition(CCPoint(262/2,275))
		btn.btn.m_nScriptClickedHandler = function(ccp)
			callReplayPanel(data.cfg_army_id)
		end
		btn.btn:setIsVisible(false)
		zxBg:addChild(btn.btn)
		
		--当前精力值
		local txt = CCLabelTTF:labelWithString("当前精力值 : ", CCSizeMake(300, 0), CCTextAlignmentLeft,  SYSFONT[EQUIPMENT], 28)
		txt:setAnchorPoint(CCPoint(0, 0))
		txt:setPosition(CCPoint(30,220))
		txt:setColor(ccc3(153,205,0))
		zxBg:addChild(txt)
		local txt = CCLabelTTF:labelWithString(GloblePlayerData.action_point.."/300", CCSizeMake(0, 0), CCTextAlignmentLeft,  SYSFONT[EQUIPMENT], 32)
		txt:setAnchorPoint(CCPoint(0, 0))
		txt:setPosition(CCPoint(30,180))
		txt:setColor(ccc3(255,204,103))
		zxBg:addChild(txt)
		self.jingliLabel = txt
		local btn = new(ButtonScale)
		btn:create("UI/playerInfos/bc.png",1.2)
		btn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn.btn:setPosition(CCPoint(262/2,110))
		btn.btn.m_nScriptClickedHandler = function(ccp)
			self:addJinLi()
		end
		zxBg:addChild(btn.btn)
		
		--右边
		local rightBg = createBG("UI/public/kuang_xiao_mi_shu.png",650,434)
		rightBg:setAnchorPoint(CCPoint(0, 0))
		rightBg:setPosition(CCPoint(315, 150))
		self.mainWidget:addChild(rightBg)
		local rightBgHead = createBG("UI/ri_chang/list_head_bg.png",650,434/2,CCSize(23,23))
		rightBgHead:setAnchorPoint(CCPoint(0, 0))
		rightBgHead:setPosition(CCPoint(0, 434/2))
		rightBg:addChild(rightBgHead)
		--敌人
		local txt = CCLabelTTF:labelWithString(data.name,CCSizeMake(0, 0), CCTextAlignmentLeft,  SYSFONT[EQUIPMENT], 28)
		txt:setAnchorPoint(CCPoint(0.5,0))
		txt:setPosition(CCPoint(83,22+434/2))
		txt:setColor(ccc3(254,153,0))
		rightBg:addChild(txt)

		local kuangs = {}
		for i=1,5 do
			local kuang = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			kuang:setPosition(CCPoint(35+(i-1)*120, 434/2+70))
			kuang:setAnchorPoint(CCPoint(0, 0))
			rightBg:addChild(kuang)
			kuangs[i]=kuang
		end

		local index = 1
		for i=1,9 do
			if data["pos_"..i] ~= 0 then
				local head_img = CCSprite:spriteWithFile("head/Middle/head_middle_"..data["pos_"..i]..".png")
				head_img:setPosition(CCPoint(96/2, 96/2))
				head_img:setScale(0.8*96/head_img:getContentSize().width)
				kuangs[index]:addChild(head_img)
				index = index+1
			end
		end

		local vs = CCSprite:spriteWithFile("UI/fight/vs.png")
		vs:setAnchorPoint(CCPoint(0.5, 0.5))
		vs:setPosition(CCPoint(650/2, 434/2))
		rightBg:addChild(vs)
		
        --玩家
		local kuangs = {}
		local index = 1
		for i=1,5 do
			local kuang = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			kuang:setPosition(CCPoint(35+(i-1)*120, 60))
			kuang:setAnchorPoint(CCPoint(0, 0))
			rightBg:addChild(kuang)
			kuangs[i]=kuang
		end
		local formation = findFormationsById(GloblePlayerData.cur_formation)
		for i=1,9 do
			if formation.pos[i] ~= 0 then
				local general = findGeneralByGeneralId(formation.pos[i])
				if general ~= 0 then
					local head_img = CCSprite:spriteWithFile("head/Middle/head_middle_"..general.face..".png")
					head_img:setPosition(CCPoint(96/2, 96/2))
					head_img:setScale(0.8*96/head_img:getContentSize().width)
					kuangs[index]:addChild(head_img)
					index = index+1
				end
			end
		end

		local txt = CCLabelTTF:labelWithString(ClientData.role_name,CCSizeMake(0, 0), CCTextAlignmentRight,  SYSFONT[EQUIPMENT], 28)
		txt:setAnchorPoint(CCPoint(0.5,0))
		txt:setPosition(CCPoint(563,175))
		txt:setColor(ccc3(153,205,0))
		rightBg:addChild(txt)
      
		--下面开始打架按钮
		local startFightBtn = new(ButtonScale)
		startFightBtn:create("UI/fight/start.png",1.2)
		startFightBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		startFightBtn.btn:setPosition(CCPoint(634,88))
		startFightBtn.btn.m_nScriptClickedHandler = function(ccp)
			if checkFormationIsEmpty() then
				return
			end
			
			current_camp = data.cfg_camp_id

			local function opBattleFinishCB(s)
				WaitDialog.closePanelFunc()
				local error_code = s:getByKey("error_code"):asInt()
				if error_code == -1 then
					self:destroy()
				end
			end
			
			showWaitDialogNoCircle("waiting battle data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_BattleSimple, opBattleFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_BattleSimple, opFailedCB)
			if canResult then
				GlobleSetCanSeeResult(1)
			else
				GlobleSetCanSeeResult(0)
			end
			globalRoleSimpleOnce = true
			dbSceneMgr:getSingletonPtr():changeToBattleScene(data.cfg_army_id, battleType)
		end
		self.mainWidget:addChild(startFightBtn.btn)
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1002)
		scene:addChild(self.uiLayer, 2002)

		local bg = CCSprite:spriteWithFile("UI/public/bg.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setPosition(CCPoint(1024 - 75,768 - 125))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.centerWidget:addChild(closeBtn)
		
		--怪物等级
		local amy_level = CCSprite:spriteWithFile("UI/fight/amy_level.png")
		amy_level:setPosition(CCPoint(128,768 - 125))
		self.centerWidget:addChild(amy_level)
		local txt = CCLabelTTF:labelWithString(self.data.level,CCSizeMake(150, 0), CCTextAlignmentLeft,  SYSFONT[EQUIPMENT], 26)
		txt:setPosition(CCPoint(290,768 - 125))
		txt:setColor(ccc3(255,204,103))
		self.centerWidget:addChild(txt)
		--奖励
		local amy_level = CCSprite:spriteWithFile("UI/fight/jiang_li.png")
		amy_level:setPosition(CCPoint(350,768 - 125))
		self.centerWidget:addChild(amy_level)

		if self.data.reward_prestige and self.data.reward_prestige~=0 then
			local battleReward = CCLabelTTF:labelWithString("神力 "..self.data.reward_prestige, SYSFONT[EQUIPMENT], 26)
			battleReward:setAnchorPoint(CCPoint(0.5, 0.5))
			battleReward:setPosition(CCPoint(460,768 - 125))
			battleReward:setColor(ccc3(255,204,103))
			self.centerWidget:addChild(battleReward)
		end
				
		
		if self.data.reward_item~=0 then
			local kuang_panel = dbUIPanel:panelWithSize(CCSize(76, 76))
			kuang_panel:setAnchorPoint(CCPoint(0.5, 0.5))
			kuang_panel:setPosition(600,768 - 125)
			self.centerWidget:addChild(kuang_panel)
			local kuang_76 = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			kuang_76:setPosition(CCPoint(76/2,76/2))
			kuang_76:setAnchorPoint(CCPoint(0.5, 0.5))
			kuang_panel:addChild(kuang_76)
			local dropWood = getItemBorder(self.data.reward_item)
			dropWood:setAnchorPoint(CCPoint(0.5, 0.5))
			dropWood:setPosition(CCPoint(76/2,76/2))
			kuang_panel:addChild(dropWood)
			
			kuang_panel:setScale(kuang_panel:getContentSize().width/dropWood:getContentSize().width)
			
			local gailvtext = CCLabelTTF:labelWithString("（概率获得） ", SYSFONT[EQUIPMENT], 22)
			gailvtext:setAnchorPoint(CCPoint(0.5, 0.5))
			gailvtext:setPosition(CCPoint(725-10,768 - 125-20))
			gailvtext:setColor(ccc3(255,204,103))	
			self.centerWidget:addChild(gailvtext)	
		end
		
		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
	end,
	
	--增加精力
	addJinLi = function(self)
		self.createJunPanel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		self.createJunPanel.m_nScriptClickedHandler = function(ccp)
			self.createJunPanel:removeFromParentAndCleanup(true)
		end
		self.centerWidget:addChild(self.createJunPanel,100000)

		local createbg = createBG("UI/public/dialog_kuang.png",500,250,CCSize(60,60))
		createbg:setAnchorPoint(CCPoint(0.5, 0.5))
		createbg:setPosition(CCPoint(512,450))
		self.createJunPanel:addChild(createbg)
		local bgFoot = createBG("UI/playerInfos/foot.png",456,60,CCSize(30,25))
		bgFoot:setAnchorPoint(CCPoint(0.5,0))
		bgFoot:setPosition(CCPoint(500/2,20))
		createbg:addChild(bgFoot)
		
		local createLabel = function(text,pos,color,width)
			local label = CCLabelTTF:labelWithString(text,CCSize(width,0),0, SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(pos)
			label:setColor(color)
			bgFoot:addChild(label)			
		end
		
		createLabel("共有金币：",CCPoint(25,30),ccc3(255,203,102),200)
		createLabel(getShotNumber(GloblePlayerData.gold),CCPoint(150,30),ccc3(254,103,0),300)
		
		createLabel("共有朗姆酒：",CCPoint(240,30),ccc3(255,203,102),300)
		createLabel(GloblePlayerData.ap_wand,CCPoint(392,30),ccc3(254,103,0),300)

		--金币补充
		local btn = dbUIButtonScale:buttonWithImage("UI/playerInfos/jb.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(145,170))
		btn.m_nScriptClickedHandler = function(ccp)
			if GloblePlayerData.gold==0 then
				alert("没金币了")
			else
				local item = BU_CHONG_JING_LI_CFG[3]
				self:ju_hua_BtnAction(item)
			end
		end
		createbg:addChild(btn)

		local label = CCLabelTTF:labelWithString("花费20金补充10点", SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0.5,0.5))
		label:setPosition(CCPoint(btn:getContentSize().width/2,-25))
		label:setColor(ccc3(103,51,1))
		btn:addChild(label)	
			
		--朗姆酒
		local btn = dbUIButtonScale:buttonWithImage("UI/playerInfos/lmj.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(360,170))
		btn.m_nScriptClickedHandler = function(ccp)
			if GloblePlayerData.ap_wand==0 then
				alert("没有朗姆酒了")
			else
				local item = BU_CHONG_JING_LI_CFG[1]
				self:ju_hua_BtnAction(item)
			end
		end
		createbg:addChild(btn)
		local label = CCLabelTTF:labelWithString("使用朗姆酒补充", SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0.5,0.5))
		label:setPosition(CCPoint(btn:getContentSize().width/2,-25))
		label:setColor(ccc3(103,51,1))
		btn:addChild(label)
		
		self.addJiLiOkBtn = btn
	end,

	ju_hua_BtnAction = function(self,item)
		local Reponse = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				GloblePlayerData.gold = json:getByKey("gold"):asInt()
				GloblePlayerData.action_point = json:getByKey("action_point"):asInt()
				GloblePlayerData.ap_wand = json:getByKey("ap_wand"):asInt()
				updataHUDData()
				self:reflash()
			end
		end

		local sendRequest = function ()
			showWaitDialogNoCircle("waiting skillLock!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_ActionPointCharge,Reponse)
			NetMgr:registOpLuaFailedCB(Net.OPT_ActionPointCharge,opFailedCB)
			local cj = Value:new()

			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("type",item.ju_hua)

			NetMgr:executeOperate(Net.OPT_ActionPointCharge, cj)
		end
		sendRequest()
	end,
	
	--更新精力值
	reflash = function(self)
		if self.createJunPanel then
			self.createJunPanel:removeFromParentAndCleanup(true)
		end
		if self.jingliLabel ~= nil then
			self.jingliLabel:setString(GloblePlayerData.action_point.."/300")
		end
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		removeUnusedTextures()
	end
}

GlobalLeavedBattleScene = function(s)
	local battleType = s:getByIndex(0):asInt()
	local leaveBotton = s:getByIndex(1):asInt()

	local moveToSubmit = false
	if battleType == 3 and current_camp ~= 0 then
		moveToSubmit = CheckSubmitAfterBattle()
		if leaveBotton == 0 then
			--判断战斗结束后是否需要去提交,如果需要提交，则直接移动到目标城市提交，在 world_map中实现
			if not moveToSubmit then
				callCampPanel(current_camp)
			end
		end
	elseif battleType == 1 and GloblePrivatePanel ~= nil then
		GloblePrivatePanel:checkMessage()
	elseif battleType == 9 and current_camp ~= 0 then
		if leaveBotton == 0 then
			createFubenFightPanel( current_camp )
		end
	elseif battleType == 7 then
		if leaveBotton == 0 then
			globleCreateArena()
		end
	elseif battleType == 6 then
		if leaveBotton == 0 then
			GlobleCreateYongBingDaJie()
		end
	end
	
	local callPanelHandle = 0
	local function callPanel()
		CCScheduler:sharedScheduler():unscheduleScriptEntry(callPanelHandle)
		
		if moveToSubmit then GlobleCloseBattleFightPanel() end
		
		if battleType == -9 then
			CheckCaveAgain()
			return
		end
		if battleType == 8 then
			MausoleumReward(reward_copper)
			reward_copper = 0
		end
		if battleType == 4 then
			closeWait()
		end
		if battleType == 5 then
			closeWait()
		end
		if leaveBotton == 0 then
			return
		end

		if battleType == 3 and GlobleBattlePanel ~= nil then
			GlobleBattlePanel:destroy()
		elseif battleType == 7 and GlobleDailyPanel ~= nil then
			GlobleDailyPanel:destroy()
		elseif battleType == 9 and GlobleFubenMainPanel ~= nil then
			GlobleFubenMainPanel:destroy()
		elseif battleType == 6 and GlobleShipPanel ~= nil then
			GlobleShipPanel:destroy()
		end

		--从战斗失败界面返回
		if leaveBotton == 1 then		--训练
			globleShowXunLianPanel()	
		elseif leaveBotton == 2 then	--强化
			globleShowQHPanel()
		elseif leaveBotton == 3 then	--阵形
			globleShowZhenFaPanel()
		elseif leaveBotton == 4 then	--洗髓
			globleShowXiSuiPanel()
		elseif leaveBotton == 5 then	--科技
			globle_create_tian_fu()
		elseif leaveBotton == 6 then	--祭星
			globleShowJiFete()
		end
	end
	callPanelHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(callPanel,0.1,false)
end

executeBattle = function(id, bType)
	local function opBattleFinishCB(s)
		WaitDialog.closePanelFunc()
		local error_code = s:getByKey("error_code"):asInt()
		if error_code ~= -1 then
			ShowErrorInfoDialog(error_code)
		end
	end

	showWaitDialog("waiting battle data")
	NetMgr:registOpLuaFinishedCB(Net.OPT_BattleSimple, opBattleFinishCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_BattleSimple, opFailedCB)
	GlobleSetCanSeeResult(0)
	dbSceneMgr:getSingletonPtr():changeToBattleScene(id, bType)
end

--战斗结束后获得奖励
globalGetRewardItem = function(resultData)
	local reward_exploit = resultData:getByKey("reward_exploit"):asInt()
	local reward_prestige = resultData:getByKey("reward_prestige"):asInt()
	local reward_exp = resultData:getByKey("reward_exp"):asInt()
	local reward_copper = resultData:getByKey("reward_copper"):asInt()
	
	local reward_item_list = resultData:getByKey("reward_item_list")
	for i=1, reward_item_list:size() do
		local reward_item = reward_item_list:getByIndex(i-1)
		local itemInfo = {
			reward_item:getByKey("reward_cfg_item_id"):asInt(),
			reward_item:getByKey("reward_item_id"):asInt(),
			reward_item:getByKey("reward_amount"):asInt(),
			false
		}
		battleGetItems(itemInfo,true)
	end
	
	GloblePlayerData.exploit = GloblePlayerData.exploit + reward_exploit
	GloblePlayerData.prestige = GloblePlayerData.prestige + reward_prestige
	GloblePlayerData.copper = GloblePlayerData.copper +  reward_copper
	updataHUDData()
end

globalShowFightResultPanel = function(fightLayer, data)
	new(FightResultPanel):create(fightLayer, data)
end

local caltScaleMin = function(designSize)
	local scaleX = WINSIZE.width/designSize.width
	local scaleY = WINSIZE.height/designSize.height
	local scale = scaleX > scaleY and scaleY or scaleX
	return scale
end

local designSize = CCSize(1280, 720)
local panelScale = caltScaleMin(designSize)

local function createWinItemByItemId(item_id,amount)

	local width = 180
	local height = 0
	local panel = dbUIPanel:panelWithSize(CCSize(width, 0))
	panel:setAnchorPoint(CCPoint(0, 0.5))

	local item_info = findShowItemInfo(item_id)
	--从下往上，以此计算高度
	--物品名字
	local item_name = CCLabelTTF:labelWithString(item_info.name.."*"..amount, CCSize(width, 0), CCTextAlignmentCenter, SYSFONT[EQUIPMENT], 26)
	item_name:setColor(ccc3(254, 244, 223))
	item_name:setAnchorPoint(CCPoint(0.5, 0))
	item_name:setPosition(CCPoint(width / 2, 0))
	height = height + item_name:getContentSize().height
	panel:addChild(item_name) 
	--框
	local kuang = dbUIWidget:widgetWithImage("UI/fight/item_kuang.png")
	kuang:setAnchorPoint(CCPoint(0.5, 0))
	kuang:setPosition(CCPoint(width / 2, height))
	height = height + kuang:getContentSize().height
	panel:addChild(kuang)
	--物品
	local item_icon = dbUIButtonScale:buttonWithImage("icon/Item/icon_item_"..item_info.icon..".png", 1.2, ccc3(125, 125, 125))
	item_icon:setAnchorPoint(CCPoint(0.5, 0.5))
	item_icon:setPosition(CCPoint(kuang:getContentSize().width / 2, kuang:getContentSize().height / 2))
	item_icon:setScale(90 / item_icon:getContentSize().width)
	item_icon.m_nScriptClickedHandler = function()
		local item_cfg = {
			item = item_info,
			from = "view"
		}
		ItemClickHandler(item_cfg)
	end
	kuang:addChild(item_icon)
	
	panel:setContentSize(CCSize(width, height))
	return panel
end

--获取当前神位已经开启的功能在配置表中的位置
local getCurLevelOpenFunctionIndex = function(cfg)
	for index = 1, #cfg do
		if cfg[index].reqLv > GloblePlayerData.officium then
			return index-1
		end
	end
	return #cfg
end

FightResultPanel = {
	
	itemsArea = nil,
	pageCount = 1,
	page = 1, --当前页
	pagePanels = nil, -- {panel=singlePagePanel,items={},page=page,loaded=false}
	
	openIndex = 0,	--对于配置表中的功能，已经开放的个数
	--以上数据只针对失败界面
	
	create = function(self, fightLayer, data)
		self:initBase(fightLayer, data)
		self:createBG()
		self:createContent()
	end,
	
	initBase = function(self, fightLayer, data)
		local scene = DIRECTOR:getRunningScene()
		self.uiLayer = dbUIMask:node()
		self.centerWidget = dbUIPanel:panelWithSize(CCSize(929, 587));
		self.centerWidget:setAnchorPoint(CCPoint(0.5, 0.5))
		self.centerWidget:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
		self.centerWidget:setScale(panelScale)
		self.uiLayer:addChild(self.centerWidget)
		
		scene:addChild(self.uiLayer, 2000, 100)	--100为RESULT_TAG
		
		self.fightLayer = fightLayer
		self.data = data
		
	end,
	
	createBG = function(self)
		local bg = CCSprite:spriteWithFile("UI/fight/bg.png")
		bg:setPosition(CCPoint(929 / 2, 587 / 2))
		self.centerWidget:addChild(bg)
		
		local qd = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1.2, ccc3(125, 125, 125))
		qd:setPosition(CCPoint(300, 60))
		qd.m_nScriptClickedHandler = function()
			self.fightLayer:backBtnCallbackForLua()
		end
		self.centerWidget:addChild(qd,1);

		local replay = dbUIButtonScale:buttonWithImage("UI/fight/replay.png", 1.2, ccc3(125, 125, 125))
		replay:setPosition(CCPoint(629,60));
		replay.m_nScriptClickedHandler = function()
			self.fightLayer:rePlayWarForLua()
		end
		self.centerWidget:addChild(replay,1)
	end,
	
	createContent = function(self)
		if self.data then
			self:createWin()
		else
			self:createLose()
		end
	end,
	
	createWin = function(self)
		--你获胜了
		local title = CCSprite:spriteWithFile("UI/fight/win.png")
		title:setAnchorPoint(CCPoint(0.5, 0))
		title:setPosition(CCPoint(929 / 2, 400))
		self.centerWidget:addChild(title)
		--斩获
		local zhan_huo = CCSprite:spriteWithFile("UI/fight/zhan_huo.png")
		zhan_huo:setAnchorPoint(CCPoint(0, 0))
		zhan_huo:setPosition(CCPoint(40, 330))
		self.centerWidget:addChild(zhan_huo)
		--斩获内容
		local offsetX = zhan_huo:getContentSize().width
		--战功
		local reward_exploit = self.data:getByKey("reward_exploit"):asInt()
		if reward_exploit > 0 then
			local exploit_label = CCLabelTTF:labelWithString("战功", CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 28)
			exploit_label:setColor(ccc3(254, 244, 223))
			exploit_label:setAnchorPoint(CCPoint(0, 0.5))
			exploit_label:setPosition(CCPoint(offsetX + 10, zhan_huo:getContentSize().height / 2))
			zhan_huo:addChild(exploit_label)
			local exploit_value = CCLabelTTF:labelWithString("*"..reward_exploit, CCSize(100, 0), 0, SYSFONT[EQUIPMENT], 28)
			exploit_value:setAnchorPoint(CCPoint(0, 0.5))
			exploit_value:setPosition(CCPoint(exploit_label:getContentSize().width + 5, exploit_label:getContentSize().height / 2))
			exploit_value:setColor(ccc3(42, 1, 0))
			exploit_label:addChild(exploit_value)
			offsetX = offsetX + 10 + exploit_label:getContentSize().width + 5 + exploit_value:getContentSize().width
		end
		--神力
		local reward_prestige = self.data:getByKey("reward_prestige"):asInt()
		if reward_prestige > 0 then
			local prestige_label = CCLabelTTF:labelWithString("神力", CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 28)
			prestige_label:setColor(ccc3(254, 244, 223))
			prestige_label:setAnchorPoint(CCPoint(0, 0.5))
			prestige_label:setPosition(CCPoint(offsetX + 10, zhan_huo:getContentSize().height / 2))
			zhan_huo:addChild(prestige_label)
			local prestige_value = CCLabelTTF:labelWithString("*"..reward_prestige, CCSize(100, 0), 0, SYSFONT[EQUIPMENT], 28)
			prestige_value:setAnchorPoint(CCPoint(0, 0.5))
			prestige_value:setPosition(CCPoint(prestige_label:getContentSize().width + 5, prestige_label:getContentSize().height / 2))
			prestige_value:setColor(ccc3(42, 1, 0))
			prestige_label:addChild(prestige_value)
			offsetX = offsetX + 10 + prestige_label:getContentSize().width + 5 + prestige_value:getContentSize().width
		end
		--经验
		local reward_exp = self.data:getByKey("reward_exp"):asInt()
		if reward_exp > 0 then
			local exp_label = CCLabelTTF:labelWithString("经验", CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 28)
			exp_label:setColor(ccc3(254, 244, 223))
			exp_label:setAnchorPoint(CCPoint(0, 0.5))
			exp_label:setPosition(CCPoint(offsetX + 10, zhan_huo:getContentSize().height / 2))
			zhan_huo:addChild(exp_label)
			local exp_value = CCLabelTTF:labelWithString("*"..reward_exp, CCSize(100, 0), 0, SYSFONT[EQUIPMENT], 28)
			exp_value:setAnchorPoint(CCPoint(0, 0.5))
			exp_value:setPosition(CCPoint(exp_label:getContentSize().width + 5, exp_label:getContentSize().height / 2))
			exp_value:setColor(ccc3(42, 1, 0))
			exp_label:addChild(exp_value)
			offsetX = offsetX + 10 + exp_label:getContentSize().width + 5 + exp_value:getContentSize().width
		end
		--银币
		local reward_copper = self.data:getByKey("reward_copper"):asInt()
		if reward_copper > 0 then
			local copper_label = CCLabelTTF:labelWithString("银币", CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 28)
			copper_label:setColor(ccc3(254, 244, 223))
			copper_label:setAnchorPoint(CCPoint(0, 0.5))
			copper_label:setPosition(CCPoint(offsetX + 10, zhan_huo:getContentSize().height / 2))
			zhan_huo:addChild(copper_label)
			local copper_value = CCLabelTTF:labelWithString("*"..reward_copper, CCSize(100, 0), 0, SYSFONT[EQUIPMENT], 28)
			copper_value:setAnchorPoint(CCPoint(0, 0.5))
			copper_value:setPosition(CCPoint(copper_label:getContentSize().width + 5, copper_label:getContentSize().height / 2))
			copper_value:setColor(ccc3(42, 1, 0))
			copper_label:addChild(copper_value)
			offsetX = offsetX + 10 + copper_label:getContentSize().width + 5 + copper_value:getContentSize().width
		end
		--获得物品
		local huo_de_wu_pin = CCSprite:spriteWithFile("UI/fight/huo_de_wu_pin.png")
		huo_de_wu_pin:setAnchorPoint(CCPoint(0, 0))
		huo_de_wu_pin:setPosition(CCPoint(40, 240))
		self.centerWidget:addChild(huo_de_wu_pin)
		--物品内容
		local reward_item_list = self.data:getByKey("reward_item_list")
		offsetX = huo_de_wu_pin:getPositionX() + huo_de_wu_pin:getContentSize().width + 20
		local y = huo_de_wu_pin:getPositionY() - 110
		if reward_item_list:size() > 0 then
			local itemUIList = dbUIScrollList:scrollList(CCRectMake(offsetX, y, 650, 160), 1);
			for i = 1, reward_item_list:size() do
				local reward_item = reward_item_list:getByIndex(i-1)
				local cfg_item_id = reward_item:getByKey("reward_cfg_item_id"):asInt()
				local amount = reward_item:getByKey("reward_amount"):asInt()
				
				local panel = createWinItemByItemId(cfg_item_id,amount)
				itemUIList:insterDetail(panel)
			end
			self.centerWidget:addChild(itemUIList)
		end
	end,
	
	createLose = function(self)
		--石头人
		local title = CCSprite:spriteWithFile("UI/fight/lose_pic.png")
		title:setAnchorPoint(CCPoint(0.5, 0))
		title:setPosition(CCPoint(929 / 2 + 40, 350))
		self.centerWidget:addChild(title)
		--失败
		local lose = CCSprite:spriteWithFile("UI/fight/lose.png")
		lose:setAnchorPoint(CCPoint(0, 1))
		lose:setPosition(CCPoint(40, 557))
		self.centerWidget:addChild(lose)
		--创建滚动区域
		self.openIndex = getCurLevelOpenFunctionIndex(lose_item_info)
		self.pageCount = math.ceil(#lose_item_info / 6)
		self:createLoseScrollArea()
		self:loadPage(self.page)
	end,
	
	createLoseScrollArea = function(self)
		local scroll_size = CCSize(919, 255)
		local pagePanelContainer = dbUIPanel:panelWithSize(CCSize(scroll_size.width * self.pageCount,scroll_size.height))
		pagePanelContainer:setAnchorPoint(CCPoint(0, 0))
		pagePanelContainer:setPosition(0, 0)
		
		self.pagePanels = new({})
		for i=1,self.pageCount do
			local singlePage = self:createSinglePage(i, scroll_size)
			pagePanelContainer:addChild(singlePage)
		end
		
		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pagePanelContainer, 1, self.pageCount)
        self.scrollArea:setAnchorPoint(CCPoint(0, 0))
        self.scrollArea:setScrollRegion(CCRect(0, 0, scroll_size.width, scroll_size.height))
        self.scrollArea:setPosition(5,130)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.page = page+1
			--public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
			self:loadPage(self.page)
		end
		self.centerWidget:addChild(self.scrollArea)
		self.scrollArea:scrollToPage(self.page-1,false)
	end,
	
	createSinglePage = function(self, page, size)
		local singlePagePanel = dbUIPanel:panelWithSize(size)
		singlePagePanel:setAnchorPoint(CCPoint(0, 0))
        singlePagePanel:setPosition((page-1)*size.width, 0)
       
        local pagePanel = {panel=singlePagePanel,items={},page=page,loaded=false}
        self.pagePanels[page] = pagePanel
        return singlePagePanel
	end,
	
	--加载某一页的数据
	loadPage = function(self,page)
		local pagePanel = self.pagePanels[page]
		if pagePanel.loaded then
			return
		end
		--当前页显示的个数
		local count = math.min(#lose_item_info - (page-1) * 6, 6)
		for i = 1, count do
			local item_panel = self:createItem(i)
			pagePanel.panel:addChild(item_panel)
			pagePanel.items[i] = item_panel	
		end
		
		pagePanel.loaded = true
	end,
	
	createItem = function(self, i)
		local curIndex = (self.page-1) * 6 + i
		local panel = dbUIPanel:panelWithSize(CCSize(286, 116))
		panel:setAnchorPoint(CCPoint(0, 0))
		panel:setPosition(lose_item_cfg[i].pos)
		--背景
		local item_bg = CCSprite:spriteWithFile(lose_item_cfg[i].bg)
		item_bg:setAnchorPoint(CCPoint(0, 0))
		item_bg:setPosition(CCPoint(0, 0))
		panel:addChild(item_bg)
		--框
		local kuang = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
		kuang:setAnchorPoint(CCPoint(0, 0.5))
		kuang:setPosition(10, 116 / 2)
		panel:addChild(kuang)
		--icon
		local icon = dbUIButtonScale:buttonWithImage(lose_item_info[curIndex].icon, 1, ccc3(125, 125, 125))
		icon:setAnchorPoint(CCPoint(0, 0))
		local offsetX = (kuang:getContentSize().width - icon:getContentSize().width) / 2
		icon:setPosition(CCPoint(10 + offsetX, 12))
		icon.m_nScriptClickedHandler = function()
			FightLayer:setLeaveBattleClickBotton(lose_item_info[curIndex].leave_id)
			self.fightLayer:backBtnCallbackForLua()
		end
		panel:addChild(icon)
		
		--功能名字 
		local nameImage = CCSprite:spriteWithFile(lose_item_info[curIndex].name)
		nameImage:setAnchorPoint(CCPoint(0, 0.5))
		nameImage:setPosition(CCPoint(116, 76))
		panel:addChild(nameImage)
		--是否已经开放
		local openInfo = nil
		local color = nil
		if curIndex > self.openIndex then	--功能未开放
			openInfo = "（"..lose_item_info[curIndex].reqLv.."级开启）"
			color = ccc3(255, 0, 0)
			icon:setIsEnabled(false)
		else
			openInfo = "（功能已开启）"
			color = ccc3(61, 32, 2)
		end
		local openLabel = CCLabelTTF:labelWithString(openInfo, CCSize(300, 0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 22)
		openLabel:setAnchorPoint(CCPoint(0, 0.5))
		openLabel:setPosition(CCPoint(116, 35))
		openLabel:setColor(color)
		panel:addChild(openLabel)
		
		return panel	
	end,
	
	destroy = function()
	end
}

lose_item_cfg = {
	{pos = CCPoint(15, 116 + 20), 					bg = "UI/fight/lose_item_bg_1.png"},
	{pos = CCPoint(15 + (286 + 15), 116 + 20), 		bg = "UI/fight/lose_item_bg_1.png"},
	{pos = CCPoint(15 + (286 + 15) * 2, 116 + 20), 	bg = "UI/fight/lose_item_bg_1.png"},
	{pos = CCPoint(15, 0), 							bg = "UI/fight/lose_item_bg_2.png"},
	{pos = CCPoint(15 + (286 + 15), 0), 			bg = "UI/fight/lose_item_bg_2.png"},
	{pos = CCPoint(15 + (286 + 15) * 2, 0), 		bg = "UI/fight/lose_item_bg_2.png"},
	
}

lose_item_info = {
	{name = "UI/fight/lose_qiang_hua.png",  	reqLv = 4,   icon = "UI/upgrade_assist/qiang_hua.png", 	leave_id = 2},
	{name = "UI/fight/lose_zhen_xing.png",  	reqLv = 9,  icon = "UI/upgrade_assist/zhen_xing.png", 	leave_id = 3},
	{name = "UI/fight/lose_ke_ji.png",  				reqLv = 9,  icon = "UI/upgrade_assist/ke_ji.png", 				leave_id = 5},
	{name = "UI/fight/lose_xi_sui.png",  			reqLv = 15,  icon = "UI/upgrade_assist/xi_sui.png",  			leave_id = 4},
	{name = "UI/fight/lose_xun_lian.png",  		reqLv = 18,   icon = "UI/upgrade_assist/xun_lian.png", 		leave_id = 1},
	{name = "UI/fight/lose_ji_xing.png",  			reqLv = 22,  icon = "UI/upgrade_assist/ji_xing.png", 			leave_id = 6},
}
--神域面板
function globleCreateShenYu()
	GlobleShenYuPanel = new(ShenYuPanel)
	GlobleShenYuPanel:create()
	GotoNextStepGuide()
end

ShenYuPanel = {

	create = function(self)
		self:initBase()

		local bg = CCSprite:spriteWithFile("UI/shen_yu/bg.png")
		bg:setPosition(CCPoint(38, 38))
		bg:setAnchorPoint(CCPoint(0, 0))
		self.centerWidget:addChild(bg)

		local createItem = function(image,pos1,pos2,callback)
			local hiddenPanel = dbUIPanel:panelWithSize(CCSize(120,120))
			hiddenPanel:setAnchorPoint(CCPoint(0,0))
			hiddenPanel:setPosition(pos2)
			hiddenPanel.m_nScriptClickedHandler = callback
			self.centerWidget:addChild(hiddenPanel)
			local btn = dbUIButtonScale:buttonWithImage(image,1.2)
			btn:setAnchorPoint(CCPoint(0,0))
			btn:setPosition(pos1)
			btn.m_nScriptClickedHandler = callback
			self.centerWidget:addChild(btn)
			return btn
		end

		local step_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_step.json")
		local tax_open = step_cfg:getByKey("tax_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--鐏垫硥闃佸緛鏀跺紑鍚�
		local farm_open = step_cfg:getByKey("farm_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--鐏垫灉绉嶆
		local nuli_open = step_cfg:getByKey("nuli_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--濂撮毝
		local stable_open = step_cfg:getByKey("stable_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--绗︽枃寮�惎
		local dock_open = step_cfg:getByKey("dock_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	---浣ｅ叺浠诲姟
		farm_open = true
	
		if tax_open then
			self.lqgBtn = createItem("UI/shen_yu/lqg.png",CCPoint(53,425),CCPoint(100,440),GlobleCreateLinQuanGe)
		end

		if nuli_open then
			self.nuliBtn = createItem("UI/shen_yu/znlc.png",CCPoint(440,479),CCPoint(440,361),GlobleCreateSlaveWork)
		end
		if stable_open then
			self.fuWenBtn = createItem("UI/shen_yu/fwjlz.png",CCPoint(758,480),CCPoint(758,425),GlobleCreateFuWenJiLian)
		end
		if farm_open then
			self.lqyBtn = createItem("UI/shen_yu/lgy.png",CCPoint(130,176),CCPoint(130,60),GlobleCreateLinGuoYuan)
		end
		--createItem("UI/shen_yu/zsmd.png",CCPoint(388,230),CCPoint(500,220),GlobleCreateLinQuanGe)

		if dock_open then
			self.yongBingBtn = createItem("UI/shen_yu/smsc.png",CCPoint(677,358),CCPoint(677,253),GlobleCreateYongBing)
		end
		--createItem("UI/shen_yu/mfkp.png",CCPoint(515,127),CCPoint(515,0),GlobleCreateLinQuanGe)

		return self
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		local top = dbUIPanel:panelWithSize(CCSize(1010,106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)

		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setPosition(CCPoint(952, 44))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
			GotoNextStepGuide()
		end
		top:addChild(closeBtn)
		self.closeBtn=closeBtn
		
		local title = CCSprite:spriteWithFile("UI/shen_yu/title.png")
		title:setPosition(CCPoint(1010/2, 44))
		top:addChild(title)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		self.lqgBtn = nil
		self.yongBingBtn = nil
		GlobleShenYuPanel = nil
		removeUnusedTextures()
	end
}
--神域  灵泉哥面板
LinQuanGePanel = {

	create = function(self)
		self:initBase()
		self:createMain()
		return self
	end,

	reflash = function(self)
		self.mainWidget:removeAllChildrenWithCleanup(true)
		self:createMain()
	end,

	createMain = function(self)
		local bg = CCSprite:spriteWithFile("UI/shen_yu/lqg/left_bg.jpg")
		bg:setPosition(CCPoint(38, 38))
		bg:setAnchorPoint(CCPoint(0,0))
		self.mainWidget:addChild(bg)

		self:createRight()
	end,

	createRight = function(self)
		local bg = CCSprite:spriteWithFile("UI/shen_yu/lqg/right_bg.png")
		bg:setPosition(CCPoint(504, 38))
		bg:setAnchorPoint(CCPoint(0,0))
		self.mainWidget:addChild(bg)

		local label = CCLabelTTF:labelWithString("神位：", CCSize(150,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(533, 533))
		label:setColor(ccc3(255,204,102))
		self.mainWidget:addChild(label)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.officium, CCSize(100,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(620, 533))
		label:setColor(ccc3(155,204,0))
		self.mainWidget:addChild(label)

		--初始冷却时间
		local label = CCLabelTTF:labelWithString("灵泉收获冷却时间：", CCSize(400,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(533, 470))
		label:setColor(ccc3(255,204,103))
		label:setIsVisible(false)
		self.mainWidget:addChild(label)
		self.lenQueLabel = label
		local label = CCLabelTTF:labelWithString("", CCSize(100,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(800, 470))
		if TAX.tax_enable == true then  --设置时间颜色
			label:setColor(ccc3(152,203,0))
		else
			label:setColor(ccc3(248,100,0))
		end
		label:setIsVisible(false)
		self.mainWidget:addChild(label)
		self.lenQueTimeTX = label
		
		--取消冷却时间
		local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/lqg/qx.png",1.2)
		btn:setPosition(CCPoint(736,434))
		btn:setIsVisible(false)
		btn.m_nScriptClickedHandler = function(ccp)
			local dtp = new(DialogTipPanel)
			dtp:create(LQ_CONSUME1.."2"..LQ_CONSUME2,ccc3(255,204,153),170)
			dtp.okBtn.m_nScriptClickedHandler = function()
				self:clearTime()
				dtp:destroy()
			end
		end
		self.mainWidget:addChild(btn)
		self.lenQueBtn = btn
		
		self.lenQueTime = math.floor((TAX.tax_cooldown - TAX.server_time)/1000)
		self:handleLenQueTime()
		
		self:createZhenShou()
		self:createJiaShou()
	end,

	--处理冷却时间
	handleLenQueTime = function(self)
		if self.lenQueTime > 0 and self.lenQueTime < 60*60 then

			self.lenQueTimeTX:setIsVisible(true)
			self.lenQueBtn:setIsVisible(true)
			self.lenQueLabel:setIsVisible(true)

			local setLenQueTime = function()
				if self.lenQueTime > 0 then
					self.lenQueTime = self.lenQueTime - 1
					self.lenQueTimeTX:setString(getLenQueTime(self.lenQueTime))
				else
					self.lenQueTimeTX:setString(getLenQueTime(self.lenQueTime))
					CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
					self.timeHandle = nil
					self.lenQueTimeTX:setIsVisible(false)
					self.lenQueBtn:setIsVisible(false)
					self.lenQueLabel:setIsVisible(false)
				end

				--设置时间颜色
				if TAX.tax_enable == true then
					self.lenQueTimeTX:setColor(ccc3(255,102,0))
				else
					self.lenQueTimeTX:setColor(ccc3(248,100,0))
				end
			end

			if self.timeHandle == nil then
				self.timeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
			else
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
				self.timeHandle = nil
				self.timeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
			end
		end
	end,

	--征收
	createZhenShou = function(self)
		local bg = CCSprite:spriteWithFile("UI/shen_yu/lqg/nice_bg.png")
		bg:setPosition(CCPoint(517, 77))
		bg:setAnchorPoint(CCPoint(0,0))
		self.mainWidget:addChild(bg)

		local label = CCLabelTTF:labelWithString("银币：", CCSize(150,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(550, 243))
		label:setColor(ccc3(255,204,103))
		self.mainWidget:addChild(label)
		local label = CCLabelTTF:labelWithString(TAX.base_tax_money, CCSize(400,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(630, 243))
		label:setColor(ccc3(248,100,0))
		self.mainWidget:addChild(label)

		local label = CCLabelTTF:labelWithString("今日剩余次数：", CCSize(400,0),0,SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(540, 170))
		label:setColor(ccc3(255,204,103))
		self.mainWidget:addChild(label)
		local label = CCLabelTTF:labelWithString(TAX.tax_left_count, CCSize(100,0),0,SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(680, 170))
		label:setColor(ccc3(153,205,0))
		self.mainWidget:addChild(label)
		self.zsTimeTX = label

		local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/lqg/zs.png",1.2)
		btn:setPosition(CCPoint(624,108))
		btn.m_nScriptClickedHandler = function(ccp)
			self:getMoney(1)
		end
		self.mainWidget:addChild(btn)
		self.taxBtn = btn
	end,

	--加收
	createJiaShou = function(self)
		local bg = CCSprite:spriteWithFile("UI/shen_yu/lqg/nice_bg.png")
		bg:setPosition(CCPoint(740, 77))
		bg:setAnchorPoint(CCPoint(0,0))
		self.mainWidget:addChild(bg)

		local label = CCLabelTTF:labelWithString("银币：", CCSize(150,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(550+218, 243))
		label:setColor(ccc3(255,204,103))
		self.mainWidget:addChild(label)
		local label = CCLabelTTF:labelWithString(TAX.base_tax_money, CCSize(400,0),0,SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(630+218, 243))
		label:setColor(ccc3(248,100,0))
		self.mainWidget:addChild(label)

		local label = CCLabelTTF:labelWithString("加收消耗：", CCSize(300,0),0,SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(550+218, 170))
		label:setColor(ccc3(255,204,103))
		self.mainWidget:addChild(label)
		local label = CCLabelTTF:labelWithString(self:getJiaZhengCast().."金币", CCSize(100,0),0,SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(650+218, 170))
		label:setColor(ccc3(153,205,0))
		self.mainWidget:addChild(label)
		self.consumeTx = label
		
		local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/lqg/js.png",1.2)
		btn:setPosition(CCPoint(848,108))
		btn.m_nScriptClickedHandler = function(ccp)
			self:getMoney(2)
		end
		self.mainWidget:addChild(btn)
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		local top = dbUIPanel:panelWithSize(CCSize(1010,106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)

		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setPosition(CCPoint(952, 44))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		top:addChild(closeBtn)
		self.closeBtn = closeBtn
		
		local title = CCSprite:spriteWithFile("UI/shen_yu/lqg/title.png")
		title:setPosition(CCPoint(1010/2, 44))
		top:addChild(title)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		if self.timeHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
			self.timeHandle = nil
		end
		GlobleLinQuanGePanel = nil
		GlobleFirstTax = nil
		removeUnusedTextures()
	end,
	--
	getMoney = function(self,num) --0：查看，1：普通征收，2：强行征收
		local function opTaxFinishCB(s)
			closeWait()
			getTaxData(s)

			self.zsTime = TAX.tax_left_count
			self.zsTimeTX:setString(self.zsTime)
			self.lenQueTime = math.floor((TAX.tax_cooldown - TAX.server_time)/1000)
			self.consumeTx:setString(self:getJiaZhengCast().."金币")

			--处理冷却时间
			self:handleLenQueTime()
			if TAX.error_code == -1 then
				local gainGold = s:getByKey("copper"):asInt() - GloblePlayerData.copper
				new(SimpleTipPanel):create(ZS_SLIVE..gainGold,ccc3(255,255,0),0)
			else
				local createPanel = new(SimpleTipPanel)
				if TAX.error_code==276 then
					createPanel:create("加收次数不足，您可以提升VIP等级增加次数",ccc3(255,0,0),0)
				else
					createPanel:create(ERROR_CODE_DESC[TAX.error_code],ccc3(255,0,0),0)
				end
			end
			GlobleFirstTax = true

			GloblePlayerData.gold = s:getByKey("gold"):asInt()
			GloblePlayerData.copper = s:getByKey("copper"):asInt()
			updataHUDData()
		end

		local function execTax()
			showWaitDialogNoCircle("waiting refresh!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_Tax, opTaxFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_Tax, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("type",num)

			NetMgr:executeOperate(Net.OPT_Tax, cj)
		end
		execTax()
	end,

	clearTime = function(self)
		local function opClearTimeFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				self.lenQueTime = 0
			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
				
				GloblePlayerData.gold = s:getByKey("gold"):asInt()
				GloblePlayerData.copper = s:getByKey("copper"):asInt()
				updataHUDData()
			end
		end

		local function execClearTime()
			showWaitDialogNoCircle("waiting tax data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_TaxSpike, opClearTimeFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_TaxSpike, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)

			NetMgr:executeOperate(Net.OPT_TaxSpike, cj)
		end
		execClearTime()
	end,
	
	getJiaZhengCast = function()
		return (TAX.tax_bonus_count + 1) * 2
	end
}


function GlobleCreateLinQuanGe()

	local function opTaxFinishCB(s)
		closeWait()
		getTaxData(s)
		GlobleLinQuanGePanel = new(LinQuanGePanel)
		GlobleLinQuanGePanel:create()
		
		GloblePlayerData.gold = s:getByKey("gold"):asInt()
		GloblePlayerData.copper = s:getByKey("copper"):asInt()
		updataHUDData()	
	end

	local function execTax()
		showWaitDialogNoCircle("waiting tax!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_Tax, opTaxFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_Tax, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("type", 0)

		NetMgr:executeOperate(Net.OPT_Tax, cj)
	end
	execTax()
end

function getTaxData(data)
	TAX.tax_left_count = data:getByKey("tax_left_count"):asInt()
	TAX.tax_event_id = data:getByKey("tax_event_id"):asInt()
	TAX.tax_money = data:getByKey("tax_money"):asInt()
	TAX.tax_cooldown = data:getByKey("tax_cooldown"):asDouble()
	TAX.copper = data:getByKey("copper"):asDouble()
	TAX.tax_bonus_count = data:getByKey("tax_bonus_count"):asInt()
	TAX.error_code = data:getByKey("error_code"):asInt()
	TAX.base_tax_money = data:getByKey("base_tax_money"):asInt()
	TAX.add_tax_money = data:getByKey("tax_money"):asInt()
	TAX.server_time = data:getByKey("server_time"):asDouble()
	TAX.tax_enable = data:getByKey("tax_enable"):asBool()
	TAX.gold = data:getByKey("gold"):asDouble()
	TAX.contribute = data:getByKey("contribute"):asInt()
end

TAX = {
	tax_left_count = 0,
	tax_event_id = 0,
	tax_money = 0,
	tax_cooldown = 0,
	copper = 2,
	tax_bonus_count = 0, --强征次数
	error_code = 0,
	base_tax_money = 0,		--普通征收
	add_tax_money = 0,		--加收
	server_time = 0,
	tax_enable = true,
	gold = 0,
	contribute = 0
}

TAX_EVENT = {
	tax_left_count = 0,
	tax_money = 0,
	event_value = 0,
	tax_cooldown = 0,
	copper = 0,
	event_effect = 0,
	tax_bonus_count = 0,
	error_code = 0,
	server_time = 0,
	tax_enable = true,
	gold = 0
}
--神域  灵果园 面板
LAND_POS_CFG = {
	CCPoint(367 - 135, 702 - 300),	
	CCPoint(460 - 135, 702 - 342),	
	CCPoint(282 - 135, 702 - 342),	
	CCPoint(373 - 135, 702 - 386),	
	CCPoint(199 - 135, 702 - 386),	
	CCPoint(290 - 135, 702 - 430),	
}
LinGuoYuanPanel = {
	data = nil,
	buyCount = 0,		--购买金钱种子的次数
	refreshCount = 0,	--刷新经验种子的次数
	freeCount = 2,		--免费刷新经验种子的次数,默认2次
	ShenweiDengji={0, 0, 0, 40, 50, 60,},

	create = function(self,data)
		self.data=data
		self:initBase()
		self:initSeed(data)
		self:createMain()
		return self
	end,

	reflash = function(self)
		self.mainWidget:removeAllChildrenWithCleanup(true)
		self:createMain()
	end,

	createMain = function(self)
		local data = self.data
		local bg = CCSprite:spriteWithFile("UI/shen_yu/lgy/bg.jpg")
		bg:setPosition(CCPoint(38, 38))
		bg:setAnchorPoint(CCPoint(0,0))
		self.mainWidget:addChild(bg)

		for i= 1, #self.ShenweiDengji do 
			local land = CCSprite:spriteWithFile("UI/shen_yu/lgy/land.png")
			land:setAnchorPoint(CCPoint(0, 0.5))
			land:setPosition(LAND_POS_CFG[i])
			self.mainWidget:addChild(land)
		end
		self.zhong_zhi = new({})
		self.leng_que = new({})
		self.shou_huo = new({})
		self.trees = new({})

		self.plantTimes = new({})
		self.plantTimesTX = new({})
		self.number_bgs = new({})
		self.plantHandles = new({})
		self.shenweiTip = new({})
		
		for i = 1, #self.ShenweiDengji do
			--种植提示			  
			local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/lgy/zhong_zhi.png",1.2)
			btn:setAnchorPoint(CCPoint(0.5, 0))
			btn:setPosition(ccpAdd(LAND_POS_CFG[i], CCPoint(84, 0)))
			btn:setIsVisible(true)
			btn.m_nScriptClickedHandler = function()
				self:createRadio(i)
			end
			self.mainWidget:addChild(btn)
			self.zhong_zhi[i] = btn
			if i==1 then
				GlobleZhongZhiBtn = self.zhong_zhi[1]
			end
			--收获
			local tree = CCSprite:spriteWithFile("UI/shen_yu/lgy/gold_tree.png")
			tree:setPosition(ccpAdd(LAND_POS_CFG[i], CCPoint(84, -15)))
			tree:setAnchorPoint(CCPoint(0,0))
			tree:setIsVisible(false)
			self.mainWidget:addChild(tree)
			self.trees[i] = tree
			local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/lgy/shou_huo.png",1.2)
			btn:setAnchorPoint(CCPoint(0.5, 0))
			btn:setPosition(ccpAdd(LAND_POS_CFG[i], CCPoint(84, 0)))
			btn:setIsVisible(false)
			self.mainWidget:addChild(btn)
			self.shou_huo[i] = btn

			--土地冷却
			local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/lgy/leng_que.png",1.2)
			btn:setAnchorPoint(CCPoint(0.5, 0))
			btn:setPosition(ccpAdd(LAND_POS_CFG[i], CCPoint(84, 0)))
			btn:setIsVisible(false)
			self.mainWidget:addChild(btn)
			self.leng_que[i] = btn

			local number_bg = CCSprite:spriteWithFile("UI/shen_yu/lgy/number_bg.png")
			number_bg:setAnchorPoint(CCPoint(0.5,0.5))
			number_bg:setPosition(ccpAdd(LAND_POS_CFG[i], CCPoint(84, -10)))
			number_bg:setIsVisible(false)
			self.mainWidget:addChild(number_bg)
			self.number_bgs[i] = number_bg

			local label = CCLabelTTF:labelWithString("",SYSFONT[EQUIPMENT], 18)
			label:setPosition(CCPoint(92/2,27/2))
			label:setColor(ccc3(248,100,0))
			number_bg:addChild(label)
			self.plantTimesTX[i]= label

			self.plantTimes[i] = 0
			self.plantHandles[i] = nil
			
			--神位开启
			local shenwei_label = CCLabelTTF:labelWithString("神位"..self.ShenweiDengji[i].."级开启",CCSize(0,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 22)
			shenwei_label:setAnchorPoint(CCPoint(0.5, 0.5))
			shenwei_label:setPosition(ccpAdd(LAND_POS_CFG[i], CCPoint(84, 0)))
			shenwei_label:setColor(ccc3(255, 0, 0))
			shenwei_label:setIsVisible(false)
			self.mainWidget:addChild(shenwei_label)
			self.shenweiTip[i] = shenwei_label
		end

		self:createAlertable1(data)
		self:createSeedInfo()
		self:createRightInfo()
	end,

	resetAll = function(self)
		for index = 1, #self.ShenweiDengji do
			self.zhong_zhi[index]:setIsVisible(true)
			self.leng_que[index]:setIsVisible(false)
			self.trees[index]:setIsVisible(false)
			self.shou_huo[index]:setIsVisible(false)
			
			self.number_bgs[index]:setIsVisible(false)
			self.plantTimesTX[index]:setIsVisible(false)
		end
	end,

	createAlertable1 = function(self,data)
		self:resetAll()
		for i = 1, #self.ShenweiDengji do
			if GloblePlayerData.officium < self.ShenweiDengji[i] then
				self.zhong_zhi[i]:setIsVisible(false)
				self.shenweiTip[i]:setIsVisible(true)
			end
			local landData = data:getByKey("farm_lands"):getByIndex(i-1)
			if landData ~= nil then
				local index = landData:getByKey("id"):asInt()
				local status = landData:getByKey("status"):asInt()
				local typeId = landData:getByKey("type"):asInt()
				--Log("index: "..index.."  i: "..i.."  index_  "..index.."  status:  "..status.."  typeId:  "..typeId)
				if index>=0 then
					if status == 2 then  --土地冷却
						self.zhong_zhi[index]:setIsVisible(false)
						self.leng_que[index]:setIsVisible(true)
						self.shou_huo[index].m_nScriptClickedHandler = function()
							self:clearLandCD(index)
						end
						self.number_bgs[index]:setIsVisible(true)
						self.plantTimesTX[index]:setIsVisible(true)
						self.plantTimes[index] = math.ceil((landData:getByKey("harvest_time"):asDouble() - data:getByKey("server_time"):asDouble())/1000)
						self:handlePlantTime(index)
					elseif status == 3 then  --可收获
						self.zhong_zhi[index]:setIsVisible(false)
						self.leng_que[index]:setIsVisible(false)
						if typeId == 1 then
						--	self.trees[index]:initWithFile("UI/shen_yu/lgy/gold_tree.png")
						else
						--	self.trees[index]:initWithFile("UI/shen_yu/lgy/exp_tree.png")
						end
						self.trees[index]:setIsVisible(true)
						self.shou_huo[index]:setIsVisible(true)
						self.shou_huo[index].m_nScriptClickedHandler = function()
							self:gainning(index,typeId)
						end
					end
				end
			end
		end
	end,
	
	createRightInfo = function(self)
		local goldBG = CCSprite:spriteWithFile("UI/public/title_bg3.png")
		goldBG:setAnchorPoint(CCPoint(0, 0))
		goldBG:setPosition(CCPoint(770, 530))
		self.mainWidget:addChild(goldBG)
		local goldIcon = CCSprite:spriteWithFile("icon/gold_mid.png")
		goldIcon:setAnchorPoint(CCPoint(0.5, 0.5))
		goldIcon:setPosition(CCPoint(25, 15))
		goldIcon:setScale(26 / 45)
		goldBG:addChild(goldIcon)
		self.goldLabel = CCLabelTTF:labelWithString(GloblePlayerData.gold, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 24)
		self.goldLabel:setAnchorPoint(CCPoint(0, 0.5))
		self.goldLabel:setPosition(CCPoint(45, 15))	
		goldBG:addChild(self.goldLabel)
		
		local seedDescBG = createBG("UI/boss/cd_bg.png",170, 200)
		seedDescBG:setAnchorPoint(CCPoint(0, 1))
		seedDescBG:setPosition(CCPoint(770, 510))
		self.mainWidget:addChild(seedDescBG)
		
		self.seedDescLabel = CCLabelTTF:labelWithString("", CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 22)
		self.seedDescLabel:setAnchorPoint(CCPoint(0, 1))
		self.seedDescLabel:setPosition(CCPoint(10, 190))	
		seedDescBG:addChild(self.seedDescLabel)
		
	end,
	
	createSeedInfo = function(self)
		self:handleSeedTime()
		if self.seedInfoPanel then 
			self.seedInfoPanel:removeFromParentAndCleanup(true)
		end
		self.seedInfoPanel = createBG("UI/boss/cd_bg.png",932, 145)
		self.seedInfoPanel:setAnchorPoint(CCPoint(0.5, 0))
		self.seedInfoPanel:setPosition(CCPoint(1010/2, 38))
		self.mainWidget:addChild(self.seedInfoPanel)
		
		local createSeed = function(seedInfo)
			local kuang = dbUIWidget:widgetWithImage("UI/public/kuang_96_96.png")
			kuang:setAnchorPoint(CCPoint(0, 0))
			local seedIcon = dbUIButtonScale:buttonWithImage("UI/shen_yu/lgy/"..((seedInfo.type == 1) and "gold_seed.png" or "exp_seed.png"), 1, ccc3(125, 125, 125))
			seedIcon:setAnchorPoint(CCPoint(0.5, 0.5))
			seedIcon:setPosition(48, 48)
			seedIcon.m_nScriptClickedHandler = function()
				self.seedDescLabel:setString(seedInfo.desc)
				if seedInfo.amount < 1 then
					if seedInfo.type == 1 then
						local createDialogBtns = function(ccp)
							local btns = {}
							local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
							btns[1] = btn
							btns[1].action = self.buySeed
								
							local btn = dbUIButtonScale:buttonWithImage("UI/public/cancel_btn.png", 1, ccc3(125, 125, 125))
							btns[2] = btn
							btns[2].action = nothing
							return btns
						end
						local dialogCfg = new(basicDialogCfg)
						dialogCfg.bg = "UI/baoguoPanel/kuang.png"
						dialogCfg.msg = "是否花费"..(2 * (self.buyCount + 1)).."金币购买种子？"
						dialogCfg.msgSize = 24
						dialogCfg.dialogType = 5
						dialogCfg.btns = createDialogBtns()
						new(Dialog):create(dialogCfg)
					else
						alert("种子已经用完啦")
					end
				else
					--获取可以种植的土地index
					local index = 0
					for i = 1, 8 do
						if not self.zhong_zhi[i]:getIsVisible() and
						   not self.leng_que[i]:getIsVisible() then
							break
						end
					end
					if index ~= 0 then
						self:planting(index,seedInfo.type)
					end
				end
			end
			kuang:addChild(seedIcon)
			
			local amount = seedInfo.amount > 1 and seedInfo.amount or ""
			local amountLabel = CCLabelTTF:labelWithString(amount, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 24)
			amountLabel:setAnchorPoint(CCPoint(1, 0))
			amountLabel:setPosition(CCPoint(90, 6))	
			kuang:addChild(amountLabel)
			
			local name = CCLabelTTF:labelWithString(seedInfo.name, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 20)
			name:setColor(ccc3(255, 204, 151))
			name:setAnchorPoint(CCPoint(0.5, 1))
			name:setPosition(CCPoint(48, -2))	
			kuang:addChild(name)
			
			return kuang
		end
		
		for i = 1, #self.seedInfo do
			local item = createSeed(self.seedInfo[i])
			item:setPosition(195 + 103 * (i - 1), 30)
			self.seedInfoPanel:addChild(item)
		end
		
		local refreshBtn = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/dj/flush.png", 1, ccc3(125, 125, 125))
		refreshBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		refreshBtn:setPosition(CCPoint(814,77))
		refreshBtn.m_nScriptClickedHandler = function()
			local refreshCost = math.min(2 + self.refreshCount, 5) 
			local function toRefresh()
				if GloblePlayerData.gold < refreshCost then
					 shortofgold()
				else
					self:refresh()
				end
			end
		
			local createDialogBtns = function(ccp)
				local btns = {}
				local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
				btns[1] = btn
				btns[1].action = toRefresh
					
				local btn = dbUIButtonScale:buttonWithImage("UI/public/cancel_btn.png", 1, ccc3(125, 125, 125))
				btns[2] = btn
				btns[2].action = nothing
				return btns
			end
			local dialogCfg = new(basicDialogCfg)
			dialogCfg.bg = "UI/baoguoPanel/kuang.png"
			dialogCfg.msg = "是否花费"..refreshCost.."金币刷新？"
			dialogCfg.msgSize = 24
			dialogCfg.dialogType = 5
			dialogCfg.btns = createDialogBtns()
			new(Dialog):create(dialogCfg)
		end
		self.seedInfoPanel:addChild(refreshBtn)
		
		local refreshCountLabel = CCLabelTTF:labelWithString("免费刷新:"..(self.freeCount or 2), CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 24)
		refreshCountLabel:setAnchorPoint(CCPoint(0.5, 1))
		refreshCountLabel:setPosition(CCPoint(814, 45))	
		self.seedInfoPanel:addChild(refreshCountLabel)
	end,
	
	--金钱种子自动更新
	handleSeedTime = function(self)
		local setLenQueTime = function()
			self.seed_cdTime = self.seed_cdTime - 1
			if self.seed_cdTime <= 0 then
				self.seedInfo[1].amount = math.min(self.seedInfo[1].amount + 1, 8)
				self.seed_cdTime = 3 * 60 * 60	--3小时
			end
		end
		if not self.seedTimeHandler then
			self.seedTimeHandler = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
		end
	end,
	--购买金钱种子
	buySeed = function()
		local function opBuySeedFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				self.buyCount = 1	--已经购买的次数
				self:initSeed(s)
				self:createSeedInfo()
			else
				new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end
		end

		local function execRefresh()
			showWaitDialogNoCircle("waiting plant data!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FarmAction, opBuySeedFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FarmAction, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("action",4) --1：种植，2：收获，4：购买金钱种子
			NetMgr:executeOperate(Net.OPT_FarmAction, cj)
		end
		execRefresh()
	end,
	--刷新经验种子
	refresh = function(self)
		local function opRefreshFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				self.freeCount = 1	--免费次数
				self.refreshCount = 1	--刷新次数
				self:initSeed(s)
				self:createSeedInfo()
			else
				new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end
		end

		local function execRefresh()
			showWaitDialogNoCircle("waiting plant data!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FarmAction, opRefreshFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FarmAction, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("idx",0)    
			cj:setByKey("type",0)  
			cj:setByKey("action",5) --1：种植，2：收获，5：刷新种子
			NetMgr:executeOperate(Net.OPT_FarmAction, cj)
		end
		execRefresh()
	end,
	--清除土地CD
	clearLandCD = function(index)
		local execClearLandCD = function()
			local function opClearLandFinishCB(s)
				closeWait()
				if s:getByKey("error_code"):asInt() == -1 then
					self:createAlertable1(s)
					local createPanel = new(SimpleTipPanel)
					createPanel:create("收获灵果："..s:getByKey("harvest"):asInt(),ccc3(255,0,0),0)
					self.liangShi = s:getByKey("barn"):asInt()
				else
					new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
				end
			end
	
			showWaitDialogNoCircle("waiting plant data!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FarmAction, opGainningFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FarmAction, opFailedCB)
	
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("idx",index)    --农田编号，从左到右，从上到下：1-4
			cj:setByKey("type",0)   --种植的作物，1-4，收获时填0
			cj:setByKey("action",3) --1：种植，2：收获, 3：清除土地冷却
			NetMgr:executeOperate(Net.OPT_FarmAction, cj)
		end		
		local createDialogBtns = function(ccp)
				local btns = {}
				local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
				btns[1] = btn
				btns[1].action = toRefresh
				btns[1].param = GloblePlayerData.generals[GloblePanel.curGenerals].general_id
					
				local btn = dbUIButtonScale:buttonWithImage("UI/public/cancel_btn.png", 1, ccc3(125, 125, 125))
				btns[2] = btn
				btns[2].action = nothing
				return btns
		end
		local dialogCfg = new(basicDialogCfg)
		dialogCfg.bg = "UI/baoguoPanel/kuang.png"
		dialogCfg.msg = "是否花费"..(math.ceil(self.plantTimes[index] / (5 * 60))).."金币清除土地冷却？"
		dialogCfg.msgSize = 24
		dialogCfg.dialogType = 5
		dialogCfg.btns = createDialogBtns()
		new(Dialog):create(dialogCfg)
	end,
	--收获
	gainning = function(self,index,typeId)
		local function opGainningFinishCB(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code == -1 then
				self:createAlertable1(s)
				local createPanel = new(SimpleTipPanel)
				createPanel:create("收获灵果："..s:getByKey("harvest"):asInt(),ccc3(255,0,0),0)
				self.liangShi = s:getByKey("barn"):asInt()
			elseif error_code == 2001 then
				new(SimpleTipPanel):create("背包不足，请清理出2个格子",ccc3(255,0,0),0)
			else
				new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end
		end

		local function execGainning()
			showWaitDialogNoCircle("waiting plant data!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FarmAction, opGainningFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FarmAction, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("idx",index)    --田编号，从左到右，从上到下：1-8
			cj:setByKey("type",typeId)   --种植的作物，1-5，收获时填0
			cj:setByKey("action",2) --1：种植，2：收获
			NetMgr:executeOperate(Net.OPT_FarmAction, cj)
		end
		execGainning()
	end,
	--土地CD计时
	handlePlantTime = function(self,i)
		self.plantTimesTX[i]:setIsVisible(true)
		local setLenQueTime = function()
			if self.plantTimes[i] > 0 then
				self.plantTimes[i] = self.plantTimes[i] - 1
				self.plantTimesTX[i]:setString(getLenQueTime(self.plantTimes[i]))
			else
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.plantHandles[i])
				self.plantHandles[i] = nil
				self.trees[i]:setIsVisible(true)
				self.shou_huo[i]:setIsVisible(true)
				self.leng_que[i]:setIsVisible(false)
				self.plantTimesTX[i]:setIsVisible(false)
				self.number_bgs[i]:setIsVisible(false)
			end
		end

		if self.plantHandles[i] == nil then
			self.plantHandles[i] = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
		else
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.plantHandles[i])
			self.plantHandles[i] = nil
			self.plantHandles[i] = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
		end
	end,
	--暂无用处
	createRadio = function(self,index)
		local  bgPanel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		bgPanel.m_nScriptClickedHandler = function(ccp)
			bgPanel:removeFromParentAndCleanup(true)
			GloblePlantBtn = nil
		end
		self.mainWidget:addChild(bgPanel,10000)

		local dialog_kuang = createBG("UI/public/dialog_kuang.png",430,232)
		dialog_kuang:setAnchorPoint(CCPoint(0.5, 0.5))
		dialog_kuang:setPosition(CCPoint(512,768/2))
		bgPanel:addChild(dialog_kuang)

		local createItem = function(image,desc,pos1,pos2,typeId)
			local btn = dbUIButtonScale:buttonWithImage(image,1.2)
			btn:setPosition(pos1)
			btn:setAnchorPoint(CCPoint(0,0))
			btn.m_nScriptClickedHandler = function()
				GloblePlanting = true
				self:planting(index,typeId,bgPanel)
			end
			dialog_kuang:addChild(btn)

			local label = CCLabelTTF:labelWithString(desc,CCSize(500,0),0,SYSFONT[EQUIPMENT], 18)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(pos2)
			label:setColor(ccc3(104,53,0))
			dialog_kuang:addChild(label)

			return btn
		end

		GloblePlantBtn = createItem("UI/shen_yu/lgy/dg.png","1000银币   1小时收获：20000", CCPoint(33,150),      CCPoint(150,165),     1)
		createItem("UI/shen_yu/lgy/tg.png","3000银币   4小时收获：90000", CCPoint(33,150-58),   CCPoint(150,165-58),  2)
		createItem("UI/shen_yu/lgy/sg.png","6金币     1小时收获：90000",    CCPoint(33,150-58*2), CCPoint(150,165-58*2),3)
	end,
	--种植
	planting = function(self,i,typeId,bgPanel)
		local function opPlantingFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				self:handlePlantTime(i)
				self:createAlertable1(s)
				if bgPanel then 
					bgPanel:removeFromParentAndCleanup(true)
				end
				GloblePlayerData.gold = s:getByKey("gold"):asInt()
				GloblePlayerData.copper = s:getByKey("copper"):asInt()
				updataHUDData()
			else
				new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end
		end

		local function execPlanting()
			showWaitDialogNoCircle("waiting plant data!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FarmAction, opPlantingFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FarmAction, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("idx",i)    	--农田编号，从上到下，从左到右：1-4
			cj:setByKey("type",typeId)   --种植的作物，1-5，收获时填0
			cj:setByKey("action",1) --1：种植，2：收获
			NetMgr:executeOperate(Net.OPT_FarmAction, cj)
		end
		execPlanting()
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		local top = dbUIPanel:panelWithSize(CCSize(1010,106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)

		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setPosition(CCPoint(952, 44))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		top:addChild(closeBtn)
		self.closeBtn = closeBtn

		local title = CCSprite:spriteWithFile("UI/shen_yu/lgy/title.png")
		title:setPosition(CCPoint(1010/2, 44))
		top:addChild(title)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
	end,

	initSeed = function(self, data)
		self.buyCount = 1
		self.refreshCount = 1
		self.freeCount = 1
		self.seed_cdTime = 1000
		self.seedInfo = {}
		self.seedInfo[1] = {
			type = 1,
			name = "金钱种子",
			amount = 8,
			desc = "种植摇钱树需要金钱种子，上限为8个，每3小时回复1个，但不能超过上限",
		}
		self.seedInfo[2] = {
			type = 2,
			name = "经验种子",
			amount = 1,
			desc = "1级经验丹种子，成熟后获得XX个经验丹",
		}
		self.seedInfo[3] = {
			type = 3,
			name = "经验种子",
			amount = 0,
			desc = "2级经验丹种子，成熟后获得XX个经验丹，小几率获得1级宝石袋",
		}
		self.seedInfo[4] = {
			type = 4,
			name = "经验种子",
			amount = 0,
			desc = "3级经验丹种子，成熟后获得XX个经验丹，大几率获得1级宝石袋",
		}
		self.seedInfo[5] = {
			type = 5,
			name = "经验种子",
			amount = 0,
			desc = "4级经验丹种子，成熟后获得XX个经验丹，大几率获得1级宝石袋，小几率获得2级宝石袋",
		}
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil

		for i=1,4 do
			if self.plantHandles[i] then
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.plantHandles[i])
				self.plantHandles[i] = nil
			end
		end
		if self.seedTimeHandler then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.seedTimeHandler)
			self.seedTimeHandler = nil
		end
		GlobleZhongZhiBtn = nil
		GloblePlantBtn  = nil
		GloblePlanting = nil
		GlobleLinGuoYuanPanel = nil
	end,
}

function GlobleCreateLinGuoYuan()
	local function opCreatePlantFinishCB(s)
		closeWait()
		if s:getByKey("error_code"):asInt() == -1 then
			GlobleLinGuoYuanPanel = new(LinGuoYuanPanel)
			GlobleLinGuoYuanPanel:create(s)
		else
			new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
		end
	end

	local function execCreatePlant()
		showWaitDialogNoCircle("waiting plant data!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_FarmAction, opCreatePlantFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_FarmAction, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code",ClientData.request_code)

		--第一次默认为0
		cj:setByKey("idx",0)    --农田编号，从上到下，从左到右：1-4
		cj:setByKey("type",0)   --种植的作物，1-4，收获时填0
		cj:setByKey("action",0) --1：种植，2：收获
		NetMgr:executeOperate(Net.OPT_FarmAction, cj)
	end
	execCreatePlant()
end
--神域  符文祭炼 面板
function GlobleCreateFuWenJiLian()
	FuWenNet(1)
end
FU_WEN_POS_CFG={
	CCPoint(100,284),
	CCPoint(427,284),
	CCPoint(270,10),
}

local HorseHandle = nil
local updateHorseHandle = function ()
	if GlobleFuWenJiLianPanel ~= nil then
		for i = 1,3 do
			if GlobleFuWenJiLianPanel.cdTimeTxt[i] ~= nil and GlobleFuWenJiLianPanel.cdTimes[i] > 0 then
				GlobleFuWenJiLianPanel.cdTimes[i] = GlobleFuWenJiLianPanel.cdTimes[i] -1
				if GlobleFuWenJiLianPanel.cdTimes[i] <= 0 then
					GlobleFuWenJiLianPanel.cdTimeTxt[i]:setString("")
					FuWenNet(1)
				else
					GlobleFuWenJiLianPanel.cdTimeTxt[i]:setString(getLenQueTime(GlobleFuWenJiLianPanel.cdTimes[i]))
				end
			end
		end
	end
end

FuWenJiLianPanel = {
	create = function(self)
		self:initBase()
		self:createMain()
		return self
	end,

	reflash = function(self)
		self.yinBiFeedBtn = nil
		self.startBtn = nil
		self.lengQueBtn = nil
		self.mainWidget:removeAllChildrenWithCleanup(true)
		self:createMain()
	end,

	createMain = function(self)
		self:createLeft()
		self:createRight()
	end,

	createLeft = function(self)
		self.left = dbUIPanel:panelWithSize(CCSize(698,545))
		self.left:setAnchorPoint(CCPoint(0,0))
		self.left:setPosition(CCPoint(38, 38))
		self.mainWidget:addChild(self.left)

		self.leftbg = CCSprite:spriteWithFile("UI/shen_yu/fwjl/left_bg.jpg")
		self.leftbg:setAnchorPoint(CCPoint(0,0))
		self.leftbg:setPosition(CCPoint(0,0))
		self.left:addChild(self.leftbg)

		local label =  CCLabelTTF:labelWithString("1、银币祭炼消耗：2500银币。\n2、金币祭炼消耗：15金币。\n3、每次祭炼会积累一定祭炼值，祭炼值越高所收获的符文品质越高。",CCSize(250, 0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT],17)
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(10,20))
		label:setColor(ccc3(255,204,102))
		self.left:addChild(label)

		self.fuwenPanels = new({})
		self.cdTimes     = new({})
		self.cdTimeTxt   = new({})
		
		--祭坛
		for i=1,3 do
			local panel = dbUIPanel:panelWithSize(CCSize(208,186))
			panel:setAnchorPoint(CCPoint(0,0))
			panel:setPosition(FU_WEN_POS_CFG[i])
			self.left:addChild(panel)
			self.fuwenPanels[i] = panel
			
			--判断祭坛是否开启
			if i <=  table.getn(HorseData.horse_list) then
				local item = HorseData.horse_list[i]
				if item.cfg_item_id>0 then
					local itemBorder = getItemBorder(HorseData.horse_list[i].cfg_item_id)
					itemBorder:setAnchorPoint(CCPoint(0.5, 0))
					itemBorder:setPosition(208/2,80)
					panel:addChild(itemBorder)
				else
					local unkown = CCSprite:spriteWithFile("icon/unknow.png")
					unkown:setAnchorPoint(CCPoint(0.5, 0))
					unkown:setPosition(208/2,80)
					panel:addChild(unkown)					
				end
											
				local icon = CCSprite:spriteWithFile("UI/shen_yu/fwjl/fu_wen_"..item.type..".png")
				icon:setAnchorPoint(CCPoint(0.5,0))
				icon:setScale(90/180)
				icon:setPosition(208/2,90)

				if item.growth ~=0 then

					--可以获得符文了
					if item.feed_count == 10 and  item.status == 3 then
						local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/fwjl/get.png",1,ccc3(236,87,5))
						btn:setPosition(CCPoint(208/2, 40))
						btn.m_nScriptClickedHandler = function()
							FuWenNet(6,i)
						end
						panel:addChild(btn)
					elseif item.feed_count == 10 and  item.status == 4 then  --第二个要钱
						local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/fwjl/one_more.png",1,ccc3(236,87,5))
						btn:setPosition(CCPoint(208/2, 40))
						btn.m_nScriptClickedHandler = function()
							local quick = function()
								FuWenNet(3,i)
							end
							local dialogCfg = new(basicDialogCfg)
							dialogCfg.msg = "是否使用15金币再祭炼一个？"
							dialogCfg.dialogType = 5
							local btns = {}
							btns[1] = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png",1,ccc3(236,87,5))
							btns[1].action = quick
							dialogCfg.btns = btns
							local dialog = new(Dialog)
							dialog:create(dialogCfg)
						end
						panel:addChild(btn)
					else  --冷却，或可以祭炼
						local labelPanel = dbUIPanel:panelWithSize(CCSize(205,25))
						labelPanel:setAnchorPoint(CCPoint(0,0))
						labelPanel:setPosition(CCPoint(0,60))
						panel:addChild(labelPanel)
						local label = CCLabelTTF:labelWithString("祭炼值:", SYSFONT[EQUIPMENT], 20)
						local count = CCLabelTTF:labelWithString(item.growth, SYSFONT[EQUIPMENT], 20)
						
						label:setAnchorPoint(CCPoint(0,0))
						count:setAnchorPoint(CCPoint(0,0))
						if i==1 then 
						count:setColor(ccc3(153,204,0))   --ccc3(252,205,87)
						elseif i==2 then
						count:setColor(ccc3(102,255,255))
						else
						count:setColor(ccc3(255,153,0))
						end
						
						label:setColor(ccc3(252,205,87))
						label:setPosition(CCPoint(25,0))
						count:setPosition(CCPoint(25+90,0))
						labelPanel:addChild(label)
						labelPanel:addChild(count)

						local labelPanel = dbUIPanel:panelWithSize(CCSize(205,25))
						labelPanel:setAnchorPoint(CCPoint(0,0))
						labelPanel:setPosition(CCPoint(0,35))
						local label = CCLabelTTF:labelWithString("祭炼次数:", SYSFONT[EQUIPMENT], 20)
						local count = CCLabelTTF:labelWithString(item.feed_count.."/10", SYSFONT[EQUIPMENT], 20)
						
						label:setAnchorPoint(CCPoint(0,0))
						count:setAnchorPoint(CCPoint(0,0))
						if i==1 then 
						count:setColor(ccc3(153,204,0))   --ccc3(252,205,87)
						elseif i==2 then
						count:setColor(ccc3(102,255,255))
						else
						count:setColor(ccc3(255,153,0))
						end
						
						label:setColor(ccc3(252,205,87))
						
					
						
                       label:setPosition(CCPoint(15,0))
						count:setPosition(CCPoint(132,0))
						labelPanel:addChild(label)
						labelPanel:addChild(count)
						panel:addChild(labelPanel)
						self.cdTimes[i] = 0
						if item.feed_cooldown ~= 0 then  --祭炼中
							local tt = item.feed_cooldown-HorseData.server_time
							if tt > 0 then
								if HorseHandle == nil then
									HorseHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(updateHorseHandle,1,false)
								end
								self.cdTimes[i] = math.floor(tt/1000)
							end
						end

						--冷却时间
						if self.cdTimes[i]>0 then
							local cdTime = CCLabelTTF:labelWithString(getLenQueTime(self.cdTimes[i]), SYSFONT[EQUIPMENT], 18)
							cdTime:setAnchorPoint(CCPoint(0,0))
							cdTime:setPosition(CCPoint(30,0))
							panel:addChild(cdTime)
							self.cdTimeTxt[i] = cdTime

							local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/fwjl/cooldown.png",1,ccc3(236,87,5))
							btn:setPosition(CCPoint(208/2+30, 10))
							btn.m_nScriptClickedHandler = function()
								local dialogCfg = new(basicDialogCfg)
								dialogCfg.msg = "是否使用2金币清除冷却时间"
								dialogCfg.msgAlign = "center"
								dialogCfg.dialogType = 5

								local quick = function()
									FuWenNet(5,i)
								end
								local btns = {}
								btns[1]= dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png",1,ccc3(236,87,5))
								btns[1].action = quick
								dialogCfg.btns = btns
								local dialog = new(Dialog)
								dialog:create(dialogCfg)
							end
							panel:addChild(btn)
							self.lengQueBtn = btn
						else --冷却时间没了，可以再祭炼
							local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/fwjl/jin_bi.png",1,ccc3(236,87,5))
							btn:setPosition(CCPoint(45, 15))
							btn.m_nScriptClickedHandler = function()
								eat_select[i] = 2
								FuWenNet(4,i)
							end
							panel:addChild(btn)

							local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/fwjl/yin_bi.png",1,ccc3(236,87,5))
							btn:setPosition(CCPoint(160, 15))
							btn.m_nScriptClickedHandler = function()
								eat_select[i] = 1
								FuWenNet(4,i)
							end
							panel:addChild(btn)
							self.yinBiFeedBtn = btn
						end
					end
				else
					local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/fwjl/start.png",1,ccc3(236,87,5))
					btn:setPosition(CCPoint(208/2,15))
					btn:setAnchorPoint(CCPoint(0.5,0))
					btn.m_nScriptClickedHandler = function()
						FuWenNet(3,i)
					end
					panel:addChild(btn)
					self.startBtn = btn
				end
			else
				----木有开启 开启吧 ，开启水阵祭练时VIP为3，开启火阵祭练时VIP为6
				----修改为水阵VIP1开启
				if i==2 then
					local vip = CCLabelTTF:labelWithString("VIP1可开启",CCSizeMake(110,0),CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 16)
					vip:setPosition(CCPoint(panel:getContentSize().width/2+18,panel:getContentSize().height/2+38) )
					vip:setColor(ccc3(255,255,255))
					panel:addChild(vip)
				else
					local vip = CCLabelTTF:labelWithString("VIP"..(3*i-3).."可开启",CCSizeMake(110,0),CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 16)
					vip:setPosition(CCPoint(panel:getContentSize().width/2+18,panel:getContentSize().height/2+38) )
					vip:setColor(ccc3(255,255,255))
					panel:addChild(vip)
				end
				if i == table.getn(HorseData.horse_list) + 1  then
					local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/fwjl/open.png",1,ccc3(236,87,5))
					btn:setPosition(CCPoint(208/2,0))
					btn:setAnchorPoint(CCPoint(0.5,0))
					btn.m_nScriptClickedHandler = function()
						local get = function()
							FuWenNet(7)
						end
						local pay = (i == 2) and 50 or 100
						local dialogCfg = new(basicDialogCfg)
						dialogCfg.msg = "是否花费"..pay.."金币开启祭坛"
						dialogCfg.dialogType = 5
						local btns = {}
						btns[1] = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png",1,ccc3(236,87,5))
						btns[1].action = get
						dialogCfg.btns = btns
						local dialog = new(Dialog)
						dialog:create(dialogCfg)
					end
					panel:addChild(btn)
				end
			end
		end
	end,

	--祭炼师
	createRight = function(self)
		local right = createDarkBG(216,545)
		right:setPosition(CCPoint(747, 38))
		right:setAnchorPoint(CCPoint(0,0))
		self.mainWidget:addChild(right)
		self.toggleBtns = new({})

		local find = function(i)
			for j=1,table.getn(HorseData.stable_man_list) do
				local stable_man = HorseData.stable_man_list[j]
				if stable_man and i==stable_man.idx then
					return true
				end
			end
			return false
		end
		local vip_need = {
			0,0,2
		}
		for i=1,3 do
			local exist = find(i)
			local image = (exist) and  "UI/shen_yu/fwjl/"..i.."_2.png" or  "UI/shen_yu/fwjl/"..i.."_1.png"
			local man = dbUIWidget:widgetWithImage(image)
			man:setPosition(CCPoint(216/2,365-(i-1)*175))
			man:setAnchorPoint(CCPoint(0.5,0))
			man:setIsEnabled(not exist)
			man.m_nScriptClickedHandler = function(ccp)
				
				if GloblePlayerData.vip_level < vip_need[i] then
					local dialogCfg = new(basicDialogCfg)
					dialogCfg.msg = "需要VIP"..vip_need[i].."级才能兑换"
					new(Dialog):create(dialogCfg)
					return			
				end
			
				local getMan = function(ccp,item)
					FuWenNet(2,i)
				end
				local dialogCfg = new(basicDialogCfg)
				dialogCfg.msg = "是否使用"..HorseCfg[i][3].."金币兑换"..HorseCfg[i][1]
				dialogCfg.dialogType = 5
				local btns = {}
				btns[1] = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png",1,ccc3(236,87,5))
				btns[1].action = getMan
				dialogCfg.btns = btns
				new(Dialog):create(dialogCfg)
			end
			right:addChild(man)
		end
	end,


	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		local top = dbUIPanel:panelWithSize(CCSize(1010,106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)

		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setPosition(CCPoint(952, 44))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		top:addChild(closeBtn)
		self.closeBtn = closeBtn
		
		local title = CCSprite:spriteWithFile("UI/shen_yu/fwjl/title.png")
		title:setPosition(CCPoint(1010/2, 44))
		top:addChild(title)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		if HorseHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(HorseHandle)
			HorseHandle = nil
		end
		self.yinBiFeedBtn = nil
		self.startBtn = nil
		GlobleFuWenJiLianPanel = nil
		removeUnusedTextures()
	end,
}
eat_select = {
	1,
	1,
	1,
}
--祭坛数据
HorseData = {
	horse_list = {},
	stable_man_list = {},
	server_time = nil ,
	stable_left_count = nil ,
	itemID = nil ,
}
function setHorseDate(json)
	local horse_list = json:getByKey("horse_list")
	local stable_man_list = json:getByKey("stable_man_list")
	local server_time = json:getByKey("server_time"):asDouble()
	local stable_left_count = json:getByKey("stable_left_count"):asInt()
	GloblePlayerData.gold = json:getByKey("gold"):asInt()
	GloblePlayerData.copper = json:getByKey("copper"):asInt()
	HorseData.itemID = json:getByKey("add_item_id_list"):getByIndex(0):asInt()
	for i = 1,horse_list:size() do
		local pre_Horse = horse_list:getByIndex(i-1)
		HorseData.horse_list[i] = new({})
		HorseData.horse_list[i].feed_count = pre_Horse:getByKey("feed_count"):asInt()
		HorseData.horse_list[i].id = pre_Horse:getByKey("id"):asInt()
		HorseData.horse_list[i].status = pre_Horse:getByKey("status"):asInt()
		HorseData.horse_list[i].cfg_item_id = pre_Horse:getByKey("cfg_item_id"):asInt()
		HorseData.horse_list[i].type = pre_Horse:getByKey("type"):asInt()
		HorseData.horse_list[i].feed_cooldown = pre_Horse:getByKey("feed_cooldown"):asDouble()
		HorseData.horse_list[i].growth = pre_Horse:getByKey("growth"):asInt()
	end
	for i = 1,stable_man_list:size() do
		local pre_stable_man_list = stable_man_list:getByIndex(i-1)
		HorseData.stable_man_list[i] = new({})
		HorseData.stable_man_list[i].idx = pre_stable_man_list:getByKey("idx"):asInt()
		HorseData.stable_man_list[i].is_innate = pre_stable_man_list:getByKey("is_innate"):asBool()
	end
	HorseData.server_time = server_time
	HorseData.stable_left_count = stable_left_count
	updataHUDData()
end
HorseCfg = {
	{
		"精灵之地祭炼师",
		"大幅度增加符文品质",
		"30",
	},
	{
		"泰坦苍穹祭炼师",
		"大幅度增加符文暴击",
		"30",
	},
	{
		"魔神炼狱祭炼师",
		"大幅度增加祭炼成功率",
		"25",
	},
}
FuWenNet = function(m_type,idx)
	local cfg_item_id = 0
	local horseNetCB = function (json)
		closeWait()
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			--如果有错误，则返回错误描述
			if error_code == 2001 then
				alert("背包空间不足，无法收取符文。")
			else
				ShowErrorInfoDialog(error_code)
			end
		else
			--否则初始化数据
			GloblePlayerData.gold = json:getByKey("gold"):asInt()
			GloblePlayerData.copper = json:getByKey("copper"):asInt()
			updataHUDData()
				
			if HorseHandle then
				CCScheduler:sharedScheduler():unscheduleScriptEntry(HorseHandle)
				HorseHandle = nil
			end
			--初始化祭坛信息
			setHorseDate(json)
			if GlobleFuWenJiLianPanel == nil then
				GlobleFuWenJiLianPanel = new(FuWenJiLianPanel):create()
			else
				if m_type == 6 then
					local item = {	cfg_item_id,
						HorseData.itemID,
					}
					battleGetItems(item,true)
				end
				GlobleFuWenJiLianPanel:reflash()
			end
		end
	end
	local sendRequest = function ()
		--发送请求
		local action = Net.OPT_Stable
		if m_type == 2 then
			action = Net.OPT_StableManBuy
		elseif m_type == 3 then
			action = Net.OPT_StableAdopt
		elseif m_type == 4 then
			action = Net.OPT_StableFeed
		elseif m_type == 5 then
			action = Net.OPT_StableSpike
		elseif m_type == 6 then
			action = Net.OPT_StableFetch
			cfg_item_id = HorseData.horse_list[idx].cfg_item_id
		elseif m_type == 7 then
			action = Net.OPT_StableSlotOpen
		end

		showWaitDialogNoCircle("waiting skillLock!")
		NetMgr:registOpLuaFinishedCB(action,horseNetCB)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		if m_type > 1 and  m_type < 7  then
			cj:setByKey("idx", idx)
		end
		if m_type == 4 then
			cj:setByKey("type", eat_select[idx])
		end
		NetMgr:executeOperate(action, cj)
	end
	sendRequest()
end
--神域  佣兵任务 面板
function GlobleCreateYongBing()
	if not GlobleYongBingMainPanel then
		GlobleYongBingMainPanel = new(YongBingMainPanel)
		GlobleYongBingMainPanel:create(1)
	end
	
	local function opDockFinishCB(s)
		closeWait()

		local error_code = s:getByKey("error_code"):asInt()
		if error_code ~= -1 then
			ShowErrorInfoDialog(error_code)
		else
			local panel = new(YongBingPanel):create(s)
			GlobleYongBingMainPanel:clearMain()
			GlobleYongBingMainPanel.mainWidget:addChild(panel.main)
			GlobleYongBingMainPanel.yb = panel
			GotoNextStepGuide()
		end
	end

	showWaitDialog("waiting Dock data")
	NetMgr:registOpLuaFinishedCB(Net.OPT_Dock, opDockFinishCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_Dock, opFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	NetMgr:executeOperate(Net.OPT_Dock, cj)
end


local serverTime = nil
local dock_bonus_count = 0
local dock_steal_count = 0

local yb_level_cfg = {
	{"泰坦圣殿","UI/shen_yu/yong_bing/string.fnt"},
	{"巨龙峡谷","UI/shen_yu/yong_bing/string.fnt"},
	{"生命之海","UI/shen_yu/yong_bing/string.fnt"},
	{"魔神炼狱","UI/shen_yu/yong_bing/string.fnt"}
}
--开启需要的VIP等级，第二个改成0，后面特殊判断
local DockVIPCfg = {0,0,5,8}
local DockOpenCastCfg = {0,0,50,100}
local DockCastCfg = {3000,5000,15000,50000}

local yb_task_desc_cfg = {
	"前往巨龙森林获取龙蛋",
	"前往巨龙森林获取龙蛋2",
	"前往巨龙森林获取龙蛋3",
	"前往巨龙森林获取龙蛋4",
}

local fecthPanel = {

	fecthLayer = nil,

	create = function(self,jValue)
		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		local scene = DIRECTOR:getRunningScene()
		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(0,0)
		mask:setScale(1/SCALEY)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		mask.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.centerWidget:addChild(mask)
         
		 local num=jValue:getByKey("fetch_list"):size()
		
		local addHeight=0
		if num+2>6 then 
		addHeight=((num-4)/2+1)*29
		end
		
		local out_bg = createBG("UI/public/dialog_kuang.png",580,400+addHeight)
		out_bg:setAnchorPoint(CCPoint(0.5,0.5))
		out_bg:setPosition(CCPoint(1010 / 2 ,706 / 2))
		self.centerWidget:addChild(out_bg)

		local bg = createBG("UI/public/recuit_dark2.png",523,268+addHeight)
		bg:setAnchorPoint(CCPoint(0.5,0))
		bg:setPosition(CCPoint(580/2,100))
		out_bg:addChild(bg)

		local title = CCLabelTTF:labelWithString("恭喜您完成任务", SYSFONT[EQUIPMENT], 30)
		title:setColor(ccc3(255,254,154))
		title:setPosition(CCPoint(523/2,235+addHeight))
		bg:addChild(title)

		local baseTX = CCLabelTTF:labelWithString("获得：",CCSize(300,0),0, SYSFONT[EQUIPMENT], 24)
		baseTX:setColor(ccc3(203,153,102))
		baseTX:setAnchorPoint(CCPoint(0,0))
		baseTX:setPosition(CCPoint(15,180+addHeight))
		bg:addChild(baseTX)

		local base = CCLabelTTF:labelWithString(jValue:getByKey("base_copper"):asInt().."银币",CCSize(500,0),0, SYSFONT[EQUIPMENT], 22)
		base:setPosition(CCPoint(100,180+addHeight))
		base:setAnchorPoint(CCPoint(0,0))
		base:setColor(ccc3(199,99,50))
		bg:addChild(base)

		local imgPath = ""
		local desc = ""
		local itemList = {}
		local amounts = {}
		local startX = 300
		local row = 0
		for i=0,jValue:getByKey("fetch_list"):size() do
			local eid = jValue:getByKey("fetch_list"):getByIndex(i):asInt()
			imgPath,desc = getEventMsg(eid)
		--[[	local width = getlabelWidth(desc,24)
			if startX + width > 520 then
				row = row + 1
				startX = 100
			end
			--]]
			local TX = CCLabelTTF:labelWithString(desc,CCSize(300,0),0, SYSFONT[EQUIPMENT], 24)
			TX:setPosition(CCPoint(startX,180+addHeight-30*row))
			TX:setAnchorPoint(CCPoint(0,0))
			TX:setColor(ccc3(199,99,50))
			bg:addChild(TX)
			--startX = startX + width + 20
			if startX==100 then
			startX=300
			else
			startX=100
			row = row + 1
			end
						
			if ((12<=eid and eid<=35) or (39<=eid and eid<=41)) then
				table.insert(itemList, cfg_event[eid].value)
				table.insert(amounts, 1)
			elseif 36<=eid and eid <=38 then
				GloblePlayerData.trainings.jump_wand = GloblePlayerData.trainings.jump_wand + cfg_event[eid].value
			end
		end

		campRewardGetItems(itemList,jValue,amounts)

		local lostTX = CCLabelTTF:labelWithString("被抢夺：",CCSize(200,0),0, SYSFONT[EQUIPMENT], 24)
		lostTX:setPosition(CCPoint(15,80))
		lostTX:setColor(ccc3(255,255,0))
		lostTX:setAnchorPoint(CCPoint(0,0))
		bg:addChild(lostTX)

		local startX = 150
		local row = 0
		for i=0, jValue:getByKey("lost_list"):size() do
			imgPath,desc = getEventMsg( jValue:getByKey("lost_list"):getByIndex(i):asInt() )
			local width = getlabelWidth(desc,24)
			if startX + width > 520 then
				row = row + 1
				startX = 100
			end
			local TX = CCLabelTTF:labelWithString(desc,CCSize(400,0),0, SYSFONT[EQUIPMENT], 22)
			TX:setPosition(CCPoint(startX,80-35*row))
			TX:setAnchorPoint(CCPoint(0,0))
			TX:setColor(ccc3(199,99,50))
			bg:addChild(TX)
			startX = startX + width + 20
		end

		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
		closeBtn:setPosition(CCPoint(580/2,50))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		out_bg:addChild(closeBtn)
	end,
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		removeUnusedTextures()
	end,
}

local OneTaskPanel = {
	parent = nil,
	main = nil,

	create = function(self,i,jValue)
		self.index = i
		self.main = dbUIPanel:panelWithSize(CCSize(220,554))
		self.main:setAnchorPoint(CCPoint(0,0))
		self.main:setPosition(CCPoint(47+(i-1)*229,25))
		local panel = self.main
		self.parent.main:addChild(panel)

		self.events = new({})
		self.task = new({})

		if i > jValue:getByKey("dock_ships"):size() then
			self.task.quality = 0
			self.task.status = 0
			self.task.id = 0
			self.task.count = 0
		else
			local json = jValue:getByKey("dock_ships"):getByIndex(i-1)
			self.task.quality = json:getByKey("quality"):asInt()
			self.task.status = json:getByKey("status"):asInt() --1可以接取 2 进行中 3 可以领取 0 没有开启 4可以开启但是没有开启
			self.task.id = json:getByKey("id"):asInt()
			self.task.count = json:getByKey("count"):asInt()

			for j=0, json:getByKey("event_list"):size()-1 do
				self.events[j+1] = json:getByKey("event_list"):getByIndex(j):asInt()
			end
		end
		
		local needVip = DockVIPCfg[i]
		if i > jValue:getByKey("dock_ships"):size() and GloblePlayerData.vip_level>=needVip then
			--第二个任务特殊判断，神位大于40级或VIP大于2级可以开放
			if i==2 then
				if GloblePlayerData.officium >=40 or GloblePlayerData.vip_level >=2 then
					self.task.status = 4
				else
					self.task.status = 0
				end
			else
				self.task.status = 4
			end
		end

		local item_bg = CCSprite:spriteWithFile("UI/shen_yu/yong_bing/item_bg.png")
		item_bg:setPosition(CCPoint(0, 109))
		item_bg:setAnchorPoint(CCPoint(0,0))
		panel:addChild(item_bg)
       
	   local spr 
	   if isRetina>1 then  
	      spr = CCLabelTTF:labelWithString(yb_level_cfg[i][1],CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		  spr:setColor(ccc3(143,186,9))
	   else
		  spr = CCLabelBMFont:labelWithString(yb_level_cfg[i][1],yb_level_cfg[i][2])
	   end
		
		spr:setPosition(CCPoint(220/2+(isRetina-1)*93, 390))
		spr:setAnchorPoint(CCPoint(0.5,0))
		
		item_bg:addChild(spr)

		local spr = CCSprite:spriteWithFile("UI/shen_yu/yong_bing/"..i..".png")
		spr:setPosition(CCPoint(220/2,90))
		spr:setAnchorPoint(CCPoint(0.5,0))
		item_bg:addChild(spr)

		if self.task.status==1 then --接取
			local cooper = DockCastCfg[i]
			self.task.cooper = cooper

			local label = CCLabelTTF:labelWithString("接取需："..cooper.."银币", SYSFONT[EQUIPMENT], 20)
			label:setAnchorPoint(CCPoint(0.5,0))
			label:setColor(ccc3(255,204,102))
			label:setPosition(CCPoint(188/2,25))
			spr:addChild(label)

			local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/accept_btn.png", 1, ccc3(125, 125, 125))
			btn:setPosition(CCPoint(220/2,30))
			btn:setAnchorPoint(CCPoint(0.5,0))
			btn.m_nScriptClickedHandler = function(ccp)
				self:createAcceptPanel()
			end
			panel:addChild(btn)
			self.acceptBtn = btn --引导时用到
		elseif self.task.status==2 then --进行中
			local label = CCLabelTTF:labelWithString("进行中...", SYSFONT[EQUIPMENT], 20)
			label:setAnchorPoint(CCPoint(0.5,0))
			label:setColor(ccc3(255,204,53))
			label:setPosition(CCPoint(188/2,25))
			spr:addChild(label)

			local json = jValue:getByKey("dock_ships"):getByIndex(i-1)
			self.returnTime = math.ceil((json:getByKey("arrive_time"):asDouble() - serverTime)/1000)

			local tips = CCLabelTTF:labelWithString(getLenQueTime(self.returnTime), CCSize(0,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 30)
			tips:setPosition(CCPoint(220/2,50))
			tips:setAnchorPoint(CCPoint(0.5,0))
			tips:setColor(ccc3(51,0,0))
			panel:addChild(tips)
			self.returnTimeTx = tips

			local setReturnTime = function()
				if self.returnTime > 0 then
					self.returnTime = self.returnTime - 1
					self.returnTimeTx:setString(getLenQueTime(self.returnTime))
				else
					CCScheduler:sharedScheduler():unscheduleScriptEntry(self.returnTimeHande)
					self.returnTimeHande = nil
					self.returnTimeTx:removeFromParentAndCleanup(true)
					self.returnTimeTx = nil

					label:setString("已完成")
					--label:setColor(ccc3(255,255,255))

					local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/get_btn.png", 1, ccc3(125, 125, 125))
					btn:setPosition(CCPoint(220/2,30))
					btn:setAnchorPoint(CCPoint(0.5,0))
					btn.m_nScriptClickedHandler = function()
						self:excuteDockFetch()
					end
					panel:addChild(btn)
				end
			end
			self.returnTimeHande = CCScheduler:sharedScheduler():scheduleScriptFunc(setReturnTime,1,false)
		elseif self.task.status==3 then -- 可以领取
			local label = CCLabelTTF:labelWithString("已完成", SYSFONT[EQUIPMENT], 20)
			label:setAnchorPoint(CCPoint(0.5,0))
			label:setColor(ccc3(255,255,255))
			label:setPosition(CCPoint(188/2,25))
			spr:addChild(label)

			local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/get_btn.png", 1, ccc3(125, 125, 125))
			btn:setPosition(CCPoint(220/2,30))
			btn:setAnchorPoint(CCPoint(0.5,0))
			btn.m_nScriptClickedHandler = function()
				self:excuteDockFetch()
			end
			panel:addChild(btn)
		elseif self.task.status==4 then --没有开启 可以开启
			local canOpen = true
			if i > jValue:getByKey("dock_ships"):size()+1 then
				canOpen = false
			end
			local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/open_btn.png", 1, ccc3(125, 125, 125))
			btn:setPosition(CCPoint(220/2,30))
			btn:setAnchorPoint(CCPoint(0.5,0))
			btn.m_nScriptClickedHandler = function(ccp)
				if not canOpen then
					return
				end
				local open = function()
					local function opDockOpenFinishCB(s)
						closeWait()
						local error_code = s:getByKey("error_code"):asInt()
						if error_code ~= -1 then
							ShowErrorInfoDialog(error_code)
						else
							GlobleCreateYongBing()
							GloblePlayerData.gold = s:getByKey("gold"):asInt()
							GloblePlayerData.copper = s:getByKey("copper"):asInt()
							updataHUDData()
						end
					end

					showWaitDialogNoCircle("waiting DockOpen data")
					NetMgr:registOpLuaFinishedCB(Net.OPT_DockSlotOpenSimple, opDockOpenFinishCB)
					NetMgr:registOpLuaFailedCB(Net.OPT_DockSlotOpenSimple, opFailedCB)

					local cj = Value:new()
					cj:setByKey("role_id", ClientData.role_id)
					cj:setByKey("request_code", ClientData.request_code)
					NetMgr:executeOperate(Net.OPT_DockSlotOpenSimple, cj)
				end
				
				if DockOpenCastCfg[i]>0 then
					local dtp = new(DialogTipPanel)
					dtp:create("是否花费"..DockOpenCastCfg[i].."金币开启它",ccc3(255,204,153),180)
					dtp.okBtn.m_nScriptClickedHandler = function()
						open()
						dtp:destroy()
					end
				else
					open()
				end
			end
			panel:addChild(btn)
		else --没有开启
			local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/not_open_btn.png", 1, ccc3(125, 125, 125))
			btn:setPosition(CCPoint(220/2,30))
			btn:setAnchorPoint(CCPoint(0.5,0))
			panel:addChild(btn)
		end

		if self.task.status==0 then --没有开启
			--第二个任务特殊判断
			if i==2 then
				local label = CCLabelTTF:labelWithString("神位40级或VIP2级开启", SYSFONT[EQUIPMENT], 20)
				label:setAnchorPoint(CCPoint(0.5,0))
				label:setColor(ccc3(143,186,9))
				label:setPosition(CCPoint(220/2,25))
				item_bg:addChild(label)
			else
				local label = CCLabelTTF:labelWithString("VIP"..needVip.."级开启", SYSFONT[EQUIPMENT], 20)
				label:setAnchorPoint(CCPoint(0.5,0))
				label:setColor(ccc3(143,186,9))
				label:setPosition(CCPoint(220/2,25))
				item_bg:addChild(label)
			end
		else
			local left = (5-self.task.count)<0  and 0 or (5-self.task.count)
			local label = CCLabelTTF:labelWithString("还可领取：", SYSFONT[EQUIPMENT], 20)
			local num = CCLabelTTF:labelWithString(left.."次", SYSFONT[EQUIPMENT], 25)
			label:setAnchorPoint(CCPoint(0.5,0))
			label:setColor(ccc3(255,204,102))
			label:setPosition(CCPoint(200/2-5,25))
			num:setAnchorPoint(CCPoint(0,0))
			num:setColor(ccc3(143,186,9))
			num:setPosition(CCPoint(140,25))
			item_bg:addChild(label)
			item_bg:addChild(num)
		end

		return self
	end,

	createAcceptPanel = function(self)
		local task = self.task
		local panel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		panel:setPosition(CCPoint(1010/2,706/2))
		panel:setAnchorPoint(CCPoint(0.5, 0.5))
		panel.m_nScriptClickedHandler = function(ccp)
			panel:removeFromParentAndCleanup(true)
			self.toggled = false
			self.acceptPanel = nil
			self.startBtn = nil
		end
		self.acceptPanel = panel
		self.parent.main:addChild(panel,10)

		local bg = createBG("UI/public/dialog_kuang.png",600,700)
		bg:setAnchorPoint(CCPoint(0.5, 0.5))
		bg:setPosition(CCPoint(512,384))
		panel:addChild(bg)

		local kuang = createBG("UI/public/recuit_dark2.png",523,507)
		kuang:setAnchorPoint(CCPoint(0.5,0))
		kuang:setPosition(CCPoint(600/2,145))
		bg:addChild(kuang)

		local spr = CCLabelBMFont:labelWithString(yb_level_cfg[self.index][1],yb_level_cfg[self.index][2])
		spr:setPosition(CCPoint(523/2, 450))
		spr:setAnchorPoint(CCPoint(0.5,0))
		kuang:addChild(spr)

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(523/28)
		line:setPosition(0,420)
		kuang:addChild(line)

		local label = CCLabelTTF:labelWithString("任务描述：",CCSize(500,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(254,205,100))
		label:setPosition(CCPoint(27,365))
		kuang:addChild(label)

		local label = CCLabelTTF:labelWithString(yb_task_desc_cfg[self.index],CCSize(500,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(254,205,100))
		label:setPosition(CCPoint(60,333))
		kuang:addChild(label)

		local label = CCLabelTTF:labelWithString("任务奖励：",CCSize(500,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(254,205,100))
		label:setPosition(CCPoint(27,290))
		kuang:addChild(label)

		self:createRewardPanels(kuang)

		local toggle = dbUIButtonToggle:buttonWithImage("UI/shen_yu/yong_bing/toggle_no.png","UI/shen_yu/yong_bing/toggle_on.png")
		toggle:setAnchorPoint(CCPoint(0,0))
		toggle:setPosition(CCPoint(27, 50))
		kuang:addChild(toggle)

		local protect_cast = 5
		if self.index > 2 then
			protect_cast = 10
		end
		local label = CCLabelTTF:labelWithString("花费"..protect_cast.."金币获得【神之守护】状态，可顺利完成佣兵任务，免受打劫困扰。",CCSize(420,80),0, SYSFONT[EQUIPMENT],24)
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(203,153,102))
		label:setPosition(CCPoint(100,30))
		kuang:addChild(label)

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(523/28)
		line:setPosition(0,140)
		kuang:addChild(line)

		--底下的按钮
		local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/start_btn.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(300-100,70))
		btn:setAnchorPoint(CCPoint(0.5,0))
		btn.m_nScriptClickedHandler = function(ccp)
			self.toggled = toggle:isToggled()
			if task.count >= 5 then
				local cost = 15 + dock_bonus_count*5
				if cost > 50 then
					cost = 50
				end
				local dtp = new(DialogTipPanel)
				dtp:create("免费次数已用完，是否花费"..cost.."金币开始任务？",ccc3(255,204,153),180)
				dtp.okBtn.m_nScriptClickedHandler = function()
					self:excuteDockDispatch(panel)
					dtp:destroy()
				end
				return
			end
			self:excuteDockDispatch(panel)
		end
		bg:addChild(btn)
		self.startBtn = btn
		
		local label = CCLabelTTF:labelWithString("消耗"..task.cooper.."银币", SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setColor(ccc3(102,50,0))
		label:setPosition(CCPoint(300-100,45))
		bg:addChild(label)

		local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/flush_btn.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(300+100,70))
		btn:setAnchorPoint(CCPoint(0.5,0))
		btn.m_nScriptClickedHandler = function(ccp)
			local dtp = new(DialogTipPanel)
			dtp:create("是否花费2金币刷新奖励",ccc3(255,204,153),180)
			dtp.okBtn.m_nScriptClickedHandler = function()

				local function opfinishCB(s)
					closeWait()
					local error_code = s:getByKey("error_code"):asInt()
					if error_code ~= -1 then
						ShowErrorInfoDialog(error_code)
					else
						for j=0, s:getByKey("event_list"):size()-1 do
							self.events[j+1] = s:getByKey("event_list"):getByIndex(j):asInt()
						end
						self:createRewardPanels(kuang)
						GloblePlayerData.gold = s:getByKey("gold"):asInt()
						GloblePlayerData.copper = s:getByKey("copper"):asInt()
						updataHUDData()
					end
				end

				showWaitDialogNoCircle("waiting Dock data")
				NetMgr:registOpLuaFinishedCB(Net.OPT_DockRefreshEventSimple, opfinishCB)
				NetMgr:registOpLuaFailedCB(Net.OPT_DockRefreshEventSimple, opFailedCB)

				local cj = Value:new()
				cj:setByKey("role_id", ClientData.role_id)
				cj:setByKey("request_code", ClientData.request_code)
				cj:setByKey("idx", self.task.id)
				NetMgr:executeOperate(Net.OPT_DockRefreshEventSimple, cj)
				dtp:destroy()
			end
		end
		bg:addChild(btn)
		local label = CCLabelTTF:labelWithString("消耗2金币", SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setColor(ccc3(102,50,0))
		label:setPosition(CCPoint(300+100,45))
		bg:addChild(label)
		
		GotoNextStepGuide()
	end,

	createRewardPanels = function(self,kuang)
		local eventList = self.events
		for i=1,table.getn(eventList) do
			local rewardPanel = dbUIPanel:panelWithSize(CCSize(96,96))
			rewardPanel:setPosition(27+(i-1)*106,174)
			rewardPanel:setAnchorPoint(CCPoint(0,0))
			kuang:addChild(rewardPanel)
			local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			icon:setPosition(48,48)
			rewardPanel:addChild(icon)

			local imgPath,desc = getEventMsg(eventList[i])
			local eventReward = dbUIButtonScale:buttonWithImage(imgPath, 1, ccc3(125, 125, 125))
			eventReward:setPosition(CCPoint(48,48))
			eventReward.m_nScriptClickedHandler = function(ccp)
				alert(desc)
			end
			rewardPanel:addChild(eventReward)
		end
	end,

	excuteDockDispatch = function(self,panel)
		local function opDockDispatchFinishCB(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else
				serverTime = s:getByKey("server_time"):asDouble()
				dock_bonus_count = s:getByKey("dock_bonus_count"):asInt()
				panel:removeFromParentAndCleanup(true)
				self:destroy()
				self:create(self.index,s)
				GlobleDockDispatch = true
				GloblePlayerData.gold = s:getByKey("gold"):asInt()
				GloblePlayerData.copper = s:getByKey("copper"):asInt()
				
				GotoNextStepGuide()
				
				updataHUDData()					
			end
		end

		showWaitDialogNoCircle("waiting Dock data")
		NetMgr:registOpLuaFinishedCB(Net.OPT_DockDispatch, opDockDispatchFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_DockDispatch, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("idx", self.task.id)
		cj:setByKey("type", self.toggled and 1 or 0)
		NetMgr:executeOperate(Net.OPT_DockDispatch, cj)
	end,

	excuteDockFetch = function(self)

		local function opDockFetchFinishCB(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code ~= -1 then
				if error_code == 2001 then
					alert("背包空间不足，无法领取奖励。")
				else
					ShowErrorInfoDialog(error_code)
				end
			else
				self:destroy()
				self:create(self.index,s)
				new(fecthPanel):create(s)
				GloblePlayerData.gold = s:getByKey("gold"):asInt()
				GloblePlayerData.copper = s:getByKey("copper"):asInt()
				updataHUDData()				
			end
		end

		showWaitDialogNoCircle("waiting Dock data")
		NetMgr:registOpLuaFinishedCB(Net.OPT_DockFetch, opDockFetchFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_DockFetch, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("idx", self.task.id)
		NetMgr:executeOperate(Net.OPT_DockFetch, cj)
	end,

	destroy = function(self)
		if self.returnTimeHande then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.returnTimeHande)
			self.returnTimeHande = nil
		end
		self.main:removeFromParentAndCleanup(true)
		self.toggled = false
		self.startBtn = nil
		self.acceptBtn = nil
		self.acceptPanel = nil
		GlobleDockDispatch = nil
	end,

}

YongBingPanel = {
	main = nil,

	initData = function(self,jValue)
		dock_steal_count = jValue:getByKey("dock_steal_count"):asInt()
		dock_bonus_count = jValue:getByKey("dock_bonus_count"):asInt()
		serverTime = jValue:getByKey("server_time"):asDouble()
		GlobleYongBingMainPanel.left_da_jie:setString(dock_steal_count.."次")
	end,

	create = function(self,jValue)
		self:initData(jValue)

		self.main = dbUIPanel:panelWithSize(CCSize(1010, 598))
		self.main:setAnchorPoint(CCPoint(0, 0))
		self.main:setPosition(0,0)
		self.tasks = new({})

		for i = 1, 4 do
			local one = new(OneTaskPanel)
			one.parent = self
			one:create(i,jValue)
			self.tasks[i] = one
		end
		return self
	end,
}

YongBingMainPanel = {
	bgLayer = nil,
	uiLayer = nil,
	topBtns = nil,
	centerWidget = nil,
	mainWidget = nil,

	createTop = function(self)
		self.top = dbUIPanel:panelWithSize(CCSize(1010, 104))
		self.top:setAnchorPoint(CCPoint(0, 0))
		self.top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(self.top)

		local TopBtnConfig = {
			{
				normal = "UI/shen_yu/yong_bing/rw_1.png",
				toggle = "UI/shen_yu/yong_bing/rw_2.png",
				position = 	CCPoint(44, 12),
			},
			{
				normal = "UI/shen_yu/yong_bing/qj_1.png",
				toggle = "UI/shen_yu/yong_bing/qj_2.png",
				position = 	CCPoint(237, 12),
			}
		}
		self.toggles = new({})
		for i = 1 , table.getn(TopBtnConfig) do
			local normalSpr = CCSprite:spriteWithFile(TopBtnConfig[i].normal)
			local togglelSpr = CCSprite:spriteWithFile(TopBtnConfig[i].toggle)
			local btn = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
			btn:setAnchorPoint(CCPoint(0,0))
			btn:setPosition(TopBtnConfig[i].position)
			self.top:addChild(btn)
			self.toggles[i] = btn
		end

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
			GotoNextStepGuide()
		end
		self.top:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
		
		--注册开关切换事件
		for i = 1 , table.getn(self.toggles) do
			self.toggles[i].m_nScriptClickedHandler = function()
				if (self.toggles[i]:isToggled()) then
					self:clearMain()
					if i == 1 then
						GlobleCreateYongBing()
						self.refreshBtn:setIsVisible(false)
					end
					if i == 2 then
						GlobleCreateYongBingDaJie()
						self.refreshBtn:setIsVisible(true)
					end
				end
				public_toggleRadioBtn(self.toggles,self.toggles[i])
			end
		end

		local tou = CCSprite:spriteWithFile("UI/shen_yu/yong_bing/tou.png")
		tou:setPosition(CCPoint(470, 30))
		tou:setAnchorPoint(CCPoint(0, 0))
		self.top:addChild(tou)
		
		self.left_da_jie = CCLabelTTF:labelWithString("",CCSize(500,0),0, SYSFONT[EQUIPMENT], 30)
		self.left_da_jie:setAnchorPoint(CCPoint(0,0))
		self.left_da_jie:setColor(ccc3(254,205,100))
		self.left_da_jie:setPosition(CCPoint(675, 30))
		self.top:addChild(self.left_da_jie)
		
		--刷新
		local refreshBtn = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/dj/flush.png", 1, ccc3(125, 125, 125))
		refreshBtn:setAnchorPoint(CCPoint(0,0))
		refreshBtn:setPosition(CCPoint(750,20))
		refreshBtn.m_nScriptClickedHandler = function()
			public_toggleRadioBtn(self.toggles,self.toggles[2])
			GlobleCreateYongBingDaJie()
		end
		self.refreshBtn=refreshBtn
		self.top:addChild(refreshBtn)
	end,

	create = function(self,topid)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self:createTop()
		self.centerWidget:addChild(self.mainWidget)
		public_toggleRadioBtn(self.toggles,self.toggles[topid])
		self.refreshBtn:setIsVisible(false)
	end,

	clearMain = function(self)
		if GlobleYongBingMainPanel.yb then
			for i=1,4 do
				GlobleYongBingMainPanel.yb.tasks[i]:destroy()
			end
			GlobleYongBingMainPanel.yb = nil
		end
		self.mainWidget:removeAllChildrenWithCleanup(true)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self:clearMain()
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		
		GlobleYongBingMainPanel.yb = nil
		GlobleYongBingMainPanel = nil
	end
}

function getEventMsg(id)
	local imgPath = ""
	local desc = ""
	local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
	if 100 <=id and id<=199 then
		imgPath = "icon/copper.png"
		desc = cfg_event[id].value.."银币"
	elseif 300 <=id and id<=399 then
		imgPath = "icon/jin_yan_dan.png"
		desc = cfg_event[id].value.."经验丹"
	elseif 500 <=id and id<=599 then
		imgPath = "icon/gold.png"
		desc = cfg_event[id].value.."金币"
	elseif 400 <=id and id<=499 then
		local item = itemJsonConfig:getByKey(cfg_event[id].value.."")
		imgPath = "icon/Item/icon_item_"..item:getByKey("icon"):asInt()..".png"
		desc = item:getByKey("name"):asString()
	end

	return imgPath,desc
end
--神域  佣兵任务 打劫  面板
GlobleCreateYongBingDaJie = function()
	local function opDockSeaFinishCB(s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()
		if error_code ~= -1 then
			ShowErrorInfoDialog(error_code)
		else
			local panel = new(YongBingDaJiePanel):create(s)
			GlobleYongBingMainPanel:clearMain()
			GlobleYongBingMainPanel.mainWidget:addChild(panel.main)
			GlobleYongBingMainPanel.dj = panel
		end
	end

	showWaitDialogNoCircle("waiting Dock data")
	NetMgr:registOpLuaFinishedCB(Net.OPT_DockSea, opDockSeaFinishCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_DockSea, opFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	NetMgr:executeOperate(Net.OPT_DockSea, cj)
end
local eventList = {}

local stealSuccessPanel = {

	successLayer = nil,
	deleteHandle = nil,

	create = function(self,eventList)
		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		local scene = DIRECTOR:getRunningScene()
		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(0,0)
		mask:setScale(1/SCALEY)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		mask.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.centerWidget:addChild(mask)

		local out_bg = createBG("UI/public/dialog_kuang.png",430,330)
		out_bg:setAnchorPoint(CCPoint(0.5,0.5))
		out_bg:setPosition(CCPoint(1010 / 2 ,702 / 2))
		self.centerWidget:addChild(out_bg)

		local bg = createBG("UI/public/recuit_dark2.png",360,200)
		bg:setAnchorPoint(CCPoint(0.5,0))
		bg:setPosition(CCPoint(430/2,95))
		out_bg:addChild(bg)
                                                       --您夺得
		local title = CCLabelTTF:labelWithString("恭喜抢到大量财宝", SYSFONT[EQUIPMENT], 30)
		title:setColor(ccc3(255,254,154))
		title:setPosition(CCPoint(360/2,160))
		bg:addChild(title)

		local imgPath = ""
		local desc = ""

		for i=1,table.getn(eventList) do
			imgPath,desc = getEventMsg( eventList[i] )
			local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
			kuang:setAnchorPoint(CCPoint(0, 0))
			kuang:setPosition(CCPoint(20+(i-1)*110,20))
			bg:addChild(kuang)

			local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			icon:setPosition(0,0)
			icon:setAnchorPoint(CCPoint(0, 0))
			kuang:addChild(icon)
			
			local eventReward = dbUIButtonScale:buttonWithImage(imgPath, 1, ccc3(125, 125, 125))
			eventReward:setAnchorPoint(CCPoint(0.5,0.5))
			eventReward:setPosition(CCPoint(48,48))
			eventReward.m_nScriptClickedHandler = function(ccp)
				alert(desc)
			end
			kuang:addChild(eventReward)
		end
		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
		closeBtn:setAnchorPoint(CCPoint(0.5,0.5))
		closeBtn:setPosition(CCPoint(430/2,60))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		out_bg:addChild(closeBtn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		removeUnusedTextures()
	end,
}

local stealWinner = 0
YongBingDaJiePanel = {

	create = function(self,jValue)
		self.main = dbUIPanel:panelWithSize(CCSize(957,574))
		self.main:setPosition(CCPoint(1010/2,25))
		self.main:setAnchorPoint(CCPoint(0.5,0))

		local bg = CCSprite:spriteWithFile("UI/shen_yu/yong_bing/dj/bg.jpg")
		bg:setPosition(CCPoint(0, 0))
		bg:setAnchorPoint(CCPoint(0,0))
		self.main:addChild(bg)

		local loc = {
			{x=313,y=247},{x=73 ,y=123},{x=461,y=200},{x=632,y=259},{x=823,y=378},
			{x=86 ,y=271},{x=342,y=376},{x=506,y=292},{x=662,y=186},{x=773,y=61 },
			{x=53 ,y=69},{x=212,y=154},{x=497,y=256},{x=619,y=62 },{x=822,y=356},
			{x=234,y=62 },{x=467,y=67 },{x=562,y=411},{x=754,y=339},{x=805,y=182},
		}

		self.ships = {}
		self.shipIds = {}

		for i=1,jValue:getByKey("ship_list"):size() do
			local ship = jValue:getByKey("ship_list"):getByIndex(i-1)

			if ship:getByKey("quality"):asInt() == 1 then
				self.ships[i]= dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/dj/1.png", 1, ccc3(125, 125, 125))
			elseif ship:getByKey("quality"):asInt() == 2 then
				self.ships[i] = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/dj/2.png", 1, ccc3(125, 125, 125))
			elseif ship:getByKey("quality"):asInt() == 3 then
				self.ships[i] = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/dj/1.png", 1, ccc3(125, 125, 125))
			else
				self.ships[i] = dbUIButtonScale:buttonWithImage("UI/shen_yu/yong_bing/dj/2.png", 1, ccc3(125, 125, 125))
			end

			self.ships[i]:setAnchorPoint(CCPoint(0.5,0.5))
			self.ships[i]:setPosition(CCPoint(loc[i].x, loc[i].y))
			self.main:addChild(self.ships[i])

			self.shipIds[i] = ship:getByKey("role_id"):asInt()
			local shipId = ship:getByKey("ship_id"):asInt()

			self.ships[i].m_nScriptClickedHandler = function()

				local dtp = new(DialogTipPanel)
				dtp:create("亲，确定要抢劫他吗",ccc3(255,204,153),180)
				dtp.okBtn.m_nScriptClickedHandler = function()

					local function opDockStealFinishCB(s)
						closeWait()
						if s:getByKey("error_code"):asInt() ~= -1 then
							new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
						else
							stealWinner = s:getByKey("result_data"):getByKey("winner"):asInt()
							local  cfg_event_id = s:getByKey("result_data"):getByKey("cfg_event_id"):asInt()
							if ((12<=cfg_event_id and cfg_event_id<=35) or (39<=cfg_event_id and cfg_event_id<=41)) and s:getByKey("result_data"):getByKey("add_item_id_list"):size() ~= 0 then
								local cj = Value:new()
								cj:setByIndex(0, cfg_event[cfg_event_id].value)
								cj:setByIndex(1, s:getByKey("result_data"):getByKey("add_item_id_list"):getByIndex(0):asInt())
								cj:setByIndex(2, 1)
								cj:setByIndex(3, false)
								battleGetItems(cj)
							end
							eventList[1] = cfg_event_id
						end
					end

					showWaitDialogNoCircle("waiting DockSteal data")
					NetMgr:registOpLuaFinishedCB(Net.OPT_DockSteal, opDockStealFinishCB)
					NetMgr:registOpLuaFailedCB(Net.OPT_DockSteal, opFailedCB)

					GlobleSetCanSeeResult(0)
					dbSceneMgr:getSingletonPtr():dockSteal(shipId)
					dtp:destroy()
				end
			end
		end

		local function getShipName()
			local function opSceneGetNameFinishCB(s)
				local error_code = s:getByKey("error_code"):asInt()
				if error_code ~= -1 then
					ShowErrorInfoDialog(error_code)
				else
					for i=1,s:getByKey("name_list"):size() do

						local name_kuang = CCSprite:spriteWithFile("UI/shen_yu/yong_bing/dj/name_kuang.png")
						name_kuang:setPosition(CCPoint(120,95))
						name_kuang:setAnchorPoint(CCPoint(0.5,0))
						self.ships[i]:addChild(name_kuang)

						local nameTX = CCLabelTTF:labelWithString(s:getByKey("name_list"):getByIndex(i-1):getByKey("name"):asString().."", SYSFONT[EQUIPMENT], 20)
						nameTX:setAnchorPoint(CCPoint(0.5,0.5))
						nameTX:setPosition(CCPoint(130/2, 63/2+17))
						nameTX:setColor(ccc3(113,65,0))
						name_kuang:addChild(nameTX)
					end
				end
			end

			NetMgr:registOpLuaFinishedCB(Net.OPT_SceneGetNameSimple, opSceneGetNameFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_SceneGetNameSimple, opFailedCB)

			local ids = Value:new()
			for i=1,table.getn(self.shipIds) do
				ids:setByIndex(i-1,self.shipIds[i])
			end

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("playerIDs",ids)
			NetMgr:executeOperate(Net.OPT_SceneGetNameSimple, cj)
		end

		getShipName()

		if GlobleYongBingMainPanel.left_da_jie then
			GlobleYongBingMainPanel.left_da_jie:setString(jValue:getByKey("dock_steal_count"):asInt().."次")
		end

		self.shipCountTX = CCLabelTTF:labelWithString("当前有："..jValue:getByKey("ship_count"):asInt().."个佣兵在进行任务",CCSize(400,0),0, SYSFONT[EQUIPMENT], 30)
		self.shipCountTX:setAnchorPoint(CCPoint(0,0))
		self.shipCountTX:setPosition(CCPoint(30,512))
		self.shipCountTX:setColor(ccc3(204,255,102))
		self.main:addChild(self.shipCountTX)

		if stealWinner == 1 then
			new(stealSuccessPanel):create(eventList)
			eventList = {}
		elseif stealWinner == 2 then

			local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
			btn.action = nothing

			local dialogCfg = new(basicDialogCfg)
			dialogCfg.msg = "打劫失败了，回去再练练"
			dialogCfg.msgSize = 25
			dialogCfg.msgAlign = "left"
			dialogCfg.btns = {btn}
			new(Dialog):create(dialogCfg)
		end
		stealWinner = 0

		return self
	end,
}
--神域  占奴老厂 奴隶 网络请求相关
SlaveData= {
	capture_list  = {},
	work_count    = nil,
	server_time   = nil,
	work_cooldown = nil,
	masrterId    = 0,
	masrterName    = '',
}
SlaveRecommend = {
	neighbor_list = {},
}
SlaveRequest = {

	initData = function(json)
		SlaveData.capture_list = new({})
		SlaveData.work_count = json:getByKey("work_count"):asInt()
		SlaveData.server_time = json:getByKey("server_time"):asDouble()
		SlaveData.work_cooldown = json:getByKey("work_cooldown"):asDouble()
		SlaveData.capture_list = new({})
		SlaveData.fetch_copper = json:getByKey("fetch_copper"):asInt()
		SlaveData.fetch_exploit = json:getByKey("fetch_exploit"):asInt()
		SlaveData.masrterId = json:getByKey("masrterId"):asInt()
		SlaveData.masrterName = json:getByKey("masrterName"):asString()

		local capture_list = json:getByKey("capture_list")
		for i = 1,capture_list:size() do
			local capture = capture_list:getByIndex(i-1)
			SlaveData.capture_list[i] = new({})
			SlaveData.capture_list[i].face = capture:getByKey("face"):asInt()
			SlaveData.capture_list[i].name = capture:getByKey("name"):asString()
			SlaveData.capture_list[i].nation = capture:getByKey("nation"):asInt()
			SlaveData.capture_list[i].officium = capture:getByKey("officium"):asInt()
			SlaveData.capture_list[i].capture_id = capture:getByKey("capture_id"):asInt()
			SlaveData.capture_list[i].work_tax = capture:getByKey("work_tax"):asInt()
			SlaveData.capture_list[i].work_cooldown = capture:getByKey("work_cooldown"):asDouble()
			SlaveData.capture_list[i].work_count = capture:getByKey("work_count"):asInt()
			SlaveData.capture_list[i].work_status = capture:getByKey("work_status"):asInt()
			SlaveData.capture_list[i].fuck_times = capture:getByKey("fuck_times"):asInt()
			SlaveData.capture_list[i].last_fuck_date = capture:getByKey("last_fuck_date"):asDouble()
			SlaveData.capture_list[i].fetch_copper = 0
			SlaveData.capture_list[i].fetch_exploit = 0
		end
	end,

	createGlobleSlaveWork = function()
		if GlobleSlaveWorkPanel == nil then
			GlobleSlaveWorkPanel = new(SlaveWorkPanel):create()
		else
			GlobleSlaveWorkPanel:clear()
			GlobleSlaveWorkPanel:create()
		end
		GotoNextStepGuide()
	end,

	--查询奴隶
	list = function(type,target_id)
		local response = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				SlaveRequest.initData(json)
				SlaveRequest.createGlobleSlaveWork()
			end
		end

		local sendRequest = function ()
			local action = Net.OPT_CaptureList
			if type == 2 then
				action = Net.OPT_Free
			elseif type == 3 then
				action = Net.OPT_SlaveWorkSpike
			end
			showWaitDialogNoCircle("waiting OPT_CaptureList!")
			NetMgr:registOpLuaFinishedCB(action,response)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			if type == 2 then
				cj:setByKey("target_id", target_id)
			end
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,

	updateSlave = function(slave,json)
		SlaveData.server_time = json:getByKey("server_time"):asDouble()
		slave.work_cooldown = json:getByKey("work_cooldown"):asDouble()
		slave.work_status = json:getByKey("work_status"):asInt()
		slave.work_count = json:getByKey("work_count"):asInt()
		slave.fetch_copper = json:getByKey("fetch_copper"):asInt()
		slave.fetch_exploit = json:getByKey("fetch_exploit"):asInt()
	end,

	--奴隶反抗了
	resist = function()
		if checkFormationIsEmpty() then
			return
		end
				
		local netCallback = function (json)
			local temp = (WaitDialog ~= nil and WaitDialog.closePanelFunc ~= nil) and WaitDialog.closePanelFunc() or 0
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				
				
				local result_data = json:getByKey("result_data"):getByKey("winner"):asInt()
				if result_data == 1 then
					ShowInfoDialog("恭喜您获得自由。")
					if GlobleSlaveWorkPanel.masterNamelabel then
						GlobleSlaveWorkPanel.masterNamelabel:removeFromParentAndCleanup(true)
						GlobleSlaveWorkPanel.fkBtn:removeFromParentAndCleanup(true)
						GlobleSlaveWorkPanel.masterNamelabel = nil
						GlobleSlaveWorkPanel.fkBtn = nil
					end
				end
			end
		end

		local sendRequest = function ()
			local action = Net.OPT_Resist
			showWaitDialogNoCircle("waiting OPT_Resist!")
			NetMgr:registOpLuaFinishedCB(action,netCallback)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			dbSceneMgr:getSingletonPtr():setCurBattleType(5)
			GlobleSetCanSeeResult(0)
			
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,

	--开始工作
	startWork = function(panel,slave)
		local response = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				SlaveRequest.updateSlave(slave,json)
				panel:reflash(slave)
			end
		end

		local sendRequest = function ()
			showWaitDialogNoCircle("waiting OPT_CaptureList!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_SlaveStartWork,response)
			NetMgr:registOpLuaFailedCB(Net.OPT_SlaveStartWork,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("capture_id", slave.capture_id)
			NetMgr:executeOperate(Net.OPT_SlaveStartWork, cj)
		end
		sendRequest()
	end,

	--停止工作
	stopWork = function(panel,slave)
		local response = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				SlaveRequest.updateSlave(slave,json)
				panel:reflash(slave)
			end
		end

		local sendRequest = function ()
			showWaitDialogNoCircle("waiting OPT_CaptureList!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_SlaveStopWork,response)
			NetMgr:registOpLuaFailedCB(Net.OPT_SlaveStopWork,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("capture_id", slave.capture_id)
			NetMgr:executeOperate(Net.OPT_SlaveStopWork, cj)
		end
		sendRequest()
	end,

	--获取工作收益
	getWorkIncome = function(panel,slave)
		local response = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				SlaveRequest.updateSlave(slave,json)
				panel:reflash(slave)
				ShowInfoDialog("获得 "..slave.fetch_copper.."银币， 战功 "..slave.fetch_exploit)
				
				GloblePlayerData.gold = json:getByKey("gold"):asInt()
				GloblePlayerData.copper = json:getByKey("copper"):asInt()
				GloblePlayerData.exploit = json:getByKey("exploit"):asInt()
				updataHUDData()
			end
		end

		local sendRequest = function ()
			showWaitDialogNoCircle("waiting OPT_CaptureList!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_SlaveGetWorkIncome,response)
			NetMgr:registOpLuaFailedCB(Net.OPT_SlaveGetWorkIncome,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("capture_id", slave.capture_id)
			NetMgr:executeOperate(Net.OPT_SlaveGetWorkIncome, cj)
		end
		sendRequest()
	end,

	--释放并 砸干她
	free = function(window,slave)
		local response = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				window:destroy()
				GlobleSlaveWorkPanel:destroy()
				SlaveRequest.initData(json)
				SlaveRequest.createGlobleSlaveWork()
				
				GloblePlayerData.gold = json:getByKey("gold"):asInt()
				GloblePlayerData.copper = json:getByKey("copper"):asInt()
				GloblePlayerData.exploit = json:getByKey("exploit"):asInt()
				updataHUDData()
			end
		end

		local sendRequest = function ()
			showWaitDialogNoCircle("waiting OPT_CaptureList!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_Free,response)
			NetMgr:registOpLuaFailedCB(Net.OPT_Free,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("target_id", slave.capture_id)
			NetMgr:executeOperate(Net.OPT_Free, cj)
		end
		sendRequest()
	end,

	--调戏，完虐
	fuck = function(win,slave,type)
		local response = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				slave.fuck_times = json:getByKey("fuck_times"):asInt()
				local fetch_copper = json:getByKey("fetch_copper"):asInt()
				local fetch_exploit = json:getByKey("fetch_exploit"):asInt()
				ShowInfoDialog("获得 "..fetch_copper.."银币")
				
				GloblePlayerData.gold = json:getByKey("gold"):asInt()
				GloblePlayerData.copper = json:getByKey("copper"):asInt()
				GloblePlayerData.exploit = json:getByKey("exploit"):asInt()
				updataHUDData()
			end
		end

		local sendRequest = function ()
			local action = Net.OPT_SlaveFuck
			showWaitDialogNoCircle("waiting OPT_SlaveWork!")
			NetMgr:registOpLuaFinishedCB(action,response)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("idx", type)
			cj:setByKey("capture_id", slave.capture_id)
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,

	slaveRecommendRequest = function ()
		local response = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				local neighbor_list = json:getByKey("neighbor_list")
				for i = 1,neighbor_list:size() do
					local neighbor = neighbor_list:getByIndex(i-1)
					SlaveRecommend.neighbor_list[i] = new({})
					SlaveRecommend.neighbor_list[i].face = neighbor:getByKey("face"):asInt()
					SlaveRecommend.neighbor_list[i].role_id = neighbor:getByKey("role_id"):asInt()
					SlaveRecommend.neighbor_list[i].name = neighbor:getByKey("name"):asString()
					SlaveRecommend.neighbor_list[i].nation = neighbor:getByKey("nation"):asInt()
					SlaveRecommend.neighbor_list[i].officium = neighbor:getByKey("officium"):asInt()
				end
				if not GloablPlayerForSlavePanel then
					GloablPlayerForSlavePanel = new(PlayerForSlavePanel)
				end
				GloablPlayerForSlavePanel:create()
				GotoNextStepGuide()
			end
		end

		local sendRequest = function ()
			local action = Net.OPT_SlaveRecommand
			showWaitDialogNoCircle("")
			NetMgr:registOpLuaFinishedCB(action,response)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,

	capture = function(target_id)
		local response = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
			else
				SlaveRequest.initData(json:getByKey("capture_list"))
				SlaveRequest.createGlobleSlaveWork()
			end
		end
		local sendRequest = function ()
			local action = Net.OPT_Capture
			showWaitDialogNoCircle("waiting OPT_Capture!")
			NetMgr:registOpLuaFinishedCB(action,response)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			dbSceneMgr:getSingletonPtr():setCurBattleType(4)
			GlobleSetCanSeeResult(0)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("target_id", target_id)
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end
}
--神域  战奴牢场 面板
function GlobleCreateSlaveWork()
	SlaveRequest.list(1)
end

--奴隶主界面
SlaveWorkPanel = {
	items = nil,

	create = function(self)
		if not self.mainWidget then
			self:initBase()
		end
		self.items = new({})
		for i=1,6 do
			self.items[i] = new(SlaveWorkItemPanel):create(self,SlaveData.capture_list[i],i)
		end
		return self
	end,

	initBase = function(self)
		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		local scene = DIRECTOR:getRunningScene()
		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/shen_yu/slave/bg.jpg")
		bg:setScale(WINSIZE.height/bg:getContentSize().height)
		bg:setPosition(WINSIZE.width/2, WINSIZE.height/2)
		self.uiLayer:addChild(bg,-1)

		--面板提示图标
		local title_tip_bg = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		title_tip_bg:setPosition(CCPoint(0, 630))
		title_tip_bg:setAnchorPoint(CCPoint(0, 0))
		self.centerWidget:addChild(title_tip_bg)
		local label = CCLabelTTF:labelWithString("战奴劳场", SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setPosition(CCPoint(100,35))
		label:setColor(ccc3(255,204,153))
		title_tip_bg:addChild(label)
		
		if SlaveData.masrterId>0 then
			local label = CCLabelTTF:labelWithString("你被"..SlaveData.masrterName.."奴役了", SYSFONT[EQUIPMENT], 30)
			label:setAnchorPoint(CCPoint(0.5, 0.5))
			label:setPosition(CCPoint(350,660))
			self.centerWidget:addChild(label)
			self.masterNamelabel = label
			
			--起义按钮
			local fkBtn = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/fk.png",1.2)
			fkBtn:setPosition(CCPoint(600, 660))
			fkBtn.m_nScriptClickedHandler = function()
				SlaveRequest.resist()
			end
			self.fkBtn = fkBtn
			self.centerWidget:addChild(fkBtn)
		end
				
		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setPosition(CCPoint(952, 660))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
			GotoNextStepGuide()
		end
		self.centerWidget:addChild(closeBtn)
		self.closeBtn = closeBtn
		
		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
	end,

	clear = function(self)
		for i=1,6 do
			local item = self.items[i]
			if item and item.workHandler then
				CCScheduler:sharedScheduler():unscheduleScriptEntry(item.workHandler)
				item.workHandler = nil
			end
		end
		self.mainWidget:removeAllChildrenWithCleanup(true)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)

		self:clear()
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil

		GlobleSlaveWorkPanel = nil
		removeUnusedTextures()
	end,
}

SlaveWorkItemPanel = {

	panel = nil,
	idx = nil,

	reflash = function(self,slave)
		if self.workHandler then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.workHandler)
			self.workHandler = nil
		end

		self.panel:removeFromParentAndCleanup(true)
		self:create(self.parent,slave,self.idx)
	end,

	create = function(self,parent,slave,idx)
		self.idx = idx
		self.parent = parent
		self.slave = slave

		local item = dbUIPanel:panelWithSize(CCSize(245,295))
		item:setAnchorPoint(CCPoint(0,0.5))
		item:setPosition(SLAVE_POS_CFG[idx])
		parent.mainWidget:addChild(item)
		self.panel = item

		local k = CCSprite:spriteWithFile("UI/shen_yu/slave/k.png")
		k:setPosition(CCPoint(245/2,0))
		k:setAnchorPoint(CCPoint(0.5,0))
		item:addChild(k)
		
		--如果已经抓取了奴隶
		if slave ~= nil then

			local head = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/head_kuang_p.png",1,ccc3(245,15,12))
			head:setPosition(CCPoint(20, 160))
			head:setAnchorPoint(CCPoint(0, 0))
			head.m_nScriptClickedHandler= function()
				new(FuckSlavePanel):create(self.parent,self,slave)
			end
			item:addChild(head)
			local man = CCSprite:spriteWithFile("head/Middle/head_middle_"..slave.face..".png")
			man:setPosition(head:getContentSize().width/2,head:getContentSize().height/2+6)
			head:addChild(man)

			local name = CCLabelTTF:labelWithString(slave.name,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
			name:setAnchorPoint(CCPoint(0,0))
			name:setPosition(CCPoint(130,230))
			name:setColor(ccc3(255,204,102))
			item:addChild(name)

			local createLabel = function(text,ccc3,pos)
				local label = CCLabelTTF:labelWithString(text,CCSize(300,0),0, SYSFONT[EQUIPMENT], 20)
				label:setAnchorPoint(CCPoint(0,0))
				label:setPosition(pos)
				label:setColor(ccc3)
				item:addChild(label)
				return label
			end

			if slave.work_status==0 then --闲着没事干
				local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/start_work.png",1,ccc3(255,203,153))
				btn:setPosition(CCPoint(245/2, 10))
				btn.m_nScriptClickedHandler = function()
					if slave.work_count >=5 then
						local dtp = new(DialogTipPanel)
						dtp:create("今日免费次数已用完。是否花费10金币继续？",ccc3(255,204,153),180)
						dtp.okBtn.m_nScriptClickedHandler = function()
							dtp:destroy()
							SlaveRequest.startWork(self,slave)
						end
					else
						SlaveRequest.startWork(self,slave)
					end
				end
				item:addChild(btn)
				createLabel("闲着没事干...",ccc3(153,204,0),CCPoint(130,200))
			elseif slave.work_status==1 then --工作中
				local get_money = new(ButtonScale)
				get_money:create("UI/shen_yu/slave/stop_work.png",1,ccc3(15,165,245))
				get_money.btn:setAnchorPoint(CCPoint(0.5,0.5))
				get_money.btn:setPosition(CCPoint(245/2, 10))
				get_money.btn.m_nScriptClickedHandler = function(ccp)
					SlaveRequest.stopWork(self,slave)
				end
				item:addChild(get_money.btn)

				if slave.work_cooldown>0 and slave.work_status==1 then
					self.cooldown_label_desc = createLabel("剩余时间：",ccc3(153,204,0),CCPoint(130,210))
					self.cooldown_time = math.ceil((slave.work_cooldown - SlaveData.server_time)/1000)
					self.cooldown_label = createLabel(getLenQueTime(self.cooldown_time),ccc3(255,154,2),CCPoint(130,185))
					self:handleWorkTime()
				end
			elseif slave.work_status==2 then --工作完成
				local get_money = new(ButtonScale)
				get_money:create("UI/shen_yu/slave/get_money.png",1,ccc3(15,165,245))
				get_money.btn:setAnchorPoint(CCPoint(0.5,0.5))
				get_money.btn:setPosition(CCPoint(245/2, 10))
				get_money.btn.m_nScriptClickedHandler = function(ccp)
					SlaveRequest.getWorkIncome(self,slave)
				end
				item:addChild(get_money.btn)

				createLabel("工作完成",ccc3(255,154,2),CCPoint(130,200))
			end
		else
			--cfg_vip_data在cfg_vip.lua中定义
			local capture_max = cfg_vip_data[GloblePlayerData.vip_level+1].capture_max --VIP是0开始计数，lua的table索引是1开始
			--capture_max可以抓捕的奴隶总数
			if idx <= capture_max then
			--奴隶2 神位40级或vip1开启  ，奴隶3   神位60级或vip2开启
				if idx == 2 then
					if GloblePlayerData.officium >=40 or GloblePlayerData.vip_level >=1 then
						item.m_nScriptClickedHandler = function(ccp)
							SlaveRequest.slaveRecommendRequest()
						end
						local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/catch.png",1,ccc3(255,203,153))
						btn:setPosition(CCPoint(245/2, 10))
						btn.m_nScriptClickedHandler = function()
							SlaveRequest.slaveRecommendRequest()
						end
						item:addChild(btn)
					else
						local t = idx - 1
						local not_open = CCSprite:spriteWithFile("UI/shen_yu/slave/slave_open_vip_"..t..".png")
						not_open:setPosition(item:getContentSize().width/2,item:getContentSize().height/2-150)
						item:addChild(not_open)
					end
				elseif idx == 3 then
					if GloblePlayerData.officium >=60 or GloblePlayerData.vip_level >=2 then
						item.m_nScriptClickedHandler = function(ccp)
							SlaveRequest.slaveRecommendRequest()
						end
						local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/catch.png",1,ccc3(255,203,153))
						btn:setPosition(CCPoint(245/2, 10))
						btn.m_nScriptClickedHandler = function()
							SlaveRequest.slaveRecommendRequest()
						end
						item:addChild(btn)
					else
						local t = idx - 1
						local not_open = CCSprite:spriteWithFile("UI/shen_yu/slave/slave_open_vip_"..t..".png")
						not_open:setPosition(item:getContentSize().width/2,item:getContentSize().height/2-150)
						item:addChild(not_open)
					end
				else
					item.m_nScriptClickedHandler = function(ccp)
						SlaveRequest.slaveRecommendRequest()
					end
					local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/catch.png",1,ccc3(255,203,153))
					btn:setPosition(CCPoint(245/2, 10))
					btn.m_nScriptClickedHandler = function()
						SlaveRequest.slaveRecommendRequest()
					end
					item:addChild(btn)
					self.captueBtn = btn
				end
			else
				--未开启的位置显示相应图片
				local findVipRequired = function(idx)
					for i=1,table.getn(cfg_vip_data) do
						if cfg_vip_data[i].capture_max>= idx then
							return cfg_vip_data[i].vip_level
						end
					end
				end
				local requiredVip = findVipRequired(idx)
				local not_open = CCSprite:spriteWithFile("UI/shen_yu/slave/slave_open_vip_"..requiredVip..".png")
				not_open:setPosition(item:getContentSize().width/2,item:getContentSize().height/2-150)
				item:addChild(not_open)
			end
		end
		return self
	end,

	handleWorkTime = function(self)
		self.cooldown_label:setIsVisible(true)
		self.cooldown_label_desc:setIsVisible(true)

		local setLenQueTime = function()
			if self.cooldown_time > 0 then
				self.slave.work_cooldown = self.slave.work_cooldown - 1000
				self.cooldown_time = self.cooldown_time - 1
				self.cooldown_label:setString(getLenQueTime(self.cooldown_time))
			else
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.workHandler)
				self.workHandler = nil
				self.slave.work_status = 2
				self:reflash(self.slave)
			end
		end

		if self.workHandler == nil then
			self.workHandler = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
		else
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.workHandler)
			self.workHandler = nil
			self.workHandler = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
		end
	end,
}

--调戏弹出框
FuckSlavePanel = {
	itemPanel = nil,

	reflash = function(self,slave)
		self.itemPanel:reflash(slave)

		if self.workHandler then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.workHandler)
			self.workHandler = nil
		end

		self.panel:removeFromParentAndCleanup(true)
		self:create(self.parent,self.itemPanel,slave)
	end,

	create = function(self,parent,itemPanel,slave)
		self.parent = parent
		self.slave = slave
		self.itemPanel = itemPanel

		local panel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		panel:setPosition(CCPoint(1010/2,706/2))
		panel:setAnchorPoint(CCPoint(0.5, 0.5))
		panel.m_nScriptClickedHandler = function(ccp)
			self:destroy()
		end
		self.panel = panel
		parent.centerWidget:addChild(panel)

		local bg = createBG("UI/public/dialog_kuang.png",540,480)
		bg:setAnchorPoint(CCPoint(0.5, 0.5))
		bg:setPosition(CCPoint(512,384))
		panel:addChild(bg)

		local kuang = createBG("UI/public/recuit_dark2.png",470,285)
		kuang:setAnchorPoint(CCPoint(0.5,0))
		kuang:setPosition(CCPoint(540/2,155))
		bg:addChild(kuang)

		local k = CCSprite:spriteWithFile("UI/shen_yu/slave/k.png")
		k:setPosition(CCPoint(20,0))
		k:setAnchorPoint(CCPoint(0,0))
		kuang:addChild(k)

		local head = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/head_kuang_p.png",1,ccc3(245,15,12))
		head:setPosition(CCPoint(27, 155))
		head:setAnchorPoint(CCPoint(0, 0))
		kuang:addChild(head)
		local man = CCSprite:spriteWithFile("head/Middle/head_middle_"..slave.face..".png")
		man:setPosition(head:getContentSize().width/2,head:getContentSize().height/2+6)
		head:addChild(man)
		--名字
		local name = CCLabelTTF:labelWithString(slave.name,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
		name:setAnchorPoint(CCPoint(0,0))
		name:setPosition(CCPoint(130,235))
		name:setColor(ccc3(255,204,102))
		kuang:addChild(name)

		local createLabel = function(text,ccc3,pos,addTo,fontsize)
			local add = addTo and addTo or kuang
			local size = fontsize and fontsize or 20
			local label = CCLabelTTF:labelWithString(text,CCSize(300,0),0, SYSFONT[EQUIPMENT], size)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(pos)
			label:setColor(ccc3)
			add:addChild(label)
			return label
		end
		if slave.work_cooldown>0 and slave.work_status==1 then
			self.cooldown_label_desc = createLabel("剩余时间：",ccc3(153,204,0),CCPoint(130,210))
			--self.cooldown_label_desc:setFontSize(18)
			self.cooldown_time = math.ceil((slave.work_cooldown - SlaveData.server_time)/1000)
			self.cooldown_label = createLabel(getLenQueTime(self.cooldown_time),ccc3(255,153,0),CCPoint(130,183))
			--self.cooldown_label:setFontSize(18)
			self:handleWorkTime()
		end
		if slave.work_cooldown>0 and slave.work_status==2 then
			createLabel("终于干完活了...",ccc3(255,154,2),CCPoint(130,200))
		end
		if slave.work_status==0 then
			createLabel("行行好，别让我干活了",ccc3(255,154,2),CCPoint(130,200))
		end

		--虐待按钮
		FUCK_CFG = {
			"UI/shen_yu/slave/1.png",
			"UI/shen_yu/slave/2.png",
			"UI/shen_yu/slave/3.png",
			"UI/shen_yu/slave/4.png",
		}
		for i=1,4 do
			local btn = dbUIButtonScale:buttonWithImage(FUCK_CFG[i],1,ccc3(99,52,0))
			btn:setPosition(CCPoint(350, 215-(i-1)*65))
			btn:setAnchorPoint(CCPoint(0,0))
			btn.m_nScriptClickedHandler= function()
				if slave.fuck_times >=4 then
					local dtp = new(DialogTipPanel)
					dtp:create("今日免费次数已用完。是否花费2金币继续？",ccc3(255,204,153),180)
					dtp.okBtn.m_nScriptClickedHandler = function()
						dtp:destroy()
						SlaveRequest.fuck(self,slave,i)
					end
				else
					SlaveRequest.fuck(self,slave,i)
				end
			end
			kuang:addChild(btn)
		end

		--底下
		local panel = dbUIPanel:panelWithSize(CCSizeMake(200,140))
		panel:setPosition(CCPoint(34,15))
		panel:setAnchorPoint(CCPoint(0, 0))
		bg:addChild(panel)

		local createLabel = function(text,ccc3,pos,dest,fontsize)
			local size=fontsize and fontsize or 20
			local label = CCLabelTTF:labelWithString(text, SYSFONT[EQUIPMENT], size)
			label:setPosition(pos)
			label:setColor(ccc3)
			dest:addChild(label)
			return label
		end

		
		--createLabel(slave.officium*100 ,ccc3(99,52,0),CCPoint(100,90),panel)

		if slave.work_status==0 then --闲着没事干
			
		--开始工作	
			local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/start_work.png",1,ccc3(99,52,0))
			btn:setPosition(CCPoint(100, 48))
			btn.m_nScriptClickedHandler = function(ccp)
				if slave.work_count >=5 then
					local dtp = new(DialogTipPanel)
					dtp:create("今日免费次数已用完。是否花费10金币继续？",ccc3(255,204,153),180)
					dtp.okBtn.m_nScriptClickedHandler = function()
						dtp:destroy()
						SlaveRequest.startWork(self,slave)
					end
				else
					SlaveRequest.startWork(self,slave)
				end
			end
			panel:addChild(btn)
		elseif slave.work_status==2 then --工作结束,可以领取收益
			
			--显示收益信息
			
			createLabel("当前可提取银币:"..slave.officium*100,ccc3(102,51,0),CCPoint(100,100),panel,18)
			createLabel(" 战功:"..slave.officium*2,ccc3(102,51,0),CCPoint(250,100),panel,18)
			local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/get.png",1,ccc3(99,52,0))
			btn:setPosition(CCPoint(100, 48))
			btn.m_nScriptClickedHandler= function()
				SlaveRequest.getWorkIncome(self,slave)
			end
			panel:addChild(btn)
		elseif slave.work_status==1 then --工作中
			
			--停止工作	
			local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/stop_work.png",1,ccc3(99,52,0))
			btn:setPosition(CCPoint(100, 48))
			btn.m_nScriptClickedHandler= function()
				SlaveRequest.stopWork(self,slave)
			end
			panel:addChild(btn)
		end

		local panel = dbUIPanel:panelWithSize(CCSizeMake(200,140))
		panel:setPosition(CCPoint(268,15))
		panel:setAnchorPoint(CCPoint(0, 0))
		bg:addChild(panel)
		--createLabel("花费10金币直接榨干她",ccc3(102,51,0),CCPoint(100,115),panel)
		--createLabel("收取100%的收益，并释放奴隶",ccc3(102,51,0),CCPoint(100,90),panel)
		
		--释放按钮
		if slave.work_status==0 or slave.work_status==2 then
			local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/free.png",1,ccc3(99,52,0))
			btn:setPosition(CCPoint(100, 48))
			btn.m_nScriptClickedHandler= function()
				local dtp = new(DialogTipPanel)
				dtp:create("请确定是否释放"..slave.name.."?",ccc3(255,204,153),180)
				dtp.okBtn.m_nScriptClickedHandler = function()
					dtp:destroy()
					SlaveRequest.free(self,slave)
				end
			end
			panel:addChild(btn)
		elseif slave.work_status==1 then
			--释放按钮无效
			local btn = CCSprite:spriteWithFile("UI/shen_yu/slave/free_locked.png")
			btn:setPosition(CCPoint(100, 48))
			panel:addChild(btn)
		end
		

		--关闭按钮
		local btn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1,ccc3(99,52,0))
		btn:setPosition(CCPoint(480,430))
		btn:setAnchorPoint(CCPoint(0, 0))
		btn.m_nScriptClickedHandler= function()
			self:destroy()
		end
		bg:addChild(btn)
	end,

	handleWorkTime = function(self)
		self.cooldown_label:setIsVisible(true)
		self.cooldown_label_desc:setIsVisible(true)

		local setLenQueTime = function()
			if self.cooldown_time > 0 then
				self.cooldown_time = self.cooldown_time - 1
				self.cooldown_label:setString(getLenQueTime(self.cooldown_time))
			else
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.workHandler)
				self.workHandler = nil
				self.slave.work_status = 2
				self:reflash(self.slave)
			end
		end

		if self.workHandler == nil then
			self.workHandler = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
		else
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.workHandler)
			self.workHandler = nil
			self.workHandler = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
		end
	end,

	destroy = function(self)
		if self.workHandler then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.workHandler)
			self.workHandler = nil
		end
		self.panel:removeFromParentAndCleanup(true)
	end
}

--推荐可以作为奴隶的玩家
PlayerForSlavePanel = {
	create = function(self)
		if not self.mainWidget then
			self:initBase()
		end
		self.mainWidget:removeAllChildrenWithCleanup(true)

		for i = 1 , table.getn(SlaveRecommend.neighbor_list) do
			local column = (i-1) % 5+1
			local row = i >5 and 2 or 1
			local player = SlaveRecommend.neighbor_list[i]

			local item = dbUIPanel:panelWithSize(CCSize(165,250))
			item:setAnchorPoint(CCPoint(0, 0))
			item:setPosition(CCPoint(55+(column-1)*185,320-(row-1)*270))
			self.mainWidget:addChild(item)

			local bg = CCSprite:spriteWithFile("UI/shen_yu/slave/player_bg.png")
			bg:setPosition(CCPoint(165/2, 250/2))
			item:addChild(bg)

			local head = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/head_kuang.png",1,ccc3(245,15,12))
			head:setPosition(CCPoint(165/2, 125))
			head:setAnchorPoint(CCPoint(0.5, 0))
			head.m_nScriptClickedHandler = function()
				if checkFormationIsEmpty() then
					return
				end
				local dialogCfg = new(basicDialogCfg)
				dialogCfg.msg = "是否奴役"..player.name.."？"
				dialogCfg.position = CCPoint(WINSIZE.width / 2, WINSIZE.height / 2)
				dialogCfg.dialogType = 5

				local kill = function()
					SlaveRequest.capture(player.role_id)
				end

				local bs = new(ButtonScale)
				bs:create("UI/public/noTextBtn.png",1,ccc3(100,100,100),"就要你了")
				local btns = {}
				btns[1] = bs.btn
				btns[1].action = kill
				dialogCfg.btns = btns
				new(Dialog):create(dialogCfg)
				GlobleCaptueBtn = bs.btn
				GotoNextStepGuide()
			end
			item:addChild(head)

			local face = CCSprite:spriteWithFile("head/Middle/head_middle_"..player.face..".png")
			face:setPosition(CCPoint(94/2, 94/2))
			head:addChild(face)
			local name = CCLabelTTF:labelWithString(player.name, SYSFONT[EQUIPMENT], 22)
			name:setAnchorPoint(CCPoint(0.5,1))
			name:setPosition(CCPoint(item:getContentSize().width/2,80))
			name:setColor(ccc3(255,204,102))
			item:addChild(name)
			local officium = CCLabelTTF:labelWithString(player.officium.."级", SYSFONT[EQUIPMENT], 22)
			officium:setAnchorPoint(CCPoint(0.5,1))
			officium:setPosition(CCPoint(item:getContentSize().width/2,45))
			officium:setColor(ccc3(255,0,153))
			item:addChild(officium)
			
			if i == 1 then
				GlobleRecommendSlave = head
			end 
		end
		return self
	end,

	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		local top = dbUIPanel:panelWithSize(CCSize(1010,106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)

		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setPosition(CCPoint(952, 44))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		top:addChild(closeBtn)

		local btn = dbUIButtonScale:buttonWithImage("UI/shen_yu/slave/flush.png",1,ccc3(125,12,147))
		btn:setPosition(CCPoint(800, 44))
		btn.m_nScriptClickedHandler = function()
			SlaveRequest.slaveRecommendRequest()
		end
		top:addChild(btn)
		local label = CCLabelTTF:labelWithString("系统已帮您找到合适的“奴隶”人选，请领导挑选抓捕！",CCSize(800,0),0, SYSFONT[EQUIPMENT], 24)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(40,44))
		label:setColor(ccc3(102,51,0))
		top:addChild(label)

		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		GloablPlayerForSlavePanel = nil
		GlobleRecommendSlave = nil
		GlobleCaptueBtn = nil
	end
}

SLAVE_POS_CFG={
	CCPoint(100,500),
	CCPoint(400,500),
	CCPoint(700,500),
	CCPoint(100,200),
	CCPoint(400,200),
	CCPoint(700,200),
}
--驯服面板
function createTavernPanel()
	local function opCreateTarvernFinishCB(s)
		closeWait()
		if s:getByKey("error_code"):asInt() == -1 then
			if s:getByKey("tavern_generals"):size() == 0 then
				new(SimpleTipPanel):create(TAVERN_RESULT1,ccc3(255,0,0),0)
			end
			GlobleZhaoMuPanel = new(ZhaoMuPanel):create(s)
			GotoNextStepGuide()
		else
			new(SimpleTipPanel):create(ERROR_CODE_DESC[data:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
		end
	end

	local function execCreateTarvern()
		showWaitDialog("waiting tavern data!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_Treat, opCreateTarvernFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_Treat, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code",ClientData.request_code)
		cj:setByKey("keep",true)
		NetMgr:executeOperate(Net.OPT_Treat, cj)
	end
	execCreateTarvern()
end
GlobleZhaoMuFlashing = false
GlobleZhaoMuFlashed = false
ZhaoMuPanel = {
	data = nil,
	cfg_general_ids = {},
	fired_cfg_general_ids = {},
	tavern_epic  = {},
	hasEpic = false,

	create = function(self,data)
		self.data = data
		self:initBase()
		self:createTop()
		self:createMain()
		self.recuited = false
		return self
	end,
	
	reflash = function(self,data)
		self.mainWidget:removeAllChildrenWithCleanup(true)
		self.cfg_general_ids = new({})
		self.fired_cfg_general_ids = new({})
		self.data = data
		self:createMain()
		GlobleZhaoMuFlashed = true
	end,
	
	--创建宠物列表
	createMain = function(self)
		local main = self.mainWidget
		local data = self.data
		self.treat_count = 10--data:getByKey("treat_count"):asInt() + 1
		self.treat_cooldown = data:getByKey("treat_cooldown"):asDouble()
		self.server_time = data:getByKey("server_time"):asDouble()
		self.fame = data:getByKey("fame"):asInt()
		self.lenQueTime = math.abs(math.ceil((self.treat_cooldown - self.server_time)/1000))
		self.general_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_general.json")

		for i = 1,data:getByKey("tavern_epic"):size() do
			self.tavern_epic[i] = data:getByKey("tavern_epic"):getByIndex(i-1):asInt()
		end
		
		self.costMap = new({})
		self.cfg_general_ids = new({})
		self.tavern_epic = new({})

		--宠物
		local tavern_generals = data:getByKey("tavern_generals")
		for i=1,tavern_generals:size() do
			local cfg_general_id = tavern_generals:getByIndex(i-1):getByKey("cfg_general_id"):asInt()
			local cost = tavern_generals:getByIndex(i-1):getByKey("cost"):asInt()
			table.insert(self.cfg_general_ids,cfg_general_id)
			table.insert(self.costMap,cost)
		end
	
		--解雇的
		local fire_generals = data:getByKey("fire_generals")
		for i=1,fire_generals:size() do
			local cfg_general_id = fire_generals:getByIndex(i-1):getByKey("cfg_general_id"):asInt()
			local general_id = fire_generals:getByIndex(i-1):getByKey("general_id"):asInt()
			table.insert(self.fired_cfg_general_ids,{general_id=general_id,cfg_general_id=cfg_general_id})
		end
			
		--创建宠物
		for i=1,4 do
			local num=table.getn(self.cfg_general_ids)
			if i<=num then
				self:createOne(i)
			else
				self:createOne(i,true)
			end
		end

		--查看名宠按钮
		local bigBtn = new(ButtonScale)
		bigBtn:create("UI/zhao_mu/big_btn.png",1.05,ccc3(255,255,255))
		bigBtn.btn:setPosition(CCPoint(792, 137))
		bigBtn.btn:setAnchorPoint(CCPoint(0, 0))
		bigBtn.btn.m_nScriptClickedHandler = function(ccp)
			globalZhaoMuMJPanel(self.fired_cfg_general_ids)
		end
		main:addChild(bigBtn.btn)

		--刷新按钮
		local reflashBtn = new(ButtonScale)
		reflashBtn:create("UI/zhao_mu/reflash.png",1.2,ccc3(255,255,255))
		reflashBtn.btn:setPosition(CCPoint(220+40, 55+27))
		reflashBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		reflashBtn.btn.m_nScriptClickedHandler = function(ccp)
			if self.hasEpic then
				new(ConfirmDialog):show({
					text = "有高级宠物存在，确定要刷新吗？",
					width = 500,
					onClickOk = function()
						self:reflashGeneral()
						self.hasEpic = false
					end
				})
			else
				self:reflashGeneral()
			end
		end
		main:addChild(reflashBtn.btn)
		self.reflashBtn = reflashBtn
		
		if self.treat_cooldown > 0 then
			local cooldown = CCLabelTTF:labelWithString("冷却时间:",CCSize(250,0),0, SYSFONT[EQUIPMENT], 23)
			cooldown:setPosition(CCPoint(350,82))
			cooldown:setAnchorPoint(CCPoint(0, 0))
			cooldown:setColor(ccc3(254,51,0))
			main:addChild(cooldown)
			local cooldown = CCLabelTTF:labelWithString(getLenQueTime(self.lenQueTime),CCSize(150,0),0, SYSFONT[EQUIPMENT], 23)
			cooldown:setPosition(CCPoint(470,82))
			cooldown:setAnchorPoint(CCPoint(0, 0))
			cooldown:setColor(ccc3(255,204,102))
			main:addChild(cooldown)
			local lable = CCLabelTTF:labelWithString("花费 "..self.treat_count.." 金币刷新宠物",CCSize(250,0),0, SYSFONT[EQUIPMENT], 23)
			lable:setPosition(CCPoint(350,60))
			lable:setAnchorPoint(CCPoint(0, 0))
			lable:setColor(ccc3(254,51,0))
			main:addChild(lable)
			self.cooldown = cooldown
			
			self:handleLenQueTime()
		end
	end,
	
	createOne = function(self,i,blank)
		local main = self.mainWidget

		if blank ~= nil then
			local bgPanel = dbUIPanel:panelWithSize(CCSize(173, 446))
			bgPanel:setAnchorPoint(CCPoint(0, 0))
			bgPanel:setPosition(45+(i-1)*186,570-446)
			if i==1 then
				main:addChild(bgPanel,5)
			else
				main:addChild(bgPanel,4)
			end
			local kuang_bg = CCSprite:spriteWithFile("UI/zhao_mu/bg.png")
			kuang_bg:setAnchorPoint(CCPoint(0.5, 0.5))
			kuang_bg:setPosition(CCPoint(173/2, 446/2+30))
			bgPanel:addChild(kuang_bg)
			local bg = CCSprite:spriteWithFile("UI/public/role_bg_kuang.png")
			bg:setAnchorPoint(CCPoint(0, 0))
			bg:setPosition(CCPoint(0, 0))
			bgPanel:addChild(bg)
			return
		end

		local generalId = self.cfg_general_ids[i]
		local da = self.general_cfg:getByKey(generalId)
		local cost = self.costMap[i]

		local name = da:getByKey("name"):asString()
		local quality = da:getByKey("quality"):asInt()
		local nameColor = PLAYER_COLOR[quality]
		if quality >= 4 then
			self.hasEpic = true
		end
		
		local descTX = (da:getByKey("desc"):asString())
		local costTX = cost

		local strengthTX = (da:getByKey("strength"):asInt())
		local intellectTX = (da:getByKey("intellect"):asInt())
		local staminaTX = (da:getByKey("stamina"):asInt())
		local agilityTX = (da:getByKey("agility"):asInt())

		local str_growTX = (da:getByKey("str_grow"):asDouble())
		local int_growTX = (da:getByKey("int_grow"):asDouble())
		local sta_growTX = (da:getByKey("sta_grow"):asDouble())
		local agi_growTX = (da:getByKey("agi_grow"):asDouble())

		local cfg_skill_id_1 = da:getByKey("cfg_skill_id_1"):asInt()
		local cfg_skill_id_2 = da:getByKey("cfg_skill_id_2"):asInt()
		
		local bgPanel = dbUIPanel:panelWithSize(CCSize(173, 446))
		bgPanel:setAnchorPoint(CCPoint(0, 0))
		bgPanel:setPosition(45+(i-1)*186,570-446)
		if i==1 then
			main:addChild(bgPanel,5)
		else
			main:addChild(bgPanel,4)
		end


		local kuang_bg = CCSprite:spriteWithFile("UI/zhao_mu/bg.png")
		kuang_bg:setAnchorPoint(CCPoint(0.5, 0.5))
		kuang_bg:setPosition(CCPoint(173/2, 446/2+30))
		bgPanel:addChild(kuang_bg)
		local bg = CCSprite:spriteWithFile("UI/public/role_bg_kuang.png")
		bg:setAnchorPoint(CCPoint(0, 0))
		bg:setPosition(CCPoint(0, 0))
		bgPanel:addChild(bg)

		local headKuang = CCSprite:spriteWithFile("UI/public/kuang_66_66b.png")
		headKuang:setAnchorPoint(CCPoint(0, 0))
		headKuang:setPosition(CCPoint(12, 446-6-66))
		bgPanel:addChild(headKuang)
		--形象
		local figure = CCSprite:spriteWithFile("head/Middle/head_middle_"..(da:getByKey("face"):asInt())..".png")
		figure:setScale(0.80 * 66/figure:getContentSize().width)
		figure:setPosition(66/2,66/2)
		headKuang:addChild(figure)

		--名字
		local label = CCLabelTTF:labelWithString(da:getByKey("name"):asString(),CCSize(300,0),0, SYSFONT[EQUIPMENT], 21)
		label:setPosition(CCPoint(80,446-18-25))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(nameColor)
		--label:setColor(ccc3(153,205,0))
		bgPanel:addChild(label)

		--等级
		local label = CCLabelTTF:labelWithString("1级",CCSize(150,0),0, SYSFONT[EQUIPMENT], 20)
		label:setPosition(CCPoint(80,446-18-25-30))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(255,204,102))
		bgPanel:addChild(label)

		local createlabel = function(label,value,labelPosition,valuePosition,growValue,growPosition)
			local label = CCLabelTTF:labelWithString(label,CCSize(150,0),0, SYSFONT[EQUIPMENT], 22)
			label:setPosition(labelPosition)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setColor(ccc3(172,130,49))
			bgPanel:addChild(label)
			local label = CCLabelTTF:labelWithString(value,CCSize(150,0),0, SYSFONT[EQUIPMENT], 22)
			label:setPosition(valuePosition)
			label:setAnchorPoint(CCPoint(0, 0))
			label:setColor(ccc3(246,196,49))
			bgPanel:addChild(label)
			
			if growValue and growPosition then
				local label = CCLabelTTF:labelWithString(growValue,CCSize(150,0),0, SYSFONT[EQUIPMENT], 18)
				label:setPosition(growPosition)
				label:setAnchorPoint(CCPoint(0, 0))
				label:setColor(ccc3(153,205,0))
				bgPanel:addChild(label)	
			end
		end

		--系别
		local jobJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_job.json")
		local jobName = jobJsonConfig:getByKey(da:getByKey("job"):asInt()):getByKey("name"):asString()
		createlabel("系别：",jobName,CCPoint(12,335),CCPoint(64,335))
		createlabel("耐力：",staminaTX + math.ceil(sta_growTX),CCPoint(12,335-35*1),CCPoint(64,335-35*1),"成长:"..sta_growTX,CCPoint(100,335-35*1))
		createlabel("力量：",strengthTX + math.ceil(str_growTX),CCPoint(12,335-35*2),CCPoint(64,335-35*2),"成长:"..str_growTX,CCPoint(100,335-35*2))
		createlabel("智力：",intellectTX + math.ceil(int_growTX),CCPoint(12,335-35*3),CCPoint(64,335-35*3),"成长:"..int_growTX,CCPoint(100,335-35*3))
		createlabel("敏捷：",agilityTX + math.ceil(agi_growTX),CCPoint(12,335-35*4),CCPoint(64,335-35*4),"成长:"..agi_growTX,CCPoint(100,335-35*4))
		local skill_json_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_skill.json")
		local skill_name = "无"
		if cfg_skill_id_1 ~= nil and cfg_skill_id_1 > 0 then
			skill_name = skill_json_cfg:getByKey(cfg_skill_id_1):getByKey("name"):asString()
			createlabel("技能：",skill_name,CCPoint(12,335-35*5),CCPoint(64,335-35*5))
		end
		if cfg_skill_id_2 ~= nil and cfg_skill_id_2 > 0 then
			skill_name = skill_json_cfg:getByKey(cfg_skill_id_2):getByKey("name"):asString()
			createlabel("技能：",skill_name,CCPoint(12,335-35*6),CCPoint(64,335-35*6))
		end
		
		local cut = CCSprite:spriteWithFile("UI/zhao_mu/cut.png")
		cut:setPosition(CCPoint(12,335-35*6-16))
		cut:setScaleX(152/54)
		cut:setAnchorPoint(CCPoint(0, 0))
		bgPanel:addChild(cut)

		local label = CCLabelTTF:labelWithString("银币:",CCSize(150,0),0, SYSFONT[EQUIPMENT], 22)
		label:setPosition(CCPoint(12,335-35*7-20+8))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(255,204,102))
		bgPanel:addChild(label)
		local label = CCLabelTTF:labelWithString(costTX.."",CCSize(150,0),0, SYSFONT[EQUIPMENT], 22)
		label:setPosition(CCPoint(70,335-35*7-20+8))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setColor(ccc3(255,153,0))
		bgPanel:addChild(label)

		--领取按钮
		local btn = new(ButtonScale)
		btn:create("UI/zhao_mu/get.png",1.2,ccc3(255,255,255))
		btn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn.btn:setPosition(CCPoint(173/2, 335-35*7-60))
		btn.btn.m_nScriptClickedHandler = function(ccp)
			self:recuit(generalId)
			self.hasEpic = false
		end
		bgPanel:addChild(btn.btn)

		if i==1 then --新手引导时用到
			self.guidBtn = btn.btn
		end
	end,
	
	createTop = function(self)
		local top = self.top
		local data = self.data
		
		local nice = CCSprite:spriteWithFile("UI/zhao_mu/nice.png")
		nice:setPosition(CCPoint(0,8))
		nice:setAnchorPoint(CCPoint(0,0))
		top:addChild(nice)
		--[[屏蔽爱心值	
		local fame = data:getByKey("fame"):asInt()
		local label = CCLabelTTF:labelWithString("爱心值："..fame,CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(280,40))
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setColor(ccc3(254,205,52))   --ccc3(254,205,52)
		self.fameLabel = label
		top:addChild(label)	]]
		
		local numjson = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_level_prestige.json")
		local numoflimit = numjson:getByIndex(GloblePlayerData.officium-1):getByKey("general_amount"):asInt()
		self.count = table.getn(GloblePlayerData.generals)
		self.countLabel = CCLabelTTF:labelWithString("宠物："..(self.count).."/"..numoflimit,CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		self.countLabel:setPosition(CCPoint(280,40))
		self.countLabel:setAnchorPoint(CCPoint(0.5, 0.5))
		self.countLabel:setColor(ccc3(254,205,52))
		top:addChild(self.countLabel)
       
	    --金币数
		local gold = data:getByKey("gold"):asInt()
		local label = CCLabelTTF:labelWithString("金币："..gold,CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(480,40))
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setColor(ccc3(254,205,52))
		self.goldLabel = label
		top:addChild(label)

		--帮助
		local helpBtn = new(ButtonScale)
		helpBtn:create("UI/public/helpred.png",1.2,ccc3(255,255,255))			
		helpBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		helpBtn.btn:setPosition(CCPoint(860, 44))
		helpBtn.btn.m_nScriptClickedHandler = function()
			CreatZhaoMuHelp()
		end
		top:addChild(helpBtn.btn)
		self.helpBtn = helpBtn.btn
				
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 46))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			GotoNextStepGuide()
			self:destroy()
		end
		top:addChild(closeBtn.btn)	
		self.closeBtn = closeBtn.btn	
	end,
		
	--初始化界面
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		self.centerWidget:addChild(self.mainWidget)

		local top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)
		self.top = top
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.top = nil
		self.centerWidget = nil
		self.mainWidget = nil
		self.closeBtn = nil
		self.recuited = false
		self.dialogTipPanel = nil
		GlobleZhaoMuPanel = nil
		GlobleZhaoMuFlashed = false
		if self.timeHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
			self.timeHandle = nil
		end
		removeUnusedTextures()
	end,

	--处理冷却时间
	handleLenQueTime = function(self)
		if self.lenQueTime > 0 then
			self.cooldown:setIsVisible(true)
			local setLenQueTime = function()
				if self.lenQueTime > 0 then
					self.lenQueTime = self.lenQueTime - 1
					self.cooldown:setString(getLenQueTime(self.lenQueTime))
				else
					self.cooldown:setString(getLenQueTime(self.lenQueTime))
					CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
					self.timeHandle = nil
					self.cooldown:setIsVisible(false)
				end
			end
			
			if self.timeHandle == nil then
				self.timeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
			else
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
				self.timeHandle = nil
				self.timeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
			end
		end
	end,
			
	reflashGeneral = function(self,ai_xing)
		local function opRefreshHeroFinishCB(s)
			if s:getByKey("error_code"):asInt() == -1 then
				if self.bgLayer then
					self:reflash(s)
					local numjson = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_level_prestige.json")
					local numoflimit = numjson:getByIndex(GloblePlayerData.officium-1):getByKey("general_amount"):asInt()	
				    self.countLabel:setString("宠物："..(self.count).."/"..numoflimit)
				    
			        self.goldLabel:setString("金币："..s:getByKey("gold"):asInt())
			        self.recuited = false
			    end
	
		        GloblePlayerData.fame = s:getByKey("fame"):asInt()
		        GloblePlayerData.gold = s:getByKey("gold"):asInt()
				GloblePlayerData.copper = s:getByKey("copper"):asInt()
				updataHUDData()
			else
				new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
			end
		end

		local function execRefreshHero()
			NetMgr:registOpLuaFinishedCB(Net.OPT_Treat, opRefreshHeroFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_Treat, opFailedCB)
			local request_code = ClientData.request_code
			if ai_xing~=nil and ai_xing==true then
				request_code = request_code.."_ai_xing"
			end
			
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",request_code)
			cj:setByKey("keed",false)  --- 1:true查看酒馆信息  0:false刷新酒馆
			
			NetMgr:setOpUnique(Net.OPT_Treat)
			NetMgr:executeOperate(Net.OPT_Treat, cj)
		end
		execRefreshHero()
	end,
	
	recuit = function(self,id)
		local function opRecuitHeroFinishCB(s)
			closeWait()
			self.recuited = true
			local createPanel = new(SimpleTipPanel)
			local error_code = s:getByKey("error_code"):asInt()
			if error_code == -1 then
				alert("成功驯服")
				if self.bgLayer then
					self:reflash(s)
					self.count = self.count+1
					
					local numjson = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_level_prestige.json")
					local numoflimit = numjson:getByIndex(GloblePlayerData.officium-1):getByKey("general_amount"):asInt()	
				    self.countLabel:setString("宠物："..(self.count).."/"..numoflimit)
				    
			        --self.fameLabel:setString("爱心值："..s:getByKey("fame"):asInt())
			        self.goldLabel:setString("金币："..s:getByKey("gold"):asInt())
		        end
		        executeGenerals()
		        GloblePlayerData.fame = s:getByKey("fame"):asInt()
		        GloblePlayerData.gold = s:getByKey("gold"):asInt()
				GloblePlayerData.copper = s:getByKey("copper"):asInt()
				updataHUDData()
			else
				ShowErrorInfoDialog(error_code)
			end
			
			if GolbalEventPanel and GolbalEventPanel.event.name == "zhaomu" then
				CloseEvent("zhaomu")
				DispatchEvent("zhenxing")
			end
			GotoNextStepGuide()
		end

		local function execRecuitHero()
			showWaitDialog("")
			NetMgr:registOpLuaFinishedCB(Net.OPT_Recruit, opRecuitHeroFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_Recruit, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("cfg_general_id",id)
			
			NetMgr:setOpUnique(Net.OPT_Recruit)
			NetMgr:executeOperate(Net.OPT_Recruit, cj)
		end
		execRecuitHero()
	end,
}
function CreatZhaoMuHelp()
	local text =
	    "1、宠物的品质从低到高依次为绿、蓝、紫、橙，品质越高的宠物属性及成长越高，技能也更为强力。"..
		"\n2、刷新有概率刷出所有品质的宠物，随神位等级的提升，可刷新出更多的极品宠物。"..
		"\n3、品质为橙色的神宠也可通过勋章来直接兑换。"
	local dialogCfg = new(basicDialogCfg)
	dialogCfg.title = "招募说明"
	dialogCfg.msg = text
	dialogCfg.msgAlign = "left"
	dialogCfg.bg = "UI/baoguoPanel/kuang.png"
	dialogCfg.dialogType = 5
	dialogCfg.msgSize = 30
	dialogCfg.size = CCSize(900, 0);
	local dialog = new(Dialog)
	dialog:create(dialogCfg) 
end

--驯服名宠面板
ZhaoMuMJPanel = {
	data = nil,
	menuToggles = {},
	curPage = 1,
	curJob = 1,
	curSelected = 0,
	curMenuIndex = 1,
	job_generals = {},
	needFlashLeft = true,
	fired_cfg_general_ids = nil,
	amount = 0,
	
	create = function(self,fired_cfg_general_ids)
		self.fired_cfg_general_ids = fired_cfg_general_ids
		self.job_generals = new({})
		self.menuToggles = new({})
		
		self:initEpicGenerals()
		self:initBase()
		self:createMain()
		return self
	end,
	
	reflash = function(self)
		self.mainWidget:removeAllChildrenWithCleanup(true)
		local bg = CCSprite:spriteWithFile("UI/zhao_mu_mj/book_bg.png")
		bg:setPosition(CCPoint(1010/2-36, 702/2-6))
		self.mainWidget:addChild(bg,1)
		self.menuToggles = {}
		self:createMain()
	end,
	
	--创建宠物列表
	createMain = function(self)
		self:createJobMenu()
		self:loadByJob(self.curJob) --默认显示第一种职业的宠物
		self:showIt()
	end,

	--初始化数据
	initEpicGenerals = function(self)
		local general_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_general.json")
		local cfg_general_epic = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_general_epic_array.json")
		local general_epic_info = {} 
		--排序
		for i=1,cfg_general_epic:size() do
			local epic = cfg_general_epic:getByIndex(i-1)
			local info = {
				cfg_general_id = epic:getByKey("cfg_general_id"):asInt(),
				job = epic:getByKey("job"):asInt(),
				idx =  epic:getByKey("idx"):asInt(),
			}
			table.insert(general_epic_info, info)
		end
		table.sort(general_epic_info, function(a, b)
			return a.idx < b.idx
		end)
		--分类
		for i = 1, #general_epic_info do
			local job = general_epic_info[i].job
			if not self.job_generals[""..job] then
				self.job_generals[""..job] = {}
			end
			table.insert(self.job_generals[""..job], general_epic_info[i].cfg_general_id)
		end
	end,
	
	cfg = {
		{normal="zs_1",  toggled="zs_2",   pos=CCPoint(878,510),      jobId=1},
		{normal="ck_1",  toggled="ck_2",   pos=CCPoint(878,510-65),   jobId=2},
		{normal="ws_1",  toggled="ws_2",   pos=CCPoint(878,510-65*2), jobId=3},
		{normal="fs_1",  toggled="fs_2",   pos=CCPoint(878,510-65*3), jobId=4},
	},
				
	--右边职业分类
	createJobMenu = function(self)
		local cfg = self.cfg
		
		--重置职业分类菜单的Z order
		local resetZOrder = function(self,menuToggles)
			for i=1,table.getn(menuToggles) do
				self.mainWidget:reorderChild(menuToggles[i],0)
			end
		end
				
		for i =1,#cfg do
			local normal = CCSprite:spriteWithFile("UI/zhao_mu_mj/"..cfg[i].normal..".png")
			local toggled = CCSprite:spriteWithFile("UI/zhao_mu_mj/"..cfg[i].toggled..".png")
			local menuToggle = dbUIButtonToggle:buttonWithImage(normal,toggled)
			menuToggle:setAnchorPoint(CCPoint(0, 0))
			menuToggle:setPosition(cfg[i].pos)
			menuToggle.m_nScriptClickedHandler = function(ccp)
				resetZOrder(self,self.menuToggles)
				self.mainWidget:reorderChild(menuToggle,2)
				public_toggleRadioBtn(self.menuToggles,menuToggle)
				self.curMenuIndex = i
				self.curPage=1
				self.curJob = cfg[i].jobId
				self:reflash()
			end
			self.mainWidget:addChild(menuToggle,-1)
			self.menuToggles[i] = menuToggle
		end
		
		local curMenu = self.menuToggles[self.curMenuIndex]
		public_toggleRadioBtn(self.menuToggles,curMenu)
		self.mainWidget:reorderChild(curMenu,2)
		--右侧覆盖
		local right_side = CCSprite:spriteWithFile("UI/zhao_mu_mj/right_side.png")
		right_side:setAnchorPoint(CCPoint(0, 0.5))
		right_side:setPosition(CCPoint(864, 702/2+ 8))
		self.mainWidget:addChild(right_side, 3)
	end,
	--加载某个职业的名宠
	loadByJob = function(self,job)
		local job_generals = self.job_generals[""..self.curJob]
		
		if job_generals==nil then
			CCLuaLog("no generals of job "..self.curJob)
			return
		end

		local page = self.curPage
		local startIndex  = page
		local endIndex    = page
		local count = table.getn(job_generals)
		local pageCount = count--math.floor(count/6)

		if count < endIndex then
			endIndex = count
		end
		
		local general_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_general.json")
		for i =startIndex,endIndex do
			local generalId = job_generals[i]
			local da = general_cfg:getByKey(generalId)

			local name = da:getByKey("name"):asString()
			
			local kuang = dbUIPanel:panelWithSize(CCSize(250,250))
			kuang:setPosition(497,250)
			kuang:setAnchorPoint(CCPoint(0, 0))
			self.mainWidget:addChild(kuang,2)
						
			--标记是否已驯服
			local own = false
			for i = 1,table.getn(GloblePlayerData.generals) do
				if generalId == GloblePlayerData.generals[i].cfg_general_id then
					own = true
					break
				end
			end
			
			local btn = new(ButtonScale)
			btn:create("head/MonsterFull/head_full_"..(da:getByKey("face"):asInt())..".png",1.2,ccc3(255,255,255))	
			btn.btn:setPosition(250/2+20,250/2)
			btn.btn.m_nScriptClickedHandler = function(ccp)
				self.curSelected = generalId
				self.needFlashLeft = false
				self.own = own
				self:reflash()
			end
			kuang:addChild(btn.btn)
         
			if own then
				local own = CCSprite:spriteWithFile("UI/zhao_mu_mj/own.png")
				own:setPosition(0,96)
				own:setAnchorPoint(CCPoint(0.5, 0.5))
				kuang:addChild(own)			
			end
			
			--名字
			local nameKuang = dbUIPanel:panelWithSize(CCSize(96, 30))
			nameKuang:setPosition(CCPoint(497,510))
			nameKuang:setAnchorPoint(CCPoint(0, 0))
			self.mainWidget:addChild(nameKuang,2)
			local label = CCLabelTTF:labelWithString(name,CCSize(0,0),0, SYSFONT[EQUIPMENT], 26)
			label:setPosition(CCPoint(96/2,30/2))
			label:setAnchorPoint(CCPoint(0.5, 0.5))
			label:setColor(ccc3(101,51,0))
			nameKuang:addChild(label)
		end
		
		--前一页
		local prevBtn = new(ButtonScale)
		prevBtn:create("UI/zhao_mu_mj/to_left.png",1.2)
		prevBtn.btn:setPosition(580, 190)
		prevBtn.btn:setIsEnabled(page>1)
		prevBtn.btn.m_nScriptClickedHandler = function(ccp)
			self.curPage = page-1
			self.needFlashLeft = true
			self:reflash()
		end
		self.mainWidget:addChild(prevBtn.btn,2)

		--页数
		local labelKuang = dbUIPanel:panelWithSize(CCSize(70, 30))
		labelKuang:setPosition(CCPoint(660,190))
		labelKuang:setAnchorPoint(CCPoint(0.5, 0.5))
		local label = CCLabelTTF:labelWithString(page.."/"..pageCount,CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)
		label:setPosition(CCPoint(70/2,30/2))
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setColor(ccc3(101,51,0))
		labelKuang:addChild(label)
		self.mainWidget:addChild(labelKuang,2)
		
		--后一页
		local nextBtn = new(ButtonScale)
		nextBtn:create("UI/zhao_mu_mj/to_right.png",1.2)
		nextBtn.btn:setPosition(750, 190)
		nextBtn.btn:setIsEnabled(count>endIndex)
		nextBtn.btn.m_nScriptClickedHandler = function(ccp)
			self.curPage = page+1
			self.needFlashLeft = true
			self:reflash()
		end
		self.mainWidget:addChild(nextBtn.btn,2)
		
		if self.needFlashLeft then
			self.curSelected = job_generals[startIndex]
		end
	end,
	
	--显示宠物详细信息
	showIt = function(self)
		if self.curSelected==nil or self.curSelected==0 then
			return
		end
		
		local generalId = self.curSelected
		local general_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_general.json")
		local cfg_general_epic = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_general_epic.json")
		local skill_json_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_skill.json")
		local jobJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_job.json")
		
		local fame_require_amount = cfg_general_epic:getByKey(generalId):getByKey("fame_require_amount"):asInt()
		local fame_require_officium = cfg_general_epic:getByKey(generalId):getByKey("fame_require_officium"):asInt()
		local tally_amount = cfg_general_epic:getByKey(generalId):getByKey("tally_amount"):asInt()
		local tally_type = cfg_general_epic:getByKey(generalId):getByKey("tally_type"):asInt()
		local da = general_cfg:getByKey(generalId)
		
		local name = da:getByKey("name"):asString()
		local descTX = (da:getByKey("desc"):asString())
		local costTX = (da:getByKey("cost"):asInt())

		local strengthTX = (da:getByKey("strength"):asInt())
		local intellectTX = (da:getByKey("intellect"):asInt())
		local staminaTX = (da:getByKey("stamina"):asInt())
		local agilityTX = (da:getByKey("agility"):asInt())

		local str_growTX = (da:getByKey("str_grow"):asDouble())
		local int_growTX = (da:getByKey("int_grow"):asDouble())
		local sta_growTX = (da:getByKey("sta_grow"):asDouble())
		local agi_growTX = (da:getByKey("agi_grow"):asDouble())
		
		local cfg_skill_id_1 = da:getByKey("cfg_skill_id_1"):asInt()
		local cfg_skill_id_2 = da:getByKey("cfg_skill_id_2"):asInt()
		
		local skill_name = "无"
		--alert("技能asdadsad"..cfg_skill_id)
		if cfg_skill_id_1~=nil and cfg_skill_id_1>0 then
		    
			skill_name = skill_json_cfg:getByKey(cfg_skill_id_1):getByKey("name"):asString()
		end
		if cfg_skill_id_2~=nil and cfg_skill_id_2>0 then
		    
			skill_name = skill_json_cfg:getByKey(cfg_skill_id_2):getByKey("name"):asString()
		end
		local jobName = jobJsonConfig:getByKey(da:getByKey("job"):asInt()):getByKey("name"):asString()
		
		--头像
		local kuang = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
		kuang:setPosition(128,470)
		kuang:setAnchorPoint(CCPoint(0, 0))
		self.mainWidget:addChild(kuang,2)
	
		local figure = CCSprite:spriteWithFile("head/Middle/head_middle_"..(da:getByKey("face"):asInt())..".png")
		figure:setScale(0.80 * 96/figure:getContentSize().width)
		figure:setPosition(96/2,96/2)
		kuang:addChild(figure)
		
		--名字
		local labelKuang = dbUIPanel:panelWithSize(CCSize(150, 30))
		labelKuang:setPosition(CCPoint(230,525))
		labelKuang:setAnchorPoint(CCPoint(0, 0))
		self.mainWidget:addChild(labelKuang,2)
		local label = CCLabelTTF:labelWithString(name,CCSize(0,0),0, SYSFONT[EQUIPMENT], 26)
		label:setPosition(CCPoint(150/2,30/2))
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setColor(ccc3(101,51,0))
		labelKuang:addChild(label)

		--职业 
		local labelKuang = dbUIPanel:panelWithSize(CCSize(150, 30))
		labelKuang:setPosition(CCPoint(230,490))
		labelKuang:setAnchorPoint(CCPoint(0, 0))
		self.mainWidget:addChild(labelKuang,2)
		local label = CCLabelTTF:labelWithString(jobName,CCSize(0,0),0, SYSFONT[EQUIPMENT], 26)
		label:setPosition(CCPoint(150/2,30/2))
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setColor(ccc3(101,51,0))
		labelKuang:addChild(label)
		
		local createLabel = function(text,width,height,position,size,color,grow)
			local labelKuang = dbUIPanel:panelWithSize(CCSize(250, 30))
			labelKuang:setPosition(position)
			labelKuang:setAnchorPoint(CCPoint(0, 0.5))
			
			local label = CCLabelTTF:labelWithString(text,CCSize(width,0),0, SYSFONT[EQUIPMENT], size)
			label:setPosition(CCPoint(0,30/2))
			label:setAnchorPoint(CCPoint(0, 0.5))
			label:setColor(color)
			labelKuang:addChild(label)
			
			if grow then
				local label = CCLabelTTF:labelWithString("成长系数："..grow,CCSize(200,0),0, SYSFONT[EQUIPMENT], 22)
				label:setPosition(CCPoint(120,30/2))
				label:setAnchorPoint(CCPoint(0, 0.5))
				label:setColor(ccc3(153,205,0))
				labelKuang:addChild(label)			
			end
			return labelKuang
		end
		if cfg_skill_id_2~=nil and cfg_skill_id_2>0 then
		local label = createLabel("绝技："..skill_name,400,30,CCPoint(120,440),24,ccc3(101,51,0))
		self.mainWidget:addChild(label,2)
		end
		local label = createLabel("绝技："..skill_name,400,30,CCPoint(120,440-30*1),24,ccc3(101,51,0))
		self.mainWidget:addChild(label,2)
	
		local label = createLabel("耐力："..(staminaTX),250,30,CCPoint(120,440-30*2),24,ccc3(101,51,0),sta_growTX)
		self.mainWidget:addChild(label,2)

		local label = createLabel("力量："..(strengthTX),250,30,CCPoint(120,440-30*3),24,ccc3(101,51,0),str_growTX)
		self.mainWidget:addChild(label,2)

		local label = createLabel("智力："..(intellectTX),250,30,CCPoint(120,440-30*4),24,ccc3(101,51,0),int_growTX)
		self.mainWidget:addChild(label,2)
		
		local label = createLabel("敏捷："..(agilityTX),250,30,CCPoint(120,440-30*5),24,ccc3(101,51,0),agi_growTX)
		self.mainWidget:addChild(label,2)
		
		--解雇列表,解雇的只用银币就能再召回
		local isFired = false
		local mem_general_id = 0
		for i = 1,table.getn(self.fired_cfg_general_ids) do
			if generalId == self.fired_cfg_general_ids[i].cfg_general_id then
				isFired = true
				mem_general_id = self.fired_cfg_general_ids[i].general_id
				break;
			end
		end	
				
		local label = createLabel("驯服条件:",250,30,CCPoint(120,440-30*6),24,ccc3(101,51,0))
		self.mainWidget:addChild(label,2)
		
		if generalId==10000 then --灵狐仙儿
			local label = createLabel("首次充值后使用 灵狐宠物蛋 即可获得",180,90,CCPoint(240,225),24,ccc3(101,51,0))
			self.mainWidget:addChild(label,2)
		elseif generalId==1144004 then --精英龙
			local label = createLabel("第一次连续七天登录 即可获得该宠物蛋",180,90,CCPoint(240,225),24,ccc3(101,51,0))
			self.mainWidget:addChild(label,2)
		else
			if isFired then
				local label = createLabel("您已经驯服过它了，\n花50000银币召回 ",350,30,CCPoint(240,440-30*7),24,ccc3(101,51,0))
				self.mainWidget:addChild(label,2)			
			else
				local bf = GloblePlayerData.bingfu[1]
				self.amount = (bf==nil or bf.amount==nil) and 0 or bf.amount
				local label = createLabel("勋章 "..self.amount.."/"..tally_amount,350,30,CCPoint(240,440-30*6),24,ccc3(101,51,0))
				self.mainWidget:addChild(label,2)

				local label = createLabel("神位要求： "..fame_require_officium,350,30,CCPoint(240,440-30*7),24,ccc3(101,51,0))
				self.mainWidget:addChild(label,2)	
			end
		end
		
		--标记是否已驯服
		local own = false
		for i = 1,table.getn(GloblePlayerData.generals) do
			if  generalId == GloblePlayerData.generals[i].cfg_general_id then
				own = true
				break
			end
		end
		
		--领取按钮
		local amount = self.amount
		
		local canGet = (amount >= tally_amount and not own and GloblePlayerData.officium>=fame_require_officium)
		if generalId == 10000 and ClientData.total_charge<=0 then --灵狐仙儿
			canGet = false
		end
				
		if isFired then
			canGet = true
		end
		
		local img = (canGet==true) and "UI/zhao_mu_mj/xunf_1.png" or "UI/zhao_mu_mj/xunf_2.png"
		if isFired then
			img = "UI/zhao_mu_mj/zao_hui.png"
		end
			
		local btn = new(ButtonScale)
		btn:create(img,1.2,ccc3(255,255,255))			
		btn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn.btn:setPosition(CCPoint(240, 140))
		btn.btn:setIsEnabled(canGet)
		btn.btn.m_nScriptClickedHandler = function(ccp)
			if isFired then
				self:recall(mem_general_id)
			else
				self:exchangeHero(generalId)
			end
		end
		self.mainWidget:addChild(btn.btn,2)
	end,
		
	--初始化界面
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/zhao_mu_mj/bg.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg,-1)

		local bg = CCSprite:spriteWithFile("UI/zhao_mu_mj/book_bg.png")
		bg:setPosition(CCPoint(1010/2-36, 702/2-6))
		self.mainWidget:addChild(bg,1)
		
		self.centerWidget:addChild(self.mainWidget,2)

		local top = dbUIPanel:panelWithSize(CCSize(1010, 106))
		top:setAnchorPoint(CCPoint(0, 0))
		top:setPosition(CCPoint(0,598))
		self.centerWidget:addChild(top)
		self.top = top
		
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952+10, 46+10))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		top:addChild(closeBtn.btn)			
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.top = nil
		self.centerWidget = nil
		self.mainWidget = nil
		
		self.menuToggles = {}
		self.curPage = 1
		self.curJob = 1
		self.curSelected = 0
		self.curMenuIndex = 1
		self.job_generals = {}
		self.needFlashLeft = true
		removeUnusedTextures()
	end,
	
	exchangeHero = function(self,id)
		local function opExchangeHeroFinishCB(s)
			if s:getByKey("error_code"):asInt() == -1 then
				alert("成功驯服")
				executeGenerals()
				
		       	mappedItemData(s)
		        updateSpecialItemData()
		        
		        GloblePlayerData.fame = s:getByKey("fame"):asInt()
		        GloblePlayerData.gold = s:getByKey("gold"):asInt()
				GloblePlayerData.copper = s:getByKey("copper"):asInt()
				updataHUDData()
		        
		        if self.bgLayer then
					self:reflash()
		        end
			else
				new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end
		end

		local function execExchangeHero()
			NetMgr:registOpLuaFinishedCB(Net.OPT_Exchange, opExchangeHeroFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_Exchange, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("cfg_general_id",id)
			
			NetMgr:setOpUnique(Net.OPT_Exchange)
			NetMgr:executeOperate(Net.OPT_Exchange, cj)
		end
		execExchangeHero()
	end,
	
	recall = function(self,id)
		local function opFinishCB(s)
			if s:getByKey("error_code"):asInt() == -1 then
				alert("成功召回")
				mappedPlayerGeneralData(s)
				GloblePlayerData.fame = s:getByKey("fame"):asInt()
		        GloblePlayerData.gold = s:getByKey("gold"):asInt()
				GloblePlayerData.copper = s:getByKey("copper"):asInt()
				updataHUDData()	
				
				if self.bgLayer then	
					for i=1,table.getn(self.fired_cfg_general_ids) do
						if self.fired_cfg_general_ids[i].general_id==id then
							self.fired_cfg_general_ids[i]={}
						end
					end
					self:destroy()
				end
			else
				new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end
		end

		local function execRecall()
			NetMgr:registOpLuaFinishedCB(Net.OPT_Recall, opFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_Recall, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("cfg_general_id",id)
			
			NetMgr:setOpUnique(Net.OPT_Recall)
			NetMgr:executeOperate(Net.OPT_Recall, cj)
		end
		execRecall()
	end,	
}

function globalZhaoMuMJPanel(fired_cfg_general_ids)
	new(ZhaoMuMJPanel):create(fired_cfg_general_ids)
end

function globalZhaoMuMJPanel2(cpp,fired_cfg_general_ids)
	new(ZhaoMuMJPanel):create(fired_cfg_general_ids)
end
--聊天面板
ChatPanel = {
	chatLayer = nil,
	--chatP = nil,
	radios = nil,
	radiosState = nil, ---- 1:all 2:world 3:NATION  4:JUNTUAN 5friends
	inputText = nil,
	sendBtn = nil,
	centerlayer = nil,
	--contentMsgTx = nil,

	channelType = nil, ---1:world 2:NATION 3:JUNTUAN

	--worldBtn = nil,
	--NATIONBtn = nil,
	--JUNTUANBtn = nil,
	--channelBtn = nil,
	scrollList = nil,
	scrollListCount = nil,
	--返回chatlayer
	create = function(self,parent)
		self.radios = new({})
		self.radiosState = new({})
		self.channelBtn = new({})

		self.channelType = 1
		self.scrollListCount = 0
		self.chatLayer = parent--dbUILayer:node()

		--创建可见大背景、位于chatlayer中间
		local myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(70,70))
		myBG:setBGSize(CCSizeMake(1004,748))
		myBG:setAnchorPoint(CCPoint(0.5,0.5))
		myBG:createCeil("UI/public/bg_light.png")
		myBG:setPosition(512-6 ,384-33)
		self.chatLayer:addChild(myBG)
		--关闭按钮
		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png", 1.2,ccc3(0,255,255))
		closeBtn:setAnchorPoint(CCPoint(0.5,0.5))
		closeBtn:setPosition(CCPoint(1024-6-60,768 - 33-70))
		closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
			--GlobleChatMainPanel:setVisible(false)
			FirstOpenChatPanel = true
		end
		self.chatLayer:addChild(closeBtn)
		--LOGO
--		local logo=CCSprite:spriteWithFile("UI/chat/chat_logo.png")
--		logo:setAnchorPoint(CCPoint(0,1))
--		logo:setPosition(CCPoint(0,768-60))
--		self.chatLayer:addChild(logo)
		--创建透明centerlayer、与大背景的内嵌框重叠
		self.centerlayer = dbUIPanel:panelWithSize(CCSizeMake(950,570))
		self.centerlayer:setAnchorPoint(CCPoint(0.5,0.5))
		self.centerlayer:setPosition(CCPoint(512-6,384-33-52))
		self.chatLayer:addChild(self.centerlayer)
		local tConfig = {
			{
				normal = "UI/chat/all_normal_btn.png",
				select = "UI/chat/all_select_btn.png",
			},
			--[[{
				normal = "UI/chat/zhenying_normal_btn.png",
				select = "UI/chat/zhenying_select_btn.png",
			},
			--]]
			{
				normal = "UI/chat/jiazu_normal_btn.png",
				select = "UI/chat/jiazu_select_btn.png",
			},
			{
				normal = "UI/chat/friend_normal_btn.png",
				select = "UI/chat/friend_select_btn.png",
			},

		}
		--聊天单选按钮
		for i = 1,1 do
			self.radios[i] = dbUIButtonToggle:buttonWithImage(tConfig[i].normal,tConfig[i].select)
			--self.radios[i]:toggled(true)
			--self.radiosState[i] = true]
			self.radiosState[i] = false
			self.radios[i].m_nScriptClickedHandler = function()

				--if self.radios[i]:isToggled() then
				--self.radiosState[i] = true
				--else
				--self.radiosState[i] = false
				--end
				if i == 1 then
					--		self.channelBtn[1]:setIsVisible(true)
					--		self.channelBtn[2]:setIsVisible(false)
					--		self.channelBtn[3]:setIsVisible(false)
					self.channelType = 1
				elseif i == 2 then
					--		self.channelBtn[1]:setIsVisible(false)
					--		self.channelBtn[2]:setIsVisible(true)
					--		self.channelBtn[3]:setIsVisible(false)
					self.channelType = 2
				elseif i == 3 then
					--		self.channelBtn[1]:setIsVisible(false)
					--		self.channelBtn[2]:setIsVisible(false)
					--		self.channelBtn[3]:setIsVisible(true)
					self.channelType = 3
				end

				public_toggleRadioBtn(self.radios,self.radios[i])
				--屏蔽好友
				--[[
				if i==4 then
					self.centerlayer:removeAllChildrenWithCleanup(true)
					globle_Create_Friend()				--创建好友聊天
				else
				]]--
					self.centerlayer:removeAllChildrenWithCleanup(true)
					self:createChat()
					self:setRadiosState(i)
					self:addChatContent()
				--end
			end
			self.radios[i]:setPosition(CCPoint(i*145 + 160-240, 384 + 245))
			self.chatLayer:addChild(self.radios[i])

		end
		--默认选中第一个按钮“世界”
		public_toggleRadioBtn(self.radios,self.radios[1])
		self.radiosState[1] = true
		--创建公用聊天
		self:createChat()
		if GlobalChatData ~= nil then
			self:addChatContent()
		end

		return self.centerlayer
	end,
	createChat=function(self)
		--创建聊天滑动区背景
		local myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(70,70))
		myBG:setBGSize(CCSizeMake(925,510))
		myBG:setAnchorPoint(CCPoint(0.5,0.5))
		myBG:createCeil("UI/public/kuang_xiao_mi_shu.png")
		myBG:setPosition(CCPoint(self.centerlayer:getContentSize().width/2,self.centerlayer:getContentSize().height/2+48))
		self.centerlayer:addChild(myBG)

		--创建聊天滑动区
		--------------------------------------------
		self.scrollList = dbUIList:list(CCRectMake(20, 95, 925, 488),0)
		self.centerlayer:addChild(self.scrollList)

		-----------------------------------------
        inputlayer=dbUILayer:node()
        inputlayer:setPosition(0,0)
    
        self.centerlayer:addChild(inputlayer,12000)
		--发送消息按钮
		self.sendBtn = dbUIButtonScale:buttonWithImage("UI/chat/chat_btn.png", 1, ccc3(125, 125, 125))
		self.sendBtn:setAnchorPoint(CCPoint(0.5,0.5))
		self.sendBtn:setPosition(CCPoint(866,40))
		self.sendBtn.m_nScriptClickedHandler = function()
			if GlobalChatData == nil then
				return
			end
			self:sendChatContent()
		end
		inputlayer:addChild(self.sendBtn)
		------------------文本输入框-------
		myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(10,10))
		myBG:setBGSize(CCSizeMake(770,60))
		myBG:setAnchorPoint(CCPoint(0,0))
		myBG:createCeil("UI/public/kuang_xiao_mi_shu.png")
		myBG:setPosition(CCPoint(10,5))
		inputlayer:addChild(myBG)

		self.inputText = dbUIWidgetInput:inputWithText("","Thonburi", 35,false,100,CCRectMake(14, 12,765,60))
		self.inputText:setNeedFocus(true)
		inputlayer:addChild(self.inputText,1000)

		self.inputText.m_ScriptKeyboardDidShow = function()
        inputlayer:runAction(CCMoveTo:actionWithDuration(0.1,CCPoint(0,350)))
		end
		self.inputText.m_ScriptKeyboardDidHide = function()
        inputlayer:runAction(CCMoveTo:actionWithDuration(0.1,CCPoint(0,0)))
		end
	end,
	setRadiosState = function(self,index)
		for i = 1,4 do
			self.radiosState[i] = false
		end
		self.radiosState[index] = true
	end,

	addSingleContent = function(self,len)
		if GlobalChatData == nil then
			return
		end

		for i = table.getn(GlobalChatData.content) - len +1 ,table.getn(GlobalChatData.content) do

			local channelTypeTXT = nil
			local col = nil
			local contentMsgTx = nil
			local channelTypeTX = nil
			local cell = nil
			----1:all 2:world 3:NATION 4:JUNTUAN 5:info
			if GlobalChatData.content[i] == nil then
				return
			end
			if GlobalChatData.channel[i] == 0 and self.radiosState[1] == true then
				channelTypeTXT = GONGGAO_TXT
				cell = dbUIWidget:widgetWithImage("UI/nothing.png")

				channelTypeTX = CCLabelTTF:labelWithString("["..(channelTypeTXT).."] ", SYSFONT[EQUIPMENT], 26)
				col = ccc3(255,66,0)
				channelTypeTX:setAnchorPoint(CCPoint(0, 1))
				channelTypeTX:setColor(col)

				col = ccc3(255,253,166)
				contentMsgTx = CCLabelTTF:labelWithString((GlobalChatData.content[i]), CCSizeMake(680,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 26)
				contentMsgTx:setAnchorPoint(CCPoint(0, 0))
				contentMsgTx:setPosition(CCPoint(100, 0))
				contentMsgTx:setColor(col)


				cell:setContentSize(CCSizeMake(750,contentMsgTx:getContentSize().height))
				cell:addChild(contentMsgTx)
				cell:addChild(channelTypeTX)

				channelTypeTX:setPosition(CCPoint(0, contentMsgTx:getContentSize().height))

				self.scrollList:insterWidget(cell)
			elseif GlobalChatData.channel[i] == 2 and self.radiosState[1] == true  then --world
				channelTypeTXT = WORLD_TXT
				cell = dbUIWidget:widgetWithImage("UI/nothing.png")

				channelTypeTX = CCLabelTTF:labelWithString("["..(channelTypeTXT).."] ", SYSFONT[EQUIPMENT], 26)
				col = ccc3(150,255,92)
				channelTypeTX:setAnchorPoint(CCPoint(0, 1))
				channelTypeTX:setColor(col)

				local theText = nil
				if GlobalChatData.identity[i] == 0 then
					theText = GlobalChatData.name[i]..":  "..GlobalChatData.content[i]
					col = ccc3(255,253,166)
				elseif GlobalChatData.identity[i] == 1 then
					theText = GlobalChatData.name[i].."("..ZHIDAOYUAN.."):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				elseif GlobalChatData.identity[i] == 2 then
					theText = GlobalChatData.name[i].."(GM):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				end

				contentMsgTx = CCLabelTTF:labelWithString(theText, CCSizeMake(670,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 26)
				contentMsgTx:setAnchorPoint(CCPoint(0, 0))
				contentMsgTx:setPosition(CCPoint(100, 0))
				contentMsgTx:setColor(col)


				cell:setContentSize(CCSizeMake(750,contentMsgTx:getContentSize().height))

				cell:addChild(channelTypeTX)
				cell:addChild(contentMsgTx)

				channelTypeTX:setPosition(CCPoint(0, contentMsgTx:getContentSize().height))

				self.scrollList:insterWidget(cell)
			elseif (GlobalChatData.channel[i] == 3 and self.radiosState[2] == true ) or (GlobalChatData.channel[i] == 3 and self.radiosState[1] == true ) then
				channelTypeTXT = NATION_TXT
				cell = dbUIWidget:widgetWithImage("UI/nothing.png")

				channelTypeTX = CCLabelTTF:labelWithString("["..(channelTypeTXT).."] ", SYSFONT[EQUIPMENT], 26)
				col = ccc3(40 ,172 ,255)
				channelTypeTX:setAnchorPoint(CCPoint(0,1))
				channelTypeTX:setColor(col)

				local theText = nil
				if GlobalChatData.identity[i] == 0 then
					theText = GlobalChatData.name[i]..":  "..GlobalChatData.content[i]
					col = ccc3(255,253,166)
				elseif GlobalChatData.identity[i] == 1 then
					theText = GlobalChatData.name[i].."("..ZHIDAOYUAN.."):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				elseif GlobalChatData.identity[i] == 2 then
					theText = GlobalChatData.name[i].."(GM):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				end
				contentMsgTx = CCLabelTTF:labelWithString(theText, CCSizeMake(680,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 26)
				contentMsgTx:setAnchorPoint(CCPoint(0, 0))
				contentMsgTx:setPosition(CCPoint(100, 0))
				contentMsgTx:setColor(col)


				cell:setContentSize(CCSizeMake(750,contentMsgTx:getContentSize().height))

				cell:addChild(channelTypeTX)
				cell:addChild(contentMsgTx)

				channelTypeTX:setPosition(CCPoint(0, contentMsgTx:getContentSize().height))

				self.scrollList:insterWidget(cell)

			elseif (GlobalChatData.channel[i] == 4 and self.radiosState[3] == true ) or (GlobalChatData.channel[i] == 4 and self.radiosState[1] == true ) then
				channelTypeTXT = JUNTUAN_TXT
				cell = dbUIWidget:widgetWithImage("UI/nothing.png")

				channelTypeTX = CCLabelTTF:labelWithString("["..(channelTypeTXT).."] ", SYSFONT[EQUIPMENT], 26)
				col = ccc3(254,128,17)
				channelTypeTX:setAnchorPoint(CCPoint(0,1))
				channelTypeTX:setColor(col)

				local theText = nil
				if GlobalChatData.identity[i] == 0 then
					theText = GlobalChatData.name[i]..":  "..GlobalChatData.content[i]
					col = ccc3(255,253,166)
				elseif GlobalChatData.identity[i] == 1 then
					theText = GlobalChatData.name[i].."("..ZHIDAOYUAN.."):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				elseif GlobalChatData.identity[i] == 2 then
					theText = GlobalChatData.name[i].."(GM):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				end
				contentMsgTx = CCLabelTTF:labelWithString(theText, CCSizeMake(680,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 26)
				contentMsgTx:setAnchorPoint(CCPoint(0, 0))
				contentMsgTx:setPosition(CCPoint(100, 0))
				contentMsgTx:setColor(col)


				cell:setContentSize(CCSizeMake(750,contentMsgTx:getContentSize().height))

				cell:addChild(channelTypeTX)
				cell:addChild(contentMsgTx)

				channelTypeTX:setPosition(CCPoint(0, contentMsgTx:getContentSize().height))

				self.scrollList:insterWidget(cell)
			end
			self.scrollListCount = self.scrollListCount  + 1
			if self.scrollListCount > 30 then
				self.scrollList:removeWidgetAtIndex(0,true)
			end

		end
		self.scrollList:m_setPosition(CCPoint(0,0))
	end,

	addChatContent = function(self)

		if GlobalChatData == nil then
			return
		end

		self.scrollList:removeAllWidget(true)
		self.scrollListCount = 0

		for i = GlobalDel ,table.getn(GlobalChatData.content) do
			local channelTypeTXT = nil
			local col = nil
			local contentMsgTx = nil
			local channelTypeTX = nil
			local cell = nil

			if GlobalChatData.channel[i] == 0 and self.radiosState[1] == true then
				channelTypeTXT = GONGGAO_TXT
				cell = dbUIWidget:widgetWithImage("UI/nothing.png")

				channelTypeTX = CCLabelTTF:labelWithString("["..(channelTypeTXT).."] ", SYSFONT[EQUIPMENT], 26)
				col = ccc3(255,66,0)
				channelTypeTX:setAnchorPoint(CCPoint(0,1))
				channelTypeTX:setColor(col)

				col = ccc3(255,253,166)
				contentMsgTx = CCLabelTTF:labelWithString((GlobalChatData.content[i]), CCSizeMake(800,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 26)
				contentMsgTx:setAnchorPoint(CCPoint(0, 0))
				contentMsgTx:setPosition(CCPoint(100, 0))
				contentMsgTx:setColor(col)


				cell:setContentSize(CCSizeMake(750,contentMsgTx:getContentSize().height))
				cell:addChild(contentMsgTx)
				cell:addChild(channelTypeTX)

				channelTypeTX:setPosition(CCPoint(0, contentMsgTx:getContentSize().height))

				self.scrollList:insterWidget(cell)
			elseif GlobalChatData.channel[i] == 2 and self.radiosState[1] == true  then --world

				channelTypeTXT = WORLD_TXT
				cell = dbUIWidget:widgetWithImage("UI/nothing.png")

				col = ccc3(150,255,92)
				channelTypeTX = CCLabelTTF:labelWithString("["..(channelTypeTXT).."] ", SYSFONT[EQUIPMENT], 26)
				channelTypeTX:setAnchorPoint(CCPoint(0, 1))
				channelTypeTX:setColor(col)

				local theText = nil
				if GlobalChatData.identity[i] == 0 then
					theText = GlobalChatData.name[i]..":  "..GlobalChatData.content[i]
					col = ccc3(255,253,166)
				elseif GlobalChatData.identity[i] == 1 then
					theText = GlobalChatData.name[i].."("..ZHIDAOYUAN.."):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				elseif GlobalChatData.identity[i] == 2 then
					theText = GlobalChatData.name[i].."(GM):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				end
				contentMsgTx = CCLabelTTF:labelWithString(theText, CCSizeMake(670,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 26)
				contentMsgTx:setAnchorPoint(CCPoint(0, 0))
				contentMsgTx:setPosition(CCPoint(100, 0))
				contentMsgTx:setColor(col)


				cell:setContentSize(CCSizeMake(750,contentMsgTx:getContentSize().height))

				cell:addChild(channelTypeTX)
				cell:addChild(contentMsgTx)

				channelTypeTX:setPosition(CCPoint(0, contentMsgTx:getContentSize().height))

				self.scrollList:insterWidget(cell)
			elseif (GlobalChatData.channel[i] == 3 and self.radiosState[2] == true ) or (GlobalChatData.channel[i] == 3 and self.radiosState[1] == true ) then
				channelTypeTXT = NATION_TXT
				cell = dbUIWidget:widgetWithImage("UI/nothing.png")

				channelTypeTX = CCLabelTTF:labelWithString("["..(channelTypeTXT).."] ", SYSFONT[EQUIPMENT], 26)
				col = ccc3(40 ,172 ,255)
				channelTypeTX:setAnchorPoint(CCPoint(0, 1))
				channelTypeTX:setColor(col)

				local theText = nil
				if GlobalChatData.identity[i] == 0 then
					theText = GlobalChatData.name[i]..":  "..GlobalChatData.content[i]
					col = ccc3(255,253,166)
				elseif GlobalChatData.identity[i] == 1 then
					theText = GlobalChatData.name[i].."("..ZHIDAOYUAN.."):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				elseif GlobalChatData.identity[i] == 2 then
					theText = GlobalChatData.name[i].."(GM):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				end
				contentMsgTx = CCLabelTTF:labelWithString(theText, CCSizeMake(680,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 26)
				contentMsgTx:setAnchorPoint(CCPoint(0, 0))
				contentMsgTx:setPosition(CCPoint(100, 0))
				contentMsgTx:setColor(col)


				cell:setContentSize(CCSizeMake(750,contentMsgTx:getContentSize().height))
				cell:addChild(channelTypeTX)
				cell:addChild(contentMsgTx)

				channelTypeTX:setPosition(CCPoint(0, contentMsgTx:getContentSize().height))

				self.scrollList:insterWidget(cell)

			elseif (GlobalChatData.channel[i] == 4 and self.radiosState[3] == true ) or (GlobalChatData.channel[i] == 4 and self.radiosState[1] == true ) then
				channelTypeTXT = JUNTUAN_TXT
				cell = dbUIWidget:widgetWithImage("UI/nothing.png")

				channelTypeTX = CCLabelTTF:labelWithString("["..(channelTypeTXT).."] ", SYSFONT[EQUIPMENT], 26)
				col = ccc3(254,128,17)
				channelTypeTX:setAnchorPoint(CCPoint(0, 1))
				channelTypeTX:setColor(col)

				local theText = nil
				if GlobalChatData.identity[i] == 0 then
					theText = GlobalChatData.name[i]..":  "..GlobalChatData.content[i]
					col = ccc3(255,253,166)
				elseif GlobalChatData.identity[i] == 1 then
					theText = GlobalChatData.name[i].."("..ZHIDAOYUAN.."):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				elseif GlobalChatData.identity[i] == 2 then
					theText = GlobalChatData.name[i].."(GM):  "..GlobalChatData.content[i]
					col = ccc3(255,66,0)
				end
				contentMsgTx = CCLabelTTF:labelWithString(theText, CCSizeMake(680,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 26)
				contentMsgTx:setAnchorPoint(CCPoint(0, 0))
				contentMsgTx:setPosition(CCPoint(100, 0))
				contentMsgTx:setColor(col)

				cell:setContentSize(CCSizeMake(750,contentMsgTx:getContentSize().height))
				cell:addChild(channelTypeTX)
				cell:addChild(contentMsgTx)

				channelTypeTX:setPosition(CCPoint(0, contentMsgTx:getContentSize().height))

				self.scrollList:insterWidget(cell)
			end
			self.scrollListCount = self.scrollListCount + 1
		end
		self.scrollList:m_setPosition(CCPoint(0,0))
	end,

	sendChatContent = function(self)
		local function opChatFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				self:getHistoryContent()
				self.inputText:setString("")
			else
				ShowErrorInfoDialog(error_code)
			end
		end

		local function execChat()
			showWaitDialogNoCircle("waiting send data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_Chat, opChatFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_Chat, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			if self.channelType == 1 then
				cj:setByKey("channel",2)   --0係統 1組队 2世界 3阵营 4家族
			elseif self.channelType == 2 then
				cj:setByKey("channel",3)   --0係統 1組队 2世界 3阵营 4家族
			elseif self.channelType == 3 then
				cj:setByKey("channel",4)   --0係統 1組队 2世界 3阵营 4家族
			end
			cj:setByKey("content",self.inputText:getString())  --說話內容
			NetMgr:executeOperate(Net.OPT_Chat, cj)
		end
		execChat()
	end,
	
	getHistoryContent = function(self)
		local function opHistoryFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				ClientData.fate_last_index = s:getByKey("last_index"):asInt()
				self:opFate()
				if s:getByKey("message_list"):size() > 0 then
					GlobalChatData:addData(s)
				end
			else
				ShowErrorInfoDialog(error_code)
			end
		end

		local function execHistory()
			showWaitDialogNoCircle("waiting Histroy data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_History, opHistoryFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_History, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("idx",ClientData.fate_last_index)  --說話內容
			NetMgr:executeOperate(Net.OPT_History, cj)
		end
		execHistory()
	end,

	opFate = function(self)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code",ClientData.request_code)
		cj:setByKey("last_index",ClientData.fate_last_index)  --說話內容
		NetMgr:executeOperate(Net.OPT_Fate, cj)
	end,

	destroy = function(self)
		GlobleChatMainPanel:destroy()
		GlobleChatMainPanel = nil
		GlobleChatPanel = nil
	end,
}

ChatMainPanel =
{
	bgLayer = nil,
	uiLayer = nil,
	centerWidget = nil,

	create = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()
		local bg = dbUIWidgetTiledBG:tiledBG("UI/public/recuit_bg.png",WINSIZE)
		bg:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
		bg:setScale(1/SCALEY)
		bg:setAnchorPoint(CCPoint(0,0))
		self.bgLayer:addChild(bg)

		local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
		mask:setScale(1/SCALEY)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		self.bgLayer:addChild(mask)

		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 2001)
		scene:addChild(self.uiLayer, 2002)
		return self
	end,

	setVisible = function(self,state)
		if state == true then
			self.bgLayer:setIsVisible(true)
			self.uiLayer:setIsVisible(true)
		else
			self.bgLayer:setIsVisible(false)
			self.uiLayer:setIsVisible(false)
		end
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer,true)
		scene:removeChild(self.uiLayer,true)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
	end
}


FirstOpenChatPanel = true
function GolbalCreateChat()
	if FirstOpenChatPanel == true then
		GlobleChatMainPanel = new(ChatMainPanel)
		GlobleChatMainPanel:create()

		GlobleChatPanel = new(ChatPanel)
		GlobleChatFriends = GlobleChatPanel:create(GlobleChatMainPanel.centerWidget)
		FirstOpenChatPanel = false
	else
		GlobleChatPanel:addChatContent()
		GlobleChatMainPanel:setVisible(true)
	end
end
--聊天面板data
GlobalDel = 1
function GlobalGetChatData(data)
	if not GlobalChatData then
		GlobalChatData = new(ChatContent)
		GlobalChatData:create()
	end

	GlobalChatData:addData(data)
	GlobalChatData:addPrivateData(data)
end

--战斗结束返回主界面时会调用
function GlobalChangeChannelSystem()
	WaitForGuaJi()
	backBossWar() --返回boss战地图界面
end

ChatContent = {
	content = nil,
	identity = nil,
	vip_level = nil,
	role_id = nil,
	name = nil,
	channel = nil,

	index = nil,--channel 2,3,4的index
	------------------
	privateIndex = nil,
	privateContent = nil,
	receiverId = nil,
	senderId = nil,

	privateMessagerId = nil,--记录哪些人发信息过来。每个人只记录一次
	privateMessagerName = nil,
	privateMessagerArrayId = nil,
	privateMessagerTempId = nil, --临时
	requestHand = nil,

	create = function(self)
		self.index = 1
		self.content = new({})
		self.identity = new({})
		self.vip_level = new({})
		self.role_id = new({})
		self.name = new({})
		self.channel = new({})

		------private------------
		self.privateIndex = 1
		self.privateContent = new({})
		self.receiverId = new({})
		self.senderId = new({})

		self.privateMessagerId = new(Queue)
		self.privateMessagerId:create()
		self.privateMessagerName = new(Queue)
		self.privateMessagerName:create()
		self.privateMessagerTempId = new(Queue)
		self.privateMessagerTempId:create()

		Global_SMS_Content = new(Queue):create()
		GolbalChatSMSPanel = new(ChatSMSPanel):create()
	end,

	addData = function(self,data)
		--2:世界 3:阵营 4:家族
		local length = data:getByKey("message_list"):size()
		for i = 1,length do
			local messageList = data:getByKey("message_list"):getByIndex(i-1)
			if messageList:getByKey("content"):asString() ~= nil and messageList:getByKey("content"):asString() ~= "" and ( messageList:getByKey("channel"):asInt() == 2 or messageList:getByKey("channel"):asInt() == 3 or messageList:getByKey("channel"):asInt() == 4 )then
				self.content[self.index] = messageList:getByKey("content"):asString()
				self.identity[self.index] = messageList:getByKey("identity"):asInt()
				self.vip_level[self.index] = messageList:getByKey("vip_level"):asInt()
				self.role_id[self.index] = messageList:getByKey("role_id"):asInt()
				self.name[self.index] = messageList:getByKey("name"):asString()
				self.channel[self.index] = messageList:getByKey("channel"):asInt()

				Global_SMS_Content:push(messageList:getByKey("name"):asString().." "..messageList:getByKey("content"):asString())
				self.index = self.index + 1
				if self.index > 30 then
					GlobalDel = GlobalDel + 1
				end
			elseif messageList:getByKey("content"):asString() ~= nil and messageList:getByKey("content"):asString() ~= "" and messageList:getByKey("channel"):asInt() == 0 then
				self.content[self.index] = messageList:getByKey("content"):asString()
				self.channel[self.index] = 0

				Global_SMS_Content:push(messageList:getByKey("content"):asString())
				self.index = self.index + 1
				if self.index > 30 then
					GlobalDel = GlobalDel + 1
				end
			end
		end

		GolbalUpdateSMSPanel() --显示底下的消息

		if GlobleChatMainPanel ~= nil and length > 0 then
			GlobleChatPanel:addSingleContent(length)
		end
	end,

	addPrivateData = function(self,data)
		if data:getByKey("private_message_list"):size() > 0 then
			for i = 1,data:getByKey("private_message_list"):size() do
				local messageList = data:getByKey("private_message_list"):getByIndex(i-1)

				self.privateContent[self.privateIndex] = messageList:getByKey("content"):asString()
				self.receiverId[self.privateIndex] = messageList:getByKey("receiverId"):asInt()
				self.senderId[self.privateIndex] = messageList:getByKey("senderId"):asInt()

				self:checkSenderId(self.senderId[self.privateIndex])
				self.privateIndex = self.privateIndex + 1

				Global_SMS_Content:push(messageList:getByKey("content"):asString())
			end
			----请求玩家名字
			self:getSenderName()
		end
	end,

	---检测发过来的有没有重复，累加人数
	checkSenderId = function(self,sId)
		if self.privateMessagerTempId:empty() == true then
			if (GloblePrivatePanel ~= nil and GloblePrivatePanel.friendRoleId ~= sId and ClientData.role_id ~= sId) or (GloblePrivatePanel == nil and ClientData.role_id ~= sId) then
				if self.privateMessagerId:empty() == true then
					self.privateMessagerTempId:pushBack(sId)
				elseif self.privateMessagerId:isHave(sId) == false then
					self.privateMessagerTempId:pushBack(sId)
				end
			end
		elseif self.privateMessagerTempId:isHave(sId) == false then
			if (GloblePrivatePanel ~= nil and GloblePrivatePanel.friendRoleId ~= sId and ClientData.role_id ~= sId) or (GloblePrivatePanel == nil and ClientData.role_id ~= sId) then
				if self.privateMessagerId:empty() == true then
					self.privateMessagerTempId:pushBack(sId)
				elseif self.privateMessagerId:isHave(sId) == false then
					self.privateMessagerTempId:pushBack(sId)
				end
			end
		end
	end,

	getSenderName = function(self)

		local function opFriendDataFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				if s:getByKey("name_list"):size() > 0 then
					for i = 1 , s:getByKey("name_list"):size() do
						local name_list = s:getByKey("name_list"):getByIndex(i-1)
						self.privateMessagerId:pushBack(name_list:getByKey("role_id"):asInt())
						self.privateMessagerName:pushBack(name_list:getByKey("name"):asString())
					end
					globalAddMsgIcon()
				end
			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end
		end

		local function execFriendData()
			showWaitDialogNoCircle("waiting name data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_SceneGetNameSimple, opFriendDataFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_SceneGetNameSimple, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)

			self.privateMessagerArrayId = nil
			self.privateMessagerArrayId = Value:new()
			local len =  self.privateMessagerTempId:CountValue()

			for i = 1,len do
				self.privateMessagerArrayId:setByIndex(i-1,self.privateMessagerTempId:popFirst())
			end

			cj:setByKey("playerIDs",self.privateMessagerArrayId)
			NetMgr:executeOperate(Net.OPT_SceneGetNameSimple, cj)
		end
		execFriendData()
	end,

	clearData = function(self)
		self.index = 1
		self.content = nil
		self.identity = nil
		self.vip_level = nil
		self.role_id = nil
		self.name = nil
		self.channel = nil
	end,
}
--更新消息提示区域，显示或不显示
function GolbalUpdateSMSPanel()
	if not GolbalChatSMSPanel then
		return
	end
	if not dbHUDLayer:shareHUD2Lua() then --这种情况一般都是在战斗中
		return
	end
	if dbHUDLayer:shareHUD2Lua():isOpenHudBtns() then
		if GolbalChatSMSPanel.status==1 then
			GolbalChatSMSPanel:pauseAction()
		end
	else
		GolbalChatSMSPanel:show()
	end
end

--主界面上显示的滚动聊天小窗口
ChatSMSPanel =
{
	count = 0,
	handler = nil,
	labelWidth = 0,
	fontSize = 24,
	speed = 1,
	status = 1, --0 未显示，1，显示中，2，暂停

	show = function(self)
		if self.panel then
			self:create()
		end
	
		if self.status==1 then --如果在播放动画或正在显示消息 就直接返回
			return
		end
		
		if self.status==2 then --暂停状态，则恢复显示
			self.status = 1
			self.panel:setIsVisible(true)
			self:playAction()
			return
		end

		local text = Global_SMS_Content:popFirst()
		if not text then --消息没了也直接返回
			return
		end
		
		self.status = 1
		self.panel:setIsVisible(true)
		
		self.labelWidth = getlabelWidth(text,self.fontSize)
		if self.labelWidth>1024 then
			self.labelWidth = 1024
		end
		
		self.label = CCLabelTTF:labelWithString(text, CCSizeMake(self.labelWidth,0),0, SYSFONT[EQUIPMENT], self.fontSize)
		self.label:setAnchorPoint(CCPoint(0,0.5))
		self.label:setPosition(CCPoint(5,137/2-10))
		self.label:setColor(ccc3(254,205,103))
		self.label:setTextureRect(CCRectMake(0,0,480,self.label:getContentSize().height))
		self.panel:addChild(self.label)
		
		self:playAction()
	end,

	create = function(self)
		local HUD = dbHUDLayer:shareHUD2Lua()
		if HUD then
			return
		end
		self.panel = dbUIPanel:panelWithSize(CCSize(680,137))
		self.panel:setAnchorPoint(CCPoint(0,0))
		self.panel:setPosition(CCPoint(140,0))
		HUD:addChild(self.panel)

		CCSpriteFrameCache:sharedSpriteFrameCache():addSpriteFramesWithFile("UI/HUD/HUD.plist")
		local message_bg = CCSprite:spriteWithSpriteFrameName("UI/HUD/message_bg.png")
		message_bg:setAnchorPoint(CCPoint(0,0))
		message_bg:setPosition(CCPoint(-60,0))
		self.panel:addChild(message_bg)
		
		if Global_SMS_Content:empty() then
			self.panel:setIsVisible(false)
			self.status = 0
		end
		
		self.speed = 0.2 * self.fontSize
		return self
	end,

	pauseAction = function(self)
		self.status = 2
		self.panel:setIsVisible(false)
		self:stopAction()
	end,

	playAction = function(self,cTime)
		local move = function()
			local moved = self.count*self.speed	--移动到头了,停止动画，并播放下一个
			if moved > self.labelWidth*0.6 then
				self:clear()
				self:playNext()
			else
				self.count = self.count+1
				self.label:setTextureRect(CCRectMake(moved,0,480,self.label:getContentSize().height))
			end
		end

		local waitForHide = function()
			self:clear()
			self:playNext()
		end

		if self.labelWidth > 480 and self.count*self.speed < self.labelWidth then --如果文字太长就滚动文字
			self.handler = CCScheduler:sharedScheduler():scheduleScriptFunc(move, 0.1, false)
		else
			self.handler = CCScheduler:sharedScheduler():scheduleScriptFunc(waitForHide, 3, false)
		end
	end,

	playNext = function(self)
		local handler = nil
		local wait = function()
			CCScheduler:sharedScheduler():unscheduleScriptEntry(handler)
			handler = nil
			self:show()
		end
		handler = CCScheduler:sharedScheduler():scheduleScriptFunc(wait, 3, false)
	end,

	stopAction = function(self)
		if self.handler then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.handler)
			self.handler = nil
		end
	end,

	clear = function(self)
		self.status = 0
		self:stopAction()
		self.count = 0
		if self.label then
			self.label:removeFromParentAndCleanup(true)
			self.label = nil
		end
		if self.panel then
			self.panel:setIsVisible(false)
		end
	end,

	destroy = function(self)
		self:clear()
		if self.panel then 
			self.panel:removeFromParentAndCleanup(true)
			self.panel = nil
		end
	end,
}
--创建好友面板
FriendMainPanel = {
    bgLayer = nil,
    uiLayer = nil,
    centerWidget = nil,

    create = function(self)
    	local scene = DIRECTOR:getRunningScene()

    	self.bgLayer = createPanelBg()
        self.uiLayer,self.centerWidget = createCenterWidget()
		self.bgLayer:setIsVisible(false)
        scene:addChild(self.bgLayer, 1000)
		--遮掩层
		local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
		mask:setScale(1/SCALEY)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		self.bgLayer:addChild(mask)
		
	    scene:addChild(self.uiLayer, 2000)

        return self
    end,
	createFriendListPanel = function(self,data)
		local flp = new(FriendListPanel)
		local panel = flp:initPanel(data)
		GlobalMainFriend.centerWidget:addChild(panel)
		print("globle_Create_Friend")
	end
	,
    destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
        self.bgLayer = nil
        self.uiLayer = nil
        self.centerWidget = nil
    end
}
--创建全局接口
function globle_Create_Friend()
--[[
	if GlobalChatData ~= nil and GlobalChatData.privateMessagerId:CountValue() > 0 then
		local id = GlobalChatData.privateMessagerId:popFirst()
		local name = GlobalChatData.privateMessagerName:popFirst()
		print("senderId::"..id.."    "..name)
		GolbalCreatePrivateMsg(id,name)

	else
	]]--
		local function opFriendFinishCB(s)
			closeWait()
			print("Lua ============= opFriendFinishCB ===============")

			print(s:getByKey("error_code"):asInt())
			if s:getByKey("error_code"):asInt() == -1 then
				--@@GlobalMainFriend = new(FriendMainPanel)
			--@@	GlobalMainFriend:create()
				GlobalListPanel = new(FriendListPanel)
				--@@ local panel = flp:initPanel(s, GlobalMainFriend.centerWidget)
				GlobalListPanel:initPanel(s, GlobleChatFriends)	--##将好友界面创建到聊天面板中
				if GlobalChatData ~= nil and GlobalChatData.privateMessagerId:CountValue() > 0 then
					local id = GlobalChatData.privateMessagerId:popFirst()
					local name = GlobalChatData.privateMessagerName:popFirst()
					print("senderId::"..id.."    "..name)
					GolbalCreatePrivateMsg(id,name)
				end
				--GlobalMainFriend.centerWidget:addChild(panel)
				print("globle_Create_Friend")
			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end

		end

		local function opFriendFailedCB(s)
			closeWait()
			print("Lua ============= opFriendFailedCB ===============")
		end

		local function execFriend()
			showWaitDialog("waiting friend data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_Friend, opFriendFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_Friend, opFriendFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
				
			NetMgr:executeOperate(Net.OPT_Friend, cj)
			print("Lua $$$$$ Execute OPT_Friend $$$$$")
		end
		
		execFriend()
	--end
	-------
	globalAddMsgIcon()

end


FriendMSG = nil
FriendCircle = nil
function globalAddMsgIcon()
	local count = GlobalChatData.privateMessagerId:CountValue()
	local hud = dbHUDLayer:shareHUD2Lua()
	if FriendMSG ~= nil then
		FriendMSG:removeFromParentAndCleanup(true)
		FriendMSG = nil
	end
	
	if FriendCircle ~= nil then
		FriendCircle:removeFromParentAndCleanup(true)
		FriendCircle = nil
	end
	
	if count > 0 then
		FriendCircle = CCSprite:spriteWithFile("UI/public/page_btn_toggle.png")
		FriendCircle:setAnchorPoint(CCPoint(0.5, 0.5))
		FriendCircle:setPosition(CCPoint(512,368))
		FriendCircle:setScaleX(SCALEX)
		FriendCircle:setScaleY(SCALEY)
		--fBtn:addChild(FriendCircle)
		
		FriendMSG = CCLabelTTF:labelWithString(count,SYSFONT[EQUIPMENT], 32)
		FriendMSG:setAnchorPoint(CCPoint(0.5, 0.5))
		FriendMSG:setPosition(CCPoint(512,368))
		FriendMSG:setColor(ccc3(255,255,255))
		FriendMSG:setScaleX(SCALEX)
		FriendMSG:setScaleY(SCALEY)
		--fBtn:addChild(FriendMSG)
	end
end

--好友聊天面板（原好友列表）
FriendListPanel = {
	m_Layer = nil,
	scrollList = nil,
	addFriendBtn = nil,
	btns = {},
	
	inputText = nil,
	--friend_face,widget,role_id,friend_name
	widget=nil,			--当前好友所在的widget
	role_id=nil,		--当前好友的ID
	friend_name=nil,	--当前好友的名字
	name_label=nil,		--显示当前选中的好友名字
	friendFaces = nil,
	msgPanel=nil,
	friendNames = nil,
	friendIds = nil,
	friendRoleIds = nil,
	friendArray = nil,
	index = nil,
	-------------------------
	newbtns = {},
	m_panel = nil , 
	
	initPanel = function(self,data,parent)
		self.friendofficiums= new({})  --@@
		self.friendFaces = new({})
		self.friendNames = new({})
		self.friendIds = new({})
		self.friendRoleIds = new({})
		self.friendArray = Value:new()
		self.btns = new({})
		self.index = 1
		
		--------------------------------------------
		self.m_Layer = parent--dbUILayer:node()
		
		self.msgPanel = dbUIPanel:panelWithSize(CCSizeMake(670,540))
		self.msgPanel:setAnchorPoint(CCPoint(1,0))
		self.msgPanel:setPosition(CCPoint(self.m_Layer:getContentSize().width,0))
		self.m_Layer:addChild(self.msgPanel)
		
		
		--创建好友列表背景
		local myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(50,50))
		myBG:setBGSize(CCSizeMake(260,590))
		myBG:setAnchorPoint(CCPoint(0,0))
		myBG:createCeil("UI/public/kuang_xiao_mi_shu.png")
		myBG:setPosition(10 ,5)
		self.m_Layer:addChild(myBG)
		--滚动条
		self.scrollList =  dbUIScrollList:scrollList(CCRectMake(12+10,12+50,240,450),0);
		self.scrollList:setPosition(CCPoint(15,7+84+30))
		self.m_Layer:addChild(self.scrollList)
		
		------------添加好友输入框---------------------
		myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(20,20))
		myBG:setBGSize(CCSizeMake(200,40))
		myBG:setAnchorPoint(CCPoint(0,0))
		myBG:createCeil("UI/public/kuang_xiao_mi_shu.png")
		myBG:setPosition(CCPoint(40,83))
		self.m_Layer:addChild(myBG)
		
		local hud = dbHUDLayer:shareHUD2Lua()---------------
		local fBtn = hud:getChildByTag(11)-----------------------
		
		self.inputText = dbUIWidgetInput:inputWithText("","Thonburi", 30,false,15,CCRectMake(43,86,190,40))
		self.inputText:setNeedFocus(true)
		self.m_Layer:addChild(self.inputText,1000)
		
		local tmp_y = self.m_Layer:getPositionY()
		self.inputText.m_ScriptKeyboardDidShow = function()
			self.m_Layer:runAction(CCMoveTo:actionWithDuration(0.5,CCPoint(self.m_Layer:getPositionX(), tmp_y + 370)))
		end
		self.inputText.m_ScriptKeyboardDidHide = function()
			self.m_Layer:runAction(CCMoveTo:actionWithDuration(0.5,CCPoint(self.m_Layer:getPositionX(), tmp_y + 0)))
		end
		-------------------添加好友按钮--------------------------------------
		self.addFriendBtn = dbUIButtonScale:buttonWithImage("UI/friend/friend_add_btn.png", 1, ccc3(125, 125, 125))
		self.addFriendBtn:setAnchorPoint(CCPoint(0.5,0.5))
		self.addFriendBtn:setPosition(CCPoint(200-70,70-30))
		self.addFriendBtn.m_nScriptClickedHandler = function()
			self:addFriend()
		end
		self.m_Layer:addChild(self.addFriendBtn,1000)
		--[[
		----------------------------------------------------------
		--------------聊天输入框---------------------
		myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(20,20))
		myBG:setBGSize(CCSizeMake(490,50))
		myBG:setAnchorPoint(CCPoint(0,0))
		myBG:createCeil("UI/public/kuang_xiao_mi_shu.png")
		myBG:setPosition(CCPoint(280,5))
		self.m_Layer:addChild(myBG)
		
		self.chatText = dbUIWidgetInput:inputWithText("","Thonburi", 30,false,100,CCRectMake(283,8,480,45))
		self.chatText:setNeedFocus(true)
		self.m_Layer:addChild(self.chatText,1000)
		
		local tmp_y = self.m_Layer:getPositionY()
		self.chatText.m_ScriptKeyboardDidShow = function()
			self.m_Layer:runAction(CCMoveTo:actionWithDuration(0.5,CCPoint(self.m_Layer:getPositionX(), tmp_y + 370)))
		end
		self.chatText.m_ScriptKeyboardDidHide = function()
			self.m_Layer:runAction(CCMoveTo:actionWithDuration(0.5,CCPoint(self.m_Layer:getPositionX(), tmp_y + 0)))
		end
		------------------发送按钮---------------------------------------
		self.sendchatBtn = dbUIButtonScale:buttonWithImage("UI/chat/chat_btn.png", 1, ccc3(125, 125, 125))
		self.sendchatBtn:setAnchorPoint(CCPoint(0,0))
		self.sendchatBtn:setPosition(CCPoint(780,5))
		self.sendchatBtn.m_nScriptClickedHandler = function()
			self:addFriend()
		end
		self.m_Layer:addChild(self.sendchatBtn)
		]]--
		----------------------------------------------------------
		-----------------------顶部按钮-------------widget,role_id,friend_name---------
		local imageConfig = {
			"UI/friend/friend_fight.png",
			"UI/friend/look_btn.png",
			"UI/friend/friend_delete.png",
		}
		for i = 1 ,3 do
			self.newbtns[i] = dbUIButtonScale:buttonWithImage(imageConfig[i], 1, ccc3(125, 125, 125))
			self.newbtns[i]:setAnchorPoint(CCPoint(0,0.5))
			self.newbtns[i]:setPosition(CCPoint(500+53+(i-1)*115,560))
			self.newbtns[i].m_nScriptClickedHandler = function()
				if i == 1 then
					if self.role_id == nil then
						return
					else
					executeBattle(self.role_id, 1)
					end
				elseif i == 2 then
					if self.role_id == nil then
						return
					else
					createViewTargetPanel(self.role_id,self.friend_name)
					end
				elseif i == 3 then
					if self.role_id == nil then
						return
					else
					self:deleteFriend(self.role_id,self.widget)
					end
				end	
			end
			self.m_Layer:addChild(self.newbtns[i])
		end
		--[[
		------------------------------------------------
		-----------------------------------------
		--创建聊天滑动区背景
		myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(70,70))
		myBG:setBGSize(CCSizeMake(660,430+40))
		myBG:setAnchorPoint(CCPoint(0,0))
		myBG:createCeil("UI/public/kuang_xiao_mi_shu.png")
		myBG:setPosition(CCPoint(280,5+66))
		self.m_Layer:addChild(myBG)
		
		--创建聊天滑动区
		--------------------------------------------
		self.chatscrollList = dbUIList:list(CCRectMake(280, 5+66, 650, 425+40),0)
		self.m_Layer:addChild(self.chatscrollList)
		]]--
	--显示好友名字
		
		self.name_label= CCLabelTTF:labelWithString("当前好友：", SYSFONT[EQUIPMENT], 27)
		self.name_label:setAnchorPoint(CCPoint(0, 0))
		self.name_label:setPosition(CCPoint(300-10 , 535))
		self.name_label:setColor(ccc3(255,255,255))
		self.m_Layer:addChild(self.name_label)
	--获取好友列表
		local friend_list = data:getByKey("fiend_list")
		if friend_list:size() > 0 then
			for i = 1,friend_list:size() do 
				self.friendFaces[self.index] = friend_list:getByIndex(i-1):getByKey("face"):asInt()
				self.friendIds[self.index] = friend_list:getByIndex(i-1):getByKey("friend_id"):asInt()
				self.friendofficiums[self.index] = friend_list:getByIndex(i-1):getByKey("officium"):asInt()--@@ 貌似服务器没有传过来此参数？
				self.friendArray:setByIndex(i-1,self.friendIds[self.index])
				print("array:"..self.friendIds[self.index])
				self.index = self.index + 1
			end
			self:addFriendData()
		end

		
			return self.m_Layer
	end,
	--未修改
	
	addFriendData = function(self)
		local function opFriendDataFinishCB(s)
			closeWait()
			print("Lua ============= opFriendDataFinishCB ===============")
			print(s:getByKey("error_code"):asInt())
			if s:getByKey("error_code"):asInt() == -1 then
				self:friendListData(s)
			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end

		end

		local function opFriendDataFailedCB(s)
			closeWait()
			print("Lua ============= opFriendDataFailedCB ===============")
		end

		local function execFriendData()
			showWaitDialogNoCircle("waiting add friend data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_SceneGetNameSimple, opFriendDataFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_SceneGetNameSimple, opFriendDataFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("playerIDs",self.friendArray)
				
			NetMgr:executeOperate(Net.OPT_SceneGetNameSimple, cj)
			print("Lua $$$$$ Execute OPT_SceneGetNameSimple $$$$$")
		end
		execFriendData()
	end,
	--增加神位
	friendListData = function(self,data)
	
		if data:getByKey("name_list"):size() > 0 then
			for i = 1 , data:getByKey("name_list"):size() do
			
				local name_list = data:getByKey("name_list"):getByIndex(i-1)
				self.friendRoleIds[i] = name_list:getByKey("role_id"):asInt()
				self.friendNames[i] = name_list:getByKey("name"):asString()
		--		self.friendofficiums[i] = name_list:getByKey("officium"):asInt()------------------------------
			end
		end
		self:insertFriendList()
	end,
	--好友列表显示具体实现方法-------------------------------------------
	insertFriendList = function(self)
		
		for i = 1 , table.getn(self.friendNames) do
			
			if self.friendNames[i] ~= "" and self.friendNames[i] ~= nil  then	
			
				--创建好友显示单元widget
				self.btns[i] = dbUIWidgetBGFactory:widgetBG()
				self.btns[i]:setCornerSize(CCSizeMake(10,10))
				self.btns[i]:setBGSize(CCSizeMake(265,100))
				self.btns[i]:setAnchorPoint(CCPoint(0,0))
				self.btns[i]:createCeil("UI/public/desc_bg.png")
				--self.btns[i] = dbUIButtonScale:buttonWithImage("UI/public/tufei_btn.png", 1, ccc3(125, 125, 125))
				--self.btns[i]:setAnchorPoint(CCPoint(0, 0))
				
				--self.btns[i]:setContentSize(CCPoint(self.btns[i]:getContentSize().width , self.btns[i]:getContentSize().height+50))
				self.btns[i]:setPosition(CCPoint(0,0))
				self.btns[i].m_nScriptClickedHandler = function()
					--public_toggleRadioBtn(self.btns,self.btns[i])------@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@-----
					self.widget=self.btns[i]
					self.role_id=self.friendRoleIds[i]
					self.friend_name=self.friendNames[i]
					self.name_label:setString("当前好友："..self.friend_name)
					GolbalCreatePrivateMsg(self.role_id,self.friend_name,true)
					--self:createFriendControlPanel(self.friendFaces[i],self.btns[i],self.friendRoleIds[i],self.friendNames[i])
				end
				--单元上显示名字
			local nateTX = CCLabelTTF:labelWithString(self.friendNames[i], SYSFONT[EQUIPMENT], 32)
				nateTX:setAnchorPoint(CCPoint(0, 0))
				nateTX:setPosition(CCPoint(100 , 50))
				nateTX:setColor(ccc3(255,255,255))
				self.btns[i]:addChild(nateTX)
				--单元上显示神位
				nateTX = CCLabelTTF:labelWithString("神位："..self.friendofficiums[i], SYSFONT[EQUIPMENT], 32) ------
				nateTX:setAnchorPoint(CCPoint(0, 0))
				nateTX:setPosition(CCPoint(100 , 10))
				nateTX:setColor(ccc3(255,255,255))
				self.btns[i]:addChild(nateTX)
				--单元上显示头像
			local image = CCSprite:spriteWithFile("head/Middle/head_middle_"..self.friendFaces[i]..".png")
				image:setPosition(CCPoint(15,5))
				image:setAnchorPoint(CCPoint(0,0))
				self.btns[i]:addChild(image)
				
			self.scrollList:insterDetail(self.btns[i])
			end
			
		end
		self.scrollList:stopDetailsActions()
		--默认选中第一个好友
		self.widget=self.btns[1]
		self.role_id=self.friendRoleIds[1]
		self.friend_name=self.friendNames[1]
		self.name_label:setString("当前好友："..self.friend_name)
		GolbalCreatePrivateMsg(self.role_id,self.friend_name,true)
		
		
	end,
	
	createFriendControlPanel = function(self,friend_face,widget,role_id,friend_name)
	
		self.newbtns = new({})

		self.m_panel  = dbUIPanel:panelWithSize(CCSize(1024, 768))
		self.m_panel:setAnchorPoint(CCPoint(0.5,0.5))
		self.m_panel:setPosition(CCPoint(512,384))
		self.m_panel.m_nScriptClickedHandler = function()

			self.m_panel:removeFromParentAndCleanup(true)
		end

		local myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(70,70))
		myBG:setBGSize(CCSizeMake(400,160))
		myBG:setAnchorPoint(CCPoint(0.5,0.5))
		myBG:createCeil("UI/public/recuit_k_bg.png")
		myBG:setPosition(512 + 50 ,384)
		self.m_panel:addChild(myBG)	
		--[[
		local closeBtn = dbUIButton:buttonWithImage("UI/public/close_circle.png", "UI/public/close_circle.png")
		closeBtn:setAnchorPoint(CCPoint(0.5,0.5))
		closeBtn:setPosition(CCPoint(512 + 280,384 + 100))
		self.m_panel:addChild(closeBtn,10)
		closeBtn.m_nScriptClickedHandler = function()

			self.m_panel:removeFromParentAndCleanup(true)
		end
		--]]
		--------按钮
		local imageConfig = {
			"UI/friend/friend_fight.png",
			"UI/friend/look_btn.png",
			"UI/friend/friend_private.png",
			"UI/friend/friend_delete.png",
		}
		for i = 1 ,4 do
			self.newbtns[i] = dbUIButtonScale:buttonWithImage(imageConfig[i], 1, ccc3(125, 125, 125))
			self.newbtns[i]:setAnchorPoint(CCPoint(0.5,0.5))
			self.newbtns[i]:setPosition(CCPoint(512+50+((i-1)%2)*120,510 - 92 - (math.floor((i-1)/2))*70))
			self.newbtns[i].m_nScriptClickedHandler = function()
				if i == 1 then
					executeBattle(role_id, 1)
				elseif i == 2 then
					createViewTargetPanel(role_id,friend_name)
				elseif i == 3 then
					GolbalCreatePrivateMsg(role_id,friend_name,true)
				elseif i == 4 then
					self:deleteFriend(role_id,widget)
				end
				self.m_panel:removeFromParentAndCleanup(true)		
			end
			self.m_panel:addChild(self.newbtns[i])
		end
		
		local kua = dbUIWidgetBGFactory:widgetBG()
		kua:setCornerSize(CCSizeMake(25,25))
		kua:setBGSize(CCSizeMake(120,120))
		kua:setAnchorPoint(CCPoint(0.5,0.5))
		kua:createCeil("UI/public/dialog_kuang.png")
		kua:setPosition(CCPoint(512 - 75,384 + 10))
		self.m_panel:addChild(kua)
		
		local image = CCSprite:spriteWithFile("head/Middle/head_middle_"..friend_face..".png")
		image:setPosition(CCPoint(512 - 75,384 + 10))
		self.m_panel:addChild(image)
		
		
		local nameText = CCLabelTTF:labelWithString(friend_name, SYSFONT[EQUIPMENT], 26)
		nameText:setAnchorPoint(CCPoint(0.5, 0.5))
		nameText:setPosition(CCPoint(512 - 75 , 384 - 55))
		nameText:setColor(ccc3(255,255,255))
		self.m_panel:addChild(nameText)
	
		self.m_Layer:addChild(self.m_panel)
	end,
	
	deleteFriend = function(self,friend_id,widget)
		local function opDeleteFriendFinishCB(s)
			closeWait()
			print("Lua ============= opDeleteFriendFinishCB ===============")
			
			print(s:getByKey("error_code"):asInt())
			if s:getByKey("error_code"):asInt() == -1 then
			------------------提示面板----------------------
				local createPanel = new(SimpleTipPanel)
				createPanel:create(DEL_FRIEND_SUCCESS,ccc3(255,0,0),0)
			---------------------------------------
				self.scrollList:removeDetail(widget,true)
			--	self.index = self.index -1 --------------------
				--self.friendIds[list_index] = 0
			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end

		end

		local function opDeleteFriendFailedCB(s)
			closeWait()
			print("Lua ============= opDeleteFriendFailedCB ===============")
		end

		local function execDeleteFriend()
			showWaitDialogNoCircle("waiting delete data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FriendAction, opDeleteFriendFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FriendAction, opDeleteFriendFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("target_id",friend_id) --friend_id
			cj:setByKey("action",2)   --1增加好友，2删除好友
 		
			NetMgr:executeOperate(Net.OPT_FriendAction, cj)
			print("Lua $$$$$ Execute OPT_FriendAction $$$$$")
		end
		execDeleteFriend()
	end,
	addFriend = function(self)
	
		if self.inputText:getString() == nil or self.inputText:getString() == "" then
			return
		end
		
		local function opAddFriendFinishCB(s)
			closeWait()
			print("Lua ============= opAddFriendFinishCB ===============")

			print(s:getByKey("error_code"):asInt())
			if s:getByKey("error_code"):asInt() == -1 then
			------------------提示面板--------------
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ADD_FRIEND_SUCCESS,ccc3(255,0,0),0)
				--------------------------------------------------

				
				local ii = s:getByKey("fiend_list"):size() - 1
				local friend_list = s:getByKey("fiend_list"):getByIndex(ii)
				local index = self.index
				self.friendFaces[index] = friend_list:getByKey("face"):asInt()
				self.friendofficiums[index] = friend_list:getByKey("officium"):asInt()
				
				self.friendNames[index] = self.inputText:getString()
				
				self.friendRoleIds[index] = friend_list:getByKey("friend_id"):asInt()
				
				--self.friendRoleIds
				
				---------加载新单元-------
				self.btns[index] = dbUIWidgetBGFactory:widgetBG()
				self.btns[index]:setCornerSize(CCSizeMake(10,10))
				self.btns[index]:setBGSize(CCSizeMake(265,100))
				self.btns[index]:setAnchorPoint(CCPoint(0,0))
				self.btns[index]:createCeil("UI/public/desc_bg.png")
				--self.btns[i] = dbUIButtonScale:buttonWithImage("UI/public/tufei_btn.png", 1, ccc3(125, 125, 125))
				--self.btns[i]:setAnchorPoint(CCPoint(0, 0))
				
				--self.btns[i]:setContentSize(CCPoint(self.btns[i]:getContentSize().width , self.btns[i]:getContentSize().height+50))
				self.btns[index]:setPosition(CCPoint(0,0))
				self.btns[index].m_nScriptClickedHandler = function()
				--	public_toggleRadioBtn(self.btns,self.btns[index])------@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@-----
					self.widget=self.btns[index]
					self.role_id=self.friendRoleIds[index]
					self.friend_name=self.friendNames[index]
					self.name_label:setString("当前好友："..self.friend_name)
					GolbalCreatePrivateMsg(self.role_id,self.friend_name,true)
					--self:createFriendControlPanel(self.friendFaces[i],self.btns[i],self.friendRoleIds[i],self.friendNames[i])
				end
				--单元上显示名字
			local nateTX = CCLabelTTF:labelWithString(self.friendNames[index], SYSFONT[EQUIPMENT], 32)
				nateTX:setAnchorPoint(CCPoint(0, 0))
				nateTX:setPosition(CCPoint(100 , 50))
				nateTX:setColor(ccc3(255,255,255))
				self.btns[index]:addChild(nateTX)
				--单元上显示神位
				nateTX = CCLabelTTF:labelWithString("神位："..self.friendofficiums[index], SYSFONT[EQUIPMENT], 32) ------
				nateTX:setAnchorPoint(CCPoint(0, 0))
				nateTX:setPosition(CCPoint(100 , 10))
				nateTX:setColor(ccc3(255,255,255))
				self.btns[index]:addChild(nateTX)
				--单元上显示头像
			local image = CCSprite:spriteWithFile("head/Middle/head_middle_"..self.friendFaces[index]..".png")
				image:setPosition(CCPoint(15,5))
				image:setAnchorPoint(CCPoint(0,0))
				self.btns[index]:addChild(image)
				--默认选中新加的好友
				self.widget=self.btns[index]
				self.role_id=self.friendRoleIds[index]
				self.friend_name=self.friendNames[index]
				self.name_label:setString("当前好友："..self.friend_name)
				 ------
			self.scrollList:insterDetail(self.btns[index])
			GolbalCreatePrivateMsg(self.role_id,self.friend_name,true)
				--[[
				self.btns[self.index] = dbUIButtonScale:buttonWithImage("UI/public/tufei_btn.png", 1, ccc3(125, 125, 125))
				self.btns[self.index]:setAnchorPoint(CCPoint(0, 0))
				self.btns[self.index]:setContentSize(CCPoint(self.btns[self.index]:getContentSize().width , self.btns[self.index]:getContentSize().height+10))
				self.btns[self.index]:setPosition(CCPoint(0,0))
				
				local nateTX = CCLabelTTF:labelWithString(self.friendNames[self.index], SYSFONT[EQUIPMENT], 32)
				nateTX:setAnchorPoint(CCPoint(0.5, 0.5))
				nateTX:setPosition(CCPoint(self.btns[self.index]:getContentSize().width / 2 , self.btns[self.index]:getContentSize().height/2))
				nateTX:setColor(ccc3(255,255,255))
				self.btns[self.index]:addChild(nateTX)
				
				self.scrollList:insterDetail(self.btns[self.index])
				--self.scrollList:stopDetailsActions()
				local friend_face = self.friendFaces[self.index]
				local tempBtn = self.btns[self.index]
				local fri_role_id = self.friendRoleIds[self.index]
				local fri_name = self.friendNames[self.index]
				self.btns[self.index].m_nScriptClickedHandler = function()
				
					self:createFriendControlPanel(friend_face,tempBtn,fri_role_id,fri_name)
				end
				----------------------
				]]--
				self.inputText:setString("")
				self.index = self.index + 1

			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end

		end

		local function opAddFriendFailedCB(s)
			closeWait()
			print("Lua ============= opAddFriendFailedCB ===============")
		end

		local function execAddFriend()
			showWaitDialogNoCircle("waiting add data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FriendAdd, opAddFriendFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FriendAdd, opAddFriendFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("name",self.inputText:getString())
			
			NetMgr:executeOperate(Net.OPT_FriendAdd, cj)
			print("Lua $$$$$ Execute OPT_FriendAdd $$$$$")
		end
		execAddFriend()
	end,
}
FriendControlPanel = {
	m_panel = nil,
	newbtns = nil,
	roleId = nil,
	create = function(self,role_id,friend_face,friend_name)

		self.newbtns = new({})
		self.roleId = role_id

		self.m_panel  = dbUIPanel:panelWithSize(CCSize(1024, 768))
		self.m_panel:setAnchorPoint(CCPoint(0.5,0.5))
		self.m_panel:setPosition(CCPoint(512,384))
		self.m_panel.m_nScriptClickedHandler = function()
			self:destroy()
		end

		local myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(70,70))
		myBG:setBGSize(CCSizeMake(350,300))
		myBG:setAnchorPoint(CCPoint(0.5,0.5))
		myBG:createCeil("UI/public/dialog_kuang.png")
		myBG:setPosition(512, 384)
		self.m_panel:addChild(myBG)

		local nameText = CCLabelTTF:labelWithString(friend_name, SYSFONT[EQUIPMENT], 26)
		nameText:setAnchorPoint(CCPoint(0.5, 1))
		nameText:setPosition(CCPoint(350/2, 280-7))
		nameText:setColor(ccc3(102,50,0))
		myBG:addChild(nameText)

		local imageConfig = {
			"UI/friend/look_btn2.png",
			"UI/friend/friend_fight2.png",
			"UI/friend/mail_btn.png",
			"UI/friend/friend_private.png",
			"UI/friend/friend_add_btn.png",
		}
		for i = 1 ,3 do    --只开放三个功能
			self.newbtns[i] = dbUIButtonScale:buttonWithImage(imageConfig[i], 1, ccc3(125, 125, 125))
			self.newbtns[i]:setAnchorPoint(CCPoint(0.5,0.5))
			self.newbtns[i]:setPosition(CCPoint(350 / 2,260 - 65 * i))
			self.newbtns[i].m_nScriptClickedHandler = function()
				if i == 1 then
					createViewTargetPanel(role_id,friend_name)
					self:destroy()
				elseif i == 2 then
					executeBattle(role_id, 1)
					self:destroy()
				elseif i == 3 then
					globleShowMailSend(friend_name)
					self:destroy()
				--elseif i == 3 then
				--	GolbalCreatePrivateMsg(role_id,friend_name,true)
				--	self:destroy()
				--elseif i == 4 then
				--	self:addFriend()
				--	self:destroy()
				end
			end
			myBG:addChild(self.newbtns[i])
		end
		return self.m_panel
	end,

	addFriend = function(self)
		local function opAddFriendFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ADD_FRIEND_SUCCESS,ccc3(255,0,0),0)
			else
				local createPanel = new(SimpleTipPanel)
				local eId = s:getByKey("error_code"):asInt()
				createPanel:create(ERROR_CODE_DESC[eId],ccc3(255,0,0),0)
			end
		end
		local function execAddFriend()
			showWaitDialogNoCircle("waiting add data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FriendAction, opAddFriendFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FriendAction, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("target_id",self.roleId) --friend_id
			cj:setByKey("action",1)   --1增加好友，2删除好友
			NetMgr:executeOperate(Net.OPT_FriendAction, cj)
		end
		execAddFriend()
	end,

	destroy = function(self)
		GolbalFriendControlMainPanel:destroy()
	end
}

FriendControlMainPanel = {
	bgLayer = nil,
	uiLayer = nil,
	centerWidget = nil,

	create = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createSystemPanelBg()

		--遮掩层
		local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
		mask:setScale(1/SCALEY)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		self.bgLayer:addChild(mask)

		self.uiLayer,self.centerWidget = createCenterWidget()

		scene:addChild(self.bgLayer, 2001)
		scene:addChild(self.uiLayer, 2002)

		return self
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
	end

}

function GolbalCreateFriendControl(player)
	if IN_BOSS_WAR_SCENE then
		return
	end
		
	GolbalFriendControlMainPanel = new(FriendControlMainPanel)
	GolbalFriendControlMainPanel:create()

	local fcp = new(FriendControlPanel)
	local ltPanelL = fcp:create(player:getRoleId(), player:getObjId(), player:getName())

	GolbalFriendControlMainPanel.centerWidget:addChild(ltPanelL)
end
--聊天面板

PrivateMessagePanel = {

	chatLayer = nil,
--	chatP = nil,

	inputText = nil,
	sendBtn = nil,
	centerlayer = nil,

	friendRoleId = nil,
	friendName = nil,

	scrollList = nil,
	
	checkHandle = nil,
	radiosBtn = nil,
	
	create = function(self,id,name,is_friend,parent)
		
	--	if self.chatLayer ~=nil then
	--	self.chatLayer:removeFromParentAndCleanup(true)
	--	self.chatLayer =nil
	--	end
		
		self.radiosBtn = new({})
		self.friendRoleId = id
		self.friendName = name
	
		self.chatLayer = parent--dbUILayer:node()
		--self.centerlayer = dbUIPanel:panelWithSize(CCSizeMake(670,540))
		--self.centerlayer:setAnchorPoint(CCPoint(1,0))
		--self.centerlayer:setPosition(CCPoint(self.chatLayer:getContentSize().width,0))
		--self.chatLayer:addChild(self.centerlayer)
		
		local myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(70,70))
		myBG:setBGSize(CCSizeMake(660,430+40))
		myBG:setAnchorPoint(CCPoint(0,0))
		myBG:createCeil("UI/public/kuang_xiao_mi_shu.png")
		myBG:setPosition(CCPoint(280-280,5+66))
		self.chatLayer:addChild(myBG)	
	--[[	
		self.centerlayer = dbUIPanel:panelWithSize(CCSizeMake(1024,700))
		self.chatLayer:addChild(self.centerlayer)
		
		local logo = CCSprite:spriteWithFile("UI/chat/chat_logo.png")
		logo:setPosition(CCPoint(512 ,384 + 320))
		self.centerlayer:addChild(logo)
		
		logo = CCSprite:spriteWithFile("UI/chat/chat_b.png")
		logo:setPosition(CCPoint(100 ,384 + 230))
		self.centerlayer:addChild(logo)
		
		logo = CCSprite:spriteWithFile("UI/chat/chat_b.png")
		logo:setPosition(CCPoint(512 + 410,384 + 230))
		self.centerlayer:addChild(logo)
		logo:setFlipX(true)
		
		
		local myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(70,70))
		myBG:setBGSize(CCSizeMake(844,528))
		myBG:setAnchorPoint(CCPoint(0.5,0.5))
		myBG:createCeil("UI/public/recuit_big_k.png")
		myBG:setPosition(512 ,384 - 50 )
		self.centerlayer:addChild(myBG)
		---------------
		local imageConfig = {
			--"UI/friend/friend_fight.png",
			"UI/friend/look_btn.png",
			"UI/friend/friend_add_btn.png",
			"UI/friend/friend_delete.png",
		}
		for i = 1 ,3 do
			self.radiosBtn[i] = dbUIButtonScale:buttonWithImage(imageConfig[i], 1, ccc3(125, 125, 125))
			self.radiosBtn[i]:setAnchorPoint(CCPoint(0.5,0.5))
			if i ~= 3 then
				self.radiosBtn[i]:setPosition(CCPoint(i*120 + 80,384 + 235))
			else
				self.radiosBtn[i]:setPosition(CCPoint((i-1)*120 + 80,384 + 235))
				self.radiosBtn[i]:setIsVisible(false)
			end
			self.radiosBtn[i].m_nScriptClickedHandler = function()
	
				if i == 1 then
					createViewTargetPanel(self.friendRoleId,self.friendName)
					self:destroy()
				elseif i == 2 then
					self:addFriend()
				elseif i == 3 then
					self:deleteFriend()
				end
		
			end
			self.centerlayer:addChild(self.radiosBtn[i])
		end
		if is_friend == true then
			self.radiosBtn[2]:setIsVisible(false)
			self.radiosBtn[3]:setIsVisible(true)
		end
		
		-------------------------------
		local gap = CCSprite:spriteWithFile("UI/chat/chat_gap.png")
		gap:setScaleX(820)
		gap:setPosition(CCPoint(512,384 - 238))
		self.centerlayer:addChild(gap)
		
]]--

		--创建聊天滑动区
		--------------------------------------------
		self.scrollList = dbUIList:list(CCRectMake(280-280, 5+66, 650, 425+40),0)
		self.chatLayer:addChild(self.scrollList)
		--------------------------------------------
		----------------------------------------------------------
		--------------聊天输入框---------------------
		myBG = dbUIWidgetBGFactory:widgetBG()
		myBG:setCornerSize(CCSizeMake(20,20))
		myBG:setBGSize(CCSizeMake(490,50))
		myBG:setAnchorPoint(CCPoint(0,0))
		myBG:createCeil("UI/public/kuang_xiao_mi_shu.png")
		myBG:setPosition(CCPoint(280-280,5))
		self.chatLayer:addChild(myBG)
		
		self.inputText = dbUIWidgetInput:inputWithText("","Thonburi", 30,false,100,CCRectMake(283-280,8,480,45))
		self.inputText:setNeedFocus(true)
		self.chatLayer:addChild(self.inputText,1000)
		
		local tmp_y = self.chatLayer:getPositionY()
		self.inputText.m_ScriptKeyboardDidShow = function()
			self.chatLayer:runAction(CCMoveTo:actionWithDuration(0.5,CCPoint(self.chatLayer:getPositionX(), tmp_y + 370)))
		end
		self.inputText.m_ScriptKeyboardDidHide = function()
			self.chatLayer:runAction(CCMoveTo:actionWithDuration(0.5,CCPoint(self.chatLayer:getPositionX(), tmp_y + 0)))
		end
		------------------发送按钮---------------------------------------
		self.sendBtn = dbUIButtonScale:buttonWithImage("UI/chat/chat_btn.png", 1, ccc3(125, 125, 125))
		self.sendBtn:setAnchorPoint(CCPoint(0,0))
		self.sendBtn:setPosition(CCPoint(780-280,5))
		self.sendBtn.m_nScriptClickedHandler = function()
			if GlobalChatData == nil then
				return
			end
				self:sendChatContent()
		end
		self.chatLayer:addChild(self.sendBtn)
		
		--[[
		self.scrollList = dbUIList:list(CCRectMake(120, 160, 760, 420),0)
		self.centerlayer:addChild(self.scrollList)
		
		-----------------------------------------
		
		self.sendBtn = dbUIButtonScale:buttonWithImage("UI/chat/chat_btn.png", 1, ccc3(125, 125, 125))
		self.sendBtn:setAnchorPoint(CCPoint(0.5,0.5))
		self.sendBtn:setPosition(CCPoint(1024 - 160,110))
		self.sendBtn.m_nScriptClickedHandler = function()
			if GlobalChatData == nil then
				return
			end
				self:sendChatContent()
		end
		self.centerlayer:addChild(self.sendBtn)
		
		
		------------------文本输入框-------
		self.inputText = dbUIWidgetInput:inputWithText("","Thonburi", 40,false,100,CCRectMake(120, 92,680,64))
		self.inputText:setNeedFocus(true)
		self.centerlayer:addChild(self.inputText,1000)
		
		self.inputText.m_ScriptKeyboardDidShow = function()
			self.centerlayer:runAction(CCMoveTo:actionWithDuration(0.5,CCPoint(0,320)))
		end
		self.inputText.m_ScriptKeyboardDidHide = function()
			self.centerlayer:runAction(CCMoveTo:actionWithDuration(0.5,CCPoint(0,0)))
		end
		-------------------
		]]--
		if GlobalChatData ~= nil then
			self:addChatContent()
		end
		----
		self:checkMessage()
		return self.chatLayer
	end,
	addChatContent = function(self)
		if GlobalChatData == nil then
			return
		end
	--	self.scrollList:removeAllWidget(true)
		for i = 1 ,table.getn(GlobalChatData.privateContent) do
			
			if GlobalChatData.receiverId[i] == self.friendRoleId and GlobalChatData.senderId[i] == ClientData.role_id then
			
				local contentMsgTx = CCLabelTTF:labelWithString(ClientData.role_name..":  "..GlobalChatData.privateContent[i], CCSizeMake(750,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 24)
				contentMsgTx:setAnchorPoint(CCPoint(0, 0))
				contentMsgTx:setColor(ccc3(255,119,87))
				local widget = dbUIWidget:widgetWithSprite(contentMsgTx)
				self.scrollList:insterWidget(widget)
				
			elseif GlobalChatData.receiverId[i] == ClientData.role_id and GlobalChatData.senderId[i] == self.friendRoleId then
			
				local contentMsgTx = CCLabelTTF:labelWithString(self.friendName..":  "..GlobalChatData.privateContent[i], CCSizeMake(750,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 24)
				contentMsgTx:setAnchorPoint(CCPoint(0, 0))
				contentMsgTx:setColor(ccc3(255,194,106))
				local widget = dbUIWidget:widgetWithSprite(contentMsgTx)
				self.scrollList:insterWidget(widget)
				
			end

		end
		self.scrollList:m_setPosition(CCPoint(0,0))
		
	end,
	
	sendChatContent = function(self)
		
		if self.inputText:getString() == nil or self.inputText:getString() =="" then
			return
		end
		
		local function opPrivateSendFinishCB(s)
			closeWait()
			print("Lua ============= opPrivateSendFinishCB ===============")

			print(s:getByKey("error_code"):asInt())
			if s:getByKey("error_code"):asInt() == -1 then
			
				local contentMsgTx = CCLabelTTF:labelWithString(ClientData.role_name..":  "..self.inputText:getString(), CCSizeMake(750,0), CCTextAlignmentLeft, SYSFONT[EQUIPMENT], 24)
				contentMsgTx:setAnchorPoint(CCPoint(0, 0))
				contentMsgTx:setColor(ccc3(255,119,87))
				local widget = dbUIWidget:widgetWithSprite(contentMsgTx)
				self.scrollList:insterWidget(widget)
				self.scrollList:m_setPosition(CCPoint(0,0))
				
				self.inputText:setString("")
			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end

		end

		local function opPrivateSendFailedCB(s)
			closeWait()
			print("Lua ============= opPrivateSendFailedCB ===============")
		end

		local function execPrivateSend()
			showWaitDialog("waiting send data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_SendPrivateMessage, opPrivateSendFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_SendPrivateMessage, opPrivateSendFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)

			cj:setByKey("target_id",self.friendRoleId)
			cj:setByKey("content",self.inputText:getString())  --说话内容
				
			NetMgr:executeOperate(Net.OPT_SendPrivateMessage, cj)
			print("Lua $$$$$ Execute OPT_SendPrivateMessage $$$$$")
		end
		execPrivateSend()
	end,
	
	checkMessage = function(self)
		
		local function opCheckFinishCB(s)
			--closeWait()
			--WaitDialog.closePanelFunc()
			print("Lua ============= opCheckFinishCB ===============")
			print(s:getByKey("error_code"):asInt())
			if s:getByKey("error_code"):asInt() == -1 then
			
				if s:getByKey("private_message_list"):size() > 0 then
					GlobalChatData:addPrivateData(s)
					self:addChatContent()
				end	
				
			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end

		end

		local function opCheckFailedCB(s)
			--WaitDialog.closePanelFunc()
			--closeWait()
			print("Lua ============= opCheckFailedCB ===============")
		end

		local function execCheck()
		
			if GlobalChatData == nil then
				return
			end
		
			--showWaitDialog("waiting check data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_CheckPrivateMessage, opCheckFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_CheckPrivateMessage, opCheckFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
				
			NetMgr:executeOperate(Net.OPT_CheckPrivateMessage, cj)
			print("Lua $$$$$ Execute OPT_CheckPrivateMessage $$$$$")
		end
			
		if self.checkHandle == nil then
			self.checkHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(execCheck,5,false)
		else
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.checkHandle)
			self.checkHandle = nil
			self.checkHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(execCheck,5,false)
		end
		
	end,
	stopCheckMsg = function(self)
		if self.checkHandle ~= nil then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.checkHandle)
			self.checkHandle = nil
		end
	end,
	addFriend = function(self)
		local function opAddFriendFinishCB(s)
			closeWait()
			print("Lua ============= opAddFriendFinishCB ===============")

			print(s:getByKey("error_code"):asInt())
			if s:getByKey("error_code"):asInt() == -1 then
			------------------提示面板--------------
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ADD_FRIEND_SUCCESS,ccc3(255,0,0),0)
				--------------------------------------------------
				self.radiosBtn[2]:setIsVisible(false)
				self.radiosBtn[3]:setIsVisible(true)

			else
				local createPanel = new(SimpleTipPanel)
				local eId = s:getByKey("error_code"):asInt()
				createPanel:create(ERROR_CODE_DESC[eId],ccc3(255,0,0),0)
				if eId == 325 then
					self.radiosBtn[2]:setIsVisible(false)
					self.radiosBtn[3]:setIsVisible(true)
				end
			end

		end

		local function opAddFriendFailedCB(s)
			closeWait()
			print("Lua ============= opAddFriendFailedCB ===============")
		end

		local function execAddFriend()
			showWaitDialog("waiting add data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FriendAction, opAddFriendFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FriendAction, opAddFriendFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("target_id",self.friendRoleId) --friend_id
			cj:setByKey("action",1)   --1增加好友，2删除好友
			
			NetMgr:executeOperate(Net.OPT_FriendAction, cj)
			print("Lua $$$$$ Execute OPT_FriendAction $$$$$")
		end
		execAddFriend()
	end,
	deleteFriend = function(self)
		local function opDeleteFriendFinishCB(s)
			closeWait()
			print("Lua ============= opDeleteFriendFinishCB ===============")
			
			print(s:getByKey("error_code"):asInt())
			if s:getByKey("error_code"):asInt() == -1 then
			------------------提示面板----------------------
				local createPanel = new(SimpleTipPanel)
				createPanel:create(DEL_FRIEND_SUCCESS,ccc3(255,0,0),0)
			---------------------------------------

			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,0,0),0)
			end

		end

		local function opDeleteFriendFailedCB(s)
			closeWait()
			print("Lua ============= opDeleteFriendFailedCB ===============")
		end

		local function execDeleteFriend()
			showWaitDialog("waiting delete data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FriendAction, opDeleteFriendFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FriendAction, opDeleteFriendFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("target_id",self.friendRoleId) --friend_id
			cj:setByKey("action",2)   --1增加好友，2删除好友
 		
			NetMgr:executeOperate(Net.OPT_FriendAction, cj)
			print("Lua $$$$$ Execute OPT_FriendAction $$$$$")
		end
		execDeleteFriend()
	end,
	
	destroy = function(self)
		if self.checkHandle ~= nil then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.checkHandle)
			self.checkHandle = nil
		end
	
		GloblePrivateMainPanel:destroy()
		GloblePrivatePanel = nil
		GloblePrivateMainPanel = nil
    end,
}

PrivateMessageMainPanel = 
{
	bgLayer = nil,
    uiLayer = nil,
    centerWidget = nil,

    create = function(self)
    	local scene = DIRECTOR:getRunningScene()

    	self.bgLayer = createSystemPanelBg()
		local bg = dbUIWidgetTiledBG:tiledBG("UI/public/recuit_bg.png",WINSIZE)
		bg:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
		bg:setScale(1/SCALEY)
		bg:setAnchorPoint(CCPoint(0,0))
		self.bgLayer:addChild(bg)
		--遮掩层
		local mask = dbUIPanel:panelWithSize(WINSIZE)
		mask:setPosition(WINSIZE.width / 2, WINSIZE.height / 2)
		mask:setScale(1/SCALEY)
		mask:setAnchorPoint(CCPoint(0.5,0.5))
		self.bgLayer:addChild(mask)
		
        self.uiLayer,self.centerWidget = createCenterWidget()

        scene:addChild(self.bgLayer, 2011)
	    scene:addChild(self.uiLayer, 2012)

        return self
    end,
	

    destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
        self.bgLayer = nil
        self.uiLayer = nil
        self.centerWidget = nil
    end
}

function GolbalCreatePrivateMsg(id,name,is_friend)
	if FirstOpenChatPanel == true then
	
		GlobleChatMainPanel = new(ChatMainPanel)
		GlobleChatMainPanel:create()
		
		GlobleChatPanel = new(ChatPanel)
	--@@	local ltPanelL = GlobleChatPanel:create(GlobleChatMainPanel.centerWidget)
		 GlobleChatFriends= GlobleChatPanel:create(GlobleChatMainPanel.centerWidget)
		--GlobleChatMainPanel.centerWidget:addChild(ltPanelL)
		FirstOpenChatPanel = false
		
	--GloblePrivateMainPanel = new(PrivateMessageMainPanel)
	--GloblePrivateMainPanel:create()
		
		GloblePrivatePanel = new(PrivateMessagePanel)
		local ltPanelL = GloblePrivatePanel:create(id,name,is_friend,GlobalListPanel.msgPanel)
	--local ltPanelL = GloblePrivatePanel:create(id,name,is_friend,GloblePrivateMainPanel.centerWidget)
	else
			if GloblePrivatePanel ~=nil then
			--GloblePrivatePanel.chatLayer:removeFromParentAndCleanup(true)
			--	GloblePrivatePanel.chatLayer=nil
			--GloblePrivatePanel = new(PrivateMessagePanel)
		
			GloblePrivatePanel:create(id,name,is_friend,GlobalListPanel.msgPanel)
			else
			GloblePrivatePanel = new(PrivateMessagePanel)
		
			GloblePrivatePanel:create(id,name,is_friend,GlobalListPanel.msgPanel)
			end
	end
	
end

     
	


--全局接口,进入天赋面板
function globle_create_tian_fu()
	createTianFuPanel()
	local response = function(json)
		closeWait()
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			initTalentData(json)
			GlobleTianFuPanel.tfp:reflash(1)
			GotoNextStepGuide()
		end
	end
	local sendRequest = function ()
		showWaitDialog("waiting skillLock!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_Talent,response)
		NetMgr:registOpLuaFailedCB(Net.OPT_Talent,closeWait)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(Net.OPT_Talent, cj)
	end
	sendRequest()
end

--刷新
function ReflashTianfuPanel(type)
	GlobleTianFuPanel.tfp:reflash(type)
end

--创建天赋界面
function createTianFuPanel()
	GlobleTianFuPanel = new(TianFuMainPanel)
	GlobleTianFuPanel:create(1)

	local tfp = new(TianFuPanel):create()
	GlobleTianFuPanel.mainWidget:addChild(tfp.bg)
	GlobleTianFuPanel.tfp = tfp
end

--创建天赋面板
TianFuMainPanel = {
	bgLayer = nil,
	uiLayer = nil,
	topBtns = nil,
	centerWidget = nil,
	mainWidget = nil,

	create = function(self,topid)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1004)
		scene:addChild(self.uiLayer, 2004)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))
		self.centerWidget:addChild(bg)

		local topbtn = new(TianFuTopButton)
		topbtn:create()
		self.topBtns = topbtn.toggles
		self.centerWidget:addChild(topbtn.bg,100)
		self.closeBtn = topbtn.closeBtn
		
		--注册开关切换事件
		for i = 1 , table.getn(topbtn.toggles) do
			topbtn.toggles[i].m_nScriptClickedHandler = function()
				if (topbtn.toggles[i]:isToggled()) then
					ReflashTianfuPanel(i)
				end
				topbtn:toggle(i)
			end
		end

		--关闭按钮
		topbtn.closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
			GotoNextStepGuide()
		end

		--topbtn:toggle(topid)

		self.centerWidget:addChild(self.mainWidget)
		self.exploitLabel = topbtn.exploitLabel
	end,

	clearMainWidget = function(self)
		self.mainWidget:removeAllChildrenWithCleanup(true)
	end,

	topBtnsTouchable = function(self, touch)	--服务器请求时，设置不可切换
		for i = 1, #self.topBtns do
			self.topBtns[i]:setIsEnabled(touch)
		end
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.topBtns = nil
		self.centerWidget = nil
		self.mainWidget = nil
		
		DestroyTianFuCountdownTimeHandle()
		
		GlobleTianFuPanel = nil
		GlobleTianFuUpdateFinished = nil
		removeUnusedTextures()
	end
}

TianFuTopButton = {
	bg = nil,
	toggles = {},
	closeBtn = nil,
	backBtn = nil,

	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(0,598))
		for i = 1 , table.getn(TianFuTopBtnConfig) do
			local btn = CCSprite:spriteWithFile(TianFuTopBtnConfig[i].normal)--,TianFuTopBtnConfig[i].toggle)
			btn:setAnchorPoint(CCPoint(0, 0))
			btn:setPosition(TianFuTopBtnConfig[i].position)
			--self.toggles[i] = btn
			self.bg:addChild(btn)
		end

	--战功
		local zhangong = CCSprite:spriteWithFile("UI/tian_fu/zg.png")
--		label:setColor(ccc3(102,61,5))
		zhangong:setAnchorPoint(CCPoint(0,0))
		zhangong:setPosition(CCPoint(430+25,20+5))
		self.bg:addChild(zhangong)
		local label = CCLabelTTF:labelWithString(GloblePlayerData.exploit,CCSize(300,0),0, SYSFONT[EQUIPMENT], 27)
		label:setColor(ccc3(254,205,52))
		label:setAnchorPoint(CCPoint(0, 0.5))
		label:setPosition(CCPoint(520,25 + zhangong:getContentSize().height / 2))
		self.bg:addChild(label)
		self.exploitLabel = label

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		self.bg:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
	end,

	--切换
	--[[toggle = function(self,topid)
		public_toggleRadioBtn(self.toggles,self.toggles[topid])
	end
	--]]
}
TianFuTopBtnConfig = {
	{
		normal = "UI/tian_fu/jc_1.png",
		--toggle = "UI/tian_fu/jc_2.png",
		position = 	CCPoint(0, 12),
	},
	--[[
	{
		normal = "UI/tian_fu/zd_1.png",
		toggle = "UI/tian_fu/zd_2.png",
		position = 	CCPoint(224, 12),
	},
	--]]
}
TalentData = {
	talent_list = {},
	point = nil ,
	cd_time = 0,
	skill_list={},
	talent_cfg = {},
}
talentData = new (TalentData)
initTalentData = function (json)
	talentData.talent_list  = new ({})
	local talent_list = json:getByKey("talent_list")
	if talent_list~=nil then
		local talent_json_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_talent.json")
		for i = 1 , talent_list:size() do
			local data  = talent_json_cfg:getByKey(tostring(talent_list:getByIndex(i-1):getByKey("cfg_talent_id"):asInt()))
			talentData.talent_list[i] =
			{
				level = talent_list:getByIndex(i-1):getByKey("level"):asInt(),
				cfg_talent_id= talent_list:getByIndex(i-1):getByKey("cfg_talent_id"):asInt(),
				class = data:getByKey("type"):asInt(),
				require_point = data:getByKey("require_point"):asInt(),
				require_officium = data:getByKey("require_officium"):asInt(),
				require_job = data:getByKey("require_job"):asInt(),
				name = data:getByKey("name"):asString(),
				max_level = data:getByKey("max_level"):asInt(),
				level_param = data:getByKey("level_param"):asInt(),
				icon = data:getByKey("icon"):asInt(),
				enhance_value = data:getByKey("enhance_value"):asDouble(),
				enhance_type =data:getByKey("enhance_type"):asInt(),
				enhance_effect =data:getByKey("enhance_effect"):asInt(),
				desc =data:getByKey("desc"):asString(),
			}
		end

		talentData.point = json:getByKey("point"):asInt()
		talentData.cd_time = json:getByKey("cd_time"):asInt()
		GloblePlayerData.gold = json:getByKey("gold"):asInt()
		GloblePlayerData.copper = json:getByKey("copper"):asInt()
		GloblePlayerData.exploit = json:getByKey("exploit"):asInt()
		updataHUDData()
	end
	getRoleAllTalents()
	getRoleAllSkills()
end

getRoleAllTalents = function ()
	talentData.talent_cfg  = new ({})
	local talent_index = 1
	local talent_json_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_talent.json")
	for i = 0 , talent_json_cfg:size() do
		local data  = talent_json_cfg:getByKey(i)
		local jobJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_job.json")
		if  GloblePlayerData.officium >= data:getByKey("require_officium"):asInt()
		and data:getByKey("icon"):asInt()~=0
		and talentData.point >= data:getByKey("require_point"):asInt()
		--and (GloblePlayerData.role_job == data:getByKey("require_job"):asInt()
		and data:getByKey("require_job"):asInt()==0
		--or  jobJsonConfig:getByKey(GloblePlayerData.role_job):getByKey("prev_job"):asInt() == data:getByKey("require_job"):asInt())
		then
			talentData.talent_cfg[talent_index] =
			{
				level = 0,
				cfg_talent_id= data:getByKey("cfg_talent_id"):asInt(),
				class = data:getByKey("type"):asInt(),
				require_point = data:getByKey("require_point"):asInt(),
				require_officium = data:getByKey("require_officium"):asInt(),
				require_job = data:getByKey("require_job"):asInt(),
				name = data:getByKey("name"):asString(),
				max_level = data:getByKey("max_level"):asInt(),
				level_param = data:getByKey("level_param"):asInt(),
				icon = data:getByKey("icon"):asInt(),
				enhance_value = data:getByKey("enhance_value"):asDouble(),
				enhance_type =data:getByKey("enhance_type"):asInt(),
				enhance_effect =data:getByKey("enhance_effect"):asInt(),
				desc =data:getByKey("desc"):asString(),
			}

			for y = 1,table.getn(talentData.talent_list) do
				if talentData.talent_list[y].cfg_talent_id == talentData.talent_cfg[talent_index].cfg_talent_id then
					talentData.talent_cfg[talent_index].level = talentData.talent_list[y].level
				end
			end

			talent_index = talent_index+1
		end
	end
end
getRoleAllSkills = function ()
	talentData.skill_list  = new ({})
	local skill_index = 1
	local job_list = getSkillAwalenTableForJob(GloblePlayerData.role_job)
	local talent_json_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_talent.json")
	for i = 0 , talent_json_cfg:size() do
		local data  = talent_json_cfg:getByKey(i)
		if data:getByKey("type"):asInt()==1 then
			local require_job = data:getByKey("icon"):asInt()
			for x =1 , table.getn(job_list) do
				if job_list[x] == require_job then
					talentData.skill_list[skill_index] =
					{
						level = 0,
						cfg_talent_id= i,
						class = data:getByKey("type"):asInt(),
						require_point = data:getByKey("require_point"):asInt(),
						require_officium = data:getByKey("require_officium"):asInt(),
						require_job = data:getByKey("require_job"):asInt(),
						name = data:getByKey("name"):asString(),
						max_level = data:getByKey("max_level"):asInt(),
						level_param = data:getByKey("level_param"):asInt(),
						icon = data:getByKey("icon"):asInt(),
						enhance_value = data:getByKey("enhance_value"):asDouble(),
						enhance_type =data:getByKey("enhance_type"):asInt(),
						enhance_effect =data:getByKey("enhance_effect"):asInt(),
						desc =data:getByKey("desc"):asString(),
					}
					for y = 1,table.getn(talentData.talent_list) do
						if talentData.talent_list[y].cfg_talent_id == talentData.skill_list[skill_index].cfg_talent_id then
							talentData.skill_list[skill_index].level = talentData.talent_list[y].level
						end
					end
					skill_index = skill_index+1
				end
			end
		end
	end
end
getLearnRequire= function (data)
	local level = data.level + 1
	local exploitCost = 0

	if level >= 1 and level <= 30 then
		exploitCost = level * data.level_param
	elseif level >= 31 and level <= 50 then
		exploitCost = (level - 30) * 2 * data.level_param + 30 * data.level_param
	elseif level >= 51 and level <= 70 then
		exploitCost = (level - 50) * 4 * data.level_param + 70 * data.level_param		
	elseif level >= 71 and level <= 90 then
		exploitCost = (level - 70) * 8 * data.level_param + 150 * data.level_param
	elseif level >= 91 and level <= 100 then
		exploitCost = (level - 90) * 20 * data.level_param + 310 * data.level_param
	end
	
	return {
		exploitCost = exploitCost
	}
	--消耗战功：升级后的天赋等级l，天赋类型：技能强化：m=需求参数+30，能力增强：m=需求参数+需求神位+25，属性提升：m=需求参数+需求神位+50，技能激活：m=需求参数+需求神位+1000。战功=（m*8.75）*（2*l-1）；如果l>20，战功=战功*2
end
TianFuCountdownTimeHandle = nil
DestroyTianFuCountdownTimeHandle = function()
	if TianFuCountdownTimeHandle then
		CCScheduler:sharedScheduler():unscheduleScriptEntry(TianFuCountdownTimeHandle)
		TianFuCountdownTimeHandle = nil
	end
end

--天赋  技能强化 面板
TianFuPanel = {
	bg = nil,
	kuangs = {},
	list= {}, --技能 或 能力 列表
	type = 1, -- 1 表示能力 2 表示技能
	selected = nil, --当前选中的技能或天赋
	
	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 598))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(0,0))
		self:createLeft()
		self:createRight()
		return self
	end,
	
	--刷新界面
	reflash = function(self,type)
		DestroyTianFuCountdownTimeHandle()
		if self.left then
			self.bg:removeChild(self.left,true)
			self.left = nil
		end
		if self.right then
			self.bg:removeChild(self.right,true)
			self.right = nil
		end
		if type~=nil and type~=self.type then --如果切换了类型，则清除选择的技能或能力
			self.selected = nil
			self.type=type
		end
		self.list = (self.type ==1 and  talentData.talent_cfg or talentData.skill_list)
		GlobleTianFuPanel.exploitLabel:setString(GloblePlayerData.exploit)
		self:createRight()
	end,

	createLeft = function(self,item)
		if self.left then
			DestroyTianFuCountdownTimeHandle()
			self.bg:removeChild(self.left,true)
			self.left = nil
		end

		self.left=createDarkBG(336,545)
		self.left:setPosition(CCPoint(40,38))
		self.left:setAnchorPoint(CCPoint(0,0))
		self.bg:addChild(self.left)
		
		if item==nil then
			return
		end

		--图标
		local tianfuIcon = CCSprite:spriteWithFile("icon/Tianfu/icon_tianfu_"..item.icon..".png")
		tianfuIcon:setPosition(CCPoint(96/2,96/2))
		tianfuIcon:setAnchorPoint(CCPoint(0.5, 0.5))
		tianfuIcon:setScale(0.90*96/tianfuIcon:getContentSize().width)
		local kuangIcon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
		kuangIcon:setPosition(16, 423)
		kuangIcon:setAnchorPoint(CCPoint(0, 0))
		kuangIcon:addChild(tianfuIcon)
		self.left:addChild(kuangIcon)
		
		--名称		
		local label = CCLabelTTF:labelWithString("名称：",CCSize(150,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(254,205,102))
		label:setPosition(CCPoint(120,500-20))
		self.left:addChild(label)
		local label = CCLabelTTF:labelWithString(item.name,CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(153,204,1))
		label:setPosition(CCPoint(190,500-20))
		self.left:addChild(label)
		
		--等级		
		local label = CCLabelTTF:labelWithString("等级：",CCSize(150,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(254,205,102))
		label:setPosition(CCPoint(120,470-20))
		self.left:addChild(label)
		local label = CCLabelTTF:labelWithString(item.level.."级",CCSize(150,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(248,100,0))
		label:setPosition(CCPoint(190,470-20))
		self.left:addChild(label)
		
		--介绍
		local infoBg = createBG("UI/tian_fu/info_kuang.png",308,130)
		infoBg:setAnchorPoint(CCPoint(0.5,0))
		infoBg:setPosition(CCPoint(336/2,273))
		self.left:addChild(infoBg)
		local label = CCLabelTTF:labelWithString(item.desc,CCSize(300,130),0, SYSFONT[EQUIPMENT], 22)
		label:setColor(ccc3(102,50,0))
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(308/2,0))
		infoBg:addChild(label)
		
		local data  = getLearnRequire(item)
		--下一级要求
		local label = CCLabelTTF:labelWithString("下一级要求",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setColor(ccc3(153,205,0))
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(326/2,222))
		self.left:addChild(label)

		--战功
		local labelBg = CCSprite:spriteWithFile("UI/tian_fu/label_bg.png")
		labelBg:setAnchorPoint(CCPoint(0.5,0))
		labelBg:setPosition(CCPoint(326/2,175))
		self.left:addChild(labelBg)
		local label = CCLabelTTF:labelWithString("战功："..public_chageShowTypeForMoney(data.exploitCost,true),CCSize(0,0),0, SYSFONT[EQUIPMENT], 22)
		label:setColor(ccc3(255,204,154))
		label:setAnchorPoint(CCPoint(0.5,0.5))
		label:setPosition(CCPoint(labelBg:getContentSize().width / 2,labelBg:getContentSize().height / 2))
		labelBg:addChild(label)		
		--[[
		local label = CCLabelTTF:labelWithString("神位：",CCSize(200,0),0, SYSFONT[EQUIPMENT], 32)
		label:setColor(ccc3(254,205,102))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(100,120))
		self.left:addChild(label)				
		local label = CCLabelTTF:labelWithString(item.require_officium.."级",CCSize(200,0),0, SYSFONT[EQUIPMENT], 32)
		label:setColor(ccc3(248,100,0))
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(190,120))
		self.left:addChild(label)
		]]
		--升级按钮
		local btn = dbUIButton:buttonWithImage("UI/tian_fu/update.png")
		btn:setPosition(CCPoint(336/2,50))
		btn:setAnchorPoint(CCPoint(0.5, 0))
		btn.m_nScriptClickedHandler = function(ccp)
			self:update(item)
		end
		self.left:addChild(btn)
		self.updateBtn = btn
	
		local btn = dbUIButton:buttonWithImage("UI/arena/cooldown.png")
		btn:setPosition(CCPoint(10,25))
		btn:setAnchorPoint(CCPoint(0, 0))
		btn.m_nScriptClickedHandler = function(ccp)
			local gold = math.ceil(talentData.cd_time / 60)
			new(ConfirmDialog):show({
				text = "确定花费"..gold.."金清除冷却吗？",
				width = 440,
				onClickOk = function()
					self:clearCooldown()
				end
			})
		end
		self.left:addChild(btn)
		self.cdClearBtn = btn
		local label = CCLabelTTF:labelWithString("冷却时间："..getLenQueTime(talentData.cd_time),CCSize(400,0),0, SYSFONT[EQUIPMENT], 22)
		label:setColor(ccc3(248,100,0))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(170,45))
		self.left:addChild(label)
		self.cdLabel = label
		
		if talentData.cd_time > 0 then
			self.updateBtn:setIsVisible(false)
			
			local update = function()
				if talentData.cd_time > 0 then
					talentData.cd_time = talentData.cd_time - 1
				end
				if talentData.cd_time==0 then
					self.cdLabel:setIsVisible(false)
					self.cdClearBtn:setIsVisible(false)
					self.updateBtn:setIsVisible(true)
					DestroyTianFuCountdownTimeHandle()
				else
					label:setString("冷却时间："..getLenQueTime(talentData.cd_time))
				end		
			end
			
			if TianFuCountdownTimeHandle == nil then
				TianFuCountdownTimeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(update,1,false)
			end
		else
			self.cdLabel:setIsVisible(false)
			self.cdClearBtn:setIsVisible(false)
		end
	end,
		
	createRight = function(self)
		self.right=createDarkBG(584,545)
		self.right:setPosition(CCPoint(389,38))
		self.right:setAnchorPoint(CCPoint(0,0))
		self.bg:addChild(self.right)
		
		local sum = table.getn(self.list)
		local pageCount = math.floor(sum/20)
		if sum%20 ~=0 or sum==0 then
			pageCount = pageCount+1
		end
		
		local scrollPanel = dbUIPanel:panelWithSize(CCSize(584 * pageCount, 440))
		scrollPanel:setAnchorPoint(CCPoint(0, 0))
		scrollPanel:setPosition(0,0)
		for i =1, pageCount do
			local single = self:createSinglePanel(i)
			scrollPanel:addChild(single)
		end
		self:createTianFuIcons()
		
		--滑动的区域
		local scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(scrollPanel, 1, pageCount)
		scrollArea:setScrollRegion(CCRect(0, 0, 584, 440))
		scrollArea:setAnchorPoint(CCPoint(0, 0))
		scrollArea:setPosition(0,90)
		scrollArea.pageChangedScriptHandler = function(page)
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[page+1])
		end
		self.right:addChild(scrollArea)		
		self:createPage(scrollArea,pageCount)
		
		--默认打开第一个天赋
		if sum > 0 and self.selected==nil then
			self:createLeft(self.list[1])
		elseif self.selected~=nil then
			self:createLeft(self.selected)
		end
	end,
	
	--创建天赋图标
	createTianFuIcons = function(self)
		local count = table.getn(self.list)
		for i = 1 , count do
			local item = self.list[i]
			local icon  = dbUIButtonScale:buttonWithImage("icon/Tianfu/icon_tianfu_"..item.icon..".png", 1, ccc3(125, 125, 125))
			icon:setAnchorPoint(CCPoint(0.5, 0.5))
			icon:setPosition(CCPoint(48,48))
			icon:setScale(0.90*96/icon:getContentSize().width)
			icon.m_nScriptClickedHandler = function(ccp)
				self.selected = item
				self:createLeft(item)
			end
			local level = CCLabelTTF:labelWithString(item.level, SYSFONT[EQUIPMENT], 32)
			level:setAnchorPoint(CCPoint(0, 0))
			level:setPosition(CCPoint(0,0))
			level:setScale(1/icon:getScale())
			icon:addChild(level)
			
			self.kuangs[i]:addChild(icon)
		end	
	end,
	
	--创建单页
	createSinglePanel = function(self,page)
		local singlePanel = dbUIPanel:panelWithSize(CCSize(584, 440))
		singlePanel:setAnchorPoint(CCPoint(0, 0))
		singlePanel:setPosition((page-1)*584,0)

		for i=1,20 do
			local row = math.floor(i/5)
			if i%5 ~=0 then
				row = row +1
			end
			local cell = i%5
			if cell==0 then
				cell = 5
			end
			
			local kuangIcon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			kuangIcon:setPosition(0,0)
			kuangIcon:setAnchorPoint(CCPoint(0, 0))
			
			local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
			kuang:setAnchorPoint(CCPoint(0, 0))
			kuang:setPosition(24+(cell-1)*110, 330-(row-1)*110)
			kuang:addChild(kuangIcon)
			singlePanel:addChild(kuang)
			self.kuangs[(page-1)*20 + i] = kuang
		end
		return singlePanel
	end,
	
	--分页按钮
	createPage = function(self,scrollArea,pageCount)
		self.pageToggles = {}
		local width = pageCount*33 + (pageCount-1)*19
		for i=1,pageCount do
			local normalSpr = CCSprite:spriteWithFile("UI/public/page_btn_normal.png")
			local togglelSpr = CCSprite:spriteWithFile("UI/public/page_btn_toggle.png")		
			local toggle = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
			toggle:setAnchorPoint(CCPoint(0, 0))
			toggle:setPosition((584-width)/2+52*(i-1),20)
			toggle.m_nScriptClickedHandler = function()
				scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,self.pageToggles[i])
			end
			self.right:addChild(toggle)
			self.pageToggles[i]=toggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[1])
	end,
	
	--提升天赋或技能
	update = function(self,item)
		local Repsonse = function (json)
			if GlobleTianFuPanel then
				GlobleTianFuPanel:topBtnsTouchable(true)
			end
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				executeGenerals()
				initTalentData(json)
				local list = (self.type ==1 and  talentData.talent_cfg or talentData.skill_list)
				for i=1, table.getn(list) do
					if list[i].cfg_talent_id == item.cfg_talent_id then
						self.selected = list[i]
						break
					end
				end
				if GlobleTianFuPanel then
					self:reflash(self.type)
				end
				GlobleTianFuUpdateFinished = true
			end
			
			GotoNextStepGuide()
		end
		local sendRequest = function ()
			--发送请求
			NetMgr:registOpLuaFinishedCB(Net.OPT_TalentUp,Repsonse)
			NetMgr:registOpLuaFailedCB(Net.OPT_TalentUp,opFailedCB)
			local cj = Value:new()
			
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("cfg_talent_id", item.cfg_talent_id)
			
			GlobleTianFuPanel:topBtnsTouchable(false)
			NetMgr:setOpUnique(Net.OPT_TalentUp)
			NetMgr:executeOperate(Net.OPT_TalentUp, cj)
		end 		
		sendRequest()	
	end,

	--清除技能冷却时间
	clearCooldown = function(self)
		local Repsonse = function (json)
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				talentData.cd_time = 0
			end
		end
		
		local sendRequest = function ()
			NetMgr:registOpLuaFinishedCB(Net.OPT_TalentClearCooldown,Repsonse)
			NetMgr:registOpLuaFailedCB(Net.OPT_TalentClearCooldown,opFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			
			NetMgr:setOpUnique(Net.OPT_TalentClearCooldown)
			NetMgr:executeOperate(Net.OPT_TalentClearCooldown, cj)
		end 		
		sendRequest()	
	end,	
}
--强化主界面，包括强化，镶嵌，宝石合成，说明  默认为强化
function globleShowQHPanel()
	GlobleQHPanel = new(QHMainPanel)
	GlobleQHPanel.curGenerals = GloblePanel.curGenerals==nil and 1 or GloblePanel.curGenerals
    GlobleQHPanel:create(1)
	createQiangHua()
end
function globleShowShengji()
	local step_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_step.json")
	local zb_sj_open = step_cfg:getByKey("zb_sj_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--装备升级开启
	if zb_sj_open then
		GlobleQHPanel = new(QHMainPanel)
		GlobleQHPanel.curGenerals = GloblePanel.curGenerals==nil and 1 or GloblePanel.curGenerals
	    GlobleQHPanel:create(2)
		createEquipComposite()
	else
		alert("功能暂未开启")
	end
end
function globleShowComposite()
	GlobleQHPanel = new(QHMainPanel)
	GlobleQHPanel.curGenerals = GloblePanel.curGenerals==nil and 1 or GloblePanel.curGenerals
    GlobleQHPanel:create(2)
	createEquipComposite()
end
function globleShowXiangQian()
	GlobleQHPanel = new(QHMainPanel)
	GlobleQHPanel.curGenerals = GloblePanel.curGenerals==nil and 1 or GloblePanel.curGenerals
    GlobleQHPanel:create(3)
	createXiangQian()
end
function globleShowHeCheng()
	local step_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_step.json")
	local hecheng_open = step_cfg:getByKey("hecheng_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--宝石合成继承
	if hecheng_open then
		GlobleQHPanel = new(QHMainPanel)
		GlobleQHPanel.curGenerals = GloblePanel.curGenerals==nil and 1 or GloblePanel.curGenerals
	    GlobleQHPanel:create(4)
		createHeCheng()
	else
		alert("功能暂未开启")
	end
end

--强化
function createQiangHua()
	createQHCenterBg(1)
	local qhp = new(QHQiangHuaPanel)
	qhp:create()
	GlobleQHPanel.mainWidget:addChild(qhp.bg)
	GlobleQHPanel.qhp = qhp
	GotoNextStepGuide()
end
--装备合成
function createEquipComposite()
	createQHCenterBg(1)
	local eqcomp = new(QHEquipCompositePanel)
	eqcomp:create()
	GlobleQHPanel.mainWidget:addChild(eqcomp.bg)
	GlobleQHPanel.eqcomp = eqcomp
end
--镶嵌
function createXiangQian()
	createQHCenterBg(1)
	local xqp = new(QHXiangQianPanel)
	xqp:create()
	GlobleQHPanel.mainWidget:addChild(xqp.bg)
	GlobleQHPanel.xqp = xqp
end
--宝石合成
function createHeCheng()
	createQHCenterBg(1)
	local hcp = new(QHHeChengPanel)
	hcp:create()
	GlobleQHPanel.mainWidget:addChild(hcp.bg)
	GlobleQHPanel.hcp = hcp
end

function createQHCenterBg(topid)
	local bgImg = nil
    if topid==nil or topid==1 then
      	bgImg = "UI/public/bg_light.png"
    else
      	bgImg = "UI/public/bg.png"
    end
    local bg = CCSprite:spriteWithFile(bgImg)
    bg:setPosition(CCPoint(1010/2, 702/2)) 
    GlobleQHPanel.mainWidget:addChild(bg)
end

--[[
	打造主面板
	bgLayer -->> 背景层 至于场景层前层 与 UI面板层后面 所在层1000
	uiLayer -->> UI控件层 所在层2000
	centerWidget -->> 该空间为1024*768的容器 居中显示 所有需要显示的内容将添加在这上面

	topBtns -->> 顶部标签按钮 占用 1010*85的空间
	mainWidget -->> 内容容器 1010*683

	create() -->> 创建一个面板 需要参数mainPanel topid(默认按下topBtn)
	clearMainWidget() -->> 清空MainWidget 上面所有的内容
	destroy() -->>
--]]
QHMainPanel = {
    bgLayer = nil,
    uiLayer = nil,
    topBtns = nil,
    centerWidget = nil,
    mainWidget = nil,

    create = function(self,topid)
    	local scene = DIRECTOR:getRunningScene()

    	self.bgLayer = createPanelBg()
        self.uiLayer,self.centerWidget = createCenterWidget()
       
		self.mainWidget = createMainWidget()

        scene:addChild(self.bgLayer, 1004)
	    scene:addChild(self.uiLayer, 2004)

		local topbtn = new(QHTopButton)
		topbtn:create()
		self.topBtns = topbtn.toggles		
		self.centerWidget:addChild(topbtn.bg,100)
		
		--注册开关切换事件
		for i = 1 , table.getn(topbtn.toggles) do
			topbtn.toggles[i].m_nScriptClickedHandler = function()
				if (topbtn.toggles[i]:isToggled()) then
                    self:clearMainWidget()
					if i == 1 then
						createQiangHua()
					end
					if i == 2 then
						createEquipComposite()
					end					
					if i == 3 then
						createXiangQian()
					end
					if i == 4 then
						createHeCheng()
					end
				end
				topbtn:toggle(i)
			end
		end
		
		--关闭按钮
		topbtn.closeBtn.m_nScriptClickedHandler = function()		
			--executeRoleSimple()
			GotoNextStepGuide()
			self:destroy()
			GloblePanel.curGenerals = GloblePlayerData.roleIndex
			if GlobleQHPanel~=nil then
				GlobleQHPanel:destroy()
				GlobleQHPanel=nil
			end
		end

		topbtn:toggle(topid)
		self.closeBtn = topbtn.closeBtn;
		
		self.centerWidget:addChild(self.mainWidget)
    end,

	clearMainWidget = function(self)
		if GlobleQHPanel.qhp then
			GlobleQHPanel.qhp:unschedule()
		end
		self.mainWidget:removeAllChildrenWithCleanup(true)
	end,

    destroy = function(self)
        if GlobleQHPanel.qhp then
			GlobleQHPanel.qhp:unschedule()
		end
		
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
        self.bgLayer = nil
        self.uiLayer = nil
        self.topBtns = nil
        self.centerWidget = nil
        self.mainWidget = nil
        
        GlobleQHPanel.hpp = nil
        GlobleQHPanel.qhp = nil
        GlobleQHPanel.bbp = nil
        GlobleQHPanel.jcp = nil
        GlobleQHPanel.hsr = nil
        GlobleQHPanel.tfp = nil
        GlobleQHPanel.eqcomp = nil
        Equip_Composite_Cur_General_Index = nil
		Equip_Composite_Cur_Item_Id = 0
        removeUnusedTextures()
    end
}

QHTopBtnConfig = {
	{
		normal = "UI/da_zao/qh_1.png",
		toggle = "UI/da_zao/qh_2.png",
		position = 	CCPoint(104, 12),
	},
	{
		normal = "UI/da_zao/zb_sj_1.png",
		toggle = "UI/da_zao/zb_sj_2.png",
		position = 	CCPoint(104 + 194, 12),
	},
	{
		normal = "UI/da_zao/xq_1.png",
		toggle = "UI/da_zao/xq_2.png",
		position = 	CCPoint(104 + 194*2, 12),
	},
	{
		normal = "UI/da_zao/hc_1.png",
		toggle = "UI/da_zao/hc_2.png",
		position = 	CCPoint(104 + 194*3, 12),
	}
}

QHTopButton = {
	bg = nil,
	toggles = {},
	closeBtn = nil,
	backBtn = nil,
	
	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(0,598))
		
		local step_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_step.json")
		local zb_sj_open = step_cfg:getByKey("zb_sj_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--装备升级开启
		local xiangqian_open = step_cfg:getByKey("xiangqian_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--镶嵌开启
		local hecheng_open = step_cfg:getByKey("hecheng_open"):getByKey("require_officium"):asInt() <= GloblePlayerData.officium	--宝石合成继承
		self.open_cfg = {
			true,
			zb_sj_open,
			xiangqian_open,
			hecheng_open
		}
		
		for i = 1 , table.getn(QHTopBtnConfig) do		
			if self.open_cfg[i] == true then
				local btn = dbUIButtonToggle:buttonWithImage(QHTopBtnConfig[i].normal,QHTopBtnConfig[i].toggle)
				btn:setAnchorPoint(CCPoint(0, 0))
				btn:setPosition(QHTopBtnConfig[i].position)
				self.toggles[i] = btn
				self.bg:addChild(btn)
			end
		end
		
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))			
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		self.bg:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
	end,
	
	--切换
	toggle = function(self,topid)
		public_toggleRadioBtn(self.toggles,self.toggles[topid])
	end
}
--打造 强化 面板
local getCDTime = function()
	local cooldown = GloblePlayerData.forge_cooldown - math.ceil(os.time() - GloblePlayerData.forge_refresh_time)
	cooldown = cooldown > 0 and cooldown or 0
	return cooldown
end

QHQiangHuaPanel = {
	selected = nil, --当前选择的装备
	role = nil,
	bg = nil,
	
	create = function(self)
		self.role = GloblePlayerData.generals[GlobleQHPanel.curGenerals]
		
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 702))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		
		self.rolePanel = new(RoleZhuangBeiPanel)
		self.rolePanel:create()
		self.bg:addChild(self.rolePanel.bg)
		
		self:initClickedHandler()

		self:createCenter()
		self:createRight()
	end,
	
	--注册点击事件
	initClickedHandler = function(self)
		local equips = self.rolePanel.equips
		local toggles = self.rolePanel.toggles
		for i=1,table.getn(equips) do
			toggles[i].m_nScriptClickedHandler = function(ccp)
				public_toggleRadioBtn(toggles,toggles[i])
				self.selected = equips[i].item
				self:refurbishItemInfo(self.selected)
				GotoNextStepGuide()
			end
		end
	end,
	
	--刷新中间显示的数据
	refurbishItemInfo = function(self,item)
		self.bg:removeChild(self.center,true)
		self:createCenter()
		
		local castMoney = forgeMoney(item.forge_price,item.star + 1)
		self.castMoneyLabel:setString(math.floor(castMoney))
		
		local cooldown = getCDTime()
		self.cdLabel:setIsVisible(cooldown > 0)
		self.cdBtn:setIsVisible(cooldown > 0)
	end,
	
	--中间数值面板
	createCenter = function(self)
		local center = createDarkBG(277,545)
		center:setAnchorPoint(CCPoint(0, 0))
		center:setPosition(CCPoint(487, 38))
		self.bg:addChild(center)
		self.center = center
		
		local item = self.selected
		
		--如果没有装备选择的话，显示一个提示信息
		if item==nil then
			local label = CCLabelTTF:labelWithString("选择装备进行强化",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
			label:setAnchorPoint(CCPoint(0.5,0.5))
			label:setPosition(CCPoint(277/2,545/2))
			label:setColor(ccc3(152,203,0))
			center:addChild(label)
			return
		end
		
		--装备名称
		local label = CCLabelTTF:labelWithString(item.name,CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0.5,0.5))
		label:setPosition(CCPoint(277/2,500))
		--根据评级显示不同颜色的名字
		label:setColor(ITEM_COLOR[item.quality])
		center:addChild(label)
		
		--装备等级
		if item.star > 0 then
			local labell = CCLabelTTF:labelWithString("+"..item.star,CCSize(0,0),0, SYSFONT[EQUIPMENT], 20)
			labell:setAnchorPoint(CCPoint(0,0.5))
			labell:setPosition(CCPoint(277-60,500))
			labell:setColor(ccc3(153,204,0))
			center:addChild(labell)
		end
		
		local title_bg = createBG("UI/public/title_bg3.png",150,30,CCSize(0,0))
		local partLabel = CCLabelTTF:labelWithString("装备类型:"..PART_STRING[item.part],CCSize(300,0),0, SYSFONT[EQUIPMENT], 20)
		partLabel:setPosition(CCPoint(title_bg:getContentSize().width+16,30/2))
		partLabel:setAnchorPoint(CCPoint(0.5,0.5))
		partLabel:setColor(ccc3(153,204,0))
		title_bg:addChild(partLabel)
		title_bg:setAnchorPoint(CCPoint(0.5,0.5))
		title_bg:setPosition(CCPoint(center:getContentSize().width/2,460))
		center:addChild(title_bg)
		--装备属性
		local index,startY, downY = 1,402,40
		
		local createLabel = function(text)
			local label = CCLabelTTF:labelWithString(text,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(13,startY - (index-1)*downY))
			label:setColor(ccc3(254,204,155))
			center:addChild(label)		
			index = index + 1
		end
		local createAddPart = function(text,up)
			local label = CCLabelTTF:labelWithString(text,CCSize(300,0),0, SYSFONT[EQUIPMENT], 20)
			local upnum = CCLabelTTF:labelWithString(up,CCSize(300,0),0, SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(70,startY - (index-2)*downY))
			label:setColor(ccc3(255,204,151))
			local spr= CCSprite:spriteWithFile("UI/public/ars_up0.png")
			spr:setAnchorPoint(CCPoint(0,0))
			spr:setPosition(CCPoint(180,startY - (index-2)*downY))
			upnum:setAnchorPoint(CCPoint(0,0))
			upnum:setPosition(CCPoint(185+spr:getContentSize().width,startY - (index-2)*downY))
			upnum:setColor(ccc3(248,100,0))
			center:addChild(label)
            center:addChild(spr)
            center:addChild(upnum)			
		end
		
		local attrs,tags,grows = public_returnEquipAttributeDesc(item)
		for i = 1, #attrs do
			createLabel(tags[i].."：")
			createAddPart(attrs[i].."+"..(grows[i] * item.star),grows[i])
		end
		
		---------------------------------------------------------------------------------------------
		local levelLabel = CCLabelTTF:labelWithString("穿戴等级要求："..item.require_level,CCSize(300,0),0, SYSFONT[EQUIPMENT], 20)
		levelLabel:setPosition(CCPoint(13, 120))
		levelLabel:setAnchorPoint(CCPoint(0,0))
		levelLabel:setColor(ccc3(255,204,102))
		center:addChild(levelLabel)
		------------------------------------------------------------------------------------------------
		
		local label = CCLabelTTF:labelWithString("卖出价格：",CCSize(200,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(13,50))
		label:setColor(ccc3(254,204,155))
		center:addChild(label)
		local price = public_chageShowTypeForMoney(public_sellprice(item))
		local moneyLabel = CCLabelTTF:labelWithString(" "..price,CCSize(300,0),0, SYSFONT[EQUIPMENT], 24)
		moneyLabel:setAnchorPoint(CCPoint(0,0))
		moneyLabel:setPosition(CCPoint(110,50))
		moneyLabel:setColor(ccc3(255,204,0))
		center:addChild(moneyLabel)
	end,
	
	--创建右边按钮部分 面板
	createRight = function(self)
		local right = createDarkBG(195,545)
		right:setAnchorPoint(CCPoint(0, 0))
		right:setPosition(CCPoint(776, 38))
		self.bg:addChild(right,1)
		self.right = right
	   
	    --右侧顶部也就是普通强化上面，与普通强化为同一面板添加目前金币和银币数量
	    --金币显示
		local label = CCLabelTTF:labelWithString("金币:",CCSize(100,0),0,SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(25,480))
		label:setColor(ccc3(255,204,102))
		right:addChild(label)
		local label= CCLabelTTF:labelWithString(getShotNumber(GloblePlayerData.gold) ,CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(80,480))
		label:setColor(ccc3(255,204,102))
		right:addChild(label)	 
	    self.goldLabel = label
	    --银币显示
	    local label2 = CCLabelTTF:labelWithString("银币:",CCSize(100,0),0,SYSFONT[EQUIPMENT], 22)
		label2:setAnchorPoint(CCPoint(0,0))
		label2:setPosition(CCPoint(25,450))
		label2:setColor(ccc3(255,204,102))
		right:addChild(label2)
		local label2= CCLabelTTF:labelWithString(getShotNumber(GloblePlayerData.copper),CCSize(200,0),0,SYSFONT[EQUIPMENT], 22)
		label2:setAnchorPoint(CCPoint(0,0))
		label2:setPosition(CCPoint(80,450))
		label2:setColor(ccc3(255,204,102))
		right:addChild(label2)	 
	    self.copperLabel = label2

		--开始强化按钮
		local btn = dbUIButtonScale:buttonWithImage("UI/qiang_hua/normal.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(195/2,370))
		btn:setAnchorPoint(CCPoint(0.5,0))
		btn.m_nScriptClickedHandler = function(ccp)
			if self.selected == nil then
				ShowInfoDialog("请选择一个装备进行强化")
				return
			end
			local forge_Item = {
				id = self.selected.item_id,
				type = 1,
			}
			forgeItem(self,forge_Item)
		end
		right:addChild(btn)
		self.qiang_hua_btn = btn

		--消耗银币		
		local label = CCLabelTTF:labelWithString("需银币:",CCSize(200,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(25,330))
		label:setColor(ccc3(255,204,0))
		right:addChild(label)
		self.castMoneyLabel = CCLabelTTF:labelWithString(0,CCSize(200,0),0, SYSFONT[EQUIPMENT], 22)
		self.castMoneyLabel:setAnchorPoint(CCPoint(0,0))
		self.castMoneyLabel:setPosition(CCPoint(100,330))
		self.castMoneyLabel:setColor(ccc3(255,204,0))
		right:addChild(self.castMoneyLabel)

		--一键强化按钮
		local btn = dbUIButtonScale:buttonWithImage("UI/qiang_hua/super.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(195/2,250))
		btn:setAnchorPoint(CCPoint(0.5,0))
		btn.m_nScriptClickedHandler = function(ccp)
			if self.selected == nil then
				ShowInfoDialog("请选择一个装备进行强化")
				return
			end
			local forge_Item = {
				id = self.selected.item_id,
				type = 2,
			}
			forgeItem(self,forge_Item)
		end
		right:addChild(btn)
		
		local cooldown = getCDTime()
		
		self.cdLabel = CCLabelTTF:labelWithString(getLenQueTime(cooldown),SYSFONT[EQUIPMENT], 22)
		self.cdLabel:setAnchorPoint(CCPoint(0.5,0))
		self.cdLabel:setPosition(CCPoint(195/2,200))
		self.cdLabel:setColor(ccc3(255,51,0))
		self.cdLabel:setIsVisible(cooldown > 0)
		right:addChild(self.cdLabel)
					
		--清除冷却
		local btn = dbUIButtonScale:buttonWithImage("UI/qiang_hua/clear_cd.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(195/2,155-40))
		btn:setAnchorPoint(CCPoint(0.5,0))
		btn:setIsVisible(cooldown > 0)
		btn.m_nScriptClickedHandler = function(ccp)
			local gold = math.ceil(getCDTime()/60)
			new(ConfirmDialog):show({
				text = "确定花费"..gold.."金清除冷却吗？",
				width = 440,
				onClickOk = function()
					self:clearCDTime()
				end
			})
		end
		right:addChild(btn)
		self.cdBtn = btn

		--提示信息	
		local label = CCLabelTTF:labelWithString("神位等级30后，出现强化装备冷却时间",CCSize(180,0),0, SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(10,10))
		label:setColor(ccc3(204,153,0))
        right:addChild(label)
        
        local secondHandleFunction = function()
        	local cooldown = getCDTime()
			if cooldown > 0 then
				self.cdBtn:setIsVisible(true)
				self.cdLabel:setIsVisible(true)
				self.cdLabel:setString(getLenQueTime(cooldown))
			else
				self.cdLabel:setIsVisible(false)
				self.cdBtn:setIsVisible(false)
			end
		end
        self.secondHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(secondHandleFunction,1, false)		 
	end,
	
	unschedule = function(self)
		if self.secondHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.secondHandle)
			self.secondHandle = nil
		end
	end,
	
	clearCDTime = function(self)
		local function opFinishCB(s)
			WaitDialog.closePanelFunc()
			local error_code = s:getByKey("error_code"):asInt()		
			if error_code ~= -1 then
				ShowErrorInfoDialog(error_code)
			else	
				GloblePlayerData.forge_cooldown = s:getByKey("cooldown"):asInt()
				GloblePlayerData.forge_refresh_time = os.time()
				GloblePlayerData.gold = s:getByKey("gold"):asInt()
				self.goldLabel:setString(getShotNumber(GloblePlayerData.gold))
				updataHUDData()
			end		
		end	
		
		local function execRequest()
			showWaitDialogNoCircle()
			
			local action = Net.OPT_ForgeClearCDTime
			NetMgr:registOpLuaFinishedCB(action, opFinishCB)
			NetMgr:registOpLuaFailedCB(action, opFailedCB)
	
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(action, cj)
		end
		
		execRequest()
	end,
}

--强化界面
function forgeItem(self,item)
	local general_id = GloblePlayerData.generals[self.rolePanel.page].general_id

	local function opforgeItemFinishCB(s)
		WaitDialog.closePanelFunc()
		local error_code = s:getByKey("error_code"):asInt()		
		GlobleQiangHuaFinished = true
		GotoNextStepGuide()
		if error_code ~= -1 and error_code ~= 231 then
			ShowErrorInfoDialog(error_code)
		else	
			--强化成功操作
			local success = s:getByKey("success"):asBool()	
			local item_id = s:getByKey("item_id"):asInt()	
			local star = s:getByKey("star"):asInt()
			local cooldown = s:getByKey("cooldown"):asInt()

			GloblePlayerData.forge_cooldown = cooldown
			GloblePlayerData.forge_refresh_time = os.time()
			GloblePlayerData.copper = s:getByKey("copper"):asInt()
			GloblePlayerData.gold = s:getByKey("gold"):asInt()
			self.copperLabel:setString(getShotNumber(GloblePlayerData.copper))
			self.goldLabel:setString(getShotNumber(GloblePlayerData.gold))
			updataHUDData()
			
			local itemInfo = findItemByItemId(item_id)
			itemInfo.star = star
			self:refurbishItemInfo(itemInfo)

			local general = findGeneralByGeneralId(general_id)
			mappedPlayerBaseAttribute(general,s:getByKey("general_base_data"))
			
			if error_code == 231 then
				ShowErrorInfoDialog(error_code)
			end
		end
	end	
	
	local function execforgeItem()
		showWaitDialogNoCircle()
		
		local action = Net.OPT_Forge
		NetMgr:registOpLuaFinishedCB(action, opforgeItemFinishCB)
		NetMgr:registOpLuaFailedCB(action, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("item_id",item.id)	--物品id
		cj:setByKey("fate_point", 0)
		cj:setByKey("type", item.type) --1：普通，2：一键强化
		cj:setByKey("generalId", general_id) --0：查看，1：普通，2：特殊
		NetMgr:executeOperate(action, cj)
	end
	
	execforgeItem()
end
--打造 宝石合成 面板
QHHeChengPanel = {
	selected = nil, --当前选择的装备
	role = nil,
	bg = nil,
	kuangs = {},
	kuangCount = 1,
	gem_cfg_id = 0,
	cur_page = 1,
	
	create = function(self)
		self.role = GloblePlayerData.generals[GlobleQHPanel.curGenerals]
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 702))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		
		self:createleft()
		self:createRight()
	end,
	
	--更新界面
	reflash = function(self)
		if self.left~=nil then
			self.bg:removeChild(self.left,true)
			self.left = nil
			self.kuangs = new({})
			self.baoshiList = new({})
			self.kuangCount = 1
			self.selected=nil
		end
		self:createleft()
	end,
		
	--宝石列表界面
	createleft = function(self)
		local left = createDarkBG(566,545)
		left:setAnchorPoint(CCPoint(0, 0))
		left:setPosition(CCPoint(40, 38))
		self.bg:addChild(left)
		self.left = left

		local baoshiList = self:findBaoshi()
		local sum = table.getn(baoshiList)
		local pageCount = math.floor(sum/20)
		if sum%20~=0 then
			pageCount = pageCount+1
		end
		if pageCount <=0 then
			pageCount = 1
		end
		
		local scrollPanel = dbUIPanel:panelWithSize(CCSize(566 * pageCount, 425))
		scrollPanel:setAnchorPoint(CCPoint(0, 0))
		scrollPanel:setPosition(0,0)
		for i =1, pageCount do
			local single = self:createSinglePanel(i)
			scrollPanel:addChild(single)
		end
		
		self:addBaoshi2Panel(baoshiList)
		
		--滑动的区域
		local scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(scrollPanel, 1, pageCount)
		scrollArea:setScrollRegion(CCRect(0, 0, 566, 425))
		scrollArea:setAnchorPoint(CCPoint(0, 0))
		scrollArea:setPosition(0,94)
		scrollArea.pageChangedScriptHandler = function(page)
			self.cur_page = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[page+1])
		end
		self.left:addChild(scrollArea)
		
		self:createPageDot(scrollArea,pageCount)

		scrollArea:scrollToPage(self.cur_page-1,false)
	end,

	--创建单页
	createSinglePanel = function(self,page)
		local singlePanel = dbUIPanel:panelWithSize(CCSize(566, 425))
		singlePanel:setAnchorPoint(CCPoint(0, 0))
		singlePanel:setPosition((page-1)*566,0)
		--创建空的框框
		for i=1,4 do
			for j=1,5 do
				local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
				icon:setPosition(0,0)
				icon:setAnchorPoint(CCPoint(0, 0))
				
				local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
				kuang:setAnchorPoint(CCPoint(0, 0))
				kuang:setPosition(17+(j-1)*109, 327-(i-1)*109)
				kuang:addChild(icon)
				singlePanel:addChild(kuang)
				self.kuangs[self.kuangCount] = kuang
				self.kuangCount = self.kuangCount + 1
			end
		end
		return singlePanel
	end,
	
	findBaoshi = function(self)
		local sum = table.getn(GloblePlayerData.baoshi)
		local index = 1
		self.baoshiList = new({})
		for i=1,sum do 
			local baoshi = GloblePlayerData.baoshi[i]
			if baoshi~=nil and baoshi.icon and baoshi.cfg_item_id then
				self.baoshiList[index] = baoshi 			
				index = index + 1
			end
		end
		return self.baoshiList
	end,
	
	--把宝石添加到框框中
	addBaoshi2Panel = function(self,baoshiList)
		local sum = table.getn(baoshiList)
		local index = 1
		for i=1,sum do 
			local baoshi = baoshiList[i]
			if baoshi~=nil and baoshi.icon and baoshi.cfg_item_id then
				local kuang = self.kuangs[index]
				if baoshi.quality>1 then
					local coloricon =CCSprite:spriteWithFile(ITEM_QUALITY[baoshi.quality])
					coloricon:setPosition(CCPoint(96/2,96/2))
					coloricon:setAnchorPoint(CCPoint(0.5, 0.5))
					kuang:addChild(coloricon)
				end
				
				local btn = dbUIButtonScale:buttonWithImage("icon/Item/icon_item_"..baoshi.icon..".png",1.2,ccc3(152,203,0))
				btn:setPosition(CCPoint(96/2,96/2))
				btn:setAnchorPoint(CCPoint(0.5, 0.5))
				btn.m_nScriptClickedHandler = function(ccp)
					self:baoshiClickHandler(baoshi)
				end
				kuang:addChild(btn)

				local label = CCLabelTTF:labelWithString(baoshi.amount, SYSFONT[EQUIPMENT], 26)
				label:setAnchorPoint(CCPoint(1, 0))
				label:setPosition(CCPoint(90,3))
				kuang:addChild(label)	
				
				AddLevelForBaoshi(btn,baoshi.cfg_item_id,CCPoint(19,60))
				index = index + 1
			end
		end
	end,
	
	--分页
	createPageDot = function(self,scrollArea,pageCount)
		self.pageToggles = {}
		local width = pageCount*33 + (pageCount-1)*19
		for i=1,pageCount do
			local normalSpr = CCSprite:spriteWithFile("UI/public/page_btn_normal.png")
			local togglelSpr = CCSprite:spriteWithFile("UI/public/page_btn_toggle.png")		
			local toggle = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
			toggle:setAnchorPoint(CCPoint(0, 0))
			toggle:setPosition((566-width)/2+52*(i-1),25)
			toggle.m_nScriptClickedHandler = function()
				scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,self.pageToggles[i])
			end
			self.left:addChild(toggle)
			self.pageToggles[i]=toggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[1])
	end,
	
	--处理点击宝石
	baoshiClickHandler = function(self,baoshi)
		local gem = getItemBorder(baoshi.cfg_item_id)
		self.kuang1:removeChildByTag(102,true)
		self.kuang1:addChild(gem,1,102)
		AddLevelForBaoshi(gem,baoshi.cfg_item_id,CCPoint(22,57))
		
		local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
		local item = itemJsonConfig:getByKey(""..baoshi.cfg_item_id )
		self.kuang2:removeChildByTag(101,true)
		
		local composeId = item:getByKey("gem_compose_id"):asInt()
		
		--if item:getByKey("gem_compose_id" ):asInt() ~= 0 and item:getByKey("quality" ):asInt() < 4 then
		if baoshi.amount<=0 then
			self.gem_cfg_id = 0
		elseif  composeId<=0 then
			self.gem_cfg_id = -1
		else
			local compose = getItemBorder(item:getByKey("gem_compose_id"):asInt())
			self.kuang2:addChild(compose,1,101)
			AddLevelForBaoshi(compose,item:getByKey("gem_compose_id"):asInt(),CCPoint(22,57))
			self.gem_cfg_id = baoshi.cfg_item_id
			self.gem_amount = baoshi.amount
		end		
	end,
	
	--创建右边按钮部分 面板
	createRight = function(self)
		local right = createDarkBG(354,545)
		right:setAnchorPoint(CCPoint(0, 0))
		right:setPosition(CCPoint(617, 38))
		self.bg:addChild(right)
		self.right = right
	
		--技能描述框
		local descKuang = dbUIWidgetBGFactory:widgetBG()
		descKuang:setBGSize(CCSizeMake(309,166))
		descKuang:setCornerSize(CCSizeMake(12,12))
		descKuang:createCeil("UI/public/desc_bg.png")
		descKuang:setAnchorPoint(CCPoint(0.5,0))
		descKuang:setPosition(CCPoint(354/2, 340))
		self.right:addChild(descKuang)
		local desc = "1.宝石合成百分百成功。\n"..
					"2.需要两颗宝石才能合成一颗更高等级的宝石。"
		local label = CCLabelTTF:labelWithString(desc,CCSize(290,160),0, SYSFONT[EQUIPMENT], 20)	
		label:setColor(ccc3(102,51,0))
		label:setPosition(CCPoint(10,0))
		label:setAnchorPoint(CCPoint(0, 0))
		descKuang:addChild(label)
					
		local kuangIcon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
		kuangIcon:setPosition(0,0)
		kuangIcon:setAnchorPoint(CCPoint(0, 0))
		local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
		kuang:setAnchorPoint(CCPoint(0, 0))
		kuang:setPosition(22, 208)
		kuang:addChild(kuangIcon)
		self.right:addChild(kuang)
		self.kuang1 = kuang
		
		local jiantou = CCSprite:spriteWithFile("UI/equip_composite/to.png")
		jiantou:setPosition(135,230)
		jiantou:setAnchorPoint(CCPoint(0, 0))
		self.right:addChild(jiantou)
		
		local kuangIcon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
		kuangIcon:setPosition(0,0)
		kuangIcon:setAnchorPoint(CCPoint(0, 0))
		local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
		kuang:setAnchorPoint(CCPoint(0, 0))
		kuang:setPosition(232, 208)
		kuang:addChild(kuangIcon)
		self.right:addChild(kuang)
		self.kuang2 = kuang
		
		--合成全部按钮
		local btn = dbUIButton:buttonWithImage("UI/he_cheng/compose_all.png")
		btn:setPosition(CCPoint(17,100))
		btn:setAnchorPoint(CCPoint(0, 0))
		btn.m_nScriptClickedHandler = function(ccp)
			ComposNet(self,self.gem_cfg_id,self.gem_amount)
		end
		self.right:addChild(btn)
	
		--合成单个按钮
		local btn = dbUIButton:buttonWithImage("UI/he_cheng/compose_one.png")
		btn:setPosition(CCPoint(180,100))
		btn:setAnchorPoint(CCPoint(0, 0))
		btn.m_nScriptClickedHandler = function(ccp)
			ComposNet(self,self.gem_cfg_id,1)
		end
		self.right:addChild(btn)
	end,
}

ComposNet = function(self,cfg_id,comp_amount)
	local response = function (json)
		closeWait()
		local error_code = json:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
			local itemID = json:getByKey("add_item_id_list"):getByIndex(0):asInt()
			local old_item = itemJsonConfig:getByKey(cfg_id)
			local new_cfg_id = old_item:getByKey("gem_compose_id" ):asInt()
			local item = {new_cfg_id,itemID,}
			
			battleGetItems(item,true)
			local reflash = function()
				self:reflash()
			end
			RefreshItem(reflash)
		end
	end
	
	local sendRequest = function ()
		showWaitDialogNoCircle("waiting OPT_GemCompose!")
		local action = Net.OPT_GemCompose
		NetMgr:registOpLuaFinishedCB(action,response)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("cfg_gem_id", cfg_id)
		cj:setByKey("amount", comp_amount)
		NetMgr:executeOperate(action, cj)
	end
	
	if self.gem_cfg_id==-1 then
		ShowInfoDialog("宝石已经合成到最高等级")
	elseif self.gem_cfg_id==0 then
		ShowInfoDialog("宝石至少需要两个才能合成哦")
	else
		sendRequest()
	end
end
--打造 -镶嵌 面板
QHXiangQianPanel = {
	selected = nil, --当前选择的装备
	role = nil,
	bg = nil,
	pageToggles = {},
	kuangs = {},

	create = function(self)
		self.role = GloblePlayerData.generals[GlobleQHPanel.curGenerals]

		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 702))
		self.bg:setAnchorPoint(CCPoint(0, 0))

		self.rolePanel = new(RoleZhuangBeiPanel)
		self.rolePanel:create()
		self.bg:addChild(self.rolePanel.bg)
		self.general_id = GloblePlayerData.generals[self.rolePanel.page].general_id

		self:createRight()

		self:initClickedHandler()
	end,

	--注册点击事件
	initClickedHandler = function(self)
		local equips = self.rolePanel.equips
		local toggles = self.rolePanel.toggles
		for i=1,table.getn(equips) do
			toggles[i].m_nScriptClickedHandler = function(ccp)
				public_toggleRadioBtn(toggles,toggles[i])
				self.selected = equips[i].item
				self:reflash(self.selected)
				self.general_id = GloblePlayerData.generals[self.rolePanel.page].general_id
			end
		end
	end,

	--刷新中间显示的数据
	reflash = function(self,item)
		self.bg:removeChild(self.right,true)
		self:createRight()
	end,

	--中间数值面板
	createRight = function(self)
		local right = createDarkBG(483,545)
		right:setAnchorPoint(CCPoint(0, 0))
		right:setPosition(CCPoint(485, 38))
		self.bg:addChild(right)
		self.right = right

		local item = self.selected

		--如果没有装备选择的话，显示一个提示信息
		if item==nil then
			local label = CCLabelTTF:labelWithString("选择装备进行镶嵌",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
			label:setAnchorPoint(CCPoint(0.5,0.5))
			label:setPosition(CCPoint(483/2,545/2))
			label:setColor(ccc3(152,203,0))
			right:addChild(label)
			return
		end
		
		local label = CCLabelTTF:labelWithString(item.name,CCSize(200,0),0, SYSFONT[EQUIPMENT], 24)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(10,495))
		label:setColor(ITEM_COLOR[item.quality])
		right:addChild(label)
		
		self:createSlot()
		self:createBaoShiPanel()
	end,

	--创建镶嵌槽，共三个框框,以及一些说明
	createSlot = function(self)
		local item = self.selected
		for k = 1 , 6 do
			local y = 423
			local x = 134 + (k-1)*115
			if k>3 then
				y = y - 105
				x = 134 + (k-1-3)*115
			end
			
			local panelKuang = dbUIPanel:panelWithSize(CCSize(96,96))
			panelKuang:setAnchorPoint(CCPoint(0, 0))
			panelKuang:setPosition(x,y)
			
			local kuang = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			kuang:setPosition(48,48)
			kuang:setAnchorPoint(CCPoint(0.5, 0.5))
			panelKuang:addChild(kuang)

			self.right:addChild(panelKuang)
			local hole
			local item_info = nil
			if item.hole[k] ~= nil and  item.hole[k].type ~= nil then
				local gem_id = item.hole[k].id
				if gem_id ~= 0 then
					item_info = new(findShowItemInfo(gem_id))
					local gemCfg = {
						item_id = item.item_id,
						item = item_info,
						gemBg = "UI/public/kuang_96_96.png",
						from  = "dialog",
						mine = true,
						parent = self,
						generalId = self.general_id,
						gem = {
							item_id = item.item_id,
							hole = k,
							isShow = true,
						}
					}
					hole = createGem(gemCfg)
				else
					local holeCfg = {
						type = item.hole[k].type,
						item_id = item.item_id,
						hole = k,
						enable = item.hole[k].type > 0,
						parent = self,
						noHoldBg = "UI/public/locked_k.png",
						holdBg = "UI/public/kuang_96_96.png"
					}
					hole = createHole(holeCfg)
				end
				hole:setAnchorPoint(CCPoint(0.5,0.5))
				hole:setPosition(CCPoint(kuang:getContentSize().width/2,kuang:getContentSize().height/2))
				panelKuang:addChild(hole)
				
				if item_info then
					AddLevelForBaoshi(panelKuang,item_info.cfg_item_id,CCPoint(23,59))
				end
			end
		end

		local label = CCLabelTTF:labelWithString("可镶嵌：",CCSize(150,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(15,466))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)
	
		local baoshiNames = new({})
		
		local nameExist = function(name)
			for i=1,table.getn(baoshiNames) do
				if baoshiNames[i]==name then
					return true
				end
			end
			return false
		end
		
		for k = 1, 6 do
			if item.hole[k] ~= nil and item.hole[k].type ~= nil and item.hole[k].type ~= 0  then
				local type = item.hole[k].type
				for i = 1 , table.getn(HOLE_CFG[type]) do
					local name =  HOLE_CFG[type][i]
					if not nameExist(name) then
						table.insert(baoshiNames,name)
					end
				end
			end
		end
		
		local names = ""
		for i=1,table.getn(baoshiNames) do
			names = names..baoshiNames[i].." "
			if i ~= #baoshiNames then
				names = names.."\n"
			end
		end
		local label = CCLabelTTF:labelWithString(names,CCSize(110,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(15,460))
		label:setColor(ccc3(255,203,153))
		self.right:addChild(label)
	end,

	--创建宝石的分页panel
	createBaoShiPanel = function(self)
		local filter = function(all,item)
			local list = new({})
			for i=1,#all do
				for j=1,6 do
					local cfgItem = findItemsByItemCfgId1(all[i].cfg_item_id)
					if item.hole[j] ~= nil and item.hole[j].type == cfgItem.effect_value then
						table.insert(list,all[i])
						break;
					end
				end
			end
			return list
		end
		
		local baoshi = filter(GloblePlayerData.baoshi,self.selected)
		local sum = table.getn(baoshi)
		local pageCount = getPageCount(sum,8)

		local scrollPanel = dbUIPanel:panelWithSize(CCSize(483 * pageCount, 216))
		scrollPanel:setAnchorPoint(CCPoint(0, 0))
		scrollPanel:setPosition(0,0)
		for i = 1, pageCount do
			local single = self:createSinglePanel(i)
			scrollPanel:addChild(single)
		end
		self:addBaoshi2Panel(baoshi)

		--滑动的区域
		local scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(scrollPanel, 1, pageCount)
		scrollArea:setScrollRegion(CCRect(0, 0, 483, 216))
		scrollArea:setAnchorPoint(CCPoint(0, 0))
		scrollArea:setPosition(0,78)
		scrollArea.pageChangedScriptHandler = function(page)
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[page+1])
		end
		self.right:addChild(scrollArea)

		self:createPage(scrollArea,pageCount)
	end,

	--创建单页
	createSinglePanel = function(self,page)
		local singlePanel = dbUIPanel:panelWithSize(CCSize(483, 216))
		singlePanel:setAnchorPoint(CCPoint(0, 0))
		singlePanel:setPosition((page-1)*483,0)
		--创建空的框框
		local count = 1
		for i=1,2 do
			for j=1,4 do
				local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
				icon:setPosition(0,0)
				icon:setAnchorPoint(CCPoint(0, 0))

				local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
				kuang:setAnchorPoint(CCPoint(0, 0))
				kuang:setPosition(17+(j-1)*118, 118-(i-1)*118)
				kuang:addChild(icon)
				singlePanel:addChild(kuang)
				self.kuangs[count + (page-1)*8] = kuang
				count = count + 1
			end
		end
		return singlePanel
	end,

	--把宝石添加到框框中
	addBaoshi2Panel = function(self,filtedBaoshi)
		local sum = table.getn(filtedBaoshi)
		local index = 1
		
		--宝石排序
		local sortFunc = function(a,b)
			return a.quality > b.quality
		end
		table.sort(filtedBaoshi,sortFunc)

		for i=1,sum do
			local baoshi = filtedBaoshi[i]
			if baoshi~=nil and baoshi.icon and baoshi.cfg_item_id then
				local handler = function(ccp)
					self:baoshiClickHandler(ccp,baoshi)
				end
				local kuang = self.kuangs[index]
				if baoshi.quality>1 then
					local coloricon = CCSprite:spriteWithFile(ITEM_QUALITY[baoshi.quality])
					coloricon:setPosition(0,0)
					coloricon:setAnchorPoint(CCPoint(0,0))
					kuang:addChild(coloricon)
				end
				
				local btn = dbUIButtonScale:buttonWithImage("icon/Item/icon_item_"..baoshi.icon..".png",1.2,ccc3(152,203,0))
				btn:setPosition(CCPoint(96/2,96/2))
				btn:setAnchorPoint(CCPoint(0.5, 0.5))
				btn.m_nScriptClickedHandler = handler
				kuang:addChild(btn)

				local label = CCLabelTTF:labelWithString(baoshi.amount, SYSFONT[EQUIPMENT], 26)
				label:setAnchorPoint(CCPoint(1, 0))
				label:setPosition(CCPoint(90,0))
				kuang:addChild(label)
				index = index + 1
				
				AddLevelForBaoshi(kuang,baoshi.cfg_item_id,CCPoint(23,59))
			end
		end
	end,

	--镶嵌事件处理
	baoshiClickHandler = function(self,ccp,baoshi)
		local item = self.selected
		local gemInfo = findItemsByItemCfgId1(baoshi.cfg_item_id)
		local findHoleIndexToType = function(type)
			for m = 1, 6 do
				if item.hole[m] ~= nil and item.hole[m].type ~= nil and item.hole[m].type ~= 0 and  item.hole[m].type == type and item.hole[m].id == 0 then
					return m
				end
			end
			return 0
		end
		local holeidx = findHoleIndexToType(gemInfo.effect_value)
		--需要分清楚到底镶嵌到那个孔
		local gem_cfg = {
			item_id = item.item_id,
			gem_id = gemInfo.item_id,
			idx = holeidx,
		}
		local GemMountLocal = function(ccp,GemInfo)
			GemMount(self,{caller=self,GemInfo=GemInfo,generalId=self.general_id})
		end
		local createGemMountBtn = function()
			local btns = {}
			local bs = new(ButtonScale)
			bs:create("UI/public/noTextBtn.png",1.2,ccc3(255,255,255),"镶嵌")
			btns[1] = bs.btn
			btns[1].action = GemMountLocal
			btns[1].param = gem_cfg

			local bs = new(ButtonScale)
			bs:create("UI/public/noTextBtn.png",1.2,ccc3(255,255,255),"取消")
			btns[2] = bs.btn
			btns[2].action = nothing
			return btns
		end

		local gemDialogCfg = new(basicDialogCfg)
		local desc,tag = public_returnEquipAttributeDesc(gemInfo)
		local msg = "镶嵌\n<"..gemInfo.name..">\n".."可以增加属性"

		for n = 1 , table.getn(desc) do
			msg = msg.."\n"..tag[n]..desc[n]
		end

		gemDialogCfg.msg = msg
		gemDialogCfg.btns = createGemMountBtn()
		gemDialogCfg.dialogType = 5
		gemDialogCfg.position = ccp
		new(Dialog):create(gemDialogCfg)
	end,

	--分页
	createPage = function(self,scrollArea,pageCount)
		self.pageToggles = {}
		local width = pageCount*33 + (pageCount-1)*19
		for i=1,pageCount do
			local normalSpr = CCSprite:spriteWithFile("UI/public/page_btn_normal.png")
			local togglelSpr = CCSprite:spriteWithFile("UI/public/page_btn_toggle.png")
			local toggle = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
			toggle:setAnchorPoint(CCPoint(0, 0))
			toggle:setPosition((483-width)/2+52*(i-1),20)
			toggle.m_nScriptClickedHandler = function()
				scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,self.pageToggles[i])
			end
			self.right:addChild(toggle)
			self.pageToggles[i]=toggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[1])
	end
}

--镶嵌
function GemMount(widget,param)
	local GemInfo = param.GemInfo
	local callback = param.callback
	local generalId = param.generalId

	local function opGemMountFinishCB(s)
		WaitDialog.closePanelFunc()
		local error_code = s:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			local gem = findItemByItemId(GemInfo.gem_id)
			--减少一顆宝石
			if gem.amount <= 1 then
				gem.id = 0
				gem.amount = 0
			else
				gem.amount = gem.amount - 1
			end
			needRefreshItems = false
			local item = findItemByItemId(s:getByKey("item_id"):asInt())
			for i = 1 , 6 do
				item.hole[i].id = s:getByKey("hole"..i):asInt()
			end
			updateSpecialItemData()
			
			local general = findGeneralByGeneralId(generalId)	
			mappedPlayerBaseAttribute(general,s:getByKey("general_base_data"))
			
			if GlobleQHPanel and GlobleQHPanel.xqp then
				GlobleQHPanel.xqp:reflash()
			end

			if callback then
				callback()
			end
			--宝石镶嵌，更新背包状态
			checkBaoguoCapacityEnough()	
		end
	end

	local function execGemMount()
		if GemInfo.idx ~= 0 then
			showWaitDialog("waiting GemMount!")

			local action = Net.OPT_GemMount

			NetMgr:registOpLuaFinishedCB(action, opGemMountFinishCB)
			NetMgr:registOpLuaFailedCB(action, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("equip_id",GemInfo.item_id )
			cj:setByKey("gem_id", GemInfo.gem_id)
			cj:setByKey("hole", GemInfo.idx)
			cj:setByKey("generalId", generalId)

			NetMgr:executeOperate(action, cj)
		else
			ShowInfo("该装备沒有可以镶嵌该宝石的孔了。")
		end
	end
	execGemMount()
end

--拆除
function GemDismount(widget,cfg)
	local GemInfo = cfg.gem
	local generalId = cfg.generalId
	local function opGemDismountFinishCB(s)
		WaitDialog.closePanelFunc()
		local error_code = s:getByKey("error_code"):asInt()

		if error_code > 0 then
			if error_code == 2001 then
				alert("背包空间不足，宝石无法被拆除。")
			else
				ShowErrorInfoDialog(error_code)
			end
		else
			local item = findItemByItemId(GemInfo.item_id)
			local itemif = {}
			local item_id = s:getByKey("add_item_id_list"):getByIndex(0):asInt()
			itemif[1] = item.hole[GemInfo.hole].id
			itemif[2] = item_id
			itemif[3] = 1
			itemif[4] = true

			item.hole[GemInfo.hole].id = 0

			needRefreshItems = item_id ~= 0 and false or true
			battleGetItems(itemif,true)

			local general = findGeneralByGeneralId(generalId)	
			mappedPlayerBaseAttribute(general,s:getByKey("general_base_data"))
			
			local tick_id
			function tick()
				if needRefreshItems then
					closeWait()
					updateSpecialItemData()
					CCScheduler:sharedScheduler():unscheduleScriptEntry(tick_id)
					if cfg.parent and cfg.parent.reflash then
						cfg.parent:reflash(cfg.parent.cfg)
					end
					needRefreshItems = false
				end
			end
			tick_id = CCScheduler:sharedScheduler():scheduleScriptFunc(tick, 0.4, false)
			--宝石拆除，更新背包状态
			checkBaoguoCapacityEnough()	
		end
	end
	local function execGemDismount()
		showWaitDialogNoCircle("waiting GemDismount!")

		local action = Net.OPT_GemDismount
		NetMgr:registOpLuaFinishedCB(action, opGemDismountFinishCB)
		NetMgr:registOpLuaFailedCB(action, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("equip_id",GemInfo.item_id )
		cj:setByKey("hole", GemInfo.hole)
		cj:setByKey("generalId", generalId)
		NetMgr:executeOperate(action, cj)
	end
	execGemDismount()
end

HOLE_CFG = {}
HOLE_CFG[1] = {"物攻石","法攻石"}
HOLE_CFG[2] = {"物防石","法防石"}
HOLE_CFG[3] = {"生命石","速度石"}
HOLE_CFG[4] = {"命中石","闪避石"}
HOLE_CFG[5] = {"破击石","格挡石"}
HOLE_CFG[6] = {"暴击石","韧性石"}
--装备合成
Equip_Composite_Cur_General_Index = nil
Equip_Composite_Cur_Item_Id = 0

local loadTagetCfgItem = function(cfgItemId)
	local cfg_item_composite = openJson("cfg/cfg_item_composite.json")
	local row = cfg_item_composite:getByKey(""..cfgItemId)
	if row:isNull() then
		return nil
	end
	
	local main_stuff = row:getByKey("main_stuff"):asInt()
	local stuff_1 = row:getByKey("stuff_1"):asInt()
	local stuff_2 = row:getByKey("stuff_2"):asInt()
	
	local sumHave = function(cfgItemId)
		local list = findItemListByItemCfgId(cfgItemId)
		local amount = 0
		for i=1,#list do
			amount = amount + list[i].amount
		end
		return amount
	end
	
	local main_amount = row:getByKey("main_amount"):asInt()
	local main_stuff_have = sumHave(main_stuff)
	
	local amount_1 = row:getByKey("amount_1"):asInt()
	local stuff_1_have = sumHave(stuff_1)
	
	local amount_2 = row:getByKey("amount_2"):asInt()
	local stuff_2_have = sumHave(stuff_2)
	local enough = main_stuff_have >= main_amount and stuff_1_have >= amount_1 and stuff_2_have >= amount_2

	return {
		target_cfg_item_id = row:getByKey("target_cfg_item_id"):asInt(),
		require_level = row:getByKey("require_level"):asInt(),

		main_stuff = main_stuff,
		main_amount = row:getByKey("main_amount"):asInt(),
		main_have = main_stuff_have,

		stuff_1 = stuff_1,
		amount_1 = amount_1,
		amount_1_have = stuff_1_have,

		stuff_2 = stuff_2,
		amount_2 = amount_2,
		amount_2_have = stuff_2_have,
		
		enough = enough
	}
end

QHEquipCompositePanel = {
	selected = nil, --当前选择的装备
	role = nil,
	bg = nil,
	pageToggles = {},
	kuangs = {},

	create = function(self)
		if Equip_Composite_Cur_General_Index == nil then
			Equip_Composite_Cur_General_Index = GlobleQHPanel.curGenerals
		end
		
		self.role = GloblePlayerData.generals[Equip_Composite_Cur_General_Index]

		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 702))
		self.bg:setAnchorPoint(CCPoint(0, 0))

		self.rolePanel = new(RoleZhuangBeiPanel)
		self.rolePanel.page = Equip_Composite_Cur_General_Index
		self.rolePanel:create()
		self.bg:addChild(self.rolePanel.bg)
		self.general_id = self.role.general_id

		if Equip_Composite_Cur_Item_Id > 0 then
			self.selected = findItemByItemId(Equip_Composite_Cur_Item_Id)
			self.target = loadTagetCfgItem(self.selected.cfg_item_id)
		end
		self:createRight()

		self:initClickedHandler()
	end,

	--注册点击事件
	initClickedHandler = function(self)
		local equips = self.rolePanel.equips
		local toggles = self.rolePanel.toggles
		for i=1,table.getn(equips) do
			toggles[i].m_nScriptClickedHandler = function(ccp)
				public_toggleRadioBtn(toggles,toggles[i])
				Equip_Composite_Cur_General_Index = self.rolePanel.page
				self.selected = equips[i].item
				self:reflash(self.selected)
			end
		end
	end,

	--刷新右边显示的数据
	reflashAll = function(self)
		GlobleQHPanel:clearMainWidget()
		createEquipComposite()
	end,
	
	--刷新右边显示的数据
	reflash = function(self,item)
		self.target = loadTagetCfgItem(self.selected.cfg_item_id)
		self.bg:removeChild(self.right,true)
		self:createRight()
	end,

	--中间数值面板
	createRight = function(self)
		local right = createDarkBG(483,545)
		right:setAnchorPoint(CCPoint(0, 0))
		right:setPosition(CCPoint(485, 38))
		self.bg:addChild(right)
		self.right = right

		local item = self.selected
		local target = self.target
		
		--如果没有装备选择或者装备不可升级的话，显示一个提示信息
		if item == nil then
			local label = CCLabelTTF:labelWithString("选择装备进行升级",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
			label:setAnchorPoint(CCPoint(0.5,0.5))
			label:setPosition(CCPoint(483/2,545/2))
			label:setColor(ccc3(152,203,0))
			right:addChild(label)
			return
		elseif target == nil then
			local label = CCLabelTTF:labelWithString("该装备无法进行升级",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
			label:setAnchorPoint(CCPoint(0.5,0.5))
			label:setPosition(CCPoint(483/2,545/2))
			label:setColor(ccc3(152,203,0))
			right:addChild(label)
			return
		end
		
		local icon = CCSprite:spriteWithFile("UI/equip_composite/to.png")
		icon:setPosition(483/2, 440)
		icon:setAnchorPoint(CCPoint(0.5, 0))		
		right:addChild(icon)
		
		local createItemInfo = function(item,position,star)
			local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			icon:setPosition(0,0)
			icon:setAnchorPoint(CCPoint(0, 0))
			local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
			kuang:setAnchorPoint(CCPoint(0, 0))
			kuang:setPosition(position)
			kuang:addChild(icon)
			right:addChild(kuang)
			local equipItem = new(BaoGuo_BackpackSingleItem)
			equipItem:create(item,{item = item,from = "view",mine=false})
			equipItem.itemBorder:setAnchorPoint(CCPoint(0.5, 0.5))
			equipItem.itemBorder:setPosition(CCPoint(48,48))
			kuang:addChild(equipItem.itemBorder)
			--[[local label = CCLabelTTF:labelWithString(item.name.." +"..item.star,CCSize(200,0),0,SYSFONT[EQUIPMENT], 24)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(5,-10))
			label:setColor(ccc3(102,203,1))
			kuang:addChild(label)	]]
			local label = CCLabelTTF:labelWithString("强化等级："..star,CCSize(150,0),0,SYSFONT[EQUIPMENT], 22)
			label:setAnchorPoint(CCPoint(0,1))
			label:setPosition(CCPoint(5,-10))
			label:setColor(ccc3(255,203,102))
			kuang:addChild(label)
			
			local a,b,c = public_returnEquipAttributeDesc(item)
			local attrCount = table.getn(a)		
			for i = 1 , attrCount do
				local attribute = b[i].."：" .. a[i]
				local label = CCLabelTTF:labelWithString(attribute,CCSize(300,0),0,SYSFONT[EQUIPMENT], 22)
				label:setAnchorPoint(CCPoint(0,1))
				label:setPosition(CCPoint(5, -10 - 30 * i))
				label:setColor(ccc3(255,203,102))
				kuang:addChild(label)
			end		
		end
		
		createItemInfo(item,CCPoint(60, 412),item.star)
		if target then
			local targetItem = findShowItemInfo(target.target_cfg_item_id)
			local targetStar = math.max(0,item.star - 5)
			targetItem.star = targetStar	--目标装备增加等级增加属性显示
			createItemInfo(targetItem,CCPoint(317, 412),targetStar)
		end
		
		local spr = CCSprite:spriteWithFile("UI/equip_composite/line.png")
		spr:setPosition(483/2, 240)
		spr:setAnchorPoint(CCPoint(0.5, 0))		
		right:addChild(spr)
		local label = CCLabelTTF:labelWithString("制造材料",SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(483/2,233))
		label:setColor(ccc3(255,203,102))
		right:addChild(label)
		
		--创建材料部分
		local createSuff = function(cfg_item_id,amount,have,position)
			local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
			kuang:setAnchorPoint(CCPoint(0, 0))
			kuang:setPosition(position)
			right:addChild(kuang)

			local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			icon:setPosition(0,0)
			icon:setAnchorPoint(CCPoint(0, 0))
			kuang:addChild(icon)

			local itemBorder = getItemBorder(cfg_item_id)
			itemBorder:setAnchorPoint(CCPoint(0.5, 0.5))
			itemBorder:setPosition(CCPoint(48,48))
			kuang:addChild(itemBorder)
			
			local label = CCLabelTTF:labelWithString(have.."/"..amount,CCSize(150,0),2,SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(1,0))
			label:setPosition(CCPoint(90,5))
			kuang:addChild(label)
		end
		
		if target then
			createSuff(target.main_stuff,target.main_amount,target.main_have,CCPoint(74,113))
			createSuff(target.stuff_1,target.amount_1,target.amount_1_have,CCPoint(194,113))
			createSuff(target.stuff_2,target.amount_2,target.amount_2_have,CCPoint(314,113))
		end
		
		--升级按钮
		local enable = target and target.enough and self.role.level >= target.require_level
		local btn = dbUIButtonScale:buttonWithImage( enable and "UI/equip_composite/composite_enable.png" or "UI/equip_composite/composite_disable.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(483/2,20))
		btn:setAnchorPoint(CCPoint(0.5,0))
		if enable then
			btn.m_nScriptClickedHandler = function(ccp)
				equipComposite(self,item.item_id,item.cfg_item_id,self.role.general_id)
			end
		end
		right:addChild(btn)
		if self.role.level < target.require_level then
			local label = CCLabelTTF:labelWithString("要求等级:"..target.require_level,CCSize(250,0),2,SYSFONT[EQUIPMENT], 26)
			label:setPosition(CCPoint(483/2+100,20))
			label:setAnchorPoint(CCPoint(0.5,0))
			right:addChild(label)	
		end
	end,
}

--合成
function equipComposite(panel,item_id,cfg_item_id,general_id)
	local function opFinishCB(s)
		WaitDialog.closePanelFunc()
		local error_code = s:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			local star = s:getByKey("star"):asInt()
			local cfg_item_id = s:getByKey("cfg_item_id"):asInt()
			local item_id = s:getByKey("item_id"):asInt()
			local targetItem = findItemByItemId(item_id)
			targetItem.cfg_item_id = cfg_item_id
			targetItem.star = star
			Equip_Composite_Cur_Item_Id = item_id
			mappedItemData(s)
			local general = findGeneralByGeneralId(general_id)	
			mappedPlayerBaseAttribute(general,s:getByKey("general_base_data"))
			panel:reflashAll()
			alert("升级成功！")
		end
	end

	showWaitDialogNoCircle("waiting GemMount!")

	local action = Net.OPT_EquipComposite
	NetMgr:registOpLuaFinishedCB(action, opFinishCB)
	NetMgr:registOpLuaFailedCB(action, opFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	cj:setByKey("cfg_item_id", cfg_item_id)
	cj:setByKey("item_id",item_id)
	cj:setByKey("general_id",general_id)
	NetMgr:executeOperate(action, cj)
end
--家族主界面
LegionData = {
	list  = {},
	legion_id = 0,
	legion_applied = 0,
}
LegionDetail = {
	legion_id = "" ,
	level = "",
	name = "",
	leader_name = "",
	number = "",
	number_max = "",
	contribute = "",
	notice = "",
	blackboard = "",
	position = 0,
}

function globleShowJiaZu()
	local opFinishCB = function(s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			initLegionData(s)
			if LegionData.legion_id == 0 then --没有加入家族
				new(JZListPanel):create()
			else
				createJiaZuMain()
			end
		end
	end

	showWaitDialog("waiting Raid data")
	NetMgr:registOpLuaFinishedCB(Net.OPT_Legion, opFinishCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_Legion, opFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	NetMgr:executeOperate(Net.OPT_Legion, cj)
end

function initLegionData (json)
	LegionData.legion_id = json:getByKey("legion_id"):asInt()
	LegionData.legion_applied = json:getByKey("legion_applied"):asInt()
	
	--还没加入家族时，显示家族列表
	if LegionData.legion_id==0 then
		LegionDetail = new({})
		
		LegionData.list = new ({})
		local legion_list = json:getByKey("legion_list")
		
		for i = 1,legion_list:size() do
			local legion = legion_list:getByIndex(i-1)
			local data = new({})
			
			data.legion_id = legion:getByKey("legion_id"):asInt()
			data.name = legion:getByKey("name"):asString()
			data.leader_name = legion:getByKey("leader_name"):asString()
			data.number = legion:getByKey("number"):asInt()
			data.number_max = legion:getByKey("number_max"):asInt()
			data.level = legion:getByKey("level"):asInt()
			data.contribute = legion:getByKey("contribute"):asInt()
			data.notice = legion:getByKey("notice"):asString()
			data.blackboard = legion:getByKey("blackboard"):asString()
			data.applied = legion:getByKey("applied"):asBool()
			LegionData.list[i] = data
		end
		
		local sort = function(a,b)
			return a.level > b.level
		end
		table.sort(LegionData.list,sort)
	else
		LegionData.list = new ({})
		initLegionDetail(json:getByKey("LegionDetail"))
	end
end

function initLegionDetail (json)
	LegionDetail.legion_id = json:getByKey("legion_id"):asInt()
	LegionDetail.level = json:getByKey("level"):asInt()
	LegionDetail.name = json:getByKey("name"):asString()
	LegionDetail.leader_name = json:getByKey("leader_name"):asString()
	LegionDetail.number = json:getByKey("number"):asInt()
	LegionDetail.number_max = json:getByKey("number_max"):asInt()
	LegionDetail.contribute = json:getByKey("contribute"):asInt()
	LegionDetail.notice = json:getByKey("notice"):asString()
	LegionDetail.blackboard = json:getByKey("blackboard"):asString()
	LegionDetail.position = json:getByKey("position"):asInt()
end

function loadLegionDetail(legion_id,callback)
	local opDetailFinishCB = function (s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
			return
		end
		initLegionDetail(s)
		LegionDetail.legion_id = legion_id
		callback(LegionDetail)
	end

	showWaitDialogNoCircle("waiting Raid data")
	NetMgr:registOpLuaFinishedCB(Net.OPT_LegionDetail, opDetailFinishCB)
	NetMgr:registOpLuaFailedCB(Net.OPT_LegionDetail, opFailedCB)

	local cj = Value:new()
	cj:setByKey("role_id", ClientData.role_id)
	cj:setByKey("request_code", ClientData.request_code)
	cj:setByKey("legion_id",legion_id )

	NetMgr:executeOperate(Net.OPT_LegionDetail, cj)
end
--家族列表 面板
JZListPanel = {
	selected = 0,

	create = function(self)
		self:initBase()
		local defaultLegion = nil
		if #LegionData.list>0 then
			defaultLegion = LegionData.list[1]
			self.selected = defaultLegion.legion_id
		end
		
		self:createLeft()
		self:createRight(defaultLegion)
		return self
	end,

	createLeft = function(self)
		if self.leftPanel then
			self.leftPanel:removeFromParentAndCleanup(true)
			self.leftPanel = nil
			self.curPoint = nil
		end
		
		self.leftPanel = createBG("UI/public/kuang_xiao_mi_shu.png",560,545)
		self.leftPanel:setAnchorPoint(CCPoint(0, 0))
		self.leftPanel:setPosition(CCPoint(40, 40))
		self.mainWidget:addChild(self.leftPanel)
		
		--创建头部标题
		local list_head_bg = createBG("UI/ri_chang/list_head_bg.png",560,65,CCSize(30,30))
		list_head_bg:setAnchorPoint(CCPoint(0.5,1))
		list_head_bg:setPosition(560/2,545)
		self.leftPanel:addChild(list_head_bg)
		local label = CCLabelTTF:labelWithString("家族名称",CCSize(180,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(23,65/2))
		label:setColor(ccc3(255,153,0))
		list_head_bg:addChild(label)
		local label = CCLabelTTF:labelWithString("家族人数",CCSize(180,0),0, "", 30)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(223,65/2))
		label:setColor(ccc3(255,153,0))
		list_head_bg:addChild(label)
		local label = CCLabelTTF:labelWithString("族长",CCSize(100,0),0, "", 30)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(441,65/2))
		label:setColor(ccc3(255,153,0))
		list_head_bg:addChild(label)		
		
		local scrollList = dbUIScrollList:scrollList(CCRectMake(0,5,570,470),0)
		self.leftPanel:addChild(scrollList)
		
		local createCurPoint = function(item)
			if self.curPoint then
				self.curPoint:removeFromParentAndCleanup(true)
				self.curPoint = nil
			end
			local curPoint = CCSprite:spriteWithFile("UI/jia_zu/xz.png")
			curPoint:setAnchorPoint(CCPoint(0,0.5))
			curPoint:setPosition(5,66/2)
			curPoint:setIsVisible(true)
			item:addChild(curPoint)
			self.curPoint = curPoint
		end
		
		local i = 1
		local createItem = function(data)
			local item = dbUIPanel:panelWithSize(CCSize(570,66))
			local color = ccc3(255,204,102) 
			
			--分割线
			local line = CCSprite:spriteWithFile("UI/public/line_2.png")
			line:setAnchorPoint(CCPoint(0,0))
			line:setScaleX(557/28)
			line:setPosition(2, 0)
			item:addChild(line)

			local label = CCLabelTTF:labelWithString(data.name,CCSize(200,0),0, SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(23,66/2))
			label:setColor(color)
			item:addChild(label)
			
			if data.applied == true then
				local ysq = CCSprite:spriteWithFile("UI/jia_zu/ysq.png")
				ysq:setAnchorPoint(CCPoint(0,0.5))
				ysq:setPosition(CCPoint(80,66/2))
				item:addChild(ysq)
				
				createCurPoint(item)
			end
			
			local label = CCLabelTTF:labelWithString(data.number.."/"..data.number_max,CCSize(200,0),0, SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(240,66/2))
			label:setColor(color)
			item:addChild(label)

			local label = CCLabelTTF:labelWithString(data.leader_name,CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(400,66/2))
			label:setColor(color)
			item:addChild(label)
			
			item.m_nScriptClickedHandler = function(ccp)
				self:createRight(data)
				createCurPoint(item)
				self.selected = data.legion_id
			end
			
			--当前指向那一条记录
			if i==1 then
				createCurPoint(item)
			end
			
			scrollList:insterDetail(item)
			i = i + 1
		end
		
		local list = LegionData.list
		for i=1,#list do
			createItem(list[i])
		end
		local y = i==2 and 470-(i)*66 or 470-(i-1)*66
		scrollList:setContentPosition(CCPoint(0,y))	--dbUIScrollList中算高度有+1，故在此-1
	end,
	
	createRight = function(self,data)
		if self.rightPanel then
			self.rightPanel:removeFromParentAndCleanup(true)
			self.rightPanel = nil
		end
		if data==nil then
			data = {notice=""}
		end
		
		self.rightPanel = createBG("UI/public/kuang_xiao_mi_shu.png",364,545)
		self.rightPanel:setAnchorPoint(CCPoint(0, 0))
		self.rightPanel:setPosition(CCPoint(610, 40))
		self.mainWidget:addChild(self.rightPanel)
		
		local label = CCLabelTTF:labelWithString("家族公告", SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(364/2,495))
		label:setColor(ccc3(153,205,0))
		self.rightPanel:addChild(label)
		
		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_3.png")
		line:setAnchorPoint(CCPoint(0.5,0))
		line:setScaleX(330/line:getContentSize().width)
		line:setPosition(360/2,480)
		self.rightPanel:addChild(line)

		local label = CCLabelTTF:labelWithString(data.notice,CCSize(320,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(20,460))
		label:setColor(ccc3(255,205,154))
		self.rightPanel:addChild(label)
				
		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_3.png")
		line:setAnchorPoint(CCPoint(0.5,1))
		line:setScaleX(330/line:getContentSize().width)
		line:setPosition(360/2,132)
		self.rightPanel:addChild(line)
				
		--判断是否能创建
		local create_verify = GloblePlayerData.officium>=40 or GloblePlayerData.vip_level>=2
		local createBtn = dbUIButtonScale:buttonWithImage(create_verify and "UI/jia_zu/create_btn.png" or "UI/jia_zu/create_btn_disable.png",1.2)
		createBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		createBtn:setPosition(CCPoint(100, 95))
		if create_verify then
			createBtn.m_nScriptClickedHandler = function(ccp)
				self:createJiaZu()
			end
		end
		self.rightPanel:addChild(createBtn)
		local label = CCLabelTTF:labelWithString("需要神位40级\n或VIP2",CCSize(150,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(35,10))
		label:setColor(ccc3(233,171,120))
		self.rightPanel:addChild(label)
		
		--判断能否加入家族，如果已经在家族中了则不能加入
		local btn = dbUIButtonScale:buttonWithImage("UI/jia_zu/apply_btn.png",1.2)
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setPosition(CCPoint(260, 95))
		btn:setIsVisible(LegionData.legion_applied == 0)
		btn.m_nScriptClickedHandler = function(ccp)
			self:legionApplyNet(self.selected)
		end
		self.rightPanel:addChild(btn)
		self.applyBtn = btn
		
		--撤回申请
		local apply_verify = data.applied and LegionData.legion_applied == data.legion_id
		local btn = dbUIButtonScale:buttonWithImage(apply_verify and "UI/jia_zu/apply_cancel_btn.png" or "UI/jia_zu/apply_btn_disable.png",1.2,ccc3(99,99,99))
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setPosition(CCPoint(260, 95))
		btn:setIsVisible(data.applied or LegionData.legion_applied > 0)
		btn.m_nScriptClickedHandler = function(ccp)
			if apply_verify then
				self:legionApplyNet(-1)
			end
		end
		self.rightPanel:addChild(btn)
		self.cancelApplyBtn = btn	
	end,

	createJiaZu = function (self)
		local  createJunPanel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		self.mainWidget:addChild(createJunPanel,10000)
		createJunPanel.m_nScriptClickedHandler = function(ccp)
			createJunPanel:removeFromParentAndCleanup(true)
		end
		
		local bg = createBG("UI/public/dialog_kuang.png",620,440,CCSize(70,70))
		bg:setAnchorPoint(CCPoint(0.5, 0.5))
		bg:setPosition(CCPoint(512,384))
		createJunPanel:addChild(bg)

		local innerBg = createBG("UI/public/recuit_dark2.png",546,298)
		innerBg:setAnchorPoint(CCPoint(0.5, 0))
		innerBg:setPosition(CCPoint(620/2,90))
		bg:addChild(innerBg)
		
		local label = CCLabelTTF:labelWithString("创建家族", SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(546/2-30,256))
		label:setColor(ccc3(153,205,0))
		innerBg:addChild(label)
		local label = CCLabelTTF:labelWithString("(需300万银币)",CCSize(180,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(546/2+120,256))
		label:setColor(ccc3(184,148,74))
		innerBg:addChild(label)
		
		local label = CCLabelTTF:labelWithString("家族名称:",CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(37,200))
		label:setColor(ccc3(255,203,102))
		innerBg:addChild(label)
		local label = CCLabelTTF:labelWithString("(5个字以内)",CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(150,200))
		label:setColor(ccc3(184,147,76))
		innerBg:addChild(label)
		local inputBg = CCSprite:spriteWithFile("UI/jia_zu/input_bg.png")
		inputBg:setAnchorPoint(CCPoint(0, 0))
		inputBg:setPosition(CCPoint(47, 145))		
		innerBg:addChild(inputBg)
		local inputName = dbUIWidgetInput:inputWithText("","Thonburi", 24,false,5,CCRectMake(70,150,400,40))
		inputName:setNeedFocus(true)
		innerBg:addChild(inputName)

		local label = CCLabelTTF:labelWithString("家族公告:",CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(37,100))
		label:setColor(ccc3(255,203,102))
		innerBg:addChild(label)
		local label = CCLabelTTF:labelWithString("(50个字以内)",CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(150,100))
		label:setColor(ccc3(184,147,76))
		innerBg:addChild(label)
		local inputBg = CCSprite:spriteWithFile("UI/jia_zu/input_bg.png")
		inputBg:setAnchorPoint(CCPoint(0, 0))
		inputBg:setPosition(CCPoint(47, 34))		
		innerBg:addChild(inputBg)
		local inputText = dbUIWidgetInput:inputWithText("","Thonburi", 24,false,50,CCRectMake(70,40,400,40))
		inputText:setNeedFocus(true)
		innerBg:addChild(inputText)

		local createBtn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
		createBtn:setAnchorPoint(CCPoint(0.5,0.5))
		createBtn:setPosition(CCPoint(620/2,55))
		createBtn.m_nScriptClickedHandler = function()
			local nameLenght = string.len(inputName:getString())
			local contentLenght = string.len(inputText:getString())
			if nameLenght > 3*5 then
				alertOK("家族名称过长")
				return
			end
			if nameLenght ==0  then
				alertOK("家族名称不能为空")
				return
			end
			if contentLenght > 3*50 then
				alertOK("家族公告过长")
				return
			end
			self:createJiaZuNet(inputName:getString(),inputText:getString())
			createJunPanel:removeFromParentAndCleanup(true)
		end
		bg:addChild(createBtn)
		
		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setAnchorPoint(CCPoint(0.5,0.5))
		closeBtn:setPosition(CCPoint(580,400))
		closeBtn.m_nScriptClickedHandler = function()
			createJunPanel:removeFromParentAndCleanup(true)
		end
		bg:addChild(closeBtn)
	end,

	createJiaZuNet = function (self,name,notice)
		local function opFinishCB (s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				self:destroy()
				initLegionData(s)
				createJiaZuMain()
			end
		end

		showWaitDialogNoCircle("waiting OPT_LegionCreate ")
		NetMgr:registOpLuaFinishedCB(Net.OPT_LegionCreate, opFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_LegionCreate, opFailedCB)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("name",name )
		cj:setByKey("notice",notice )
		NetMgr:executeOperate(Net.OPT_LegionCreate, cj)
	end,

	legionApplyNet = function (self,legion_id)
		local function opApplyFinishCB (s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				if legion_id == -1 then --撤回申请
					self.applyBtn:setIsVisible(true)
					self.cancelApplyBtn:setIsVisible(false)
					LegionData.legion_applied = 0

					for i=1, #LegionData.list do
						LegionData.list[i].applied = false
					end
					self:createLeft()
				else
					self.applyBtn:setIsVisible(false)
					self.cancelApplyBtn:setIsVisible(true)
					LegionData.legion_applied = legion_id
					
					for i=1, #LegionData.list do
						if legion_id == LegionData.list[i].legion_id then
							LegionData.list[i].applied = true
						else
							LegionData.list[i].applied = false
						end
					end
					self:createLeft()
				end
			end
		end

		showWaitDialogNoCircle("waiting Raid data")
		NetMgr:registOpLuaFinishedCB(Net.OPT_LegionApply, opApplyFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_LegionApply, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("legion_id",legion_id )
		NetMgr:executeOperate(Net.OPT_LegionApply, cj)
	end,
	
	--初始化界面，包括头部，背景
	initBase = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()
		
		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
		bg:setPosition(CCPoint(1010/2, 702/2))

		self.centerWidget:addChild(bg)
		self.centerWidget:addChild(self.mainWidget)

		--面板提示图标
		local nice = CCSprite:spriteWithFile("UI/public/title_tip_bg.png")
		nice:setPosition(CCPoint(-5, 768 - 125))
		nice:setAnchorPoint(CCPoint(0, 0.5))
		self.centerWidget:addChild(nice)
		local label = CCLabelTTF:labelWithString("家族列表", SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5,0.5))
		label:setPosition(CCPoint(100,32))
		label:setColor(ccc3(255,203,153))
		nice:addChild(label)
		
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 768 - 125))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		closeBtn.btn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		self.centerWidget:addChild(closeBtn.btn)
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		removeUnusedTextures()
	end,
}
--家族 自己有家族了才显示这个 面板

function createJiaZuMain()
	GlobalJZMainPanel = new(JZMainPanel):create()
	createJiaZuMembers()
end

--成员
function createJiaZuMembers()
	addJiaZuBg("UI/public/bg.png")
	local jzm = new(JZMembersPanel):create()
	GlobalJZMainPanel.mainWidget:addChild(jzm.bg)
end

--家族建设
function createJiaZuJianSe()
	addJiaZuBg("UI/public/bg_light.png")
	local jzjs = new(JZJianSePanel):create()
	GlobalJZMainPanel.mainWidget:addChild(jzjs.bg)
end

--家族聊天
function createJiaZuLiaoTian()
	addJiaZuBg("UI/public/bg_light.png")
	local panel = new(JZChatPanel):create()
	GlobalJZMainPanel.mainWidget:addChild(panel.bg)
end

--申请列表
function createJiaZuApply()
	addJiaZuBg("UI/public/bg.png")
	local jzm = new(JZApplyPanel):create()
	GlobalJZMainPanel.mainWidget:addChild(jzm.bg)
end

--显示家族信息
function createJiaZuInfo()
	addJiaZuBg("UI/public/bg.png")
	local jzm = new(JZInfoPanel):create()
	GlobalJZMainPanel.mainWidget:addChild(jzm.bg)
end

function addJiaZuBg(img)
	local bg = CCSprite:spriteWithFile(img,-1)
	bg:setPosition(CCPoint(1010/2, 702/2))
	GlobalJZMainPanel.centerWidget:addChild(bg)	
end

JZMainPanel = {
	bg = nil,
	list = {},
	pageCount = 1,
	page  = 1,
	selected = 0,

	create = function(self)
		local scene = DIRECTOR:getRunningScene()

		self.bgLayer = createPanelBg()
		self.uiLayer,self.centerWidget = createCenterWidget()

		self.mainWidget = createMainWidget()

		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)

		self.centerWidget:addChild(self.mainWidget,1)

		local topbtn = new(JZJianSeTopButton):create()
		self.centerWidget:addChild(topbtn.bg,100)

		--注册开关切换事件
		for i = 1 , table.getn(topbtn.toggles) do
			topbtn.toggles[i].m_nScriptClickedHandler = function()
				if (topbtn.toggles[i]:isToggled()) then
					self.mainWidget:removeAllChildrenWithCleanup(true)
					if i==1 then
						createJiaZuMembers()
					elseif i==2 then
						createJiaZuLiaoTian()
					elseif i==3 then
						if LegionDetail.position == 1 then	--族长第三个为申请列表
							createJiaZuApply()
						else								--成员则为家族信息
							createJiaZuInfo()
						end
					elseif i==4 then
						createJiaZuInfo()
					end
				end
				topbtn:toggle(i)
			end
		end

		--关闭按钮
		topbtn.closeBtn.m_nScriptClickedHandler = function()
			self:destroy()
		end
		return self
	end,

	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		if JiaZuChatSecondHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(JiaZuChatSecondHandle)
			JiaZuChatSecondHandle = nil
		end		
		removeUnusedTextures()
	end,
}

JZJianSeTopButton = {
	bg = nil,
	toggles = {},
	closeBtn = nil,
	backBtn = nil,

	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(0,598))
		local topBtnConfig = (LegionDetail.position == 1) and JZjianSeTopBtnConfigForShaikh or JZjianSeTopBtnConfigForMember
		for i = 1 , table.getn(topBtnConfig) do
			local btn = dbUIButtonToggle:buttonWithImage(topBtnConfig[i].normal,topBtnConfig[i].toggle)
			btn:setAnchorPoint(CCPoint(0, 0))
			btn:setPosition(topBtnConfig[i].position)
			self.toggles[i] = btn
			self.bg:addChild(btn)
		end
		self:toggle(1)

		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		self.bg:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn

		return self
	end,

	--切换
	toggle = function(self,topid)
		public_toggleRadioBtn(self.toggles,self.toggles[topid])
	end
}
--族长视角按钮配置，拥有申请列表
JZjianSeTopBtnConfigForShaikh = {
	{
		normal = "UI/jia_zu/cy_1.png",
		toggle = "UI/jia_zu/cy_2.png",
		position = 	CCPoint(100, 12),
	},
	{
		normal = "UI/jia_zu/lt_1.png",
		toggle = "UI/jia_zu/lt_2.png",
		position = 	CCPoint(100 + 190*1, 12),
	},
	{
		normal = "UI/jia_zu/lb_1.png",
		toggle = "UI/jia_zu/lb_2.png",
		position = 	CCPoint(100 + 190*2, 12),
	},
	{
		normal = "UI/jia_zu/xx_1.png",
		toggle = "UI/jia_zu/xx_2.png",
		position = 	CCPoint(100 + 190*3, 12),
	},
}

--成员视角按钮配置
JZjianSeTopBtnConfigForMember = {
	{
		normal = "UI/jia_zu/cy_1.png",
		toggle = "UI/jia_zu/cy_2.png",
		position = 	CCPoint(100, 12),
	},
	{
		normal = "UI/jia_zu/lt_1.png",
		toggle = "UI/jia_zu/lt_2.png",
		position = 	CCPoint(100 + 190*1, 12),
	},
	{
		normal = "UI/jia_zu/xx_1.png",
		toggle = "UI/jia_zu/xx_2.png",
		position = 	CCPoint(100 + 190*2, 12),
	},
}
--家族聊天 
JiaZuChatSecondHandle = nil
local msgLastIdx = 0
JZChatPanel = {
	bg = nil,
	secondHandle = nil,
	msgCurLine = 0,
	
	initSecondHandle = function(self)
		msgLastIdx = 0
		
		local opSuccessCB = function (json)
			local error_code = json:getByKey("error_code"):asInt()
			if error_code == -1 then
				msgLastIdx = json:getByKey("last_index"):asInt()
				local message_list = json:getByKey("message_list")
				for i = message_list:size(), 1,-1 do
					local msg = message_list:getByIndex(i-1)
					self:insertMsg({
						name = msg:getByKey("name"):asString(),
						position = msg:getByKey("position"):asInt(),
						content =  msg:getByKey("content"):asString()
					})
				end
			end
		end
		
		local action = Net.OPT_LegionCheckChatData
		NetMgr:registOpLuaFinishedCB(action,opSuccessCB)
		NetMgr:registOpLuaFailedCB(action,opFailedCB)
	
		local secondHandleFunction = function()
			self:checkChatData()
		end
		self:checkChatData()
		
		if JiaZuChatSecondHandle == nil then
			JiaZuChatSecondHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(secondHandleFunction, 5, false)
		end
	end,
	
	checkChatData = function(self)
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("last_idx", msgLastIdx)
		NetMgr:executeOperate(Net.OPT_LegionCheckChatData, cj)
	end,

	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 702))
		self.bg:setAnchorPoint(CCPoint(0, 0))

		self:createMsgPanel()
		self:createRight()
		
		self:initSecondHandle()
		return self
	end,

	createMsgPanel = function(self)
		local msgPanel = createBG("UI/public/kuang_xiao_mi_shu.png",600,470)
		msgPanel:setAnchorPoint(CCPoint(0, 0))
		msgPanel:setPosition(CCPoint(44, 110))
		self.bg:addChild(msgPanel)

		local scrollList = dbUIScrollList:scrollList(CCRectMake(0,5,570,450),0)
		msgPanel:addChild(scrollList)
		self.msgList = scrollList
		
		local inputPanel = createBG("UI/public/kuang_xiao_mi_shu.png",600,60)
		inputPanel:setAnchorPoint(CCPoint(0, 0))
		inputPanel:setPosition(CCPoint(44, 40))
		self.bg:addChild(inputPanel)

		local input = dbUIWidgetInput:inputWithText("","Thonburi", 24,false,100,CCRectMake(20,15,400,30))
		input:setNeedFocus(true)
		inputPanel:addChild(input)

		local btn = dbUIButtonScale:buttonWithImage("UI/jia_zu/send_msg.png",1.2)
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setPosition(CCPoint(538, 30))
		btn.m_nScriptClickedHandler = function(ccp)
			self:sendMsg(input:getString())
			input:setString("")
		end
		inputPanel:addChild(btn)input.m_ScriptKeyboardDidShow = function()
        inputPanel:runAction(CCMoveTo:actionWithDuration(0.1,CCPoint(50,380)))
		end
		input.m_ScriptKeyboardDidHide = function()
       inputPanel:runAction(CCMoveTo:actionWithDuration(0.1,CCPoint(50,42)))
		end
		
	end,

	createRight = function(self)
		if self.rightPanel then
			self.rightPanel:removeFromParentAndCleanup(true)
			self.rightPanel = nil
		end
		
		self.rightPanel = createBG("UI/public/kuang_xiao_mi_shu.png",323,540)
		self.rightPanel:setAnchorPoint(CCPoint(0, 0))
		self.rightPanel:setPosition(CCPoint(650, 40))
		self.bg:addChild(self.rightPanel)

		local label = CCLabelTTF:labelWithString("家族黑板报", SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(323/2,495))
		label:setColor(ccc3(153,205,0))
		self.rightPanel:addChild(label)

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_3.png")
		line:setAnchorPoint(CCPoint(0.5,0))
		line:setScaleX(300/line:getContentSize().width)
		line:setPosition(323/2,480)
		self.rightPanel:addChild(line)

		local label = CCLabelTTF:labelWithString(LegionDetail.blackboard,CCSize(280,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,1))
		label:setPosition(CCPoint(20,460))
		label:setColor(ccc3(255,205,152))
		self.rightPanel:addChild(label)
		self.blackboardLabel =  label

		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_3.png")
		line:setAnchorPoint(CCPoint(0.5,1))
		line:setScaleX(300/line:getContentSize().width)
		line:setPosition(323/2,80)
		self.rightPanel:addChild(line)
		
		--只有族长才显示
		if LegionDetail.position==1 then
			local btn = dbUIButtonScale:buttonWithImage("UI/jia_zu/edit_notice.png",1.2)
			btn:setAnchorPoint(CCPoint(0.5, 0.5))
			btn:setPosition(CCPoint(323/2, 40))
			btn.m_nScriptClickedHandler = function(ccp)
				self:editBlackboard()
			end
			self.rightPanel:addChild(btn)
		end
	end,
	
	--在消息面板中插入消息
	insertMsg = function(self,data)
		local scrollList = self.msgList
		
		local item = dbUIPanel:panelWithSize(CCSize(570,45))
		
		local color = self.msgCurLine%2==0 and ccc3(255,214,109) or ccc3(249,179,58)
		local name = data.name
		if data.position==1 or data.position==2 or data.position==3 then
			name = name.."("..MembersCfg[data.position]..")"
			color = ccc3(152,203,0)
		end
		
		local label = CCLabelTTF:labelWithString(name.."："..data.content,CCSize(550,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(23,66/2))
		label:setColor(color)
		item:addChild(label)

		scrollList:insterDetail(item)
		
		self.msgCurLine = self.msgCurLine + 1
		scrollList:setContentPosition(CCPoint(0,0))
	end,
	
	sendMsg = function (self,content)
		local contentLenght = string.len(content)
		if contentLenght > 3*50 then
			alertOK("内容过长")
			return
		end
		if contentLenght == 0 then
			alertOK("内容不能为空")
			return
		end
			
		local function opChatFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				self:checkChatData()
			end
		end

		local function execChat()
			showWaitDialogNoCircle("")
			NetMgr:registOpLuaFinishedCB(Net.OPT_Chat, opChatFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_Chat, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("channel",4)
			cj:setByKey("content",content)
			NetMgr:executeOperate(Net.OPT_Chat, cj)
		end
		execChat()
	end,

	editBlackboard = function (self)
		local createJunPanel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		createJunPanel.m_nScriptClickedHandler = function(ccp)
			createJunPanel:removeFromParentAndCleanup(true)
		end
		self.bg:addChild(createJunPanel,100000)
		
		local createbg = createBG("UI/public/dialog_kuang.png",640,280)
		createbg:setAnchorPoint(CCPoint(0.5, 0.5))
		createbg:setPosition(CCPoint(512,384))
		createJunPanel:addChild(createbg)

		local noticeKuang = createBG("UI/public/recuit_dark2.png",545,136,CCSize(20,20))
		noticeKuang:setAnchorPoint(CCPoint(0.5, 0))
		noticeKuang:setPosition(CCPoint(640/2, 100))
		createbg:addChild(noticeKuang)

		local label = CCLabelTTF:labelWithString("修改黑板报:",CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(25,90))
		label:setColor(ccc3(153,205,0))
		noticeKuang:addChild(label)
		
		local label = CCLabelTTF:labelWithString("(50字以内)",CCSize(200,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(215,90))
		label:setColor(ccc3(184,148,74))
		noticeKuang:addChild(label)
		
		local inputBg = CCSprite:spriteWithFile("UI/jia_zu/input_bg.png")
		inputBg:setAnchorPoint(CCPoint(0, 0))
		inputBg:setPosition(CCPoint(26, 30))		
		noticeKuang:addChild(inputBg)
		
		local inputText = dbUIWidgetInput:inputWithText("","Thonburi", 24,false,150,CCRectMake(40,40,400,40))
		inputText:setNeedFocus(true)
		noticeKuang:addChild(inputText)
		
		local createBtn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
		createBtn:setAnchorPoint(CCPoint(0.5,0.5))
		createBtn:setPosition(CCPoint(640/2,60))
		createBtn.m_nScriptClickedHandler = function()
			self:setBlackborad(inputText:getString())
			createJunPanel:removeFromParentAndCleanup(true)
		end
		createbg:addChild(createBtn)

		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setAnchorPoint(CCPoint(0.5,0.5))
		closeBtn:setPosition(CCPoint(600,230))
		closeBtn.m_nScriptClickedHandler = function()
			createJunPanel:removeFromParentAndCleanup(true)
		end
		createbg:addChild(closeBtn)		
	end,

	setBlackborad = function (self,blackboard)
		local contentLenght = string.len(blackboard)
		if contentLenght > 3*50 then
			alertOK("内容过长")
			return
		end
		if contentLenght ==0 then
			alertOK("内容不能为空")
			return
		end
		
		local function setFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				alert("修改成功  ")
				if LegionDetail.legion_id == LegionData.legion_id then
					LegionDetail.blackboard = blackboard
					self.blackboardLabel:setString(LegionDetail.blackboard)
				end
			end
		end

		local function setNoticeNet()
			showWaitDialogNoCircle("waiting add data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_LegionModifyBlackboard, setFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_LegionModifyBlackboard, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("blackboard",blackboard)  
			
			NetMgr:executeOperate(Net.OPT_LegionModifyBlackboard, cj)
		end
		setNoticeNet()		
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.mainWidget = nil
		if JiaZuChatSecondHandle then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(JiaZuChatSecondHandle)
			JiaZuChatSecondHandle = nil
		end
		removeUnusedTextures()
	end,
}
--家族 建设 面板
JZJianSePanel = {
	bg = nil,
	tech_list = {},
	contribute = 0,
	selected = 1,

	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 702))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self:developNet(1,LegionData.legion_id)
		return self
	end,

	createMain = function(self)
		self.bg:removeAllChildrenWithCleanup(true)
		self:createLeft()
		self:createRight(self.selected)
	end,

	createRight = function(self,index)
		local tech_list = self.tech_list
		if table.getn(tech_list)==0 then
			return
		end

		if self.rightPanel then
			self.bg:removeChild(self.rightPanel,true)
			self.rightPanel = nil
		end

		local item = tech_list[index]

		self.rightPanel = createDarkBG(360,545)
		self.rightPanel:setAnchorPoint(CCPoint(0, 0))
		self.rightPanel:setPosition(CCPoint(610, 40))
		self.bg:addChild(self.rightPanel)

		local kuangIcon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
		kuangIcon:setPosition(48,48)

		local mImage = CCSprite:spriteWithFile("UI/juntuan/teach"..index..".png")
		mImage:setPosition(CCPoint(48 ,48))

		local panelKuang = dbUIPanel:panelWithSize(CCSize(96,96))
		panelKuang:setPosition(12, 432)
		panelKuang:addChild(kuangIcon)
		panelKuang:addChild(mImage)
		self.rightPanel:addChild(panelKuang)

		local label = CCLabelTTF:labelWithString(cfg_legion_tech[item.tech_id].name, CCSize(300,0),0,SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(130, 493))
		label:setColor(ccc3(152,203,0))
		self.rightPanel:addChild(label)

		local label = CCLabelTTF:labelWithString("当前等级：", CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(130, 454))
		label:setColor(ccc3(255,204,154))
		self.rightPanel:addChild(label)
		local label = CCLabelTTF:labelWithString(item.level, CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(260, 454))
		label:setColor(ccc3(248,100,0))
		self.rightPanel:addChild(label)

		local all = item.level *cfg_legion_tech[item.tech_id].contribute_level + cfg_legion_tech[item.tech_id].contribute_base
		local bar = new(Bar2)
		bar:create(all, JZ_JIAN_SE_BAR_CFG)
		bar:setExtent(item.contribute)
		self.rightPanel:addChild(bar.barbg)

		--技能描述框
		local descKuang = dbUIWidgetBGFactory:widgetBG()
		descKuang:setBGSize(CCSizeMake(326,110))
		descKuang:setCornerSize(CCSizeMake(12,12))
		descKuang:createCeil("UI/public/desc_bg.png")
		descKuang:setAnchorPoint(CCPoint(0.5,0))
		descKuang:setPosition(CCPoint(360/2, 250))
		self.rightPanel:addChild(descKuang)

		local descLabel = CCLabelTTF:labelWithString(cfg_legion_tech[item.tech_id].desc,CCSize(288,130),0, SYSFONT[EQUIPMENT], 22)
		descLabel:setColor(ccc3(106,56,5))
		descLabel:setAnchorPoint(CCPoint(0.5,0.5))
		descLabel:setPosition(CCPoint(descKuang:getContentSize().width/2, descKuang:getContentSize().height/2))
		descKuang:addChild(descLabel)

		local createBtn = dbUIButtonScale:buttonWithImage("UI/jia_zu/yb.png",1.2)
		createBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		createBtn:setPosition(CCPoint(360/2, 60))
		createBtn.m_nScriptClickedHandler = function(ccp)
			self:createJuanKuan(item)
		end
		self.rightPanel:addChild(createBtn)
	end,

	createJuanKuan = function (self,item)
		local  createJunPanel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		createJunPanel.m_nScriptClickedHandler = function(ccp)
			createJunPanel:removeFromParentAndCleanup(true)
		end
		self.bg:addChild(createJunPanel,100000)

		local createbg = createBG("UI/public/dialog_kuang.png",550,340)
		createbg:setAnchorPoint(CCPoint(0.5, 0.5))
		createbg:setPosition(CCPoint(512,384))
		createJunPanel:addChild(createbg)

		local label = CCLabelTTF:labelWithString("家族建设",CCSize(0,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(550/2,260))
		label:setColor(ccc3(51,102,1))
		createbg:addChild(label)

		local label = CCLabelTTF:labelWithString("贡献银币：",CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(50,160))
		label:setColor(ccc3(51,102,1))
		createbg:addChild(label)
		local yinLabel = CCLabelTTF:labelWithString("0",CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
		yinLabel:setAnchorPoint(CCPoint(0,0))
		yinLabel:setPosition(CCPoint(200,160))
		yinLabel:setColor(ccc3(248,100,0))
		createbg:addChild(yinLabel)

		--滑动条
		local cfg = new(JZ_JIAN_SE_BAR_CFG)
		cfg.position = CCPoint(55, 220)
		cfg.borderSize =  {width = 440,height = 32}
		cfg.entitySize = {width = 440,height = 28}

		local all = GloblePlayerData.copper
		local bar = new(Bar2)
		bar:create(all, cfg)
		bar:setExtent(0)
		createbg:addChild(bar.barbg)

		--滑动的点
		local m_temp = 293
		local t_temp = 440-30
		local image = CCSprite:spriteWithFile("UI/jia_zu/la.png")
		local drag =  dbUIWidget:widgetWithSprite(image)
		drag:setAnchorPoint(CCPoint(0,0))
		drag:setPosition(CCPoint(512-220,384+37))
		drag.m_nScriptDragMoveHandler = function(pos,prevPos)
			local pos1 = drag:convertToNodeSpace(pos)
			local prevPos1 = drag:convertToNodeSpace(prevPos)
			local m_pos = drag:getPositionX()-prevPos1.x + pos1.x
			if m_pos <m_temp or m_pos>m_temp+t_temp then
				return
			end
			drag:setPositionX(m_pos)
			bar:setExtent(all*(drag:getPositionX()-m_temp)/400)
			yinLabel:setString(math.floor(bar.cur))
		end
		createJunPanel:addChild(drag,100)

		local createBtn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
		createBtn:setAnchorPoint(CCPoint(0.5,0.5))
		createBtn:setPosition(CCPoint(550/2,80))
		createBtn.m_nScriptClickedHandler = function(ccp)
			if bar.cur==0 then
				createJunPanel:removeFromParentAndCleanup(true)
			else
				self:developNet(2,0,item.tech_id,bar.cur)
			end
		end
		createbg:addChild(createBtn,10)
	end,
	createLeft = function(self)
		self.leftPanel = createDarkBG(557,480)
		self.leftPanel:setAnchorPoint(CCPoint(0, 0))
		self.leftPanel:setPosition(CCPoint(40, 40))
		self.bg:addChild(self.leftPanel)

		local zhi = CCSprite:spriteWithFile("UI/jia_zu/zong.png")
		zhi:setAnchorPoint(CCPoint(0, 0))
		zhi:setPosition(CCPoint(50,540))
		self.bg:addChild(zhi)

		local contribute = CCLabelTTF:labelWithString(self.contribute,CCSize(288,0),0, SYSFONT[EQUIPMENT], 37)
		contribute:setColor(ccc3(106,56,5))
		contribute:setAnchorPoint(CCPoint(0, 0))
		contribute:setPosition(CCPoint(225,540))
		self.bg:addChild(contribute)

		local list = self.tech_list
		local index = 1
		local line = 1
		for i=1,table.getn(list) do
			if index > 3 then
				index = 1
				line = line + 1
			end

			local kuangIcon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			kuangIcon:setPosition(48,48+30)

			local mImage  = dbUIButtonScale:buttonWithImage("UI/juntuan/teach"..i..".png",1.2)
			mImage:setPosition(CCPoint(48 ,48+30))
			mImage.m_nScriptClickedHandler = function(ccp)
				self.selected = i
				self:createRight(i)
			end
			local panelKuang = dbUIPanel:panelWithSize(CCSize(96,126))
			panelKuang:setPosition(30+(index-1)*126, 330-(line-1)*130)
			panelKuang:addChild(kuangIcon)
			panelKuang:addChild(mImage)
			self.leftPanel:addChild(panelKuang)

			local label = CCLabelTTF:labelWithString("等级："..list[i].level,SYSFONT[EQUIPMENT], 24)
			label:setAnchorPoint(CCPoint(0.5,0))
			label:setPosition(CCPoint(48,0))
			label:setColor(ccc3(255,203,0))
			panelKuang:addChild(label)

			index = index + 1
		end
	end,

	initDevelopList = function(self,json)
		self.tech_list = new ({})
		self.contribute = json:getByKey("contribute"):asInt()
		local tech_list = json:getByKey("tech_list")
		for i = 1,tech_list:size() do
			local pre = tech_list:getByIndex(i-1)
			self.tech_list[i] = new ({})
			self.tech_list[i].level = pre:getByKey("level"):asInt()
			self.tech_list[i].contribute = pre:getByKey("contribute"):asInt()
			self.tech_list[i].tech_id = pre:getByKey("tech_id"):asInt()
		end
	end,

	developNet = function(self,m_type,legion_id,tech_id,cooper)
		local developListNetCB = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				self:initDevelopList(json)
				self:createMain()
			end
		end

		local sendRequest = function ()
			local action = Net.OPT_LegionTech
			if m_type == 2  then
				action =Net.OPT_LegionContribute
			end

			showWaitDialogNoCircle("!")
			NetMgr:registOpLuaFinishedCB(action,developListNetCB)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			if m_type == 1 then
				cj:setByKey("legion_id", legion_id)
			elseif m_type ==2 then
				cj:setByKey("tech_id",tech_id)
				cj:setByKey("cooper",cooper)
			end
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,
}

JZ_JIAN_SE_BAR_CFG = {
	res = {border = "UI/bar/bar_bg.png",entity = "UI/bar/bar_green.png",},
	borderSize = {width = 296,height = 32},
	entitySize = {width = 296,height = 28},
	fontSize = 26,
	position = CCPoint(32, 382),
	borderCornerSize = CCSize(11,16),
	entityCornerSize = CCSize(10,14)
}
--家族 成员 面板
local MembersList = {
	legion_list = {},
	legion_id = nil,
}
MembersCfg = {
	"族长",
	"元老",
	"团长",
	"队长",
	"扈从",
	"成员"
}
JZMembersPanel = {
	bg = nil,

	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 702))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self:membersListNet(1,LegionData.legion_id)
		return self
	end,

	createMain = function(self)
		self.bg:removeAllChildrenWithCleanup(true)

		local listBg = createBG("UI/public/kuang_xiao_mi_shu.png",928,465)
		listBg:setAnchorPoint(CCPoint(0, 0))
		listBg:setPosition(CCPoint(40, 120))
		self.bg:addChild(listBg)

		local list_head = createBG("UI/ri_chang/list_head_bg.png",928,77,CCSize(20,20))
		list_head:setAnchorPoint(CCPoint(0, 1))
		list_head:setPosition(CCPoint(0, 465))
		listBg:addChild(list_head)

		--头部标题
		local label = CCLabelTTF:labelWithString("家族职位",CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(20,77/2))
		label:setColor(ccc3(255,152,3))
		list_head:addChild(label)
		
		local label = CCLabelTTF:labelWithString("玩家名",CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(292,77/2))
		label:setColor(ccc3(255,152,3))
		list_head:addChild(label)
		
		local label = CCLabelTTF:labelWithString("神位等级",CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(527,77/2))
		label:setColor(ccc3(255,152,3))
		list_head:addChild(label)
		
		local label = CCLabelTTF:labelWithString("登录",CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(800,77/2))
		label:setColor(ccc3(255,152,3))
		list_head:addChild(label)

		--显示成员列表
		local itemList = dbUIList:list(CCRectMake(0,0,928,465-78),0)
		listBg:addChild(itemList)

		local list = MembersList.legion_list
		for i = 1 , table.getn(list) do
			local member = list[i]

			local item = dbUIPanel:panelWithSize(CCSize(928,48))
			itemList:insterWidget(item)

			--分割线
			local line = CCSprite:spriteWithFile("UI/public/line_2.png")
			line:setAnchorPoint(CCPoint(0,0))
			line:setScaleX(928/28)
			line:setPosition(2, 0)
			item:addChild(line)

			local label = CCLabelTTF:labelWithString(MembersCfg[member.position],CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(45,48/2))
			label:setColor(ccc3(254,205,102))
			item:addChild(label)
			
			local label = CCLabelTTF:labelWithString(member.name,CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(270,48/2))
			label:setColor(ccc3(254,205,102))
			item:addChild(label)
			
			local label = CCLabelTTF:labelWithString(member.officium,CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(560,48/2))
			label:setColor(ccc3(254,205,102))
			item:addChild(label)
			
			local label = CCLabelTTF:labelWithString(os.date("%m",member.last_heartbeat/1000).."月"..
			os.date("%d",member.last_heartbeat/1000).."日 "..
			os.date("%H",member.last_heartbeat/1000)..":"..
			os.date("%M",member.last_heartbeat/1000), SYSFONT[EQUIPMENT], 25)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(720,48/2))
			label:setColor(ccc3(254,205,102))
			item:addChild(label)

			item.m_nScriptClickedHandler = function(ccp)
				self:createContextMenu(item,member)
			end
		end
		itemList:m_setPosition(CCPoint(0,- itemList:get_m_content_size().height + itemList:getContentSize().height ))

		--退出家族按钮
		local btn = dbUIButtonScale:buttonWithImage("UI/jia_zu/leavel.png",1.2)
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		btn:setPosition(CCPoint(1010/2, 80))
		btn.m_nScriptClickedHandler = function(ccp)
			new(ConfirmDialog):show({
				text = "确定退出家族?",
				onClickOk = function()
					self:membersListNet(2,ClientData.role_id)
				end,
			})
		end
		self.bg:addChild(btn)
	end,

	createContextMenu = function (self,item,member)
		--选中的时候的底色
		local list_item_bg = createBG("UI/public/recuit_dark2.png",920,50,CCSize(20,20))
		list_item_bg:setAnchorPoint(CCPoint(0.5, 0.5))
		list_item_bg:setPosition(CCPoint(928/2, 48/2+3))
		item:addChild(list_item_bg,-1)

		local panel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		panel.m_nScriptClickedHandler = function(ccp)
			item:removeChild(list_item_bg,true)
			panel:removeFromParentAndCleanup(true)
		end
		self.bg:addChild(panel,100000)
		
		local isShaikh = (ClientData.role_id == MembersList.leader_id)
		local createbg = createBG("UI/public/tankuang_bg.png",260, isShaikh and 310 or 110)
		createbg:setAnchorPoint(CCPoint(0.5, 0.5))
		createbg:setPosition(CCPoint(512,384))
		panel:addChild(createbg)
		
		local index = 1
		--查看
		local btn = dbUIButtonScale:buttonWithImage("UI/jia_zu/view.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(260/2, isShaikh and 240-(index-1)*80 or 55))
		btn.m_nScriptClickedHandler = function(ccp)
			--Log(">>>>>>>>>>>>>>>>>>>>>>>>>>>"..member.role_id.."  "..member.name)
			createViewTargetPanel(member.role_id,member.name)	
		end
		createbg:addChild(btn)
		index = index + 1
		
		if isShaikh then
			--转让族长
			local btn = dbUIButtonScale:buttonWithImage("UI/jia_zu/zr.png", 1, ccc3(125, 125, 125))
			btn:setAnchorPoint(CCPoint(0.5,0.5))
			btn:setPosition(CCPoint(260/2,240-(index-1)*80))
			btn.m_nScriptClickedHandler = function(ccp)
				new(ConfirmDialog):show({
					text = "是否将族长转让给"..member.name,
					width = 440,
					onClickOk = function()
						self:membersListNet(3,member.role_id)
					end,
				})
			end
			createbg:addChild(btn)
			index = index + 1
			--驱逐出家族
			local btn = dbUIButtonScale:buttonWithImage("UI/jia_zu/go_out.png", 1, ccc3(125, 125, 125))
			btn:setAnchorPoint(CCPoint(0.5,0.5))
			btn:setPosition(CCPoint(260/2,240-(index-1)*80))
			btn.m_nScriptClickedHandler = function(ccp)
				new(ConfirmDialog):show({
					text = "是否将"..member.name.."清除出家族",
					width = 440,
					onClickOk = function()
						self:membersListNet(2,member.role_id)
					end,
				})		
			end
			createbg:addChild(btn)
		end
	end,

	--m_type 1: 查看列表 2： 离开家族 3  更换老大
	membersListNet = function (self,m_type,target_id)

		local order = {
			function (a,b)
				return a.index > b.index
			end,
			function (a,b)
				return a.last_heartbeat > b.last_heartbeat
			end,
			function (a,b)
				return a.position < b.position
			end
		}

		local membersListNetCB = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				if m_type ==2 then
					if target_id == ClientData.role_id then
						GlobalJZMainPanel:destroy()
						globleShowJiaZu()
					else
						self:membersListNet(1)
					end
				elseif m_type ==3 then
					self:membersListNet(1)
				else
					self:initMembersList (json)
					table.sort(MembersList.legion_list,order[3])
					self:createMain()
				end
			end
		end

		local sendRequest = function ()
			local action = Net.OPT_LegionMember
			if m_type == 2  then
				action =Net.OPT_LegionLeave
			elseif m_type == 3 then
				action = Net.OPT_LegionLeaderTrans
			end

			showWaitDialogNoCircle("waiting skillLock!")
			NetMgr:registOpLuaFinishedCB(action,membersListNetCB)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)

			if m_type == 1 then
				cj:setByKey("legion_id", LegionData.legion_id)
			else
				cj:setByKey("target_id",target_id)
			end
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,

	initMembersList =function  (self,json)
		MembersList.legion_list = new ({})
		MembersList.legion_id = json:getByKey("legion_id"):asBool()
		MembersList.leader_id = 0
		local legion_list = json:getByKey("legion_mem_list")
		for i = 1,legion_list:size() do
			local pre = legion_list:getByIndex(i-1)
			MembersList.legion_list[i] = new ({})
			MembersList.legion_list[i].position = pre:getByKey("position"):asInt() == 0 and 6 or pre:getByKey("position"):asInt()
			MembersList.legion_list[i].is_online = pre:getByKey("is_online"):asBool()
			MembersList.legion_list[i].role_id = pre:getByKey("role_id"):asInt()
			MembersList.legion_list[i].last_heartbeat = pre:getByKey("last_heartbeat"):asDouble()
			MembersList.legion_list[i].name = pre:getByKey("name"):asString()
			MembersList.legion_list[i].contribute_rank = pre:getByKey("contribute_rank"):asInt()
			MembersList.legion_list[i].contribute = pre:getByKey("contribute"):asInt()
			MembersList.legion_list[i].officium = pre:getByKey("officium"):asInt()
			MembersList.legion_list[i].index = i

			if MembersList.legion_list[i].position ==1 then
				MembersList.leader_id = MembersList.legion_list[i].role_id
			end
		end
		local sortFunc = function(a,b)
			if a.contribute  ~= b.contribute then
				return a.contribute  > b.contribute
			else
				return a.officium  > b.officium
			end
		end
		table.sort(MembersList.legion_list,sortFunc)
		for i = 1 , table.getn(MembersList.legion_list) do
			MembersList.legion_list[i].order = i
		end
		local sortByIndex = function(a,b)
			return a.index  > b.index
		end
		table.sort(MembersList.legion_list,sortByIndex)
	end,

	--添加好友
	legionAddFriend = function(self,target_id)
		local function opAddFriendFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				local dialogCfg = new(basicDialogCfg)
				dialogCfg.msg = "添加成功"
				dialogCfg.msgAlign = "center"
				dialogCfg.bg = "UI/public/dialog_kuang.png"
				dialogCfg.position = CCPoint(WINSIZE.width / 2, WINSIZE.height / 2)
				dialogCfg.dialogType = 5
				dialogCfg.btns = btns
				local dialog = new(Dialog)
				dialog:create(dialogCfg)
			else
				ShowErrorInfoDialog(s:getByKey("error_code"):asInt())
			end
		end

		local function execAddFriend()
			showWaitDialogNoCircle("waiting add data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_FriendAction, opAddFriendFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_FriendAction, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("target_id",target_id) --friend_id
			cj:setByKey("action",1)   --1增加好友，2刪除好友
			NetMgr:executeOperate(Net.OPT_FriendAction, cj)
		end
		execAddFriend()
	end,
}
--家族 申请面板
ApplyList ={
	apply_list = {},
	can_approve = false,
}

function initApplyList (json)
	ApplyList.apply_list = new ({})
	ApplyList.can_approve = json:getByKey("can_approve"):asBool()
	local apply_list = json:getByKey("apply_list")
	for i = 1,apply_list:size() do
		local pre = apply_list:getByIndex(i-1)
		ApplyList.apply_list[i] = new ({})
		ApplyList.apply_list[i].apply_time = pre:getByKey("apply_time"):asDouble()
		ApplyList.apply_list[i].role_id = pre:getByKey("role_id"):asInt()
		ApplyList.apply_list[i].name = pre:getByKey("name"):asString()
		ApplyList.apply_list[i].job = pre:getByKey("job"):asInt()
		ApplyList.apply_list[i].officium = pre:getByKey("officium"):asInt()
	end
	
	if apply_list:size()==0 then
		local HUD = dbHUDLayer:shareHUD2Lua()
		local node = HUD:getChildByTag(309):getChildByTag(3091)
		node:setIsVisible(false)
		node:stopAction()
	end
end

JZApplyPanel = {
	bg = nil,

	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 702))
		self.bg:setAnchorPoint(CCPoint(0, 0))

		self:applyListNet(1,LegionData.legion_id)
		return self
	end,

	createMain = function(self)
		self.bg:removeAllChildrenWithCleanup(true)

		local listBg = createBG("UI/public/kuang_xiao_mi_shu.png",928,530)
		listBg:setAnchorPoint(CCPoint(0, 0))
		listBg:setPosition(CCPoint(40, 52))
		self.bg:addChild(listBg)

		local list_head = createBG("UI/ri_chang/list_head_bg.png",928,77,CCSize(20,20))
		list_head:setAnchorPoint(CCPoint(0, 1))
		list_head:setPosition(CCPoint(0, 530))
		listBg:addChild(list_head)

		--头部标题
		local label = CCLabelTTF:labelWithString("玩家名",CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(35,77/2))
		label:setColor(ccc3(255,152,3))
		list_head:addChild(label)
		local label = CCLabelTTF:labelWithString("神位等级",CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(260,77/2))
		label:setColor(ccc3(255,152,3))
		list_head:addChild(label)
		local label = CCLabelTTF:labelWithString("职业",CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(513,77/2))
		label:setColor(ccc3(255,152,3))
		list_head:addChild(label)
		local label = CCLabelTTF:labelWithString("申请时间",CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(703,77/2))
		label:setColor(ccc3(255,152,3))
		list_head:addChild(label)

		--显示成员列表
		local itemList = dbUIList:list(CCRectMake(0,0,928,530-78),0)
		listBg:addChild(itemList)

		local list = ApplyList.apply_list
		for i = 1 , table.getn(list) do
			local member = list[i]

			local item = dbUIPanel:panelWithSize(CCSize(928,48))
			itemList:insterWidget(item)

			--分割线
			local line = CCSprite:spriteWithFile("UI/public/line_2.png")
			line:setAnchorPoint(CCPoint(0,0))
			line:setScaleX(928/28)
			line:setPosition(2, 0)
			item:addChild(line)

			local label = CCLabelTTF:labelWithString(member.name,CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(35,48/2))
			label:setColor(ccc3(254,205,102))
			item:addChild(label)
			local label = CCLabelTTF:labelWithString(member.officium,CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(260,48/2))
			label:setColor(ccc3(254,205,102))
			item:addChild(label)
			local jobJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_job.json")
			local label = CCLabelTTF:labelWithString(jobJsonConfig:getByKey(member.job):getByKey("name"):asString(),CCSize(300,0),0, SYSFONT[EQUIPMENT], 32)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(513,48/2))
			label:setColor(ccc3(254,205,102))
			item:addChild(label)
			local label = CCLabelTTF:labelWithString(os.date("%Y-%m-%d %H:%M:%S",member.apply_time/1000), SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(660,48/2))
			label:setColor(ccc3(254,205,102))
			item:addChild(label)

			item.m_nScriptClickedHandler = function(ccp)
				self:createContextMenu(item,member)
			end
		end
		itemList:m_setPosition(CCPoint(0,- itemList:get_m_content_size().height + itemList:getContentSize().height ))
	end,

	createContextMenu = function (self,item,member)
		if ApplyList.can_approve then
			--选中的时候的底色
			local list_item_bg = createBG("UI/public/recuit_dark2.png",920,50,CCSize(20,20))
			list_item_bg:setAnchorPoint(CCPoint(0.5, 0.5))
			list_item_bg:setPosition(CCPoint(928/2, 48/2+3))
			item:addChild(list_item_bg,-1)

			local panel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
			panel.m_nScriptClickedHandler = function(ccp)
				item:removeChild(list_item_bg,true)
				panel:removeFromParentAndCleanup(true)
			end
			self.bg:addChild(panel,100000)

			local createbg = createBG("UI/public/dialog_kuang.png",260,220)
			createbg:setAnchorPoint(CCPoint(0.5, 0.5))
			createbg:setPosition(CCPoint(512,384))
			panel:addChild(createbg)

			--同意
			local btn = dbUIButtonScale:buttonWithImage("UI/jia_zu/agree.png", 1, ccc3(125, 125, 125))
			btn:setAnchorPoint(CCPoint(0.5,0.5))
			btn:setPosition(CCPoint(260/2,150))
			btn.m_nScriptClickedHandler = function(ccp)
				local dialogCfg = new(basicDialogCfg)
				dialogCfg.msg = "是否同意"..member.name.."加入家族？"
				dialogCfg.msgAlign = "center"
				dialogCfg.bg = "UI/baoguoPanel/kuang.png"
				dialogCfg.position = CCPoint(WINSIZE.width / 2, WINSIZE.height / 2)
				dialogCfg.dialogType = 5
				local btns = {}
				local bs = new(ButtonScale)
				bs:create("UI/public/noTextBtn.png",1,ccc3(100,100,100),"确定")
				btns[1]=bs.btn
				local quick = function()
					self:applyListNet(2,member.role_id)
				end
				btns[1].action = quick
				dialogCfg.btns = btns
				local dialog = new(Dialog)
				dialog:create(dialogCfg)
			end
			createbg:addChild(btn)
			--拒绝
			local btn = dbUIButtonScale:buttonWithImage("UI/jia_zu/ref.png", 1, ccc3(125, 125, 125))
			btn:setAnchorPoint(CCPoint(0.5,0.5))
			btn:setPosition(CCPoint(260/2,60))
			btn.m_nScriptClickedHandler = function(ccp)
				local dialogCfg = new(basicDialogCfg)
				dialogCfg.msg = "真的不让"..member.name.."加入家族吗？"
				dialogCfg.msgAlign = "center"
				dialogCfg.bg = "UI/baoguoPanel/kuang.png"
				dialogCfg.position = CCPoint(WINSIZE.width / 2, WINSIZE.height / 2)
				dialogCfg.dialogType = 5
				local btns = {}
				local bs = new(ButtonScale)
				bs:create("UI/public/noTextBtn.png",1,ccc3(100,100,100),"确定")
				btns[1]=bs.btn
				local quick = function()
					self:applyListNet(3,member.role_id)
				end
				btns[1].action = quick
				dialogCfg.btns = btns
				local dialog = new(Dialog)
				dialog:create(dialogCfg)
			end
			createbg:addChild(btn)
		end
	end,

	applyListNet = function (self,m_type,target_id)
		
		local applyListNetCB = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				initApplyList (json)
				self:createMain()
			end
		end

		local sendRequest = function ()
			--发送请求
			local action = Net.OPT_LegionApplyList
			if m_type == 2 or m_type == 3 then
				action =Net.OPT_LegionApprove
			elseif m_type == 4 then
				action = Net.OPT_LegionApplyListClear
			end

			showWaitDialogNoCircle("waiting skillLock!")
			NetMgr:registOpLuaFinishedCB(action,applyListNetCB)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)

			if m_type < 2 or m_type == 4 then
				cj:setByKey("legion_id", LegionData.legion_id)
			end
			if m_type == 2 or m_type == 3 then
				cj:setByKey("action",m_type-1)
				cj:setByKey("target_id",target_id)
			end

			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end
}
--家族列表 面板
JZInfoPanel = {
	bg = nil,

	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 702))
		self.bg:setAnchorPoint(CCPoint(0, 0))

		self:createMain()
		return self
	end,

	createMain = function(self)
		local infoPanel = createBG("UI/public/kuang_xiao_mi_shu.png",928,535)
		infoPanel:setAnchorPoint(CCPoint(0, 0))
		infoPanel:setPosition(CCPoint(40, 52))
		self.bg:addChild(infoPanel)
		
		local index = 1
		local createLabel = function(text,value)
			local label = CCLabelTTF:labelWithString(text, CCSize(300,0),0,SYSFONT[EQUIPMENT], 28)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(34, 472-(index-1)*40))
			label:setColor(ccc3(255,204,102))
			infoPanel:addChild(label)
			local label = CCLabelTTF:labelWithString(value, CCSize(300,0),0,SYSFONT[EQUIPMENT], 32)
			label:setAnchorPoint(CCPoint(0,0))
			label:setPosition(CCPoint(170, 472-(index-1)*40))
			label:setColor(ccc3(255,153,0))
			infoPanel:addChild(label)
			index = index + 1
		end

		createLabel("家族名称：",LegionDetail.name)
		--createLabel("当前等级：",LegionDetail.level)
		createLabel("家族人数：",LegionDetail.number)
		--createLabel("大陆排名：",LegionDetail.name)
		createLabel("家族族长：",LegionDetail.leader_name)

		--描述底色
		local title_bg = CCSprite:spriteWithFile("UI/public/title_bg2.png")
		title_bg:setPosition(CCPoint(37, 472-(index-1)*40-20))
		title_bg:setAnchorPoint(CCPoint(0,0))
		infoPanel:addChild(title_bg)
		
		local label = CCLabelTTF:labelWithString("公告",CCSize(0,0),0, SYSFONT[EQUIPMENT], 28)
		label:setPosition(CCPoint(142/2,37/2))
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setColor(ccc3(255,153,0))
		title_bg:addChild(label)
		
		local label = CCLabelTTF:labelWithString(LegionDetail.notice,CCSize(870,0),0, SYSFONT[EQUIPMENT], 32)
		label:setPosition(CCPoint(37,472-(index-2)*40-100))
		label:setAnchorPoint(CCPoint(0,1))
		label:setColor(ccc3(253,204,102))
		infoPanel:addChild(label)
		self.noticeLabel = label
		
		--族长才显示
		if LegionDetail.position==1 then	
			local createBtn = dbUIButtonScale:buttonWithImage("UI/jia_zu/xiu_gai.png",1.2)
			createBtn:setAnchorPoint(CCPoint(0.5, 0.5))
			createBtn:setPosition(CCPoint(928/2, 75))
			createBtn.m_nScriptClickedHandler = function(ccp)
				self:xiugaiNotice()
			end
			infoPanel:addChild(createBtn)
		end
	end,
	
	xiugaiNotice = function (self)
		local createJunPanel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		createJunPanel.m_nScriptClickedHandler = function(ccp)
			createJunPanel:removeFromParentAndCleanup(true)
		end
		self.bg:addChild(createJunPanel,100000)
		
		local createbg = createBG("UI/public/dialog_kuang.png",640,280)
		createbg:setAnchorPoint(CCPoint(0.5, 0.5))
		createbg:setPosition(CCPoint(512,384))
		createJunPanel:addChild(createbg)

		local noticeKuang = createBG("UI/public/recuit_dark2.png",545,136,CCSize(20,20))
		noticeKuang:setAnchorPoint(CCPoint(0.5, 0))
		noticeKuang:setPosition(CCPoint(640/2, 100))
		createbg:addChild(noticeKuang)

		local label = CCLabelTTF:labelWithString("修改家族公告:",CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(25,90))
		label:setColor(ccc3(153,205,0))
		noticeKuang:addChild(label)
		
		local label = CCLabelTTF:labelWithString("(50字以内)",CCSize(200,0),0, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(215,90))
		label:setColor(ccc3(184,148,74))
		noticeKuang:addChild(label)
		
		local inputBg = CCSprite:spriteWithFile("UI/jia_zu/input_bg.png")
		inputBg:setAnchorPoint(CCPoint(0, 0))
		inputBg:setPosition(CCPoint(26, 30))		
		noticeKuang:addChild(inputBg)
		
		local inputText = dbUIWidgetInput:inputWithText("","Thonburi", 24,false,150,CCRectMake(40,40,400,40))
		inputText:setNeedFocus(true)
		noticeKuang:addChild(inputText)
		
	
		local createBtn = dbUIButtonScale:buttonWithImage("UI/public/ok_btn.png", 1, ccc3(125, 125, 125))
		createBtn:setAnchorPoint(CCPoint(0.5,0.5))
		createBtn:setPosition(CCPoint(640/2,60))
		createBtn.m_nScriptClickedHandler = function()
			self:setNotice(inputText:getString())
			createJunPanel:removeFromParentAndCleanup(true)
		end
		createbg:addChild(createBtn)
		
		local closeBtn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png",1.2)
		closeBtn:setAnchorPoint(CCPoint(0.5,0.5))
		closeBtn:setPosition(CCPoint(600,230))
		closeBtn.m_nScriptClickedHandler = function()
			createJunPanel:removeFromParentAndCleanup(true)
		end
		createbg:addChild(closeBtn)		
	end,
	
	setNotice = function (self,notice)
		local contentLenght = string.len(notice)
		if contentLenght > 3*50 then
			alertOK("内容过长")
			return
		end
		
		if contentLenght ==0 then
			alertOK("家族信息不能为空")
			return
		end
		
		local function setNoticeFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				alert("修改成功")

				if LegionDetail.legion_id == LegionData.legion_id then
					LegionDetail.notice = notice
					self.noticeLabel:setString(LegionDetail.notice)
				end
			else
				ShowErrorInfoDialog(s:getByKey("error_code"):asInt())
			end
		end

		local function setNoticeNet()
			showWaitDialogNoCircle("waiting add data")
			NetMgr:registOpLuaFinishedCB(Net.OPT_LegionModifyNotice, setNoticeFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_LegionModifyNotice, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("notice",notice)  
			
			NetMgr:executeOperate(Net.OPT_LegionModifyNotice, cj)
		end
		setNoticeNet()		
	end,	
}
--日常任务主界面，包括日常，悬赏任务，角色信息，排行榜，设置，说明  默认为日常
function globleShowRCPanel()
	GlobleRCPanel = new(RCMainPanel)
    GlobleRCPanel:create(1)
	createRiChang()
end

--日常
function createRiChang()
	local function opTransLogFinishCB(s)
		closeWait()
		local error_code = s:getByKey("error_code"):asInt()	
		if error_code == -1 then
			local rcrc = new(RCRiChangPanel):create(s)
			GlobleRCPanel.mainWidget:addChild(rcrc.bg)
		else
			new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
		end
	end
	function createTransLog()
		showWaitDialogNoCircle("waiting Raid data")		
		NetMgr:registOpLuaFinishedCB(Net.OPT_CheckVitality, opTransLogFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_CheckVitality, opFailedCB)
	
		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		NetMgr:executeOperate(Net.OPT_CheckVitality, cj)
	end
	createTransLog()
end

--悬赏任务
function createXuanShang()
	local function opCreateDailyTaskFinishCB(s)
		closeWait()
		if s:getByKey("error_code"):asInt() == -1 then
			local rcxs = new(RCXuanShangPanel):create(s)
			GlobleRCPanel.mainWidget:addChild(rcxs.bg,2001)
			GlobleRCPanel.rcxs = rcxs
		else
			local createPanel = new(SimpleTipPanel)
			createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
		end
	end

	local function opCreateDailyTaskFailedCB(s)
		closeWait()
	end

	local function execCreateDailyTask()
		showWaitDialogNoCircle("waiting tavern data!")
		NetMgr:registOpLuaFinishedCB(Net.OPT_DailyTaskSimple, opCreateDailyTaskFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_DailyTaskSimple, opCreateDailyTaskFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code",ClientData.request_code)
		cj:setByKey("cfg_task_id",0)
		cj:setByKey("do_value",0)
		NetMgr:executeOperate(Net.OPT_DailyTaskSimple, cj)
	end
	execCreateDailyTask()
end
--角色信息
function globleCreateJueSePanel(orderz)
	GlobleRCPanel = new(RCMainPanel)
	if orderz ~=nil then 
	
	GlobleRCPanel.orderz=orderz
	end
    GlobleRCPanel:create(2)
	createJueSe()
end
function createJueSe()
	local rcjs = new(RCJueSePanel):create()
	GlobleRCPanel.mainWidget:addChild(rcjs.bg)
	GlobleRCPanel.rcjs = rcjs
end
--排行榜
function createPaiMing()
	local rcph = new(RCPaiHangPanel)
	rcph:create(GloblePlayerData.generals[GloblePanel.curGenerals])
	GlobleRCPanel.mainWidget:addChild(rcph.bg)
	GlobleRCPanel.rcph = rcph
end
--设置
function createSheZhi()
	local rcst = new(RCSettingPanel)
	rcst:create(GloblePlayerData.generals[GloblePanel.curGenerals])
	GlobleRCPanel.mainWidget:addChild(rcst.bg)
	GlobleRCPanel.rcst = rcst
end

RCMainPanel = {
    bgLayer = nil,
    uiLayer = nil,
    topBtns = nil,
    centerWidget = nil,
    mainWidget = nil,
    orderz = nil,
    create = function(self,topid)
    	local scene = DIRECTOR:getRunningScene()

    	self.bgLayer = createPanelBg()
        self.uiLayer,self.centerWidget = createCenterWidget()
	   
	    local bg = CCSprite:spriteWithFile("UI/public/bg.png")
	    bg:setPosition(CCPoint(1010/2, 702/2)) 
	    self.centerWidget:addChild(bg)
        
        if self.orderz ~=nil then 
         	scene:addChild(self.bgLayer,self.orderz )  --原先值1000   5000
	        scene:addChild(self.uiLayer, self.orderz+1)  ----原先值2000	
		else
		
            scene:addChild(self.bgLayer, 1000)  --原先值1000   5000
	    scene:addChild(self.uiLayer, 2000)  ----原先值2000
        end
		
		local topbtn = new(RCTopButton)
		topbtn:create()
		self.topBtns = topbtn.toggles	
		self.closeBtn = topbtn.closeBtn	
		self.centerWidget:addChild(topbtn.bg,100)
		
		self.mainWidget = createMainWidget()
		self.centerWidget:addChild(self.mainWidget)
		
		--注册开关切换事件
		for i = 1 , table.getn(topbtn.toggles) do
			topbtn.toggles[i].m_nScriptClickedHandler = function()
				if (topbtn.toggles[i]:isToggled()) then
                    self:clearMainWidget()
					if i == 1 then
						createRiChang()
					end
--					if i == 2 then
--						createXuanShang()
--					end
					if i == 2 then
						createJueSe()
					end
					if i == 3 then
						createPaiMing()
					end
					if i == 4 then
						createSheZhi()
					end
				end
				topbtn:toggle(i)
			end
		end
		
		--关闭按钮
		topbtn.closeBtn.m_nScriptClickedHandler = function()		
			self:destroy()
			GloblePanel.curGenerals = GloblePlayerData.roleIndex
			if GlobleRCPanel~=nil then
				GlobleRCPanel:destroy()
				GlobleRCPanel=nil
			end
		end

		topbtn:toggle(topid)
    end,

	clearMainWidget = function(self)
		self.mainWidget:removeAllChildrenWithCleanup(true)
		self:unscheduleScript()
	end,
	
	unscheduleScript = function(self)
		if GlobleRCPanel.rcxs then
			if GlobleRCPanel.rcxs.timeHandle then
				CCScheduler:sharedScheduler():unscheduleScriptEntry(GlobleRCPanel.rcxs.timeHandle)
				GlobleRCPanel.rcxs.timeHandle = nil
			end
		end
	end,
	
    destroy = function(self)
    	self:unscheduleScript()
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
        self.bgLayer = nil
        self.uiLayer = nil
        self.topBtns = nil
        self.centerWidget = nil
        self.mainWidget = nil
        
        GlobleRCPanel.rcrc = nil
        removeUnusedTextures()
    end
}

RCTopBtnConfig = {
	{
		normal = "UI/ri_chang/rc_1.png",
		toggle = "UI/ri_chang/rc_2.png",
		position = 	CCPoint(50, 12),
	},
--	{
--		normal = "UI/ri_chang/xs_1.png",
--		toggle = "UI/ri_chang/xs_2.png",
--		position = 	CCPoint(24 + 180, 12),
--	},	
	{
		normal = "UI/ri_chang/js_1.png",
		toggle = "UI/ri_chang/js_2.png",
		position = 	CCPoint(50 + 220, 12),
	},
	{
		normal = "UI/ri_chang/ph_1.png",
		toggle = "UI/ri_chang/ph_2.png",
		position = 	CCPoint(50 + 220*2, 12),
	},	
	{
		normal = "UI/ri_chang/sz_1.png",
		toggle = "UI/ri_chang/sz_2.png",
		position = 	CCPoint(50 + 220*3, 12),
	},		
}

RCTopButton = {
	bg = nil,
	toggles = {},
	closeBtn = nil,
	backBtn = nil,
	
	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 106))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(0,598))
		for i = 1 , table.getn(RCTopBtnConfig) do		
			local btn = dbUIButtonToggle:buttonWithImage(RCTopBtnConfig[i].normal,RCTopBtnConfig[i].toggle)
			btn:setAnchorPoint(CCPoint(0, 0))
			btn:setPosition(RCTopBtnConfig[i].position)
			self.toggles[i] = btn
			self.bg:addChild(btn)
		end
		
		--关闭按钮
		local closeBtn = new(ButtonScale)
		closeBtn:create("UI/public/close_circle.png",1.2,ccc3(255,255,255))			
		closeBtn.btn:setPosition(CCPoint(952, 44))
		closeBtn.btn:setAnchorPoint(CCPoint(0.5, 0.5))
		self.bg:addChild(closeBtn.btn)
		self.closeBtn = closeBtn.btn
	end,
	
	--切换
	toggle = function(self,topid)
		public_toggleRadioBtn(self.toggles,self.toggles[topid])
	end
}
--日常 面板
RCRiChangPanel = {
	bg = nil,
	data = nil,
	idx = 1,
	
	create = function(self,data)
		self.data=data
		self.vitality = self.data:getByKey("vitality"):asInt()
		self.idx = self.data:getByKey("idx"):asInt()
		
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 598))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(0,0)
		
		self:createLeft()
		self:createRight()
		return self
	end,
	
	reflash = function(self,data)
		self.data=data
		self.vitality = self.data:getByKey("vitality"):asInt()
		self.idx = self.data:getByKey("idx"):asInt()
		self.bg:removeAllChildrenWithCleanup(true)
		self:createLeft()
		self:createRight()	
	end,
	
	createLeft = function(self)
		local niceGirl = CCSprite:spriteWithFile("UI/public/nice_girl.png")
		niceGirl:setAnchorPoint(CCPoint(0,0))
		niceGirl:setPosition(36-40, 78)
		self.bg:addChild(niceGirl,20000)
	end,
	
	--创建右边按钮部分 面板
	createRight = function(self)
		--日常任务列表
		local listBg = createBG("UI/public/kuang_xiao_mi_shu.png",650,362)
		listBg:setAnchorPoint(CCPoint(0, 0))
		listBg:setPosition(CCPoint(320, 222))
		self.bg:addChild(listBg)
		
		local list_head_bg = dbUIWidget:widgetWithImage("UI/ri_chang/list_head_bg.png")
		list_head_bg:setAnchorPoint(CCPoint(0,0))
		list_head_bg:setPosition(0, 299)
		listBg:addChild(list_head_bg)

		local listHead = CCSprite:spriteWithFile("UI/ri_chang/rc.png")
		listHead:setAnchorPoint(CCPoint(0,0))
		listHead:setPosition(36, 315)
		listBg:addChild(listHead)
		local listHead = CCSprite:spriteWithFile("UI/ri_chang/hyd_1.png")
		listHead:setAnchorPoint(CCPoint(0,0))
		listHead:setPosition(260+70, 315)
		listBg:addChild(listHead)
		local listHead = CCSprite:spriteWithFile("UI/ri_chang/zt.png")
		listHead:setAnchorPoint(CCPoint(0,0))
		listHead:setPosition(500, 315)
		listBg:addChild(listHead)
		
		local data = self.data
		self.item_count = new({})
		self.item_type = new({})
		
		local length = data:getByKey("vitality_list"):size()
		local total = 0
		for i = 1 ,length do
			local vitality = data:getByKey("vitality_list"):getByIndex(i-1)
			local tempType = vitality:getByKey("type"):asInt()
			
			total = total + 1
			self.item_count[total] = vitality:getByKey("count"):asInt()
			self.item_type[total] = tempType
		end
		
		local itemList = dbUIList:list(CCRectMake(0,0,650,300),0)
		listBg:addChild(itemList)

		local step_cfg = openJson("cfg/cfg_step.json")

		for i = 1 , total do
			local type = self.item_type[i]
			local rc_item = RC_TYPE[type]
			
			if rc_item then
				local open_name = rc_item.open_name
				local name = rc_item.name
				local huoyue = rc_item.huoyue
				local complete = self.item_count[i]
				local total = item_totCount[type]
				
				local soul_open = step_cfg:getByKey(open_name):getByKey("require_officium"):asInt() <= GloblePlayerData.officium
				if soul_open then
					local item = dbUIPanel:panelWithSize(CCSize(650,75))
					--分割线
					local line = CCSprite:spriteWithFile("UI/public/line_2.png")
					line:setAnchorPoint(CCPoint(0,0))
					line:setScaleX(645/28)
					line:setPosition(2, 0)
					item:addChild(line)
				
					local nameLabel = CCLabelTTF:labelWithString(name,CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
					nameLabel:setAnchorPoint(CCPoint(0,0.5))
					nameLabel:setPosition(CCPoint(36,75/2))
					nameLabel:setColor(ccc3(254,205,102))
					item:addChild(nameLabel)
					if complete > total then
						complete = total
					end
					local prosLabel = CCLabelTTF:labelWithString(complete.."/"..total,CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
					prosLabel:setAnchorPoint(CCPoint(0,0.5))
					prosLabel:setPosition(CCPoint(200,75/2))
					prosLabel:setColor(ccc3(248,100,0))
					item:addChild(prosLabel)
				
					local huoyueLabel = CCLabelTTF:labelWithString("+"..huoyue,CCSize(300,0),0, SYSFONT[EQUIPMENT], 30)
					huoyueLabel:setAnchorPoint(CCPoint(0,0.5))
					huoyueLabel:setPosition(CCPoint(305+36,75/2))
					huoyueLabel:setColor(ccc3(152,203,0))
					item:addChild(huoyueLabel)
					if complete >= total then
						local goBtn = new(ButtonScale)
						goBtn:create("UI/ri_chang/ywc.png",1.2)
						goBtn.btn:setAnchorPoint(CCPoint(0,0.5))
						goBtn.btn:setPosition(CCPoint(425+36,75/2))
						item:addChild(goBtn.btn)					
					else
						local goBtn = new(ButtonScale)
						goBtn:create("UI/ri_chang/qw.png",1.2)
						goBtn.btn:setAnchorPoint(CCPoint(0,0.5))
						goBtn.btn:setPosition(CCPoint(425+36,75/2))
						goBtn.btn.m_nScriptClickedHandler = function(ccp)
							self:goto_do(rc_item)
						end
						item:addChild(goBtn.btn)				
					end
					itemList:insterWidget(item)
				end			
			end
		end
		itemList:m_setPosition(CCPoint(0,- itemList:get_m_content_size().height + itemList:getContentSize().height ))
		
		self:createReward()
	end,
	
	--奖励信息
	createReward = function(self)
		local vitality = self.vitality
		local bxType = self.idx
		if bxType==0 then bxType = 4;vitality = 0 end
		
		local rwward = HUO_YUE_DU_REWARD_CFG[bxType]
		local rewardBg = createBG("UI/public/kuang_xiao_mi_shu.png",650,160)
		rewardBg:setAnchorPoint(CCPoint(0, 0))
		rewardBg:setPosition(CCPoint(320, 50))
		self.bg:addChild(rewardBg)

		local hyd_2 = CCSprite:spriteWithFile("UI/ri_chang/hyd_2.png")
		hyd_2:setAnchorPoint(CCPoint(0,0))
		hyd_2:setPosition(36, 75)
		rewardBg:addChild(hyd_2)
				
		--活跃度进度条 300 450 600 750
		local max = rwward.require
		local bar = new(Bar2)
        bar:create(max,HUO_YUE_DU_BAR_CFG)
		bar:setExtent(vitality,max)	
		rewardBg:addChild(bar.barbg)
		
		local bxBtn = new(ButtonScale)
		bxBtn:create("UI/ri_chang/bx.png",1.2)
		bxBtn.btn:setAnchorPoint(CCPoint(0,0.5))
		bxBtn.btn:setPosition(CCPoint(480, 70))
		bxBtn.btn.m_nScriptClickedHandler = function(ccp)
			self:reward(bxType)
		end
		rewardBg:addChild(bxBtn.btn)

		local jl = CCSprite:spriteWithFile("UI/ri_chang/jl.png")
		jl:setAnchorPoint(CCPoint(0,0))
		jl:setPosition(36, 25)
		rewardBg:addChild(jl)
		
		local label = CCLabelTTF:labelWithString(rwward.bx,CCSize(400,0),0, SYSFONT[EQUIPMENT], 24)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(165,25))
		label:setColor(ccc3(254,205,102))
		rewardBg:addChild(label)
	end,
	
	reward = function(self,index)		
		local function opLogRewardFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				local iemChangeList = s:getByKey("iemChangeList")
				for i=0, iemChangeList:size()-1 do
					GloblePlayerData.copper = s:getByKey("copper"):asInt()
					updataHUDData()
					local itemChange = iemChangeList:getByIndex(i)
					local addList = itemChange:getByKey("add_item_id_list")
					local changeList = itemChange:getByKey("change_item_id_list")
					local cfgItemId = itemChange:getByKey("cfg_item_id"):asInt()
					for j=0, addList:size()-1 do
						local itemId = addList:getByIndex(j):asInt()
						battleGetItems({cfgItemId,itemId},true)
					end
					for j=0, changeList:size()-1 do
						local itemId = changeList:getByIndex(j):asInt()
						battleGetItems({cfgItemId,itemId,1,true},true)
					end
				end
				RefreshItem()
				self:reflash(s)
			else
				new(SimpleTipPanel):create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
			end
		end

		local function execCreateLog()
			showWaitDialogNoCircle("waiting tavern data!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_RewardVitalitySimple, opLogRewardFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_RewardVitalitySimple, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("idx",index)
			NetMgr:executeOperate(Net.OPT_RewardVitalitySimple, cj)
		end
		execCreateLog()
	end,	
	
	goto_do = function(self,rc_item)
		rc_item.func()
	end,
}

item_totCount = 
{
	1, 1, 5, 10, 2,
	1, 1, 1, 1, 1,
	1,
}

RC_TYPE = {
	{name="每日登录",open_name="",huoyue=5,func = nothing},
	{name="强化装备",open_name="forge_open",huoyue=5,func = globleShowQHPanel},
	{name="佣兵任务",open_name="dock_open",huoyue=5,func = GlobleCreateYongBing},
	{name="竞技场挑战",open_name="arena_open",huoyue=5,func = globleCreateArena},
	{name="哈迪斯捐献",open_name="hades_open",huoyue=5,func = GlobleCreateHades},
	{name="祭星",open_name="soul_open",huoyue=5,func = globleShowJiFete},
	{name="升级科技",open_name="talent_open",huoyue=5,func = globle_create_tian_fu},
	{name="祈福",open_name="qifu_open",huoyue=5,func = GlobalCreateWishPanel},
	{name="古战场寻宝",open_name="gu_yiji_open",huoyue=5,func = globalShowRuinsPanel},
	{name="装备升级",open_name="zb_sj_open",huoyue=5,func = globleShowShengji},
	{name="宝石镶嵌",open_name="xiangqian_open",huoyue=5,func = globleShowXiangQian},
}

HUO_YUE_DU_REWARD_CFG={
	{require = 5,bx="活跃度宝箱1",desc="奖：银币5000，普通经验包1个",cfg_item_id=41080001},
	{require = 30,bx="活跃度宝箱2",desc="奖：银币1万，普通经验包2个",cfg_item_id=41080002},
	{require = 60,bx="活跃度宝箱3",desc="奖：银币2万，普通经验包4个",cfg_item_id=41080003},
	{require = 100,bx="活跃度宝箱4",desc="奖：银币5万，普通经验包6个",cfg_item_id=41080004},
}
--活跃度进度条配置
HUO_YUE_DU_BAR_CFG = {
	res = {border = "UI/bar/bar_bg.png",entity = "UI/bar/bar_green.png",},
	borderSize = {width = 280,height = 32},
	entitySize = {width = 280,height = 28},
	fontSize = 30,
	position = CCPoint(165, 75),
	borderCornerSize = CCSize(13,16),
	entityCornerSize = CCSize(13,14)
}
--日常  悬赏  面板
RCXuanShangPanel = {
	bg = nil,
	curTaskId = nil,
	daily_list = nil,
	curTaskIndex = 0,
	daily_left_count = 0,
	daily_cooldown = 0,
	server_time = 0,
	bonus_count = 0,
	task_name_labels = {},
	
	create = function(self,data)
		self:initData(data)
		self.cfg_item = self.cfg_item ~= nil and self.cfg_item or GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_item.json")
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 598))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(0,0)
		
		self:createLeft()
		self:createRight()
		return self
	end,
	
	initData = function(self,data)
		self.daily_list = new({})
		local daily_list_json = data:getByKey("daily_list")
		
		for i=1,daily_list_json:size() do
			local daily_task_json = daily_list_json:getByIndex(i-1)
			local cfg_task_id = daily_task_json:getByKey("cfg_task_id"):asInt()
			local status = daily_task_json:getByKey("status"):asInt()
			local do_value = daily_task_json:getByKey("do_value"):asInt()
			local cfg_task_id = daily_task_json:getByKey("cfg_task_id"):asInt()		
			self.daily_list[i] = {status=status,do_value=do_value,cfg_task_id=cfg_task_id}
		end
		
		self.daily_left_count = data:getByKey("daily_left_count"):asDouble()
		self.daily_cooldown = data:getByKey("daily_cooldown"):asDouble()
		self.server_time = data:getByKey("server_time"):asDouble()
		self.bonus_count = data:getByKey("daily_bonus_count"):asInt()
		
		if self.curTaskIndex<=0 then
			self.curTaskIndex = 1
		end
		self.curTaskId = self.daily_list[self.curTaskIndex].cfg_task_id
	end,
	
	reflash = function(self,data)
		self:initData(data)
		self.bg:removeAllChildrenWithCleanup(true)
		self.descPanel = nil
		self.btnsPanel = nil
		self:createLeft()
		self:createRight()	
	end,
	
	createLeft = function(self)
		local descKuang = createBG("UI/dailyTask/desc_bg.png",265,533)
		descKuang:setAnchorPoint(CCPoint(0, 0))
		descKuang:setPosition(CCPoint(40, 50))
		self.bg:addChild(descKuang)

		local text = CCLabelTTF:labelWithString(DAILY_TASK_DES,CCSize(250, 0),CCTextAlignmentLeft,SYSFONT[EQUIPMENT],25)  
		local temp = dbUIWidget:widgetWithSprite(text)
		temp:setAnchorPoint(CCPoint(0,1))
		temp:setPosition(CCPoint(10,424-text:getContentSize().height)) 

		local textList = dbUIList:list(CCRectMake(7,43,265,424),0)
		textList:insterWidget(temp)
		textList:m_setPosition(CCPoint(0,- textList:get_m_content_size().height + textList:getContentSize().height ))
		descKuang:addChild(textList)
	end,
	
	createRight = function(self)
		local rightBg = createBG("UI/public/kuang_xiao_mi_shu.png",650,533)
		rightBg:setAnchorPoint(CCPoint(0, 0))
		rightBg:setPosition(CCPoint(320, 50))
		self.bg:addChild(rightBg)
		self.rightBg=rightBg
		
		self:createTaskList()
		
		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(645/28)
		line:setPosition(2, 359)
		rightBg:addChild(line)
		
		self:createTaskDesc()
		
		--分割线
		local line = CCSprite:spriteWithFile("UI/public/line_2.png")
		line:setAnchorPoint(CCPoint(0,0))
		line:setScaleX(645/28)
		line:setPosition(2, 121)
		rightBg:addChild(line)
		
		self:createBtns()
	end,
	
	createTaskList = function(self)
		local rightBg = self.rightBg
		
		--默认选中第一个
		local task_selected_kuang = CCSprite:spriteWithFile("UI/public/kuang_120.png")
		task_selected_kuang:setPosition(27+(self.curTaskIndex-1)*120,403)
		task_selected_kuang:setAnchorPoint(CCPoint(0, 0))
		rightBg:addChild(task_selected_kuang)
		self.task_selected_kuang = task_selected_kuang
		
		for i = 1,table.getn(self.daily_list) do
			local daily_task = self.daily_list[i]
			local cfg_task_id = daily_task.cfg_task_id
			
			--local iconIndex = cfg_task_daily_data[cfg_task_id].icon
			local texName = cfg_task_daily_data[cfg_task_id].name
			local task_qua = cfg_task_daily_data[cfg_task_id].quality

			local icon = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			icon:setPosition(0,0)
			icon:setAnchorPoint(CCPoint(0, 0))
			local taskIcon = dbUIButtonScale:buttonWithImage("UI/dailyTask/logo.png", 1, ccc3(125, 125, 125))
			taskIcon:setPosition(48,48)
			taskIcon:setAnchorPoint(CCPoint(0.5, 0.5))
			taskIcon.m_nScriptClickedHandler = function(ccp)
				self.curTaskId = cfg_task_id
				self.curTaskIndex = i
				self.task_selected_kuang:setPosition(27+(i-1)*120,403)
				self:setCurTaskNameColor(i)
				self:createTaskDesc()
				self:createBtns()
			end
			local kuang = dbUIPanel:panelWithSize(CCSize(96, 96))
			kuang:setAnchorPoint(CCPoint(0, 0))
			kuang:setPosition(40+(i-1)*120, 415)
			kuang:addChild(icon)
			kuang:addChild(taskIcon)
			rightBg:addChild(kuang)
			
			--名称
			local text = CCLabelTTF:labelWithString(texName,CCSizeMake(120, 0), 1,SYSFONT[EQUIPMENT], 24)
			text:setAnchorPoint(CCPoint(0, 0))
			text:setPosition(CCPoint(25+(i-1)*122,365))
			text:setColor(ccc3(255,255,160))
			rightBg:addChild(text)
			self.task_name_labels[i]=text	
		end
		
		self:setCurTaskNameColor(self.curTaskIndex)
	end,
	
	setCurTaskNameColor = function(self,index)
		for i=1,table.getn(self.task_name_labels) do
			self.task_name_labels[i]:setColor(ccc3(255,255,160))
		end
		self.task_name_labels[index]:setColor(ccc3(154,153,151))
	end,
	
	createTaskDesc = function(self)
		if self.descPanel then
			self.descPanel:removeAllChildrenWithCleanup(true)
			self.descPanel = nil
		end
		local descPanel = dbUIPanel:panelWithSize(CCSize(650, 236))
		descPanel:setAnchorPoint(CCPoint(0, 0))
		descPanel:setPosition(0,123)
		self.rightBg:addChild(descPanel)
		self.descPanel = descPanel
		
		local task_cfg_id = self.curTaskId
		local taskCfg =  cfg_task_daily_data[task_cfg_id]

		--描述底色
		local title_bg = CCSprite:spriteWithFile("UI/public/title_bg2.png")
		title_bg:setPosition(CCPoint(37,180))
		title_bg:setAnchorPoint(CCPoint(0,0))
		descPanel:addChild(title_bg)
		local label = CCLabelTTF:labelWithString("任务描述",CCSize(0,0),0, SYSFONT[EQUIPMENT], 26)
		label:setPosition(CCPoint(142/2,37/2))
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setColor(ccc3(255,152,3))
		title_bg:addChild(label)
		local label = CCLabelTTF:labelWithString(taskCfg.desc,CCSize(1000,0),0, SYSFONT[EQUIPMENT], 24)
		label:setPosition(CCPoint(55,140))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(253,204,102))
		descPanel:addChild(label)
		
		local title_bg = CCSprite:spriteWithFile("UI/public/title_bg2.png")
		title_bg:setPosition(CCPoint(37,70))
		title_bg:setAnchorPoint(CCPoint(0,0))
		descPanel:addChild(title_bg)
		local label = CCLabelTTF:labelWithString("任务奖励",CCSize(0,0),0, SYSFONT[EQUIPMENT], 26)
		label:setPosition(CCPoint(142/2,37/2))
		label:setAnchorPoint(CCPoint(0.5, 0.5))
		label:setColor(ccc3(255,152,3))
		title_bg:addChild(label)

		local tempStr = ""
		if taskCfg.reward_prestige ~= 0 then
			tempStr = TASK_SHENGWANG..taskCfg.reward_prestige.." "
		end
		if taskCfg.reward_copper ~= 0 then
			tempStr = tempStr..ZS_SLIVE..taskCfg.reward_copper.." "
		end
		if taskCfg.reward_gold ~= 0 then
			tempStr = tempStr..ZS_GOLD..taskCfg.reward_gold.." "
		end
		if taskCfg.reward_jump_wand ~= 0 then
			tempStr = tempStr..TASK_TUFEI..taskCfg.reward_jump_wand.." "
		end
		if taskCfg.reward_item ~= 0 then
			local itemName = self.cfg_item:getByKey(taskCfg.reward_item..""):getByKey("name"):asString()
			tempStr = tempStr..TASK_WUPIN..itemName.."*"..taskCfg.reward_item_amount
		end
		local label = CCLabelTTF:labelWithString(tempStr,CCSize(800,0),0, SYSFONT[EQUIPMENT], 24)
		label:setPosition(CCPoint(55,32))
		label:setAnchorPoint(CCPoint(0,0))
		label:setColor(ccc3(253,204,102))
		descPanel:addChild(label)		
	end,
	
	createBtns = function(self)
		if self.btnsPanel then
			self.btnsPanel:removeAllChildrenWithCleanup(true)
			self.btnsPanel = nil
		end
		local btnsPanel = dbUIPanel:panelWithSize(CCSize(650, 120))
		btnsPanel:setAnchorPoint(CCPoint(0, 0))
		btnsPanel:setPosition(0,0)
		self.rightBg:addChild(btnsPanel)
		self.btnsPanel = btnsPanel	
		
		local taskCfg =  cfg_task_daily_data[self.curTaskId]
		local task = self.daily_list[self.curTaskIndex]
		
		local daily_left_count = self.daily_left_count
		local daily_cooldown = self.daily_cooldown
		local server_time = self.server_time
		
		local status = task.status
		local do_value = task.do_value
		
		local action = 0
		local btnImg = nil
		if status == 0 then --还没接
			btnImg = "UI/dailyTask/accept.png"
			action = 2
		elseif status == 1 then
			if do_value >= taskCfg.complete_value then --完成 可领奖
				btnImg = "UI/dailyTask/wc.png"
				action = 3
			else
				btnImg = "UI/dailyTask/give_up.png" --还没完成，可以放弃
				action = 1
			end
		end
		local acceptBtn = dbUIButtonScale:buttonWithImage(btnImg, 1.2, ccc3(125, 125, 125))
		acceptBtn:setPosition(112,78)
		acceptBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		acceptBtn.m_nScriptClickedHandler = function(ccp)
			self:task(action)
		end
		btnsPanel:addChild(acceptBtn)

		local addBtn = dbUIButtonScale:buttonWithImage("UI/dailyTask/more.png", 1.2, ccc3(125, 125, 125))
		addBtn:setPosition(112+205,78)
		addBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		addBtn.m_nScriptClickedHandler = function(ccp)
			local b_count = 20 + self.bonus_count*20
			if b_count > 100 then
				b_count = 100
			end
			local dtp = new(DialogTipPanel)
			dtp:create(LQ_CONSUME1..b_count..TASK_ADD,ccc3(255,204,153),210)
			dtp.okBtn.m_nScriptClickedHandler = function()
				self:addCount()
				dtp:destroy()
			end
		end
		btnsPanel:addChild(addBtn)
		
		local acceptBtn = dbUIButtonScale:buttonWithImage("UI/dailyTask/flash.png", 1.2, ccc3(125, 125, 125))
		acceptBtn:setPosition(112+205*2,78)
		acceptBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		acceptBtn.m_nScriptClickedHandler = function(ccp)
			local dtp = new(DialogTipPanel)
			dtp:create(TASK_R,ccc3(255,204,153),300)
			dtp.okBtn.m_nScriptClickedHandler = function()
				self:refreshItem()
				dtp:destroy()
			end
		end
		btnsPanel:addChild(acceptBtn)
		
		local label = CCLabelTTF:labelWithString(TASK_SHENG..daily_left_count,CCSize(300,0),0, SYSFONT[EQUIPMENT], 24)
		label:setPosition(CCPoint(220,25))
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setColor(ccc3(253,204,102))
		btnsPanel:addChild(label)
		self.leftCount = label
		
		self.lenQueTime = math.abs(math.ceil((daily_cooldown - server_time)/1000))
		if daily_cooldown>0 then
			self:handleLenQueTime()
			local label = CCLabelTTF:labelWithString(TASK_REFRSH..getLenQueTime(self.lenQueTime),CCSize(300,0),0, SYSFONT[EQUIPMENT], 24)
			label:setPosition(CCPoint(440,25))
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setColor(ccc3(253,204,102))		
			btnsPanel:addChild(label)
			self.lenQueTimeTX = label
		end			
	end,

	--处理冷却时间
	handleLenQueTime = function(self)
		if self.lenQueTime > 0 then
			
			local setLenQueTime = function()
				if self.lenQueTime > 0 then
					self.lenQueTime = self.lenQueTime - 1
					self.lenQueTimeTX:setString(TASK_REFRSH..getLenQueTime(self.lenQueTime))
				else
					self.lenQueTimeTX:setString(getLenQueTime(self.lenQueTime))
					CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
					self.timeHandle = nil
					self.lenQueTimeTX:setIsVisible(false)
				end
			end
		
			if self.timeHandle == nil then
				self.timeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
			else
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.timeHandle)
				self.timeHandle = nil
				self.timeHandle = CCScheduler:sharedScheduler():scheduleScriptFunc(setLenQueTime,1,false)
			end
		end
	end,
		
	task = function(self,action)

		local function opCreateTaskFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				local taskCfg =  cfg_task_daily_data[self.curTaskId]
				if action == 3 then --领奖
					local items = {}
					local json = s
					local amounts = {}
					local count = 1
					if taskCfg.reward_jump_wand > 0 then
						--获得经验丹 40000008
						items[count] = 40000008
						amounts[count] = taskCfg.reward_jump_wand
						count = count + 1
					end
					if taskCfg.reward_item > 0 then
						--获得物品
						items[count] = taskCfg.reward_item
						amounts[count] = taskCfg.reward_item_amount
						count = count + 1
					end
					campRewardGetItems(items,s,amounts)
				end
				self:reflash(s)
			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
			end
		end

		local function opCreateTaskFailedCB(s)
			closeWait()
		end

		local function execCreateTask()
			showWaitDialogNoCircle("waiting tavern data!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_DailyTaskSimple, opCreateTaskFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_DailyTaskSimple, opCreateTaskFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("cfg_task_id",self.curTaskId)
			cj:setByKey("do_value",action)
			NetMgr:executeOperate(Net.OPT_DailyTaskSimple, cj)
		end
		execCreateTask()
	end,
	
	refreshItem = function(self)
		local function opCreateRefreshItemFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				self:reflash(s)
			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
			end
		end

		local function opCreateRefreshItemFailedCB(s)
			closeWait()
		end

		local function execCreateRefreshItem()
			showWaitDialogNoCircle("waiting tavern data!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_DailyTaskRefresh, opCreateRefreshItemFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_DailyTaskRefresh, opCreateRefreshItemFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)

			NetMgr:executeOperate(Net.OPT_DailyTaskRefresh, cj)
		end
		execCreateRefreshItem()
	end,
	
	addCount = function(self)
		local function opCreateAddFinishCB(s)
			closeWait()
			if s:getByKey("error_code"):asInt() == -1 then
				self.leftCount:setString(TASK_SHENG..s:getByKey("daily_left_count"):asInt())
				self.bonus_count = s:getByKey("daily_bonus_count"):asInt()
				local createPanel = new(SimpleTipPanel)
				createPanel:create(TASK_A,ccc3(255,255,255),0)
			else
				local createPanel = new(SimpleTipPanel)
				createPanel:create(ERROR_CODE_DESC[s:getByKey("error_code"):asInt()],ccc3(255,255,255),0)
			end
		end

		local function opCreateAddFailedCB(s)
			closeWait()
		end

		local function execCreateAdd()
			showWaitDialogNoCircle("waiting tavern data!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_DailyTaskAddCount, opCreateAddFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_DailyTaskAddCount, opCreateAddFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			NetMgr:executeOperate(Net.OPT_DailyTaskAddCount, cj)
		end
		execCreateAdd()
	end,
}
--日常 角色信息  面板
RCJueSePanel = {
	bg = nil,
	data = nil,
	idx = 1,

	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 598))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(0,0)

		self:createLeft()
		self:createBars()
		self:createAttrs()
		return self
	end,

	reflash = function(self)
		self.bg:removeAllChildrenWithCleanup(true)
		self:createLeft()
		self:createBars()
		self:createAttrs()
	end,

	createLeft = function(self)
		local niceGirl = CCSprite:spriteWithFile("UI/public/nice_girl.png")
		niceGirl:setAnchorPoint(CCPoint(0,0))
		niceGirl:setPosition(36-40, 78)
		self.bg:addChild(niceGirl,20000)
	end,

	--创建右边按钮部分 面板
	createBars = function(self)
		local listBg = createBG("UI/public/kuang_xiao_mi_shu.png",650,330)
		listBg:setAnchorPoint(CCPoint(0, 0))
		listBg:setPosition(CCPoint(320, 253))
		self.bg:addChild(listBg)

		local head_bg = dbUIWidget:widgetWithImage("UI/ri_chang/list_head_bg.png")
		head_bg:setAnchorPoint(CCPoint(0,0))
		head_bg:setPosition(0, 330-head_bg:getContentSize().height)
		listBg:addChild(head_bg)

		--角色名
		local label = CCLabelTTF:labelWithString(GloblePlayerData.role_name, SYSFONT[EQUIPMENT], 32)
		label:setPosition(CCPoint(650/2,75/2-5))
		label:setColor(ccc3(152,203,0))
		head_bg:addChild(label)
		--VIP等级
		local label = CCLabelTTF:labelWithString("VIP "..GloblePlayerData.vip_level.." 级", SYSFONT[EQUIPMENT], 28)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(650/2+label:getContentSize().width/2+100,75/2-5))
		label:setColor(ccc3(255,204,103))
		head_bg:addChild(label)

		--VIP进度条
		local vipSpr = CCSprite:spriteWithFile("UI/playerInfos/vip.png")
		vipSpr:setAnchorPoint(CCPoint(0,0))
		vipSpr:setPosition(30, 197)
		listBg:addChild(vipSpr)

		local bar_cfg = new(COMMON_BAR_CFG)
		bar_cfg.position = CCPoint(146, 197)
		local all = cfg_vip_data[GloblePlayerData.vip_level+1].total_charge
		local bar = new(Bar2)
		bar:create(all,bar_cfg)
		bar:setExtent(GloblePlayerData.vip_charge,all)
		listBg:addChild(bar.barbg)

		local vipBtn = new(ButtonScale)
		vipBtn:create("UI/playerInfos/cz.png",1.2)
		vipBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		vipBtn.btn:setPosition(CCPoint(540,215))
		vipBtn.btn.m_nScriptClickedHandler = function(ccp)	
			globleShowVipPanel()
		end
		listBg:addChild(vipBtn.btn)

		--精力
		local jlSpr = CCSprite:spriteWithFile("UI/playerInfos/jl.png")
		jlSpr:setAnchorPoint(CCPoint(0,0))
		jlSpr:setPosition(30, 197-78)
		listBg:addChild(jlSpr)

		local bar_cfg = new(COMMON_BAR_CFG)
		bar_cfg.position = CCPoint(146, 197-78)
		local bar = new(Bar2)
		bar:create(300,bar_cfg)
		bar:setExtent(GloblePlayerData.action_point,300)
		listBg:addChild(bar.barbg)
		
		local jlBtn = new(ButtonScale)
		jlBtn:create("UI/playerInfos/bc.png",1.2)
		jlBtn.btn:setAnchorPoint(CCPoint(0.5,0.5))
		jlBtn.btn:setPosition(CCPoint(540,215-78))
		jlBtn.btn.m_nScriptClickedHandler = function(ccp)
			self:addJinLi()
		end
		listBg:addChild(jlBtn.btn)
		self.jlBtn = jlBtn.btn
		
		--神力
		local tlSpr = CCSprite:spriteWithFile("UI/playerInfos/shen_li.png")
		tlSpr:setAnchorPoint(CCPoint(0,0))
		tlSpr:setPosition(30, 197-78*2)
		listBg:addChild(tlSpr)

		local bar_cfg = new(COMMON_BAR_CFG)
		bar_cfg.position = CCPoint(146, 197-78*2)
		bar_cfg.labelFull = true
		
		local level_prestige_cfg = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_level_prestige.json")
		local lastNeed = 0 --上一个等级需要的经验
		if GloblePlayerData.officium > 1 then
			lastNeed = level_prestige_cfg:getByIndex(GloblePlayerData.officium-2):getByKey("prestige_need"):asInt()
		end
		local need = level_prestige_cfg:getByIndex(GloblePlayerData.officium-1):getByKey("prestige_need"):asInt()
		local bar = new(Bar2)
		bar:create(all,bar_cfg)
		bar:setExtent(GloblePlayerData.prestige - lastNeed,need - lastNeed)
		listBg:addChild(bar.barbg)
	end,

	--增加精力
	addJinLi = function(self)
		local  createJunPanel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		createJunPanel.m_nScriptClickedHandler = function(ccp)
			createJunPanel:removeFromParentAndCleanup(true)
		end
		self.bg:addChild(createJunPanel,100000)

		local createbg = createBG("UI/public/dialog_kuang.png",500,250,CCSize(60,60))
		createbg:setAnchorPoint(CCPoint(0.5, 0.5))
		createbg:setPosition(CCPoint(512,450))
		createJunPanel:addChild(createbg)
		local bgFoot = createBG("UI/playerInfos/foot.png",456,60,CCSize(30,25))
		bgFoot:setAnchorPoint(CCPoint(0.5,0))
		bgFoot:setPosition(CCPoint(500/2,20))
		createbg:addChild(bgFoot)
		
		
		local createLabel = function(text,pos,color,width)
			local label = CCLabelTTF:labelWithString(text,CCSize(width,0),0, SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(pos)
			label:setColor(color)
			bgFoot:addChild(label)			
		end
		
		createLabel("共有金币：",CCPoint(25,30),ccc3(255,203,102),200)
		createLabel(getShotNumber(GloblePlayerData.gold),CCPoint(150,30),ccc3(254,103,0),300)
		
		createLabel("共有朗姆酒：",CCPoint(240,30),ccc3(255,203,102),300)
		createLabel(GloblePlayerData.ap_wand,CCPoint(392,30),ccc3(254,103,0),300)

		--金币补充
		local btn = dbUIButtonScale:buttonWithImage("UI/playerInfos/jb.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(145,170))
		btn.m_nScriptClickedHandler = function(ccp)
			if GloblePlayerData.gold==0 then
				alert("没金币了")
			else
				local item = BU_CHONG_JING_LI_CFG[3]
				self:ju_hua_BtnAction(item)
			end
		end
		createbg:addChild(btn)

		local label = CCLabelTTF:labelWithString("花费20金补充10点", SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0.5,0.5))
		label:setPosition(CCPoint(btn:getContentSize().width/2,-25))
		label:setColor(ccc3(103,51,1))
		btn:addChild(label)	
			
		--朗姆酒
		local btn = dbUIButtonScale:buttonWithImage("UI/playerInfos/lmj.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(360,170))
		btn.m_nScriptClickedHandler = function(ccp)
			if GloblePlayerData.ap_wand==0 then
				alert("没有朗姆酒了")
			else
				local item = BU_CHONG_JING_LI_CFG[1]
				self:ju_hua_BtnAction(item)
			end
		end
		createbg:addChild(btn)
		local label = CCLabelTTF:labelWithString("使用朗姆酒补充", SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0.5,0.5))
		label:setPosition(CCPoint(btn:getContentSize().width/2,-25))
		label:setColor(ccc3(103,51,1))
		btn:addChild(label)
		
		self.addJiLiOkBtn = btn
	end,

	ju_hua_BtnAction = function(self,item)
		local Reponse = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				GloblePlayerData.gold = json:getByKey("gold"):asInt()
				GloblePlayerData.action_point = json:getByKey("action_point"):asInt()
				GloblePlayerData.ap_wand = json:getByKey("ap_wand"):asInt()
				updataHUDData()
				self:reflash()
			end
		end

		local sendRequest = function ()
			showWaitDialogNoCircle("waiting skillLock!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_ActionPointCharge,Reponse)
			NetMgr:registOpLuaFailedCB(Net.OPT_ActionPointCharge,opFailedCB)
			local cj = Value:new()

			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("type",item.ju_hua)

			NetMgr:executeOperate(Net.OPT_ActionPointCharge, cj)
		end
		sendRequest()
	end,

	--增加生命
	addTiLi = function(self)
		local  createJunPanel = dbUIPanel:panelWithSize(CCSizeMake(1024,768))
		createJunPanel.m_nScriptClickedHandler = function(ccp)
			createJunPanel:removeFromParentAndCleanup(true)
		end
		self.bg:addChild(createJunPanel,100000)

		local createbg = createBG("UI/public/dialog_kuang.png",500,250,CCSize(60,60))
		createbg:setAnchorPoint(CCPoint(0.5, 0.5))
		createbg:setPosition(CCPoint(512,450))
		createJunPanel:addChild(createbg)
		local bgFoot = createBG("UI/playerInfos/foot.png",456,60,CCSize(30,25))
		bgFoot:setAnchorPoint(CCPoint(0.5,0))
		bgFoot:setPosition(CCPoint(500/2,20))
		createbg:addChild(bgFoot)
		
		local createLabel = function(text,pos,color,width)
			local label = CCLabelTTF:labelWithString(text,CCSize(width,0),0, SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(pos)
			label:setColor(color)
			bgFoot:addChild(label)			
		end
		
		createLabel("共有银币：",CCPoint(25,30),ccc3(255,203,102),200)
		createLabel(getShotNumber(GloblePlayerData.copper),CCPoint(150,30),ccc3(254,103,0),300)
		
		createLabel("共有灵果：",CCPoint(240,30),ccc3(255,203,102),200)
		createLabel(getShotNumber(GloblePlayerData.barn),CCPoint(360,30),ccc3(254,103,0),300)

		--银币补充
		local maxAddPoolByCopper = math.min(getMAXPool()-GloblePlayerData.pool, GloblePlayerData.copper*10)
		local maxPool = getMAXPool();
		local pool = getMAXPool()-GloblePlayerData.pool
		local addPool = 0;
		if pool > maxPool/5 then
			addPool = maxPool/5
		else
			addPool = pool
		end
		local btn = dbUIButtonScale:buttonWithImage("UI/playerInfos/yb.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(145,170))
		btn.m_nScriptClickedHandler = function(ccp)
			if GloblePlayerData.copper==0 then
				alert("没钱了")
			else
				self:addBtnAction(1,addPool)
			end
		end
		createbg:addChild(btn)

		local costText = "花费 "..(addPool/10).." 银币\n补充 "..addPool.." 体力";
		local label = CCLabelTTF:labelWithString(costText, SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0.5,0.5))
		label:setPosition(CCPoint(btn:getContentSize().width/2,-25))
		label:setColor(ccc3(103,51,1))
		btn:addChild(label)	
			
		--灵果补充
		local barn = math.min(getMAXPool()-GloblePlayerData.pool, GloblePlayerData.barn)
		local btn = dbUIButtonScale:buttonWithImage("UI/playerInfos/lg.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn:setPosition(CCPoint(360,170))
		btn.m_nScriptClickedHandler = function(ccp)
			if GloblePlayerData.barn==0 then
				alert("没有灵果了")
			else
				self:addBtnAction(2,barn)
			end
		end
		createbg:addChild(btn)
		local label = CCLabelTTF:labelWithString("使用灵果补充", SYSFONT[EQUIPMENT], 22)
		label:setAnchorPoint(CCPoint(0.5,0.5))
		label:setPosition(CCPoint(btn:getContentSize().width/2,-25))
		label:setColor(ccc3(103,51,1))
		btn:addChild(label)				
	end,
	
	addBtnAction =  function(self,add_type,add_pool)
		local Reponse = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				GloblePlayerData.pool = json:getByKey("pool"):asInt()
				GloblePlayerData.copper = json:getByKey("copper"):asInt()
				GloblePlayerData.barn = json:getByKey("barn"):asInt()
				updataHUDData()

				self:reflash()
			end
		end

		local sendRequest = function ()
			showWaitDialogNoCircle("waiting skillLock!")
			NetMgr:registOpLuaFinishedCB(Net.OPT_PoolCharge,Reponse)
			NetMgr:registOpLuaFailedCB(Net.OPT_PoolCharge,opFailedCB)
			local cj = Value:new()

			if add_pool > GloblePlayerData.barn and add_type == 2 then
				add_pool  = GloblePlayerData.barn
			end
			if add_pool /10 > GloblePlayerData.copper and self.add_type == 1 then
				add_pool  = GloblePlayerData.copper
			end
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("pool", add_pool)
			cj:setByKey("type", add_type)
			NetMgr:executeOperate(Net.OPT_PoolCharge, cj)
		end
		sendRequest()
	end,

	--一些人物属性
	createAttrs = function(self)
		local attrsBg = createBG("UI/public/kuang_xiao_mi_shu.png",650,190)
		attrsBg:setAnchorPoint(CCPoint(0, 0))
		attrsBg:setPosition(CCPoint(320, 50))
		self.bg:addChild(attrsBg)

		local createOne = function(label,value,row,column)
			local label = CCLabelTTF:labelWithString(label,CCSize(200,0),0, SYSFONT[EQUIPMENT], 32)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(30 + (column-1)*320,145-(row-1)*50))
			label:setColor(ccc3(153,204,1))
			attrsBg:addChild(label)
			local label = CCLabelTTF:labelWithString(value,CCSize(200,0),0, SYSFONT[EQUIPMENT], 32)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(120 + (column-1)*320,145-(row-1)*50))
			label:setColor(ccc3(255,155,0))
			attrsBg:addChild(label)
		end
		createOne("神位：",GloblePlayerData.officium.."级",1,1)
		createOne("金币：",GloblePlayerData.gold,1,2)
		createOne("神力：",GloblePlayerData.prestige,2,1)
		createOne("银币：",GloblePlayerData.copper,2,2)
		createOne("阵营：",GloblePlayerData.nation,3,1)
		createOne("战功：",public_chageShowTypeForMoney(GloblePlayerData.exploit,true),3,2)
	end,
}
COMMON_BAR_CFG={
	res = {border = "UI/bar/bar_bg.png",entity = "UI/bar/bar_green.png",},
	borderSize = {width = 280,height = 32},
	entitySize = {width = 280,height = 28},
	fontSize = 30,
	position = CCPoint(146, 197),
	borderCornerSize = CCSize(13,16),
	entityCornerSize = CCSize(13,14)
}
BU_CHONG_JING_LI_CFG={
	{type=1,ju_hua=1,desc="使用1瓶朗姆酒恢复20点精力"},
	{type=2,ju_hua=5,desc="使用10瓶朗姆酒恢复200点精力"},
	{type=2,ju_hua=2,desc="使用80金币恢复20点精力"},
	{type=2,ju_hua=3,desc="使用190金币恢复50点精力"},
	{type=1,ju_hua=4,desc="使用360金币恢复100点精力"},
}
--日常 排行榜  面板 小秘书
RCRankHeads = {
	{
		head = "UI/ri_chang/role_rank.png",
		action = Net.OPT_GetRoleRank,
	},
	{
		head = "UI/ri_chang/fight_power_rank.png",
		action = Net.OPT_GetFightPowerRank,
	},
	{
		head = "UI/ri_chang/pet_rank.png",
		action = Net.OPT_GetGeneralRank,
	}
}
RCPaiHangPanel = {
	bg = nil,
	page = 1,
	pageCount = 1,
	pagePanels = {},
	roleList  = {},
	myRank  = 0,
	selected  = nil,
	type	=	1,
	
	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 598))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(0,0)
		
		self:loadRank(1)
		return self
	end,
	
	createLeft = function(self)
		if self.leftBg then
			self.leftBg:removeFromParentAndCleanup(true)
			self.leftBg = nil
		end
		
		local leftBg = createBG("UI/public/kuang_xiao_mi_shu.png",270,531)
		leftBg:setAnchorPoint(CCPoint(0, 0))
		leftBg:setPosition(CCPoint(40, 50))
		self.bg:addChild(leftBg)
		self.leftBg = leftBg
		
		local player = self.selected
		
		--形象
		local image = player.figure > 2000 
						and "head/MonsterFull/head_full_"..player.figure..".png" 
						or "head/full/head_full_"..player.figure..".png"
		local figure = CCSprite:spriteWithFile(image)
		figure:setAnchorPoint(CCPoint(0.5,0.5))
		if player.figure < 2000  then
			figure:setScale(250/figure:getContentSize().width)
		end
		figure:setPosition(270/2,531/2)
		leftBg:addChild(figure)
		
		--头
		local headBg = createBG("UI/ri_chang/list_head_bg.png",270,88,CCSize(23,23))
		headBg:setAnchorPoint(CCPoint(0, 0))
		headBg:setPosition(CCPoint(0, 445))
		leftBg:addChild(headBg)
		local label = CCLabelTTF:labelWithString(player.name, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setPosition(CCPoint(270/2,44))
		label:setColor(ccc3(255,204,1))
		headBg:addChild(label)
		local label = CCLabelTTF:labelWithString("人气:", SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(90,10))
		label:setColor(ccc3(255,204,102))
		headBg:addChild(label)
		local label = CCLabelTTF:labelWithString(player.popularity, SYSFONT[EQUIPMENT], 20)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(150,10))
		label:setColor(ccc3(231,92,1))
		headBg:addChild(label)
		self.popLabel = label
		
		local lv = CCSprite:spriteWithFile("UI/xun_lian_panel/lv.png")
		lv:setAnchorPoint(CCPoint(0,0))
		lv:setPosition(10,415)
		leftBg:addChild(lv)
		local label = CCLabelTTF:labelWithString(player.officium,CCSize(50,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(42,415))
		label:setColor(ccc3(198,131,236))
		leftBg:addChild(label)

		local worshipLabel = CCLabelTTF:labelWithString("剩余崇拜次数："..GloblePlayerData.ph_worship_left_count, SYSFONT[EQUIPMENT], 20)
		worshipLabel:setAnchorPoint(CCPoint(0.5,0))
		worshipLabel:setPosition(CCPoint(270/2,78))
		worshipLabel:setColor(ccc3(255,204,102))
		leftBg:addChild(worshipLabel)
		
		--查看玩家数据
		local viewBtn = dbUIButtonScale:buttonWithImage("UI/ri_chang/view_role.png", 1, ccc3(125, 125, 125))
		viewBtn:setAnchorPoint(CCPoint(0,0))
		viewBtn:setPosition(215,390)
		viewBtn.m_nScriptClickedHandler = function(ccp)
			if self.selected == nil then
				ShowInfoDialog("请选择一个玩家")
				return
			end
			createViewTargetPanel(player.role_id,player.name)
		end
		leftBg:addChild(viewBtn)
				
		--底部
		local footBg = createBG("UI/ri_chang/list_head_foot_bg.png",270,70,CCSize(20,20))
		footBg:setAnchorPoint(CCPoint(0, 0))
		footBg:setPosition(CCPoint(0, 0))
		leftBg:addChild(footBg)
		
		local function opFinishCB(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				alert("获得银币："..(s:getByKey("copper"):asInt() - GloblePlayerData.copper))
				GloblePlayerData.copper = s:getByKey("copper"):asInt()
				updataHUDData()
			
				GloblePlayerData.ph_worship_left_count = s:getByKey("ph_worship_left_count"):asInt()	--今天排行榜崇拜剩余次数
				worshipLabel:setString("剩余崇拜次数："..GloblePlayerData.ph_worship_left_count)
				
				local target_popularity = s:getByKey("target_popularity"):asInt()
				player.popularity = target_popularity
				self.popLabel:setString(target_popularity)
			end
		end	
		
		local function execWorship()
			showWaitDialogNoCircle("")
			local action = Net.OPT_PhWorship
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("target_id", player.role_id)
			cj:setByKey("rank", player.rank)
			cj:setByKey("type", self.type)
			
			NetMgr:registOpLuaFinishedCB(action, opFinishCB)
			NetMgr:registOpLuaFailedCB(action, opFailedCB)
			NetMgr:executeOperate(action, cj)
		end
		
		--崇拜
		local btn = dbUIButtonScale:buttonWithImage("UI/ri_chang/mo_bai_btn.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(270/2,70/2))
		btn:setAnchorPoint(CCPoint(0.5,0.5))
		btn.m_nScriptClickedHandler = function(ccp)
			if self.selected == nil then
				ShowInfoDialog("请选择一个玩家")
				return
			end
			
			if GloblePlayerData.ph_worship_left_count <= 0 then
				ShowInfoDialog("崇拜次数已经用完")
				return
			end		
			execWorship()
		end
		footBg:addChild(btn)
	end,
		
	createRight = function(self)
		if self.rightBg then
			self.rightBg:removeFromParentAndCleanup(true)
			self.rightBg = nil
			self.curSelectBg = nil
		end
		self.page = 1
		
		local rightBg = createBG("UI/public/kuang_xiao_mi_shu.png",650,531)
		rightBg:setAnchorPoint(CCPoint(0, 0))
		rightBg:setPosition(CCPoint(320, 50))
		self.bg:addChild(rightBg)
		self.rightBg = rightBg
		
		local headBg = createBG("UI/ri_chang/list_head_bg.png",650,88,CCSize(23,23))
		headBg:setAnchorPoint(CCPoint(0, 0))
		headBg:setPosition(CCPoint(0, 445))
		rightBg:addChild(headBg)
		local title = CCSprite:spriteWithFile(RCRankHeads[self.type].head)
		title:setAnchorPoint(CCPoint(0.5, 0.5))
		title:setPosition(CCPoint(650/2, 38))
		headBg:addChild(title)

		--前一个按钮
		local img = nil
		local enable = true
		if self.type <= 1 then
			img = "UI/public/prev_disable.png"
			enable = false
		else
			img = "UI/public/prev_enable.png"
		end
		local preBtn = dbUIButtonScale:buttonWithImage(img, 1, ccc3(125, 125, 125))
		preBtn:setAnchorPoint(CCPoint(0, 0.5))
		preBtn:setPosition(CCPoint(50, 44))
		preBtn:setIsEnabled(enable)
		preBtn.m_nScriptClickedHandler = function(ccp)
			self.type = self.type - 1
			self:loadRank(self.type)
		end
		headBg:addChild(preBtn)

		--下一个按钮
		local img = nil
		local enable = true
		if self.type == 3 then
			img = "UI/public/next_disable.png"
			enable = false
		else
			img = "UI/public/next_enable.png"
		end
		local nextBtn = dbUIButtonScale:buttonWithImage(img, 1, ccc3(125, 125, 125))
		nextBtn:setAnchorPoint(CCPoint(0, 0.5))
		nextBtn:setPosition(CCPoint(560, 44))
		nextBtn:setIsEnabled(enable)
		nextBtn.m_nScriptClickedHandler = function(ccp)
			self.type = self.type + 1
			self:loadRank(self.type)
		end
		headBg:addChild(nextBtn)
						
		--创建排名分页
		local pagePanelContainer = dbUIPanel:panelWithSize(CCSize(650 * self.pageCount,330))
		pagePanelContainer:setAnchorPoint(CCPoint(0, 0))
		pagePanelContainer:setPosition(0,0)
		
		for i=1,self.pageCount do
			local singlePage = dbUIPanel:panelWithSize(CCSize(650,330))
			singlePage:setAnchorPoint(CCPoint(0, 0))
	        singlePage:setPosition((i-1)*650,0)
	       
	        local pagePanel = {panel=singlePage,items={},page=i,loaded=false}
	        self.pagePanels[i] = pagePanel
			pagePanelContainer:addChild(singlePage)
		end
		
		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pagePanelContainer, 1, self.pageCount)
        self.scrollArea:setAnchorPoint(CCPoint(0, 0))
        self.scrollArea:setScrollRegion(CCRect(0, 0, 650, 330))
        self.scrollArea:setPosition(0,117)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.page = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
			self:loadPage(self.page)
		end
		rightBg:addChild(self.scrollArea)
		self:createPageDot(self.pageCount)
		self.scrollArea:scrollToPage(self.page-1,false)		
		
		--底部
		local footBg = createBG("UI/ri_chang/list_head_foot_bg.png",650,70,CCSize(20,20))
		footBg:setAnchorPoint(CCPoint(0, 0))
		footBg:setPosition(CCPoint(0, 0))
		rightBg:addChild(footBg)
		
		local label = CCLabelTTF:labelWithString("我的排名：",CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(20,70/2))
		label:setColor(ccc3(250,225,0))
		footBg:addChild(label)
		
		local myRank = self.myRank == 0 and "千里之外" or "第"..self.myRank.."名"
		local label = CCLabelTTF:labelWithString(myRank,CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(155,70/2))
		label:setColor(ccc3(248,100,0))
		footBg:addChild(label)
		
		self:loadPage(1)
	end,
	
	loadPage = function(self,page)
		local pagePanel = self.pagePanels[page]
		local panel = pagePanel.panel

		local createCurPoint = function(item)
			if self.curSelectBg then
				self.curSelectBg:removeFromParentAndCleanup(true)
				self.curSelectBg = nil
			end
			local bg = CCSprite:spriteWithFile("UI/ri_chang/cur_bg.png")
			bg:setAnchorPoint(CCPoint(0,0.5))
			bg:setPosition(5,55/2)
			item:addChild(bg)
			self.curSelectBg = bg
		end
		
		local createTitile = function(text,offsetX,width)
			local title_bg = createBG("UI/public/title_bg2.png",width,37,CCSize(15,15))
			title_bg:setAnchorPoint(CCPoint(0, 0))
			title_bg:setPosition(CCPoint(offsetX, 290))
			panel:addChild(title_bg)
			local label = CCLabelTTF:labelWithString(text,SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0.5,0.5))
			label:setPosition(CCPoint(width/2,37/2))
			label:setColor(ccc3(255,152,3))
			title_bg:addChild(label)
		end

		if self.type == 1 then --神位榜
			createTitile("排名",37,80)
			createTitile("玩家名",197,93)
			createTitile("神位",355,80)
			createTitile("神力",500,80)
		elseif self.type == 2 then --战力
			createTitile("排名",37,80)
			createTitile("玩家名",175,93)
			createTitile("神位等级",320,130)
			createTitile("总战斗力",475,130)
		elseif self.type == 3 then --宠物
			createTitile("排名",17,80)
			createTitile("玩家名",125,100)
			createTitile("宠物",250,80)
			createTitile("职业",350,80)
			createTitile("等级",450,80)
			createTitile("属性",540,80)
		end

		local createItem = function(panel,text,offsetX,width,color)
			local label = CCLabelTTF:labelWithString(text,CCSize(width,0),0,SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(offsetX,55/2))
			label:setColor(color)
			panel:addChild(label)
		end

		local roleList = self.roleList
		local count = table.getn(roleList)
		local start = (page-1)*5 + 1
		local ends = start-1+5>count and count or start+5-1

		local index = 1
		for i = start, ends do
			local row = dbUIPanel:panelWithSize(CCSize(650,55))
			row:setAnchorPoint(CCPoint(0, 0))
			row:setPosition(CCPoint(0, 220-(index-1)*55))
			row.m_nScriptClickedHandler = function(ccp)
				self.selected = roleList[i]
				self:createLeft()
				createCurPoint(row)
			end
			panel:addChild(row)
			
			local color = ccc3(254,205,102)
			if i == 1 then
				color = ccc3(255,204,4)
			elseif i == 2 then
				color = ccc3(254,0,248)
			elseif i == 3 then
				color = ccc3(229,1,18)
			end
			
			local data = roleList[i]
			local rank = data.rank
			if ClientData.role_id == data.role_id then
				rank = rank.."(我)"
			end
			
			if self.type == 1 then --神位榜
				createItem(row,rank,63,100,color)
				createItem(row,data.name,160,250,color)
				createItem(row,data.officium,370,60,color)
				createItem(row,data.prestige,500,120,color)
			elseif self.type == 2 then --战力
				createItem(row,rank,63 ,100,color)
				createItem(row,data.name,160,250,color)
				createItem(row,data.officium,370,60,color)
				createItem(row,data.fight_power,500,120,color)
			elseif self.type == 3 then --宠物
				createItem(row,rank,40,100,color)
				createItem(row,data.role_name,110,250,color)
				createItem(row,data.name,255,250,color)
				createItem(row,data.job,370,100,color)
				createItem(row,data.level,480,50,color)
				createItem(row,data.attr,557,250,color)
			end
			index = index+1
			
			if data.vip > 0 then
				local width = 40;local height = 296 / 10
				local vipLevelSpr = CCSprite:spriteWithFile("UI/playerInfos/vip_level.png", CCRectMake(0, height * (data.vip-1), width, height))
				vipLevelSpr:setAnchorPoint(CCPoint(0,0.5))
				vipLevelSpr:setPosition(CCPoint(20,55/2))
				row:addChild(vipLevelSpr)
			end
			
			if i == start then
				self.selected = roleList[i]
				self:createLeft()
				createCurPoint(row)
			end
		end
		pagePanel.loaded = true
	end,

	--创建分页底下的圈圈
	createPageDot = function(self,pageCount)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 45))
		self.form:setPosition(650/2, 80)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		self.rightBg:addChild(self.form)
		self.pageToggles = {}
		for i=1, pageCount do
			local pageToggle = dbUIButtonToggle:buttonWithImage("UI/public/page_btn_normal.png","UI/public/page_btn_toggle.png")
			pageToggle:setPosition(CCPoint(52*(i-1),20) )
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
	end,
		
	loadRank = function(self,type)
		local function opRankFinishCB(s)
			closeWait()
			local error_code = s:getByKey("error_code"):asInt()		
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
				return				
			end

			self.myRank = 0
			self.roleList = {}
						
			if type == 1 then --神位榜
				for i = 1 , s:getByKey("role_list"):size() do
					local roleJson = s:getByKey("role_list"):getByIndex(i - 1)
					self.roleList[i] = {
						role_id = roleJson:getByKey("role_id"):asInt(),
						rank = roleJson:getByKey("rank"):asInt(),
						name = roleJson:getByKey("name"):asString(),
						officium = roleJson:getByKey("officium"):asInt(),
						prestige = roleJson:getByKey("prestige"):asInt(),
						vip = roleJson:getByKey("vip"):asInt(),
						figure = roleJson:getByKey("figure"):asInt(),
						popularity = roleJson:getByKey("popularity"):asInt(),
					}
					if ClientData.role_id == self.roleList[i].role_id then
						self.myRank = i
					end
				end
			elseif type == 2 then --战力
				for i = 1 , s:getByKey("role_list"):size() do
					local roleJson = s:getByKey("role_list"):getByIndex(i - 1)
					self.roleList[i] = {
						role_id = roleJson:getByKey("role_id"):asInt(),
						rank = roleJson:getByKey("rank"):asInt(),
						name = roleJson:getByKey("name"):asString(),
						officium = roleJson:getByKey("officium"):asInt(),
						fight_power = roleJson:getByKey("fight_power"):asInt(),
						vip = roleJson:getByKey("vip"):asInt(),
						figure = roleJson:getByKey("figure"):asInt(),
						popularity = roleJson:getByKey("popularity"):asInt(),
					}
					if ClientData.role_id == self.roleList[i].role_id then
						self.myRank = i
					end
				end			
			elseif type == 3 then --宠物
				local jobJsonConfig = GlobalCfgMgr:getCfgJsonRoot("cfg/cfg_job.json")
				for i = 1 , s:getByKey("general_list"):size() do
					local roleJson = s:getByKey("general_list"):getByIndex(i - 1)
					local job = jobJsonConfig:getByKey(""..roleJson:getByKey("job"):asInt()):getByKey("name"):asString()
					self.roleList[i] = {
						rank = roleJson:getByKey("rank"):asInt(),
						name = roleJson:getByKey("name"):asString(),
						role_id = roleJson:getByKey("role_id"):asInt(),
						role_name = roleJson:getByKey("role_name"):asString(),
						level = roleJson:getByKey("level"):asInt(),
						job = job,
						attr = roleJson:getByKey("attr"):asInt(),
						figure = roleJson:getByKey("figure"):asInt(),
						vip = 0,
						popularity = 0,
						officium = 0,
					}
					if ClientData.role_id == self.roleList[i].role_id and self.myRank == 0 then
						self.myRank = i
					end
				end
			end

			self.pageCount = getPageCount(table.getn(self.roleList),5)
			self:createRight()
		end	
		
		local function execRank()
			showWaitDialogNoCircle("waiting Rank!")
			local action = RCRankHeads[self.type].action
			local cj = Value:new()
			NetMgr:registOpLuaFinishedCB(action, opRankFinishCB)
			NetMgr:registOpLuaFailedCB(action, opFailedCB)
			NetMgr:executeOperate(action, cj)
		end
		execRank()
	end,
}
--日常 角色信息  面板
RCSettingPanel = {
	bg = nil,

	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 598))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(0,0)

		self:createLeft()
		self:createRight()
		return self
	end,

	createLeft = function(self)
		local niceGirl = CCSprite:spriteWithFile("UI/public/nice_girl.png")
		niceGirl:setAnchorPoint(CCPoint(0,0))
		niceGirl:setPosition(36-40, 78)
		self.bg:addChild(niceGirl)
	end,

	createRight = function(self)
		local listBg = createBG("UI/public/kuang_xiao_mi_shu.png",650,530)
		listBg:setAnchorPoint(CCPoint(0, 0))
		listBg:setPosition(CCPoint(320, 50))
		self.bg:addChild(listBg)
		--头
		local list_head_bg = createBG("UI/ri_chang/list_head_bg.png",650,80,CCSize(23,23))
		list_head_bg:setAnchorPoint(CCPoint(0, 0))
		list_head_bg:setPosition(CCPoint(0, 450))
		listBg:addChild(list_head_bg)
		
		local test = "";
		if ClientData.sdk=="umi" then
			test = "游戏问题：0571-85350171   充值问题：QQ1444922651"
		elseif ClientData.sdk=="joy7" then
			test = "客服QQ：2263174602  客服电话：4009210718"
		end
		local label = CCLabelTTF:labelWithString(test,CCSize(800,0),0, SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0,0.5))
		label:setPosition(CCPoint(10,40))
		label:setColor(ccc3(255,255,255))
		list_head_bg:addChild(label)
		
		--底部
		local list_foot_bg = createBG("UI/ri_chang/list_head_foot_bg.png",650,80,CCSize(20,20))
		list_foot_bg:setAnchorPoint(CCPoint(0, 0))
		list_foot_bg:setPosition(CCPoint(0, 0))
		listBg:addChild(list_foot_bg)

		local btn = dbUIButtonToggle:buttonWithImage("UI/ri_chang/sound_on.png", "UI/ri_chang/sound_off.png")
		btn:setPosition(CCPoint(60,308))
		btn:toggled(not dbAudioManager:sharedAudioManager():getMusicState())
		btn.m_nScriptClickedHandler = function()
			dbAudioManager:sharedAudioManager():setMusicState(not btn:isToggled());
		end
		listBg:addChild(btn)
		local label = CCLabelTTF:labelWithString("声音", SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0.5,1))
		label:setPosition(CCPoint(48,-10))
		label:setColor(ccc3(155,202,0))
		btn:addChild(label)
		
		--意见反馈
		local btn = dbUIButtonScale:buttonWithImage("UI/ri_chang/feedback.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(60, 308-175))
		btn:setAnchorPoint(CCPoint(0,0))
		btn.m_nScriptClickedHandler = function()
			globleShowMailFeedback()
		end
		listBg:addChild(btn)
		local label = CCLabelTTF:labelWithString("意见反馈", SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0.5,1))
		label:setPosition(CCPoint(48,-10))
		label:setColor(ccc3(155,202,0))
		btn:addChild(label)

		local btn = dbUIButtonScale:buttonWithImage("UI/ri_chang/mail.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(60+140, 308))
		btn:setAnchorPoint(CCPoint(0,0))
		btn.m_nScriptClickedHandler = function()
			globleShowMailInbox()
		end
		listBg:addChild(btn)
		local label = CCLabelTTF:labelWithString("邮箱", SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0.5,1))
		label:setPosition(CCPoint(48,-10))
		label:setColor(ccc3(155,202,0))
		btn:addChild(label)
		
		--随机码领取礼包
		local btn = dbUIButtonScale:buttonWithImage("UI/ri_chang/libao.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(60+140, 308-175))
		btn:setAnchorPoint(CCPoint(0,0))
		btn.m_nScriptClickedHandler = function()
			self:Libaoget()
		end
		listBg:addChild(btn)
		local label = CCLabelTTF:labelWithString("礼包领取", SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0.5,1))
		label:setPosition(CCPoint(48,-10))
		label:setColor(ccc3(155,202,0))
		btn:addChild(label)

		local btn = dbUIButtonScale:buttonWithImage("UI/ri_chang/center.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(60+140*2,308))
		btn:setAnchorPoint(CCPoint(0,0))
		btn.m_nScriptClickedHandler = function()
			local hud = dbHUDLayer:shareHUD2Lua()
			hud:homeBtnClickHandler()
		end
		listBg:addChild(btn)
		local label = CCLabelTTF:labelWithString("个人中心", SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0.5,1))
		label:setPosition(CCPoint(48,-10))
		label:setColor(ccc3(155,202,0))
		btn:addChild(label)
		
        local btn = dbUIButtonScale:buttonWithImage("UI/ri_chang/login_out.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(60+140*3, 308))
		btn:setAnchorPoint(CCPoint(0,0))
		btn.m_nScriptClickedHandler = function()
			local wtd = new(DialogTipPanel)
			wtd:create(LOGIN_OUT,ccc3(255,204,153),200)
			wtd.okBtn.m_nScriptClickedHandler = function()
				wtd:destroy()
				--GlobalLogout()
			end
		end
		listBg:addChild(btn)
		local label = CCLabelTTF:labelWithString("注销", SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0.5,1))
		label:setPosition(CCPoint(48,-10))
		label:setColor(ccc3(155,202,0))
		btn:addChild(label)
	end,
	
	Libaoget = function(self)
		local  createJunPanel = dbUIPanel:panelWithSize(WINSIZE)
		createJunPanel:setAnchorPoint(CCPoint(0.5, 0.5))
		createJunPanel:setPosition(CCPoint(1010/2,598/2))
		createJunPanel.m_nScriptClickedHandler = function()
			createJunPanel:removeFromParentAndCleanup(true)
		end
		self.bg:addChild(createJunPanel)
		
		--背景图
		local libao_bg = dbUIPanel:panelWithSize(CCSize(544,490))
		libao_bg:setAnchorPoint(CCPoint(0.5, 0.5))
		libao_bg:setPosition(CCPoint(WINSIZE.width/2,WINSIZE.height/2))
		createJunPanel:addChild(libao_bg)
		local lingqu_libao = CCSprite:spriteWithFile("UI/ri_chang/lingqu_libao.png")
		lingqu_libao:setAnchorPoint(CCPoint(0.5,0.5))
		lingqu_libao:setPosition(CCPoint(libao_bg:getContentSize().width/2,libao_bg:getContentSize().height/2))
		libao_bg:addChild(lingqu_libao)
		
		--输入框
		local inputPanel = dbUIPanel:panelWithSize(CCSize(384,53))
		inputPanel:setAnchorPoint(CCPoint(0.5,0))
		inputPanel:setPosition(CCPoint(libao_bg:getContentSize().width/2,244))
		libao_bg:addChild(inputPanel)
		
		local inputBg = CCSprite:spriteWithFile("UI/ri_chang/active_bg.png")
		inputBg:setAnchorPoint(CCPoint(0.5,0.5))
		inputBg:setPosition(CCPoint(384/2,53/2))
		inputPanel:addChild(inputBg)
		
		local inputText = dbUIWidgetInput:inputWithText("请输入激活码",SYSFONT[EQUIPMENT],30,false,18,CCRectMake(10,12,350,50))
		inputText:setNeedFocus(true)
		inputText.m_nScriptClickedHandler = function()
			if inputText:getString()=="请输入激活码" then
				inputText:setString("")
			end
		end
		inputPanel:addChild(inputText)
				
		local label = CCLabelTTF:labelWithString("每个激活码只能使用一次", SYSFONT[EQUIPMENT], 26)
		label:setAnchorPoint(CCPoint(0.5,0))
		label:setColor(ccc3(192,137,83))
		label:setPosition(CCPoint(libao_bg:getContentSize().width/2,209))
		libao_bg:addChild(label)	

		--确定按钮，确定后要么可以领取到，要么不能领取
		local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
		btn:setAnchorPoint(CCPoint(0.5,0))
		btn:setPosition(CCPoint(libao_bg:getContentSize().width/2,15))
		btn.m_nScriptClickedHandler = function()
       		RewardCode(inputText:getString())
		end
		libao_bg:addChild(btn)
    end,

}

function RewardCode(pack_code)
	local function opRewardCodeFinishCB(s)
		WaitDialog.closePanelFunc()
		local error_code = s:getByKey("error_code"):asInt()		
		if error_code > 0 then
			ShowErrorInfoDialog(error_code)
		else
			alert("恭喜你，成功领取".. s:getByKey("pack_name"):asString())
			
			local items = {}
			local amounts = {}
			
			for i = 1 , s:getByKey("items"):size() do
				items[i] = s:getByKey("items"):getByIndex(i-1):getByKey("cfg_item_id"):asInt()
				amounts[i] = s:getByKey("items"):getByIndex(i-1):getByKey("amount"):asInt()
			end
			
			GloblePlayerData.gold = GloblePlayerData.gold + s:getByKey("gold"):asInt()
			GloblePlayerData.exploit = GloblePlayerData.exploit + s:getByKey("exploit"):asInt()
			GloblePlayerData.copper = 	GloblePlayerData.copper + s:getByKey("copper"):asInt()
			campRewardGetItems(items,s,amounts)
		end
	end	
	
	local function execRewardCode()
		showWaitDialog("waiting RewardCode!")
		local action = Net.OPT_RewardCode
		NetMgr:registOpLuaFinishedCB(action, opRewardCodeFinishCB)
		NetMgr:registOpLuaFailedCB(action, opFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code", ClientData.request_code)
		cj:setByKey("pack_code", pack_code)
		cj:setByKey("type", 1)
		NetMgr:executeOperate(action, cj)
	end
	
	execRewardCode()
end
--邮件系统，全局调用
--收件箱
function globleShowMailInbox()
	GlobleMailPanel = new(MailMainPanel)
    GlobleMailPanel:create(1)
	createMailInbox()
end
--写邮件
function globleShowMailSend(friend_name)
	GlobleMailPanel = new(MailMainPanel)
    GlobleMailPanel:create(2)
	createMailSend(friend_name)
end
--建议
function globleShowMailFeedback()
	GlobleMailPanel = new(MailMainPanel)
    GlobleMailPanel:create(3)
	createFeedback()
end

--收件箱
function createMailInbox()
	local mip = new(MailInboxPanel)
	mip:create()
	GlobleMailPanel.mainWidget:addChild(mip.bg)
	GlobleMailPanel.mip = mip
end
--写邮件
function createMailSend(friend_name)
	local msp = new(MailSendPanel)
	msp:create(friend_name)
	GlobleMailPanel.mainWidget:addChild(msp.bg)
	GlobleMailPanel.msp = msp
end
--反馈
function createFeedback()
	local mfp = new(MailFeedbackPanel)
	mfp:create()
	GlobleMailPanel.mainWidget:addChild(mfp.bg)
	GlobleMailPanel.mfp = mfp
end

MailMainPanel = {
    bgLayer = nil,
    uiLayer = nil,
    topBtns = nil,
    centerWidget = nil,
    mainWidget = nil,

    create = function(self,topid)
    	local scene = DIRECTOR:getRunningScene()

    	self.bgLayer = createPanelBg()
        self.uiLayer,self.centerWidget = createCenterWidget()
       
		self.mainWidget = createMainWidget()

        scene:addChild(self.bgLayer, 1004)
	    scene:addChild(self.uiLayer, 2004)
	
	    local bg = CCSprite:spriteWithFile("UI/public/bg_light.png")
	    bg:setPosition(CCPoint(1010/2, 702/2)) 
	    self.centerWidget:addChild(bg)
    
		local topbtn = new(MailTopButton)
		topbtn:create()
		self.topBtns = topbtn.toggles		
		self.centerWidget:addChild(topbtn.bg,100)
		
		--注册开关切换事件
		for i = 1 , table.getn(topbtn.toggles) do
			topbtn.toggles[i].m_nScriptClickedHandler = function()
				if (topbtn.toggles[i]:isToggled()) then
                    self:clearMainWidget()
					if i == 1 then
						createMailInbox()
					elseif i == 2 then
						createMailSend()
					elseif i == 3 then
						createFeedback()
					end
				end
				topbtn:toggle(i)
			end
		end
		
		--关闭按钮
		topbtn.closeBtn.m_nScriptClickedHandler = function()		
			self:destroy()
		end

		topbtn:toggle(topid)
		
		self.centerWidget:addChild(self.mainWidget)
    end,

	clearMainWidget = function(self)
		self.mainWidget:removeAllChildrenWithCleanup(true)
	end,

    destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
        self.bgLayer = nil
        self.uiLayer = nil
        self.topBtns = nil
        self.centerWidget = nil
        self.mainWidget = nil
        GlobleMailPanel.mip = nil
        GlobleMailPanel.mwp = nil
        GlobleMailPanel.mfp = nil
        globalRecentContacts = nil
    end
}

MailTopBtnConfig = {
	{
		normal = "UI/mail/inbox_1.png",
		toggle = "UI/mail/inbox_2.png",
		position = 	CCPoint(250, 45),
	},
	{
		normal = "UI/mail/write_1.png",
		toggle = "UI/mail/write_2.png",
		position = 	CCPoint(250 + 190, 45),
	},	
	{
		normal = "UI/mail/feedback_1.png",
		toggle = "UI/mail/feedback_2.png",
		position = 	CCPoint(250 + 190 * 2, 45),
	},	
}

MailTopButton = {
	bg = nil,
	toggles = {},
	closeBtn = nil,
	backBtn = nil,
	
	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(1010, 90))
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(0,600))
		for i = 1 , table.getn(MailTopBtnConfig) do		
			local btn = dbUIButtonToggle:buttonWithImage(MailTopBtnConfig[i].normal,MailTopBtnConfig[i].toggle)
			btn:setAnchorPoint(CCPoint(0, 0.5))
			btn:setPosition(MailTopBtnConfig[i].position)
			self.toggles[i] = btn
			self.bg:addChild(btn)
		end 
		
		local title = CCSprite:spriteWithFile("UI/mail/title.png")
		title:setPosition(CCPoint(0, 45))
		title:setAnchorPoint(CCPoint(0, 0.5))
		self.bg:addChild(title)
				
		--关闭按钮
		local btn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(952, 45))
		btn:setAnchorPoint(CCPoint(0.5, 0.5))
		self.bg:addChild(btn)
		self.closeBtn = btn
	end,
	
	--切换
	toggle = function(self,topid)
		public_toggleRadioBtn(self.toggles,self.toggles[topid])
	end
}
local getStringLength = function(s)
	local length = 0
	while true do
		local ascii = s:byte(length + 1)
		if not ascii then break end
		length = length + 1
		if ascii >= 128 then
			length = length + 2
		end
	end 
	return length
end

local getStringByLength = function(s, length)
	local pos = 0
	while true do
		local ascii = s:byte(pos + 1)
		if not ascii then break end
		if ascii >= 128 then
			if pos + 3 <= length then 
				pos = pos + 3
			else
				break
			end
		else
			if pos + 1 <= length then
				pos = pos + 1
			else
				break
			end
		end
	end
	return string.sub(s, 1, pos)
end

local getTimeBefore = function(time)
		local nowTable = os.date("*t", os.time())
		local timeTable = os.date("*t", time)
		if nowTable.year - timeTable.year > 0 then
			return (nowTable.year - timeTable.year).."年前"
		elseif nowTable.month  - timeTable.month  > 0 then
			return (nowTable.month - timeTable.month).."个月前"
		elseif nowTable.day - timeTable.day > 0 then
			return (nowTable.day - timeTable.day).."天前"
		elseif nowTable.hour - timeTable.hour > 0 then
			return (nowTable.hour - timeTable.hour).."小时前"
		elseif nowTable.min - timeTable.min > 0 then
			return (nowTable.min - timeTable.min).."分钟前"
		else
			return "刚刚"
		end
end

--邮件系统 系统信息
MailInboxPanel = {
	bg = nil,
	mailCount = 0,
	curMailInfo = nil	,		--当前阅读的mailList中的item,删除邮件及回复时使用

	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(935,550))
		self.bg:setAnchorPoint(CCPoint(0.5, 0))
		self.bg:setPosition(CCPoint(1010/2, 35))

		self:createLeft()
		self:createRight()

		self:loadMail()
	end,

	createLeft = function(self)
		--背景
		self.lbg = createBG("UI/public/kuang_xiao_mi_shu.png", 345, 550)
		self.lbg:setAnchorPoint(CCPoint(0, 0))
		self.lbg:setPosition(CCPoint(0, 0))
		self.bg:addChild(self.lbg)
		--邮件条目List
		self.mailList = dbUIList:list(CCRectMake(10, 40, 350, 500), 0)
		self.lbg:addChild(self.mailList)
	end,
	
	createRight = function(self, mail)
		if self.rbg then
			self.rbg:removeAllChildrenWithCleanup(true)
		end
		self.rbg = createBG("UI/public/kuang_xiao_mi_shu.png", 580, 550)
		self.rbg:setAnchorPoint(CCPoint(1, 0))
		self.rbg:setPosition(CCPoint(935, 0))
		self.bg:addChild(self.rbg)
		--创建邮件内容
		if mail then
			self:createMailDetail(mail)
		end
	end,
	--创建邮件列表
	createMailList = function(self)
		for i = 1 , table.getn(self.mail_list) do
			local mail = self.mail_list[i]

			local id = mail.id
			local sender_name = mail.sender_name
			local title = mail.title
			local content = mail.content
			local send_time = mail.send_time
			local is_read = mail.is_read

			local item = dbUIPanel:panelWithSize(CCSize(335, 50))
		
			local isAdmin =  sender_name == "诸神Q传系统邮件" 
			mail.isAdmin = isAdmin
			local str = (isAdmin and "系统" or sender_name)..":"..title
			local length = getStringLength(str)
			local shortStr = str
			if length >= 30 then
				shortStr = getStringByLength(str,30).."..."
			end
			local label_info = CCLabelTTF:labelWithString(shortStr,CCSize(500,0),0, SYSFONT[EQUIPMENT], 20)
			label_info:setAnchorPoint(CCPoint(0,0.5))
			label_info:setPosition(CCPoint(0,50/2))
			label_info:setColor(is_read and ccc3(128, 128, 128) or (isAdmin and ccc3(153,204,0) or ccc3(253,204,102)))
			item:addChild(label_info)
			--日期
			local label_time = CCLabelTTF:labelWithString(getTimeBefore(send_time), CCSize(0,0), 0,  SYSFONT[EQUIPMENT], 20)
			label_time:setAnchorPoint(CCPoint(1,0.5))
			label_time:setPosition(CCPoint(325, 50/2))
			label_time:setColor(is_read and ccc3(128, 128, 128) or (isAdmin and ccc3(153,204,0) or ccc3(253,204,102)))
			item:addChild(label_time)
			item.m_nScriptClickedHandler = function()		
				if not self.curMailInfo then
					self.curMailInfo = new({})
				end
				self.curMailInfo.item = item
				self.curMailInfo.label_info = label_info
				self.curMailInfo.label_time = label_time
				self.curMailInfo.mail = mail
				if self.curMailInfo.focus then
					self.curMailInfo.focus:removeFromParentAndCleanup(true)
				end
				self.curMailInfo.focus = CCSprite:spriteWithFile("UI/jia_zu/cur.png")
				self.curMailInfo.focus:setAnchorPoint(CCPoint(0, 0.5))
				self.curMailInfo.focus:setPosition(CCPoint(334, 50 / 2))
				item:addChild(self.curMailInfo.focus)
				
				self:readMail(mail)
			end
			self.mailList:insterWidget(item)
		end
		self.mailList:m_setPosition(CCPoint(0,- self.mailList:get_m_content_size().height + self.mailList:getContentSize().height ))
		--邮件数
		self.mailCountLabel = CCLabelTTF:labelWithString(self.mailCount.."/30", CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 24)
		self.mailCountLabel:setColor(ccc3(180, 130, 67))
		self.mailCountLabel:setAnchorPoint(CCPoint(1, 0))
		self.mailCountLabel:setPosition(CCPoint(330, 15))
		self.lbg:addChild(self.mailCountLabel)
	end,
	--创建邮件详细内容
	createMailDetail = function(self, mail)
		if self.rbg then
			--发件人
			local sender = CCLabelTTF:labelWithString("发件人:", CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 28)
			sender:setColor(ccc3(245, 200, 115))
			sender:setAnchorPoint(CCPoint(0, 0.5))
			sender:setPosition(CCPoint(10,  510))
			self.rbg:addChild(sender)
			local kuang = createBG("UI/mail/kuang.png", 453, 46, CCSize(10, 10))
			kuang:setAnchorPoint(CCPoint(0, 0.5))
			kuang:setPosition(CCPoint(110, 510))
		    self.rbg:addChild(kuang)
		    local sender_name = CCLabelTTF:labelWithString(mail.sender_name, CCSize(433, 0), 0, SYSFONT[EQUIPMENT], 28)
			sender_name:setAnchorPoint(CCPoint(0, 0.5))
			sender_name:setPosition(CCPoint(10,  23))
			kuang:addChild(sender_name)
			--标题
			local sender = CCLabelTTF:labelWithString("标题:", CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 28)
			sender:setColor(ccc3(245, 200, 115))
			sender:setAnchorPoint(CCPoint(0, 0.5))
			sender:setPosition(CCPoint(38,  455))
			self.rbg:addChild(sender)
			local kuang = createBG("UI/mail/kuang.png", 453, 46, CCSize(10, 10))
			kuang:setAnchorPoint(CCPoint(0, 0.5))
			kuang:setPosition(CCPoint(110, 455))
		    self.rbg:addChild(kuang)
		    local title = CCLabelTTF:labelWithString(mail.title, CCSize(433, 0), 0, SYSFONT[EQUIPMENT], 28)
			title:setAnchorPoint(CCPoint(0, 0.5))
			title:setPosition(CCPoint(10,  23))
			kuang:addChild(title)
			--内容
			local sender = CCLabelTTF:labelWithString("内容:", CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 28)
			sender:setColor(ccc3(245, 200, 115))
			sender:setAnchorPoint(CCPoint(0, 0.5))
			sender:setPosition(CCPoint(38,  400))
			self.rbg:addChild(sender)
			local kuang = createBG("UI/mail/kuang.png", 453, 329, CCSize(10, 10))
			kuang:setAnchorPoint(CCPoint(0, 1))
			kuang:setPosition(CCPoint(110, 400 + 23))
		    self.rbg:addChild(kuang)
		     local content = CCLabelTTF:labelWithString(mail.content, CCSize(433, 0), 0, SYSFONT[EQUIPMENT], 28)
			content:setAnchorPoint(CCPoint(0, 1))
			content:setPosition(CCPoint(10,  320))
			kuang:addChild(content)
			--时间
			local time = CCLabelTTF:labelWithString(getTimeBefore(mail.send_time), CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 22)
			time:setColor(ccc3(245, 200, 115))
			time:setAnchorPoint(CCPoint(1, 0))
			time:setPosition(CCPoint(423,  10))
			kuang:addChild(time)
			--删除
		    local deleteBtn = dbUIButtonScale:buttonWithImage("UI/mail/delete.png", 1, ccc3(125, 125, 125))
		    deleteBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		    deleteBtn:setPosition(CCPoint(230, 50))
		    deleteBtn.m_nScriptClickedHandler = function()
		    	local deleteMail = function(ccp,id)
					self:deleteMail(mail.id)
				end
				
				local createBtns = function(ccp)
					local btns = {}
					local btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1, ccc3(125, 125, 125))
					btns[1] = btn
					btns[1].action = deleteMail
					btns[1].param = mail.id

					local btn = dbUIButtonScale:buttonWithImage("UI/public/cancel_btn.png", 1, ccc3(125, 125, 125))
					btns[2] = btn
					btns[2].action = nothing
					return btns
				end
				local dialogCfg = new(basicDialogCfg)
				dialogCfg.bg = "UI/baoguoPanel/kuang.png"
				dialogCfg.msg = "真的要删除这条信息吗？"
				dialogCfg.msgSize = 30
				dialogCfg.dialogType = 5
				dialogCfg.btns = createBtns()
				new(Dialog):create(dialogCfg)
		    end
		    self.rbg:addChild(deleteBtn)
		    --回复
		    local replyBtn = dbUIButtonScale:buttonWithImage("UI/mail/reply.png", 1, ccc3(125, 125, 125))
		    replyBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		    replyBtn:setPosition(CCPoint(450, 50))
		    replyBtn.m_nScriptClickedHandler = function()
            	GlobleMailPanel:clearMainWidget()
                public_toggleRadioBtn(GlobleMailPanel.topBtns,GlobleMailPanel.topBtns[2])
				createMailSend(self.curMailInfo.mail.sender_name)
		    end
		    self.rbg:addChild(replyBtn)
		    --系统邮件，无法回复
		    if mail.isAdmin then
		    	deleteBtn:setPosition(CCPoint(340, 50))
		    	replyBtn:setIsVisible(false)
		    end 
		end
	end,
	
	analogData = function(self)
		self.mail_list = new({})
		for i = 1, 20 do
			self.mail_list[i] = {
				id = i,
				send_time = 1000 * math.random(5),
				sender_name = "名字五个字",
				title = "这是标题这是标题",
				content = "这是邮件测试内容这是邮件测试内容这是邮件测试内容这是邮件测试内容这是邮件测试内容这是邮件测试内容!!",
				is_read =  (math.random(2) == 1) and true or false,
			}
		end
		local sortFunc = function(a,b)
			if a.is_read ~= b.is_read then
				return b.is_read
			else
				return a.send_time > b.send_time
			end
		end
		table.sort(self.mail_list,sortFunc)
	end,

	initData = function (self,json)
		self.mail_list = new ({})
		local mail_list = json:getByKey("mail_list")
		for i = 1,mail_list:size() do
			local pre_mail = mail_list:getByIndex(i-1)
			self.mail_list[i] = new({})
			self.mail_list[i].id = pre_mail:getByKey("id"):asInt()
			self.mail_list[i].send_time = math.floor(pre_mail:getByKey("send_time"):asDouble() / 1000)
			self.mail_list[i].title = pre_mail:getByKey("title"):asString()
			self.mail_list[i].sender_name = pre_mail:getByKey("sender_name"):asString()
			self.mail_list[i].is_read = pre_mail:getByKey("is_read"):asBool()
		end

		local sortFunc = function(a,b)
			if a.is_read ~= b.is_read then
				return a.is_read
			else
				return a.send_time > b.send_time
			end
		end
		table.sort(self.mail_list,sortFunc)
		self.mailCount = #self.mail_list
	end,
	--更新邮件状态，未读->已读
	updateMailStatus = function(self)
		local label_info = self.curMailInfo.label_info
		local label_time = self.curMailInfo.label_time
		label_info:setColor(ccc3(128, 128, 128))
		label_time:setColor(ccc3(128, 128, 128))
	end,
	--打开邮件
	readMail = function(self, mail)
		--发送设置邮件状态请求
		local getMailCB = function (json)
			local error_code = json:getByKey("error_code"):asInt()
			if error_code == -1 then
				mail.is_read = true
				mail.content = json:getByKey("content"):asString()
				self:updateMailStatus()
				self:createRight(mail)
			else
				ShowErrorInfoDialog(error_code)
			end
		end
		local sendRequest = function ()
			local action = Net.OPT_Read
			NetMgr:registOpLuaFinishedCB(action,getMailCB)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("mail_id", mail.id)
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,
	
	updateMailCount = function(self)
			self.mailCount = math.max(0, self.mailCount - 1)
			self.mailCountLabel:setString(self.mailCount.."/30")
	end,
	--删除邮件
	deleteMail = function(self,id)
		local delMailCB = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				alert("删除成功")
				self.mailList:removeWidget(self.curMailInfo.item,true)
				self.mailList:m_setPosition(CCPoint(0,- self.mailList:get_m_content_size().height + self.mailList:getContentSize().height ))
				self.curMailInfo = nil
				self:updateMailCount()
				self:createRight()
			end
		end

		local sendRequest = function ()
			local action = Net.OPT_Drop
			showWaitDialogNoCircle("waiting OPT_Drop!")
			NetMgr:registOpLuaFinishedCB(action,delMailCB)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			
			local array = Value:new()
			array:setByIndex(0, id)
			cj:setByKey("mail_ids", array)

			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,
	--加载邮件
	loadMail = function(self)
		local netCallback = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				--self:analogData()
				self:initData(json)
				self:createMailList()
				globalSaveRecentContacts(json)
			end
		end

		local sendRequest = function ()
			local action = Net.OPT_Mail
			showWaitDialogNoCircle("waiting OPT_Mail!")
			NetMgr:registOpLuaFinishedCB(action,netCallback)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,
}
local function calcStringCount(s, count)
	local pos = 0
	while count >  0 do
		pos = pos + 1
		local ascii = s:byte(pos)
		if not ascii then break end
		if ascii >= 128 then
			pos = pos + 2
		end
		count = count - 1
	end 
	return pos
end
--保存最近联系人
globalRecentContacts = nil
globalSaveRecentContacts = function(json)
	local person_list = json:getByKey("person_list")
	globalRecentContacts = new({})
	for i = 1, person_list:size() do
		globalRecentContacts[i] = person_list:getByIndex(i-1):asString()
	end
end

--邮件系统 写邮件
MailSendPanel = {
	bg = nil,
	contentLengthCheckHandler = nil,
	
	create = function(self, name)
		self.bg = dbUIPanel:panelWithSize(CCSize(935,550))
		self.bg:setAnchorPoint(CCPoint(0.5, 0))
		self.bg:setPosition(CCPoint(1010/2, 35))

		self:createLeft()
		self:createRight(name)
	end,

	createLeft = function(self)
		--背景
		local lbg = createBG("UI/public/kuang_xiao_mi_shu.png", 215, 550)
		lbg:setAnchorPoint(CCPoint(0, 0))
		lbg:setPosition(CCPoint(0, 0))
		self.bg:addChild(lbg)
		--最近联系人
		local label = CCLabelTTF:labelWithString("最近联系人：",CCSize(300,0),0, SYSFONT[EQUIPMENT], 28)
		label:setColor(ccc3(253,204,102))
		label:setAnchorPoint(CCPoint(0, 0))
		label:setPosition(CCPoint(20, 500))
		lbg:addChild(label)
		--最近联系人List
		self.contactsList = dbUIList:list(CCRectMake(10, 10, 195, 485), 0)
		lbg:addChild(self.contactsList)
		if globalRecentContacts then
			self:createRecentContacts()
		else
			self:getRecentContacts()
		end
	end,
	
	createRight = function(self, name)
		if self.rbg then
			self.rbg:removeAllChildrenWithCleanup(true)
		end
		self.rbg = createBG("UI/public/kuang_xiao_mi_shu.png", 710, 550)
		self.rbg:setAnchorPoint(CCPoint(1, 0))
		self.rbg:setPosition(CCPoint(935, 0))
		self.bg:addChild(self.rbg)
		--创建写邮件
		self:createWriteMail(name)
	end,
	--请求获取最近联系人	--直接进入写邮件时，未获取最近联系人
	getRecentContacts = function(self)
		local recentContactsCallback = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				globalSaveRecentContacts(json)
				self:createRecentContacts()
			end
		end

		local sendRequest = function ()
			local action = Net.OPT_Mail
			showWaitDialogNoCircle("waiting OPT_Mail!")
			NetMgr:registOpLuaFinishedCB(action,recentContactsCallback)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,
	--创建最近联系人
	createRecentContacts = function(self)
		self.contacts_list = globalRecentContacts
		self.contactsList:removeAllWidget(true)
		for i = 1 , table.getn(self.contacts_list) do
			local contact = self.contacts_list[i]
			local item = dbUIPanel:panelWithSize(CCSize(315, 40))
			local label = CCLabelTTF:labelWithString(contact,CCSize(300,0),0, SYSFONT[EQUIPMENT], 26)
			label:setAnchorPoint(CCPoint(0,0.5))
			label:setPosition(CCPoint(10,40/2))
			item:addChild(label)
			item.m_nScriptClickedHandler = function()		
				self:setReceiver(contact)
			end
			self.contactsList:insterWidget(item)
		end
		self.contactsList:m_setPosition(CCPoint(0,- self.contactsList:get_m_content_size().height + self.contactsList:getContentSize().height ))
	end,
	--创建写邮件
	createWriteMail = function(self, name)
		if self.rbg then
			--收件人
			local receiver = CCLabelTTF:labelWithString("收件人:", CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 28)
			receiver:setColor(ccc3(245, 200, 115))
			receiver:setAnchorPoint(CCPoint(0, 0.5))
			receiver:setPosition(CCPoint(10,  510))
			self.rbg:addChild(receiver)
			local kuang = createBG("UI/mail/kuang.png", 583, 46, CCSize(10, 10))
			kuang:setAnchorPoint(CCPoint(0, 0.5))
			kuang:setPosition(CCPoint(110, 510))
		    self.rbg:addChild(kuang)
		    self.receiverInput = dbUIWidgetInput:inputWithText("","Thonburi", 28,false,5,CCRectMake(10,10,563,46))
			self.receiverInput:setNeedFocus(true)
			kuang:addChild(self.receiverInput)
		    if name then
				self.receiverInput:setString(name)
			end
			--标题
			local title = CCLabelTTF:labelWithString("标题:", CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 28)
			title:setColor(ccc3(245, 200, 115))
			title:setAnchorPoint(CCPoint(0, 0.5))
			title:setPosition(CCPoint(38,  455))
			self.rbg:addChild(title)
			local kuang = createBG("UI/mail/kuang.png", 583, 46, CCSize(10, 10))
			kuang:setAnchorPoint(CCPoint(0, 0.5))
			kuang:setPosition(CCPoint(110, 455))
		    self.rbg:addChild(kuang)
		    self.titleInput = dbUIWidgetInput:inputWithText("","Thonburi",28,false,8,CCRectMake(10,10,563,46))
			self.titleInput:setNeedFocus(true)
			kuang:addChild(self.titleInput)
			--内容
			local cotent = CCLabelTTF:labelWithString("内容:", CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 28)
			cotent:setColor(ccc3(245, 200, 115))
			cotent:setAnchorPoint(CCPoint(0, 0.5))
			cotent:setPosition(CCPoint(38,  400))
			self.rbg:addChild(cotent)
			local kuang = createBG("UI/mail/kuang.png", 583, 329, CCSize(10, 10))
			kuang:setAnchorPoint(CCPoint(0, 1))
			kuang:setPosition(CCPoint(110, 400 + 23))
			kuang:setNeedFocus(true)
			kuang.m_nScriptGainFocusHandler = function()
				self.contentInput:attachWithIME()
			end
			kuang.m_nScriptLostFocusHandler = function()
				self.contentInput:detachWithIME()
			end
		    self.rbg:addChild(kuang)
			--self.contentInput = dbUIWidgetInput:inputWithText("",SYSFONT[EQUIPMENT],28,false,50,CCRectMake(10,329 - 36,563,329))
			--self.contentInput:setNeedFocus(true)
			--kuang:addChild(self.contentInput)
			self.contentInput = CCTextFieldTTF:textFieldWithPlaceHolder("",CCSize(563, 0), 0,  SYSFONT[EQUIPMENT], 28)
			self.contentInput:setAnchorPoint(CCPoint(0, 1))
			self.contentInput:setPosition(CCPoint(10,319))
			self.contentInput:registerScriptHandler(function(eventType)
				if eventType == kCCNodeOnExit then
					if self.contentLengthCheckHandler then
						CCScheduler:sharedScheduler():unscheduleScriptEntry(self.contentLengthCheckHandler)
						self.contentLengthCheckHandler = nil
					end
				end
			end)
			kuang:addChild(self.contentInput)
			--检测内容长度
			local function checkContentLegth()
				if self.contentInput:getCharCount() >= 50 then
					local content = self.contentInput:getString()
					local pos = calcStringCount(content,50)
  					local subStr = string.sub(content, 1, pos)
					self.contentInput:setString(subStr)
				end
			end
			if not self.contentLengthCheckHandler then
				self.contentLengthCheckHandler = CCScheduler:sharedScheduler():scheduleScriptFunc(checkContentLegth, 0.3, false)
			end
		    --发送
		    local sendBtn = dbUIButtonScale:buttonWithImage("UI/mail/send.png", 1, ccc3(125, 125, 125))
		    sendBtn:setAnchorPoint(CCPoint(0.5, 0.5))
		    sendBtn:setPosition(CCPoint(400, 50))
		    sendBtn.m_nScriptClickedHandler = function()
		    	if self.receiverInput:getString() == "" then
		    		alert("收件人未填写，无法发送！")
		    	elseif self.titleInput:getString() == "" then
		    		alert("标题未填写，无法发送！")
		    	elseif self.contentInput:getString() == "" then
		    		alert("内容未填写，无法发送！")
		    	else
		    		local detail = {
		    			receiver = self.receiverInput:getString(),
		    			title = self.titleInput:getString(),
		    			content = self.contentInput:getString(),
		    		}
		    		self:sendMail(detail)
		    	end
			end
		    self.rbg:addChild(sendBtn)
		end
	end,
	
	analogData = function(self)
		self.contacts_list = new({})
		for i = 1, 10 do
			self.contacts_list[i] = "测试名字"..i
		end
	end,

	--设置收件人
	setReceiver = function(self, receiver)
		self.mReceiver = receiver
		self.receiverInput:setString(receiver)
	end,
	--加入到最近联系人	
	insertToRecentContacts = function(self, receiver)
		local exist = false
		for i = 1, #globalRecentContacts do
			if globalRecentContacts[i] == receiver then
				exist = true
				break
			end
		end
		if not exist then
			table.insert(globalRecentContacts, 1,receiver)
			self:createRecentContacts()
		end
	end,
	--发送邮件
	sendMail = function(self,detail)
		local sendMailCB = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				alert("发送成功")
				self:insertToRecentContacts(detail.receiver)
			end
		end

		local sendRequest = function ()
			local action = Net.OPT_Send
			showWaitDialogNoCircle("waiting OPT_Send!")
			NetMgr:registOpLuaFinishedCB(action,sendMailCB)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)
			
			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			
			cj:setByKey("receiver_name", detail.receiver)
			cj:setByKey("title", detail.title)
			cj:setByKey("content", detail.content)
			
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,
}
--邮件系统 反馈信息
MailFeedbackPanel = {
	bg = nil,

	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(930,505))
		self.bg:setAnchorPoint(CCPoint(0.5, 0))
		self.bg:setPosition(CCPoint(1010/2, 32))

		local textBg = createBG("UI/public/kuang_xiao_mi_shu.png",930,50)
		textBg:setAnchorPoint(CCPoint(0, 0))
		textBg:setPosition(CCPoint(0, 455))
		self.bg:addChild(textBg)

		local input = dbUIWidgetInput:inputWithText("",SYSFONT[EQUIPMENT],30,false,60,CCRectMake(10,10,800,50))
		input:setNeedFocus(true)
		textBg:addChild(input)
		
		local test = "";
		if ClientData.sdk=="umi" then
			test = "游戏相关问题请联系客服：0571-85350171 QQ:1713256038\n充值帐号类问题请联系客服：QQ1444922651"
		elseif ClientData.sdk=="joy7" then
			test = "客服QQ：2263174602  客服电话：4009210718"
		end
		local label = CCLabelTTF:labelWithString(test,CCSize(800,0),0, SYSFONT[EQUIPMENT], 30)
		label:setAnchorPoint(CCPoint(0,0))
		label:setPosition(CCPoint(0,10))
		label:setColor(ccc3(86,40,4))
		self.bg:addChild(label)

		local btn = dbUIButtonScale:buttonWithImage("UI/mail/send.png", 1, ccc3(125, 125, 125))
		btn:setPosition(CCPoint(770, 20))
		btn:setAnchorPoint(CCPoint(0, 0))
		btn.m_nScriptClickedHandler = function()
			self:send(input:getString())
		end
		self.bg:addChild(btn)	
	end,

	send = function(self,content)
		if content=="" then
			alert("亲，你还没写什么呢")
			return
		end
		local netCallback = function (json)
			closeWait()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code > 0 then
				ShowErrorInfoDialog(error_code)
			else
				alert("发送成功")
			end
		end

		local sendRequest = function ()
			local action = Net.OPT_Send
			showWaitDialogNoCircle("waiting OPT_Mail!")
			NetMgr:registOpLuaFinishedCB(action,netCallback)
			NetMgr:registOpLuaFailedCB(action,opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code", ClientData.request_code)
			cj:setByKey("receiver_name", "admin")
			cj:setByKey("title", "feedback")
			cj:setByKey("content",content)
			NetMgr:executeOperate(action, cj)
		end
		sendRequest()
	end,
}
globalQuickGetReward = function()
	if ClientData.new_man_reward == false then
		if not globalQuickGetLoginReward() then	--登录礼包领取
			globalQuickGetVitalityReward()					--活跃度礼包领取
		end
	end
end

--连续登录奖励
globalQuickGetLoginReward = function()
	if GloblePlayerData.login_days > GloblePlayerData.login_reward_step and ClientData.new_man_reward==false then
		local loginPanel = new(QuiclGetLoginRewardPanel)
		loginPanel:create()
		return true
	else 
		return false
	end
end

--活跃度奖励
globalQuickGetVitalityReward = function()
	local vitalityPanel = new(QuickGetVitalityRewardPanel)
	vitalityPanel:initData()
	if vitalityPanel.idx ~= 0 and vitalityPanel.idx <= vitalityPanel.canRewardCount then
		vitalityPanel:create()
	end
end

local createBGForReward = function(isLoginBG, isShortTitle)	--login背景略高
	local scene = DIRECTOR:getRunningScene()
	
	local bgLayer = createSystemPanelBg()
	local uiLayer = dbUIMask:node()
	local centerWidget = dbUIPanel:panelWithSize(CCSize(891, isLoginBG and 705 or 640))
	
	centerWidget:setAnchorPoint(CCPoint(0.5, 0.5))
	centerWidget:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
	centerWidget:setScale(SCALE)
	uiLayer:addChild(centerWidget)
	
	scene:addChild(bgLayer, 1000)
	scene:addChild(uiLayer, 2000)
	
	--背景
	--背景拉伸
	local bg1 = dbUIWidgetBGFactory:widgetBG()
	bg1:setBGSize(CCSizeMake(891, isLoginBG and 625 or 573))
	bg1:setCornerSize(CCSizeMake(134,110))
	bg1:createCeil("UI/get_reward/bg1.png")
	bg1:setAnchorPoint(CCPoint(0,0))
	bg1:setPosition(CCPoint(0, 0))
	--内背景拉伸
	local bg2 = dbUIWidgetBGFactory:widgetBG()
	bg2:setBGSize(CCSizeMake(854, isLoginBG and 494 or 424))
	bg2:setCornerSize(CCSizeMake(70,70))
	bg2:createCeil("UI/get_reward/bg2.png")
	bg2:setAnchorPoint(CCPoint(0.5, 1.0))
	bg2:setPosition(CCPoint(891 / 2,  isLoginBG and (617 - 34) or (565 - 44)))
	bg1:addChild(bg2)
	--上方圆弧
	local radian = CCSprite:spriteWithFile(isShortTitle and "UI/get_reward/radian_short.png" or "UI/get_reward/radian_long.png")
	radian:setAnchorPoint(CCPoint(0.5, 1.0))
	radian:setPosition(891 / 2, isLoginBG and 627 or 565)	--外层渐变阴影，故要下层几个像素
	bg1:addChild(radian)
	
	centerWidget:addChild(bg1)
	
	return bgLayer, uiLayer, centerWidget
end

QuiclGetLoginRewardPanel = {
	
	originRewardStep = 0,		--保存已经领取的天数
	rewardGetDays = 0,			--领取的天数
		
	initData = function(self)
		self.originRewardStep = GloblePlayerData.login_reward_step
	end,	
		
	create = function(self)
		--初始化数据
		self:initData()
		--背景	
		self.bgLayer, self.uiLayer, self.centerWidget = createBGForReward(true, false)
		--标语
		local head = CCSprite:spriteWithFile("UI/get_reward/login_head.png")
		head:setAnchorPoint(CCPoint(0.5, 1))
		head:setPosition(CCPoint(891 / 2, 705))
		self.centerWidget:addChild(head)
		--分割线
		self:createLine()
		--物品
		for i = 1, #login_item_cfg do
			self:createItem(i)
		end
		--领取按钮
		local get_btn = dbUIButtonScale:buttonWithImage("UI/gift/log_get.png", 1.2, ccc3(125, 125, 125))
		get_btn:setAnchorPoint(CCPoint(0.5, 0.5))
		get_btn:setPosition(CCPoint(891 / 2, 55))
		get_btn.m_nScriptClickedHandler = function()
			self:getReward()
		end
		self.centerWidget:addChild(get_btn)
	end,
	
	createLine = function(self)
		--六条横线
		for i = 1, 6 do
			local line_horizontal = CCSprite:spriteWithFile("UI/public/line_2.png")
			line_horizontal:setAnchorPoint(CCPoint(0.5, 0))
			line_horizontal:setPosition(CCPoint(891 / 2, 100 + 65 * i))
			line_horizontal:setScaleX(800 / 28)
			self.centerWidget:addChild(line_horizontal)
		end
		--一条竖线
		local line1_vertical = CCSprite:spriteWithFile("UI/get_reward/line_vertical.png")
		line1_vertical:setAnchorPoint(CCPoint(0.5, 0))
		line1_vertical:setPosition(CCPoint(login_item_x[2], 90))
		line1_vertical:setScale(485 / 472)
		self.centerWidget:addChild(line1_vertical)
	end,
	
	createItem = function(self, index)
		--title
		local title = CCSprite:spriteWithFile("UI/get_reward/login"..index..".png")
		title:setAnchorPoint(CCPoint(0, 0.5))
		title:setPosition(CCPoint(login_item_x[1], login_item_cfg[index].centerY))
		self.centerWidget:addChild(title)
		--content
		for k, v in pairs(login_item_cfg[index].content) do
			local type_icon = nil
			if v.type == 1 then
				type_icon = CCSprite:spriteWithFile("UI/get_reward/silver_small.png")
			elseif v.type == 2 then
				type_icon = CCSprite:spriteWithFile("UI/get_reward/zhangong_small.png")
				--type_icon:setScale(0.5)
			elseif v.type == 3 then
				type_icon = CCSprite:spriteWithFile("UI/get_reward/gold_small.png")
			elseif v.type == 4 then
				type_icon = CCSprite:spriteWithFile("icon/Item/icon_item_"..v.icon..".png")
				type_icon:setScale(0.5)
			elseif v.type == 5 then
				type_icon = CCSprite:spriteWithFile("icon/Item/icon_item_10000048.png")
				type_icon:setScale(0.5)
			elseif v.type == 6 then
				type_icon = CCSprite:spriteWithFile("icon/jin_yan_dan.png")
				type_icon:setScale(0.5)
			end
			type_icon:setAnchorPoint(CCPoint(0, 0.5))
			type_icon:setPosition(CCPoint(login_item_x[k+1] + 10, login_item_cfg[index].centerY))
			self.centerWidget:addChild(type_icon)
			local value_label = CCLabelTTF:labelWithString("*"..v.value, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 20)
			--value_label:setColor(ccc3(255,204,51))
			value_label:setAnchorPoint(CCPoint(0, 0.5))
			value_label:setPosition(CCPoint(login_item_x[k+1] + 60, login_item_cfg[index].centerY))
			self.centerWidget:addChild(value_label)
		end
		
		if index <= GloblePlayerData.login_reward_step then	--已经领取
			--已领取
			local get = CCSprite:spriteWithFile("UI/get_reward/already_get_small.png")
			get:setAnchorPoint(CCPoint(0, 0.5))
			get:setPosition(CCPoint(login_item_x[6], login_item_cfg[index].centerY))
			self.centerWidget:addChild(get)
		elseif index <= GloblePlayerData.login_days then	--可以领取
			local can_get = CCSprite:spriteWithFile("UI/get_reward/can_get.png")
			can_get:setAnchorPoint(CCPoint(0, 0.5))
			can_get:setPosition(login_item_x[6], login_item_cfg[index].centerY)	
			self.centerWidget:addChild(can_get)
		end
	end,
	
	getReward = function(self)
		local function opGetRewardFinishCB(json)
			closeWait()
			self:destroy()		--是否显示奖励结果，都将领取奖励界面销毁
			local error_code = json:getByKey("error_code"):asInt()
			if error_code == -1 or error_code == 2001 then
				if not json:getByKey("iemChangeList"):isNull() then		--有数据返回
					GloblePlayerData.copper = json:getByKey("copper"):asInt()
					GloblePlayerData.gold = json:getByKey("gold"):asInt()
					GloblePlayerData.exploit = json:getByKey("exploit"):asInt()
					updataHUDData()
			
					local iemChangeList = json:getByKey("iemChangeList")
					for i=0, iemChangeList:size()-1 do
						local itemChange = iemChangeList:getByIndex(i)
						
						local addList = itemChange:getByKey("add_item_id_list")
						local changeList = itemChange:getByKey("change_item_id_list")
						local cfgItemId = itemChange:getByKey("cfg_item_id"):asInt()
						for j=0, addList:size()-1 do
							local itemId = addList:getByIndex(j):asInt()
							battleGetItems({cfgItemId,itemId},true)
						end
						for j=0, changeList:size()-1 do
							local itemId = changeList:getByIndex(j):asInt()
							battleGetItems({cfgItemId,itemId},true)
						end
					end
					GloblePlayerData.login_reward_step = json:getByKey("login_reward_step"):asInt()
					self.rewardGetDays = GloblePlayerData.login_reward_step - self.originRewardStep
					--关闭HUD中的动画显示
					local gift_enable = json:getByKey("gift_enable"):asBool()
					ClientData.gift_enable = gift_enable
					GiftEnable(ClientData.gift_enable)
				
					self:showRewardStep(error_code)
				else
					alert("背包空间不足，礼包领取失败，整理背包后重新登陆可再次领取。")
					globalQuickGetVitalityReward()	--显示活跃度奖励
				end
	 			RefreshItem()
			else
				ShowErrorInfoDialog(error_code)
			end
		end
		local function execGetReward()
			showWaitDialogNoCircle("打开礼包中...")
			NetMgr:registOpLuaFinishedCB(Net.OPT_RewardLogin, opGetRewardFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_RewardLogin, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			
			NetMgr:executeOperate(Net.OPT_RewardLogin, cj)
		end
		execGetReward()
	end,
	
	--逐个显示奖励
	showRewardStep = function(self, error_code)
		for i = self.rewardGetDays, 1, -1 do
			local data = {
				class = 1,
				index = self.originRewardStep + i,
			}
			if i == self.rewardGetDays then		--领取的最后一个奖励，需要跳转提示error_code，跳转活跃度
				data.error_code = error_code
				data.finish = true
			end	
			showQuickRewarResult(false, data)
		end
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
	end
	
}

QuickGetVitalityRewardPanel = {

	idx = nil,				--当前还未领的
	vitality = nil,			--当前活跃度
	canRewardCount = nil, 	--当前活跃度可以领取的宝箱数
	rewardCount = nil,		--领取的个数
	
	initData = function(self)
		--初始化数据	
		self.vitality = GloblePlayerData.vitality
		self.idx = GloblePlayerData.vitality_idx
		if self.vitality >= 100 then
			self.canRewardCount = 4
		elseif self.vitality >= 60 then
			self.canRewardCount = 3
		elseif self.vitality >= 30 then
			self.canRewardCount = 2
		elseif self.vitality >= 5 then
			self.canRewardCount = 1
		else
			self.canRewardCount = 0
		end
	end,
	
	create = function(self)
		--背景
		self.bgLayer, self.uiLayer, self.centerWidget = createBGForReward(false, false)
		--标语
		local head = CCSprite:spriteWithFile("UI/get_reward/hyd_head.png")
		head:setAnchorPoint(CCPoint(0.5, 1))
		head:setPosition(CCPoint(891 / 2, 640))
		self.centerWidget:addChild(head)
		--提示
		local hyd_tip_label = CCLabelTTF:labelWithString("每天点小秘书，可赚取活跃度，并能领取相应的活跃度宝箱奖励。",CCSize(800,0),0, SYSFONT[EQUIPMENT], 24)
		hyd_tip_label:setAnchorPoint(CCPoint(0,0.5))
		hyd_tip_label:setPosition(CCPoint(80, 450))
		hyd_tip_label:setColor(ccc3(255,204,51))
		self.centerWidget:addChild(hyd_tip_label)
		--物品
		for i = 1, #hyd_item_cfg do
			self:createItem(i)
		end
		--当前活跃度
		local cur_hyd = CCSprite:spriteWithFile("UI/get_reward/hyd.png")
		cur_hyd:setAnchorPoint(CCPoint(0, 0.5))
		cur_hyd:setPosition(CCPoint(85, 140))
		self.centerWidget:addChild(cur_hyd)
		local hyd_value = CCLabelTTF:labelWithString(self.vitality, CCSize(200, 0), 0, SYSFONT[EQUIPMENT], 24)
		hyd_value:setColor(ccc3(249,179,58))
		hyd_value:setAnchorPoint(CCPoint(0, 0.5))
		hyd_value:setPosition(CCPoint(220, 140))
		self.centerWidget:addChild(hyd_value)
		--领取按钮
		local get_btn = dbUIButtonScale:buttonWithImage("UI/gift/log_get.png", 1.2, ccc3(125, 125, 125))
		get_btn:setAnchorPoint(CCPoint(0.5, 0.5))
		get_btn:setPosition(CCPoint(891 / 2, 55))
		get_btn.m_nScriptClickedHandler = function()
			self:getReward()
		end
		self.centerWidget:addChild(get_btn)
	end,
	
	createItem = function(self, index)
		local item_bg = CCSprite:spriteWithFile("UI/get_reward/hyd_item_bg.png")
		item_bg:setAnchorPoint(CCPoint(0, 0))
		item_bg:setPosition(hyd_item_cfg[index].position)
		
		local title = CCLabelTTF:labelWithString(hyd_item_cfg[index].title, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 20);
		title:setAnchorPoint(CCPoint(0.5, 1.0))
		title:setPosition(CCPoint(149 / 2, 227 - 15))
		title:setColor(ccc3(0, 0, 0))
		item_bg:addChild(title)
		
		local content1 = CCLabelTTF:labelWithString(hyd_item_cfg[index].content1, CCSize(0, 0), CCTextAlignmentCenter, SYSFONT[EQUIPMENT], 20)
		content1:setAnchorPoint(CCPoint(0.5, 1.0))
		content1:setPosition(CCPoint(149 / 2, 65))
		content1:setColor(ccc3(0, 0, 0))
		item_bg:addChild(content1)
		
		local content2 = CCLabelTTF:labelWithString(hyd_item_cfg[index].content2, CCSize(0, 0), CCTextAlignmentCenter, SYSFONT[EQUIPMENT], 20)
		content2:setAnchorPoint(CCPoint(0.5, 1.0))
		content2:setPosition(CCPoint(149 / 2, 40))
		content2:setColor(ccc3(0, 0, 0))
		item_bg:addChild(content2)
		
		if index > self.canRewardCount then	--不可领取的宝箱
			local box = CCSprite:spriteWithFile("UI/get_reward/hyd_box_gray.png")
			box:setPosition(CCPoint(149 / 2, 126))
			item_bg:addChild(box)
		else
			if index < self.idx then	--已经领取过的宝箱
				local box = CCSprite:spriteWithFile("UI/get_reward/hyd_box_gray.png")
				box:setPosition(CCPoint(149 / 2, 126))
				item_bg:addChild(box)
				--已领取
				local get = CCSprite:spriteWithFile("UI/get_reward/already_get.png")
				get:setAnchorPoint(CCPoint(0.5, 0.5))
				get:setPosition(149 / 2, 150)
				item_bg:addChild(get)
			else						--可以领取
				local box_light = CCSprite:spriteWithFile("UI/get_reward/hyd_box_light.png")
				box_light:setPosition(CCPoint(149 / 2, 126))
				item_bg:addChild(box_light)
			end
		end
		self.centerWidget:addChild(item_bg)
	end,
	
	getReward = function(self)
		local opGetRewaradFinishCB = function(json)
			closeWait()
			self:destroy()
			local error_code = json:getByKey("error_code"):asInt()
			if error_code == -1 or error_code == 2001 then
				local iemChangeList = json:getByKey("iemChangeList")
				if not iemChangeList:isNull() then
					GloblePlayerData.copper = json:getByKey("copper"):asInt()
					updataHUDData()
					for i=0, iemChangeList:size()-1 do
						local itemChange = iemChangeList:getByIndex(i)
						local addList = itemChange:getByKey("add_item_id_list")
						local changeList = itemChange:getByKey("change_item_id_list")
						local cfgItemId = itemChange:getByKey("cfg_item_id"):asInt()
						for j=0, addList:size()-1 do
							local itemId = addList:getByIndex(j):asInt()
							battleGetItems({cfgItemId,itemId},true)
						end
						for j=0, changeList:size()-1 do
							local itemId = changeList:getByIndex(j):asInt()
							battleGetItems({cfgItemId,itemId,1,true},true)
						end
					end
					
					local rewardIdx = json:getByKey("idx"):asInt()
					local rewardCount = rewardIdx - self.idx
					for i = rewardCount, 1, -1 do
						local data = {
							class = 2,
							index = self.idx + i - 1
						}
						if i == rewardCount then
							data.error_code = error_code
						end
						showQuickRewarResult(false, data)
					end
				else
					alert("背包空间不足，礼包领取失败，整理背包后可从小秘书处重新领取，或重新登陆后领取。")
				end
				RefreshItem()
			else
				ShowErrorInfoDialog(error_code)
			end
		end
		local execGetReward = function()
			showWaitDialogNoCircle("打开礼包中...")
			NetMgr:registOpLuaFinishedCB(Net.OPT_RewardVitalitySimple, opGetRewaradFinishCB)
			NetMgr:registOpLuaFailedCB(Net.OPT_RewardVitalitySimple, opFailedCB)

			local cj = Value:new()
			cj:setByKey("role_id", ClientData.role_id)
			cj:setByKey("request_code",ClientData.request_code)
			cj:setByKey("idx",self.idx)
			NetMgr:executeOperate(Net.OPT_RewardVitalitySimple, cj)
		end
		execGetReward()
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
	end
}


showQuickRewarResult = function(single, data) 
	if single and QuickRewardResult ~= nil then
		QuickRewardResult:destroy()
		QuickRewardResult = nil
	end
	QuickRewardResult = new(QuickRewardResultPanel)
	QuickRewardResult:create(data)
	
end

--领取成功后的面板
QuickRewardResultPanel = {
	create = function(self, data)
		--背景
		self.bgLayer, self.uiLayer, self.centerWidget = createBGForReward(false, true)
		--标语
		local head = CCSprite:spriteWithFile("UI/get_reward/gift_head.png")
		head:setAnchorPoint(CCPoint(0.5, 1))
		head:setPosition(CCPoint(891 / 2, 640))
		self.centerWidget:addChild(head)
		--确定
		local get_btn = dbUIButtonScale:buttonWithImage("UI/public/btn_ok.png", 1.2, ccc3(125, 125, 125))
		get_btn:setAnchorPoint(CCPoint(0.5, 0.5))
		get_btn:setPosition(CCPoint(891 / 2, 55))
		get_btn.m_nScriptClickedHandler = function()
			self:destroy()
			if data.error_code == 2001 then
				if data.class == 1 then
					alert("背包空间不足，礼包领取失败，整理背包后重新登陆可再次领取。")
				elseif data.class == 2 then
					alert("背包空间不足，礼包领取失败，整理背包后可从小秘书处重新领取，或重新登陆后领取。")
				end
			end
			if data.finish then
				globalQuickGetVitalityReward()	--显示活跃度奖励
			end
		end
		self.centerWidget:addChild(get_btn)
		self:createContent(data)
	end,
	
	createContent = function(self, data)
		--内容
		if data.class == 1 then	--连续登录
			local function showRewardDetail(cfg)
				local item_data = login_item_cfg[cfg.index]
				local offsetX = 0
				if cfg.prefix then
					local prefix = CCLabelTTF:labelWithString(cfg.prefix, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 24)
					prefix:setAnchorPoint(CCPoint(0,0))
					prefix:setPosition(cfg.tipPosition)
					prefix:setColor(ccc3(255, 255, 153))
					self.centerWidget:addChild(prefix)
					offsetX = offsetX + prefix:getContentSize().width + 2
				end
				if cfg.content then
					local content = CCSprite:spriteWithFile(cfg.content)
					content:setAnchorPoint(CCPoint(0,0))
					content:setPosition(ccpAdd(cfg.tipPosition, CCPoint(offsetX-3, -3+3)))
					content:setColor(ccc3(255, 255, 153))
					self.centerWidget:addChild(content)
					offsetX = offsetX + content:getContentSize().width + 2
				end
				if cfg.suffix then
					local suffix = CCLabelTTF:labelWithString(cfg.suffix, CCSize(300, 0), 0, SYSFONT[EQUIPMENT], 24)
					suffix:setAnchorPoint(CCPoint(0,0))
					suffix:setPosition(ccpAdd(cfg.tipPosition, CCPoint(offsetX, 0)))
					suffix:setColor(ccc3(255, 255, 153))
					self.centerWidget:addChild(suffix)
				end
				local item_x = cfg.tipPosition.x + 20
				local item_y = cfg.tipPosition.y - 110
				local item_pos = {
						CCPoint(item_x, item_y),
						CCPoint(item_x + 200,	item_y),
						CCPoint(item_x + 200 * 2, item_y),
						CCPoint(item_x + 200 * 3, item_y),
				}
			--[[	else
					item_pos = {
						CCPoint(item_x, item_y),
						CCPoint(item_x + 215,	item_y),
						CCPoint(item_x + 215 + 215, item_y),
						CCPoint(item_x + 215 + 215 + 195, item_y),
					} 
				end]]
				for k, v in pairs(item_data.content) do
					local type_icon = nil
					local valueText = nil
					if v.type == 1 then
						type_icon = CCSprite:spriteWithFile("icon/copper.png")
						valueText = "银币*"..v.value
					elseif v.type == 2 then
						type_icon = CCSprite:spriteWithFile("UI/get_reward/zhangong.png")
						valueText = "战功*"..v.value
					elseif v.type == 3 then
						type_icon = CCSprite:spriteWithFile("icon/gold.png")
						valueText = "金币*"..v.value
					elseif v.type == 4 then
						type_icon = CCSprite:spriteWithFile("icon/Item/icon_item_"..v.icon..".png")
						valueText = v.name.."*"..v.value
					elseif v.type == 5 then
						type_icon = CCSprite:spriteWithFile("icon/Item/icon_item_10000048.png")
						valueText = "一级宝石袋*"..v.value
					elseif v.type == 6 then
						type_icon = CCSprite:spriteWithFile("icon/jin_yan_dan.png")
						valueText = "经验丹*"..v.value
					end
					type_icon:setAnchorPoint(CCPoint(0.5, 0.5))
					type_icon:setPosition(CCPoint(48, 48))
					local item_bg = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
					item_bg:setAnchorPoint(CCPoint(0, 0))
					item_bg:setPosition(item_pos[k])
					item_bg:addChild(type_icon)
					
					local value_label = CCLabelTTF:labelWithString(valueText, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 24)
					value_label:setAnchorPoint(CCPoint(0.5, 1))
					value_label:setPosition(CCPoint(item_pos[k].x + 48, item_pos[k].y - 5))
					value_label:setColor(ccc3(255,204,51))
					
					self.centerWidget:addChild(item_bg)
					self.centerWidget:addChild(value_label)
				end
			end
			
			showRewardDetail(
				{
					index = data.index,
					prefix = "恭喜你获得登录  ",
					content = "UI/numbers/yellow/"..((data.index > 1 and data.index < 7) and data.index or 1)..".png",
					suffix = data.index == 7 and "周礼包，内含:" or "天礼包，内含:",
					tipPosition = CCPoint(70, 440),
				}
			)
			if data.finish then		--最后一个对话框，显示下一天奖励
				showRewardDetail(
				{
					index = math.min(data.index + 1, #login_item_cfg),
					prefix = "明天登录可继续领取:",
					suffix = "",
					tipPosition = CCPoint(70, 260),
				}
			)
			end
		elseif data.class == 2 then --活跃度
			local item_data = hyd_item_cfg[data.index]
			local tip = CCLabelTTF:labelWithString("恭喜获得活跃度宝箱"..data.index.."奖励，内含:", CCSize(800, 0), 0, SYSFONT[EQUIPMENT], 24)
			tip:setAnchorPoint(CCPoint(0,0.5))
			tip:setPosition(CCPoint(80, 450))
			tip:setColor(ccc3(255, 255, 153))
			self.centerWidget:addChild(tip)
			
			--银币
			local item_bg = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			item_bg:setAnchorPoint(CCPoint(0, 0))
			item_bg:setPosition(CCPoint(140, 300))
			self.centerWidget:addChild(item_bg)
			local silver_icon = CCSprite:spriteWithFile("icon/copper.png")
			silver_icon:setAnchorPoint(CCPoint(0.5, 0.5))
			silver_icon:setPosition(CCPoint(48, 48))
			item_bg:addChild(silver_icon)
			local silver_label = CCLabelTTF:labelWithString(item_data.content1, CCSize(200, 0), 0, SYSFONT[EQUIPMENT], 24)
			silver_label:setAnchorPoint(CCPoint(0, 0.5))
			silver_label:setPosition(CCPoint(245, 350))
			silver_label:setColor(ccc3(255,204,51))
			self.centerWidget:addChild(silver_label)
			--普通经验包
			local item_bg = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
			item_bg:setAnchorPoint(CCPoint(0, 0))
			item_bg:setPosition(CCPoint(500, 300))
			self.centerWidget:addChild(item_bg)
			local exp_icon = CCSprite:spriteWithFile("icon/Item/icon_item_10000041.png")
			exp_icon:setAnchorPoint(CCPoint(0.5, 0.5))
			exp_icon:setPosition(CCPoint(48, 48))
			exp_icon:setScale(0.75)
			item_bg:addChild(exp_icon)
			local exp_label = CCLabelTTF:labelWithString(item_data.content2, CCSize(300, 0), 0, SYSFONT[EQUIPMENT], 24)
			exp_label:setAnchorPoint(CCPoint(0, 0.5))
			exp_label:setPosition(CCPoint(605, 350))
			exp_label:setColor(ccc3(255,204,51))
			self.centerWidget:addChild(exp_label)
		end
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
	end
}

--连续登录信息
--content类型，1银币、2战功、3金币、4宝石袋、5宠物蛋、6经验丹
login_item_x = {
	70, 230, 390, 520, 640, 750
}
login_item_cfg = {
	{
		title = "连续登录一天",
		content = 
		{
			{
				type = 1,
				value = 10000,
			},
			{
				type = 6,
				value = 4,
			},
			{
				type = 3,
				value = 10,
			},
		},
		centerY = 100 + 65 * 13 / 2, 
	},
	{
		title = "连续登录两天",
		content = 
		{
			{
				type = 1,
				value = 100000,
			},
			{
				type = 6,
				value = 10,
			},
			{
				type = 3,
				value = 20,
			},
			{
				type = 4,
				value = 1,
				icon = 10000005,
				name = "一级宝石袋",
			},
		},
		centerY = 100 + 65 * 11 / 2,
	},
	{
		title = "连续登录三天",
		content = 
		{
			{
				type = 1,
				value = 40000,
			},
			{
				type = 6,
				value = 6,
			},
			{
				type = 3,
				value = 15,
			},
		},
		centerY = 100 + 65 * 9 / 2,
	},
	{
		title = "连续登录四天",
		content = 
		{
			{
				type = 1,
				value = 70000,
			},
			{
				type = 6,
				value = 8,
			},
			{
				type = 3,
				value = 15,
			},
		},
		centerY = 100 + 65 * 7 / 2,
	},
	{
		title = "连续登录五天",
		content = 
		{
			{
				type = 1,
				value = 100000,
			},
			{
				type = 6,
				value = 10,
			},
			{
				type = 3,
				value = 20,
			},
			{
				type = 4,
				value = 1,
				icon = 10000005,
				name = "一级宝石袋",
			},
		},
		centerY = 100 + 65 * 5 / 2,
	},
	{
		title = "连续登录六天",
		content =
		{
			{
				type = 1,
				value = 150000,
			},
			{
				type = 6,
				value = 10,
			},
			{
				type = 3,
				value = 20,
			},
			{
				type = 4,
				value = 1,
				icon = 10000005,
				name = "一级宝石袋",
			},
		}, 
		centerY = 100 + 65 * 3 / 2,
	},
	{
		title = "连续登录一周",
		content = 
		{
			{
				type = 1,
				value = 500000,
			},
			{
				type = 6,
				value = 15,
			},
			{
				type = 3,
				value = 30,
			},
			{
				type = 4,
				value = 1,
				icon = 10000005,
				name = "一级宝石袋",
			},
		}, 
		centerY = 100 + 65 / 2,
	},
}

--活跃度信息
hyd_item_cfg = {
	{
		title = "活跃度5",
		content1 = "银币*5000",		--使用\n换行显示，UI排版有问题，故分开
		content2 = "普通经验包*1 ",
		position = CCPoint(85, 180),
	},
	{
		title = "活跃度30",
		content1 = "银币*1万",
		content2 = "普通经验包*2",
		position = CCPoint(85 + 149 + 41, 180),
	},
	{
		title = "活跃度60",
		content1 = "银币*2万",
		content2 = "普通经验包*4",
		position = CCPoint(85 + 149 * 2 + 41 * 2, 180),
	},
	{
		title = "活跃度100",
		content1 = "银币*5万",
		content2 = "普通经验包*6",
		position = CCPoint(85 + 149 * 3 + 41 * 3, 180),
	},

}
globalShowRuinsPanel = function()
	GlobalRuinsPanel = new(RuinsPanel):create()
	GotoNextStepGuide()
end

local caltScaleMin = function(designSize)
	local scaleX = WINSIZE.width/designSize.width
	local scaleY = WINSIZE.height/designSize.height
	local scale = scaleX > scaleY and scaleY or scaleX
	return scale
end

local createToggleBtns = function(btnCfg)
	local btns = {}
	for i = 1, #btnCfg do
		local btn = dbUIButtonToggle:buttonWithImage(btnCfg[i].normal,btnCfg[i].toggle)
		btn:setAnchorPoint(CCPoint(0, 0))
		btn:setPosition(btnCfg[i].position)
		btns[i] = btn
	end
	return btns
end

local getIndexByCfgItemId = function(items, cfg_item_id)
	for i = 1, #items do
		if cfg_item_id == items[i].cfg_item_id then
			return i
		end
	end
	return -1
end

local getItemsByItemIds = function(itemsInfo, isPet)
	local items = {}
	local itemJsonConfig = GlobalCfgMgr:getCfgJsonRoot(isPet and "cfg/cfg_general.json" or "cfg/cfg_item.json")
	for i = 1, #itemsInfo do
		local item = itemJsonConfig:getByKey(itemsInfo[i].cfg_item_id)
		items[i] = {
			hole1 = 0,
			hole2 = 0,
			hole3 = 0,
			hole4 = 0,
			hole5 = 0,
			hole6 = 0,
		}
		if isPet then
			items[i].name = item:getByKey("name"):asString()
			items[i].quality = item:getByKey("quality"):asInt()
			items[i].desc = item:getByKey("desc"):asString()
			items[i].luck = item:getByKey("luck"):asInt()
			items[i].strength = item:getByKey("strength"):asInt()
			items[i].intellect = item:getByKey("intellect"):asInt()
			items[i].stamina = item:getByKey("stamina"):asInt()
			items[i].agility = item:getByKey("agility"):asInt()
			items[i].str_grow = item:getByKey("str_grow"):asDouble()*100
			items[i].int_grow = item:getByKey("int_grow"):asDouble()*100
			items[i].sta_grow = item:getByKey("sta_grow"):asDouble()*100
			items[i].agi_grow = item:getByKey("agi_grow"):asDouble()*100
			items[i].cfg_skill_id = item:getByKey("cfg_skill_id"):asInt()
		else
			items[i].cfg_item_id = itemsInfo[i].cfg_item_id
			
			items[i].hole = new({})
		
			for k = 1 , 6 do 
				items[i].hole[k] = {
					id = items[i]["hole"..k],
					type = item:getByKey("hole_catrgory_"..k):asInt()
				}
			end
			
			items[i].name = item:getByKey("name"):asString()
			items[i].part = item:getByKey("part"):asInt()
			items[i].type = item:getByKey("type"):asInt()
			items[i].quality = item:getByKey("quality"):asInt()
			items[i].require_level = item:getByKey("require_level"):asInt()
			items[i].info = item:getByKey("desc"):asString()
			items[i].star = 0
			items[i].isEquip = false
			items[i].effect_type = item:getByKey("effect_type"):asInt()
			items[i].effect_value = item:getByKey("effect_value"):asInt()
			items[i].max_count = item:getByKey("max_count"):asInt()
			items[i].icon = item:getByKey("icon"):asInt()
			items[i].forge_price = item:getByKey("forge_price"):asInt()
			items[i].ability = item:getByKey("ability"):asInt()
			items[i].ability_grow = item:getByKey("ability_grow"):asInt()
			items[i].ability_type = item:getByKey("ability_type"):asInt()
			items[i].ability_2 = item:getByKey("ability_2"):asInt()
			items[i].ability_grow_2 = item:getByKey("ability_grow_2"):asInt()
			items[i].ability_type_2 = item:getByKey("ability_type_2"):asInt()		
			items[i].sell_price = item:getByKey("sell_price"):asInt()	
		end
	end
	
	return items
end

local designSize = CCSize(1280, 720)
local panelScale = caltScaleMin(designSize)

RuinsPanel = {
	coolDown = 3599, 	--寻宝冷却时间,默认最大时间
	items =	{},			--用来保存12个item详细信息
	itemBtns = nil,		--用来保存转盘上的12个BTN
	acquires = {},		--用来保存寻宝获得的item信息
	
	item_type = 1,				--物品库类型：1.装备库，2.消耗库
	search_type = 1,			--寻宝类型：1.战功寻宝，2.银币寻宝，3.金币寻宝
	search_times = 0,			--寻宝次数: 0.其他，1.寻宝，10.寻宝10次
	refresh	= false,			--是否需要更新，为true为强制更新，需要耗费财力
	last_message_index = 0,		--最近更新的消息index
	
	create = function(self)
		local scene = DIRECTOR:getRunningScene()
		
		self.bgLayer = createSystemPanelBg()
		self.uiLayer = dbUIMask:node()
		self.centerWidget = dbUIPanel:panelWithSize(CCSize(1082, 720))
		self.centerWidget:setAnchorPoint(CCPoint(0.5, 0.5))
		self.centerWidget:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
		self.centerWidget:setScale(panelScale)
		self.uiLayer:addChild(self.centerWidget, 1000)
		
		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)
		
		--大背景
		local bg = CCSprite:spriteWithFile("UI/ruins/bg.jpg")
		bg:setAnchorPoint(CCPoint(0.5, 0.5))
		bg:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
		bg:setScaleX(WINSIZE.width / bg:getContentSize().width)
		bg:setScaleY(WINSIZE.height / bg:getContentSize().height)
		self.uiLayer:addChild(bg)
		--关闭
		local close_btn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png", 1.2, ccc3(125, 125, 125))
		close_btn:setAnchorPoint(CCPoint(0.5, 0.5))
		close_btn:setPosition(CCPoint(WINSIZE.width - 50 * panelScale, WINSIZE.height - 50 * panelScale))
		close_btn:setScale(panelScale)
		close_btn.m_nScriptClickedHandler = function()
			GotoNextStepGuide()
			self:destroy()
		end
		self.uiLayer:addChild(close_btn,10000)
		self.closeBtn = close_btn
		
		--中心区域
		local center_bg = CCSprite:spriteWithFile("UI/ruins/center_bg.png")
		center_bg:setAnchorPoint(CCPoint(0, 0))
		center_bg:setPosition(CCPoint(0, 0))
		self.centerWidget:addChild(center_bg)
		--转盘转动时的focus
		self.focus = CCSprite:spriteWithFile("UI/ruins/focus.png")
		self.focus:setAnchorPoint(CCPoint(0, 1))
		self.focus:setPosition(RuinsWheelPosition[1])
		self.focus:setIsVisible(false)
		self.centerWidget:addChild(self.focus, 100)
		--寻宝按钮
		local xunbao_btn = dbUIButtonScale:buttonWithImage("UI/ruins/xun_bao.png", 1, ccc3(125, 125, 125))
		xunbao_btn:setAnchorPoint(CCPoint(0.5, 0.5))
		xunbao_btn:setPosition(CCPoint(702, 318))
		xunbao_btn.m_nScriptClickedHandler = function()
			if GloblePlayerData.gold < 50 then		--如果寻宝必然返回异常，先做一次判断
				alert("金币不足")	
				GlobleXunBaoFinished = true
				GotoNextStepGuide()
				return
			end
			if self.tenTimesToggle:isToggled() then
				self.search_times = 10
			else
				self.search_times = 1
			end
			if #self.items > 0 then
				self:requestSearch()
			else
				alert("数据错误")
			end
		end
		self.centerWidget:addChild(xunbao_btn,200)
		self.xunbao_btn = xunbao_btn
		
		--[[右上方按钮
		self.rightToggles = createToggleBtns(RuinsRightBtnCfg)
		public_toggleRadioBtn(self.rightToggles,self.rightToggles[1])
		for i = 1, #self.rightToggles do
			local btn = self.rightToggles[i]
			self.centerWidget:addChild(btn)
			btn.m_nScriptClickedHandler = function()
				if (btn:isToggled()) then
					self.item_type = i
					self:requestUpdate()
				end
				public_toggleRadioBtn(self.rightToggles,btn)
			end
		end
		--左侧按钮
		local cost_cfg = {
			"消耗1000战功",
			"消耗1000银币",
			"消耗50金币",
		}
		self.leftToggles = createToggleBtns(RuinsLeftBtnCfg)
		public_toggleRadioBtn(self.leftToggles,self.leftToggles[1])
		for i = 1, #self.leftToggles do
			local btn = self.leftToggles[i]
			self.centerWidget:addChild(btn)
			btn.m_nScriptClickedHandler = function()
				if (btn:isToggled()) then
					self.search_type = i
				end
				public_toggleRadioBtn(self.leftToggles,btn)
			end
			local cost_label = CCLabelTTF:labelWithString(cost_cfg[i], CCSize(152, 20), CCTextAlignmentCenter, SYSFONT[EQUIPMENT], 20)
			cost_label:setColor(ccc3(255, 204, 51))
			cost_label:setAnchorPoint(CCPoint(0, 1))
			cost_label:setPosition(CCPoint(btn:getPositionX(), btn:getPositionY()))
			self.centerWidget:addChild(cost_label)
		end ]]
		--每次寻宝提示
		local cost_tip = CCLabelTTF:labelWithString("每次寻宝消耗50金币", CCSize(400, 0), 0, SYSFONT[EQUIPMENT], 24)
		cost_tip:setColor(ccc3(255, 204, 51))
		cost_tip:setAnchorPoint(CCPoint(0, 0))
		cost_tip:setPosition(CCPoint(360, 30))
		self.centerWidget:addChild(cost_tip)
		--左上角消息面板
		self.msgPanel = new(RuinsMessagePanel)
		self.msgPanel:create()
		self.centerWidget:addChild(self.msgPanel.bg)
		
		self:createOwnInfo()
		self:createTenTimes()
		self:createRefresh()
		--进入遗址，请求数据
		self:requestUpdate()
		
		return self
	end,
	
	--右下角玩家拥有数额
	createOwnInfo = function(self)
		local panel = dbUIPanel:panelWithSize(CCSize(153, 182))
		panel:setAnchorPoint(CCPoint(1.0, 0))
		panel:setPosition(CCPoint(WINSIZE.width - 0 * panelScale, 0 * panelScale))
		panel:setScale(panelScale)
		local gray_bg = CCSprite:spriteWithFile("UI/ruins/gray_bg.png")
		gray_bg:setAnchorPoint(CCPoint(0, 0))
		gray_bg:setPosition(CCPoint(0, 0))
		panel:addChild(gray_bg)
		
		--金币
		local gold_label = CCLabelTTF:labelWithString("金币：", CCSize(100, 0), 0, SYSFONT[EQUIPMENT], 20)
		gold_label:setColor(ccc3(255, 203, 102))
		gold_label:setAnchorPoint(CCPoint(0, 0))
		gold_label:setPosition(CCPoint(15, 150))
		panel:addChild(gold_label)
		self.gold_value = CCLabelTTF:labelWithString(getShotNumber(GloblePlayerData.gold), CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 20)
		self.gold_value:setColor(ccc3(255, 102, 0))
		self.gold_value:setAnchorPoint(CCPoint(0, 0))
		self.gold_value:setPosition(CCPoint(73, 150))
		panel:addChild(self.gold_value)
		--银币
		local silver_label = CCLabelTTF:labelWithString("银币：", CCSize(100, 0), 0, SYSFONT[EQUIPMENT], 20)
		silver_label:setColor(ccc3(255, 203, 102))
		silver_label:setAnchorPoint(CCPoint(0, 0))
		silver_label:setPosition(CCPoint(15, 120))
		panel:addChild(silver_label)
		self.silver_value = CCLabelTTF:labelWithString(getShotNumber(GloblePlayerData.copper), CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 20)
		self.silver_value:setColor(ccc3(255, 102, 0))
		self.silver_value:setAnchorPoint(CCPoint(0, 0))
		self.silver_value:setPosition(CCPoint(73, 120))
		panel:addChild(self.silver_value)
		--战功
		local exploit_label = CCLabelTTF:labelWithString("战功：", CCSize(100, 0), 0, SYSFONT[EQUIPMENT], 20)
		exploit_label:setColor(ccc3(255, 203, 102))
		exploit_label:setAnchorPoint(CCPoint(0, 0))
		exploit_label:setPosition(CCPoint(15, 90))
		panel:addChild(exploit_label)
		self.exploit_value = CCLabelTTF:labelWithString(getShotNumber(GloblePlayerData.exploit), CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 20)
		self.exploit_value:setColor(ccc3(255, 102, 0))
		self.exploit_value:setAnchorPoint(CCPoint(0, 0))
		self.exploit_value:setPosition(CCPoint(73, 90))
		panel:addChild(self.exploit_value)
		
		self.uiLayer:addChild(panel, 1000)
	end,
	--寻宝10次
	createTenTimes = function(self)
		self.tenTimesToggle = dbUIButtonToggle:buttonWithImage("UI/ruins/unselected.png", "UI/ruins/selected.png")
		self.tenTimesToggle:setAnchorPoint(CCPoint(0, 0))
		self.tenTimesToggle:setPosition(CCPoint(645, 185))							
		local tenLabel = CCLabelTTF:labelWithString("寻宝10次", CCSize(150, 0), 0, SYSFONT[EQUIPMENT], 22)
		tenLabel:setColor(ccc3(255, 204, 51))
		tenLabel:setAnchorPoint(CCPoint(0, 0.5))
		tenLabel:setPosition(CCPoint(680, 185 + self.tenTimesToggle:getContentSize().height / 2))
		self.centerWidget:addChild(self.tenTimesToggle)
		self.centerWidget:addChild(tenLabel)
	end,
	--冷却时间
	createRefresh = function(self)
	--[[	self.refreshBtn = dbUIButtonScale:buttonWithImage("UI/ruins/refresh.png", 1.0, ccc3(125, 125, 125))
		self.refreshBtn:setAnchorPoint(CCPoint(0, 0))
		self.refreshBtn:setPosition(CCPoint(380, 545))
		self.refreshBtn.m_nScriptClickedHandler = function()
			local dtp = new(DialogTipPanel)
			dtp:create("是否花20金币刷新物品",ccc3(255,204,153),180)
			dtp.okBtn.m_nScriptClickedHandler = function()
				self:requestRefresh()
				dtp:destroy()
			end
		end
		self.centerWidget:addChild(self.refreshBtn)
			
		self.coolDownLabel = CCLabelTTF:labelWithString("倒计时:", CCSize(100, 0), 0, SYSFONT[EQUIPMENT], 18)
		self.coolDownLabel:setColor(ccc3(255, 203, 102))
		self.coolDownLabel:setAnchorPoint(CCPoint(0, 1))
		self.coolDownLabel:setPosition(CCPoint(380, 540))
		self.centerWidget:addChild(self.coolDownLabel)
			
		self.coolDownValue = CCLabelTTF:labelWithString(os.date("%M:%S", self.coolDown), CCSize(200, 0), 0, SYSFONT[EQUIPMENT], 18)
		self.coolDownValue:setColor(ccc3(255, 102, 0))
		self.coolDownValue:setAnchorPoint(CCPoint(0, 1))
		self.coolDownValue:setPosition(CCPoint(380 + 65, 540))
		self.centerWidget:addChild(self.coolDownValue)
		]]
		--self:updateRefresh()
	end,
	
	--刷新倒计时
	updateRefresh = function(self)
	--[[	if self.coolDownHandler == nil then
			--定时器更新倒计时时间
			local updateCoolDownValue = function()
				if self.coolDown > 0 then
					self.coolDown = self.coolDown - 1
				else
					if self.searchHandler == nil then	--寻宝过程中，不会请求更新物品
						CCScheduler:sharedScheduler():unscheduleScriptEntry(self.coolDownHandler)
						self.coolDownHandler = nil
						self:requestUpdate()
					end
				end
				self.coolDownValue:setString(os.date("%M:%S", self.coolDown))
			end
			self.coolDownHandler = CCScheduler:sharedScheduler():scheduleScriptFunc(updateCoolDownValue,1,false)
		end  ]]
	end,
	
	createItems = function(self, itemsInfo)
		self.items = getItemsByItemIds(itemsInfo, false)
		for i = 1, #self.items do
			local item_btn = dbUIButtonScale:buttonWithImage("icon/Item/icon_item_"..self.items[i].icon..".png", 1, ccc3(125, 125, 125))
			item_btn:setScale(90 / item_btn:getContentSize().width)
			item_btn:setAnchorPoint(CCPoint(0.5, 0.5))
			item_btn:setPosition(ccpAdd(RuinsWheelPosition[i], CCPoint(48, -48)))
			item_btn.m_nScriptClickedHandler = function()
				local cfg = {
					item = self.items[i],
					mine = true,
					from = "view",
				}
				ItemClickHandler(cfg)
			end

			--不同物品不同颜色的框
			local kuang = CCSprite:spriteWithFile(ITEM_QUALITY[self.items[i].quality])
			kuang:setAnchorPoint(CCPoint(0, 1))
			kuang:setPosition(RuinsWheelPosition[i])
			if self.centerWidget:getChildByTag(100+i) ~= nil then
				self.centerWidget:removeChildByTag(100+i, true)
			end
			self.centerWidget:addChild(kuang, 10, 100+i)
			--物品数量
			local amountLabel = CCLabelTTF:labelWithString(itemsInfo[i].amount, SYSFONT[EQUIPMENT], 24)
			amountLabel:setAnchorPoint(CCPoint(1, 0))
			amountLabel:setPosition(CCPoint(90, 6))
			kuang:addChild(amountLabel)

			--将之前的Btn清除
			if self.itemBtns == nil then
				self.itemBtns = new({})
			end
			if self.itemBtns[i] ~= nil then
				self.itemBtns[i]:removeFromParentAndCleanup(true)
			end
			self.centerWidget:addChild(item_btn, 2)
			self.itemBtns[i] = item_btn
		end
	end,
	--更新金币，银币，战功
	updateOwnInfo = function(self, s)
		GloblePlayerData.gold = s:getByKey("gold"):asInt()
		GloblePlayerData.silver = s:getByKey("copper"):asInt()
		GloblePlayerData.exploit = s:getByKey("exploit"):asInt()
		updataHUDData()
		
		self.gold_value:setString(getShotNumber(GloblePlayerData.gold))
		self.silver_value:setString(getShotNumber(GloblePlayerData.silver))
		self.exploit_value:setString(getShotNumber(GloblePlayerData.exploit))
	end,
	--开始转盘
	search = function(self)
		self.focus:setIsVisible(true)
		self.focus:setOpacity(255)
		--self.focus:stopAllActions()
		self.centerWidget:setIsEnabled(false)
		self.msgPanel:toggle(2)
		
		local itemIndex = 1		--当前物品在acquires中的位置
		local searchIndex = nil
		local isSteady = true
		
		local wheelIndex = 1
		local scrollSpeed = 0.01
		local scrollCircle = 0
		local scrollOffset = math.random(6, 12)	--物品再转多少次后出现
		
		local scrollWheel
		scrollWheel = function()
			local continue = true
			wheelIndex = wheelIndex + 1
			if wheelIndex > #RuinsWheelPosition then
				wheelIndex = 1;
				if self.acquireSuccess then
					scrollCircle = scrollCircle + 1
				end
			end
			self.focus:setPosition(RuinsWheelPosition[wheelIndex])
			
			if self.acquireSuccess then		--成功接收到服务器数据，正式开始转盘
				if #self.acquires == 1 then
					isSteady = false
					if not searchIndex then
						searchIndex = getIndexByCfgItemId(self.items, self.acquires[1].cfg_item_id)
						if searchIndex == -1 then	--物品找不到
							alert("数据错误")
							continue = false
						else 
							scrollOffset = searchIndex
						end
					end
					if scrollCircle > 2 then	--2圈之后开始判断位置停止
						scrollOffset = scrollOffset - 1
					end
					if scrollOffset <= 0 then		--已经到达目的地
						continue = false
						self:showGetItems(itemIndex)
					end
					scrollSpeed = scrollSpeed + 0.01 * scrollCircle / 2
				else
					scrollOffset = scrollOffset - 1
					if scrollOffset <= 0 then
						self:showGetItems(itemIndex)
						itemIndex = itemIndex + 1
						scrollOffset = math.random(36, 40)
						if itemIndex > #self.acquires then
							continue = false
						elseif itemIndex == #self.acquires then
							--最后一个，计算正确的停止位置
							searchIndex = getIndexByCfgItemId(self.items, self.acquires[itemIndex].cfg_item_id)
							scrollOffset = 24 + (12 - wheelIndex) + (searchIndex == -1 and 0 or searchIndex)
						end
					end
				end
			end
			
			if continue == false then
				GlobleXunBaoFinished = true
				GotoNextStepGuide()
			end
			
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.searchHandler)
			self.searchHandler = nil
			if continue and (not self.acquireFailed) then
				self.searchHandler = CCScheduler:sharedScheduler():scheduleScriptFunc(scrollWheel,scrollSpeed,false)
			else
				--self.focus:stopAllActions()
				--self.focus:runAction(CCFadeOut:actionWithDuration(2));
				
				self.centerWidget:setIsEnabled(true)
				self.acquireSuccess = nil
				self.acquireFailed = nil
				if self.acquireErrorCode then
					if self.acquireErrorCode == 2001 then
						alert("背包空间不足，无法继续寻宝。")
					else
						new(SimpleTipPanel):create(ERROR_CODE_DESC[self.acquireErrorCode],ccc3(255,0,0),0)
					end
					GlobleXunBaoFinished = true
					GotoNextStepGuide()
				end
			end
		end

		if not self.searchHandler then
			self.searchHandler = CCScheduler:sharedScheduler():scheduleScriptFunc(scrollWheel,scrollSpeed,false)
		end
	end,
	--显示转盘获得的物品
	showGetItems = function(self, index)
		local cfg_item_id = self.acquires[index].cfg_item_id
		local item_id = self.acquires[index].item_id
		local index = getIndexByCfgItemId(self.items, cfg_item_id)
		--获取物品数量
		local amount = 0
		for i = 1, #self.itemsInfo do
			if self.itemsInfo[i].cfg_item_id == cfg_item_id then
				amount = self.itemsInfo[i].amount
				break
			end
		end
		--将物品放入背包
		battleGetItems({cfg_item_id, item_id, amount,}, true)
		--左侧面板消息更新
		self.msgPanel:refreshContent(false)
		--物品弹出动画
		local tipLayer = dbUIMask:node()
		local tiplabel = CCLabelTTF:labelWithString((index == -1 and "找不到物品" or self.items[index].name.."*"..amount),SYSFONT[EQUIPMENT],32)
		tiplabel:setPosition(CCPoint(702, self.centerWidget:getContentSize().height / 2))
		tiplabel:setColor(ITEM_COLOR[self.items[index].quality])
		self.centerWidget:addChild(tipLayer, 1000)
		tipLayer:addChild(tiplabel)
		local action = CCMoveBy:actionWithDuration(2, CCPoint(0, self.centerWidget:getContentSize().height / 2))
		tiplabel:runAction(action)
		local function rvlabel()
			local x,y = tiplabel:getPosition()
			if	y >= self.centerWidget:getContentSize().height then
				tipLayer:removeFromParentAndCleanup(true)
				CCScheduler:sharedScheduler():unscheduleScriptEntry(self.tick_rv[1])
				table.remove(self.tick_rv, 1)
			end
		end
		if  not self.tick_rv then
			self.tick_rv = new({})
		end
		local tick  = CCScheduler:sharedScheduler():scheduleScriptFunc(rvlabel, 0.1, false)
		table.insert(self.tick_rv, tick)
	end,
	
	--更新ITEM网络请求
	requestUpdate = function(self)
		local function opUpdateFinishCB(s)
			if self.centerWidget then
				self.centerWidget:setIsEnabled(true)
			end
			--回调处理
			local error_code = s:getByKey("error_code"):asInt()
			if error_code == -1 then
				self.coolDown = s:getByKey("cd_time"):asInt()
				local item_list = s:getByKey("item_list")
				self.itemsInfo = {}
				for i = 1, item_list:size() do
					local item = item_list:getByIndex(i-1)
					self.itemsInfo[i] = {}
					self.itemsInfo[i].cfg_item_id  = item:getByKey("cfg_item_id"):asInt()
					self.itemsInfo[i].amount  = item:getByKey("amount"):asInt()
				end		

				--更新消息
				if self.centerWidget then
					self:createItems(self.itemsInfo)
					self:updateRefresh()
					self.last_message_index = s:getByKey("last_message_index"):asInt()
					self.msgPanel:updateMessage(s:getByKey("message_list"))
					self.msgPanel:refreshContent(true)	
				end
			else
				ShowErrorInfoDialog(error_code)
			end
		end
		local function opUpdateFailedCB(s)
			if self.centerWidget then
				self.centerWidget:setIsEnabled(true)
			end
			local error_code = s:getByKey("error_code"):asInt()
			ShowErrorInfoDialog(error_code)
		end
		
		NetMgr:registOpLuaFinishedCB(Net.OPT_RuinsUpdate, opUpdateFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_RuinsUpdate, opUpdateFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code",ClientData.request_code)
		
		cj:setByKey("item_type", self.item_type)
		cj:setByKey("last_message_index", self.last_message_index)
		
		self.centerWidget:setIsEnabled(false)
		NetMgr:setOpUnique(Net.OPT_RuinsUpdate)
		NetMgr:executeOperate(Net.OPT_RuinsUpdate, cj)
	end,
	--强制刷新网络请求
	requestRefresh = function(self)
		local opRefreshFinishCB = function(s)
			if self.centerWidget then
				self.centerWidget:setIsEnabled(true)
			end
			--回调做处理
			local error_code = s:getByKey("error_code"):asInt()
			if error_code == -1 then
				if self.centerWidget then
					self.coolDown = s:getByKey("cd_time"):asInt()
					local item_list = s:getByKey("item_list")
					self.itemsInfo = {}
					for i = 1, item_list:size() do
						local item = item_list:getByIndex(i-1)
						self.itemsInfo[i] = {}
						self.itemsInfo[i].cfg_item_id  = item:getByKey("cfg_item_id"):asInt()
						self.itemsInfo[i].amount  = item:getByKey("amount"):asInt()
					end			
					self:createItems(self.itemsInfo)
					--更新金币，银币，战功
					self:updateOwnInfo(s)
					--更新消息
					self.msgPanel:updateMessage(s:getByKey("message_list"))
					self.last_message_index = s:getByKey("last_message_index"):asInt()
					self.msgPanel:refreshContent(true)
				end
			else
				ShowErrorInfoDialog(error_code)
			end
		end
		local opRefreshFailedCB = function(s)
			if self.centerWidget then
				self.centerWidget:setIsEnabled(true)
			end
		end
		NetMgr:registOpLuaFinishedCB(Net.OPT_RuinsRefresh, opRefreshFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_RuinsRefresh, opRefreshFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code",ClientData.request_code)
		
		cj:setByKey("item_type", self.item_type)
		cj:setByKey("last_message_index", self.last_message_index)
		
		self.centerWidget:setIsEnabled(false)
		NetMgr:setOpUnique(Net.OPT_RuinsRefresh)
		NetMgr:executeOperate(Net.OPT_RuinsRefresh, cj)
	end,
	--寻宝网络请求
	requestSearch = function(self)
		local opSearchFinishCB = function(s)
			--回调做处理
			local error_code = s:getByKey("error_code"):asInt()
			local acquire_list = s:getByKey("acquire_list")
			--返回失败并且没有进行转盘
			if error_code ~= -1 and acquire_list:isNull() then
				ShowErrorInfoDialog(error_code)
				self.acquireFailed = true
				GlobleXunBaoFinished = true
				GotoNextStepGuide()
				return
			end
			
			if acquire_list:size() > 0 then
				self.acquires = new({})
				for i = 1, acquire_list:size() do
					local item = {}
					item.item_id = acquire_list:getByIndex(i-1):getByKey("item_id"):asInt()
					item.cfg_item_id = acquire_list:getByIndex(i-1):getByKey("cfg_item_id"):asInt()
					self.acquires[i] = item
				end
				self.acquireSuccess = true
			end
			
			if self.centerWidget then
				self.msgPanel:updateMessage(s:getByKey("message_list"))
				self.last_message_index = s:getByKey("last_message_index"):asInt()
				--更新金币，银币，战功
				self:updateOwnInfo(s)
			end
			
			--寻宝操作没有正确完成,保存终止类型
			if error_code ~= -1 then
				self.acquireErrorCode = error_code
			end
		end
		local opSearchFailedCB = function(s)
			self.acquireFailed = true
		end
	
		NetMgr:registOpLuaFinishedCB(Net.OPT_RuinsSearch, opSearchFinishCB)
		NetMgr:registOpLuaFailedCB(Net.OPT_RuinsSearch, opSearchFailedCB)

		local cj = Value:new()
		cj:setByKey("role_id", ClientData.role_id)
		cj:setByKey("request_code",ClientData.request_code)
		
		--cj:setByKey("item_type", self.item_type)
		--cj:setByKey("search_type", self.search_type)
		cj:setByKey("item_type", 1)		--默认装备库
		cj:setByKey("search_type", 3)	--消耗金币
		cj:setByKey("search_times", self.search_times)
		cj:setByKey("last_message_index", self.last_message_index)
		
		self:search()	--开始模拟寻宝，匀速转动，服务器成功返回后开始计算宝物位置
		NetMgr:executeOperate(Net.OPT_RuinsSearch, cj)
	end,
	
	destroy = function(self)
		if self.searchHandler ~= nil then
			new(SimpleTipPanel):create("正在寻宝中，请勿退出",ccc3(255,0,0),0)
			return	
		end
	
		local scene = DIRECTOR:getRunningScene()
		if self.coolDownHandler ~= nil then
			CCScheduler:sharedScheduler():unscheduleScriptEntry(self.coolDownHandler)
			self.coolDownHandler = nil
		end
		
		if self.tick_rv then
			for i = 1, #self.tick_rv do
				if self.tick_rv[i] then
					CCScheduler:sharedScheduler():unscheduleScriptEntry(self.tick_rv[i])
					self.tick_rv[i] = nil
				end
			end
			self.tick_rv = nil
		end
		
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		self.msgPanel:destroy()
		self.message = nil
		self.step_message = nil
		
		self.itemBtns = nil
		self.items = {}
		
		GlobalRuinsPanel = nil
	end
}

RuinsMessagePanel = {
	bg = nil,
	contentArea = nil,
	label = {},			--世界，个人
	index = 1,			--当前停留在那个界面上
	message = nil,	--用来保存消息:1.世界消息，2.个人消息
	
	step_message = nil,	--用来保存自己抽取物品的消息，逐步加入到message中
	
	create = function(self)
		self.bg = dbUIPanel:panelWithSize(CCSize(230, 550))			--230， 275
		self.bg:setAnchorPoint(CCPoint(0, 0))
		self.bg:setPosition(CCPoint(110, 75))										--110， 350
		local btncfg = {
			{
				normal = "UI/ruins/half_bg.png",
				toggle = "UI/ruins/nothing.png",
				position = CCPoint(0, 495),											--0，220
			},
			{
				normal = "UI/ruins/half_bg.png",
				toggle = "UI/ruins/nothing.png",
				position = CCPoint(125, 495),									--125， 220
			}
		}
		self.msgToggles = createToggleBtns(btncfg)
		public_toggleRadioBtn(self.msgToggles,self.msgToggles[1])
		for i = 1, #self.msgToggles do
			local btn = self.msgToggles[i]
			self.bg:addChild(btn)
			btn.m_nScriptClickedHandler = function()
				if (btn:isToggled()) then
					self.index = i
					self.label[i]:setColor(ccc3(255, 204, 51))
					self.label[i == 1 and 2 or 1]:setColor(ccc3(165, 147, 123))
					self:refreshContent(true)
				end
				public_toggleRadioBtn(self.msgToggles,btn)
			end
		end	
		--世界标签
		local world_label = CCLabelTTF:labelWithString("世界", CCSize(121, 56), CCTextAlignmentCenter, SYSFONT[EQUIPMENT], 24)
		world_label:setColor(ccc3(255, 204, 51))
		world_label:setAnchorPoint(CCPoint(0, 0))
		world_label:setPosition(btncfg[1].position)
		self.label[1] = world_label
		self.bg:addChild(world_label)
		--个人标签
		local private_label = CCLabelTTF:labelWithString("个人", CCSize(121, 56), CCTextAlignmentCenter, SYSFONT[EQUIPMENT], 24)
		private_label:setColor(ccc3(165, 147, 123))
		private_label:setAnchorPoint(CCPoint(0, 0))
		private_label:setPosition(btncfg[2].position)
		self.label[2] = private_label
		self.bg:addChild(private_label)
		
		self.contentArea = dbUIList:list(CCRectMake(10, 0, 210, 485),0);		--210， 210
		self.bg:addChild(self.contentArea)
		
		self.message = new({})
		self.message[1] = new({})
		self.message[2] = new({})
		self.step_message = new({})	
		
	end,
	
	--切换toggle
	toggle = function(self, index)
		if self.msgToggles[index]:isToggled() == false then
			public_toggleRadioBtn(self.msgToggles,self.msgToggles[index])
			self.index = index
			self:refreshContent(true)
		end
	end,
	
	--更新存储的消息
	updateMessage = function(self, msg_list)
		local size = msg_list:size()
		for i = 1, size do
			local msg = msg_list:getByIndex(i-1)
			local type = msg:getByKey("type"):asInt()
			local _msg = {}
			_msg.name = msg:getByKey("name"):asString()
			_msg.item_name = msg:getByKey("item_name"):asString()
			if type == 2 then	--先加入到逐步显示的消息中
				table.insert(self.step_message, _msg)
			else
				table.insert(self.message[type], _msg)
			end
		end
		--世界消息最多15条
		if #self.message[1] > 15 then
			local offset = #self.message[1] - 15
			for i = 1, #self.message[1] do
				if i <= 15 then
					self.message[1][i] = self.message[1][i+offset]
				else
					self.message[1][i] = nil
				end
			end
		end
	end,
	
	refreshContent = function(self, show_all)
		self.contentArea:removeAllWidget(true)
		local content = self.message[self.index]
		--刷新时判断，如果step_message中有内容，则先逐步将其加入到总消息中
		if show_all and self.index == 2 then
			for i = 1, #self.step_message do
				table.insert(content, self.step_message[i])
			end
			self.step_message = {}
		else
			if self.index == 2 and #self.step_message > 0 then
				table.insert(content, self.step_message[1])
				table.remove(self.step_message, 1)
			end
		end		
		for i = 1, #content do
			local item = dbUIPanel:panelWithSize(CCSize(210, 18))
			local name = CCLabelTTF:labelWithString(content[i].name, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 20)
			name:setColor(ccc3(255, 204, 51))
			name:setAnchorPoint(CCPoint(0, 0.5))
			name:setPosition(CCPoint(0, 9))
			item:addChild(name)
			local gain = CCLabelTTF:labelWithString(" 获得 ", CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 20)
			gain:setColor(ccc3(255, 102, 0))
			gain:setAnchorPoint(CCPoint(0, 0.5))
			gain:setPosition(CCPoint(name:getPositionX() + name:getContentSize().width, 9))
			item:addChild(gain)
			local item_name = CCLabelTTF:labelWithString(content[i].item_name, CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 20)
			item_name:setColor(ccc3(255, 204, 51))
			item_name:setAnchorPoint(CCPoint(0, 0.5))
			item_name:setPosition(CCPoint(gain:getPositionX() + gain:getContentSize().width, 9))
			item:addChild(item_name)
			self.contentArea:insterWidget(item)
		end
		if (self.contentArea:get_m_content_size().height < self.contentArea:getContentSize().height) then
			self.contentArea:m_setPosition(CCPoint(0, -self.contentArea:get_m_content_size().height + self.contentArea:getContentSize().height))
		else
			self.contentArea:m_setPosition(CCPoint(0, 0))
		end 
	end,
	
	destroy = function(self)
		self.message = nil
		self.step_message = nil
	end
}

RuinsRightBtnCfg = {
	{
		normal = "UI/ruins/zbk1.png",
		toggle = "UI/ruins/zbk2.png",
		position = CCPoint(400, 620),
	},
	{
		normal = "UI/ruins/xhk1.png",
		toggle = "UI/ruins/xhk2.png",
		position = CCPoint(580, 620),
	},
	--[[	宠物库未开启
	{
		normal = "UI/ruins/cwk1.png",
		toggle = "UI/ruins/cwk2.png",
		position = CCPoint(760, 620),
	},	]]
}

RuinsLeftBtnCfg = {
	{
		normal = "UI/ruins/zgxb1.png",
		toggle = "UI/ruins/zgxb2.png",
		position = CCPoint(155, 275),
	},
	{
		normal = "UI/ruins/ybxb1.png",
		toggle = "UI/ruins/ybxb2.png",
		position = CCPoint(155, 185),
	},
	{
		normal = "UI/ruins/jbxb1.png",
		toggle = "UI/ruins/jbxb2.png",
		position = CCPoint(155, 95),
	},
}

RuinsWheelPosition = {
	CCPoint(530, 720 - 140),
	CCPoint(654, 720 - 117),
	CCPoint(770, 720 - 140),
	CCPoint(872, 720 - 244),
	CCPoint(872, 720 - 358),
	CCPoint(873, 720 - 468),
	CCPoint(770, 720 - 537),
	CCPoint(654, 720 - 586),
	CCPoint(531, 720 - 537),
	CCPoint(422, 720 - 468),
	CCPoint(422, 720 - 358),
	CCPoint(422, 720 - 244),
}

globalShowUpgradeAssist = function()
	if globalUpgradeAssistPanel == nil then
		globalUpgradeAssistPanel = new(UpgradeAssistPanel)
		globalUpgradeAssistPanel:create()
	end
end

--拼接 "您当前" "【12】" "级，您可以："/"级，升级后："
local getCurLevelOrAfterCanDoStr = function(label)
	local label1 = CCLabelTTF:labelWithString(label[1], CCSize(200, 0), 0, SYSFONT[EQUIPMENT], 26)
	label1:setAnchorPoint(CCPoint(0, 1))
	label1:setColor(ccc3(102, 50, 0))
	
	local label2 = CCLabelTTF:labelWithString(label[2], CCSize(0, 0), 0, SYSFONT[EQUIPMENT], 26)
	label2:setAnchorPoint(CCPoint(0, 1))
	label2:setPosition(CCPoint(65, label1:getContentSize().height))
	label2:setColor(ccc3(153, 0, 153))
	label1:addChild(label2)
	
	local label3 = CCLabelTTF:labelWithString(label[3], CCSize(200, 0), 0, SYSFONT[EQUIPMENT], 26)
	label3:setAnchorPoint(CCPoint(0, 1))
	label3:setPosition(CCPoint(label2:getContentSize().width - 5, label2:getContentSize().height))
	label3:setColor(ccc3(102, 50, 0))
	label2:addChild(label3)
	
	return label1
end

--拼接 "您可以通过以下途径"，"赚钱"/"变强"
local getBeStrongOrEarnMoneyStr = function(label)
	local label1 = CCLabelTTF:labelWithString(label[1], CCSize(400, 0), 0, SYSFONT[EQUIPMENT], 24)
	label1:setAnchorPoint(CCPoint(0, 1))
	label1:setColor(ccc3(102, 50, 0))
	
	local label2 = CCLabelTTF:labelWithString(label[2], CCSize(100, 0), 0, SYSFONT[EQUIPMENT], 30)
	label2:setAnchorPoint(CCPoint(0, 0))
	label2:setPosition(CCPoint(242, 0))
	label2:setColor(ccc3(102, 50, 0))
	label1:addChild(label2)
	
	return label1
end

--获取当前神位已经开启的功能在配置表中的位置
local getCurLevelOpenFunctionIndex = function(cfg)
	for index = 1, #cfg do
		if cfg[index].reqLv > GloblePlayerData.officium then
			return index-1
		end
	end
	return #cfg
end

--从配置表中取部分数据作为新表
local getDataFromCfg = function(cfg, start, count)
	local data = {}
	for i = 0, #cfg do
		if count > 0 then
			if start + i > #cfg then
				break
			end
			local item = {}
			item.name = cfg[start+i].name
			item.reqLv = cfg[start+i].reqLv
			item.icon = cfg[start+i].icon
			data[i+1] = item
			count = count - 1
		end
	end	
	return data
end

UpgradeAssistPanel = {
	isMain = true,				--是否是主界面
	contentWidget = nil,		--内容显示UI
	
	create = function(self)
		local scene = DIRECTOR:getRunningScene()
		self.bgLayer = createSystemPanelBg()
		
		self.uiLayer = dbUIMask:node()
    	self.centerWidget = dbUIPanel:panelWithSize(CCSize(573, 598))
    	self.centerWidget:setAnchorPoint(CCPoint(0.5, 0.5))
    	self.centerWidget:setPosition(CCPoint(WINSIZE.width / 2, WINSIZE.height / 2))
    	self.centerWidget:setScale(SCALE)
    	self.uiLayer:addChild(self.centerWidget)
		
		scene:addChild(self.bgLayer, 1000)
		scene:addChild(self.uiLayer, 2000)
	
		local bg = CCSprite:spriteWithFile("UI/upgrade_assist/bg.png")
		bg:setAnchorPoint(CCPoint(0.5, 0.5))
		bg:setPosition(CCPoint(self.centerWidget:getContentSize().width / 2, self.centerWidget:getContentSize().height / 2))
		self.centerWidget:addChild(bg)
		
		local close_btn = dbUIButtonScale:buttonWithImage("UI/public/close_circle.png", 1, ccc3(125, 125, 125))
		close_btn:setAnchorPoint(CCPoint(1, 1))
		close_btn:setPosition(CCPoint(573, 588))
		close_btn.m_nScriptClickedHandler = function()
			if self.isMain then
				self:destroy()
			else
				self:createMain()
			end
		end
		self.centerWidget:addChild(close_btn)
		
		self:createMain()
	end,
	
	createMain = function(self)
		if self.contentWidget ~= nil then
			self.contentWidget:removeFromParentAndCleanup(true)
		end
		self.isMain = true
		local size = CCSize(553, 465)
		self.contentWidget = dbUIWidget:widgetWithImage("UI/nothing.png")
		self.contentWidget:setAnchorPoint(CCPoint(0, 0))
		self.contentWidget:setPosition(CCPoint(10, 10))
		self.contentWidget:setContentSize(size)
		self.centerWidget:addChild(self.contentWidget)
	
		local content_bg = dbUIWidgetBGFactory:widgetBG()
		content_bg:setCornerSize(CCSizeMake(70, 70))
		content_bg:setBGSize(size)
		content_bg:setAnchorPoint(CCPoint(0, 0))
		content_bg:createCeil("UI/upgrade_assist/bg_black.png")
		content_bg:setPosition(CCPoint(0, 0))
		self.contentWidget:addChild(content_bg)
		
		local centerPoint = CCPoint(size.width / 2, size.height / 2)
		for i = 1, #main_item_cfg do
			local item_btn = dbUIButtonScale:buttonWithImage(main_item_cfg[i].image, 1, ccc3(125, 125, 125))
			item_btn:setAnchorPoint(main_item_cfg[i].anchor)
			item_btn:setPosition(ccpAdd(centerPoint, main_item_cfg[i].offset))
			item_btn.m_nScriptClickedHandler = function()
				self:createBranch(i)
			end
			self.contentWidget:addChild(item_btn)
		end
	end,
	
	createBranch = function(self, index)
		if self.contentWidget ~= nil then
			self.contentWidget:removeFromParentAndCleanup(true)
		end
		self.isMain = false
		local size = CCSize(553, 480)
		self.contentWidget = dbUIWidget:widgetWithImage("UI/nothing.png")
		self.contentWidget:setAnchorPoint(CCPoint(0, 0))
		self.contentWidget:setPosition(CCPoint(10, 10))
		self.contentWidget:setContentSize(size)
		self.centerWidget:addChild(self.contentWidget)
		
		local content_bg = dbUIWidgetBGFactory:widgetBG()
		content_bg:setCornerSize(CCSizeMake(70, 70))
		content_bg:setBGSize(CCSize(size.width, size.height - 30))
		content_bg:setAnchorPoint(CCPoint(0, 0))
		content_bg:createCeil("UI/upgrade_assist/bg_brown.png")
		content_bg:setPosition(CCPoint(0, 0))
		self.contentWidget:addChild(content_bg)
		
		local content_panel = new(UpgradeAssistBranchPanel):create(index)
		self.contentWidget:addChild(content_panel)
		
		local strLabel = nil
		if index == 1 then
			local label = {
				"您当前",
				"【"..GloblePlayerData.officium.."】",
				"级，您可以：",
			}
			strLabel = getCurLevelOrAfterCanDoStr(label)
		elseif index == 2 then
			local label = {
				"您当前",
				"【"..GloblePlayerData.officium.."】",
				"级，升级后：",
			}
			strLabel = getCurLevelOrAfterCanDoStr(label)
		elseif index == 3 then
			local label = {
				"您可以通过以下途径变",
				"强：",
			}
			strLabel = getBeStrongOrEarnMoneyStr(label)
		elseif index == 4 then
			local label = {
				"您可以通过以下途径赚",
				"钱：",
			}
			strLabel = getBeStrongOrEarnMoneyStr(label)
		end
		strLabel:setPosition(CCPoint(20, size.height))
		self.contentWidget:addChild(strLabel)
	end,
	
	destroy = function(self)
		local scene = DIRECTOR:getRunningScene()
		scene:removeChild(self.bgLayer)
		scene:removeChild(self.uiLayer)
		
		self.bgLayer = nil
		self.uiLayer = nil
		self.centerWidget = nil
		
		globalUpgradeAssistPanel = nil
	end
}

UpgradeAssistBranchPanel = {

	itemsArea = nil,
	pageCount = 1,
	page = 1, --当前页
	pagePanels = nil, -- {panel=singlePagePanel,items={},page=page,loaded=false}
	
	openIndex = 0,	--对于配置表中的功能，已经开放的个数
	data = nil,		--配置数据表
	
	create = function(self, index)
		self:initData(index)
		local size = CCSize(553, 450)
		local panel = dbUIPanel:panelWithSize(size)
		panel:setAnchorPoint(CCPoint(0, 0))
		panel:setPosition(CCPoint(0, 0))
	
		self:createPageScroll(panel)
		self:loadPage(self.page)
		
		return panel
	end,
	
	initData = function(self, index)
		local openIndex = 0
		if index == 1 then
			openIndex = getCurLevelOpenFunctionIndex(all_function_cfg)
			self.data = getDataFromCfg(all_function_cfg, 1, openIndex)
			self.openIndex = #self.data
			self.pageCount = math.ceil(#self.data / 6)
		elseif index == 2 then
			openIndex = getCurLevelOpenFunctionIndex(all_function_cfg)
			self.data = getDataFromCfg(all_function_cfg, openIndex + 1, #all_function_cfg - openIndex)
			self.openIndex = 0
			self.pageCount = math.ceil(#self.data / 6)
		elseif index == 3 then 
			self.data = be_stronger_cfg
			self.openIndex = getCurLevelOpenFunctionIndex(be_stronger_cfg)
			self.pageCount = math.ceil(#self.data / 6)
		elseif index == 4 then
			self.data = earn_money_cfg
			self.openIndex = getCurLevelOpenFunctionIndex(earn_money_cfg)
			self.pageCount = math.ceil(#self.data / 6)
		end
		self.pageCount = math.max(self.pageCount, 1)	
	end,
	
	--创建滑动分页部分
	createPageScroll = function(self, panel)
		local scroll_size = CCSize(panel:getContentSize().width, panel:getContentSize().height - 60)
		local pagePanelContainer = dbUIPanel:panelWithSize(CCSize(scroll_size.width * self.pageCount,scroll_size.height))
		pagePanelContainer:setAnchorPoint(CCPoint(0, 0))
		pagePanelContainer:setPosition(0, 0)
		
		self.pagePanels = new({})
		for i=1,self.pageCount do
			local singlePage = self:createSinglePage(i, scroll_size)
			pagePanelContainer:addChild(singlePage)
		end
		
		self.scrollArea = dbUIPageScrollArea:scrollAreaWithWidget(pagePanelContainer, 1, self.pageCount)
        self.scrollArea:setAnchorPoint(CCPoint(0, 0))
        self.scrollArea:setScrollRegion(CCRect(0, 0, scroll_size.width, scroll_size.height))
        self.scrollArea:setPosition(0,50)
		self.scrollArea.pageChangedScriptHandler = function(page)
			self.page = page+1
			public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
			self:loadPage(self.page)
		end
		panel:addChild(self.scrollArea)
		self:createPageDot(self.pageCount, panel)
		self.scrollArea:scrollToPage(self.page-1,false)
	end,
	
	createSinglePage = function(self, page, size)
		local singlePagePanel = dbUIPanel:panelWithSize(size)
		singlePagePanel:setAnchorPoint(CCPoint(0, 0))
        singlePagePanel:setPosition((page-1)*size.width, 0)
       
        local pagePanel = {panel=singlePagePanel,items={},page=page,loaded=false}
        self.pagePanels[page] = pagePanel
        return singlePagePanel
	end,
	
	--加载某一页的数据
	loadPage = function(self,page)
		local pagePanel = self.pagePanels[page]
		if pagePanel.loaded then
			return
		end
		--当前页显示的个数
		local count = math.min(#self.data - (page-1) * 6, 6)
		for i = 1, count do
			local item_panel = self:createItem(i)
			pagePanel.panel:addChild(item_panel)
			pagePanel.items[i] = item_panel	
		end
		
		pagePanel.loaded = true
	end,
	
	--创建分页底下的圈圈
	createPageDot = function(self,pageCount, panel)
		local width = pageCount*33 + (pageCount-1)*19
		self.form = dbUIPanel:panelWithSize(CCSize(width, 80))
		self.form:setPosition(553 / 2, 10)
		self.form:setAnchorPoint(CCPoint(0.5,0))
		panel:addChild(self.form)
		
		self.pageToggles = {}
		for i=1, pageCount do
			local normalSpr = CCSprite:spriteWithFile("UI/public/page_btn_normal.png")
			local togglelSpr = CCSprite:spriteWithFile("UI/public/page_btn_toggle.png")		
			local pageToggle = dbUIButtonToggle:buttonWithImage(normalSpr,togglelSpr)
			pageToggle:setPosition(CCPoint(52*(i-1), 15))
			pageToggle:setAnchorPoint(CCPoint(0,0.5))
			pageToggle.m_nScriptClickedHandler = function(ccp)
				self.scrollArea:scrollToPage(i-1)
				public_toggleRadioBtn(self.pageToggles,pageToggle)
			end
			self.form:addChild(pageToggle)
			self.pageToggles[i] = pageToggle
		end
		public_toggleRadioBtn(self.pageToggles,self.pageToggles[self.page])
	end,
	
	createItem = function(self, i)
		local curIndex = (self.page-1) * 6 + i
		local panel = dbUIPanel:panelWithSize(CCSize(254, 114))
		panel:setAnchorPoint(CCPoint(0, 0))
		panel:setPosition(branch_item_cfg[i])
		--背景
		local item_bg = CCSprite:spriteWithFile("UI/upgrade_assist/item_bg.png")
		item_bg:setAnchorPoint(CCPoint(0, 0))
		item_bg:setPosition(CCPoint(0, 0))
		panel:addChild(item_bg)
		--框
		local kuang = CCSprite:spriteWithFile("UI/public/kuang_96_96.png")
		kuang:setAnchorPoint(CCPoint(0, 0.5))
		kuang:setPosition(10, 114 / 2)
		panel:addChild(kuang)
		--icon
		local icon = dbUIButtonScale:buttonWithImage(self.data[curIndex].icon, 1, ccc3(125, 125, 125))
		icon:setAnchorPoint(CCPoint(0, 0))
		local offsetX = (kuang:getContentSize().width - icon:getContentSize().width) / 2
		icon:setPosition(CCPoint(10 + offsetX, 12))
		icon.m_nScriptClickedHandler = function()
			self:gotoFunction(self.data[curIndex].name)
		end
		panel:addChild(icon)
		
		--功能名次
		local name = self.data[curIndex].name
		local nameLabel = CCLabelTTF:labelWithString(name, CCSize(148, 0), CCTextAlignmentCenter, SYSFONT[EQUIPMENT], 24)
		nameLabel:setAnchorPoint(CCPoint(0, 0.5))
		nameLabel:setPosition(CCPoint(106, 76))
		nameLabel:setColor(ccc3(255, 204, 103))
		panel:addChild(nameLabel)
		--是否已经开放
		local openInfo = nil
		local color = nil
		if curIndex > self.openIndex then	--功能未开放
			openInfo = "（"..self.data[curIndex].reqLv.."级开启）"
			color = ccc3(255, 0, 0)
			panel:setIsEnabled(false)
		else
			openInfo = "（功能已开启）"
			color = ccc3(153, 204, 3)
		end
		local openLabel = CCLabelTTF:labelWithString(openInfo, CCSize(148, 0), CCTextAlignmentCenter, SYSFONT[EQUIPMENT], 20)
		openLabel:setAnchorPoint(CCPoint(0, 0.5))
		openLabel:setPosition(CCPoint(106, 30))
		openLabel:setColor(color)
		panel:addChild(openLabel)
		
		return panel	
	end,
	
	gotoFunction = function(self, name)
		if 	   name == "在线礼包"	 then
			globleRewardOnline()
		elseif name == "福利礼包"	 then
			GlobalCreateGiftPanel()
		elseif name == "主线任务"	 then
			dbTaskMgr:getSingletonPtr():taskPathing(1)
		elseif name == "训练"		 then 
			globleShowXunLianPanel()
		--elseif name == "升级助手"	 then
		elseif name == "强化"		 then
			globleShowQHPanel()
		elseif name == "技能"		 then
			globleShowJiNengPanel()
		elseif name == "招募"		 then
			createTavernPanel()
		elseif name == "阵型"		 then
			globleShowZhenFaPanel()
		elseif name == "洗髓"		 then
			globleShowXiSuiPanel()
		elseif name == "灵果园"	 	 then
			GlobleCreateLinGuoYuan()
		elseif name == "科技"		 then
			globle_create_tian_fu()
		elseif name == "竞技场"	 	 then
			globleCreateArena()
		elseif name == "祈福"		 then
			GlobalCreateWishPanel()
		elseif name == "家族"		 then
			globleShowJiaZu()
		elseif name == "支线任务"	 then
			dbTaskMgr:getSingletonPtr():taskPathing(2)
		elseif name == "古战场遗迹"  then
			globalShowRuinsPanel()
		elseif name == "精英副本"	 then
			globleShowJingYingFubenPanel()
		elseif name == "灵泉阁"	 	 then
			GlobleCreateLinQuanGe()
		elseif name == "符文祭炼阵"  then
			GlobleCreateFuWenJiLian()
		elseif name == "镶嵌"		 then
			globleShowXiangQian()
		elseif name == "商城"		 then
			GlobleCreateShopping()
		elseif name == "BOSS战"	 	 then
			globleExecuteBossWar()
		elseif name == "宝石合成"	 then
			globleShowHeCheng()
		elseif name == "团队副本"	 then
			globleShowTeamFubenPanel()
		elseif name == "佣兵任务"	 then
			GlobleCreateYongBing()
		elseif name == "哈迪斯宝库"   then
			GlobleCreateHades()
		elseif name == "祭星"		 then
			globleShowJiFete()
		elseif name == "战奴劳场"	 then
			GlobleCreateSlaveWork()
		elseif name == "攻城战"		 then
			GlobleExecuteLeagueWar()
        elseif name == "宠物继承"	 then
        	globalShowGeneralExtend()
        elseif name == "装备升级" 	then
        	globleShowShengji()
		end
		
		globalUpgradeAssistPanel:destroy()
	end
}
					 
main_item_cfg = {
	{
		image = "UI/upgrade_assist/now_can_do.png",
		anchor = CCPoint(1, 0),
		offset = CCPoint(-10, 10),
	},
	{
		image = "UI/upgrade_assist/after_can_do.png",
		anchor = CCPoint(0, 0),
		offset = CCPoint(10, 10),
	},
	{
		image = "UI/upgrade_assist/be_stronger.png",
		anchor = CCPoint(1, 1),
		offset = CCPoint(-10, -10),
	},
	{
		image = "UI/upgrade_assist/earn_money.png",
		anchor = CCPoint(0, 1),
		offset = CCPoint(10, -10),
	},
}

branch_item_cfg = {
	CCPoint(15, 			10 + (114 + 14) *2),
	CCPoint(15 + 254 + 15, 	10 + (114 + 14) *2),
	CCPoint(15, 			10 + 114 + 14),
	CCPoint(15 + 254 + 15, 	10 + 114 + 14),
	CCPoint(15,	 			10),
	CCPoint(15 + 254 + 15, 	10),
}

all_function_cfg = {
	{name = "主线任务",		reqLv = 1, 		icon = "UI/upgrade_assist/task.png",								},
	{name = "强化",				reqLv = 4 ,		icon = "UI/upgrade_assist/qiang_hua.png",					},
	--{name = "升级助手",		reqLv = 5 ,		icon = "UI/upgrade_assist/nothing.png",			},
	{name = "招募",				reqLv = 9,		icon = "UI/upgrade_assist/zhao_mu.png",					},
	{name = "阵型",				reqLv = 9, 		icon = "UI/upgrade_assist/zhen_xing.png",					},
	{name = "科技",				reqLv = 12, 	icon = "UI/upgrade_assist/ke_ji.png",								},
	{name = "洗髓",				reqLv = 15, 	icon = "UI/upgrade_assist/xi_sui.png",							},
	{name = "训练",				reqLv = 18 ,	icon = "UI/upgrade_assist/xun_lian.png",						},
	--{name = "灵果园",		reqLv = 16, 	icon = "UI/upgrade_assist/ling_guo_yuan.png",	},
	{name = "竞技场",			reqLv = 19, 	icon = "UI/upgrade_assist/arena.png",							},
	{name = "祭星",				reqLv = 22, 	icon = "UI/upgrade_assist/ji_xing.png",							},
	--{name = "灵泉阁",			reqLv = 24, 	icon = "icon/copper.png",													},
	{name = "哈迪斯宝库",	reqLv = 24, 	icon = "UI/upgrade_assist/hades.png",							},
	{name = "BOSS战",			reqLv = 25, 	icon = "UI/upgrade_assist/boss_war.png",					},
	{name = "支线任务",		reqLv = 26, 	icon = "UI/upgrade_assist/task.png",								},
	{name = "家族",				reqLv = 27, 	icon = "UI/upgrade_assist/jia_zu.png",							},
	{name = "祈福",				reqLv = 28, 	icon = "UI/upgrade_assist/qi_fu.png",							},
	{name = "装备升级",		reqLv = 30, 	icon = "UI/upgrade_assist/equip_composite.png"	,	},
	{name = "团队副本",		reqLv = 30, 	icon = "UI/upgrade_assist/fu_ben.png",						},
	{name = "精英副本",		reqLv = 30, 	icon = "UI/upgrade_assist/fu_ben.png",						},
	{name = "镶嵌",				reqLv = 32, 	icon = "UI/upgrade_assist/xiang_qian.png",					},
	{name = "商城",				reqLv = 34, 	icon = "UI/upgrade_assist/shop.png",							},
	{name = "宝石合成",		reqLv = 35, 	icon = "UI/upgrade_assist/he_cheng.png",					},
	{name = "古战场遗迹",	reqLv = 36, 	icon = "UI/upgrade_assist/ruins.png",							},
	{name = "佣兵任务",		reqLv = 38, 	icon = "UI/upgrade_assist/yong_bing.png",					},
	{name = "战奴劳场",		reqLv = 40, 	icon = "UI/upgrade_assist/zhan_nu.png",						},
	{name = "攻城战",			reqLv = 45, 	icon = "UI/upgrade_assist/zhen_ying.png",					},
	{name = "宠物继承",		reqLv = 50, 	icon = "UI/upgrade_assist/general_extend.png",  		},
	--{name = "符文祭炼阵",	reqLv = 33, 	icon = "UI/upgrade_assist/fu_wen.png",			},
	
}

be_stronger_cfg = {
	{name="强化",				reqLv = 4 , 	icon = "UI/upgrade_assist/qiang_hua.png",		},
	{name="招募",				reqLv = 9, 		icon = "UI/upgrade_assist/zhao_mu.png",		},
	{name="阵型",				reqLv = 9, 		icon = "UI/upgrade_assist/zhen_xing.png",		},
	{name="科技",				reqLv = 12, 	icon = "UI/upgrade_assist/ke_ji.png",					},
	{name="洗髓",				reqLv = 15, 	icon = "UI/upgrade_assist/xi_sui.png",				},
	{name="训练",				reqLv = 18 , 	icon = "UI/upgrade_assist/xun_lian.png",			},
	{name="祭星",				reqLv = 22, 	icon = "UI/upgrade_assist/ji_xing.png",				},
	{name="团队副本",		reqLv = 30, 	icon = "UI/upgrade_assist/fu_ben.png",			},
	{name="精英副本",		reqLv = 30, 	icon = "UI/upgrade_assist/fu_ben.png",			},
	{name="镶嵌",				reqLv = 32, 	icon = "UI/upgrade_assist/xiang_qian.png",		},
	{name="宝石合成",		reqLv = 35, 	icon = "UI/upgrade_assist/he_cheng.png",		},
	{name="古战场遗迹",	reqLv = 26, 	icon = "UI/upgrade_assist/ruins.png",				},
	--{name="符文祭炼阵",	reqLv = 33, 	icon = "UI/upgrade_assist/fu_wen.png",		},
}                                                 
                                                  
earn_money_cfg = {                                
	{name="在线礼包",	reqLv = 1 , 	icon = "icon/copper.png",	},            
	{name="福利礼包",	reqLv = 1 , 	icon = "icon/gold.png",		},	
	--{name="灵果园",		reqLv = 16, 	icon = "icon/copper.png",	},
	{name="竞技场",		reqLv = 19, 	icon = "icon/copper.png",	},
	--{name="灵泉阁",		reqLv = 24, 	icon = "icon/copper.png",	},
	{name="哈迪斯宝库",	reqLv = 24, 	icon = "icon/copper.png",	},
	{name="BOSS战",	reqLv = 25, 	icon = "icon/copper.png",	},	
	{name="佣兵任务",	reqLv = 38, 	icon = "icon/gold.png",		},	
	{name="战奴劳场",	reqLv = 40, 	icon = "icon/gold.png",		},	
	{name="攻城战",		reqLv = 45, 	icon = "icon/copper.png",	},
}
